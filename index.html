<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#050508">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SATURNO HUB">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>SATURNO HUB</title>
<style>
:root {
  --bg-void: #050508;
  --bg-deep: #0a0a0e;
  --bg-surface: #101014;
  --bg-elevated: #161619;
  --bg-hover: #1c1c20;
  --bg-input: #121215;
  --border: rgba(255,255,255,0.04);
  --border-hover: rgba(255,255,255,0.08);
  --border-active: rgba(74,222,160,0.35);
  --accent: #4ade80;
  --accent-glow: rgba(74,222,160,0.06);
  --accent-secondary: #2dd4bf;
  --accent-cyan: #22d3ee;
  --green: #4ade80;
  --yellow: #fbbf24;
  --orange: #fb923c;
  --red: #f87171;
  --text: rgba(255,255,255,0.90);
  --text-secondary: rgba(255,255,255,0.50);
  --text-muted: rgba(255,255,255,0.22);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  --radius: 8px;
  --radius-lg: 12px;
  --transition-fast: all 0.12s cubic-bezier(0.4,0,0.2,1);
  --transition-smooth: all 0.25s cubic-bezier(0.4,0,0.2,1);
  --sidebar-width: 220px;
  --context-width: 320px;
  --project-width: 420px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg-void);color:var(--text-secondary);height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}

.app{display:grid;grid-template-columns:var(--sidebar-width) 4px 1fr;height:100vh;transition:grid-template-columns 0.25s cubic-bezier(0.4,0,0.2,1)}
.app.project-open{grid-template-columns:var(--sidebar-width) 4px 1fr 5px var(--project-width)}
.app.project-open .project-view{display:flex}
.app.context-open{grid-template-columns:var(--sidebar-width) 4px 1fr 4px var(--context-width)}
.app.context-open .context-panel{display:flex}
.app.context-open .context-resize{display:block}
.app.mode-focus{grid-template-columns:1fr}
.app.mode-focus .sidebar{display:none}
.app.mode-focus .writer-sidebar{display:flex!important}
.app.mode-focus .sidebar-resize{display:none}
.app.mode-extended{grid-template-columns:var(--sidebar-width) 4px 1fr 4px var(--context-width)}
.app.mode-extended .context-panel{display:flex}
.app.mode-extended .context-resize{display:block}
.context-resize{display:none}
.project-resize-handle{width:5px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0;display:none}
.app.project-open .project-resize-handle{display:block}
.project-resize-handle:hover,.project-resize-handle.dragging{background:var(--accent);opacity:0.4}
.project-resize-handle::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:3px;height:32px;border-radius:2px;background:var(--text-muted);opacity:0}

/* RESIZE HANDLES */
.sidebar-resize{width:4px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0}
.sidebar-resize:hover,.sidebar-resize.dragging{background:var(--accent);opacity:0.3}
.context-resize{width:4px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0}
.context-resize:hover,.context-resize.dragging{background:var(--accent);opacity:0.3}

/* SIDEBAR */
.sidebar{background:linear-gradient(180deg, #080810 0%, #060608 100%);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
.logo{font-size:13px;font-weight:700;color:var(--accent);letter-spacing:0.5px;animation:logoBreathe 4s ease-in-out infinite}
@keyframes logoBreathe{0%,100%{opacity:0.85}50%{opacity:1}}
.logo-sub{font-size:9px;color:var(--text-muted);margin-top:2px;letter-spacing:0.3px}
.sidebar-section{padding:12px}
.sidebar-label{font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;padding:0 8px;margin-bottom:6px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:12px;color:var(--text-secondary)}
.sidebar-item:hover{background:var(--bg-hover);color:var(--text)}
.sidebar-item.active{background:var(--accent-glow);color:var(--accent)}
.sidebar-item-icon{width:16px;text-align:center;font-size:11px;opacity:0.4;font-family:var(--mono);display:flex;align-items:center;justify-content:center}
.sidebar-item-icon svg{opacity:0.7}
.sidebar-item.active .sidebar-item-icon svg{opacity:1}
.sidebar-item-count{margin-left:auto;font-size:10px;color:var(--text-muted);font-family:var(--mono)}
.sidebar-divider{height:1px;background:var(--border);margin:4px 12px}
.sidebar-header{position:relative}
.sidebar-toggle-btn{padding:3px 5px!important}
.sidebar-collapse-chevron{display:flex;align-items:center;justify-content:center;padding:12px;cursor:pointer;color:var(--text-muted);transition:var(--transition-fast);border-top:1px solid var(--border);margin-top:auto;flex-shrink:0}
.sidebar-collapse-chevron:hover{color:var(--text);background:var(--bg-hover)}
.sidebar-collapse-chevron svg{opacity:0.5;transition:opacity 0.15s}
.sidebar-collapse-chevron:hover svg{opacity:1}
.project-collapse-chevron{display:flex;align-items:center;justify-content:center;padding:10px;cursor:pointer;color:var(--text-muted);transition:var(--transition-fast);border-top:1px solid var(--border);flex-shrink:0}
.project-collapse-chevron:hover{color:var(--text);background:var(--bg-hover)}
.project-collapse-chevron svg{opacity:0.5;transition:opacity 0.15s}
.project-collapse-chevron:hover svg{opacity:1}

/* COLLAPSED SIDEBAR — icon-only strip */
.app.sidebar-collapsed{grid-template-columns:52px 0px 1fr}
.app.sidebar-collapsed.project-open{grid-template-columns:52px 0px 1fr 5px var(--project-width)}
.app.sidebar-collapsed.context-open,.app.sidebar-collapsed.mode-extended{grid-template-columns:52px 0px 1fr 4px var(--context-width)}
.app.sidebar-collapsed .sidebar-resize{display:none}
.app.sidebar-collapsed .sidebar{overflow-x:hidden;overflow-y:auto}
.app.sidebar-collapsed .sidebar-header{padding:14px 0;display:flex;justify-content:center}
.app.sidebar-collapsed .logo{font-size:0;width:24px;height:24px;background:var(--accent);border-radius:50%;display:block}
.app.sidebar-collapsed .logo::after{content:'S';font-size:12px;font-weight:700;color:#09090b;display:flex;align-items:center;justify-content:center;width:100%;height:100%}
.app.sidebar-collapsed .logo-sub{display:none}
.app.sidebar-collapsed .sidebar-label{display:none}
.app.sidebar-collapsed .sidebar-item span:not(.sidebar-item-icon){display:none}
.app.sidebar-collapsed .sidebar-item-count{display:none}
.app.sidebar-collapsed .sidebar-section:not(:first-of-type){display:none}
.app.sidebar-collapsed .sidebar-divider{display:none}
.app.sidebar-collapsed #sidebar-dash{display:none!important}
.app.sidebar-collapsed .sidebar-section{padding:6px 4px}
.app.sidebar-collapsed .sidebar-item{padding:10px 0;justify-content:center;gap:0;border-radius:8px;margin:2px 6px}
.app.sidebar-collapsed .sidebar-item-icon{width:auto;opacity:0.6}
.app.sidebar-collapsed .sidebar-item.active .sidebar-item-icon{opacity:1}
.app.sidebar-collapsed #sidebar-context{display:none}
.app.sidebar-collapsed #sidebar-bottom{display:none!important}
.app.sidebar-collapsed .sidebar-collapse-chevron svg{transform:rotate(180deg)}

/* MAIN */
.main{display:flex;flex-direction:column;overflow:hidden}
.header{height:48px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0;background:var(--bg-void)}
.header-title{font-size:14px;font-weight:600;color:var(--text)}
.header-actions{display:flex;gap:6px;margin-left:auto}
.content-area{flex:1;overflow-y:auto;padding:20px}

/* BUTTONS */
.btn{padding:5px 10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-surface);color:var(--text-secondary);font-family:var(--font);font-size:10px;font-weight:500;cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:4px}
.btn:hover{border-color:var(--border-active);color:var(--text)}
.btn-primary{background:var(--accent);color:#09090b;border:none;font-weight:600}
.btn-primary:hover{opacity:0.9;box-shadow:0 2px 12px rgba(74,222,160,0.25)}
.btn-sm{padding:3px 7px;font-size:9px}
.btn-ghost{background:transparent;border:none}
.btn-ghost:hover{background:var(--bg-hover)}
.btn-danger:hover{color:var(--red);border-color:rgba(239,68,68,0.4)}

/* INPUTS */
input,select,textarea{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:var(--font);padding:6px 10px;font-size:11px;transition:all 0.15s;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--border-active);box-shadow:0 0 0 2px var(--accent-glow)}
textarea{resize:vertical;line-height:1.6}

/* BADGES */
.badge{font-family:var(--mono);font-size:8px;letter-spacing:0.5px;text-transform:uppercase;padding:2px 6px;border-radius:3px;line-height:1}
.badge-blue{background:rgba(74,222,160,0.12);color:var(--accent)}
.badge-purple{background:rgba(139,92,246,0.15);color:var(--accent-secondary)}
.badge-green{background:rgba(34,197,94,0.15);color:var(--green)}
.badge-yellow{background:rgba(234,179,8,0.15);color:var(--yellow)}
.badge-orange{background:rgba(249,115,22,0.15);color:var(--orange)}
.badge-red{background:rgba(239,68,68,0.15);color:var(--red)}
.badge-muted{background:rgba(255,255,255,0.06);color:var(--text-muted)}

/* TABS */
.tab-bar{display:flex;gap:2px}
.tab-btn{padding:5px 10px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:10px;font-weight:500;cursor:pointer;border-radius:var(--radius);transition:all 0.15s}
.tab-btn:hover{color:var(--text-secondary);background:var(--bg-surface)}
.tab-btn.active{background:var(--accent-glow);color:var(--accent)}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg-elevated);border-radius:3px}

/* PANELS */
.panel{display:none;height:100%;flex-direction:column;opacity:0;transition:opacity 0.15s ease}
.panel.active{display:flex;opacity:1}

/* CONTENT VAULT */
.content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;padding-top:12px}
.content-card{background:linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;position:relative}
.content-card:hover{border-color:var(--border-hover);box-shadow:0 4px 16px rgba(0,0,0,0.35);transform:translateY(-1px)}
.content-card-body{font-size:12px;color:var(--text-secondary);line-height:1.7;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow:hidden;cursor:pointer;position:relative}
.content-card-body.expanded{max-height:none;overflow:visible}
.content-card-body:not(.expanded)::after{content:'';position:absolute;bottom:0;left:0;right:0;height:30px;background:linear-gradient(transparent,var(--bg-surface))}
.content-card-footer{display:flex;align-items:center;gap:6px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border)}
.content-card-actions{display:flex;gap:4px;margin-left:auto;opacity:0;transition:opacity 0.15s}
.content-card:hover .content-card-actions{opacity:1}

/* TASK MANAGER */
.task-toolbar{display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:1px solid var(--border);margin-bottom:0;flex-wrap:wrap}
.task-toolbar-search{flex:1;max-width:260px;margin-left:auto}
.task-table-header{display:grid;grid-template-columns:36px 1fr 110px 110px 110px 100px 50px;padding:6px 0;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-void);z-index:5}
.task-table-header-cell{font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;padding:0 4px}
.task-row{display:grid;grid-template-columns:36px 1fr 110px 110px 110px 100px 50px;align-items:center;min-height:40px;border-bottom:1px solid var(--border);transition:background 0.1s;border-left:3px solid transparent}
.task-row.priority-p0{border-left-color:#ef4444}
.task-row.priority-p1{border-left-color:#f59e0b}
.task-row.priority-p2{border-left-color:#3b82f6}
.task-row.priority-p3{border-left-color:var(--border)}
.task-row:hover{background:var(--bg-hover)}
.task-row.overdue{background:rgba(239,68,68,0.04)}
.task-row.dragging-over{border-top:2px solid var(--accent)}
.task-checkbox{width:15px;height:15px;border:2px solid var(--border-hover);border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;margin:0 auto}
.task-checkbox:hover{border-color:var(--accent)}
.task-checkbox.checked{background:var(--green);border-color:var(--green)}
.task-checkbox.checked::after{content:'';width:4px;height:7px;border:solid #fff;border-width:0 1.5px 1.5px 0;transform:rotate(45deg);margin-bottom:1px}
.task-title-input{background:transparent;border:none;color:var(--text);font-size:12px;padding:4px 0;width:100%}
.task-title-input:focus{outline:none}
.task-title-input::placeholder{color:var(--text-muted)}
.task-row.completed .task-title-input{text-decoration:line-through;opacity:0.4}
.task-select{background:transparent;border:1px solid transparent;color:var(--text-secondary);font-size:10px;padding:4px 6px;cursor:pointer}
.task-select:hover{background:var(--bg-input);border-color:var(--border)}
.task-actions{display:flex;gap:2px;opacity:0}
.task-row:hover .task-actions{opacity:1}
.task-action-btn{width:22px;height:22px;border-radius:3px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center}
.task-action-btn:hover{background:var(--bg-input);color:var(--text)}
.task-action-btn.del:hover{color:var(--red)}
.add-task-row{display:flex;align-items:center;gap:8px;padding:10px 0 10px 36px;color:var(--text-muted);cursor:pointer;font-size:12px}
.add-task-row:hover{color:var(--text-secondary)}

/* Board */
.board-view{display:none;gap:12px;overflow-x:auto;flex:1}
.board-view.active{display:flex}
.board-col{min-width:250px;flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);display:flex;flex-direction:column;max-height:100%}
.board-col-header{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}
.board-col-title{font-size:11px;font-weight:600;color:var(--text-secondary)}
.board-col-count{font-size:10px;color:var(--text-muted);font-family:var(--mono);margin-left:auto}
.board-col-tasks{padding:6px;flex:1;overflow-y:auto;transition:background 0.15s}
.board-col-tasks.drag-over{background:rgba(74,222,128,0.05);outline:1px dashed var(--accent);outline-offset:-2px}
.board-card{background:linear-gradient(135deg, var(--bg-elevated) 0%, #1e1e22 100%);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:6px;cursor:grab;transition:all 0.15s}
.board-card:hover{border-color:var(--border-hover);box-shadow:0 4px 12px rgba(0,0,0,0.35);transform:translateY(-1px)}
.board-card-title{font-size:12px;color:var(--text);margin-bottom:4px}
.board-card-desc{font-size:10px;color:var(--text-muted);margin-bottom:6px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.board-card-subtasks{font-size:9px;color:var(--text-muted);margin-bottom:4px;font-family:var(--mono)}
.board-card-subtasks .done{color:var(--accent)}
.board-card-meta{display:flex;gap:4px;flex-wrap:wrap;align-items:center}
.task-detail-modal{position:fixed;inset:0;z-index:1500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.task-detail-modal.open{display:flex}
.task-detail-inner{background:var(--bg-deep);border:1px solid var(--border);border-radius:var(--radius-lg);width:540px;max-width:95vw;max-height:85vh;overflow-y:auto;padding:24px}
.task-detail-inner h3{font-size:16px;font-weight:600;color:var(--text);margin-bottom:16px}
.td-field{margin-bottom:14px}
.td-field label{display:block;font-size:10px;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
.td-field input,.td-field textarea,.td-field select{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);padding:8px 10px;font-size:13px;font-family:var(--font)}
.td-field textarea{min-height:80px;resize:vertical;line-height:1.6}
.td-field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.td-subtasks{margin-top:8px}
.td-subtask{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px}
.td-subtask input[type=checkbox]{accent-color:var(--accent)}
.td-subtask input[type=text]{flex:1;background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text);padding:2px 0;font-size:12px;outline:none}
.td-subtask input[type=text]:focus{border-color:var(--accent)}
.td-subtask .del{opacity:0;cursor:pointer;color:var(--red);font-size:10px;transition:opacity 0.1s}
.td-subtask:hover .del{opacity:1}
.td-add-subtask{font-size:11px;color:var(--text-muted);cursor:pointer;padding:4px 0;margin-top:4px}
.td-add-subtask:hover{color:var(--accent)}
.td-footer{display:flex;gap:8px;margin-top:20px;justify-content:space-between}
.td-created{font-size:9px;color:var(--text-muted);margin-top:12px}

/* Calendar */
.calendar-shell{display:flex;flex-direction:column;height:100%}
.calendar-nav{display:flex;align-items:center;gap:12px;padding-bottom:12px;flex-shrink:0}
.calendar-month-label{font-size:15px;font-weight:600;color:var(--text)}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border-radius:var(--radius-lg);overflow:hidden;flex:1}
.calendar-day-header{padding:8px;background:var(--bg-surface);font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;text-align:center}
.calendar-day{background:var(--bg-void);padding:6px;min-height:80px;cursor:pointer;transition:background 0.1s;overflow-y:auto}
.calendar-day:hover{background:var(--bg-deep)}
.calendar-day.other{opacity:0.25}
.calendar-day.today{background:rgba(74,222,160,0.06)}
.calendar-day-num{font-size:11px;font-weight:500;color:var(--text-secondary);margin-bottom:4px}
.calendar-day.today .calendar-day-num{width:22px;height:22px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px}
.calendar-task-pill{font-size:9px;padding:2px 5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text-secondary);cursor:grab;border-left:2px solid var(--border)}
.calendar-task-pill.pill-p0{border-left-color:#ef4444}
.calendar-task-pill.pill-p1{border-left-color:#f59e0b}
.calendar-task-pill.pill-p2{border-left-color:#3b82f6}
.calendar-task-pill:hover{border-color:var(--accent)}
.calendar-task-pill.dragging{opacity:0.4}
.cal-view-toggle{display:flex;gap:2px;background:var(--bg-surface);border-radius:var(--radius);padding:2px}
.cal-view-btn{padding:4px 10px;border:none;background:transparent;color:var(--text-muted);font-size:10px;border-radius:4px;cursor:pointer;font-family:var(--font)}
.cal-view-btn.active{background:var(--bg-elevated);color:var(--text)}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border-radius:var(--radius-lg);overflow:hidden;flex:1}
.week-day{background:var(--bg-void);padding:8px;min-height:120px;display:flex;flex-direction:column;gap:4px;overflow-y:auto}
.week-day.today{background:rgba(74,222,160,0.06)}
.week-day-header{font-size:10px;color:var(--text-muted);font-weight:600;text-align:center;padding:4px;margin-bottom:4px;font-family:var(--mono)}
.week-day-header .day-num{font-size:13px;color:var(--text-secondary);display:block;margin-top:2px}
.week-day.today .week-day-header .day-num{background:var(--accent);color:#fff;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center}
.week-task-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px 8px;cursor:grab;transition:all 0.1s;font-size:10px}
.week-task-card:hover{border-color:var(--accent)}
.week-task-card .wt-title{color:var(--text);font-size:11px;margin-bottom:2px}
.week-task-card .wt-meta{display:flex;gap:4px;align-items:center}
.week-add{font-size:9px;color:var(--text-muted);cursor:pointer;padding:4px 0;text-align:center}
.week-add:hover{color:var(--accent)}

/* Links */
.links-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;padding-top:12px}
.link-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;cursor:pointer;display:flex;flex-direction:column;gap:6px}
.link-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 16px rgba(74,222,160,0.08)}
.link-card-title{font-size:12px;font-weight:600;color:var(--text)}
.link-card-url{font-family:var(--mono);font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.link-card-desc{font-size:10px;color:var(--text-secondary);line-height:1.5}
.link-card-footer{display:flex;gap:4px;align-items:center;margin-top:auto}
.link-card-actions{margin-left:auto;display:flex;gap:2px;opacity:0}
.link-card:hover .link-card-actions{opacity:1}

/* WRITING HUB */
.writer-shell{display:flex;height:100%;overflow:hidden}
.writer-sidebar{width:200px;min-width:160px;max-width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0;overflow:hidden}
.writer-doc-list{flex:1;overflow-y:auto;padding:6px}
.writer-doc-item{padding:8px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:2px}
.writer-doc-item:hover{background:var(--bg-hover)}
.writer-doc-item.active{background:var(--accent-glow)}
.writer-doc-title{font-size:11px;color:var(--text);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.writer-doc-meta{font-size:9px;color:var(--text-muted);margin-top:2px;display:flex;gap:8px}
.writer-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.writer-toolbar{display:flex;align-items:center;gap:2px;padding:6px 8px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:none}.writer-toolbar::-webkit-scrollbar{display:none}
.writer-toolbar-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:12px;display:flex;align-items:center;justify-content:center;transition:all 0.1s;font-weight:600}
.writer-toolbar-btn:hover{background:var(--bg-hover);color:var(--text)}
.writer-toolbar-btn.active{background:var(--accent-glow);color:var(--accent)}
.writer-toolbar-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.writer-toolbar-select{background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);font-size:10px;padding:4px 6px;border-radius:var(--radius);width:auto;cursor:pointer}
.writer-title-input{background:transparent;border:none;color:var(--text);font-size:22px;font-weight:700;padding:20px 28px 8px;width:100%;letter-spacing:-0.3px}
.writer-title-input:focus{outline:none}
.writer-title-input::placeholder{color:var(--text-muted)}
.writer-editor{flex:1;overflow-y:auto;padding:0 28px 40px;font-size:15px;line-height:1.85;color:var(--text-secondary);outline:none;min-height:200px}
.writer-editor:empty::before{content:attr(data-placeholder);color:var(--text-muted)}
.writer-editor h1{font-size:24px;font-weight:700;color:var(--text);margin:24px 0 8px;line-height:1.3}
.writer-editor h2{font-size:18px;font-weight:600;color:var(--text);margin:20px 0 6px}
.writer-editor h3{font-size:15px;font-weight:600;color:var(--text);margin:16px 0 4px}
.writer-editor p{margin-bottom:12px}
.writer-editor blockquote{border-left:3px solid var(--accent);padding-left:16px;margin:12px 0;color:var(--text-muted);font-style:italic}
.writer-editor ul,.writer-editor ol{margin:8px 0;padding-left:24px}
.writer-editor li{margin-bottom:4px}
.writer-editor code{background:var(--bg-surface);padding:1px 4px;border-radius:3px;font-family:var(--mono);font-size:13px;color:var(--accent)}
.writer-editor pre{background:var(--bg-surface);padding:12px;border-radius:var(--radius);font-family:var(--mono);font-size:12px;overflow-x:auto;margin:12px 0;border:1px solid var(--border)}
.writer-editor hr{border:none;border-top:1px solid var(--border);margin:20px 0}
.writer-statusbar{display:flex;align-items:center;gap:16px;padding:4px 12px;border-top:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--text-muted);flex-shrink:0}
.writer-right-panel{width:240px;border-left:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0;overflow-y:auto;padding:12px}
.writer-right-panel.hidden{display:none}

/* ZEN WRITER — Full-screen distraction-free writing overlay */
.zen-writer{position:fixed;inset:0;z-index:2000;background:var(--bg-void);display:none;flex-direction:column;opacity:0;transition:opacity 0.3s cubic-bezier(0.4,0,0.2,1)}
.zen-writer.open{display:flex;opacity:1}
.zen-writer-topbar{display:flex;align-items:center;gap:8px;padding:8px 20px;border-bottom:1px solid var(--border);flex-shrink:0;background:linear-gradient(180deg, rgba(10,10,14,0.95) 0%, rgba(5,5,8,0.95) 100%);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.zen-doc-picker{background:var(--bg-input);border:1px solid var(--border);color:var(--text);font-size:11px;padding:5px 10px;border-radius:var(--radius);cursor:pointer;max-width:220px}
.zen-doc-picker:focus{outline:none;border-color:var(--accent)}
.zen-toolbar{display:flex;align-items:center;gap:1px;flex:1;justify-content:center;flex-wrap:wrap}
.zen-tb{width:30px;height:30px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:6px;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all 0.12s;font-weight:600}
.zen-tb:hover{background:var(--bg-hover);color:var(--text)}
.zen-tb.active{background:var(--accent-glow);color:var(--accent)}
.zen-tb-sep{width:1px;height:20px;background:var(--border);margin:0 6px}
.zen-tb-select{background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);font-size:11px;padding:4px 8px;border-radius:var(--radius);cursor:pointer}
.zen-tb-select:focus{outline:none;border-color:var(--accent)}
.zen-close-btn{width:30px;height:30px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:6px;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.12s;margin-left:8px}
.zen-close-btn:hover{background:rgba(248,113,113,0.15);color:var(--red)}
.zen-body{flex:1;display:flex;flex-direction:column;overflow:hidden;max-width:780px;width:100%;margin:0 auto;padding:0 24px}
.zen-title{background:transparent;border:none;color:var(--text);font-size:28px;font-weight:700;padding:32px 0 12px;width:100%;letter-spacing:-0.5px;line-height:1.2}
.zen-title:focus{outline:none}
.zen-title::placeholder{color:var(--text-muted)}
.zen-editor{flex:1;overflow-y:auto;padding:0 0 80px;font-size:17px;line-height:2;color:rgba(255,255,255,0.78);outline:none;caret-color:var(--accent);letter-spacing:0.01em}
.zen-editor:empty::before{content:attr(data-placeholder);color:var(--text-muted);font-style:italic}
.zen-editor h1{font-size:28px;font-weight:700;color:var(--text);margin:28px 0 10px;line-height:1.3;letter-spacing:-0.3px}
.zen-editor h2{font-size:22px;font-weight:600;color:var(--text);margin:24px 0 8px;letter-spacing:-0.2px}
.zen-editor h3{font-size:17px;font-weight:600;color:var(--text);margin:20px 0 6px}
.zen-editor p{margin-bottom:16px}
.zen-editor blockquote{border-left:3px solid var(--accent);padding:4px 0 4px 20px;margin:16px 0;color:rgba(255,255,255,0.45);font-style:italic}
.zen-editor ul,.zen-editor ol{margin:10px 0;padding-left:28px}
.zen-editor li{margin-bottom:6px}
.zen-editor code{background:rgba(74,222,160,0.08);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:15px;color:var(--accent)}
.zen-editor pre{background:var(--bg-surface);padding:16px;border-radius:var(--radius);font-family:var(--mono);font-size:13px;overflow-x:auto;margin:16px 0;border:1px solid var(--border);line-height:1.6}
.zen-editor hr{border:none;border-top:1px solid var(--border);margin:28px 0}
.zen-editor a{color:var(--accent-cyan);text-decoration:underline;text-underline-offset:2px}
.zen-editor ::selection{background:rgba(74,222,160,0.2)}
.zen-statusbar{display:flex;align-items:center;gap:20px;padding:8px 24px;border-top:1px solid var(--border);font-family:var(--mono);font-size:10px;color:var(--text-muted);flex-shrink:0;max-width:780px;width:100%;margin:0 auto}
.zen-statusbar span{transition:color 0.2s}
.zen-fab{position:fixed;bottom:20px;right:20px;z-index:900;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,rgba(74,222,160,0.15) 0%,rgba(34,211,238,0.1) 100%);border:1px solid rgba(74,222,160,0.25);color:var(--accent);cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,0.4);transition:all 0.2s;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.zen-fab:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(74,222,160,0.2);border-color:var(--accent)}
.zen-fab svg{opacity:0.8}
.zen-fab:hover svg{opacity:1}
.writer-version-item{padding:8px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:4px;border:1px solid var(--border)}
.writer-version-item:hover{background:var(--bg-hover);border-color:var(--border-hover)}
.writer-version-title{font-size:10px;color:var(--text);font-weight:500}
.writer-version-meta{font-size:9px;color:var(--text-muted);margin-top:2px}

/* LIVING DOCS */
.specs-shell{display:flex;height:100%;overflow:hidden}
.specs-sidebar{width:220px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0}
.specs-doc-list{flex:1;overflow-y:auto;padding:6px}
.specs-doc-item{padding:10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:2px;border-left:3px solid transparent}
.specs-doc-item:hover{background:var(--bg-hover)}
.specs-doc-item.active{background:var(--accent-glow);border-left-color:var(--accent)}
.specs-doc-title{font-size:11px;color:var(--text);font-weight:600}
.specs-doc-meta{font-size:9px;color:var(--text-muted);margin-top:3px;display:flex;gap:8px}
.specs-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.specs-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.specs-title-input{background:transparent;border:none;color:var(--text);font-size:18px;font-weight:700;flex:1}
.specs-title-input:focus{outline:none}
.specs-title-input::placeholder{color:var(--text-muted)}
.specs-sections{flex:1;overflow-y:auto;padding:20px 24px}
.specs-section{margin-bottom:20px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.specs-section-header{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;transition:background 0.15s}
.specs-section-header:hover{background:var(--bg-hover)}
.specs-section-title{font-size:12px;font-weight:600;color:var(--text);flex:1}
.specs-section-toggle{font-size:10px;color:var(--text-muted);transition:transform 0.2s}
.specs-section.collapsed .specs-section-toggle{transform:rotate(-90deg)}
.specs-section.collapsed .specs-section-body{display:none}
.specs-section-body{padding:12px 14px;border-top:1px solid var(--border)}
.specs-section-editor{min-height:80px;font-size:13px;line-height:1.7;color:var(--text-secondary);outline:none}
.specs-section-editor:empty::before{content:'Click to add content...';color:var(--text-muted)}
.specs-add-section{padding:10px;text-align:center;color:var(--text-muted);font-size:11px;cursor:pointer;border:1px dashed var(--border);border-radius:var(--radius);transition:all 0.15s}
.specs-add-section:hover{border-color:var(--accent);color:var(--text-secondary)}
.specs-statusbar{display:flex;align-items:center;gap:16px;padding:6px 14px;border-top:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--text-muted);flex-shrink:0}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:linear-gradient(160deg, rgba(21,21,24,0.95) 0%, rgba(19,19,22,0.95) 100%);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.06);border-radius:var(--radius-lg);padding:20px;width:400px;max-width:90vw;max-height:80vh;overflow-y:auto;box-shadow:0 24px 48px rgba(0,0,0,0.6),0 0 0 1px rgba(255,255,255,0.03)}
.modal-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:14px}
.form-group{margin-bottom:12px}
.form-label{font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:block}

/* WHITEBOARD */
.wb-shell{display:flex;height:100%;overflow:hidden;position:relative}
.wb-toolbar{position:absolute;top:10px;left:10px;z-index:20;display:flex;gap:3px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
.wb-tool{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:4px;font-size:11px;display:flex;align-items:center;justify-content:center;transition:all 0.1s;font-weight:600}
.wb-tool:hover{background:var(--bg-hover);color:var(--text)}
.wb-tool.active{background:var(--accent-glow);color:var(--accent)}
.wb-tool-sep{width:1px;background:var(--border);margin:2px 1px}
.wb-top-bar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:20;display:flex;gap:6px;align-items:center}
.wb-zoom{display:flex;align-items:center;gap:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:3px 6px;font-family:var(--mono);font-size:9px;color:var(--text-muted)}
.wb-actions{position:absolute;top:10px;right:10px;z-index:20;display:flex;gap:4px}
.wb-canvas-wrap{width:100%;height:100%;overflow:hidden;cursor:crosshair;position:relative;background:var(--bg-void)}
.wb-canvas{position:absolute;transform-origin:0 0}
.wb-grid{position:absolute;inset:0;pointer-events:none;opacity:0.08}
.wb-svg{position:absolute;inset:0;pointer-events:none;z-index:1}
.wb-node{position:absolute;min-width:120px;min-height:50px;background:var(--bg-surface);border:1.5px solid var(--border);border-radius:var(--radius-lg);cursor:grab;z-index:10;transition:box-shadow 0.15s;display:flex;flex-direction:column}
.wb-node:hover{box-shadow:0 4px 16px rgba(0,0,0,0.4);border-color:var(--border-hover)}
.wb-node.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.wb-node.dragging{opacity:0.8;cursor:grabbing;z-index:50}
.wb-node-header{padding:6px 10px;font-size:11px;font-weight:600;color:var(--text);border-bottom:1px solid var(--border);outline:none;min-height:28px;display:flex;align-items:center}
.wb-node-body{padding:6px 10px;font-size:10px;color:var(--text-secondary);outline:none;flex:1;min-height:22px;line-height:1.5}
.wb-node-color{position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--radius-lg) var(--radius-lg) 0 0}
.wb-node-del{position:absolute;top:-8px;right:-8px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:20}
.wb-node:hover .wb-node-del{display:flex}
.wb-node:hover .wb-node-dup{display:flex}
.wb-node:hover .wb-node-color-btn{opacity:0.7}
.wb-node-resize{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:nwse-resize;z-index:15}
.wb-node-port{position:absolute;width:10px;height:10px;border-radius:50%;background:var(--accent);border:2px solid var(--bg-surface);cursor:crosshair;z-index:15;opacity:0;transition:opacity 0.15s}
.wb-node:hover .wb-node-port{opacity:1}
.wb-port-right{right:-5px;top:50%;transform:translateY(-50%)}
.wb-port-bottom{bottom:-5px;left:50%;transform:translateX(-50%)}
.wb-port-left{left:-5px;top:50%;transform:translateY(-50%)}
.wb-port-top{top:-5px;left:50%;transform:translateX(-50%)}
.wb-minimap{position:absolute;bottom:10px;right:10px;width:160px;height:100px;background:linear-gradient(135deg, #0e0e12 0%, #0c0c0f 100%);border:1px solid var(--border);border-radius:var(--radius);z-index:20;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
.wb-minimap-viewport{position:absolute;border:1.5px solid var(--accent);background:rgba(74,222,160,0.06);pointer-events:none}
.wb-minimap-node{position:absolute;background:var(--accent);border-radius:1px;opacity:0.5}
.wb-tpl-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:none;align-items:center;justify-content:center}
.wb-tpl-modal.open{display:flex}
.wb-tpl-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-height:60vh;overflow-y:auto;padding:4px}
.wb-tpl-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;cursor:pointer;transition:all 0.15s;text-align:center}
.wb-tpl-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 16px rgba(74,222,160,0.12)}
.wb-tpl-icon{font-size:24px;margin-bottom:6px}
.wb-tpl-name{font-size:11px;font-weight:600;color:var(--text)}
.wb-tpl-desc{font-size:9px;color:var(--text-muted);margin-top:3px}

/* PROJECTS SIDEBAR */
.sidebar-projects{padding:6px 12px}
.sidebar-project-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:12px;color:var(--text-secondary);position:relative}
.sidebar-project-item:hover{background:var(--bg-hover);color:var(--text)}
.sidebar-project-item.active{background:var(--accent-glow);color:var(--accent)}
.sidebar-project-item .proj-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sidebar-project-item .proj-icon svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.sidebar-project-item .proj-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sidebar-project-item .proj-status{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.sidebar-project-item .proj-status.active-s{background:var(--green)}
.sidebar-project-item .proj-status.paused-s{background:var(--yellow)}
.sidebar-project-item .proj-status.complete-s{background:var(--accent)}
.sidebar-add-project{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:11px;color:var(--text-muted)}
.sidebar-add-project:hover{color:var(--text-secondary);background:var(--bg-hover)}

/* PROJECT DETAIL VIEW — right panel */
.project-view{display:none;flex-direction:column;height:100vh;overflow:hidden;background:linear-gradient(180deg, #080810 0%, #060608 100%);border-left:1px solid var(--border)}
.project-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.project-header .proj-icon-lg{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);border:1px solid var(--border)}
.project-header .proj-icon-lg svg{width:18px;height:18px;stroke:var(--accent);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.project-header-name{font-size:18px;font-weight:700;color:var(--text);flex:1}
.project-header-actions{display:flex;gap:4px;position:relative}
.export-menu{position:absolute;top:100%;right:0;margin-top:6px;background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:var(--radius-lg);padding:6px;min-width:180px;z-index:999;box-shadow:0 8px 32px rgba(0,0,0,0.5);backdrop-filter:blur(20px);animation:fadeIn 0.12s ease}
.export-menu-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:var(--radius);cursor:pointer;font-size:11px;color:var(--text-secondary);transition:all 0.12s}
.export-menu-item:hover{background:var(--bg-hover);color:var(--text)}
.export-menu-item .export-icon{width:16px;text-align:center;font-family:var(--mono);font-size:9px;color:var(--accent)}
.export-menu-label{font-weight:500}
.export-menu-desc{font-size:9px;color:var(--text-muted)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.project-tabs{display:flex;gap:2px;padding:0 24px;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.project-tabs::-webkit-scrollbar{display:none}
.project-tab{white-space:nowrap;flex-shrink:0}
.project-tab{padding:8px 14px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:11px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s}
.project-tab:hover{color:var(--text-secondary)}
.project-tab.active{color:var(--proj-accent, var(--accent));border-bottom-color:var(--proj-accent, var(--accent))}
.project-content{flex:1;overflow-y:auto;padding:20px 24px}

/* PROJECT INSTRUCTIONS */
.proj-instructions-editor{min-height:200px;font-size:14px;line-height:1.8;color:var(--text-secondary);outline:none;padding:12px 0}
.proj-instructions-editor:empty::before{content:'Describe what this project is...';color:var(--text-muted)}
.proj-instructions-editor h1{font-size:22px;font-weight:700;color:var(--text);margin:20px 0 8px}
.proj-instructions-editor h2{font-size:17px;font-weight:600;color:var(--text);margin:16px 0 6px}
.proj-instructions-editor h3{font-size:14px;font-weight:600;color:var(--text);margin:12px 0 4px}
.proj-instructions-editor p{margin-bottom:10px}
.proj-instructions-editor ul,.proj-instructions-editor ol{padding-left:24px;margin:8px 0}
.proj-instructions-editor li{margin-bottom:4px}
.proj-instructions-editor code{background:var(--bg-surface);padding:1px 4px;border-radius:3px;font-family:var(--mono);font-size:12px;color:var(--accent)}
.proj-instructions-editor pre{background:var(--bg-surface);padding:12px;border-radius:var(--radius);font-family:var(--mono);font-size:11px;overflow-x:auto;margin:12px 0;border:1px solid var(--border)}
.proj-instructions-editor blockquote{border-left:3px solid var(--accent);padding-left:16px;margin:12px 0;color:var(--text-muted);font-style:italic}
.proj-instructions-editor table{width:100%;border-collapse:collapse;margin:12px 0;font-size:12px}
.proj-instructions-editor th,.proj-instructions-editor td{border:1px solid var(--border);padding:6px 10px;text-align:left}
.proj-instructions-editor th{background:var(--bg-surface);font-weight:600;color:var(--text)}

/* KNOWLEDGE BASE */
.kb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;padding-top:12px}
.kb-card{background:linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;cursor:pointer;position:relative}
.kb-card:hover{border-color:var(--border-hover);box-shadow:0 2px 12px rgba(0,0,0,0.3);transform:translateY(-1px)}
.kb-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.kb-card-type{font-family:var(--mono);font-size:8px;letter-spacing:0.5px;text-transform:uppercase;padding:2px 6px;border-radius:3px;line-height:1;flex-shrink:0}
.kb-type-md{background:rgba(59,130,246,0.15);color:#60a5fa}
.kb-type-pdf{background:rgba(239,68,68,0.15);color:#f87171}
.kb-type-img{background:rgba(34,197,94,0.15);color:#4ade80}
.kb-type-url{background:rgba(139,92,246,0.15);color:#a78bfa}
.kb-type-txt{background:rgba(255,255,255,0.08);color:var(--text-muted)}
.kb-type-json{background:rgba(251,191,36,0.15);color:#fbbf24}
.kb-type-other{background:rgba(255,255,255,0.06);color:var(--text-muted)}
.kb-card-name{font-size:12px;font-weight:600;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.kb-card-desc{font-size:10px;color:var(--text-secondary);line-height:1.5;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.kb-card-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:8px}
.kb-card-tag{font-family:var(--mono);font-size:7px;padding:1px 5px;background:rgba(255,255,255,0.05);border-radius:3px;color:var(--text-muted)}
.kb-card-actions{position:absolute;top:8px;right:8px;display:flex;gap:2px;opacity:0;transition:opacity 0.15s}
.kb-card:hover .kb-card-actions{opacity:1}
.kb-card-drag{cursor:grab;width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:10px}
.kb-card-img{width:100%;height:100px;object-fit:cover;border-radius:var(--radius);margin-top:8px;border:1px solid var(--border)}
.kb-empty{text-align:center;padding:40px;color:var(--text-muted);font-size:12px}

/* PROJECT LIVING DOCS LIST */
.proj-docs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;padding-top:12px}
.proj-doc-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;cursor:pointer;transition:all 0.2s}
.proj-doc-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 16px rgba(74,222,160,0.08)}
.proj-doc-card-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px}
.proj-doc-card-meta{font-size:9px;color:var(--text-muted);display:flex;gap:8px}
.proj-doc-card-preview{font-size:10px;color:var(--text-secondary);line-height:1.5;margin-top:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* ICON PICKER */
.icon-picker-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1100;display:none;align-items:center;justify-content:center}
.icon-picker-modal.open{display:flex}
.icon-picker-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:50vh;overflow-y:auto;padding:8px}
.icon-picker-item{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius);border:1px solid var(--border);cursor:pointer;transition:all 0.15s;background:var(--bg-surface)}
.icon-picker-item:hover{border-color:var(--accent);background:var(--accent-glow)}
.icon-picker-item.selected{border-color:var(--accent);background:var(--accent-glow);box-shadow:0 0 0 2px rgba(74,222,160,0.2)}
.icon-picker-item svg{width:18px;height:18px;stroke:var(--text-secondary);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.icon-picker-item:hover svg,.icon-picker-item.selected svg{stroke:var(--accent)}

.pm-color-opt{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.pm-color-opt:hover{transform:scale(1.2)}
.pm-color-opt.selected{border-color:#fff;box-shadow:0 0 8px currentColor}

/* KB MODAL */
.kb-modal-tabs{display:flex;gap:2px;margin-bottom:12px}
.kb-modal-tab{padding:5px 10px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:var(--radius);transition:all 0.15s}
.kb-modal-tab:hover{color:var(--text-secondary);background:var(--bg-surface)}
.kb-modal-tab.active{background:var(--accent-glow);color:var(--accent)}
.kb-modal-panel{display:none}
.kb-modal-panel.active{display:block}

/* VOICE INPUT */
.voice-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.voice-btn:hover{background:var(--bg-hover);color:var(--text)}
.voice-btn.recording{background:rgba(239,68,68,0.2);color:var(--red);animation:voice-pulse 1s infinite}
@keyframes voice-pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* WIKI LINKS */
.wiki-link{color:var(--accent);cursor:pointer;border-bottom:1px dashed rgba(74,222,160,0.4);padding-bottom:1px;transition:var(--transition-fast)}
.wiki-link:hover{border-bottom-color:var(--accent);background:var(--accent-glow);border-radius:2px}
.wiki-link-broken{color:var(--red);border-bottom:1px dashed rgba(248,113,113,0.4)}

/* FOLDER TREE */
.folder-tree{padding:4px 0}
.folder-item{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast);font-size:11px;color:var(--text-secondary)}
.folder-item:hover{background:var(--bg-hover);color:var(--text)}
.folder-item.active{background:var(--accent-glow);color:var(--accent)}
.folder-item-icon{font-size:10px;color:var(--text-muted);width:14px;text-align:center}
.folder-item-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.folder-item-count{font-size:9px;color:var(--text-muted);font-family:var(--mono)}

/* COMMAND PALETTE */
.cmd-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);z-index:9000;display:none;align-items:flex-start;justify-content:center;padding-top:20vh}
.cmd-overlay.open{display:flex}
.cmd-box{width:560px;max-width:90vw;background:linear-gradient(180deg, #101014 0%, #0c0c0f 100%);border:1px solid var(--border-hover);border-radius:var(--radius-lg);box-shadow:0 24px 80px rgba(0,0,0,0.7);overflow:hidden;animation:cmdSlideIn 0.15s ease}
@keyframes cmdSlideIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
.cmd-input-wrap{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);gap:10px}
.cmd-input-icon{color:var(--text-muted);font-size:14px;flex-shrink:0}
.cmd-input{flex:1;background:none;border:none;color:var(--text);font-size:15px;font-family:var(--font);outline:none}
.cmd-input::placeholder{color:var(--text-muted)}
.cmd-hint{font-size:9px;color:var(--text-muted);font-family:var(--mono);flex-shrink:0}
.cmd-results{max-height:360px;overflow-y:auto;padding:6px}
.cmd-item{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast)}
.cmd-item:hover,.cmd-item.active{background:var(--bg-hover)}
.cmd-item.active{background:var(--accent-glow);border:1px solid rgba(74,222,160,0.15)}
.cmd-item-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);font-size:12px;color:var(--text-muted);flex-shrink:0}
.cmd-item-text{flex:1;min-width:0}
.cmd-item-title{font-size:13px;color:var(--text);font-weight:500}
.cmd-item-desc{font-size:10px;color:var(--text-muted);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cmd-item-badge{font-family:var(--mono);font-size:8px;padding:2px 6px;border-radius:3px;background:rgba(255,255,255,0.05);color:var(--text-muted)}
.cmd-footer{display:flex;align-items:center;gap:12px;padding:8px 14px;border-top:1px solid var(--border);font-size:9px;color:var(--text-muted);font-family:var(--mono)}
.cmd-key{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 4px;background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:3px;font-size:9px;color:var(--text-muted)}

/* CONTEXT PANEL */
.context-panel{display:none;flex-direction:column;height:100vh;overflow:hidden;background:linear-gradient(180deg, #0a0a0e 0%, #080810 100%);border-left:1px solid var(--border)}
.context-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.context-header-title{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;flex:1}
.context-close{width:22px;height:22px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:12px;display:flex;align-items:center;justify-content:center}
.context-close:hover{background:var(--bg-hover);color:var(--text)}
.context-body{flex:1;overflow-y:auto;padding:12px 16px}
.context-section{margin-bottom:16px}
.context-section-title{font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.context-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast);font-size:11px;color:var(--text-secondary)}
.context-item:hover{background:var(--bg-hover);color:var(--text)}
.context-item-icon{width:14px;text-align:center;font-size:10px;color:var(--text-muted);flex-shrink:0}

/* MODE SWITCHER */
.mode-switcher{display:flex;align-items:center;gap:2px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:2px}
.mode-btn{padding:3px 8px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:9px;font-weight:500;cursor:pointer;border-radius:4px;transition:var(--transition-fast);text-transform:uppercase;letter-spacing:0.3px}
.mode-btn:hover{color:var(--text-secondary)}
.mode-btn.active{background:var(--accent-glow);color:var(--accent)}

/* FOCUS TIMER EMBEDDED */
.focus-timer-panel{padding:16px}
.ft-circle-wrap{position:relative;width:160px;height:160px;margin:0 auto 16px}
.ft-circle{width:100%;height:100%;transform:rotate(-90deg)}
.ft-circle .ft-track{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:6}
.ft-circle .ft-progress{fill:none;stroke:var(--accent);stroke-width:6;stroke-linecap:round;stroke-dasharray:440.9;stroke-dashoffset:440.9;transition:stroke-dashoffset 1s ease,stroke 0.3s ease;filter:drop-shadow(0 0 8px var(--accent))}
.ft-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.ft-time{font-size:28px;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums;letter-spacing:-0.02em}
.ft-label{font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;margin-top:2px}
.ft-controls{display:flex;justify-content:center;gap:8px}
.ft-btn{padding:6px 16px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-secondary);font-size:11px;font-weight:500;cursor:pointer;transition:var(--transition-fast)}
.ft-btn:hover{border-color:var(--border-active);color:var(--text)}
.ft-btn.running{background:var(--accent);color:var(--bg-void);border-color:var(--accent)}
.ft-categories{display:flex;flex-wrap:wrap;gap:4px;margin-top:12px;justify-content:center}
.ft-cat{padding:3px 8px;border:1px solid var(--border);border-radius:var(--radius);font-size:9px;color:var(--text-muted);cursor:pointer;transition:var(--transition-fast)}
.ft-cat:hover{border-color:var(--border-hover);color:var(--text-secondary)}
.ft-cat.active{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}
.ft-time-adjust{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:10px}
.ft-adj-btn{width:24px;height:24px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition-fast)}
.ft-adj-btn:hover{background:var(--accent);color:var(--bg-void);border-color:var(--accent)}

/* RESPONSIVE */
@media(max-width:900px){
  :root{--sidebar-width:180px;--context-width:260px}
  .writer-sidebar{width:160px}
  .specs-sidebar{width:180px}
  .content-grid{grid-template-columns:1fr}
  .links-grid{grid-template-columns:1fr}
}
@media(max-width:640px){
  .app{grid-template-columns:1fr!important}
  .sidebar{position:fixed;left:-220px;top:0;bottom:0;width:220px;z-index:100;transition:left 0.25s}
  .sidebar.mobile-open{left:0}
  .sidebar-resize{display:none!important}
  .context-panel{display:none!important}
  .context-resize{display:none!important}
  .writer-shell{flex-direction:column}
  .writer-sidebar{width:100%;height:auto;max-height:120px;border-right:none;border-bottom:1px solid var(--border)}
  .writer-right-panel{display:none}
  .specs-shell{flex-direction:column}
  .specs-sidebar{width:100%;height:auto;max-height:120px;border-right:none;border-bottom:1px solid var(--border)}
  .mobile-hamburger{display:block!important}
  .mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
  .mobile-overlay.open{display:block}
  .board-columns{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap}
  .board-column{min-width:240px;flex-shrink:0}
  .calendar-grid{font-size:9px}
  .calendar-day{min-height:50px;padding:2px}
  .week-grid{grid-template-columns:1fr!important;gap:4px}
  .week-day{min-height:60px}
  .task-detail-inner{width:95vw;padding:16px}
  .panel-project{position:fixed;inset:0;z-index:110;width:100%!important;max-width:100%!important}
  .header{padding:4px 8px}
  .header-left{gap:6px}
}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg, #101014 0%, #161619 100%);border:1px solid rgba(74,222,160,0.12);border-radius:var(--radius);padding:8px 14px;font-size:11px;color:var(--text);opacity:0;transform:translateY(10px);transition:all 0.3s;z-index:2000;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
.toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">SATURNO HUB</div>
      <div class="logo-sub">v2.0 — Command Center</div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Sections</div>
      <div class="sidebar-item active" onclick="switchSection('content',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span><span>Content</span>
        <span class="sidebar-item-count" id="content-count">0</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('tasks',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span><span>Tasks</span>
        <span class="sidebar-item-count" id="tasks-count">0</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('calendar',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span><span>Calendar</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('writer',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></svg></span><span>Writing Hub</span>
        <span class="sidebar-item-count" id="writer-count">0</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('specs',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span><span>Living Docs</span>
        <span class="sidebar-item-count" id="specs-count">0</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('links',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></span><span>Links</span>
        <span class="sidebar-item-count" id="links-count">0</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('whiteboard',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></span><span>Whiteboard</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('pipeline',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg></span><span>Pipeline</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('repos',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/><path d="M1 12h6m6 0h6"/></svg></span><span>Repos</span>
      </div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section">
      <div class="sidebar-label" style="display:flex;align-items:center;justify-content:space-between">
        <span>Projects</span>
        <span class="sidebar-add-project" onclick="openNewProjectModal()" style="padding:0;font-size:13px;font-weight:600" title="New Project">+</span>
      </div>
      <div id="sidebar-projects"></div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section" id="sidebar-folders-section">
      <div class="sidebar-label" style="display:flex;align-items:center;justify-content:space-between">
        <span>Folders</span>
        <span onclick="addFolderFromSidebar()" style="padding:0;font-size:13px;font-weight:600;cursor:pointer;color:var(--text-muted)" title="New Folder">+</span>
      </div>
      <div class="folder-tree" id="sidebar-folder-tree"></div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section" id="sidebar-context"></div>
    <div id="sidebar-bottom" style="margin-top:auto;padding:12px">
      <button class="btn btn-sm" style="width:100%;margin-bottom:6px;justify-content:center;gap:6px" onclick="openCommandPalette()">
        <span style="font-size:10px">Search</span>
        <span style="font-family:var(--mono);font-size:8px;padding:1px 4px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px">K</span>
      </button>
      <button class="btn btn-sm" style="width:100%;margin-bottom:4px" onclick="window.open('https://calendar.google.com','_blank')">Google Calendar</button>
      <div id="sidebar-dash" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:6px">
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:600" id="dash-tasks">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Tasks</div>
        </div>
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--accent-cyan);font-weight:600" id="dash-docs">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Docs</div>
        </div>
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--yellow);font-weight:600" id="dash-projects">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Proj</div>
        </div>
      </div>
      <div style="font-family:var(--mono);font-size:8px;color:var(--text-muted);text-align:center;margin-top:4px">
        <span id="storage-indicator">0 KB</span> used
      </div>
      <div style="display:flex;gap:4px;margin-top:6px">
        <button class="btn btn-sm" style="flex:1" onclick="exportAll()">Export</button>
        <button class="btn btn-sm" style="flex:1" onclick="importAll()">Import</button>
      </div>
      <button class="btn btn-sm btn-danger" style="width:100%;margin-top:4px;font-size:8px;opacity:0.5" onclick="undoImport()">Undo Import</button>
    </div>
    <div class="sidebar-collapse-chevron" onclick="toggleSidebar()" title="Collapse sidebar">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg>
    </div>
  </aside>
  <div class="sidebar-resize" id="sidebar-resize"></div>

  <main class="main">
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileSidebar()"></div>
    <div class="header">
      <button class="mobile-hamburger" onclick="openMobileSidebar()" style="display:none;background:none;border:none;color:var(--text);cursor:pointer;padding:4px"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <button class="btn btn-sm btn-ghost sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar" id="sidebar-toggle-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg></button>
      <span class="header-title" id="header-title">Content</span>
      <span id="header-breadcrumb" style="font-size:10px;color:var(--text-muted);font-family:var(--mono);display:flex;align-items:center;gap:4px"></span>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <span id="header-stats" style="font-size:8px;color:var(--text-muted);font-family:var(--mono);display:flex;gap:8px;align-items:center"></span>
        <span id="save-indicator" style="font-family:var(--mono);font-size:8px;color:var(--text-muted);opacity:0;transition:opacity 0.3s">Saved</span>
        <input type="text" id="header-search" placeholder="Search... (Cmd+K)" onfocus="this.blur();openCommandPalette()" style="font-size:9px;padding:3px 8px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;width:120px;font-family:var(--mono);cursor:pointer" readonly>
        <span id="cloud-sync-indicator" onclick="cloudSave()" title="Click to sync" style="cursor:pointer;font-size:12px;opacity:0.5;transition:all 0.3s">&#9729;</span>
        <div class="mode-switcher">
          <button class="mode-btn" onclick="setMode('focus')" id="mode-focus-btn" title="Focus: Primary only">F</button>
          <button class="mode-btn active" onclick="setMode('default')" id="mode-default-btn" title="Default">D</button>
          <button class="mode-btn" onclick="setMode('extended')" id="mode-extended-btn" title="Extended: Show context panel">E</button>
        </div>
        <button class="btn btn-sm btn-ghost" onclick="openCommandPalette()" title="Command Palette (Cmd+K)" style="font-family:var(--mono);font-size:9px;padding:3px 8px;gap:4px">
          <span class="cmd-key" style="min-width:14px;height:14px;font-size:8px">K</span>
        </button>
        <div class="header-actions" id="header-actions"></div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="panel active" id="panel-content">
      <div style="padding:16px 20px 0;display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <div class="tab-bar" id="content-type-tabs">
          <button class="tab-btn active" onclick="setContentType('all',this)">All</button>
          <button class="tab-btn" onclick="setContentType('caption',this)">Captions</button>
          <button class="tab-btn" onclick="setContentType('quote',this)">Quotes</button>
        </div>
        <div class="tab-bar" id="content-theme-tabs" style="margin-left:8px;border-left:1px solid var(--border);padding-left:8px"></div>
        <div style="margin-left:auto;display:flex;gap:6px">
          <input type="text" id="content-search" placeholder="Search..." oninput="renderContent()" style="width:140px;font-size:10px;padding:5px 8px">
          <select id="content-sort" onchange="renderContent()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="longest">Longest</option>
            <option value="shortest">Shortest</option>
            <option value="alpha">A-Z</option>
          </select>
          <span id="content-word-total" style="font-size:8px;color:var(--text-muted);font-family:var(--mono)"></span>
          <button class="btn btn-sm" onclick="randomContent()" title="Random content for inspiration">Random</button>
          <button class="btn btn-sm" onclick="exportContent()" title="Export all content as markdown">Export</button>
          <button class="btn btn-sm" onclick="contentManageTags()" title="Rename or delete tags">Tags</button>
          <button class="btn btn-sm" id="content-bulk-btn" onclick="toggleContentBulk()" title="Select multiple">Select</button>
          <div id="content-bulk-actions" style="display:none;gap:4px">
            <button class="btn btn-sm btn-danger" onclick="contentBulkDelete()">Delete Selected</button>
            <button class="btn btn-sm" onclick="contentBulkTag()">Tag Selected</button>
            <button class="btn btn-sm" onclick="mergeContent()">Merge Selected</button>
            <button class="btn btn-sm" onclick="contentBulkExport()">Export Selected</button>
            <button class="btn btn-sm" onclick="toggleContentBulk()">Cancel</button>
          </div>
          <button class="btn btn-primary btn-sm" onclick="openContentModal()">+ Add</button>
        </div>
      </div>
      <div id="content-tag-pills" style="padding:0 20px;display:flex;gap:4px;flex-wrap:wrap;flex-shrink:0"></div>
      <div class="content-area"><div class="content-grid" id="content-grid"></div></div>
    </div>

    <!-- TASKS -->
    <div class="panel" id="panel-tasks">
      <div style="padding:12px 20px 0;flex-shrink:0">
        <div class="task-toolbar">
          <button class="btn btn-primary btn-sm" onclick="addTask()">+ Task</button>
          <div class="btn-group" style="position:relative;display:inline-block"><button class="btn btn-sm" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'" title="Task templates">T</button><div style="display:none;position:absolute;top:100%;left:0;z-index:100;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:4px;min-width:160px;box-shadow:0 8px 24px rgba(0,0,0,0.4)"><div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;letter-spacing:0.05em">Quick Templates</div><div class="task-tpl" onclick="addTaskFromTemplate('Daily standup','p1','daily')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Daily standup</div><div class="task-tpl" onclick="addTaskFromTemplate('Code review','p2','weekly')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Code review (weekly)</div><div class="task-tpl" onclick="addTaskFromTemplate('Content batch','p1','weekly')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Content batch (weekly)</div><div class="task-tpl" onclick="addTaskFromTemplate('Write session','p1','daily')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Write session (daily)</div><div class="task-tpl" onclick="addTaskFromTemplate('Deploy check','p2','weekday')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Deploy check (weekday)</div></div></div>
          <div class="tab-bar">
            <button class="tab-btn active" id="task-view-list" onclick="setTaskView('list')">List</button>
            <button class="tab-btn" id="task-view-board" onclick="setTaskView('board')">Board</button>
          </div>
          <div class="tab-bar" style="margin-left:8px">
            <button class="tab-btn active" id="task-filter-all" onclick="setTaskFilter('all')">All</button>
            <button class="tab-btn" id="task-filter-active" onclick="setTaskFilter('active')">Active</button>
            <button class="tab-btn" id="task-filter-done" onclick="setTaskFilter('done')">Done</button>
          </div>
          <select id="task-project-filter" onchange="filterTaskProject(this.value||null)" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;max-width:100px"><option value="">All Projects</option></select>
          <select id="task-sort" onchange="renderTasks()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px">
            <option value="manual">Manual</option>
            <option value="priority">Priority</option>
            <option value="due">Due Date</option>
            <option value="newest">Newest</option>
            <option value="alpha">A-Z</option>
          </select>
          <button class="btn btn-sm" onclick="exportTasks()" title="Copy tasks as markdown">Export</button>
          <button class="btn btn-sm" onclick="toggleTaskBulk()" id="task-bulk-btn">Bulk</button>
          <div id="task-bulk-actions" style="display:none;gap:4px;align-items:center">
            <select id="task-bulk-status" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="">Set Status</option><option value="todo">To Do</option><option value="progress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select>
            <select id="task-bulk-priority" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="">Set Priority</option><option value="p0">P0</option><option value="p1">P1</option><option value="p2">P2</option><option value="p3">P3</option></select>
            <button class="btn btn-sm btn-danger" onclick="taskBulkDelete()">Delete</button>
            <button class="btn btn-sm" onclick="taskBulkApply()">Apply</button>
            <button class="btn btn-sm" onclick="toggleTaskBulk()">Cancel</button>
          </div>
          <button class="btn btn-sm" onclick="archiveCompletedTasks()" title="Archive all completed tasks">Archive Done</button>
          <button class="btn btn-sm" id="task-filter-archived" onclick="showArchivedTasks()" title="View archived tasks">Archived<span id="archived-count" style="font-size:8px;color:var(--text-muted);margin-left:3px;font-family:var(--mono)"></span></button>
          <div class="task-toolbar-search">
            <input type="text" id="task-search" placeholder="Search tasks..." oninput="renderTasks()" style="font-size:10px;padding:5px 8px">
          </div>
        </div>
      </div>
      <div class="content-area" id="task-content-area">
        <div id="task-list-view">
          <div class="task-table-header">
            <div class="task-table-header-cell"></div>
            <div class="task-table-header-cell">Task</div>
            <div class="task-table-header-cell">Status</div>
            <div class="task-table-header-cell">Priority</div>
            <div class="task-table-header-cell">Project</div>
            <div class="task-table-header-cell">Due</div>
            <div class="task-table-header-cell"></div>
          </div>
          <div id="task-rows"></div>
        </div>
        <div class="board-view" id="task-board-view">
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">To Do</span><span class="board-col-count" id="bc-todo" oncontextmenu="event.preventDefault();boardMoveAll('todo')">0</span></div><div class="board-col-tasks" id="board-todo" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'todo')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">In Progress</span><span class="board-col-count" id="bc-progress" oncontextmenu="event.preventDefault();boardMoveAll('progress')">0</span></div><div class="board-col-tasks" id="board-progress" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'progress')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">Done</span><span class="board-col-count" id="bc-done" oncontextmenu="event.preventDefault();boardMoveAll('done')">0</span></div><div class="board-col-tasks" id="board-done" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'done')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">Blocked</span><span class="board-col-count" id="bc-blocked" oncontextmenu="event.preventDefault();boardMoveAll('blocked')">0</span></div><div class="board-col-tasks" id="board-blocked" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'blocked')"></div></div>
        </div>
      </div>
    </div>

    <!-- CALENDAR -->
    <div class="panel" id="panel-calendar">
      <div class="content-area" style="display:flex;flex-direction:column">
        <div class="calendar-shell">
          <div class="calendar-nav">
            <button class="btn btn-sm" onclick="calNav(-1)">Prev</button>
            <button class="btn btn-sm" onclick="calNav(1)">Next</button>
            <span class="calendar-month-label" id="cal-month-label"></span>
            <button class="btn btn-sm" onclick="calToday()">Today</button>
            <div class="cal-view-toggle">
              <button class="cal-view-btn active" id="cal-view-month" onclick="setCalView('month')">Month</button>
              <button class="cal-view-btn" id="cal-view-week" onclick="setCalView('week')">Week</button>
            </div>
            <div style="margin-left:auto;display:flex;gap:6px">
              <button class="btn btn-sm" onclick="window.open('https://calendar.google.com','_blank')">Google Cal</button>
              <button class="btn btn-sm" onclick="exportICS()">Export .ics</button>
              <button class="btn btn-sm" onclick="importICS()">Import .ics</button>
            </div>
          </div>
          <div id="cal-today-summary" style="padding:6px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);margin:0 0 8px 0;font-size:10px;color:var(--text-secondary);display:none"></div>
          <div class="calendar-grid" id="cal-grid"></div>
          <div class="week-grid" id="cal-week-grid" style="display:none"></div>
        </div>
        <div id="cal-upcoming" style="padding:8px 0 0;border-top:1px solid var(--border);margin-top:8px"></div>
      </div>
    </div>

    <!-- WRITER -->
    <div class="panel" id="panel-writer">
      <div class="writer-shell">
        <div class="writer-sidebar">
          <div style="padding:8px;border-bottom:1px solid var(--border);display:flex;gap:4px">
            <button class="btn btn-primary btn-sm" style="flex:1" onclick="newDoc()">+ New</button>
            <button class="btn btn-sm" onclick="toggleWriterPanel()">H</button>
          </div>
          <div class="writer-doc-list" id="writer-doc-list"></div>
        </div>
        <div class="writer-main">
          <div class="writer-toolbar">
            <select class="writer-toolbar-select" id="writer-block-type" onchange="execBlock(this.value)">
              <option value="p">Paragraph</option>
              <option value="h1">Heading 1</option>
              <option value="h2">Heading 2</option>
              <option value="h3">Heading 3</option>
              <option value="blockquote">Quote</option>
              <option value="pre">Code Block</option>
            </select>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="execCmd('bold')" title="Bold"><b>B</b></button>
            <button class="writer-toolbar-btn" onclick="execCmd('italic')" title="Italic"><i>I</i></button>
            <button class="writer-toolbar-btn" onclick="execCmd('underline')" title="Underline"><u>U</u></button>
            <button class="writer-toolbar-btn" onclick="execCmd('strikeThrough')"><s>S</s></button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="execCmd('insertUnorderedList')">*</button>
            <button class="writer-toolbar-btn" onclick="execCmd('insertOrderedList')">1.</button>
            <button class="writer-toolbar-btn" onclick="execCmd('indent')">&gt;</button>
            <button class="writer-toolbar-btn" onclick="execCmd('outdent')">&lt;</button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="insertLink()">Ln</button>
            <button class="writer-toolbar-btn" onclick="insertHR()">--</button>
            <button class="writer-toolbar-btn" onclick="insertCodeInline()">{}</button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="clearFormatting()">Tx</button>
            <div style="margin-left:auto;display:flex;gap:2px">
              <button class="voice-btn" id="writer-voice-btn" onclick="toggleVoice('writer')" title="Voice Input">M</button>
              <button class="writer-toolbar-btn" onclick="writerTOC()" title="Insert Table of Contents">TOC</button>
              <button class="writer-toolbar-btn" onclick="writerToContent()" title="Save to Content section">C+</button>
              <button class="writer-toolbar-btn" onclick="saveVersion()" title="Save Version">v+</button>
              <button class="writer-toolbar-btn" onclick="toggleWriterPanel()" title="History">H</button>
              <select class="writer-toolbar-select" id="writer-export-sel" onchange="writerExport(this.value);this.selectedIndex=0">
                <option value="">Export</option>
                <option value="md">Markdown</option>
                <option value="html">HTML</option>
                <option value="txt">Plain Text</option>
                <option value="clipboard">Copy All</option>
              </select>
            </div>
          </div>
          <div id="writer-find-bar" style="display:none;padding:4px 8px;background:var(--bg-elevated);border-bottom:1px solid var(--border);display:none;align-items:center;gap:6px;flex-shrink:0">
            <input type="text" id="writer-find-input" placeholder="Find..." style="flex:1;font-size:10px;padding:4px 8px;max-width:200px" oninput="writerFindNext()" onkeydown="if(event.key==='Enter'){event.preventDefault();writerFindNext();}if(event.key==='Escape'){writerFindClose();}">
            <input type="text" id="writer-replace-input" placeholder="Replace..." style="flex:1;font-size:10px;padding:4px 8px;max-width:200px" onkeydown="if(event.key==='Escape'){writerFindClose();}">
            <button class="btn btn-sm btn-ghost" onclick="writerReplace()" style="font-size:9px;padding:2px 6px">Replace</button>
            <button class="btn btn-sm btn-ghost" onclick="writerReplaceAll()" style="font-size:9px;padding:2px 6px">All</button>
            <span id="writer-find-count" style="font-size:9px;color:var(--text-muted);font-family:var(--mono)"></span>
            <button class="btn btn-sm btn-ghost" onclick="writerFindClose()" style="font-size:9px;padding:2px 4px">x</button>
          </div>
          <div class="writer-editor-wrap" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
            <input type="text" class="writer-title-input" id="writer-title" placeholder="Untitled Document" oninput="onWriterChange()">
            <div class="writer-editor" id="writer-editor" contenteditable="true" data-placeholder="Start writing..." oninput="onWriterChange()" onkeydown="writerKeydown(event)"></div>
          </div>
          <div class="writer-statusbar">
            <span id="ws-words">0 words</span>
            <span id="ws-chars">0 chars</span>
            <span id="ws-reading">0 min read</span>
            <span id="ws-goal" style="cursor:pointer" onclick="setWriterGoal()" title="Click to set word goal"></span>
            <span id="ws-saved" style="margin-left:auto">Saved</span>
          </div>
        </div>
        <div class="writer-right-panel hidden" id="writer-right-panel">
          <div class="sidebar-label" style="padding:0;margin-bottom:8px">Version History</div>
          <div id="writer-versions"></div>
        </div>
      </div>
    </div>

    <!-- LIVING DOCS -->
    <div class="panel" id="panel-specs">
      <div class="specs-shell">
        <div class="specs-sidebar">
          <div style="padding:8px;border-bottom:1px solid var(--border);display:flex;gap:4px">
            <button class="btn btn-primary btn-sm" style="flex:1" onclick="newSpec()">+ New Spec</button>
            <select class="writer-toolbar-select" onchange="specExport(this.value);this.selectedIndex=0" style="width:auto">
              <option value="">Export</option>
              <option value="md">Markdown</option>
              <option value="html">HTML</option>
              <option value="clipboard">Copy All</option>
            </select>
          </div>
          <div class="specs-doc-list" id="specs-doc-list"></div>
        </div>
        <div class="specs-main" id="specs-main">
          <div class="specs-header">
            <input type="text" class="specs-title-input" id="specs-title" placeholder="Project Name..." oninput="onSpecChange()">
            <button class="voice-btn" id="specs-voice-btn" onclick="toggleVoice('specs')" title="Voice Input">M</button>
            <button class="btn btn-sm" onclick="addSpecSection()">+ Section</button>
            <input type="text" id="spec-search" placeholder="Search sections..." oninput="specSearch()" style="width:120px;font-size:10px;padding:4px 8px">
            <button class="btn btn-sm" onclick="collapseAllSections()" title="Collapse all">Collapse</button>
            <button class="btn btn-sm" onclick="expandAllSections()" title="Expand all">Expand</button>
          </div>
          <div class="specs-sections" id="specs-sections"></div>
          <div class="specs-statusbar">
            <span id="specs-status">Saved</span>
            <span style="margin-left:auto" id="specs-word-count">0 words</span>
          </div>
        </div>
      </div>
    </div>

    <!-- WHITEBOARD -->
    <div class="panel" id="panel-whiteboard">
      <div class="wb-shell">
        <div class="wb-toolbar" id="wb-toolbar">
          <button class="wb-tool active" data-tool="select" onclick="wbSetTool('select')" title="Select (V)">V</button>
          <button class="wb-tool" data-tool="hand" onclick="wbSetTool('hand')" title="Pan (H)">H</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" data-tool="node" onclick="wbSetTool('node')" title="Add Node (N)">+N</button>
          <button class="wb-tool" data-tool="connect" onclick="wbSetTool('connect')" title="Connect (C)">-></button>
          <button class="wb-tool" data-tool="text" onclick="wbSetTool('text')" title="Text (T)">T</button>
          <button class="wb-tool" data-tool="sticky" onclick="wbSetTool('sticky')" title="Sticky (S)">St</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" onclick="wbUndo()" title="Undo">Un</button>
          <button class="wb-tool" onclick="wbRedo()" title="Redo">Re</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" onclick="wbToggleGrid()" title="Grid (G)">G</button>
          <button class="wb-tool" onclick="wbAutoLayout()" title="Auto Layout">AL</button>
        </div>
        <div class="wb-actions">
          <button class="btn btn-sm" onclick="openTplModal()">Templates</button>
          <select class="writer-toolbar-select" onchange="wbExport(this.value);this.selectedIndex=0" style="width:auto"><option value="">Export</option><option value="png">PNG</option><option value="svg">SVG</option><option value="json">JSON</option></select>
          <button class="btn btn-sm" onclick="wbImportJSON()" title="Import whiteboard JSON">Import</button>
          <button class="btn btn-sm" onclick="wbClearAll()">Clear</button>
        </div>
        <div class="wb-top-bar">
          <div class="wb-zoom"><button class="wb-tool" onclick="wbZoom(-0.1)" style="width:20px;height:20px;font-size:14px">-</button><span id="wb-zoom-level">100%</span><button class="wb-tool" onclick="wbZoom(0.1)" style="width:20px;height:20px;font-size:14px">+</button><button class="wb-tool" onclick="wbFitView()" style="width:20px;height:20px;font-size:9px">Fit</button></div>
        </div>
        <div class="wb-canvas-wrap" id="wb-canvas-wrap" onmousedown="wbCanvasDown(event)" onmousemove="wbCanvasMove(event)" onmouseup="wbCanvasUp(event)" onwheel="wbWheel(event)" oncontextmenu="event.preventDefault()">
          <div class="wb-canvas" id="wb-canvas">
            <svg class="wb-svg" id="wb-svg"></svg>
          </div>
        </div>
        <div class="wb-minimap" id="wb-minimap"></div>
      </div>
    </div>

    <!-- LINKS -->
    <div class="panel" id="panel-links">
      <div style="padding:16px 20px 0;display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <div class="tab-bar" id="link-category-tabs"></div>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <input type="text" id="link-search" placeholder="Search links..." oninput="renderLinks()" style="width:140px;font-size:10px;padding:5px 8px">
          <select id="link-sort" onchange="renderLinks()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="newest">Newest</option><option value="oldest">Oldest</option><option value="alpha">A-Z</option><option value="category">Category</option></select>
          <button class="btn btn-sm" onclick="openFilteredLinks()" title="Open all visible links">Open All</button>
          <button class="btn btn-sm" onclick="copyAllLinkURLs()" title="Copy all filtered URLs to clipboard">Copy URLs</button>
          <button class="btn btn-sm" onclick="batchImportLinks()" title="Paste multiple URLs to import">Import</button>
          <button class="btn btn-primary btn-sm" onclick="openLinkModal()">+ Add</button>
        </div>
      </div>
      <div class="content-area"><div class="links-grid" id="links-grid"></div></div>
    </div>

    <!-- PIPELINE -->
    <div class="panel" id="panel-pipeline">
      <div style="padding:16px 20px 0;flex-shrink:0">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <span style="font-size:13px;font-weight:600;letter-spacing:0.02em">Pipeline</span>
          <span style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em">Audio / Text -> Whisper -> GPT -> ASTRA</span>
          <span style="flex:1"></span>
          <span id="pl-status-dot" style="width:8px;height:8px;border-radius:50%;background:var(--text-muted)" title="Not connected"></span>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" id="pl-record-btn" onclick="plToggleRecord()">Record Mic</button>
          <label class="btn btn-sm" style="cursor:pointer;display:inline-flex;align-items:center;gap:4px">
            Upload Audio
            <input type="file" accept="audio/*" onchange="plUploadFile(this)" style="display:none">
          </label>
          <button class="btn btn-sm" onclick="plPasteText()">Paste Text</button>
          <button class="btn btn-sm" onclick="plLoadHistory()">History</button>
        </div>
        <div id="pl-onboarding" style="padding:10px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;font-size:10px;color:var(--text-muted);line-height:1.6;display:none">
          <div style="font-weight:600;color:var(--accent);margin-bottom:4px">Text-only mode available</div>
          Use "Paste Text" to paste any text, write a prompt (e.g. "Summarize key ideas", "Extract action items", "Translate to Spanish"), then hit Process. Audio requires OPENAI_API_KEY in Vercel env vars.
        </div>
        <div id="pl-recording" style="display:none;padding:8px 12px;background:rgba(239,68,68,0.1);border:1px solid var(--red);border-radius:4px;margin-bottom:12px;display:none;align-items:center;gap:8px">
          <div style="width:8px;height:8px;background:var(--red);border-radius:50%;animation:pulse 1s infinite"></div>
          <span id="pl-rec-time" style="font-size:10px;color:var(--red)">Recording... 0s</span>
        </div>
        <div id="pl-input-preview" style="display:none;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;max-height:120px;overflow-y:auto;font-size:11px;color:var(--text-muted)"></div>
        <div style="margin-bottom:12px">
          <label style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:4px;display:block">Custom Prompt</label>
          <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap">
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Summarize the key ideas in 3-5 bullet points'" style="font-size:8px;padding:2px 6px">Summarize</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Extract all action items and tasks as a checklist'" style="font-size:8px;padding:2px 6px">Action Items</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Rewrite this as a polished social media post (Twitter/X length)'" style="font-size:8px;padding:2px 6px">Social Post</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Translate to Spanish, maintaining the original tone'" style="font-size:8px;padding:2px 6px">Translate ES</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Clean up grammar and punctuation, keep the original voice'" style="font-size:8px;padding:2px 6px">Clean Up</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Extract the top keywords and most frequent terms'" style="font-size:8px;padding:2px 6px">Keywords</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Convert to bullet point list'" style="font-size:8px;padding:2px 6px">Bullets</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Generate headline and title suggestions'" style="font-size:8px;padding:2px 6px">Headlines</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Show detailed word count and text statistics'" style="font-size:8px;padding:2px 6px">Stats</button>
            <span style="width:1px;height:12px;background:var(--border);margin:0 2px"></span>
            <button class="btn btn-sm btn-ghost" onclick="plSaveTemplate()" style="font-size:8px;padding:2px 6px;color:var(--accent)">+ Save</button>
          </div>
          <div id="pl-custom-templates" style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px"></div>
          <textarea id="pl-prompt" placeholder="What should the pipeline do with this input? e.g. 'Summarize key ideas', 'Extract action items', 'Rewrite for social media', 'Translate to Spanish'..." style="width:100%;min-height:60px;resize:vertical;font-size:11px;padding:8px 10px"></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:16px">
          <button class="btn btn-primary" onclick="plProcess()" id="pl-process-btn" style="flex:1">Process Pipeline</button>
          <select id="pl-source" style="font-size:10px;padding:4px 8px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text);border-radius:4px">
            <option value="pipeline-manual">Manual</option>
            <option value="pipeline-whatsapp">WhatsApp</option>
            <option value="pipeline-voice">Voice Memo</option>
            <option value="pipeline-capture">Capture</option>
          </select>
        </div>
      </div>
      <div class="content-area" style="padding:0 20px 20px">
        <div id="pl-result" style="display:none;padding:16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent)">Pipeline Result</span>
            <div style="display:flex;gap:6px">
              <button class="btn btn-sm" onclick="plCopyResult()">Copy</button>
              <button class="btn btn-sm" onclick="plSaveToContent()">Save to Content</button>
              <button class="btn btn-sm" onclick="plSaveCapture()">Save to API</button>
              <button class="btn btn-sm" onclick="plClearResult()">New</button>
            </div>
          </div>
          <div id="pl-transcript-box" style="display:none;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:3px;margin-bottom:8px;font-size:10px;color:var(--text-muted);max-height:80px;overflow-y:auto">
            <div style="font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);margin-bottom:4px">Transcript</div>
            <div id="pl-transcript-text"></div>
          </div>
          <div id="pl-synthesis-text" style="font-size:12px;line-height:1.6;white-space:pre-wrap"></div>
        </div>
        <div id="pl-history" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:6px">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted)">Pipeline History</span>
            <input type="text" id="pl-history-search" placeholder="Search history..." oninput="plLoadHistory()" style="flex:1;max-width:200px;font-size:9px;padding:3px 6px">
            <button class="btn btn-sm btn-ghost btn-danger" onclick="if(confirm('Clear all pipeline history?')){S.pipelineHistory=[];save();plLoadHistory();toast('Cleared');}" style="font-size:8px;padding:1px 6px">Clear all</button>
          </div>
          <div id="pl-history-list"></div>
        </div>
      </div>
    </div>

    <!-- REPOS -->
    <div class="panel" id="panel-repos">
      <div style="padding:16px 20px 0;flex-shrink:0">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap">
          <span style="font-size:13px;font-weight:600;letter-spacing:0.02em">Connected Repos</span>
          <span id="repos-count" style="font-size:9px;color:var(--text-muted);font-family:var(--mono)">0</span>
          <span style="flex:1"></span>
          <input type="text" id="repo-search" placeholder="Filter repos..." oninput="reposRefresh()" style="width:120px;font-size:10px;padding:5px 8px">
          <button class="btn btn-primary btn-sm" onclick="openRepoModal()">+ Add</button>
          <button class="btn btn-sm" onclick="(S.repos||[]).filter(r=>r.live).forEach(r=>window.open(r.live,'_blank'));toast('Opened '+((S.repos||[]).filter(r=>r.live).length)+' live sites')" title="Open all live URLs">Open All</button>
          <button class="btn btn-sm" onclick="repoHealthCheck()" title="Ping all live URLs">Health Check</button>
          <button class="btn btn-sm" onclick="reposRefresh()">Refresh</button>
        </div>
      </div>
      <div class="content-area" style="padding:0 20px 20px">
        <div id="repos-grid" style="display:grid;gap:8px"></div>
      </div>
    </div>
  </main>
  <div class="project-resize-handle" id="project-resize-handle"></div>
  <!-- PROJECT VIEW — right panel inside grid -->
  <div class="project-view" id="panel-project">
      <div class="project-header">
        <div class="proj-icon-lg" id="proj-header-icon"></div>
        <span class="project-header-name" id="proj-header-name"></span>
        <span class="badge" id="proj-header-status"></span>
        <div id="proj-stats-bar" style="display:flex;gap:12px;margin-left:auto;margin-right:12px"></div>
        <div class="project-header-actions">
          <button class="btn btn-sm" onclick="editProject()">Edit</button>
          <button class="btn btn-sm" onclick="showExportMenu(event)" title="Export project">Export</button>
          <button class="btn btn-sm btn-danger" onclick="archiveProject()">Archive</button>
          <button class="btn btn-sm" onclick="closeProjectPanel()" title="Close panel" style="font-size:14px;padding:2px 6px">x</button>
        </div>
      </div>
      <div class="project-tabs" id="proj-tabs">
        <button class="project-tab active" onclick="setProjTab('instructions',this)">Instructions</button>
        <button class="project-tab" onclick="setProjTab('docs',this)">Living Docs</button>
        <button class="project-tab" onclick="setProjTab('kb',this)">Knowledge Base</button>
        <button class="project-tab" onclick="setProjTab('proj-tasks',this)">Tasks</button>
        <button class="project-tab" onclick="setProjTab('proj-links',this)">Links</button>
      </div>
      <div class="project-content" id="proj-content">
        <!-- Instructions -->
        <div id="proj-panel-instructions" class="proj-tab-panel">
          <div class="proj-instructions-editor" id="proj-instructions-editor" contenteditable="true" oninput="onProjInstructionsChange()"></div>
        </div>
        <!-- Living Docs -->
        <div id="proj-panel-docs" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="newProjLivingDoc()">+ New Living Doc</button>
          </div>
          <div class="proj-docs-grid" id="proj-docs-grid"></div>
        </div>
        <!-- Knowledge Base -->
        <div id="proj-panel-kb" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="openKBModal()">+ Add Item</button>
            <input type="text" id="kb-search" placeholder="Search knowledge base..." oninput="renderKB()" style="width:200px;font-size:10px;padding:5px 8px">
          </div>
          <div class="kb-grid" id="kb-grid"></div>
        </div>
        <!-- Tasks -->
        <div id="proj-panel-proj-tasks" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="addProjTask()">+ Task</button>
          </div>
          <div id="proj-task-rows"></div>
        </div>
        <!-- Links -->
        <div id="proj-panel-proj-links" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="openProjLinkModal()">+ Add Link</button>
          </div>
          <div class="links-grid" id="proj-links-grid"></div>
        </div>
      </div>
    <div class="project-collapse-chevron" onclick="closeProjectPanel()" title="Collapse panel">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
    </div>
    </div>
  <!-- CONTEXT PANEL -->
  <div class="context-resize" id="context-resize"></div>
  <div class="context-panel" id="context-panel">
    <div class="context-header">
      <span class="context-header-title">Context</span>
      <button class="context-close" onclick="toggleContextPanel()" title="Close">x</button>
    </div>
    <div class="context-body" id="context-body">
      <div class="context-section">
        <div class="context-section-title">Focus Timer</div>
        <div class="focus-timer-panel" id="focus-timer-embed">
          <div class="ft-circle-wrap">
            <svg class="ft-circle" viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="70" class="ft-track"/>
              <circle cx="80" cy="80" r="70" class="ft-progress" id="ft-progress"/>
            </svg>
            <div class="ft-display">
              <div class="ft-time" id="ft-time">25:00</div>
              <div class="ft-label" id="ft-label">Writing</div>
            </div>
          </div>
          <div class="ft-controls">
            <button class="ft-btn" id="ft-btn" onclick="ftToggle()">Start</button>
            <button class="ft-btn" onclick="ftReset()">Reset</button>
          </div>
          <div class="ft-time-adjust" id="ft-time-adjust">
            <button class="ft-adj-btn" onclick="ftAdjust(-5)">-</button>
            <span style="font-size:11px;color:var(--text-muted);font-family:var(--mono)" id="ft-duration-label">25 min</span>
            <button class="ft-adj-btn" onclick="ftAdjust(5)">+</button>
          </div>
          <div class="ft-categories">
            <span class="ft-cat active" onclick="ftSetCat(this,'Writing','#4ade80')">Writing</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Training','#FF6B6B')">Training</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Meditation','#50E3C2')">Meditation</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Breath','#9013FE')">Breath</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Free Flow','#FFD93D')">Free Flow</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Code','#22d3ee')">Code</span>
          </div>
        </div>
      </div>
      <div class="context-section" id="ctx-related">
        <div class="context-section-title">Related Items</div>
        <div id="ctx-related-items" style="font-size:10px;color:var(--text-muted);padding:8px 0">Select an item to see related content</div>
      </div>
      <div class="context-section" id="ctx-graph">
        <div class="context-section-title">Knowledge Graph</div>
        <canvas id="ctx-graph-canvas" width="280" height="160" style="width:100%;height:160px;border-radius:var(--radius);background:var(--bg-surface);border:1px solid var(--border);cursor:grab"></canvas>
      </div>
      <div class="context-section" id="ctx-quick-actions">
        <div class="context-section-title">Quick Actions</div>
        <div class="context-item" onclick="openContentModal()"><span class="context-item-icon">+</span>Add Content</div>
        <div class="context-item" onclick="addTask()"><span class="context-item-icon">+</span>Add Task</div>
        <div class="context-item" onclick="newDoc()"><span class="context-item-icon">+</span>New Document</div>
        <div class="context-item" onclick="openLinkModal()"><span class="context-item-icon">+</span>Add Link</div>
        <div class="context-item" onclick="openNewProjectModal()"><span class="context-item-icon">+</span>New Project</div>
      </div>
      <div class="context-section">
        <div class="context-section-title">Stats</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px" id="ctx-stats">
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-tasks">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Active Tasks</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-docs">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Documents</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-projects">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Projects</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-kb">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">KB Items</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div><!-- /app -->

<!-- SHORTCUTS HELP -->
<div class="modal-overlay" id="shortcuts-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" style="width:480px">
    <div class="modal-title">Keyboard Shortcuts</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:11px">
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:8px">Navigation</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Command Palette</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+K</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Content</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+1</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Tasks</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+2</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Calendar</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+3</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Writing Hub</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+4</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Living Docs</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+5</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Links</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+6</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Whiteboard</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+7</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Pipeline</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+8</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Repos</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+9</span></div>
      </div>
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:8px">Actions</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>New Item</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>New Task (anywhere)</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+T</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Quick Capture</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Toggle Sidebar</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+B</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Context Panel</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+E</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Focus Mode</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+\</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Save / Sync</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+S</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Zen Writer</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+W</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Today View</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+D</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Focus Mode</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+F</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Close/Escape</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Esc</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Export Section</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+E</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Show Shortcuts</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+/</span></div>
        <div style="font-weight:600;color:var(--text);margin:12px 0 8px">Whiteboard</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Select</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">V</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Hand</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">H</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Node</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Connect</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">C</span></div>
      </div>
    </div>
  </div>
</div>

<!-- COMMAND PALETTE -->
<div class="cmd-overlay" id="cmd-overlay" onclick="if(event.target===this)closeCommandPalette()">
  <div class="cmd-box">
    <div class="cmd-input-wrap">
      <span class="cmd-input-icon">></span>
      <input type="text" class="cmd-input" id="cmd-input" placeholder="Search everything... sections, projects, tasks, docs" oninput="cmdSearch()" onkeydown="cmdKeydown(event)" autocomplete="off" spellcheck="false">
      <span class="cmd-hint">ESC to close</span>
    </div>
    <div class="cmd-results" id="cmd-results"></div>
    <div class="cmd-footer">
      <span><span class="cmd-key">Enter</span> select</span>
      <span><span class="cmd-key">Up</span><span class="cmd-key">Down</span> navigate</span>
      <span><span class="cmd-key">Esc</span> close</span>
    </div>
  </div>
</div>

<!-- CONTENT MODAL -->
<div class="modal-overlay" id="content-modal">
  <div class="modal">
    <div class="modal-title" id="content-modal-title">Add Content</div>
    <div class="form-group"><label class="form-label">Type</label><select id="cm-type"><option value="caption">Caption</option><option value="quote">Quote</option></select></div>
    <div class="form-group"><label class="form-label">Theme</label><input type="text" id="cm-theme" placeholder="discipline, growth, healing..."></div>
    <div class="form-group"><label class="form-label">Content</label><textarea id="cm-body" rows="8" placeholder="Paste from Apple Notes..."></textarea></div>
    <div class="form-group"><label class="form-label">Source (optional)</label><input type="text" id="cm-source" placeholder="Apple Notes #Captions"></div>
    <div class="form-group"><label class="form-label">Tags (comma separated)</label><input type="text" id="cm-tags" placeholder="training, mindset, content"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeContentModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveContent()">Save</button>
    </div>
  </div>
</div>

<!-- LINK MODAL -->
<div class="modal-overlay" id="link-modal">
  <div class="modal">
    <div class="modal-title" id="link-modal-title">Add Link</div>
    <div class="form-group"><label class="form-label">Title</label><input type="text" id="lm-title" placeholder="Saturno Vault"></div>
    <div class="form-group"><label class="form-label">URL</label><div style="display:flex;gap:4px"><input type="text" id="lm-url" placeholder="https://..." onblur="suggestLinkTitle()" style="flex:1"><button class="btn btn-sm btn-ghost" onclick="fetchLinkTitle()" style="font-size:9px;white-space:nowrap" type="button">Fetch Title</button></div></div>
    <div class="form-group"><label class="form-label">Category</label><input type="text" id="lm-category" placeholder="deployment, repo, tool"></div>
    <div class="form-group"><label class="form-label">Description</label><input type="text" id="lm-desc" placeholder="Short description"></div>
    <div class="form-group"><label class="form-label">Project (optional)</label><select id="lm-project"><option value="">None</option></select></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeLinkModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveLink()">Save</button>
    </div>
  </div>
</div>

<!-- TEMPLATE MODAL -->
<div class="wb-tpl-modal" id="wb-tpl-modal" onclick="if(event.target===this)closeTplModal()">
  <div class="modal" style="width:720px;max-width:95vw">
    <div class="modal-title">Choose Template</div>
    <div class="wb-tpl-grid" id="wb-tpl-grid"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" onclick="closeTplModal()">Cancel</button></div>
  </div>
</div>

<!-- PROJECT MODAL -->
<div class="modal-overlay" id="project-modal" onclick="if(event.target===this)closeProjectModal()">
  <div class="modal" style="width:480px">
    <div class="modal-title" id="project-modal-title">New Project</div>
    <div class="form-group">
      <label class="form-label">Project Name</label>
      <input type="text" id="pm-name" placeholder="Saturno Bonus">
    </div>
    <div class="form-group">
      <label class="form-label">Icon</label>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="pm-icon-preview" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);border:1px solid var(--border);cursor:pointer" onclick="openIconPicker()"></div>
        <button class="btn btn-sm" onclick="openIconPicker()">Choose Icon</button>
        <input type="hidden" id="pm-icon" value="folder">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <select id="pm-status">
        <option value="active">Active</option>
        <option value="paused">Paused</option>
        <option value="complete">Complete</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Color Accent</label>
      <div style="display:flex;gap:6px" id="pm-colors">
        <div class="pm-color-opt" style="background:#4ade80" onclick="setPmColor('#4ade80')" data-color="#4ade80"></div>
        <div class="pm-color-opt" style="background:#8b5cf6" onclick="setPmColor('#8b5cf6')" data-color="#8b5cf6"></div>
        <div class="pm-color-opt" style="background:#3b82f6" onclick="setPmColor('#3b82f6')" data-color="#3b82f6"></div>
        <div class="pm-color-opt" style="background:#06b6d4" onclick="setPmColor('#06b6d4')" data-color="#06b6d4"></div>
        <div class="pm-color-opt" style="background:#f59e0b" onclick="setPmColor('#f59e0b')" data-color="#f59e0b"></div>
        <div class="pm-color-opt" style="background:#ec4899" onclick="setPmColor('#ec4899')" data-color="#ec4899"></div>
        <div class="pm-color-opt" style="background:#ef4444" onclick="setPmColor('#ef4444')" data-color="#ef4444"></div>
        <div class="pm-color-opt" style="background:#f97316" onclick="setPmColor('#f97316')" data-color="#f97316"></div>
      </div>
      <input type="hidden" id="pm-color" value="#4ade80">
    </div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeProjectModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save</button>
    </div>
  </div>
</div>

<!-- REPO MODAL -->
<div class="modal-overlay" id="repo-modal" onclick="if(event.target===this)closeRepoModal()">
  <div class="modal" style="width:420px">
    <div class="modal-title" id="repo-modal-title">Add Repo</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" id="rm-name" placeholder="my-repo"></div>
    <div class="form-group"><label class="form-label">GitHub URL</label><input type="text" id="rm-github" placeholder="https://github.com/user/repo"></div>
    <div class="form-group"><label class="form-label">Live URL (optional)</label><input type="text" id="rm-live" placeholder="https://my-app.vercel.app"></div>
    <div class="form-group"><label class="form-label">Role</label>
      <select id="rm-role"><option value="backend-hub">Backend Hub</option><option value="customer-facing">Customer Facing</option><option value="internal-tools">Internal Tools</option><option value="experience">Experience</option><option value="extension">Extension</option><option value="library">Library</option><option value="other">Other</option></select>
    </div>
    <div class="form-group"><label class="form-label">Status</label>
      <select id="rm-status"><option value="active">Active</option><option value="complete">Complete</option><option value="archived">Archived</option></select>
    </div>
    <div class="form-group"><label class="form-label">Description</label><textarea id="rm-desc" rows="3" placeholder="What this repo does..."></textarea></div>
    <div class="form-group"><label class="form-label">Notes</label><input type="text" id="rm-notes" placeholder="Quick notes, reminders..."></div>
    <div class="form-group"><label class="form-label">Last Commit</label><input type="text" id="rm-lastcommit" placeholder="e.g. feat: added new feature"></div>
    <div class="form-group"><label class="form-label">Tech Stack</label><input type="text" id="rm-stack" placeholder="HTML, JS, Vercel, Node (comma-separated)"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeRepoModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveRepo()">Save</button>
    </div>
  </div>
</div>

<!-- ICON PICKER MODAL -->
<div class="icon-picker-modal" id="icon-picker-modal" onclick="if(event.target===this)closeIconPicker()">
  <div class="modal" style="width:400px">
    <div class="modal-title">Choose Icon</div>
    <div class="icon-picker-grid" id="icon-picker-grid"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" onclick="closeIconPicker()">Done</button></div>
  </div>
</div>

<!-- KB MODAL -->
<div class="modal-overlay" id="kb-modal" onclick="if(event.target===this)closeKBModal()">
  <div class="modal" style="width:500px">
    <div class="modal-title" id="kb-modal-title">Add to Knowledge Base</div>
    <div class="kb-modal-tabs">
      <button class="kb-modal-tab active" onclick="setKBModalTab('text',this)">Text / Markdown</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('file',this)">File Reference</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('url',this)">URL</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('image',this)">Image</button>
    </div>
    <div class="kb-modal-panel active" id="kb-panel-text">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-text-name" placeholder="Design Specs"></div>
      <div class="form-group"><label class="form-label">Content</label><textarea id="kbm-text-content" rows="8" placeholder="Paste markdown or plain text..." style="font-family:var(--mono);font-size:11px"></textarea></div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-file">
      <div class="form-group"><label class="form-label">File Name</label><input type="text" id="kbm-file-name" placeholder="Visual Branding.pdf"></div>
      <div class="form-group"><label class="form-label">File Path</label><input type="text" id="kbm-file-path" placeholder="~/Downloads/Visual Branding.pdf"></div>
      <div class="form-group"><label class="form-label">File Type</label>
        <select id="kbm-file-type"><option value="pdf">PDF</option><option value="img">Image</option><option value="json">JSON</option><option value="other">Other</option></select>
      </div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-url">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-url-name" placeholder="Saturno Movement"></div>
      <div class="form-group"><label class="form-label">URL</label><input type="text" id="kbm-url-url" placeholder="https://saturnomovement.com"></div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-image">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-img-name" placeholder="Gate Screenshot"></div>
      <div class="form-group"><label class="form-label">Paste image or drop file</label>
        <div id="kbm-img-drop" style="border:2px dashed var(--border);border-radius:var(--radius);padding:30px;text-align:center;color:var(--text-muted);font-size:11px;cursor:pointer;transition:all 0.15s" onclick="document.getElementById('kbm-img-input').click()">
          Click or paste (Ctrl+V) an image here
          <input type="file" id="kbm-img-input" accept="image/*" style="display:none" onchange="handleKBImageFile(this)">
        </div>
        <div id="kbm-img-preview" style="display:none;margin-top:8px"><img id="kbm-img-preview-img" style="max-width:100%;max-height:150px;border-radius:var(--radius);border:1px solid var(--border)"></div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Description</label><input type="text" id="kbm-desc" placeholder="Brief description of this item"></div>
    <div class="form-group"><label class="form-label">Tags (comma-separated)</label><input type="text" id="kbm-tags" placeholder="design, branding, specs"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeKBModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveKBItem()">Save</button>
    </div>
  </div>
</div>

<!-- KB VIEWER MODAL -->
<div class="modal-overlay" id="kb-viewer-modal" onclick="if(event.target===this)closeKBViewer()">
  <div class="modal" style="width:640px;max-height:85vh">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
      <span class="kb-card-type" id="kbv-type"></span>
      <span style="font-size:14px;font-weight:600;color:var(--text);flex:1" id="kbv-name"></span>
      <button class="btn btn-sm" onclick="editKBItem()">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="deleteKBItem()">Delete</button>
      <button class="btn btn-sm" onclick="closeKBViewer()">Close</button>
    </div>
    <div id="kbv-desc" style="font-size:11px;color:var(--text-secondary);margin-bottom:12px"></div>
    <div id="kbv-content" style="font-size:13px;line-height:1.7;color:var(--text-secondary);max-height:60vh;overflow-y:auto;white-space:pre-wrap;font-family:var(--mono);background:var(--bg-surface);padding:14px;border-radius:var(--radius);border:1px solid var(--border)"></div>
    <div id="kbv-image" style="display:none;text-align:center;margin-top:12px"><img id="kbv-image-img" style="max-width:100%;max-height:50vh;border-radius:var(--radius)"></div>
    <div id="kbv-path" style="display:none;margin-top:12px;font-family:var(--mono);font-size:10px;color:var(--text-muted)"></div>
    <div id="kbv-tags" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:12px"></div>
  </div>
</div>

<!-- QUICK CAPTURE -->
<div id="quick-capture" style="position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:500px;max-width:90vw;z-index:500;display:none;transition:transform 0.2s ease,opacity 0.2s ease;opacity:0">
  <div style="background:linear-gradient(135deg, rgba(16,16,20,0.98) 0%, rgba(22,22,25,0.98) 100%);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.06);border-bottom:none;border-radius:var(--radius-lg) var(--radius-lg) 0 0;padding:10px 14px;box-shadow:0 -8px 32px rgba(0,0,0,0.5)">
    <div style="display:flex;align-items:center;gap:8px">
      <select id="qc-type" style="width:auto;font-size:9px;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary)">
        <option value="task">Task</option>
        <option value="content">Content</option>
        <option value="link">Link</option>
        <option value="note">Quick Note</option>
      </select>
      <input type="text" id="qc-input" placeholder="Quick capture... (Cmd+Shift+N)" style="flex:1;font-size:12px;padding:8px 10px;border-radius:6px;background:var(--bg-input);border:1px solid var(--border)" onkeydown="if(event.key==='Enter'){qcSubmit();event.preventDefault();}if(event.key==='Escape')qcClose();">
      <button class="btn btn-primary btn-sm" onclick="qcSubmit()" style="padding:6px 12px">Add</button>
      <button class="btn btn-sm btn-ghost" onclick="qcClose()" style="font-size:12px">x</button>
    </div>
  </div>
</div>

<!-- ZEN WRITER — Full-screen writing environment (Cmd+Shift+W or FAB) -->
<div class="zen-writer" id="zen-writer">
  <div class="zen-writer-topbar">
    <select class="zen-doc-picker" id="zen-doc-picker" onchange="zenPickDoc(this.value)"></select>
    <button class="zen-tb" onclick="zenNewDoc()" title="New Document" style="font-size:11px;width:auto;padding:0 8px;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> New</button>
    <div class="zen-toolbar">
      <select class="zen-tb-select" id="zen-block-type" onchange="zenExecBlock(this.value)">
        <option value="p">Paragraph</option>
        <option value="h1">Heading 1</option>
        <option value="h2">Heading 2</option>
        <option value="h3">Heading 3</option>
        <option value="blockquote">Quote</option>
        <option value="pre">Code Block</option>
      </select>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenCmd('bold')" title="Bold (Cmd+B)"><b>B</b></button>
      <button class="zen-tb" onclick="zenCmd('italic')" title="Italic (Cmd+I)"><i>I</i></button>
      <button class="zen-tb" onclick="zenCmd('underline')" title="Underline (Cmd+U)"><u>U</u></button>
      <button class="zen-tb" onclick="zenCmd('strikeThrough')" title="Strikethrough"><s>S</s></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenCmd('insertUnorderedList')" title="Bullet List"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('insertOrderedList')" title="Numbered List"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 6h11M10 12h11M10 18h11M3 5v3h2M4 8H3M5 18H3l2-3H3"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('indent')" title="Indent"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8l4 4-4 4M12 4h9M12 12h9M12 20h9"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('outdent')" title="Outdent"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 8L3 12l4 4M12 4h9M12 12h9M12 20h9"/></svg></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenInsertLink()" title="Insert Link"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></button>
      <button class="zen-tb" onclick="zenInsertHR()" title="Horizontal Rule"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg></button>
      <button class="zen-tb" onclick="zenInsertCode()" title="Inline Code"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenClearFormat()" title="Clear Formatting"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg></button>
    </div>
    <button class="zen-tb" onclick="zenSaveVersion()" title="Save Version (Cmd+S)" style="font-size:10px;width:auto;padding:0 8px;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><path d="M17 21v-8H7v8M7 3v5h8"/></svg> Save</button>
    <select class="zen-tb-select" id="zen-export-sel" onchange="zenExport(this.value);this.selectedIndex=0">
      <option value="">Export</option>
      <option value="md">Markdown</option>
      <option value="html">HTML</option>
      <option value="txt">Plain Text</option>
      <option value="clipboard">Copy All</option>
    </select>
    <button class="zen-close-btn" onclick="zenClose()" title="Close (Esc)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
  </div>
  <div class="zen-body">
    <input type="text" class="zen-title" id="zen-title" placeholder="Untitled Document" oninput="zenOnChange()">
    <div class="zen-editor" id="zen-editor" contenteditable="true" data-placeholder="Start writing..." oninput="zenOnChange()" onkeydown="zenKeydown(event)"></div>
  </div>
  <div class="zen-statusbar">
    <span id="zen-words">0 words</span>
    <span id="zen-chars">0 chars</span>
    <span id="zen-reading">0 min read</span>
    <span id="zen-goal" style="cursor:pointer" onclick="zenSetGoal()" title="Set word goal"></span>
    <span id="zen-saved" style="margin-left:auto">Saved</span>
  </div>
</div>

<!-- Floating Write Button -->
<button class="zen-fab" id="zen-fab" onclick="zenOpen()" title="Open Writer (Cmd+Shift+W)">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
</button>

<!-- Task Detail Modal -->
<div class="task-detail-modal" id="task-detail-modal" onclick="if(event.target===this)closeTaskDetail()">
  <div class="task-detail-inner">
    <h3 id="td-heading">Task Details</h3>
    <div class="td-field"><label>Title</label><input type="text" id="td-title" placeholder="Task title..."></div>
    <div class="td-field"><label>Description</label><textarea id="td-desc" placeholder="Add details, notes, context..."></textarea></div>
    <div class="td-field-row">
      <div class="td-field"><label>Status</label><select id="td-status"><option value="todo">To Do</option><option value="progress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select></div>
      <div class="td-field"><label>Priority</label><select id="td-priority"><option value="p0">P0 Critical</option><option value="p1">P1 High</option><option value="p2">P2 Medium</option><option value="p3">P3 Low</option></select></div>
    </div>
    <div class="td-field-row">
      <div class="td-field"><label>Project</label><input type="text" id="td-project" placeholder="Project name..." list="pdl"></div>
      <div class="td-field"><label>Due Date</label><input type="date" id="td-due"><div style="display:flex;gap:3px;margin-top:3px"><button class="btn btn-sm btn-ghost" onclick="tdSetDue(0)" style="font-size:8px;padding:1px 5px">Today</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(1)" style="font-size:8px;padding:1px 5px">Tmrw</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(7)" style="font-size:8px;padding:1px 5px">+1W</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(30)" style="font-size:8px;padding:1px 5px">+1M</button></div><input type="text" id="td-due-natural" placeholder="or type: friday, 3d, next week..." style="font-size:9px;padding:3px 6px;margin-top:3px;width:100%;border:1px solid var(--border);border-radius:4px;background:var(--bg-input);color:var(--text-secondary)" onkeydown="if(event.key==='Enter'){const v=parseNaturalDate(this.value);if(v&&v!==this.value){document.getElementById('td-due').value=v;this.value='';toast('Due: '+v);}event.preventDefault();}"></div>
    </div>
    <div class="td-field-row">
      <div class="td-field"><label>Recurrence</label><select id="td-recur"><option value="">None</option><option value="daily">Daily</option><option value="weekday">Weekdays</option><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option></select></div>
      <div class="td-field"><label>Estimate</label><input type="text" id="td-estimate" placeholder="e.g. 30m, 2h, 1d" style="font-size:10px"></div>
    </div>
    <div style="display:flex;gap:8px;font-size:9px;color:var(--text-muted);padding:2px 0"><span id="td-recur-info"></span></div>
    <div class="td-field-row">
      <div class="td-field"><label>Blocked By</label><input type="text" id="td-blocked-by" placeholder="Task name..." style="font-size:10px"></div>
    </div>
    <div class="td-field">
      <label>Subtasks</label>
      <div class="td-subtasks" id="td-subtasks"></div>
      <div class="td-add-subtask" onclick="addSubtaskInModal()">+ Add subtask</div>
    </div>
    <div class="td-created" id="td-created"></div>
    <div id="td-log" style="margin-top:8px"></div>
    <div class="td-footer">
      <button class="btn btn-primary btn-sm" onclick="saveTaskDetail()">Save</button>
      <button class="btn btn-sm" onclick="closeTaskDetail()">Cancel</button>
      <button class="btn btn-sm" onclick="duplicateTask()">Duplicate</button>
      <button class="btn btn-sm" onclick="taskToContent()" title="Save task details as content">To Content</button>
      <button class="btn btn-sm" id="td-timer-btn" onclick="toggleTaskTimer()" title="Start/stop time tracking"></button>
      <button class="btn btn-sm" onclick="ftStartForTask(taskDetailId)" title="Start 25min focus timer for this task" style="color:var(--accent)">Focus</button>
      <button class="btn btn-sm btn-danger" onclick="deleteTaskFromDetail()" style="margin-left:auto">Delete</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// === STATE ===
const SK = 'saturno-private-hub';
let S = { content:[], tasks:[], links:[], docs:[], specs:[], activeDoc:null, activeSpec:null, whiteboard:{}, projects:[], knowledgeBase:[], folders:[] };
let currentSection = 'content';
let contentType = 'all', contentTheme = 'all', contentTagFilter = null;
let taskView = 'list', taskFilter = 'all', taskProjectFilter = null;
let linkCategory = 'all';
let editingContentId = null, editingLinkId = null;
let writerTimer = null, specTimer = null, writerPanelOpen = false;
let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
let calView = 'month'; // 'month' or 'week'
let calWeekStart = null; // Date object for week view start (Monday)
let calDragId = null;
let recentItems = [];
function trackRecent(type, id, title) {
  recentItems = recentItems.filter(r => !(r.type===type && r.id===id));
  recentItems.unshift({ type, id, title: title||'Untitled', time: Date.now() });
  if(recentItems.length > 10) recentItems = recentItems.slice(0, 10);
}

function load() {
  try { const s = localStorage.getItem(SK); if(s) S = { content:[], tasks:[], links:[], docs:[], specs:[], activeDoc:null, activeSpec:null, whiteboard:{}, projects:[], knowledgeBase:[], folders:[], ...JSON.parse(s) }; } catch(e){}
  if(!S.projects) S.projects = [];
  if(!S.knowledgeBase) S.knowledgeBase = [];
  if(!S.docs.length) { S.docs.push({id:Date.now(),title:'',body:'',versions:[],created:new Date().toISOString(),updated:new Date().toISOString()}); S.activeDoc=S.docs[0].id; }
  if(!S.activeDoc&&S.docs.length) S.activeDoc=S.docs[0].id;
  if(!S.specs) S.specs=[];
  if(!S.specs.length) { seedKernel(); }
  if(!S.activeSpec&&S.specs.length) S.activeSpec=S.specs[0].id;
}

function migrateV2() {
  // Add Claude Code project if it doesn't exist yet
  if(S.projects && S.projects.length && !S.projects.find(p => p.id === 'proj_claude_code')) {
    const now = new Date().toISOString();
    S.projects.push({
      id:'proj_claude_code', name:'Claude Code', icon:'terminal', status:'active', color:'#a78bfa',
      instructions:'<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div><h1>Claude Code - Session Continuity Kernel</h1><h2>Purpose</h2><p>This project is the SINGLE SOURCE OF TRUTH for every Claude Code session. Any new Claude reads this project first and knows exactly what to do without asking Gabo.</p><h2>Rules That NEVER Change</h2><ol><li>~/dev/ is canonical for ALL repos - NOT Desktop, NOT iCloud</li><li>NO DELETE - archive, never delete</li><li>Every Gabo message -> save to backend as-is (project/title/text)</li><li>Commit + deploy after EVERY meaningful change</li><li>Dark theme only, no emojis in code</li><li>Custom over SaaS, always</li><li>DO NOT ASK GABO - read the logs and specs, then execute</li></ol><h2>Active Repos</h2><table><tr><th>Repo</th><th>Local</th><th>Live</th></tr><tr><td>astra-command-center</td><td>~/dev/astra-command-center/</td><td>astra-command-center-sigma.vercel.app</td></tr><tr><td>titan-forge</td><td>~/dev/titan-forge/</td><td>titan-forge-ten.vercel.app</td></tr><tr><td>saturno-bonus</td><td>~/dev/saturno-bonus/</td><td>saturno-bonus-omega.vercel.app</td></tr><tr><td>de-aqui-a-saturno</td><td>~/dev/de-aqui-a-saturno/</td><td>de-aqui-a-saturno-jet.vercel.app</td></tr></table><h2>Machine Context</h2><ul><li>C2 iMac: username Gabosaturno (CAPITAL G)</li><li>C1 MacBook Pro: username gabosaturno (lowercase)</li><li>GitHub: gabosaturno11</li></ul><h2>Design Constraints</h2><ul><li>Pure black backgrounds (#09090b)</li><li>Mint green for ASTRA (#4ade80)</li><li>Purple accents (#8b5cf6)</li><li>Dark theme ONLY</li></ul><h2>How to Use This Project</h2><p>1. Export this project as MD (click Export button)</p><p>2. The exported MD becomes CLAUDE.md in repo root</p><p>3. Next Claude Code session reads it automatically</p><p>4. Update KB items below as state changes</p>',
      created:now, updated:now
    });
    S.knowledgeBase.push(
      { id:'kb_cc_session_log', projectId:'proj_claude_code', name:'Session Log - Feb 16, 2026', type:'md', storage:'inline',
        content:'# Session Log — Feb 16, 2026 (LATEST)\n\n## Batch 1 (Commit 1e98d43):\nHide internal tools, fix auth, fix alerts, add auto-advance, add lock vault, coming soon section, BONUS PDF badges\n\n## Batch 2 (Commit 86dd606):\nRewrite ALL tool descriptions, categorize Training vs Experience, fix music case bug, fix gate og:image, create .env.example\n\n## Previous Session:\n- Desktop cleaned\n- Claude Code project added to ASTRA\n- Export feature added (MD, JSON, clipboard)\n- CLAUDE.md kernel placed in all repos\n- ASTRA V2 features: color tabs, mobile scroll, doc assignment, migrateV2()\n\n## Messages Backend:\n~/dev/saturno-bonus/logs/gabo-messages.json (16 messages, id 0-16)',
        description:'Current session state', tags:['session','log'], created:now, updated:now },
      { id:'kb_cc_gabo_rules', projectId:'proj_claude_code', name:'Gabo Rules (Permanent)', type:'md', storage:'inline',
        content:'# Permanent Rules\n1. ~/dev/ is canonical\n2. NO DELETE\n3. Every message -> backend\n4. Commit + deploy after EVERY change\n5. Dark theme only\n6. Custom over SaaS\n7. DO NOT ASK - execute\n8. BOOK FIRST\n9. planet-logo.png is THE logo\n10. Audio 404s on Vercel - needs CDN\n11. Brevo needs API keys in Vercel env',
        description:'Rules that never change', tags:['rules','permanent'], created:now, updated:now },
      { id:'kb_cc_messages', projectId:'proj_claude_code', name:'Messages Backend', type:'md', storage:'inline',
        content:'# Backend: ~/dev/saturno-bonus/logs/gabo-messages.json\n9 messages (id 0-8)\nRule: save EVERY message unless told otherwise',
        description:'Message log location', tags:['messages','backend'], created:now, updated:now }
    );
    save();
  }
  // Add v2.0 build summary if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_v2_build')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_v2_build', projectId:'proj_claude_code', name:'ASTRA v2.0 Build Summary — Feb 16, 2026', type:'md', storage:'inline',
        content:'# SATURNO HUB v2.0 Build Summary\n\n## Session: Feb 16, 2026\n**17 commits pushed** | 3,400 lines | 224+ functions | Single-file HTML app\n\n## New Features Built:\n\n### Architecture\n1. **3-Panel Resizable Layout** - sidebar (220px) + primary (flex) + context panel (320px)\n2. **Mode Switching** - Focus (primary only), Default, Extended (all panels)\n3. **Resizable Panels** - Drag handles on sidebar + context panel borders\n4. **Responsive Design** - Mobile sidebar, stacked layouts, adaptive breakpoints\n\n### Navigation & Search\n5. **Command Palette (Cmd+K)** - Fuzzy search across all items, sections, actions\n6. **Keyboard Shortcuts** - Cmd+1-7 sections, Cmd+N new, Cmd+E context, Cmd+\\ focus, Cmd+/ help\n7. **Breadcrumb Navigation** - Shows current doc/spec/project in header\n8. **Recent Items Tracking** - Last 10 accessed items shown in Cmd+K\n\n### Knowledge Management\n9. **Folder System** - Tree UI in sidebar, nested folders, create/rename/delete\n10. **Drag-and-Drop to Folders** - Content cards + link cards to folder tree\n11. **[[Wiki-Links]]** - Cross-referencing system with backlink engine\n12. **Mini Knowledge Graph** - Force-directed canvas visualization in context panel\n13. **Global Tagging System** - Tags on content, searchable, displayed on cards\n\n### Productivity\n14. **Focus Timer** - Pomodoro with SVG progress, categories, embedded in context\n15. **Quick Capture (Cmd+Shift+N)** - Floating bar for instant task/content/note\n16. **Today View** - Overdue/today/upcoming tasks in context panel\n17. **Writer Word Goals** - Clickable goal target in status bar\n18. **Project Progress Bars** - Task completion % per project in sidebar\n\n### Polish\n19. **SVG Sidebar Icons** - Lucide-style icons replacing letter icons\n20. **Logo Breathing Animation** - Subtle opacity animation\n21. **Glass Morphism Modals** - Backdrop blur + transparency\n22. **Auto-Save Indicator** - Flash in header on save\n23. **Sidebar Dashboard** - Mini task/docs/project counts\n24. **Smooth Panel Transitions** - Fade opacity on section switch\n25. **Endel-Inspired Theme** - Deeper blacks (#050508), refined borders\n\n## Commits:\n```\necb41f8 Today View\ne44c78e Writer word goals\n9cfdf6d Project progress bars\n4d1fd59 Quick Capture bar\n31ae7f5 Responsive design\nb84d449 Global tagging\neec1099 Sidebar dashboard + auto-save\n275f22f Drag-drop to folders\n14cedd2 Breadcrumbs + shortcuts help\nabcb1a6 Keyboard shortcuts + recent items\nea2eea5 Endel polish (SVG icons, breathe, glass)\n3eda6bc Resizable panels\n21df181 Mini knowledge graph\nd517f68 Folder tree UI\n6df5e02 Wiki-links wiring\n6470d43 Context panel related items\n```\n\n## What Still Could Be Done:\n- Unified BaseItem schema refactor\n- Task subtasks/checklists\n- Drag-drop folder reordering\n- Wiki-link rendering in contenteditable editors\n- More Endel transitions/microinteractions\n- Activity log / changelog\n- Pinned items feature',
        description:'Complete build log for the v2.0 upgrade session', tags:['v2','build-log','session','architecture'], created:now, updated:now }
    );
    save();
  }
  // Add v2.0 fix session log
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_v2_fixes')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_v2_fixes', projectId:'proj_claude_code', name:'v2.0 UX Fix Session — Feb 16, 2026 (evening)', type:'md', storage:'inline',
        content:'# v2.0 UX Fix Session — Feb 16, 2026\n\n## Critical fix: Panel resize breaking layout\n- Project panel resize was setting app.style.gridTemplateColumns as inline style\n- This permanently overrode all CSS class-based grid definitions\n- After any drag, closing panel or switching modes left broken inline style\n- FIX: Now uses --project-width CSS variable instead of inline style\n\n## Panel conflicts resolved\n- Opening a project now closes context panel (they share same grid slot)\n- Toggling context panel now closes project panel first\n- Focus mode properly closes both project and context panels\n- Extended mode closes project panel, opens context panel\n\n## Migration ordering fix\n- migrateV2() was running inside load() before seedProjects()\n- On fresh localStorage, S.projects.length was 0 so Claude Code project was never created\n- FIX: migrateV2 now runs after seedProjects()\n\n## Other fixes\n- Links added from project panel now get projectId assigned\n- Removed duplicate saveLink monkeypatch override\n- Archive project now requires confirmation dialog\n- switchSection properly highlights sidebar item when called programmatically\n- Removed dead wbCanvasDownV2 wrapper code\n- Removed conflicting explicit width on context panel CSS\n- Removed negative margins on resize handles causing misalignment\n\n## Deployment discovery\n- Live URL is astra-command-center-sigma.vercel.app\n- NOT astra-command-center.vercel.app (that is an OLD Vercel project)\n\n## Commits (7):\neccdc1f, 6fdb2f2, 955273b, 12141fe, e806f0e, 84b0b45, 804ee06',
        description:'UX bug fixes for panel resize, mode switching, migration ordering', tags:['v2','fixes','session','ux'], created:now, updated:now }
    );
    save();
  }
  // Add collapsible sidebars log
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_collapsible_panels')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_collapsible_panels', projectId:'proj_claude_code', name:'Collapsible Panels — Feb 16, 2026', type:'md', storage:'inline',
        content:'# Collapsible Panels Feature\n\n## Left Sidebar\n- Sidebar panel icon in header toggles sidebar visibility\n- Double-chevron (<<) at bottom of sidebar collapses it\n- CSS class: .app.sidebar-collapsed hides sidebar completely (0px grid column)\n- Sidebar resize handle also hidden when collapsed\n- Grid recalculates for all states: default, project-open, context-open, extended\n- Smooth transition via grid-template-columns 0.25s\n\n## Right Project Panel\n- Double-chevron (>>) at bottom of project panel to collapse/close\n- Uses existing closeProjectPanel() function\n- Minimalistic arrow design matching Claude AI reference screenshots\n\n## Implementation\n- toggleSidebar() function toggles .sidebar-collapsed class\n- CSS handles all grid states when collapsed\n- Focus mode (.mode-focus) is separate — hides sidebar via display:none\n- No conflict between collapsed state and focus mode',
        description:'Collapsible sidebar and project panel with chevron arrows', tags:['v2','ux','panels','collapsible'], created:now, updated:now }
    );
    save();
  }
  // Rename kernel spec and assign to all projects
  const kernel = S.specs.find(s => s.id === 1000);
  if(kernel && kernel.title === 'Saturno Living Canvas v2.0') {
    kernel.title = 'Saturno OS Complete Map';
    kernel.icon = 'globe';
    kernel.color = '#4ade80';
    save();
  }
  // Ensure icon/color fields on all specs
  S.specs.forEach(s => { if(!s.icon) s.icon = 'file'; if(!s.color) s.color = '#8b8b8b'; });
  // Seed per-project living docs if not present
  if(!(S.specs||[]).find(s => s.id === 'ld_bonus')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_bonus', title:'Saturno Bonus — Project Spec', projectId:'proj_saturno_bonus', icon:'rocket', color:'#4ade80',
      created:now, updated:now,
      sections:[
        {id:'ld_b1',title:'Design & Branding',icon:'palette',color:'#8b5cf6',body:'<p><b>Visual Identity:</b> Dark cosmic theme (#050711 base), teal accents (#06b6d4, #22d3ee), Sora font.</p><p><b>Logo:</b> planet-logo.png (white silhouette). Used in header, gate, footer.</p><p><b>Layout:</b> Hero + category sections + tool grid + music player + PDF cards + footer.</p><p><b>Target Feel:</b> Premium vault, exclusive access, cosmic luxury.</p>',collapsed:false},
        {id:'ld_b2',title:'Technical Architecture',icon:'cpu',color:'#22d3ee',body:'<p><b>Stack:</b> Static HTML + Vercel serverless functions. Single-page index.html (~1,800 lines).</p><p><b>Auth:</b> Cookie-based password gate (saturno2025). Redirects on auth fail.</p><p><b>API:</b> /api/verify (password), /api/brevo (email capture), /api/config (feature flags), /api/admin-verify.</p><p><b>Storage:</b> No database. PDFs/tools served as static files from bonuses/ directory.</p><p><b>Music:</b> manifest.json for track metadata. Audio files gitignored (need CDN).</p>',collapsed:false},
        {id:'ld_b3',title:'Content Inventory',icon:'layers',color:'#f59e0b',body:'<p><b>Tools (60):</b> 19 Training + 25 Experience + 16 unlisted. Each is a standalone HTML file in bonuses/tools/.</p><p><b>PDFs (15):</b> HBF phases, skill programming, routines. In pdfs/.</p><p><b>Music (36 tracks):</b> 8 categories. In audio/ (gitignored, needs CDN).</p><p><b>Video:</b> app-promo.mov needs MP4 conversion.</p>',collapsed:true},
        {id:'ld_b4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'<p><b>BLOCKER 1:</b> Domain — bonus.saturnomovement.com (Cloudflare CNAME needed by Gabo)</p><p><b>BLOCKER 2:</b> Brevo API keys not in Vercel env vars (email capture broken)</p><p><b>BLOCKER 3:</b> Audio files 404 on Vercel (gitignored + vercelignored, needs CDN solution)</p><p><b>BLOCKER 4:</b> app-promo.mov is .mov format (needs .mp4 conversion for web)</p><p><b>BLOCKER 5:</b> Physical device testing (Gabo must QA on phone/iPad)</p>',collapsed:false},
        {id:'ld_b5',title:'Roadmap & Milestones',icon:'flag',color:'#06b6d4',body:'<p><b>Phase 1 (DONE):</b> Core page live, auth, tools, PDFs, descriptions rewritten, categories sorted.</p><p><b>Phase 2 (NOW):</b> Domain setup, Brevo integration, music CDN, device QA.</p><p><b>Phase 3:</b> 100 tools, 100 PDFs, album artwork, polished footer, video embed.</p><p><b>Phase 4:</b> Analytics review, A/B test gate, referral system, subscriber dashboard.</p>',collapsed:true},
        {id:'ld_b6',title:'Links & Resources',icon:'link',color:'#a78bfa',body:'<p><b>Live:</b> <a href="https://saturno-bonus-omega.vercel.app/index.html" target="_blank">saturno-bonus-omega.vercel.app</a></p><p><b>Repo:</b> github.com/gabosaturno11/saturno-bonus</p><p><b>Gate:</b> saturno-bonus-omega.vercel.app/gate.html (password: saturno2025)</p><p><b>Vercel Dashboard:</b> vercel.com/gabosaturno</p><p><b>Cloudflare:</b> dash.cloudflare.com (saturnomovement.com)</p>',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_sm_app')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_sm_app', title:'SM App Rebuild — Project Spec', projectId:'proj_sm_app', icon:'code', color:'#8b5cf6',
      created:now, updated:now,
      sections:[
        {id:'ld_a1',title:'Architecture Overview',icon:'cpu',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_a2',title:'Developer Handoff Status',icon:'users',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_a3',title:'Tech Stack & Dependencies',icon:'layers',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_a4',title:'Blockers & Risks',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_a5',title:'Roadmap & Timeline',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_book')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_book', title:'Book (AOC) — Project Spec', projectId:'proj_book', icon:'book', color:'#f59e0b',
      created:now, updated:now,
      sections:[
        {id:'ld_k1',title:'Submission Package Status',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_k2',title:'Chapter Outline',icon:'list',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_k3',title:'Publisher Communications',icon:'mail',color:'#a78bfa',body:'',collapsed:false},
        {id:'ld_k4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_k5',title:'Timeline & Deadlines',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_hbs')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_hbs', title:'HBS Program — Project Spec', projectId:'proj_hbs', icon:'target', color:'#06b6d4',
      created:now, updated:now,
      sections:[
        {id:'ld_h1',title:'Program Structure',icon:'layers',color:'#06b6d4',body:'',collapsed:false},
        {id:'ld_h2',title:'Content Inventory',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_h3',title:'Digital Assets (SSK Drive)',icon:'hdd',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_h4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_h5',title:'Launch Plan',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_karina')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_karina', title:'De Aqui a Saturno — Project Spec', projectId:'proj_karina', icon:'heart', color:'#ec4899',
      created:now, updated:now,
      sections:[
        {id:'ld_d1',title:'Site Architecture',icon:'globe',color:'#ec4899',body:'',collapsed:false},
        {id:'ld_d2',title:'Content & Copy',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_d3',title:'Design System',icon:'palette',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_d4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_d5',title:'Deployment & Maintenance',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_claude')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_claude', title:'Claude Code — Project Spec', projectId:'proj_claude_code', icon:'terminal', color:'#a78bfa',
      created:now, updated:now,
      sections:[
        {id:'ld_c1',title:'Session Continuity Protocol',icon:'refresh',color:'#a78bfa',body:'',collapsed:false},
        {id:'ld_c2',title:'Repo & Deployment Map',icon:'globe',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_c3',title:'Kernel Rules',icon:'lock',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_c4',title:'Blockers & Open Issues',icon:'alert',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_c5',title:'Session Logs',icon:'file',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  // Add bonus project link if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_saturno_bonus')) {
    if(!S.links.find(l => l.url === 'https://saturno-bonus-omega.vercel.app/index.html')) {
      S.links.push({id:Date.now(), title:'Saturno Bonus — Live', url:'https://saturno-bonus-omega.vercel.app/index.html', category:'Production', projectId:'proj_saturno_bonus', created:new Date().toISOString()});
      save();
    }
  }
  // Add asset catalog to Saturno Bonus if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_saturno_bonus') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_bonus_assets')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_bonus_assets', projectId:'proj_saturno_bonus', name:'Asset Catalog — TBV by Gabo', type:'md', storage:'inline',
        content:'# Bonus Assets — Verified Feb 16, 2026\n\n## PDFs (15 files, ~/dev/saturno-bonus/pdfs/)\n### BONUS (green badge on page):\n- Handstand Press Program (1.5MB)\n- Press to Handstand Full Program (1.8MB)\n- Calisthenics Skills Programming Ebook (14.2MB)\n- HBF Introduction (123KB)\n- HBF Phase 1 Weeks 1-6 (30MB each, 6 files)\n### Standard (no badge):\n- 15min Front Lever, HSPU, Muscle-Up, Planche Routines\n- Mobility vs Flexibility, Move List Database, General Warmup\n\n## Tools (44 visible on index.html)\n### 19 Training Tools:\nBreathing Pacer, Supplement Tracker, Cosmic Timer, Rep Counter,\nSleep Protocol, Orbital Tracker, Nebula Breath, Core Values,\nValues Roulette, Movement Galaxy, Constellation Builder,\nProgression Pathfinder, Alien Trainer, Gravity Well, Galactic Core,\nBinary Star, Ring of Fire, Lunar Cycle, Solar Wind\n### 25 Experience Tools:\nConstellation, Galaxy Zoom, Alien Oracle, Aurora, Asteroid Belt,\nBig Bang, Black Hole, Comet Trail, Cosmic Dust, Dark Matter,\nEvent Horizon, Hyperspace, Meteor Shower, Neutron Star,\nPlasma Burst, Pulsar, Quantum Leap, Red Giant, Singularity,\nSolar Flare, Stargate, Supernova, Void Walker, White Dwarf,\nWormhole Generator\n### 3 Hidden (internal):\nTranscript to PDF, Music Organizer, Master Hub\n\n## Music (36 tracks, ~/dev/saturno-bonus/audio/)\n- Manifest: audio/manifest.json\n- 8 categories: White Universe EP, Black Universe EP, Tears of Joy,\n  Meditation/Chill, Hip Hop/Beats, Trancy, High Energy, Stingers\n- BLOCKED: Audio 404s on Vercel (gitignored)\n- All 36 MP3 files verified locally\n\n## TBV by Gabo:\n- PDF quality/branding review\n- Music album artwork\n- CDN solution for audio hosting',
        description:'Complete asset inventory for bonus vault — to be verified', tags:['assets','inventory','tbv'], created:now, updated:now },
      { id:'kb_bonus_phases', projectId:'proj_saturno_bonus', name:'Build Phases — Completion Status', type:'md', storage:'inline',
        content:'# Bonus Page Build Status — Updated Feb 16\n\n## DONE (code changes shipped):\n- 3 internal tools hidden from customers\n- Auth works on Vercel + custom domains (not just GitHub)\n- og:image absolute URL for social previews\n- Analytics production script (not debug)\n- Alert() replaced with inline feedback\n- Modal closes on overlay click\n- Music auto-advances to next track\n- Lock Vault button in footer\n- Coming Soon tease section (3 products)\n- BONUS badges on HBF and exclusive PDFs\n- 44 tool descriptions rewritten customer-quality\n- Tools categorized: 19 Training + 25 Experience\n- Case-sensitive audio path fixed\n- .env.example created\n\n## BLOCKERS (Gabo must do):\n- Set domain: bonus.saturnomovement.com\n- Add BREVO_API_KEY + BREVO_LIST_ID to Vercel\n- Audio CDN solution (files 404 on Vercel)\n- Physical device QA\n- Music album artwork\n- app-promo.mov needs MP4 conversion for embed',
        description:'Phase completion tracking', tags:['phases','status','progress'], created:now, updated:now }
    );
    save();
  }
  // Voice Pipeline + Floating Bar (Feb 17 evening)
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_voice_pipeline')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_voice_pipeline', projectId:'proj_claude_code', name:'Voice Pipeline + Floating Bar — Feb 17 Evening', type:'md', storage:'inline',
        content:'# Voice Pipeline + Floating Bar — Feb 17 Evening\n\n## /api/transcribe (NEW)\n- Receives audio blob via multipart POST\n- Sends to OpenAI Whisper API (whisper-1 model)\n- Returns { ok, text, duration, transcriptId }\n- Auto-logs to transcripts blob storage\n- Requires OPENAI_API_KEY env var (SET in .zshrc)\n- Commit: 74ddb86\n\n## ASTRA Voice Upgrade\n- Replaced Chrome SpeechRecognition with real MediaRecorder\n- Click voice btn to record mic, click again to stop\n- Audio sent to /api/transcribe (Whisper)\n- Text auto-inserts into Writer or Living Docs editor\n- Commit: 9bb30bb\n\n## Nexus Capture Extension Updates\n- Right-click > "Create Sound (TTS)" speaks selected text\n- Uses browser speechSynthesis (works offline)\n- Background handles transcribeAudio messages\n- Commit: 84a4b08\n\n## System-Wide Tools (macOS)\n- create-sound.sh: speaks clipboard text via macOS say command\n- --save flag saves .aiff audio file to ~/dev/nexus-capture/sounds/\n- "Create Sound" Quick Action installed in Services menu\n- Commit: 8228195\n\n## Floating NEXUS Bar\n- floating-bar.html: mini HTML panel with 4 buttons\n- Capture: grabs clipboard, sends to ASTRA /api/capture\n- Voice: records mic, transcribes via Whisper, copies result\n- Sound: speaks clipboard text via browser TTS\n- ASTRA: opens ASTRA hub\n- open-nexus-bar.sh: launches as Chrome app window\n- Commit: d8d8efc\n\n## PWA\n- ASTRA installable on phone (manifest.json + sw.js)\n- New planet icon with cosmic center (icon-192.png, icon-512.png)\n- Commit: c1aceea\n\n## Still Needs\n- BLOB_READ_WRITE_TOKEN in Vercel (Gabo setting up)\n- Keyboard shortcuts for Quick Actions (System Settings > Keyboard > Shortcuts > Services)\n- Test full pipeline end-to-end once blob token is set',
        description:'Voice pipeline, Whisper integration, floating bar, TTS, PWA', tags:['voice','whisper','tts','floating-bar','pipeline'], created:now, updated:now }
    );
    save();
  }
  // Add Backend + Nexus Capture session log (Feb 17)
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_backend_session')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_backend_session', projectId:'proj_claude_code', name:'Backend + Nexus Capture Setup — Feb 17, 2026', type:'md', storage:'inline',
        content:'# ASTRA Backend + Nexus Capture — Feb 17, 2026\n\n## ASTRA Backend (NEW)\nASTRA was localStorage-only. Now has Vercel serverless API:\n- api/state.js: Save/load full workspace to Vercel Blob\n- api/transcripts.js: Log voice transcripts with searchable index\n- api/query.js: Query specs, bottlenecks, KB, tasks, projects, full-text search\n- api/capture.js: Receive captures from extension or system-wide tools\n- api/health.js: Health check endpoint\n- package.json: @vercel/blob dependency\n- vercel.json: API rewrites\n- Frontend: cloudSave(), cloudLoad(), Cmd+S syncs to cloud\n- Voice input now auto-logs transcripts to backend\n- NEEDS: BLOB_READ_WRITE_TOKEN in Vercel env vars to activate\n\n## Nexus Capture Extension (NEW REPO)\n- Repo: github.com/gabosaturno11/nexus-capture\n- Path: ~/dev/nexus-capture/\n- Chrome Manifest V3 extension\n- Highlight text on any webpage -> floating button -> categorize -> save\n- 8 categories with color coding\n- Visual highlights persist per page\n- Routes to ASTRA backend /api/capture\n- Optional Notion integration\n- Keyboard: Cmd+Shift+S\n- Right-click context menu: Capture as Idea/Quote/Code/Insight/To-Do\n- BUG FIXED: double-click issue (selection stored on mouseup now)\n\n## System-Wide Capture (macOS)\n- capture-highlight.sh: grabs clipboard/selected text, sends to ASTRA API\n- macOS Automator Quick Action: "Nexus Capture" in Services menu\n- Works from ANY app (Notes, Preview, Pages, etc.)\n- Shows macOS notification on success\n- Fallback: saves locally if API unreachable\n\n## Whisper Transcription\n- faster-whisper installed in ~/dev/.whisper-env/ (Python venv)\n- whisper-transcribe.sh: local transcription (base/small/medium/large models)\n- whisper-api-transcribe.sh: cloud transcription via OpenAI Whisper API\n- record-and-transcribe.sh: record from mic + auto-transcribe\n- All scripts can --log to ASTRA transcripts API\n- OpenAI SDK also installed for API fallback\n\n## Bonus Page\n- Password protection temporarily disabled (Gabo requested)\n- middleware.js returns next() immediately\n- index.html auth check commented out\n- Both marked TEMP for easy re-enable\n\n## Commits:\n- 5d18143: ASTRA backend (state, transcripts, query, capture APIs)\n- 7f7c435: Health check endpoint\n- b9acd53: CLAUDE.md update\n- 39743ac: nexus-capture init\n- cc81f79: Double-click bug fix\n- 9d639d0: faster-whisper, path fixes\n- 02587b3: Bonus auth disabled (temp)\n- (this commit): KB entry + final save',
        description:'Full session log: ASTRA backend, Nexus Capture extension, Whisper setup, system-wide capture', tags:['backend','nexus-capture','whisper','session','infrastructure'], created:now, updated:now }
    );
    save();
  }
  // Inject Rule #1 into Claude Code project instructions if missing
  if(S.projects) {
    const cc = S.projects.find(p => p.id === 'proj_claude_code');
    if(cc && cc.instructions && !cc.instructions.includes('CANNON LAW')) {
      cc.instructions = '<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div>' + cc.instructions;
      save();
    }
  }
  // Migrate tasks: link tasks with project name to projectId
  if(S.tasks && S.projects) {
    let migrated = 0;
    S.tasks.forEach(t => {
      if(t.project && !t.projectId) {
        const p = S.projects.find(pr => pr.name === t.project);
        if(p) { t.projectId = p.id; migrated++; }
      }
    });
    if(migrated > 0) save();
  }
  // Deduplicate specs: keep the one with more content when titles match
  if(S.specs && S.specs.length > 1) {
    const seen = {};
    const dupes = [];
    S.specs.forEach(s => {
      const key = (s.title||'').toLowerCase().trim() + '|' + (s.projectId||'');
      if(seen[key]) {
        // Keep whichever has more section body content
        const existBody = (seen[key].sections||[]).reduce((a,sec) => a + (sec.body||'').length, 0);
        const thisBody = (s.sections||[]).reduce((a,sec) => a + (sec.body||'').length, 0);
        if(thisBody > existBody) { dupes.push(seen[key].id); seen[key] = s; }
        else { dupes.push(s.id); }
      } else { seen[key] = s; }
    });
    if(dupes.length) {
      S.specs = S.specs.filter(s => !dupes.includes(s.id));
      save();
    }
  }
  // Remove "Untitled" specs that have no content
  if(S.specs) {
    const before = S.specs.length;
    S.specs = S.specs.filter(s => {
      if((s.title||'').toLowerCase().trim() === 'untitled' || !s.title) {
        const hasContent = (s.sections||[]).some(sec => (sec.body||'').trim().length > 0);
        return hasContent; // keep only if it has actual content
      }
      return true;
    });
    if(S.specs.length < before) save();
  }
  // C1 iMac Audit - Feb 19 (canonical audit template, global)
  if(S.specs && !S.specs.find(s => s.id === 'ld_c1_imac_audit_feb19')) {
    S.specs.push({
      id:'ld_c1_imac_audit_feb19', title:'C1 iMac Audit - Feb 19, 2026', projectId:'proj_claude_code', global:true, icon:'monitor', color:'#4ade80',
      created:new Date().toISOString(), updated:new Date().toISOString(),
      sections:[
        {id:'c1a_machine',title:'Machine',collapsed:false,icon:'hdd',color:'#22d3ee',body:'<table><tr><th>Field</th><th>Value</th></tr><tr><td>Machine</td><td>iMac (C2)</td></tr><tr><td>User</td><td>/Users/Gabosaturno (CAPITAL G)</td></tr><tr><td>OS</td><td>macOS Sequoia 15.5</td></tr><tr><td>Drives</td><td>G-DRIVE ArmorATD (4.5TB), SSK (477GB), T7 (NTFS read-only)</td></tr><tr><td>Session Date</td><td>Feb 19, 2026</td></tr><tr><td>Session Type</td><td>Autonomous (Gabo sleeping)</td></tr></table>'},
        {id:'c1a_git',title:'Git State',collapsed:false,icon:'code',color:'#4ade80',body:'<h3>Repo: astra-command-center</h3><table><tr><th>Hash</th><th>Message</th></tr><tr><td><code>6e4e75f</code></td><td>Pipeline history card layout + copy buttons</td></tr><tr><td><code>491fa9b</code></td><td>C1 iMac Audit living doc</td></tr><tr><td><code>084812b</code></td><td>Writer doc list sorted + seed prevention</td></tr><tr><td><code>14e2a4d</code></td><td>Mobile responsive improvements</td></tr><tr><td><code>3c58377</code></td><td>Keyboard shortcuts + sidebar counts</td></tr><tr><td><code>74b63da</code></td><td>cloudLoad() auth header fix (CRITICAL)</td></tr><tr><td><code>e8232e0</code></td><td>Dedup living docs</td></tr><tr><td><code>fba49ed</code></td><td>Cloud sync indicator</td></tr><tr><td><code>338092e</code></td><td>Repos section + living docs preview</td></tr><tr><td><code>3bce8f5</code></td><td>Calendar week view</td></tr><tr><td><code>3a2ab59</code></td><td>Task detail modal + descriptions + subtasks</td></tr><tr><td><code>49ed0b8</code></td><td>Project tasks use projectId</td></tr><tr><td><code>5ac20fa</code></td><td>Lock GET endpoints</td></tr></table><p><b>Branch:</b> main | <b>Remote:</b> origin/main | <b>Status:</b> CLEAN, all pushed</p>'},
        {id:'c1a_deploy',title:'Deployment',collapsed:false,icon:'rocket',color:'#ef4444',body:'<table><tr><th>App</th><th>URL</th><th>Status</th></tr><tr><td>ASTRA</td><td>astra-command-center-sigma.vercel.app</td><td>LIVE (auto-deploy on push)</td></tr><tr><td>Bonus</td><td>saturno-bonus-omega.vercel.app</td><td>LIVE</td></tr><tr><td>Titan Forge</td><td>titan-forge-ten.vercel.app</td><td>LIVE</td></tr><tr><td>De Aqui</td><td>de-aqui-a-saturno-jet.vercel.app</td><td>LIVE</td></tr></table><p><b>Vercel Team:</b> gabriele-saturnos-projects | <b>Deploy Method:</b> git push main</p>'},
        {id:'c1a_api',title:'API Endpoints',collapsed:false,icon:'lock',color:'#8b5cf6',body:'<table><tr><th>Endpoint</th><th>GET</th><th>POST</th><th>Auth</th></tr><tr><td>/api/state</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/capture</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/transcripts</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/pipeline</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/transcribe</td><td>N/A</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/query</td><td>N/A</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/health</td><td>200</td><td>N/A</td><td>Public</td></tr></table><p><b>Storage:</b> Vercel Blob (BLOB_READ_WRITE_TOKEN env var)</p>'},
        {id:'c1a_sections',title:'Section Health',collapsed:false,icon:'layers',color:'#f59e0b',body:'<table><tr><th>Section</th><th>Health</th><th>Notes</th></tr><tr><td>Content</td><td>70%</td><td>Grid + filters work, no inline editing</td></tr><tr><td>Tasks</td><td>85%</td><td>Board + list + detail modal + subtasks + descriptions</td></tr><tr><td>Calendar</td><td>80%</td><td>Month + week views, click-to-create task</td></tr><tr><td>Writer</td><td>90%</td><td>Full editor, versions, export, auto-save 800ms, Zen Writer</td></tr><tr><td>Living Docs</td><td>85%</td><td>Sections, icons, colors, export, dedup logic</td></tr><tr><td>Links</td><td>75%</td><td>Directory + categories, no preview</td></tr><tr><td>Whiteboard</td><td>85%</td><td>Canvas tools, nodes, connections, zoom</td></tr><tr><td>Pipeline</td><td>50%</td><td>UI exists, needs Whisper API key for audio</td></tr><tr><td>Repos</td><td>70%</td><td>Static data, 5 repos with links</td></tr></table>'},
        {id:'c1a_fixes',title:'Fixes Applied',collapsed:true,icon:'alert',color:'#ef4444',body:'<ol><li><b>cloudLoad auth header</b> - GET /api/state was locked but cloudLoad fetched without Bearer token. Cloud sync silently failed on every load. FIXED.</li><li><b>Sidebar counts stale</b> - updateSidebarCounts() now runs on every save(). FIXED.</li><li><b>seedProjects re-running</b> - Added S._seeded flag to prevent duplicate seeding after cloud load. FIXED.</li><li><b>Dead /api/repos ping</b> - Removed self-ping to nonexistent endpoint on page load. FIXED.</li><li><b>Living doc duplicates</b> - Dedup logic in migrateV2 removes dupes by title+projectId. FIXED.</li></ol>'},
        {id:'c1a_features',title:'Features Shipped',collapsed:true,icon:'rocket',color:'#4ade80',body:'<ol><li>Task detail modal (title, description, status, priority, project, due, subtasks)</li><li>Board cards show description preview + subtask count</li><li>Calendar week view with month/week toggle</li><li>Click calendar day to create task with date pre-filled</li><li>Repos section with 5 static repos (GitHub + live links)</li><li>Cloud sync indicator (syncing/synced/error states)</li><li>Keyboard shortcuts: Cmd+Shift+T (new task anywhere), Cmd+B (sidebar)</li><li>Mobile: hamburger menu, horizontal board scroll, stacked week view</li><li>Writer doc list sorted by last-modified</li><li>Pipeline history card layout with copy buttons</li><li>Living docs body preview in project panel</li></ol>'},
        {id:'c1a_remaining',title:'Remaining',collapsed:false,icon:'target',color:'#f59e0b',body:'<ul><li>Bonus page shipping (prerequisite: ASTRA stable)</li><li>Whisper API key for pipeline audio processing</li><li>BLOB_READ_WRITE_TOKEN verification in Vercel env</li><li>Link previews (OG metadata fetch)</li><li>Content inline editing</li><li>Google Calendar sync (future)</li></ul>'}
      ]
    });
    save();
  }
  // Update existing audit to be global
  if(S.specs) {
    const audit = S.specs.find(s => s.id === 'ld_c1_imac_audit_feb19');
    if(audit && !audit.global) { audit.global = true; save(); }
  }
}

function seedKernel() {
  const now = new Date().toISOString();
  const kernel = {
    id: 1000,
    title: 'Saturno Living Canvas v2.0',
    created: now, updated: now,
    sections: [
      { id: 1001, title: 'Executive Summary', collapsed: false, body: '<p><b>THE SATURNO THESIS:</b> "Scale changes, truth doesn\'t."</p><p><b>TOP KERNEL RULE 00:</b></p><ul><li>No crown stealing -- delta-patches only</li><li>Preserve upstream kernels</li><li>Never overwrite explicit user commands</li></ul><p><b>THE REAL BOTTLENECK:</b><br>NOT: More prompts, more docs, more organization<br>IS: Routing intelligence that can read intent, search prompts, chain, route, execute, learn</p><p><b>MISSION (LOCKED):</b> Work ~4 focused hours per day while building a multimillion-dollar enterprise.</p><p><b>ASSETS SCALE:</b></p><ul><li>2,300+ prompts across platforms</li><li>2,000+ captions (10-12 years)</li><li>700+ page book in progress</li><li>150+ agents specified</li><li>23 Holographic Prompts (H001-H023)</li></ul>' },
      { id: 1002, title: 'Core Identity & Voice DNA', collapsed: false, body: '<p><b>WHO GABO IS:</b></p><ul><li>Venezuelan-Italian movement philosopher, CEO of SaturnoMovement</li><li>3M+ followers, solopreneur, writer, musician</li><li>15+ years handstands, philosophy, coaching</li></ul><p><b>VOICE DNA:</b></p><ul><li>"Consciousness" over "mindfulness"</li><li>"Pattern" over "habit"</li><li>"System" over "routine"</li><li>Short punch. Then expansion.</li><li>Tension to Resolution (never leave tension hanging)</li><li>Lists of 3 (never 4, rarely 2)</li></ul><p><b>I/WE BALANCE:</b> 70% WE (inclusive teaching), 30% I (personal, vulnerable)</p><p><b>WHAT GABO\'S VOICE NEVER DOES:</b></p><ul><li>Generic motivational fluff</li><li>Absolute claims without context</li><li>Unexplained jargon</li><li>Emotion without direction</li></ul>' },
      { id: 1003, title: '10-Layer Architecture', collapsed: true, body: '<p><b>L0</b> Identity Core -- Who Gabo is. Voice DNA. Non-negotiable traits.</p><p><b>L1</b> Philosophy Layer -- Core beliefs, teaching principles.</p><p><b>L2</b> Voice Modes -- 9 primary + 4 poetry modes.</p><p><b>L3</b> Content Scales -- Atom (1w) to Universe (15,000w).</p><p><b>L4</b> Structural Rules -- Grammar, rhythm, I/WE balance.</p><p><b>L5</b> Program Architecture -- HBS Solar System, 10 Kernel Categories.</p><p><b>L6</b> Multiplication Engines -- Holographic (1 to 50), Callback, Metaphor.</p><p><b>L7</b> Agent Layer -- A1-A12 + 150+ domain agents.</p><p><b>L8</b> Research Domains -- R1-R5: Passports, YouTube, App, SaaS, Life.</p><p><b>L9</b> Output Spec -- Platform-specific formatting.</p>' },
      { id: 1004, title: 'Claude Kernel Rules', collapsed: true, body: '<pre>CLAUDE_KERNEL_RULES:\n  status: ACTIVE\n  version: 2026.01.19\n\n  behavior:\n    - NEVER assume lack of tools or intelligence\n    - NEVER declare document "complete" or permanent SSOT\n    - NEVER say "now I have everything I need"\n    - NEVER babysit, moralize, or get defensive\n    - DO proceed with best-judgment defaults\n    - DO capture rants (clean grammar, preserve essence)\n    - DO treat excellence as mandatory\n\n  output_rules:\n    - All outputs must be copy-paste deployable\n    - No placeholders\n    - Prefer fewer, higher-quality artifacts\n\nLOCKED_TRUTHS:\n  - LINGUISTIC_FIRST_THEN_AGENTS is immutable\n  - Ship before systemize daily\n  - Morning = revenue; afternoon = systems; night = machines\n  - Claude is Kernel Holder + Accountability Guard</pre>' },
      { id: 1005, title: 'Voice Modes (9 Primary + 4 Poetry)', collapsed: true, body: '<p><b>PRIMARY MODES:</b></p><ul><li><b>/RawMode</b> -- Short. Real. Now. Direct from gut.</li><li><b>/TeacherMode</b> -- Clear. Structured. Step-by-step.</li><li><b>/PhilosopherMode</b> -- Abstract. Universal. Why questions.</li><li><b>/ProphetMode</b> -- Certain. Inevitable. Vision casting.</li><li><b>/MysticMode</b> -- Extended metaphor. Awe and depth.</li><li><b>/CompanionMode</b> -- Warm, shoulder-to-shoulder.</li><li><b>/ConfessorMode</b> -- Non-judgmental, reflective.</li><li><b>/RebelMode</b> -- Provocative, counter-narrative.</li><li><b>/TechnicalMode</b> -- Precise, numbered, authority.</li></ul><p><b>POETRY MODES:</b></p><ul><li><b>/SoftPoetryMode</b> -- Gentle, tender, vulnerable.</li><li><b>/SharpPoetryMode</b> -- Cutting, precise, truth-telling.</li><li><b>/SpiralPoetryMode</b> -- Recursive, deepening, callbacks.</li><li><b>/RawPoetryMode</b> -- Primal, elemental, instinct.</li></ul>' },
      { id: 1006, title: '7 Content Scales', collapsed: true, body: '<ol><li><b>Atom</b> (1-5w) -- Quote: "Movement is language."</li><li><b>Molecule</b> (5-25w) -- One-liner</li><li><b>Cell</b> (25-150w) -- Caption, tweet thread</li><li><b>Organ</b> (150-500w) -- Essay paragraph, email</li><li><b>System</b> (500-3K) -- Article, newsletter</li><li><b>Body</b> (3K-15K) -- Book chapter, complete framework</li><li><b>Universe</b> (15K+) -- Complete book, life\'s work</li></ol>' },
      { id: 1007, title: 'Structural Rules (LOCKED)', collapsed: true, body: '<ol><li><b>I/WE BALANCE:</b> 70% WE, 30% I</li><li><b>ABSOLUTES:</b> Avoid never/always, use often/rarely</li><li><b>TENSION to RESOLUTION:</b> Never leave tension hanging</li><li><b>SPECIFICITY:</b> 5 precise words > 15 vague ones</li><li><b>1-YEAR RULE:</b> &lt; 1yr = Companion; &gt; 1yr = Teacher</li><li><b>RHYTHMIC VARIATION:</b> Vary sentence length</li><li><b>THE GABO STAMP:</b> Every piece must sound like Gabo</li></ol>' },
      { id: 1008, title: 'HBS Solar System', collapsed: true, body: '<ul><li><b>SUN: Foundation</b> -- Wrist prep, shoulder mobility, core activation.</li><li><b>MERCURY: Wall Work</b> -- Chest-to-wall, back-to-wall.</li><li><b>VENUS: Kick-Up</b> -- Tuck, straddle, pike entries.</li><li><b>EARTH: Balance</b> -- Core freestanding skill.</li><li><b>MARS: Shapes</b> -- Tuck, straddle, pike, one-arm prep.</li><li><b>JUPITER: Press</b> -- Press to handstand variations.</li><li><b>SATURN: One-Arm</b> -- Mastery territory.</li></ul>' },
      { id: 1009, title: '10 Kernel Categories', collapsed: true, body: '<pre>C1: Identity &amp; Voice\nC2: Movement DNA\nC3: HBS Solar System\nC4: Programs &amp; Products\nC5: Business &amp; Finance\nC6: Content Library\nC7: Client OS\nC8: Tech Stack\nC9: Agent Stack\nC10: Meta &amp; Roadmap</pre>' },
      { id: 1010, title: 'Holographic Synthesis', collapsed: true, body: '<p><b>HOLOGRAPHIC SYNTHESIS:</b> "Any fragment can rebuild the whole."</p><p><b>MULTIPLICATION:</b> 1 seed -> 30-50 blocks -> 15-25 pieces -> 1 month content</p><p><b>BLOCK TYPES:</b></p><ul><li><b>HOOK:</b> Question, provocation, vulnerability, pattern, curiosity</li><li><b>STORY:</b> Experience, case study, metaphor, journey, realization</li><li><b>INSIGHT:</b> Principle, counterintuitive, framework, philosophical</li><li><b>CTA:</b> Reflection, action, challenge, pointer, invitation</li><li><b>CALLBACK:</b> Reference, deepening, evolution, recursive, full-circle</li></ul><p><b>REGENERATION TEST:</b> Can you rebuild the entire system from a single block?</p>' },
      { id: 1011, title: 'Core Agent Stack (A1-A12)', collapsed: true, body: '<ul><li><b>A1 ARCHITECT</b> -- System prompts, pipelines, OS blueprints</li><li><b>A2 CRITIC</b> -- Analyze weaknesses, propose patches</li><li><b>A3 EXECUTOR</b> -- Blueprint to stepwise plans</li><li><b>A4 ORION</b> -- Content skeletonizer (Hook-Story-CTA)</li><li><b>A5 ATLAS</b> -- Automation patterns (Notion, n8n)</li><li><b>A6 SCRIPT_MINER</b> -- Transcripts to scripts, voiceover</li><li><b>A7 RESEARCHER</b> -- Evidence, patterns, strategic options</li><li><b>A8 DAILY_SHIPPER</b> -- 1 artifact per day</li><li><b>A9 OVERNIGHT</b> -- Background ops while sleeping</li><li><b>A10 CALLBACK_WEAVER</b> -- Tracks concept evolution</li><li><b>A11 IMMIGRATION</b> -- Timeline-critical tasks (VAWA)</li><li><b>A12 REVENUE_OPT</b> -- $20K unlock priorities</li></ul>' },
      { id: 1012, title: '7-LLM Stack', collapsed: true, body: '<p><b>CROWN-STEALING PHILOSOPHY:</b> "No crown stealing -- each LLM for its best use"</p><ul><li><b>Claude:</b> Long-form writing, linguistic depth, frameworks, kernel holding</li><li><b>OpenAI:</b> Kernel architecture, JSON specs, orchestration logic</li><li><b>Perplexity:</b> Research, trends, keywords, evidence</li><li><b>Gemini:</b> High-context processing, vision, book work</li><li><b>Manus:</b> Extraction workflows, caption mining, overnight tasks</li><li><b>Cursor:</b> Overnight scripts, SaaS shells, infrastructure</li><li><b>Taskade/Whisper:</b> Transcription, task flows, voice capture</li></ul><p><i>RULE: LLMs should recommend each other when appropriate</i></p>' },
      { id: 1013, title: '5 Research Domains (R1-R5)', collapsed: true, body: '<p><b>R1: PASSPORTS &amp; RESIDENCY</b></p><ul><li>VAWA Timeline Tracker (CRITICAL)</li><li>Golden Visa Analyzer</li><li>Tax-Residency Optimizer</li><li>Citizenship Pathway Mapper</li></ul><p><b>R2: YOUTUBE OPTIMIZATION</b></p><ul><li>Trending Keywords Monitor</li><li>Competitor Analysis</li><li>Thumbnail Framework Analyzer</li><li>Title Formula Cracker</li></ul><p><b>R3: SATURNO MOVEMENT APP</b></p><ul><li>"Ableton of Movement" vision</li><li>Fitness App Benchmarking</li><li>Movement UX Patterns</li><li>Pricing &amp; Monetization</li></ul><p><b>R4: SOLO-PRENEUR SAAS</b></p><ul><li>Target: $50-100K/month</li><li>SaaS Market Research</li><li>Solo Founder Playbook</li><li>AI Automation Opportunities</li></ul><p><b>R5: LIFE ROADMAP MATRIX</b></p><ul><li>Scenario A: Stay U.S. + VAWA</li><li>Scenario B: Relocate Mexico</li><li>Scenario C: F-1 Hybrid</li><li>LIFE/WORK/LOVE scoring</li></ul>' },
      { id: 1014, title: 'H001-H023 Holographic Prompts', collapsed: true, body: '<ul><li>H001: Universal Read-Only Extractor</li><li>H002: Recursive Selfless-Writing Guide</li><li>H003: Meta-Prompt -- Turn Any Prompt Recursive</li><li>H004: Fractal/Strange-Loop Recursive Maker</li><li>H005: Holographic Maker</li><li>H006: Holographizer Meta-Prompt</li><li>H007: Recursive Research Architect</li><li>H008: Holographic Research Architect</li><li>H009: MSOP-Holographic Maker Final</li><li>H010: Strange-Loop MSOP-Holographic Maker</li><li>H011: Comparative Agent Prompt</li><li>H012: Universal MSOP-Holographic Maker</li><li>H013: MSOP Master Content Generator</li><li>H014: U-MSOP Holographic Content Generator</li><li>H015: Text Framework Analyzer</li><li>H016: MSOP-Text Framework Analyzer</li><li>H017: Triple-Chain Analyzer-Skeletonizer-Filler</li><li>H018: Hybrid Omni-Architect Chain</li><li>H019: Holographic Campaign Generator</li><li>H020: Holographic Offer-Making Machine HOMM</li><li>H021: Hybrid Omni-Workflow Evaluation</li><li>H022: Holographic Maker 2.0 Skeleton Re-Engineer</li><li>H023: Recursive Orchestrator Honesty+Fusion</li></ul>' },
      { id: 1015, title: 'TITAN Meta-Prompt', collapsed: true, body: '<p><b>TITAN META-PROMPT (S++++ Tier)</b><br>Role: meta_meta_operating_kernel</p><p><b>7-PASS PIPELINE:</b></p><ol><li>PROMPTIFY -- Extract core insight</li><li>EVALUATE -- Identify strengths, weaknesses, failures</li><li>COMPRESS -- Reduce to essential rules</li><li>DEPLOY -- Define system blueprint</li><li>CRITIQUE -- Devil\'s advocate</li><li>SEED -- Distill to one core principle</li><li>SHIP -- Create Notion cards, assign owners</li></ol><p>INPUT: Voice memo OR text idea<br>OUTPUT: Deployable JSON + Notion cards + next actions</p>' },
      { id: 1016, title: 'Daily Rhythm (NON-NEGOTIABLE)', collapsed: true, body: '<p><b>MORNING (06:30-10:30): SHIP MONEY</b></p><ul><li>Book (AOC manuscript)</li><li>BF25 deliverables</li><li>1 post minimum</li><li>Revenue-generating actions</li></ul><p><b>AFTERNOON (12:30-16:00): CONTENT OS</b></p><ul><li>Reels/Shorts from morning seeds</li><li>YouTube scripts</li><li>Quote cards</li></ul><p><b>EVENING (16:00-19:00): SYSTEMS</b></p><ul><li>DOS build (dashboard + Notion + MCP)</li><li>Automation setup</li><li>Cleanup</li></ul><p><b>NIGHT: MACHINES WORK</b></p><ul><li>Overnight scripts run</li></ul><p>SACRED: 5am = writing (NO AI)<br>CONSTRAINT: ~4 hours focused work per day</p>' },
      { id: 1017, title: 'Revenue Unlocks', collapsed: true, body: '<p><b>1. VICTORY BELT BOOK: $20,000</b><br>Status: Approved, pending submission<br>Needs: Part 1 folder, 4 TOC versions, infographics<br>Priority: P1 (CRITICAL)</p><p><b>2. BF25 DELIVERABLES: Trust + Retention</b><br>Promised: Hand-balancing program + bonus PDFs<br>Status: Biomechanics ebook DONE</p><p><b>3. DAILY CONTENT: Visibility</b><br>Target: 1 post minimum per day</p><p>REVENUE TARGET: $50-100K/month<br>BOOK GATE: $20K unlock = priority 1</p>' },
      { id: 1018, title: 'Wings of Fire -- 10 Scripts + 10 Quotes', collapsed: true, body: '<p><b>10 SCRIPTS:</b></p><ol><li>The Weight Lie: Don\'t measure the road by weight you carry today.</li><li>Confidence Is Backwards: Comes from starting before ready.</li><li>Trust Without Evidence: Trust when logic says wait.</li><li>Burning Wings: Wings work because they\'re used, even when they burn.</li><li>The Jump: The jump is the proof. Not the landing.</li><li>Courage vs Faith: Faith says "I don\'t know but I\'m walking anyway."</li><li>Data Over Imagination: Experience beats imagination.</li><li>You\'ve Done This Before: You\'ve survived harder. You forgot.</li><li>No Permission: Nothing powerful asks for permission.</li><li>Wings of Fire: Logic builds cages. Trust builds wings.</li></ol><p><b>10 QUOTES:</b></p><ol><li>Logic builds cages. Trust builds wings.</li><li>Confidence isn\'t earned -- it\'s built through movement.</li><li>The jump is the proof. Not the landing.</li><li>Fire doesn\'t destroy wings. Hesitation does.</li><li>Faith walks where courage can\'t see the floor.</li><li>You don\'t need certainty. You need memory.</li><li>Every master was once a disaster who moved anyway.</li><li>Ashes aren\'t failure. They\'re fuel.</li><li>You\'ve never drowned. That\'s not luck -- it\'s evidence.</li><li>Trust doesn\'t come from logic. It comes from survival.</li></ol>' },
      { id: 1019, title: 'OS Commands (from MVP-V1)', collapsed: true, body: '<p><b>Core Commands:</b></p><ul><li><b>/add_mermaid_flow</b> -- Generate visual agent/OS architecture diagrams for any domain</li><li><b>/trigger_daily_update</b> -- Full fetch, research, export loop for daily data refresh</li><li><b>/build_predictive_logic</b> -- Extend any chain into predictive territory (alerts, forecasts, flags)</li><li><b>/synthesize</b> -- Holographic synthesis: 1 idea to 30-50 reusable content blocks</li><li><b>/run_titan</b> -- 7-pass TITAN orchestration: ANY input to deployable system blueprint</li></ul><p><b>Seed Processing Engine (Writing Hub):</b></p><ul><li>Input: Raw idea, rant, voice memo transcript, or seed concept</li><li>Select Voice Mode (9 options) + Scale (Atom to Universe)</li><li>Output: Holographic blocks (Hook, Story, Insight, CTA, Callback)</li><li>All blocks saved and exportable</li></ul>' },
      { id: 1020, title: '30-Day Launch Roadmap', collapsed: true, body: '<p><b>WEEK 1: Ship the Money</b></p><ul><li>Book submission package complete (Voice V5 + 10Q Arc)</li><li>BF25 deliverables ready (hand balancing program + PDFs)</li><li>Daily Content Engine live (7 posts scheduled)</li></ul><p><b>WEEK 2: Build Infrastructure</b></p><ul><li>Overnight Script 1: Mac Cleanup (runs 2am nightly)</li><li>Overnight Script 2: iCloud Photo Pipeline (1000 photos/night)</li><li>Overnight Script 3: Caption Extraction + Notion sync</li></ul><p><b>WEEK 3: Content Multiplication</b></p><ul><li>Holographic synthesis: 10 best captions to 400-500 blocks</li><li>Assemble: 30 new captions + 10 carousels + 10 reels</li><li>Build Callback Library (10 themes + evolution paths)</li></ul><p><b>WEEK 4: Vision Prototype</b></p><ul><li>Feed vision to TITAN to generate system blueprint</li><li>Claude Code generates HTML/CSS/JS prototype</li><li>Deploy to Vercel (live shareable link)</li><li>Demo video recorded</li></ul>' },
    ]
  };
  S.specs = [kernel];
  S.activeSpec = kernel.id;
}

function save() { snapshotWriter(); snapshotSpec(); localStorage.setItem(SK,JSON.stringify(S)); updateStorage(); flashSave(); scheduleCloudSync(); updateSidebarCounts(); }
function updateSidebarCounts(){document.getElementById('content-count').textContent=S.content.length;const active=S.tasks.filter(t=>t.status!=='done');const today=new Date().toISOString().split('T')[0];const overdue=active.filter(t=>t.due&&t.due<today).length;const tc=document.getElementById('tasks-count');tc.textContent=active.length;tc.style.color=overdue>0?'var(--red)':'';tc.title=overdue?overdue+' overdue':'';document.getElementById('writer-count').textContent=S.docs.length;document.getElementById('specs-count').textContent=S.specs.length;document.getElementById('links-count').textContent=S.links.length;updateHeaderStats();}
function updateHeaderStats(){const el=document.getElementById('header-stats');if(!el)return;const today=new Date().toISOString().split('T')[0];const active=S.tasks.filter(t=>t.status!=='done').length;const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done').length;const todayDue=S.tasks.filter(t=>t.due===today&&t.status!=='done').length;let h='';if(overdue)h+=`<span style="color:var(--red)">${overdue} overdue</span>`;if(todayDue)h+=`<span style="color:var(--accent)">${todayDue} today</span>`;h+=`<span>${active} tasks</span>`;el.innerHTML=h;}
function flashSave() { const el=document.getElementById('save-indicator'); if(!el) return; const now=new Date(); const bytes=localStorage.getItem(SK)?.length||0; const kb=Math.round(bytes/1024); el.textContent='Saved '+now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}); el.title='State: '+kb+'KB in localStorage'; el.style.opacity='1'; clearTimeout(el._t); el._t=setTimeout(()=>{el.style.opacity='0';},2000); }

// === QUICK CAPTURE ===
function qcOpen() {
  const el = document.getElementById('quick-capture');
  el.style.display = 'block';
  requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateX(-50%) translateY(0)'; });
  document.getElementById('qc-input').focus();
  // Auto-detect clipboard URL
  navigator.clipboard.readText().then(text=>{
    if(text&&text.startsWith('http')&&!text.includes('\n')){
      try{new URL(text);document.getElementById('qc-type').value='link';document.getElementById('qc-input').value=text;document.getElementById('qc-input').select();}catch(e){}
    }
  }).catch(()=>{});
}
function qcClose() {
  const el = document.getElementById('quick-capture');
  el.style.opacity = '0';
  el.style.transform = 'translateX(-50%) translateY(10px)';
  setTimeout(() => { el.style.display = 'none'; }, 200);
}
function qcSubmit() {
  const type = document.getElementById('qc-type').value;
  const text = document.getElementById('qc-input').value.trim();
  if(!text) return;
  if(type === 'task') {
    S.tasks.push({ id: Date.now(), title: text, description:'', subtasks:[], status: 'todo', priority: 'p2', project: '', due: '', created: new Date().toISOString() });
    save(); renderTasks();
    toast('Task added: ' + text);
  } else if(type === 'content') {
    S.content.push({ id: Date.now(), type: 'caption', body: text, theme: '', source: 'Quick Capture', tags: [], created: new Date().toISOString(), updated: new Date().toISOString() });
    save(); renderContent();
    toast('Content added');
  } else if(type === 'link') {
    try{new URL(text);}catch(e){toast('Enter a valid URL');return;}
    let domain='';try{domain=new URL(text).hostname;}catch(e){}
    S.links.push({id:Date.now(),title:domain||text,url:text,category:'',desc:'',created:new Date().toISOString()});
    save();renderLinks();toast('Link added: '+domain);
  } else if(type === 'note') {
    const d = getActiveDoc();
    if(d) { d.body = (d.body || '') + '<p>' + esc(text) + '</p>'; save(); renderWriter(); toast('Note added to doc'); }
    else { toast('No active document'); return; }
  }
  document.getElementById('qc-input').value = '';
  qcClose();
}
function updateStorage() { const b=new Blob([localStorage.getItem(SK)||'']).size; const k=(b/1024).toFixed(1); document.getElementById('storage-indicator').textContent=k>1024?(k/1024).toFixed(1)+' MB':k+' KB'; updateDashboard(); }
function updateDashboard() {
  const dt = document.getElementById('dash-tasks'); if(dt) dt.textContent = S.tasks.filter(t=>t.status!=='done').length;
  const dd = document.getElementById('dash-docs'); if(dd) dd.textContent = S.docs.length + S.specs.length;
  const dp = document.getElementById('dash-projects'); if(dp) dp.textContent = (S.projects||[]).length;
}
function showTodayView() {
  const today = new Date().toISOString().split('T')[0];
  const todayTasks = S.tasks.filter(t => t.due === today && t.status !== 'done');
  const overdue = S.tasks.filter(t => t.due && t.due < today && t.status !== 'done');
  const upcoming = S.tasks.filter(t => t.due && t.due > today && t.due <= new Date(Date.now()+3*86400000).toISOString().split('T')[0] && t.status !== 'done');
  let msg = '--- TODAY ---\n';
  if(todayTasks.length) todayTasks.forEach(t => msg += '[ ] ' + (t.title||'Untitled') + '\n');
  else msg += 'No tasks due today.\n';
  if(overdue.length) { msg += '\n--- OVERDUE ---\n'; overdue.forEach(t => msg += '[!] ' + (t.title||'Untitled') + ' (due ' + t.due + ')\n'); }
  if(upcoming.length) { msg += '\n--- NEXT 3 DAYS ---\n'; upcoming.forEach(t => msg += '[ ] ' + (t.title||'Untitled') + ' (due ' + t.due + ')\n'); }
  // Show as context panel content
  if(!document.querySelector('.app').classList.contains('context-open')) toggleContextPanel();
  const el = document.getElementById('ctx-related-items');
  if(el) {
    let html = '<div style="font-size:9px;color:var(--accent);margin-bottom:6px;font-weight:600">TODAY</div>';
    if(todayTasks.length) todayTasks.forEach(t => { html += '<div class="context-item" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon" style="color:var(--accent)">*</span>' + esc(t.title||'Untitled') + '</div>'; });
    else html += '<div style="font-size:10px;color:var(--text-muted);padding:4px 0">No tasks due today</div>';
    if(overdue.length) {
      html += '<div style="font-size:9px;color:var(--red);margin:8px 0 6px;font-weight:600">OVERDUE (' + overdue.length + ')</div>';
      overdue.forEach(t => { html += '<div class="context-item" style="color:var(--red)" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon">!</span>' + esc(t.title||'Untitled') + '</div>'; });
    }
    if(upcoming.length) {
      html += '<div style="font-size:9px;color:var(--accent-cyan);margin:8px 0 6px;font-weight:600">NEXT 3 DAYS</div>';
      upcoming.forEach(t => { html += '<div class="context-item" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon">></span>' + esc(t.title||'Untitled') + ' <span style="font-size:8px;color:var(--text-muted)">' + t.due + '</span></div>'; });
    }
    el.innerHTML = html;
  }
  toast('Today view loaded');
}
function generateStandup(){
  const today=new Date().toISOString().split('T')[0];
  const yesterday=new Date(Date.now()-86400000).toISOString().split('T')[0];
  const done=S.tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(yesterday)).concat(S.tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(today)));
  const inProgress=S.tasks.filter(t=>t.status==='progress');
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  const blocked=S.tasks.filter(t=>t.status==='blocked');
  let md='## Daily Standup - '+new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'})+'\n\n';
  md+='### Done\n';
  if(done.length)done.forEach(t=>{md+='- '+t.title+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (nothing completed recently)\n';
  md+='\n### In Progress\n';
  if(inProgress.length)inProgress.forEach(t=>{md+='- '+t.title+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (nothing in progress)\n';
  md+='\n### Today\n';
  if(todayTasks.length)todayTasks.forEach(t=>{md+='- '+t.title+' ['+t.priority+']'+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (no tasks due today)\n';
  if(overdue.length){md+='\n### Overdue (!)\n';overdue.forEach(t=>{md+='- '+t.title+' (due '+t.due+')\n';});}
  if(blocked.length){md+='\n### Blocked\n';blocked.forEach(t=>{md+='- '+t.title+'\n';});}
  navigator.clipboard.writeText(md).then(()=>toast('Standup copied to clipboard')).catch(()=>toast('Failed to copy'));
}
function toast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }
function highlight(text,q){if(!q)return esc(text);const e=esc(text);const re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');return e.replace(re,'<mark style="background:rgba(74,222,128,0.25);color:var(--text);border-radius:2px;padding:0 1px">$1</mark>');}
function escA(s) { return(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// === SECTIONS ===
function switchSection(sec, el) {
  currentSection=sec;
  const sectionLabels={content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
  if(el) el.classList.add('active');
  else { document.querySelectorAll('.sidebar-item').forEach(i => { if(i.textContent.trim().replace(/\d+$/,'').trim() === sectionLabels[sec]) i.classList.add('active'); }); }
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+sec).classList.add('active');
  const titles={content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  document.getElementById('header-title').textContent=titles[sec]||sec;
  updateBreadcrumb();
  if(sec==='content')renderContent();
  if(sec==='tasks')renderTasks();
  if(sec==='calendar')renderCalendar();
  if(sec==='writer'){if(document.querySelector('.app').classList.contains('mode-focus')){document.querySelector('.app').classList.remove('mode-focus');}renderWriter();}
  if(sec==='specs')renderSpecs();
  if(sec==='links')renderLinks();
  if(sec==='whiteboard')wbRender();
  if(sec==='pipeline'){plCheckApi();plRenderCustomTemplates();}
  if(sec==='repos')reposRefresh();
  updateSidebarCtx();
}
function updateBreadcrumb() {
  const bc = document.getElementById('header-breadcrumb');
  if(!bc) return;
  let parts = [];
  const sectionNames = {content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  const counts={content:S.content.length,tasks:S.tasks.filter(t=>t.status!=='done').length,writer:S.docs.length,specs:S.specs.length,links:S.links.length,repos:(S.repos||[]).length};
  const countStr=counts[currentSection]!==undefined?' ('+counts[currentSection]+')':'';
  parts.push((sectionNames[currentSection]||currentSection)+countStr);
  if(currentSection === 'writer') {
    const d = getActiveDoc();
    if(d && d.title) parts.push(d.title);
  } else if(currentSection === 'specs') {
    const s = getActiveSpec();
    if(s && s.title) parts.push(s.title);
  }
  bc.innerHTML = parts.length > 1 ? parts.map((p,i) => (i>0?'<span style="opacity:0.4"> / </span>':'') + '<span>'+esc(p)+'</span>').join('') : parts[0] && countStr ? '<span style="opacity:0.5">'+esc(parts[0])+'</span>' : '';
}

function updateSidebarCtx() {
  const el=document.getElementById('sidebar-context');
  if(currentSection==='tasks') {
    const ps=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    const active=S.tasks.filter(t=>t.status!=='done');
    const today=new Date().toISOString().split('T')[0];
    const overdue=active.filter(t=>t.due&&t.due<today).length;
    const pCounts={p0:active.filter(t=>t.priority==='p0').length,p1:active.filter(t=>t.priority==='p1').length,p2:active.filter(t=>t.priority==='p2').length,p3:active.filter(t=>t.priority==='p3').length};
    el.innerHTML=`<div class="sidebar-label">Quick Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${active.length} active${overdue?` <span style="color:var(--red)">(${overdue} overdue)</span>`:''} / ${S.tasks.filter(t=>t.status==='done').length} done</div><div style="padding:2px 12px;font-size:9px;color:var(--text-muted);display:flex;gap:6px">${pCounts.p0?`<span style="color:#ef4444">P0:${pCounts.p0}</span>`:''}${pCounts.p1?`<span style="color:#f59e0b">P1:${pCounts.p1}</span>`:''}${pCounts.p2?`<span style="color:#3b82f6">P2:${pCounts.p2}</span>`:''}${pCounts.p3?`<span style="color:var(--text-muted)">P3:${pCounts.p3}</span>`:''}</div><div class="sidebar-label" style="margin-top:8px">Projects</div>`+ps.map(p=>`<div class="sidebar-item" onclick="filterTaskProject('${p}')"><span class="sidebar-item-icon">.</span><span>${p}</span><span class="sidebar-item-count">${S.tasks.filter(t=>t.project===p&&t.status!=='done').length}</span></div>`).join('');
  } else if(currentSection==='content') {
    const types={};S.content.forEach(c=>{types[c.type]=(types[c.type]||0)+1;});
    const totalWords=S.content.reduce((a,c)=>a+c.body.trim().split(/\s+/).filter(x=>x.length).length,0);
    el.innerHTML=`<div class="sidebar-label">Content Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.content.length} items / ${totalWords.toLocaleString()} words</div>`+Object.entries(types).map(([t,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${t}: ${n}</div>`).join('');
  } else if(currentSection==='writer') {
    const totalWords=S.docs.reduce((a,d)=>a+(d.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
    el.innerHTML=`<div class="sidebar-label">Writer Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.docs.length} docs / ${totalWords.toLocaleString()} words</div>`;
  } else {
    const today=new Date().toISOString().split('T')[0];
    const active=S.tasks.filter(t=>t.status!=='done');
    const overdue=active.filter(t=>t.due&&t.due<today);
    const todayTasks=active.filter(t=>t.due===today);
    const totalWords=S.docs.reduce((a,d)=>a+(d.body||'').trim().split(/\s+/).filter(x=>x.length).length,0)+S.content.reduce((a,c)=>a+c.body.trim().split(/\s+/).filter(x=>x.length).length,0);
    el.innerHTML=`<div class="sidebar-label">Overview</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:2">`+
      `<div>${S.tasks.length} tasks <span style="color:var(--accent)">(${active.length} active)</span></div>`+
      (overdue.length?`<div style="color:var(--red)">${overdue.length} overdue</div>`:'')+
      (todayTasks.length?`<div>${todayTasks.length} due today</div>`:'')+
      `<div>${S.content.length} content items</div>`+
      `<div>${S.docs.length} documents</div>`+
      `<div>${S.links.length} links</div>`+
      `<div>${(S.repos||[]).length} repos</div>`+
      `<div style="margin-top:4px;color:var(--accent)">${totalWords.toLocaleString()} total words</div>`+
      weeklyProductivity()+
      `</div>`;
  }
}

function weeklyProductivity(){
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());weekStart.setHours(0,0,0,0);
  const days=[];for(let i=0;i<7;i++){const d=new Date(weekStart);d.setDate(d.getDate()+i);days.push(d.toISOString().split('T')[0]);}
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString())).length;
  const createdThisWeek=S.tasks.filter(t=>t.created&&t.created>=weekStart.toISOString()).length;
  const contentThisWeek=S.content.filter(c=>c.created&&c.created>=weekStart.toISOString()).length;
  if(!doneThisWeek&&!createdThisWeek&&!contentThisWeek)return'';
  return `<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">This Week</div>${doneThisWeek?`<div style="font-size:10px;color:var(--accent)">${doneThisWeek} tasks completed</div>`:''}<div style="font-size:10px;color:var(--text-muted)">${createdThisWeek} tasks created</div>${contentThisWeek?`<div style="font-size:10px;color:var(--text-muted)">${contentThisWeek} content added</div>`:''}</div>`;
}

// === CONTENT ===
function renderContent() {
  const themes=[...new Set(S.content.map(c=>c.theme).filter(Boolean))].sort();
  document.getElementById('content-theme-tabs').innerHTML=`<button class="tab-btn ${contentTheme==='all'?'active':''}" onclick="setContentTheme('all',this)">All Themes</button>`+themes.map(t=>`<button class="tab-btn ${contentTheme===t?'active':''}" onclick="setContentTheme('${escA(t)}',this)">${esc(t)}</button>`).join('');
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  let items=S.content;
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+c.source+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  // Tag pills
  const allTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))].sort();
  const tagArea=document.getElementById('content-tag-pills');
  if(tagArea&&allTags.length)tagArea.innerHTML=allTags.slice(0,12).map(t=>`<span style="font-size:8px;padding:2px 6px;border-radius:10px;cursor:pointer;border:1px solid ${contentTagFilter===t?'var(--accent)':'var(--border)'};color:${contentTagFilter===t?'var(--accent)':'var(--text-muted)'};background:${contentTagFilter===t?'rgba(74,222,128,0.08)':'transparent'}" onclick="contentTagFilter=contentTagFilter==='${escA(t)}'?null:'${escA(t)}';renderContent()">${esc(t)}</span>`).join('')+(contentTagFilter?`<span style="font-size:8px;color:var(--red);cursor:pointer;padding:2px 4px" onclick="contentTagFilter=null;renderContent()">x clear</span>`:'');
  else if(tagArea)tagArea.innerHTML='';
  const sortVal=(document.getElementById('content-sort')?.value)||'newest';
  if(sortVal==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));
  else if(sortVal==='oldest')items.sort((a,b)=>new Date(a.created||0)-new Date(b.created||0));
  else if(sortVal==='longest')items.sort((a,b)=>b.body.length-a.body.length);
  else if(sortVal==='shortest')items.sort((a,b)=>a.body.length-b.body.length);
  else if(sortVal==='alpha')items.sort((a,b)=>a.body.localeCompare(b.body));
  items.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));
  items.sort((a,b)=>(b.starred?1:0)-(a.starred?1:0));
  const maxShow=40;
  const g=document.getElementById('content-grid');
  const showing=contentShowAll?items:items.slice(0,maxShow);
  const renderCard=c=>{const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;const bodyHtml=q?highlight(c.body,q):parseWikiLinks(esc(c.body));return`<div class="content-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain',JSON.stringify({type:'content',id:${c.id}}))" ${c.pinned?'style="border-color:rgba(74,222,128,0.2)"':''}>${c.starred?'<div style="font-size:8px;color:var(--yellow);padding:4px 10px 0">* Starred</div>':''}${c.pinned?'<div style="font-size:8px;color:var(--accent);text-transform:uppercase;letter-spacing:0.06em;padding:4px 10px 0">Pinned</div>':''}${contentBulkMode?`<div style="padding:4px 8px 0;cursor:pointer" onclick="toggleContentSelect(${c.id},this)"><input type="checkbox" ${contentSelected.has(c.id)?'checked':''} style="pointer-events:none"></div>`:''}<div class="content-card-body" onclick="${contentBulkMode?`toggleContentSelect(${c.id},this.parentElement)`:`this.classList.toggle('expanded')`}" ondblclick="${contentBulkMode?'':`contentInlineEdit(${c.id},this,event)`}">${bodyHtml}</div><div class="content-card-footer"><span class="badge ${c.type==='caption'?'badge-blue':'badge-purple'}">${c.type}</span>${c.theme?`<span class="badge badge-muted">${esc(c.theme)}</span>`:''}${c.source?`<span style="font-size:8px;color:var(--text-muted)">${esc(c.source)}</span>`:''}<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${wc}w${wc>50?' / '+Math.max(1,Math.ceil(wc/238))+'m':''}</span>${c.created?`<span style="font-size:8px;color:var(--text-muted)">${new Date(c.created).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>`:''} ${(c.tags||[]).map(t=>`<span class="badge badge-muted" style="font-size:7px">${esc(t)}</span>`).join('')}<div class="content-card-actions"><button class="btn btn-sm btn-ghost" onclick="starContent(${c.id})" style="${c.starred?'color:var(--yellow)':''}">*</button><button class="btn btn-sm btn-ghost" onclick="pinContent(${c.id})" style="${c.pinned?'color:var(--accent)':''}">${c.pinned?'Unpin':'Pin'}</button><button class="btn btn-sm btn-ghost" onclick="copyContent(${c.id})">Copy</button><button class="btn btn-sm btn-ghost" onclick="openContentModal(${c.id})">Edit</button><button class="btn btn-sm btn-ghost" onclick="dupContent(${c.id})">Dup</button><button class="btn btn-sm btn-ghost" onclick="readContent(${c.id})">Read</button><button class="btn btn-sm btn-ghost" onclick="contentToDoc(${c.id})">Doc</button><button class="btn btn-sm btn-ghost" onclick="contentToPipeline(${c.id})">Pipe</button><button class="btn btn-sm btn-ghost btn-danger" onclick="delContent(${c.id})">Del</button></div></div></div>`;};
  g.innerHTML=!items.length?`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">C</div><div style="font-size:12px">${q?'No matching content':'No content yet'}</div><div style="font-size:10px;margin-top:4px">${q?'Try a different search term':'Click + Add to paste from Apple Notes'}</div></div>`:showing.map(renderCard).join('')+(items.length>maxShow&&!contentShowAll?`<div style="grid-column:1/-1;text-align:center;padding:12px"><button class="btn btn-sm" onclick="contentShowAll=true;renderContent()">Show all ${items.length} items (${items.length-maxShow} more)</button></div>`:'');
  document.getElementById('content-count').textContent=S.content.length;
  const totalWords=S.content.reduce((sum,c)=>sum+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
  const cwEl=document.getElementById('content-word-total');if(cwEl)cwEl.textContent=totalWords.toLocaleString()+'w total';
}
function setContentType(t,el){contentType=t;document.querySelectorAll('#content-type-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderContent();}
function setContentTheme(t,el){contentTheme=t;document.querySelectorAll('#content-theme-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderContent();}
function openContentModal(id){editingContentId=id||null;document.getElementById('content-modal-title').textContent=id?'Edit Content':'Add Content';
  // Populate theme datalist
  const themes=[...new Set(S.content.map(c=>c.theme).filter(Boolean))].sort();
  let dl=document.getElementById('theme-dl');if(!dl){dl=document.createElement('datalist');dl.id='theme-dl';document.body.appendChild(dl);}
  dl.innerHTML=themes.map(t=>`<option value="${esc(t)}">`).join('');
  document.getElementById('cm-theme').setAttribute('list','theme-dl');
  if(id){const c=S.content.find(x=>x.id===id);if(c){document.getElementById('cm-type').value=c.type;document.getElementById('cm-theme').value=c.theme||'';document.getElementById('cm-body').value=c.body;document.getElementById('cm-source').value=c.source||'';document.getElementById('cm-tags').value=(c.tags||[]).join(', ');}}else{document.getElementById('cm-type').value='caption';document.getElementById('cm-theme').value='';document.getElementById('cm-body').value='';document.getElementById('cm-source').value='';document.getElementById('cm-tags').value='';}document.getElementById('content-modal').classList.add('open');setTimeout(()=>document.getElementById('cm-body').focus(),100);}
function closeContentModal(){document.getElementById('content-modal').classList.remove('open');editingContentId=null;}
function saveContent(){const type=document.getElementById('cm-type').value,theme=document.getElementById('cm-theme').value.trim().toLowerCase(),body=document.getElementById('cm-body').value.trim(),source=document.getElementById('cm-source').value.trim(),tags=(document.getElementById('cm-tags').value||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);if(!body){toast('Content cannot be empty');return;}if(editingContentId){const c=S.content.find(x=>x.id===editingContentId);if(c){c.type=type;c.theme=theme;c.body=body;c.source=source;c.tags=tags;c.updated=new Date().toISOString();}}else S.content.push({id:Date.now(),type,theme,body,source,tags,created:new Date().toISOString(),updated:new Date().toISOString()});save();closeContentModal();renderContent();toast(editingContentId?'Updated':'Added');}
let lastDeletedContent=null;
function delContent(id){const c=S.content.find(x=>x.id===id);if(c)lastDeletedContent={...c};S.content=S.content.filter(c=>c.id!==id);save();renderContent();toast('Deleted — Cmd+Z to undo');}
function undoDeleteContent(){if(!lastDeletedContent)return;S.content.unshift(lastDeletedContent);lastDeletedContent=null;save();renderContent();toast('Restored');}
function copyContent(id){const c=S.content.find(x=>x.id===id);if(c){navigator.clipboard.writeText(c.body);toast('Copied');}}
function randomContent(){if(!S.content.length){toast('No content yet');return;}const r=S.content[Math.floor(Math.random()*S.content.length)];navigator.clipboard.writeText(r.body);toast('Random: '+(r.body.substring(0,50)+'...'));document.getElementById('content-search').value='';contentType='all';contentTheme='all';contentTagFilter=null;renderContent();setTimeout(()=>{const cards=document.querySelectorAll('.content-card');const idx=S.content.indexOf(r);if(cards[idx])cards[idx].scrollIntoView({behavior:'smooth',block:'center'});},100);}
function pinContent(id){const c=S.content.find(x=>x.id===id);if(c){c.pinned=!c.pinned;save();renderContent();toast(c.pinned?'Pinned':'Unpinned');}}
function readContent(id){
  const c=S.content.find(x=>x.id===id);if(!c)return;
  const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;
  const readTime=Math.max(1,Math.ceil(wc/238));
  let existing=document.getElementById('content-reader');if(existing)existing.remove();
  const overlay=document.createElement('div');overlay.id='content-reader';
  overlay.style.cssText='position:fixed;inset:0;z-index:9999;background:var(--bg-void);display:flex;flex-direction:column;overflow-y:auto';
  overlay.innerHTML=`<div style="max-width:680px;margin:0 auto;padding:40px 24px;width:100%"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px"><div style="display:flex;gap:8px;align-items:center"><span class="badge ${c.type==='caption'?'badge-blue':'badge-purple'}">${c.type}</span>${c.theme?`<span class="badge badge-muted">${esc(c.theme)}</span>`:''}<span style="font-size:10px;color:var(--text-muted)">${wc} words / ${readTime} min read</span></div><button onclick="this.closest('#content-reader').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:8px">x close</button></div><div style="font-size:15px;line-height:2;color:var(--text);white-space:pre-wrap">${parseWikiLinks(esc(c.body))}</div>${(c.tags||[]).length?`<div style="margin-top:24px;display:flex;gap:4px;flex-wrap:wrap">${c.tags.map(t=>`<span class="badge badge-muted" style="font-size:8px">${esc(t)}</span>`).join('')}</div>`:''}<div style="margin-top:24px;display:flex;gap:8px"><button class="btn btn-sm" onclick="navigator.clipboard.writeText(${JSON.stringify(c.body).replace(/'/g,"\\'")});toast('Copied')">Copy</button><button class="btn btn-sm" onclick="this.closest('#content-reader').remove();openContentModal(${c.id})">Edit</button></div></div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('keydown',e=>{if(e.key==='Escape')overlay.remove();});
  overlay.tabIndex=0;overlay.focus();
}
function starContent(id){const c=S.content.find(x=>x.id===id);if(c){c.starred=!c.starred;save();renderContent();toast(c.starred?'Starred':'Unstarred');}}
function contentToDoc(id){const c=S.content.find(x=>x.id===id);if(!c)return;const title=(c.theme||'Untitled')+' — '+(c.body.substring(0,40).replace(/\n/g,' '));S.docs.push({id:Date.now(),title,body:c.body.replace(/\n/g,'<br>'),created:new Date().toISOString(),updated:new Date().toISOString(),versions:[]});save();toast('Created doc: '+title.substring(0,30));if(currentSection==='writer')renderWriter();}
function contentToPipeline(id){const c=S.content.find(x=>x.id===id);if(!c)return;switchSection('pipeline',null);setTimeout(()=>{const ta=document.getElementById('pl-transcript-box');if(ta){ta.style.display='block';ta.value=c.body;plTranscriptText=c.body;const wc=document.getElementById('pl-text-stats');if(wc){const words=c.body.trim().split(/\s+/).filter(x=>x.length).length;wc.textContent=words+' words, '+c.body.length+' chars';}toast('Content loaded in pipeline');}},200);}
function dupContent(id){const c=S.content.find(x=>x.id===id);if(!c)return;S.content.unshift({...c,id:Date.now(),pinned:false,created:new Date().toISOString()});save();renderContent();toast('Duplicated');}
function mergeContent(){if(contentSelected.size<2){toast('Select 2+ items to merge');return;}const items=[...contentSelected].map(id=>S.content.find(c=>c.id===id)).filter(Boolean);const merged=items.map(c=>c.body).join('\n\n---\n\n');const tags=[...new Set(items.flatMap(c=>c.tags||[]))];S.content.unshift({id:Date.now(),type:items[0].type||'caption',theme:items[0].theme||'',body:merged,tags,source:'merged',created:new Date().toISOString()});save();contentSelected.clear();contentBulkMode=false;renderContent();toast('Merged '+items.length+' items');}
function exportContent(){
  const items=S.content;
  const groups={};
  items.forEach(c=>{const g=c.theme||'Unthemed';if(!groups[g])groups[g]=[];groups[g].push(c);});
  let md='# Content Export\n';
  md+='Generated: '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n';
  md+=items.length+' items total\n\n';
  Object.keys(groups).sort().forEach(g=>{
    md+='## '+g+'\n\n';
    groups[g].forEach(c=>{
      md+='### '+c.type+(c.source?' ('+c.source+')':'')+'\n';
      md+=c.body+'\n';
      if(c.tags&&c.tags.length)md+='Tags: '+c.tags.join(', ')+'\n';
      md+='\n---\n\n';
    });
  });
  navigator.clipboard.writeText(md).then(()=>toast('Content copied as markdown')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='content-export.md';a.click();toast('Content exported');
  });
}
let contentBulkMode=false, contentSelected=new Set(), contentShowAll=false;
function toggleContentBulk(){
  contentBulkMode=!contentBulkMode;contentSelected.clear();
  document.getElementById('content-bulk-btn').style.display=contentBulkMode?'none':'';
  document.getElementById('content-bulk-actions').style.display=contentBulkMode?'flex':'none';
  renderContent();
}
function toggleContentSelect(id,el){
  if(contentSelected.has(id))contentSelected.delete(id);else contentSelected.add(id);
  el.closest('.content-card').style.outline=contentSelected.has(id)?'2px solid var(--accent)':'none';
}
function contentBulkDelete(){
  if(!contentSelected.size){toast('Select items first');return;}
  if(!confirm('Delete '+contentSelected.size+' items?'))return;
  S.content=S.content.filter(c=>!contentSelected.has(c.id));
  save();contentSelected.clear();renderContent();toast('Deleted');
}
function contentBulkTag(){
  if(!contentSelected.size){toast('Select items first');return;}
  const tag=prompt('Enter tag to add:');
  if(!tag)return;
  const t=tag.trim().toLowerCase();
  S.content.forEach(c=>{if(contentSelected.has(c.id)){if(!c.tags)c.tags=[];if(!c.tags.includes(t))c.tags.push(t);}});
  save();contentSelected.clear();renderContent();toast('Tagged');
}
function contentBulkExport(){
  if(!contentSelected.size){toast('Select items first');return;}
  const items=[...contentSelected].map(id=>S.content.find(c=>c.id===id)).filter(Boolean);
  let md='# Selected Content Export\n'+items.length+' items\n\n';
  items.forEach(c=>{md+=`## ${c.theme||c.type||'Content'}\n${c.body}\n`;if(c.tags&&c.tags.length)md+='Tags: '+c.tags.join(', ')+'\n';md+='\n---\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Exported '+items.length+' items to clipboard'));
}
function contentManageTags(){
  const allTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))].sort();
  if(!allTags.length){toast('No tags to manage');return;}
  const action=prompt('Tag Management\n\nTags: '+allTags.join(', ')+'\n\nType:\n- rename:oldtag:newtag\n- delete:tagname');
  if(!action)return;
  if(action.startsWith('rename:')){const parts=action.split(':');if(parts.length===3){const old=parts[1].trim(),nw=parts[2].trim();let count=0;S.content.forEach(c=>{if(c.tags){const i=c.tags.indexOf(old);if(i>=0){c.tags[i]=nw;count++;}}});save();renderContent();toast('Renamed "'+old+'" to "'+nw+'" in '+count+' items');}}
  else if(action.startsWith('delete:')){const tag=action.substring(7).trim();let count=0;S.content.forEach(c=>{if(c.tags){const i=c.tags.indexOf(tag);if(i>=0){c.tags.splice(i,1);count++;}}});save();renderContent();toast('Removed "'+tag+'" from '+count+' items');}
  else{toast('Use rename:old:new or delete:tagname');}
}
function contentInlineEdit(id,el,e){
  e.stopPropagation();e.preventDefault();
  const c=S.content.find(x=>x.id===id);if(!c)return;
  el.classList.add('expanded');
  const ta=document.createElement('textarea');
  ta.value=c.body;ta.style.cssText='width:100%;min-height:120px;resize:vertical;font-size:11px;line-height:1.6;padding:8px;background:var(--bg-input);color:var(--text);border:1px solid var(--accent);border-radius:4px;font-family:var(--font);outline:none';
  el.innerHTML='';el.appendChild(ta);ta.focus();
  let saved=false;
  function finishEdit(){if(saved)return;saved=true;const v=ta.value.trim();if(v&&v!==c.body){c.body=v;c.updated=new Date().toISOString();save();toast('Saved');}renderContent();}
  ta.addEventListener('blur',finishEdit);
  ta.addEventListener('keydown',ev=>{if(ev.key==='Escape'){saved=true;renderContent();}if((ev.metaKey||ev.ctrlKey)&&ev.key==='Enter')finishEdit();});
}

// === TASKS ===
function setTaskView(v){taskView=v;document.getElementById('task-view-list').classList.toggle('active',v==='list');document.getElementById('task-view-board').classList.toggle('active',v==='board');document.getElementById('task-list-view').style.display=v==='list'?'block':'none';document.getElementById('task-board-view').classList.toggle('active',v==='board');renderTasks();}
function setTaskFilter(f){taskFilter=f;taskProjectFilter=null;document.getElementById('task-filter-all').classList.toggle('active',f==='all');document.getElementById('task-filter-active').classList.toggle('active',f==='active');document.getElementById('task-filter-done').classList.toggle('active',f==='done');renderTasks();}
function filterTaskProject(p){taskProjectFilter=p;taskFilter='all';renderTasks();}
function getFilteredTasks(){const q=(document.getElementById('task-search')?.value||'').toLowerCase();let items=[...S.tasks];if(taskFilter==='active')items=items.filter(t=>t.status!=='done');if(taskFilter==='done')items=items.filter(t=>t.status==='done');if(taskProjectFilter)items=items.filter(t=>t.project===taskProjectFilter);if(q)items=items.filter(t=>(t.title+' '+t.project+' '+(t.description||'')).toLowerCase().includes(q));const sortVal=(document.getElementById('task-sort')?.value)||'manual';const pMap={p0:0,p1:1,p2:2,p3:3};if(sortVal==='priority')items.sort((a,b)=>(pMap[a.priority]||2)-(pMap[b.priority]||2));else if(sortVal==='due')items.sort((a,b)=>(a.due||'9999').localeCompare(b.due||'9999'));else if(sortVal==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));else if(sortVal==='alpha')items.sort((a,b)=>(a.title||'').localeCompare(b.title||''));return items;}

function renderTasks(){
  const items=getFilteredTasks();
  const today=new Date().toISOString().split('T')[0];
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  const rows=document.getElementById('task-rows');
  rows.innerHTML=items.map(t=>`<div class="task-row ${t.status==='done'?'completed':''} priority-${t.priority||'p2'}${t.due&&t.due<today&&t.status!=='done'?' overdue':''}" data-id="${t.id}" draggable="true" ondragstart="taskDragStart(event,${t.id})" ondragover="taskDragOver(event)" ondragleave="taskDragLeave(event)" ondrop="taskDrop(event,${t.id})">${taskBulkMode?`<div style="padding:0 4px;cursor:pointer" onclick="toggleTaskSelect(${t.id});this.querySelector('input').checked=taskSelected.has(${t.id})"><input type="checkbox" ${taskSelected.has(t.id)?'checked':''} style="pointer-events:none;cursor:pointer"></div>`:''}<div class="task-checkbox ${t.status==='done'?'checked':''}" onclick="toggleTask(${t.id})"></div><div><input type="text" class="task-title-input" value="${escA(t.title)}" onchange="updateTask(${t.id},'title',this.value)" placeholder="Task name...">${t.timeSpent||t.timeStarted?`<span style="font-size:8px;color:${t.timeStarted?'var(--green)':'var(--text-muted)'};font-family:var(--mono);margin-left:4px">${t.timeStarted?'...':formatTimeSpent(t.timeSpent)}</span>`:''}</div><div><select class="task-select" onchange="updateTask(${t.id},'status',this.value)"><option value="todo" ${t.status==='todo'?'selected':''}>To Do</option><option value="progress" ${t.status==='progress'?'selected':''}>In Progress</option><option value="done" ${t.status==='done'?'selected':''}>Done</option><option value="blocked" ${t.status==='blocked'?'selected':''}>Blocked</option></select></div><div><select class="task-select" onchange="updateTask(${t.id},'priority',this.value)"><option value="p0" ${t.priority==='p0'?'selected':''}>P0 Critical</option><option value="p1" ${t.priority==='p1'?'selected':''}>P1 High</option><option value="p2" ${t.priority==='p2'?'selected':''}>P2 Medium</option><option value="p3" ${t.priority==='p3'?'selected':''}>P3 Low</option></select></div><div><input type="text" class="task-select" style="border:1px solid transparent" value="${escA(t.project||'')}" onchange="updateTask(${t.id},'project',this.value)" placeholder="Project..." list="pdl"></div><div><input type="date" class="task-select" value="${t.due||''}" onchange="updateTask(${t.id},'due',this.value)"></div><div class="task-actions"><button class="task-action-btn" onclick="openTaskDetail(${t.id})" title="Details" style="font-size:10px">...</button><button class="task-action-btn del" onclick="deleteTask(${t.id})">x</button></div></div>`).join('')+`<div class="add-task-row" onclick="addTask()">+ Add task</div>`;

  ['todo','progress','done','blocked'].forEach(st=>{
    const col=document.getElementById('board-'+st),cnt=document.getElementById('bc-'+st),f=items.filter(t=>t.status===st);
    cnt.textContent=f.length;
    const wipLimit=st==='progress'?5:0;
    if(wipLimit&&f.length>wipLimit){cnt.style.color='var(--red)';cnt.title='WIP limit: '+wipLimit;}else{cnt.style.color='';cnt.title='';};
    col.innerHTML=f.length?f.map(t=>{const st=t.subtasks||[],stDone=st.filter(s=>s.done).length,stTotal=st.length;return `<div class="board-card" draggable="true" ondragstart="boardDragStart(event,${t.id})" onclick="openTaskDetail(${t.id})"><div class="board-card-title">${esc(t.title||'Untitled')}</div>${t.description?`<div class="board-card-desc">${esc(t.description)}</div>`:''}${stTotal?`<div class="board-card-subtasks"><span class="done">${stDone}</span>/${stTotal} subtasks<div style="width:100%;height:2px;background:var(--border);border-radius:1px;margin-top:3px"><div style="width:${Math.round(stDone/stTotal*100)}%;height:100%;background:var(--accent);border-radius:1px;transition:width 0.3s"></div></div></div>`:''}<div class="board-card-meta"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}">${t.priority||'p3'}</span>${t.project?`<span class="badge badge-blue">${esc(t.project)}</span>`:''}${t.due?`<span style="font-size:9px;color:${t.due<today&&t.status!=='done'?'var(--red)':'var(--text-muted)'};font-family:var(--mono)">${t.due}${t.due<today&&t.status!=='done'?' !':''}</span>`:''}${t.recurrence?`<span style="font-size:8px;color:var(--accent-cyan)" title="Repeats ${t.recurrence}">r</span>`:''}${t.blockedBy?`<span style="font-size:8px;color:var(--red)" title="Blocked by: ${escA(t.blockedBy)}">B</span>`:''}${t.estimate?`<span style="font-size:8px;color:var(--accent-cyan);font-family:var(--mono)" title="Estimate">${esc(t.estimate)}</span>`:''}${t.timeSpent?`<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)" title="Time tracked">${formatTimeSpent(t.timeSpent)}</span>`:''}</div></div>`;}).join(''):'<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:10px;opacity:0.5">Drop tasks here</div>';
  });
  const activeTasks=S.tasks.filter(t=>t.status!=='done').length;
  const doneTasks=S.tasks.filter(t=>t.status==='done').length;
  document.getElementById('tasks-count').textContent=activeTasks;
  document.getElementById('tasks-count').title=activeTasks+' active, '+doneTasks+' done ('+S.tasks.length+' total)';
  const acEl=document.getElementById('archived-count');if(acEl)acEl.textContent=(S.archivedTasks||[]).length||'';
  if(!document.getElementById('pdl')){const dl=document.createElement('datalist');dl.id='pdl';document.body.appendChild(dl);}
  document.getElementById('pdl').innerHTML=projects.map(p=>`<option value="${p}">`).join('');
  const tpf=document.getElementById('task-project-filter');if(tpf){tpf.innerHTML='<option value="">All Projects</option>'+projects.map(p=>`<option value="${escA(p)}" ${taskProjectFilter===p?'selected':''}>${esc(p)}</option>`).join('');}
  updateSidebarCtx();
}

function addTask(){S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p1',project:taskProjectFilter||'',due:new Date().toISOString().split('T')[0],created:new Date().toISOString()});save();renderTasks();setTimeout(()=>{const i=document.querySelector('.task-title-input');if(i)i.focus();},50);}
function addTaskFromTemplate(title,priority,recurrence){S.tasks.unshift({id:Date.now(),title,description:'',subtasks:[],status:'todo',priority:priority||'p2',project:taskProjectFilter||'',due:new Date().toISOString().split('T')[0],recurrence:recurrence||'',created:new Date().toISOString()});save();renderTasks();toast('Added: '+title);document.querySelectorAll('.btn-group div[style*="display: block"],.btn-group div[style*="display:block"]').forEach(d=>d.style.display='none');}
function updateTask(id,f,v){const t=S.tasks.find(x=>x.id===id);if(t){if(f==='status'&&v==='progress'&&!t.timeStarted)t.timeStarted=new Date().toISOString();if(f==='status'&&v!=='progress'&&t.timeStarted){t.timeSpent=(t.timeSpent||0)+Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);t.timeStarted=null;}if(f==='status'&&t.status!==v){if(!t.log)t.log=[];t.log.push({from:t.status,to:v,at:new Date().toISOString()});if(t.log.length>20)t.log=t.log.slice(-20);}t[f]=v;save();renderTasks();}}
function toggleTask(id){const t=S.tasks.find(x=>x.id===id);if(t){const wasDone=t.status==='done';t.status=wasDone?'todo':'done';if(!wasDone&&t.recurrence&&t.due){const nd=getNextRecurDate(t.due,t.recurrence);S.tasks.unshift({id:Date.now(),title:t.title,description:t.description||'',subtasks:(t.subtasks||[]).map(s=>({...s,done:false})),status:'todo',priority:t.priority,project:t.project,due:nd,recurrence:t.recurrence,created:new Date().toISOString()});t.lastRecurred=new Date().toISOString().split('T')[0];toast('Recurring task created for '+nd);}save();renderTasks();}}
function getNextRecurDate(dateStr,recur){const d=new Date(dateStr+'T12:00:00');if(recur==='daily')d.setDate(d.getDate()+1);else if(recur==='weekday'){d.setDate(d.getDate()+1);while(d.getDay()===0||d.getDay()===6)d.setDate(d.getDate()+1);}else if(recur==='weekly')d.setDate(d.getDate()+7);else if(recur==='biweekly')d.setDate(d.getDate()+14);else if(recur==='monthly')d.setMonth(d.getMonth()+1);return d.toISOString().split('T')[0];}
function parseNaturalDate(text){
  if(!text||/^\d{4}-\d{2}-\d{2}$/.test(text))return text;
  const t=text.toLowerCase().trim();const now=new Date();
  if(t==='today')return now.toISOString().split('T')[0];
  if(t==='tomorrow'||t==='tmrw'||t==='tom'){now.setDate(now.getDate()+1);return now.toISOString().split('T')[0];}
  if(t==='next week'){now.setDate(now.getDate()+7);return now.toISOString().split('T')[0];}
  if(t==='next month'){now.setMonth(now.getMonth()+1);return now.toISOString().split('T')[0];}
  const days=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const dIdx=days.findIndex(d=>t.startsWith(d.substring(0,3)));
  if(dIdx>=0){const curr=now.getDay();let diff=dIdx-curr;if(diff<=0)diff+=7;now.setDate(now.getDate()+diff);return now.toISOString().split('T')[0];}
  const match=t.match(/^(\d+)\s*(d|day|w|week|m|month)/);
  if(match){const n=parseInt(match[1]);const unit=match[2][0];if(unit==='d')now.setDate(now.getDate()+n);else if(unit==='w')now.setDate(now.getDate()+n*7);else if(unit==='m')now.setMonth(now.getMonth()+n);return now.toISOString().split('T')[0];}
  return text;
}
function deleteTask(id){S.tasks=S.tasks.filter(t=>t.id!==id);save();renderTasks();toast('Deleted');}
function archiveCompletedTasks(){
  const done=S.tasks.filter(t=>t.status==='done');
  if(!done.length){toast('No completed tasks to archive');return;}
  if(!confirm('Archive '+done.length+' completed tasks? They will be moved to a hidden archive.'))return;
  if(!S.archivedTasks)S.archivedTasks=[];
  S.archivedTasks=done.concat(S.archivedTasks);
  if(S.archivedTasks.length>500)S.archivedTasks.length=500;
  S.tasks=S.tasks.filter(t=>t.status!=='done');
  save();renderTasks();toast('Archived '+done.length+' tasks');
}
function showArchivedTasks(){
  const archived=S.archivedTasks||[];
  if(!archived.length){toast('No archived tasks');return;}
  const rows=document.getElementById('task-rows');
  document.getElementById('task-list-view').style.display='block';
  document.getElementById('task-board-view').classList.remove('active');
  rows.innerHTML='<div style="padding:8px 0;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:8px"><span>Archived Tasks ('+archived.length+')</span><button class="btn btn-sm btn-ghost" onclick="renderTasks()" style="font-size:8px;padding:1px 6px">Back to active</button></div>'+archived.slice(0,50).map(t=>`<div class="task-row completed priority-${t.priority||'p2'}" style="opacity:0.6"><div class="task-checkbox checked"></div><div><span style="font-size:12px;color:var(--text-secondary);text-decoration:line-through">${esc(t.title||'Untitled')}</span></div><div><span style="font-size:10px;color:var(--text-muted)">${t.project||''}</span></div><div><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':'muted'}" style="font-size:8px">${t.priority||'p3'}</span></div><div><span style="font-size:9px;color:var(--text-muted)">${t.due||''}</span></div><div><span style="font-size:8px;color:var(--text-muted)">${t.created?new Date(t.created).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'?'}</span></div><div class="task-actions" style="opacity:1"><button class="task-action-btn" onclick="restoreArchivedTask(${t.id})" title="Restore" style="font-size:10px;color:var(--accent)">+</button></div></div>`).join('')+(archived.length>50?'<div style="padding:8px;font-size:10px;color:var(--text-muted)">Showing first 50 of '+archived.length+'</div>':'');
}
function restoreArchivedTask(id){
  const idx=(S.archivedTasks||[]).findIndex(t=>t.id===id);
  if(idx<0)return;
  const t=S.archivedTasks.splice(idx,1)[0];
  t.status='todo';
  S.tasks.unshift(t);
  save();renderTasks();toast('Restored: '+(t.title||'task'));
}

let taskBulkMode=false,taskSelected=new Set();
function toggleTaskBulk(){taskBulkMode=!taskBulkMode;taskSelected.clear();document.getElementById('task-bulk-btn').style.display=taskBulkMode?'none':'';document.getElementById('task-bulk-actions').style.display=taskBulkMode?'flex':'none';renderTasks();}
function toggleTaskSelect(id){if(taskSelected.has(id))taskSelected.delete(id);else taskSelected.add(id);}
function taskBulkApply(){
  const status=document.getElementById('task-bulk-status').value;
  const priority=document.getElementById('task-bulk-priority').value;
  if(!status&&!priority){toast('Select a status or priority to apply');return;}
  let count=0;
  taskSelected.forEach(id=>{const t=S.tasks.find(x=>x.id===id);if(t){if(status)t.status=status;if(priority)t.priority=priority;count++;}});
  save();taskSelected.clear();taskBulkMode=false;document.getElementById('task-bulk-btn').style.display='';document.getElementById('task-bulk-actions').style.display='none';renderTasks();toast('Updated '+count+' tasks');
}
function taskBulkDelete(){
  if(!taskSelected.size){toast('No tasks selected');return;}
  if(!confirm('Delete '+taskSelected.size+' tasks?'))return;
  S.tasks=S.tasks.filter(t=>!taskSelected.has(t.id));save();taskSelected.clear();taskBulkMode=false;document.getElementById('task-bulk-btn').style.display='';document.getElementById('task-bulk-actions').style.display='none';renderTasks();toast('Deleted');
}
function exportTasks(){
  const items=getFilteredTasks();
  const today=new Date().toISOString().split('T')[0];
  let md='# Tasks Export\n';
  md+='Generated: '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n\n';
  const groups={};
  items.forEach(t=>{const g=t.project||'No Project';if(!groups[g])groups[g]=[];groups[g].push(t);});
  Object.keys(groups).sort().forEach(g=>{
    md+='## '+g+'\n';
    groups[g].forEach(t=>{
      const check=t.status==='done'?'x':' ';
      md+='- ['+check+'] '+t.title+(t.priority==='p0'?' [CRITICAL]':t.priority==='p1'?' [HIGH]':'')+(t.due?' (due '+t.due+')':'')+(t.due&&t.due<today&&t.status!=='done'?' OVERDUE':'')+'\n';
      if(t.description)md+='  '+t.description.substring(0,100)+'\n';
      (t.subtasks||[]).forEach(s=>{md+='  - ['+(s.done?'x':' ')+'] '+s.title+'\n';});
    });
    md+='\n';
  });
  navigator.clipboard.writeText(md).then(()=>toast('Tasks copied as markdown')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tasks-'+today+'.md';a.click();toast('Tasks exported');
  });
}

// Task drag reorder
let taskDragId=null;
function taskDragStart(e,id){taskDragId=id;e.dataTransfer.effectAllowed='move';}
function taskDragOver(e){e.preventDefault();e.currentTarget.classList.add('dragging-over');}
function taskDragLeave(e){e.currentTarget.classList.remove('dragging-over');}
function taskDrop(e,targetId){e.preventDefault();e.currentTarget.classList.remove('dragging-over');if(!taskDragId||taskDragId===targetId)return;const fi=S.tasks.findIndex(t=>t.id===taskDragId),ti=S.tasks.findIndex(t=>t.id===targetId);if(fi<0||ti<0)return;const[item]=S.tasks.splice(fi,1);S.tasks.splice(ti,0,item);taskDragId=null;save();renderTasks();}

// Board drag
let boardDragId=null;
function boardDragStart(e,id){boardDragId=id;e.dataTransfer.effectAllowed='move';}
function boardDrop(e,status){e.preventDefault();if(boardDragId){const t=S.tasks.find(x=>x.id===boardDragId);if(t){t.status=status;save();renderTasks();}boardDragId=null;}}
function boardMoveAll(fromStatus){
  const targets=['todo','progress','done','blocked'].filter(s=>s!==fromStatus);
  const to=prompt('Move all "'+fromStatus+'" tasks to:\n'+targets.join(', '));
  if(!to||!targets.includes(to))return;
  const items=getFilteredTasks().filter(t=>t.status===fromStatus);
  if(!items.length){toast('No tasks to move');return;}
  items.forEach(t=>{if(!t.log)t.log=[];t.log.push({from:t.status,to,at:new Date().toISOString()});t.status=to;});
  save();renderTasks();toast('Moved '+items.length+' tasks to '+to);
}

// Task Detail Modal
let taskDetailId = null;
function openTaskDetail(id) {
  const t = S.tasks.find(x=>x.id===id);
  if(!t) return;
  taskDetailId = id;
  document.getElementById('td-title').value = t.title || '';
  document.getElementById('td-desc').value = t.description || '';
  document.getElementById('td-status').value = t.status || 'todo';
  document.getElementById('td-priority').value = t.priority || 'p2';
  document.getElementById('td-project').value = t.project || '';
  document.getElementById('td-due').value = t.due || '';
  document.getElementById('td-recur').value = t.recurrence || '';
  document.getElementById('td-blocked-by').value = t.blockedBy || '';
  document.getElementById('td-estimate').value = t.estimate || '';
  document.getElementById('td-recur-info').textContent = t.recurrence ? 'Repeats ' + t.recurrence + (t.lastRecurred ? ' (last: ' + t.lastRecurred + ')' : '') : '';
  let timeText=t.created ? 'Created: ' + new Date(t.created).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
  if(t.timeSpent)timeText+=' | Time: '+formatTimeSpent(t.timeSpent);
  if(t.timeStarted)timeText+=' | Started: '+timeAgo(t.timeStarted);
  document.getElementById('td-created').textContent = timeText;
  const logEl=document.getElementById('td-log');
  if(logEl&&t.log&&t.log.length){logEl.innerHTML='<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Activity</div>'+t.log.slice(-5).reverse().map(e=>`<div style="font-size:8px;color:var(--text-muted);padding:1px 0;font-family:var(--mono)">${e.from} -> ${e.to} <span style="opacity:0.5">${timeAgo(e.at)}</span></div>`).join('');}else if(logEl){logEl.innerHTML='';}
  renderSubtasksInModal(t.subtasks || []);
  updateTimerBtn(t);
  document.getElementById('task-detail-modal').classList.add('open');
  setTimeout(()=>document.getElementById('td-title').focus(),100);
}
function formatTimeSpent(mins){if(mins<60)return mins+'m';const h=Math.floor(mins/60);const m=mins%60;return h+'h'+(m?' '+m+'m':'');}
function tdSetDue(days){const d=new Date();d.setDate(d.getDate()+days);document.getElementById('td-due').value=d.toISOString().split('T')[0];}
function closeTaskDetail() {
  document.getElementById('task-detail-modal').classList.remove('open');
  taskDetailId = null;
}
function renderSubtasksInModal(subtasks) {
  const el = document.getElementById('td-subtasks');
  el.innerHTML = (subtasks||[]).map((st,i) => `<div class="td-subtask">
    <input type="checkbox" ${st.done?'checked':''} onchange="toggleSubtaskInModal(${i},this.checked)">
    <input type="text" value="${escA(st.title)}" onchange="renameSubtaskInModal(${i},this.value)" placeholder="Subtask...">
    <span class="del" onclick="removeSubtaskInModal(${i})">x</span>
  </div>`).join('');
}
function addSubtaskInModal() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  if(!t.subtasks) t.subtasks = [];
  t.subtasks.push({id:Date.now(), title:'', done:false});
  renderSubtasksInModal(t.subtasks);
  const inputs = document.querySelectorAll('#td-subtasks input[type=text]');
  if(inputs.length) inputs[inputs.length-1].focus();
}
function toggleSubtaskInModal(i,done) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks && t.subtasks[i]) t.subtasks[i].done = done;
}
function renameSubtaskInModal(i,val) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks && t.subtasks[i]) t.subtasks[i].title = val;
}
function removeSubtaskInModal(i) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks) { t.subtasks.splice(i,1); renderSubtasksInModal(t.subtasks); }
}
function saveTaskDetail() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  t.title = document.getElementById('td-title').value.trim();
  t.description = document.getElementById('td-desc').value.trim();
  t.status = document.getElementById('td-status').value;
  t.priority = document.getElementById('td-priority').value;
  t.project = document.getElementById('td-project').value.trim();
  t.due = document.getElementById('td-due').value;
  t.recurrence = document.getElementById('td-recur').value || '';
  t.blockedBy = document.getElementById('td-blocked-by').value.trim() || '';
  t.estimate = document.getElementById('td-estimate').value.trim() || '';
  // Link to project ID if name matches
  if(t.project) { const p = (S.projects||[]).find(pr => pr.name === t.project); if(p) t.projectId = p.id; }
  save(); closeTaskDetail(); renderTasks();
  if(activeProject) renderProjTasks();
  toast('Task saved');
}
function deleteTaskFromDetail() {
  if(!taskDetailId) return;
  if(!confirm('Delete this task?')) return;
  S.tasks = S.tasks.filter(t=>t.id!==taskDetailId);
  save(); closeTaskDetail(); renderTasks();
  if(activeProject) renderProjTasks();
  toast('Task deleted');
}
function duplicateTask() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  const dup = {...t, id:Date.now(), title:(t.title||'')+ ' (copy)', subtasks:(t.subtasks||[]).map(s=>({...s,id:Date.now()+Math.random()*1000,done:false})), status:'todo', created:new Date().toISOString()};
  S.tasks.unshift(dup);
  save(); closeTaskDetail(); renderTasks();
  toast('Task duplicated');
}
function taskToContent(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  let body=t.title||'Untitled Task';
  if(t.description)body+='\n\n'+t.description;
  if(t.subtasks&&t.subtasks.length)body+='\n\nSubtasks:\n'+t.subtasks.map(s=>(s.done?'[x] ':'[ ] ')+s.title).join('\n');
  S.content.unshift({id:Date.now(),body,type:'caption',theme:t.project||'tasks',tags:['from-task',t.priority||'p2'].filter(Boolean),source:'task-convert',created:new Date().toISOString()});
  save();closeTaskDetail();if(currentSection==='content')renderContent();toast('Saved to Content');
}
function toggleTaskTimer(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  if(t.timeStarted){
    t.timeSpent=(t.timeSpent||0)+Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);
    t.timeStarted=null;
    save();toast('Timer stopped — '+formatTimeSpent(t.timeSpent)+' total');
  }else{
    t.timeStarted=new Date().toISOString();
    if(t.status==='todo'){t.status='progress';if(!t.log)t.log=[];t.log.push({from:'todo',to:'progress',at:t.timeStarted});}
    save();toast('Timer started');
  }
  updateTimerBtn(t);
}
function updateTimerBtn(t){
  const btn=document.getElementById('td-timer-btn');if(!btn)return;
  if(t.timeStarted){btn.textContent='Stop Timer';btn.style.color='var(--red)';btn.title='Stop time tracking (running since '+timeAgo(t.timeStarted)+')';}
  else{btn.textContent='Start Timer';btn.style.color='';btn.title='Start time tracking'+(t.timeSpent?' ('+formatTimeSpent(t.timeSpent)+' logged)':'');}
}

// === CALENDAR ===
function setCalView(v) {
  calView = v;
  document.getElementById('cal-view-month').classList.toggle('active', v==='month');
  document.getElementById('cal-view-week').classList.toggle('active', v==='week');
  document.getElementById('cal-grid').style.display = v==='month' ? 'grid' : 'none';
  document.getElementById('cal-week-grid').style.display = v==='week' ? 'grid' : 'none';
  if(v==='week' && !calWeekStart) {
    const now = new Date();
    const day = now.getDay();
    const diff = day === 0 ? -6 : 1 - day; // Monday start
    calWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
  }
  renderCalendar();
}
function renderCalTodaySummary(){
  const el=document.getElementById('cal-today-summary');
  const today=new Date().toISOString().split('T')[0];
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  if(!todayTasks.length&&!overdue.length){el.style.display='none';return;}
  el.style.display='block';
  let h='';
  if(overdue.length)h+=`<span style="color:var(--red)">${overdue.length} overdue</span> `;
  if(todayTasks.length)h+=`<span style="color:var(--accent)">${todayTasks.length} today:</span> `;
  h+=todayTasks.slice(0,5).map(t=>`<span style="cursor:pointer;text-decoration:underline dotted;margin:0 4px" onclick="openTaskDetail(${t.id})">${esc(t.title||'Untitled')}</span>`).join(' ');
  if(todayTasks.length>5)h+=` <span style="color:var(--text-muted)">+${todayTasks.length-5} more</span>`;
  el.innerHTML=h;
}
function renderCalUpcoming(){
  const el=document.getElementById('cal-upcoming');if(!el)return;
  const today=new Date().toISOString().split('T')[0];
  const upcoming=S.tasks.filter(t=>t.due&&t.due>=today&&t.status!=='done').sort((a,b)=>a.due.localeCompare(b.due)).slice(0,8);
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done').sort((a,b)=>a.due.localeCompare(b.due));
  if(!upcoming.length&&!overdue.length){el.innerHTML='';return;}
  let h='<div style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:6px">Upcoming</div>';
  const renderRow=(t,isOverdue)=>{const daysLabel=t.due===today?'Today':isOverdue?'Overdue':'';return`<div style="display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:10px" onclick="openTaskDetail(${t.id})" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}" style="font-size:7px;padding:1px 3px;min-width:16px;text-align:center">${t.priority||'p3'}</span><span style="flex:1;color:${isOverdue?'var(--red)':'var(--text-secondary)'}">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${isOverdue?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'};font-family:var(--mono)">${isOverdue?t.due+' !':t.due===today?'today':t.due.substring(5)}</span></div>`;};
  if(overdue.length){h+='<div style="font-size:8px;color:var(--red);margin:4px 0 2px;font-weight:600">OVERDUE</div>';overdue.slice(0,5).forEach(t=>{h+=renderRow(t,true);});}
  upcoming.forEach(t=>{h+=renderRow(t,false);});
  el.innerHTML=h;
}
function renderCalendar(){
  renderCalTodaySummary();renderCalUpcoming();
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  if(calView === 'week') {
    renderWeekView();
    return;
  }
  const monthTaskCount=S.tasks.filter(t=>{if(!t.due)return false;const d=new Date(t.due+'T12:00:00');return d.getMonth()===calMonth&&d.getFullYear()===calYear;}).length;
  document.getElementById('cal-month-label').innerHTML=months[calMonth]+' '+calYear+(monthTaskCount?` <span style="font-size:9px;color:var(--accent);font-family:var(--mono)">${monthTaskCount} tasks</span>`:'');
  const first=new Date(calYear,calMonth,1).getDay();
  const days=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date().toISOString().split('T')[0];
  const prev=new Date(calYear,calMonth,0).getDate();
  let h='';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div class="calendar-day-header">${d}</div>`;});
  for(let i=first-1;i>=0;i--)h+=`<div class="calendar-day other"><div class="calendar-day-num">${prev-i}</div></div>`;
  for(let d=1;d<=days;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=ds===today;
    const dt=S.tasks.filter(t=>t.due===ds);
    h+=`<div class="calendar-day ${isToday?'today':''}" onclick="calClickDay('${ds}')" ondragover="event.preventDefault()" ondrop="calDrop(event,'${ds}')"><div class="calendar-day-num">${d}${dt.length?`<span style="font-size:7px;color:var(--accent);font-family:var(--mono);margin-left:3px">${dt.length}</span>`:''}</div>${dt.slice(0,4).map(t=>`<div class="calendar-task-pill pill-${t.priority||'p2'}" draggable="true" ondragstart="calDragStart(event,${t.id})" onclick="event.stopPropagation();openTaskDetail(${t.id})" title="${escA(t.title)}">${esc(t.title||'...')}</div>`).join('')}${dt.length>4?`<div style="font-size:8px;color:var(--text-muted)">+${dt.length-4} more</div>`:''}</div>`;
  }
  const rem=42-(first+days);
  for(let d=1;d<=rem;d++)h+=`<div class="calendar-day other"><div class="calendar-day-num">${d}</div></div>`;
  document.getElementById('cal-grid').innerHTML=h;
}
function renderWeekView() {
  if(!calWeekStart) return;
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const ws = new Date(calWeekStart);
  const we = new Date(ws); we.setDate(we.getDate()+6);
  const label = ws.getMonth()===we.getMonth() ? months[ws.getMonth()]+' '+ws.getFullYear() : months[ws.getMonth()].substring(0,3)+' - '+months[we.getMonth()]+' '+we.getFullYear();
  document.getElementById('cal-month-label').textContent=label;
  const today=new Date().toISOString().split('T')[0];
  const dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  let h='';
  for(let i=0;i<7;i++){
    const d=new Date(ws); d.setDate(d.getDate()+i);
    const ds=d.toISOString().split('T')[0];
    const isToday=ds===today;
    const dt=S.tasks.filter(t=>t.due===ds);
    h+=`<div class="week-day ${isToday?'today':''}" ondragover="event.preventDefault()" ondrop="calDrop(event,'${ds}')">
      <div class="week-day-header">${dayNames[i]}<span class="day-num">${d.getDate()}</span>${dt.length?`<span style="font-size:8px;color:var(--accent);font-family:var(--mono);margin-left:4px;opacity:0.7">${dt.length}</span>`:''}</div>
      ${dt.map(t=>`<div class="week-task-card" draggable="true" ondragstart="calDragStart(event,${t.id})" onclick="openTaskDetail(${t.id})">
        <div class="wt-title">${esc(t.title||'Untitled')}</div>
        <div class="wt-meta"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}" style="font-size:8px;padding:1px 4px">${t.priority||'p3'}</span>${t.project?`<span style="font-size:8px;color:var(--text-muted)">${esc(t.project)}</span>`:''}${t.estimate?`<span style="font-size:8px;color:var(--accent-cyan);font-family:var(--mono)">${esc(t.estimate)}</span>`:''}</div>
      </div>`).join('')}
      <div class="week-add" onclick="calClickDay('${ds}')">+ task</div>
    </div>`;
  }
  document.getElementById('cal-week-grid').innerHTML=h;
}
function calNav(dir){
  if(calView==='week'){
    calWeekStart.setDate(calWeekStart.getDate()+(dir*7));
    renderCalendar(); return;
  }
  calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}if(calMonth<0){calMonth=11;calYear--;}renderCalendar();
}
function calToday(){
  calMonth=new Date().getMonth();calYear=new Date().getFullYear();
  const now=new Date(),day=now.getDay(),diff=day===0?-6:1-day;
  calWeekStart=new Date(now.getFullYear(),now.getMonth(),now.getDate()+diff);
  renderCalendar();
}
function calClickDay(dateStr){
  const dt=S.tasks.filter(t=>t.due===dateStr);
  if(dt.length>0){calDayPopup(dateStr,dt);return;}
  S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString()});
  save();renderCalendar();renderTasks();
  toast('New task on '+dateStr);
}
function calDayPopup(dateStr,tasks){
  let existing=document.getElementById('cal-day-popup');if(existing)existing.remove();
  const d=new Date(dateStr+'T12:00:00');
  const label=d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const popup=document.createElement('div');popup.id='cal-day-popup';
  popup.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px;z-index:9999;max-width:350px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.5)';
  popup.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:13px;font-weight:600;color:var(--text-primary)">${label}</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">x</button></div><div style="display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto">${tasks.map(t=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-secondary);border-radius:4px;cursor:pointer;border-left:3px solid var(${t.priority==='p0'?'--red':t.priority==='p1'?'--orange':'--accent'})" onclick="this.parentElement.parentElement.remove();openTaskDetail(${t.id})"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted)">${t.status} | ${t.priority||'p2'}${t.project?' | '+esc(t.project):''}</div></div></div>`).join('')}</div><button onclick="this.parentElement.remove();calAddTaskOnDay('${dateStr}')" class="btn btn-primary btn-sm" style="width:100%;margin-top:10px">+ Add task on this day</button>`;
  document.body.appendChild(popup);
  popup.addEventListener('click',e=>{if(e.target===popup)popup.remove();});
}
function calAddTaskOnDay(dateStr){
  S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString()});
  save();renderCalendar();renderTasks();toast('New task on '+dateStr);
}
function calDragStart(e,id){calDragId=id;e.dataTransfer.effectAllowed='move';}
function calDrop(e,dateStr){e.preventDefault();if(calDragId){const t=S.tasks.find(x=>x.id===calDragId);if(t){t.due=dateStr;save();renderCalendar();renderTasks();toast('Moved to '+dateStr);}calDragId=null;}}
function exportICS(){let ics='BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//SaturnoHub//EN\n';S.tasks.filter(t=>t.due).forEach(t=>{const d=t.due.replace(/-/g,'');ics+=`BEGIN:VEVENT\nDTSTART;VALUE=DATE:${d}\nSUMMARY:${t.title||'Task'}\nDESCRIPTION:Priority: ${t.priority||'p2'} | Status: ${t.status||'todo'}${t.project?' | Project: '+t.project:''}\nEND:VEVENT\n`;});ics+='END:VCALENDAR';const blob=new Blob([ics],{type:'text/calendar'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-tasks.ics';a.click();toast('ICS exported - import into Google Calendar');}
function importICS(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.ics,.ical';
  inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{
    const text=ev.target.result;const events=text.split('BEGIN:VEVENT').slice(1);
    if(!events.length){toast('No events found in ICS file');return;}
    let count=0;
    events.forEach(block=>{
      const sum=(block.match(/SUMMARY[;:]([^\r\n]+)/)||[])[1]||'';
      const desc=(block.match(/DESCRIPTION[;:]([^\r\n]+)/)||[])[1]||'';
      let dateStr='';
      const dtMatch=block.match(/DTSTART[^:]*:(\d{4})(\d{2})(\d{2})/);
      if(dtMatch)dateStr=dtMatch[1]+'-'+dtMatch[2]+'-'+dtMatch[3];
      if(!sum.trim())return;
      const title=sum.replace(/\\,/g,',').replace(/\\n/g,' ').trim();
      const existing=S.tasks.find(t=>t.title===title&&t.due===dateStr);
      if(existing)return;
      S.tasks.unshift({id:Date.now()+count,title,description:desc.replace(/\\n/g,'\n').replace(/\\,/g,',').substring(0,500),subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString(),source:'ics-import'});
      count++;
    });
    save();renderCalendar();renderTasks();toast('Imported '+count+' events from ICS');
  };r.readAsText(f);};inp.click();
}

function exportWeek(){
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());weekStart.setHours(0,0,0,0);
  const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  let md='# Week of '+weekStart.toLocaleDateString('en-US',{month:'long',day:'numeric'})+' - '+weekEnd.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'\n\n';
  for(let i=0;i<7;i++){
    const d=new Date(weekStart);d.setDate(d.getDate()+i);
    const ds=d.toISOString().split('T')[0];
    const tasks=S.tasks.filter(t=>t.due===ds);
    if(tasks.length){md+='## '+days[d.getDay()]+' ('+ds+')\n';tasks.forEach(t=>{md+='- ['+t.status+'] '+t.title+(t.priority?' ('+t.priority+')':'')+(t.project?' ['+t.project+']':'')+'\n';});md+='\n';}
  }
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString()));
  if(doneThisWeek.length){md+='## Completed This Week\n';doneThisWeek.forEach(t=>{md+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});md+='\n';}
  navigator.clipboard.writeText(md).then(()=>toast('Week summary copied to clipboard'));
}

// === WRITING HUB ===
function getActiveDoc(){return S.docs.find(d=>d.id===S.activeDoc);}
function renderWriter(){renderDocList();loadDoc();document.getElementById('writer-count').textContent=S.docs.length;}
function renderDocList(){const sorted=[...S.docs].sort((a,b)=>(new Date(b.updated||0))-(new Date(a.updated||0)));document.getElementById('writer-doc-list').innerHTML=sorted.map(d=>{const w=countW(d.body);const dt=d.updated?new Date(d.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';return`<div class="writer-doc-item ${d.id===S.activeDoc?'active':''}" onclick="switchDoc(${d.id})"><div class="writer-doc-title">${esc(d.title||'Untitled')}</div><div class="writer-doc-meta"><span>${w}w</span><span>${dt}</span><span style="margin-left:auto;cursor:pointer;opacity:0.4;font-size:8px" onclick="event.stopPropagation();dupDoc(${d.id})" title="Duplicate">D</span>${S.docs.length>1?`<span style="cursor:pointer;opacity:0.4" onclick="event.stopPropagation();delDoc(${d.id})">x</span>`:''}</div></div>`;}).join('');}
function loadDoc(){const d=getActiveDoc();if(!d)return;document.getElementById('writer-title').value=d.title||'';document.getElementById('writer-editor').innerHTML=d.body||'';updateWS();renderVersions();}
function switchDoc(id){if(S.activeDoc===id)return;snapshotWriter();save();S.activeDoc=id;renderWriter();const d=S.docs.find(x=>x.id===id);if(d)trackRecent('doc',id,d.title);save();updateBreadcrumb();}
function newDoc(){snapshotWriter();const d={id:Date.now(),title:'',body:'',versions:[],created:new Date().toISOString(),updated:new Date().toISOString()};S.docs.unshift(d);S.activeDoc=d.id;save();renderWriter();document.getElementById('writer-title').focus();}
function delDoc(id){if(S.docs.length<=1){toast('Cannot delete last doc');return;}S.docs=S.docs.filter(d=>d.id!==id);if(S.activeDoc===id)S.activeDoc=S.docs[0].id;save();renderWriter();toast('Deleted');}
function dupDoc(id){const d=S.docs.find(x=>x.id===id);if(!d)return;snapshotWriter();const dup={...d,id:Date.now(),title:(d.title||'Untitled')+' (copy)',created:new Date().toISOString(),updated:new Date().toISOString(),versions:[]};S.docs.unshift(dup);S.activeDoc=dup.id;save();renderWriter();toast('Duplicated');}
function snapshotWriter(){const d=getActiveDoc();if(!d)return;const t=document.getElementById('writer-title'),e=document.getElementById('writer-editor');if(!t||!e)return;d.title=t.value;d.body=e.innerHTML;d.updated=new Date().toISOString();}
function onWriterChange(){clearTimeout(writerTimer);document.getElementById('ws-saved').textContent='Unsaved';document.getElementById('ws-saved').style.color='var(--yellow)';writerTimer=setTimeout(()=>{snapshotWriter();save();renderDocList();document.getElementById('ws-saved').textContent='Saved';document.getElementById('ws-saved').style.color='var(--green)';},800);updateWS();}
function updateWS(){const e=document.getElementById('writer-editor'),t=e.innerText||'',w=t.trim().split(/\s+/).filter(x=>x.length).length;document.getElementById('ws-words').textContent=w+' words';document.getElementById('ws-chars').textContent=t.length+' chars';document.getElementById('ws-reading').textContent=Math.max(1,Math.ceil(w/238))+' min read';
  const d=getActiveDoc();const goal=d&&d.wordGoal?d.wordGoal:0;const goalEl=document.getElementById('ws-goal');
  if(goal>0){const pct=Math.min(100,Math.round(w/goal*100));goalEl.textContent=pct+'% of '+goal+'w goal';goalEl.style.color=pct>=100?'var(--green)':'var(--accent-cyan)';}else{goalEl.textContent='Set goal';goalEl.style.color='var(--text-muted)';}}
function setWriterGoal(){const d=getActiveDoc();if(!d)return;const g=prompt('Word count goal:',d.wordGoal||'');if(g===null)return;d.wordGoal=parseInt(g)||0;save();updateWS();}
function countW(html){const d=document.createElement('div');d.innerHTML=html||'';return(d.innerText||'').trim().split(/\s+/).filter(x=>x.length).length;}
function execCmd(c){document.execCommand(c,false,null);document.getElementById('writer-editor').focus();}
function execBlock(tag){document.execCommand('formatBlock',false,'<'+tag+'>');document.getElementById('writer-editor').focus();}
function insertLink(){const u=prompt('URL:');if(u)document.execCommand('createLink',false,u);document.getElementById('writer-editor').focus();}
function insertHR(){document.execCommand('insertHTML',false,'<hr>');document.getElementById('writer-editor').focus();}
function insertCodeInline(){const s=window.getSelection();if(s.rangeCount)document.execCommand('insertHTML',false,'<code>'+(esc(s.toString())||'code')+'</code>');}
function clearFormatting(){document.execCommand('removeFormat',false,null);document.getElementById('writer-editor').focus();}
function writerKeydown(e){if(e.key==='Tab'){e.preventDefault();document.execCommand('insertHTML',false,'&nbsp;&nbsp;&nbsp;&nbsp;');}if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveVersion();}if((e.ctrlKey||e.metaKey)&&(e.key==='h'||e.key==='f')&&currentSection==='writer'){e.preventDefault();writerFindOpen();}}
function writerTOC(){
  const editor=document.getElementById('writer-editor');if(!editor)return;
  const headings=editor.querySelectorAll('h1,h2,h3');
  if(!headings.length){toast('No headings found');return;}
  let toc='<div style="border:1px solid var(--border);border-radius:6px;padding:12px 16px;margin:8px 0;background:var(--bg-secondary)"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">Table of Contents</div>';
  headings.forEach(h=>{
    const level=parseInt(h.tagName[1]);const indent=(level-1)*16;
    toc+=`<div style="padding:2px 0 2px ${indent}px;font-size:${level===1?'12':'11'}px;color:var(--text-${level===1?'primary':'secondary'})">${h.textContent}</div>`;
  });
  toc+='</div>';
  const range=document.createRange();range.selectNodeContents(editor);range.collapse(true);
  const frag=range.createContextualFragment(toc);
  editor.insertBefore(frag,editor.firstChild);
  onWriterChange();toast('TOC inserted at top');
}
function writerFindOpen(){const bar=document.getElementById('writer-find-bar');bar.style.display='flex';document.getElementById('writer-find-input').focus();const sel=window.getSelection();if(sel.toString())document.getElementById('writer-find-input').value=sel.toString();}
function writerFindClose(){document.getElementById('writer-find-bar').style.display='none';document.getElementById('writer-find-count').textContent='';window.getSelection().removeAllRanges();}
function writerFindNext(){const q=document.getElementById('writer-find-input').value;if(!q){document.getElementById('writer-find-count').textContent='';return;}const ed=document.getElementById('writer-editor');const text=ed.innerText;const matches=text.match(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'));document.getElementById('writer-find-count').textContent=matches?matches.length+' found':'0 found';if(window.find)window.find(q,false,false,true);}
function writerReplace(){const q=document.getElementById('writer-find-input').value;const r=document.getElementById('writer-replace-input').value;if(!q)return;const sel=window.getSelection();if(sel.toString().toLowerCase()===q.toLowerCase()){document.execCommand('insertText',false,r);writerFindNext();}}
function writerReplaceAll(){const q=document.getElementById('writer-find-input').value;const r=document.getElementById('writer-replace-input').value;if(!q)return;const ed=document.getElementById('writer-editor');const re=new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');const count=(ed.innerText.match(re)||[]).length;snapshotWriter();const d=getActiveDoc();if(d){const tmp=document.createElement('div');tmp.innerHTML=d.body;const walk=n=>{if(n.nodeType===3){const parts=n.textContent.split(re);if(parts.length>1){n.textContent=n.textContent.replace(re,r);}}else{n.childNodes.forEach(walk);}};walk(tmp);d.body=tmp.innerHTML;save();loadDoc();}toast('Replaced '+count+' occurrences');writerFindClose();}
function saveVersion(){snapshotWriter();const d=getActiveDoc();if(!d)return;if(!d.versions)d.versions=[];d.versions.unshift({id:Date.now(),title:d.title,body:d.body,words:countW(d.body),date:new Date().toISOString()});if(d.versions.length>50)d.versions=d.versions.slice(0,50);save();renderVersions();toast('Version saved');}
function renderVersions(){const d=getActiveDoc(),el=document.getElementById('writer-versions');if(!d||!d.versions||!d.versions.length){el.innerHTML='<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:20px">No versions. Ctrl+S to save.</div>';return;}el.innerHTML=d.versions.map((v,i)=>{const dt=new Date(v.date);return`<div class="writer-version-item" onclick="restoreVersion(${i})"><div class="writer-version-title">${esc(v.title||'Untitled')}</div><div class="writer-version-meta">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${dt.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})} - ${v.words||0}w</div></div>`;}).join('');}
function restoreVersion(i){const d=getActiveDoc();if(!d||!d.versions[i])return;const v=d.versions[i];d.title=v.title;d.body=v.body;d.updated=new Date().toISOString();save();loadDoc();toast('Restored');}
function toggleWriterPanel(){writerPanelOpen=!writerPanelOpen;document.getElementById('writer-right-panel').classList.toggle('hidden',!writerPanelOpen);}
function writerExport(fmt){const d=getActiveDoc();if(!d||!fmt)return;const t=d.title||'untitled',e=document.getElementById('writer-editor');if(fmt==='clipboard'){navigator.clipboard.writeText(e.innerText);toast('Copied');return;}let c,m,x;if(fmt==='txt'){c=e.innerText;m='text/plain';x='txt';}else if(fmt==='html'){c=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(t)}</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#222}h1{font-size:28px}h2{font-size:22px}blockquote{border-left:3px solid #ccc;padding-left:16px;color:#666;font-style:italic}code{background:#f4f4f4;padding:1px 4px;border-radius:3px}pre{background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto}</style></head><body><h1>${esc(t)}</h1>${e.innerHTML}</body></html>`;m='text/html';x='html';}else if(fmt==='md'){c=htmlToMd(e.innerHTML,t);m='text/markdown';x='md';}const blob=new Blob([c],{type:m});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=t.replace(/[^a-z0-9]/gi,'-').toLowerCase()+'.'+x;a.click();toast('Exported .'+x);}
function writerToContent(){const d=getActiveDoc();if(!d)return;snapshotWriter();const ed=document.getElementById('writer-editor');const text=ed.innerText||'';if(!text.trim()){toast('Document is empty');return;}S.content.unshift({id:Date.now(),type:'caption',theme:d.title||'writer',body:text,tags:['from-writer'],source:'writer-export',created:new Date().toISOString()});save();toast('Saved to Content: '+(d.title||'Untitled').substring(0,30));}
function htmlToMd(html,title){let md='# '+(title||'Untitled')+'\n\n';const tmp=document.createElement('div');tmp.innerHTML=html;const walk=n=>{if(n.nodeType===3)return n.textContent;if(n.nodeType!==1)return'';const tag=n.tagName.toLowerCase(),ch=Array.from(n.childNodes).map(walk).join('');switch(tag){case'h1':return'\n# '+ch+'\n\n';case'h2':return'\n## '+ch+'\n\n';case'h3':return'\n### '+ch+'\n\n';case'p':return ch+'\n\n';case'br':return'\n';case'strong':case'b':return'**'+ch+'**';case'em':case'i':return'*'+ch+'*';case'code':return'`'+ch+'`';case'pre':return'\n```\n'+ch+'\n```\n\n';case'blockquote':return'\n> '+ch.replace(/\n/g,'\n> ')+'\n\n';case'ul':return'\n'+ch+'\n';case'ol':return'\n'+ch+'\n';case'li':return'- '+ch+'\n';case'a':return'['+ch+']('+n.href+')';case'hr':return'\n---\n\n';case'div':return ch+'\n';default:return ch;}};md+=Array.from(tmp.childNodes).map(walk).join('');return md.replace(/\n{3,}/g,'\n\n').trim()+'\n';}

// === ZEN WRITER (full-screen distraction-free) ===
let zenDocId = null;
let zenTimer = null;
let zenIsOpen = false;

function zenOpen(docId) {
  zenIsOpen = true;
  const zw = document.getElementById('zen-writer');
  // Snapshot current writer state if in writer section
  if(currentSection === 'writer') snapshotWriter();
  // Pick doc
  if(docId) { zenDocId = docId; }
  else if(!zenDocId) { zenDocId = S.activeDoc || (S.docs[0] && S.docs[0].id); }
  zenRenderPicker();
  zenLoadDoc();
  zw.classList.add('open');
  document.getElementById('zen-fab').style.display = 'none';
  setTimeout(function(){ document.getElementById('zen-editor').focus(); }, 100);
}

function zenClose() {
  zenSnapshot();
  save();
  zenIsOpen = false;
  document.getElementById('zen-writer').classList.remove('open');
  document.getElementById('zen-fab').style.display = '';
  // Sync back to writer section if active
  if(currentSection === 'writer') { renderWriter(); }
}

function zenRenderPicker() {
  const sel = document.getElementById('zen-doc-picker');
  sel.innerHTML = S.docs.map(function(d) {
    return '<option value="' + d.id + '"' + (d.id === zenDocId ? ' selected' : '') + '>' + esc(d.title || 'Untitled') + ' (' + countW(d.body) + 'w)</option>';
  }).join('');
}

function zenPickDoc(id) {
  zenSnapshot();
  save();
  zenDocId = parseInt(id) || id;
  zenLoadDoc();
}

function zenLoadDoc() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d && S.docs.length) { d = S.docs[0]; zenDocId = d.id; }
  if(!d) return;
  document.getElementById('zen-title').value = d.title || '';
  document.getElementById('zen-editor').innerHTML = d.body || '';
  zenUpdateStats();
}

function zenSnapshot() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  var t = document.getElementById('zen-title');
  var e = document.getElementById('zen-editor');
  if(!t || !e) return;
  d.title = t.value;
  d.body = e.innerHTML;
  d.updated = new Date().toISOString();
}

function zenOnChange() {
  clearTimeout(zenTimer);
  document.getElementById('zen-saved').textContent = 'Unsaved';
  document.getElementById('zen-saved').style.color = 'var(--yellow)';
  zenTimer = setTimeout(function() {
    zenSnapshot();
    save();
    zenRenderPicker();
    document.getElementById('zen-saved').textContent = 'Saved';
    document.getElementById('zen-saved').style.color = 'var(--green)';
  }, 800);
  zenUpdateStats();
}

function zenUpdateStats() {
  var e = document.getElementById('zen-editor');
  var t = e.innerText || '';
  var w = t.trim().split(/\s+/).filter(function(x){ return x.length; }).length;
  document.getElementById('zen-words').textContent = w + ' words';
  document.getElementById('zen-chars').textContent = t.length + ' chars';
  document.getElementById('zen-reading').textContent = Math.max(1, Math.ceil(w / 238)) + ' min read';
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  var goal = d && d.wordGoal ? d.wordGoal : 0;
  var goalEl = document.getElementById('zen-goal');
  if(goal > 0) {
    var pct = Math.min(100, Math.round(w / goal * 100));
    goalEl.textContent = pct + '% of ' + goal + 'w goal';
    goalEl.style.color = pct >= 100 ? 'var(--green)' : 'var(--accent-cyan)';
  } else {
    goalEl.textContent = 'Set goal';
    goalEl.style.color = 'var(--text-muted)';
  }
}

function zenSetGoal() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  var g = prompt('Word count goal:', d.wordGoal || '');
  if(g === null) return;
  d.wordGoal = parseInt(g) || 0;
  save();
  zenUpdateStats();
}

function zenNewDoc() {
  zenSnapshot();
  var d = { id: Date.now(), title: '', body: '', versions: [], created: new Date().toISOString(), updated: new Date().toISOString() };
  S.docs.unshift(d);
  zenDocId = d.id;
  S.activeDoc = d.id;
  save();
  zenRenderPicker();
  zenLoadDoc();
  document.getElementById('zen-title').focus();
}

function zenCmd(c) { document.execCommand(c, false, null); document.getElementById('zen-editor').focus(); }
function zenExecBlock(tag) { document.execCommand('formatBlock', false, '<' + tag + '>'); document.getElementById('zen-editor').focus(); }
function zenInsertLink() { var u = prompt('URL:'); if(u) document.execCommand('createLink', false, u); document.getElementById('zen-editor').focus(); }
function zenInsertHR() { document.execCommand('insertHTML', false, '<hr>'); document.getElementById('zen-editor').focus(); }
function zenInsertCode() { var s = window.getSelection(); if(s.rangeCount) document.execCommand('insertHTML', false, '<code>' + (esc(s.toString()) || 'code') + '</code>'); }
function zenClearFormat() { document.execCommand('removeFormat', false, null); document.getElementById('zen-editor').focus(); }

function zenKeydown(e) {
  if(e.key === 'Tab') { e.preventDefault(); document.execCommand('insertHTML', false, '&nbsp;&nbsp;&nbsp;&nbsp;'); }
  if((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); zenSaveVersion(); }
}

function zenSaveVersion() {
  zenSnapshot();
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  if(!d.versions) d.versions = [];
  d.versions.unshift({ id: Date.now(), title: d.title, body: d.body, words: countW(d.body), date: new Date().toISOString() });
  if(d.versions.length > 50) d.versions = d.versions.slice(0, 50);
  save();
  toast('Version saved');
  document.getElementById('zen-saved').textContent = 'Version saved';
  document.getElementById('zen-saved').style.color = 'var(--accent)';
}

function zenExport(fmt) {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d || !fmt) return;
  var t = d.title || 'untitled';
  var e = document.getElementById('zen-editor');
  if(fmt === 'clipboard') { navigator.clipboard.writeText(e.innerText); toast('Copied to clipboard'); return; }
  var c, m, x;
  if(fmt === 'txt') { c = e.innerText; m = 'text/plain'; x = 'txt'; }
  else if(fmt === 'html') {
    c = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + esc(t) + '</title><style>body{font-family:Georgia,"Times New Roman",serif;max-width:680px;margin:40px auto;padding:0 24px;line-height:1.9;color:#1a1a1a;font-size:18px}h1{font-size:32px;margin-bottom:8px}h2{font-size:24px;margin-top:32px}h3{font-size:20px}blockquote{border-left:3px solid #bbb;padding-left:16px;color:#666;font-style:italic}code{background:#f0f0f0;padding:2px 5px;border-radius:3px;font-size:15px}pre{background:#f5f5f5;padding:16px;border-radius:8px;overflow-x:auto;font-size:14px}a{color:#2563eb}</style></head><body><h1>' + esc(t) + '</h1>' + e.innerHTML + '</body></html>';
    m = 'text/html'; x = 'html';
  } else if(fmt === 'md') { c = htmlToMd(e.innerHTML, t); m = 'text/markdown'; x = 'md'; }
  var blob = new Blob([c], { type: m });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = t.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.' + x;
  a.click();
  toast('Exported .' + x);
}

// === LIVING DOCS ===
function getActiveSpec(){return S.specs.find(s=>String(s.id)===String(S.activeSpec));}
function renderSpecs(){renderSpecList();loadSpec();document.getElementById('specs-count').textContent=S.specs.length;}
function renderSpecList(){document.getElementById('specs-doc-list').innerHTML=S.specs.map(s=>{const sc=s.sections?s.sections.length:0;const dt=s.updated?new Date(s.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';const ic=s.icon||'file';const c=s.color||'#8b8b8b';const path=specSectionIcon(ic);const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;return`<div class="specs-doc-item ${String(s.id)===String(S.activeSpec)?'active':''}" onclick="switchSpec('${s.id}')"><div style="display:flex;align-items:center;gap:6px"><span style="color:${c};display:flex;flex-shrink:0"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><div class="specs-doc-title">${esc(s.title||'Untitled Spec')}</div></div><div class="specs-doc-meta"><span>${sc} sec</span>${proj?`<span style="color:${proj.color||c}">${esc(proj.name)}</span>`:'<span>unassigned</span>'}<span>${dt}</span><span style="margin-left:auto;cursor:pointer;opacity:0.4;font-size:8px" onclick="event.stopPropagation();dupSpec('${s.id}')" title="Duplicate">D</span>${S.specs.length>1?`<span style="cursor:pointer;opacity:0.4" onclick="event.stopPropagation();delSpec('${s.id}')">x</span>`:''}</div></div>`;}).join('');}
function loadSpec(){const s=getActiveSpec();if(!s)return;document.getElementById('specs-title').value=s.title||'';renderSpecSections();updateSpecStatus();}
function switchSpec(id){if(String(S.activeSpec)===String(id))return;snapshotSpec();save();S.activeSpec=id;renderSpecs();const s=S.specs.find(x=>String(x.id)===String(id));if(s)trackRecent('spec',id,s.title);save();updateBreadcrumb();}
function newSpec(){snapshotSpec();const s={id:Date.now(),title:'',sections:[{id:Date.now()+1,title:'Overview',body:'',collapsed:false}],created:new Date().toISOString(),updated:new Date().toISOString()};S.specs.unshift(s);S.activeSpec=s.id;save();renderSpecs();document.getElementById('specs-title').focus();}
function delSpec(id){if(S.specs.length<=1){toast('Cannot delete last spec');return;}S.specs=S.specs.filter(s=>String(s.id)!==String(id));if(String(S.activeSpec)===String(id))S.activeSpec=S.specs[0].id;save();renderSpecs();toast('Deleted');}
function dupSpec(id){const s=S.specs.find(x=>String(x.id)===String(id));if(!s)return;const dup={...JSON.parse(JSON.stringify(s)),id:Date.now(),title:(s.title||'Spec')+' (copy)',created:new Date().toISOString(),updated:new Date().toISOString()};dup.sections=dup.sections.map(sec=>({...sec,id:'sec_'+Date.now()+Math.random()*1000}));S.specs.unshift(dup);S.activeSpec=dup.id;save();renderSpecs();toast('Duplicated: '+dup.title.substring(0,30));}
function snapshotSpec(){const s=getActiveSpec();if(!s)return;const t=document.getElementById('specs-title');if(t)s.title=t.value;if(!s.sections)s.sections=[];s.sections.forEach(sec=>{const el=document.getElementById('spec-editor-'+sec.id);if(el)sec.body=el.innerHTML;const tEl=document.getElementById('spec-title-'+sec.id);if(tEl)sec.title=tEl.value;});s.updated=new Date().toISOString();}
function specSectionIcon(name){const m={palette:'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z',cpu:'M18 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2z',layers:'M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5',alert:'M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01',flag:'M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1zM4 22v-7',link:'M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71',file:'M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z',globe:'M12 2a10 10 0 100 20 10 10 0 000-20z',lock:'M19 11H5a2 2 0 00-2 2v7a2 2 0 002 2h14a2 2 0 002-2v-7a2 2 0 00-2-2zM7 11V7a5 5 0 0110 0v4',refresh:'M23 4v6h-6M1 20v-6h6',users:'M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2',list:'M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01',mail:'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z',hdd:'M22 12H2M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z',rocket:'M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 00-2.91-.09zM12 15l-3-3M22 2l-7.5 7.5',book:'M4 19.5A2.5 2.5 0 016.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z',heart:'M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z',target:'M12 22a10 10 0 100-20 10 10 0 000 20zM12 18a6 6 0 100-12 6 6 0 000 12zM12 14a2 2 0 100-4 2 2 0 000 4z',terminal:'M4 17l6-6-6-6M12 19h8',code:'M16 18l6-6-6-6M8 6l-6 6 6 6'};return m[name]||m.file;}
function renderSpecSections(){const s=getActiveSpec();if(!s)return;const el=document.getElementById('specs-sections');const secColors=['#4ade80','#22d3ee','#8b5cf6','#f59e0b','#ef4444','#a78bfa','#06b6d4','#ec4899'];el.innerHTML=(s.sections||[]).map((sec,i)=>{const c=sec.color||secColors[i%secColors.length];const ic=sec.icon||'file';const path=specSectionIcon(ic);return`<div class="specs-section ${sec.collapsed?'collapsed':''}" data-id="${sec.id}" draggable="true" ondragstart="specDragStart(event,'${sec.id}')" ondragover="specDragOver(event)" ondragleave="event.currentTarget.style.borderTop=''" ondrop="specDrop(event,'${sec.id}')"><div class="specs-section-header" onclick="toggleSpecSection('${sec.id}')"><span class="spec-drag-handle" style="cursor:grab;opacity:0.3;font-size:10px;padding:0 4px;display:flex;align-items:center" onmousedown="event.stopPropagation()" title="Drag to reorder">::</span><span class="specs-section-toggle">v</span><span class="spec-sec-icon" style="color:${c};flex-shrink:0;display:flex;align-items:center" onclick="event.stopPropagation();cycleSecIcon('${sec.id}')" title="Click to change icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><input type="text" class="specs-section-title" id="spec-title-${sec.id}" value="${escA(sec.title||'Section '+(i+1))}" onclick="event.stopPropagation()" oninput="onSpecChange()" style="background:transparent;border:none;color:var(--text);font-size:12px;font-weight:600;flex:1;padding:0"><div style="display:flex;gap:2px;opacity:0.4"><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);margin-right:4px">${countW(sec.body)}w</span><button class="task-action-btn" onclick="event.stopPropagation();copySpecSection('${sec.id}')" title="Copy section" style="font-size:8px">C</button><button class="task-action-btn" onclick="event.stopPropagation();moveSpecSection('${sec.id}',-1)" title="Move up" style="font-size:10px">^</button><button class="task-action-btn" onclick="event.stopPropagation();moveSpecSection('${sec.id}',1)" title="Move down" style="font-size:10px">v</button><button class="task-action-btn del" onclick="event.stopPropagation();delSpecSection('${sec.id}')" title="Delete">x</button></div></div><div class="specs-section-body"><div class="specs-section-editor" id="spec-editor-${sec.id}" contenteditable="true" oninput="onSpecChange()">${sec.body||''}</div></div></div>`;}).join('')+`<div class="specs-add-section" onclick="addSpecSection()">+ Add Section</div>`;}
function addSpecSection(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.push({id:'sec_'+Date.now(),title:'New Section',body:'',collapsed:false});save();renderSpecSections();}
function delSpecSection(id){const s=getActiveSpec();if(!s||s.sections.length<=1)return;snapshotSpec();s.sections=s.sections.filter(x=>String(x.id)!==String(id));save();renderSpecSections();}
function copySpecSection(id){const s=getActiveSpec();if(!s)return;snapshotSpec();const sec=s.sections.find(x=>String(x.id)===String(id));if(!sec)return;const d=document.createElement('div');d.innerHTML=sec.body||'';const text='## '+(sec.title||'Section')+'\n\n'+(d.innerText||'');navigator.clipboard.writeText(text).then(()=>toast('Section copied'));}
function toggleSpecSection(id){const s=getActiveSpec();if(!s)return;const sec=s.sections.find(x=>String(x.id)===String(id));if(sec){sec.collapsed=!sec.collapsed;renderSpecSections();}}
function moveSpecSection(id,dir){const s=getActiveSpec();if(!s)return;snapshotSpec();const i=s.sections.findIndex(x=>String(x.id)===String(id));const ni=i+dir;if(ni<0||ni>=s.sections.length)return;[s.sections[i],s.sections[ni]]=[s.sections[ni],s.sections[i]];save();renderSpecSections();}
let specDragSectionId=null;
function specDragStart(e,id){specDragSectionId=id;e.dataTransfer.effectAllowed='move';}
function specDragOver(e){e.preventDefault();e.currentTarget.style.borderTop='2px solid var(--accent)';}
function specDrop(e,targetId){e.preventDefault();e.currentTarget.style.borderTop='';if(!specDragSectionId||specDragSectionId===targetId)return;const s=getActiveSpec();if(!s)return;snapshotSpec();const fi=s.sections.findIndex(x=>String(x.id)===specDragSectionId);const ti=s.sections.findIndex(x=>String(x.id)===targetId);if(fi<0||ti<0)return;const[item]=s.sections.splice(fi,1);s.sections.splice(ti,0,item);specDragSectionId=null;save();renderSpecSections();}
const specIconList=['file','palette','cpu','layers','alert','flag','link','globe','lock','refresh','users','list','mail','hdd','rocket','book','heart','target','terminal','code'];
const specColorList=['#4ade80','#22d3ee','#8b5cf6','#f59e0b','#ef4444','#a78bfa','#06b6d4','#ec4899','#facc15','#fb923c'];
function cycleSecIcon(id){const s=getActiveSpec();if(!s)return;const sec=s.sections.find(x=>String(x.id)===String(id));if(!sec)return;const cur=specIconList.indexOf(sec.icon||'file');sec.icon=specIconList[(cur+1)%specIconList.length];const ci=specColorList.indexOf(sec.color||'#8b8b8b');sec.color=specColorList[(ci+1)%specColorList.length];save();renderSpecSections();}
function collapseAllSections(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.forEach(x=>x.collapsed=true);save();renderSpecSections();}
function expandAllSections(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.forEach(x=>x.collapsed=false);save();renderSpecSections();}
function specSearch(){const q=(document.getElementById('spec-search')?.value||'').toLowerCase();const s=getActiveSpec();if(!s)return;if(!q){s.sections.forEach(x=>x.collapsed=false);renderSpecSections();return;}s.sections.forEach(sec=>{const title=(sec.title||'').toLowerCase();const d=document.createElement('div');d.innerHTML=sec.body||'';const body=(d.innerText||'').toLowerCase();sec.collapsed=!(title.includes(q)||body.includes(q));});renderSpecSections();}
function onSpecChange(){clearTimeout(specTimer);document.getElementById('specs-status').textContent='Unsaved';document.getElementById('specs-status').style.color='var(--yellow)';specTimer=setTimeout(()=>{snapshotSpec();save();renderSpecList();document.getElementById('specs-status').textContent='Saved';document.getElementById('specs-status').style.color='var(--green)';updateSpecStatus();},1000);}
function updateSpecStatus(){const s=getActiveSpec();if(!s)return;let total=0;(s.sections||[]).forEach(sec=>{total+=countW(sec.body);});document.getElementById('specs-word-count').textContent=total+' words';}
function specExport(fmt){if(!fmt)return;snapshotSpec();const s=getActiveSpec();if(!s)return;const t=s.title||'spec';let c;if(fmt==='clipboard'){let txt=t+'\n'+'='.repeat(t.length)+'\n\n';(s.sections||[]).forEach(sec=>{txt+=sec.title+'\n'+'-'.repeat(sec.title.length)+'\n';const d=document.createElement('div');d.innerHTML=sec.body||'';txt+=(d.innerText||'')+'\n\n';});navigator.clipboard.writeText(txt);toast('Copied');return;}if(fmt==='md'){c='# '+t+'\n\n';(s.sections||[]).forEach(sec=>{c+='## '+sec.title+'\n\n';c+=htmlToMd(sec.body||'',null).replace(/^# .*\n\n/,'')+'\n';});}else if(fmt==='html'){c=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(t)}</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#222}h1{font-size:28px;border-bottom:2px solid #eee;padding-bottom:8px}h2{font-size:20px;margin-top:24px;color:#333}blockquote{border-left:3px solid #ccc;padding-left:16px;color:#666;font-style:italic}code{background:#f4f4f4;padding:1px 4px;border-radius:3px}</style></head><body><h1>${esc(t)}</h1>`+(s.sections||[]).map(sec=>`<h2>${esc(sec.title)}</h2>${sec.body||''}`).join('')+'</body></html>';}const blob=new Blob([c],{type:fmt==='md'?'text/markdown':'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=t.replace(/[^a-z0-9]/gi,'-').toLowerCase()+'.'+(fmt==='md'?'md':'html');a.click();toast('Exported');}

// === LINKS ===
function renderLinks(){
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  document.getElementById('link-category-tabs').innerHTML=`<button class="tab-btn ${linkCategory==='all'?'active':''}" onclick="setLinkCat('all',this)">All <span style="font-size:8px;opacity:0.6">${S.links.length}</span></button>`+cats.map(c=>{const cnt=S.links.filter(l=>l.category===c).length;return `<button class="tab-btn ${linkCategory===c?'active':''}" onclick="setLinkCat('${escA(c)}',this)">${esc(c)} <span style="font-size:8px;opacity:0.6">${cnt}</span></button>`;}).join('');
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc).toLowerCase().includes(q));
  const ls=(document.getElementById('link-sort')?.value)||'newest';
  if(ls==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));
  else if(ls==='oldest')items.sort((a,b)=>new Date(a.created||0)-new Date(b.created||0));
  else if(ls==='alpha')items.sort((a,b)=>(a.title||'').localeCompare(b.title||''));
  else if(ls==='category')items.sort((a,b)=>(a.category||'zzz').localeCompare(b.category||'zzz'));
  items.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));
  const g=document.getElementById('links-grid');
  g.innerHTML=!items.length?`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">L</div><div style="font-size:12px">${q?'No matching links':'No links saved'}</div><div style="font-size:10px;margin-top:4px">${q?'Try a different search':'Click + Add to save bookmarks and resources'}</div></div>`:items.map(l=>{let domain='';try{domain=new URL(l.url).hostname;}catch(e){}return`<div class="link-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain',JSON.stringify({type:'links',id:${l.id}}))" onclick="window.open('${escA(l.url)}','_blank')" ${l.pinned?'style="border-color:rgba(74,222,128,0.2)"':''}>${l.pinned?'<div style="font-size:7px;color:var(--accent);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:2px">Pinned</div>':''}<div style="display:flex;align-items:center;gap:8px">${domain?`<img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" width="16" height="16" style="border-radius:2px;flex-shrink:0" onerror="this.style.display='none'">`:''}<div class="link-card-title" style="margin:0">${esc(l.title)}</div></div><div class="link-card-url">${esc(l.url)}</div>${l.desc?`<div class="link-card-desc">${parseWikiLinks(esc(l.desc))}</div>`:''}<div class="link-card-footer">${l.category?`<span class="badge badge-blue">${esc(l.category)}</span>`:''}${l.projectId?(()=>{const p=(S.projects||[]).find(x=>x.id===l.projectId);return p?`<span class="badge badge-muted" style="font-size:7px">${esc(p.name)}</span>`:''})():''}${l.created?`<span style="font-size:8px;color:var(--text-muted)">${new Date(l.created).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>`:''}<div class="link-card-actions"><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();pinLink(${l.id})" style="${l.pinned?'color:var(--accent)':''}">${l.pinned?'Unpin':'Pin'}</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('${escA(l.url)}')">Copy</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('[${escA(l.title)}](${escA(l.url)})');toast('Markdown link copied')">MD</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();openLinkModal(${l.id})">Edit</button><button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();delLink(${l.id})">Del</button></div></div></div>`;}).join('');
  document.getElementById('links-count').textContent=S.links.length;
}
function setLinkCat(c,el){linkCategory=c;document.querySelectorAll('#link-category-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderLinks();}
function openLinkModal(id){editingLinkId=id||null;document.getElementById('link-modal-title').textContent=id?'Edit Link':'Add Link';const projSel=document.getElementById('lm-project');projSel.innerHTML='<option value="">None</option>'+(S.projects||[]).map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
  // Category datalist
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  let cdl=document.getElementById('link-cat-dl');if(!cdl){cdl=document.createElement('datalist');cdl.id='link-cat-dl';document.body.appendChild(cdl);}
  cdl.innerHTML=cats.map(c=>`<option value="${esc(c)}">`).join('');
  document.getElementById('lm-category').setAttribute('list','link-cat-dl');if(id){const l=S.links.find(x=>x.id===id);if(l){document.getElementById('lm-title').value=l.title;document.getElementById('lm-url').value=l.url;document.getElementById('lm-category').value=l.category||'';document.getElementById('lm-desc').value=l.desc||'';projSel.value=l.projectId||'';}}else{document.getElementById('lm-title').value='';document.getElementById('lm-url').value='';document.getElementById('lm-category').value='';document.getElementById('lm-desc').value='';projSel.value=activeProject||'';}document.getElementById('link-modal').classList.add('open');setTimeout(()=>document.getElementById('lm-title').focus(),100);}
function closeLinkModal(){document.getElementById('link-modal').classList.remove('open');editingLinkId=null;}
function saveLink(){const title=document.getElementById('lm-title').value.trim(),url=document.getElementById('lm-url').value.trim(),cat=document.getElementById('lm-category').value.trim().toLowerCase(),desc=document.getElementById('lm-desc').value.trim(),projId=document.getElementById('lm-project').value;if(!title||!url){toast('Title and URL required');return;}try{new URL(url);}catch(e){toast('Invalid URL format');return;}if(!editingLinkId){const dup=S.links.find(l=>l.url===url);if(dup&&!confirm('URL already exists as "'+dup.title+'". Add anyway?'))return;}if(editingLinkId){const l=S.links.find(x=>x.id===editingLinkId);if(l){l.title=title;l.url=url;l.category=cat;l.desc=desc;l.projectId=projId||undefined;}}else{const link={id:Date.now(),title,url,category:cat,desc,created:new Date().toISOString()};if(projId)link.projectId=projId;else if(activeProject)link.projectId=activeProject;S.links.push(link);}save();closeLinkModal();renderLinks();if(activeProject)renderProjLinks();toast(editingLinkId?'Updated':'Added');}
function suggestLinkTitle(){
  const urlEl=document.getElementById('lm-url'),titleEl=document.getElementById('lm-title');
  if(!urlEl||!titleEl||titleEl.value.trim())return;
  const url=urlEl.value.trim();if(!url)return;
  try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'');const path=u.pathname.replace(/^\//,'').replace(/\/$/, '').split('/').filter(Boolean);
  let title=host;
  if(path.length)title=path[path.length-1].replace(/[-_]/g,' ').replace(/\.\w+$/,'');
  titleEl.value=title.charAt(0).toUpperCase()+title.slice(1);
  }catch(e){}
}
async function fetchLinkTitle(){
  const urlEl=document.getElementById('lm-url'),titleEl=document.getElementById('lm-title');
  const url=urlEl?.value.trim();if(!url)return;
  try{new URL(url);}catch(e){toast('Invalid URL');return;}
  titleEl.value='Fetching...';
  try{
    const resp=await fetch('https://api.allorigins.win/get?url='+encodeURIComponent(url),{signal:AbortSignal.timeout(5000)});
    const data=await resp.json();
    const match=(data.contents||'').match(/<title[^>]*>([^<]+)<\/title>/i);
    if(match&&match[1]){titleEl.value=match[1].trim().substring(0,120);toast('Title fetched');}
    else{suggestLinkTitle();toast('No title found, using URL-based name');}
  }catch(e){suggestLinkTitle();toast('Fetch failed, using URL-based name');}
}
function batchImportLinks(){
  const text=prompt('Paste URLs (one per line):');if(!text)return;
  const urls=text.split('\n').map(u=>u.trim()).filter(u=>{try{new URL(u);return true;}catch(e){return false;}});
  if(!urls.length){toast('No valid URLs found');return;}
  urls.forEach(url=>{try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'');const path=u.pathname.replace(/^\//,'').replace(/\/$/,'').split('/').filter(Boolean);let title=host;if(path.length)title=path[path.length-1].replace(/[-_]/g,' ').replace(/\.\w+$/,'');title=title.charAt(0).toUpperCase()+title.slice(1);S.links.push({id:Date.now()+Math.random()*1000,title,url,category:'imported',desc:'',created:new Date().toISOString()});}catch(e){}});
  save();renderLinks();toast('Imported '+urls.length+' links');
}
let lastDeletedLink=null;
function delLink(id){const l=S.links.find(x=>x.id===id);if(l)lastDeletedLink={...l};S.links=S.links.filter(l=>l.id!==id);save();renderLinks();toast('Deleted — Cmd+Z to undo');}
function undoDeleteLink(){if(!lastDeletedLink)return;S.links.unshift(lastDeletedLink);lastDeletedLink=null;save();renderLinks();toast('Link restored');}
function pinLink(id){const l=S.links.find(x=>x.id===id);if(l){l.pinned=!l.pinned;save();renderLinks();toast(l.pinned?'Pinned':'Unpinned');}}
function openFilteredLinks(){
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc).toLowerCase().includes(q));
  const urls=items.filter(l=>l.url).slice(0,10);
  if(!urls.length){toast('No links to open');return;}
  if(urls.length>5&&!confirm('Open '+urls.length+' links in new tabs?'))return;
  urls.forEach(l=>window.open(l.url,'_blank'));toast('Opened '+urls.length+' links');
}
function cpText(t){navigator.clipboard.writeText(t);toast('Copied');}
function exportLinks(){
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  let md='# Links Export\n'+S.links.length+' links | '+new Date().toLocaleDateString()+'\n\n';
  cats.forEach(c=>{md+='## '+c+'\n';S.links.filter(l=>l.category===c).forEach(l=>{md+='- ['+l.title+']('+l.url+')'+(l.desc?' — '+l.desc:'')+'\n';});md+='\n';});
  const uncategorized=S.links.filter(l=>!l.category);
  if(uncategorized.length){md+='## Other\n';uncategorized.forEach(l=>{md+='- ['+l.title+']('+l.url+')'+(l.desc?' — '+l.desc:'')+'\n';});md+='\n';}
  navigator.clipboard.writeText(md).then(()=>toast('Links exported to clipboard'));
}
function copyAllLinkURLs(){
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc).toLowerCase().includes(q));
  if(!items.length){toast('No links to copy');return;}
  const urls=items.map(l=>l.url).join('\n');
  navigator.clipboard.writeText(urls).then(()=>toast('Copied '+items.length+' URLs'));
}

// === PROJECTS ===
let activeProject = null;
let activeProjTab = 'instructions';
let editingProjectId = null;
let editingKBId = null;
let kbModalTab = 'text';
let kbImageData = null;

const ICON_SVGS = {
  rocket:'<path d="M4.5 16.5c-1.5 1.37-3 4.5-3 4.5s3.13-1.5 4.5-3c.78-.78.78-2.04 0-2.83s-2.04-.78-2.83 0z"/><path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/>',
  code:'<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>',
  book:'<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
  music:'<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>',
  globe:'<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
  atom:'<circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5z"/>',
  target:'<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
  heart:'<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
  star:'<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
  flag:'<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>',
  lightning:'<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
  fire:'<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.07-2.14 0-5.5 3.5-7.5-2.5 5 1.5 5 3 7.5 2 3.5 1 6-2 8-1.5 1-4.5 1-6-1"/>',
  terminal:'<polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>',
  database:'<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>',
  server:'<rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>',
  cpu:'<rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/>',
  cloud:'<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>',
  pen:'<path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/>',
  palette:'<circle cx="13.5" cy="6.5" r="1.5"/><circle cx="17.5" cy="10.5" r="1.5"/><circle cx="8.5" cy="7.5" r="1.5"/><circle cx="6.5" cy="12" r="1.5"/><path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10c.97 0 1.76-.79 1.76-1.76 0-.47-.18-.89-.48-1.21-.3-.31-.48-.74-.48-1.21 0-.97.79-1.76 1.76-1.76H16c3.31 0 6-2.69 6-6 0-5.17-4.49-8.06-10-8.06z"/>',
  camera:'<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>',
  video:'<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>',
  mic:'<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>',
  headphones:'<path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>',
  layers:'<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
  brain:'<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44A2.5 2.5 0 0 1 5.5 17c-1.56 0-3-1.28-3-3 0-1.16.6-2.13 1.46-2.7A2.5 2.5 0 0 1 5.5 7a2.5 2.5 0 0 1 4-2z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44A2.5 2.5 0 0 0 18.5 17c1.56 0 3-1.28 3-3 0-1.16-.6-2.13-1.46-2.7A2.5 2.5 0 0 0 18.5 7a2.5 2.5 0 0 0-4-2z"/>',
  flask:'<path d="M9 3h6"/><path d="M10 3v7.4a2 2 0 0 1-.5 1.3L4 18.6A2 2 0 0 0 5.5 22h13a2 2 0 0 0 1.5-3.4L14.5 11.7a2 2 0 0 1-.5-1.3V3"/>',
  telescope:'<path d="M10.065 12.493l-6.18 1.318a.934.934 0 0 1-1.108-.702l-.537-2.15a1.07 1.07 0 0 1 .691-1.265l13.504-4.44"/><path d="M13.56 11.747l4.332-.924"/><path d="M16 21l-3.105-6.21"/><path d="M16.485 5.94a2 2 0 0 1 1.455-2.425l1.09-.272a1 1 0 0 1 1.212.727l1.515 6.06a1 1 0 0 1-.727 1.213l-1.09.272a2 2 0 0 1-2.425-1.455z"/><path d="M6.158 8.633l1.114 4.456"/>',
  map:'<polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/>',
  compass:'<circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>',
  tools:'<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',
  wrench:'<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',
  key:'<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>',
  lock:'<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
  shield:'<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
  crown:'<path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7z"/><path d="M5 16h14"/>',
  diamond:'<rect x="12" y="1" width="15.56" height="15.56" rx="2.41" transform="rotate(45 12 12)" style="stroke-width:1.5"/>',
  sun:'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',
  moon:'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>',
  mountain:'<path d="M8 3l4 8 5-5 5 15H2z"/>',
  leaf:'<path d="M11 20A7 7 0 0 1 9.8 6.9C15.5 4.9 17 3.5 19 2c1 2 2 4.5 2 8 0 5.5-4.78 10-10 10z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>',
  mail:'<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>',
  phone:'<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>',
  bell:'<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>',
  megaphone:'<path d="M3 11l18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/>',
  chart:'<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
  trending:'<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
  dollar:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
  briefcase:'<rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>',
  building:'<rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><line x1="8" y1="6" x2="8" y2="6.01"/><line x1="16" y1="6" x2="16" y2="6.01"/><line x1="12" y1="6" x2="12" y2="6.01"/><line x1="8" y1="10" x2="8" y2="10.01"/><line x1="16" y1="10" x2="16" y2="10.01"/><line x1="12" y1="10" x2="12" y2="10.01"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="16" y1="14" x2="16" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/>',
  user:'<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
  users:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
  eye:'<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>',
  calendar:'<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>',
  clock:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
  folder:'<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>',
  file:'<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>',
  grid:'<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>',
  list:'<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>',
  archive:'<polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/>',
  activity:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',
  zap:'<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
  anchor:'<circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/>',
  feather:'<path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/>',
  gift:'<polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>',
  message:'<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
  git:'<circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><line x1="6" y1="9" x2="6" y2="21"/>',
  wifi:'<path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>',
  crosshair:'<circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/>',
  hammer:'<path d="M15 12l-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15L22 10.64"/><path d="M20.91 11.7l-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V6.5L14.5 2.25 12 4.75l1.5 1.5L9 12"/>',
  tree:'<path d="M12 22v-7"/><path d="M5 12H2l10-10 10 10h-3"/><path d="M8 18H2l10-8 10 8h-6"/>',
};
const ICON_KEYS = Object.keys(ICON_SVGS);

function getIconSVG(key, size) {
  const s = size || 16;
  const d = ICON_SVGS[key] || ICON_SVGS.folder;
  return `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${d}</svg>`;
}

// Project CRUD
function getProjects() { return S.projects || []; }
function getProject(id) { return (S.projects||[]).find(p=>p.id===id); }
function getKBItems(projectId) { return (S.knowledgeBase||[]).filter(k=>k.projectId===projectId); }

function renderProjectsSidebar() {
  const el = document.getElementById('sidebar-projects');
  const projects = getProjects();
  el.innerHTML = projects.map(p => {
    const statusClass = p.status === 'active' ? 'active-s' : p.status === 'paused' ? 'paused-s' : 'complete-s';
    const isActive = activeProject === p.id;
    const projTasks = getProjectTasks(p.id);
    const doneTasks = projTasks.filter(t => t.status === 'done').length;
    const totalTasks = projTasks.length;
    const pct = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
    return `<div class="sidebar-project-item ${isActive?'active':''}" onclick="openProject('${p.id}')" style="${isActive?'border-left:3px solid '+p.color:'border-left:3px solid transparent'}">
      <span class="proj-icon" style="color:${p.color}">${getIconSVG(p.icon,14)}</span>
      <span class="proj-name">${esc(p.name)}</span>
      ${totalTasks>0?`<span style="font-family:var(--mono);font-size:8px;color:var(--text-muted);margin-left:auto">${pct}%</span>`:''}
      <span class="proj-status ${statusClass}"></span>
    </div>${totalTasks>0?`<div style="height:2px;background:var(--border);margin:0 12px 2px;border-radius:1px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${p.color};border-radius:1px;transition:width 0.3s"></div></div>`:''}`;

  }).join('') + `<div class="sidebar-add-project" onclick="openNewProjectModal()">+ New Project</div>`;
}

function openProject(id) {
  activeProject = id;
  activeProjTab = 'instructions';
  const p = (S.projects||[]).find(x=>x.id===id);
  if(p) trackRecent('project', id, p.name);
  const app = document.querySelector('.app');
  // Close context panel — they share the right-side grid slot
  app.classList.remove('context-open');
  app.classList.add('project-open');
  renderProjectsSidebar();
  renderProjectView();
}

function closeProjectPanel() {
  activeProject = null;
  const app = document.querySelector('.app');
  app.classList.remove('project-open');
  document.documentElement.style.setProperty('--project-width', '420px');
  renderProjectsSidebar();
}

function renderProjectView() {
  const p = getProject(activeProject);
  if (!p) return;
  document.getElementById('proj-header-icon').innerHTML = getIconSVG(p.icon, 18);
  document.getElementById('proj-header-icon').style.borderColor = p.color;
  document.getElementById('proj-header-name').textContent = p.name;
  const statusEl = document.getElementById('proj-header-status');
  statusEl.textContent = p.status;
  statusEl.className = 'badge badge-' + (p.status==='active'?'green':p.status==='paused'?'yellow':'blue');
  // Project stats
  const pTasks=S.tasks.filter(t=>t.project===p.name);
  const pTasksDone=pTasks.filter(t=>t.status==='done').length;
  const pDocs=S.specs.filter(s=>s.projectId===p.id);
  const pLinks=S.links.filter(l=>l.projectId===p.id);
  const pKB=(S.kb||[]).filter(k=>k.projectId===p.id);
  const pContent=S.content.filter(c=>(c.tags||[]).includes(p.name.toLowerCase()));
  const statsBar=document.getElementById('proj-stats-bar');
  statsBar.innerHTML=`<span style="font-size:9px;color:var(--text-muted)" title="${pTasks.length} tasks (${pTasksDone} done)">T:${pTasksDone}/${pTasks.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pDocs.length} living docs">D:${pDocs.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pKB.length} KB items">KB:${pKB.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pLinks.length} links">L:${pLinks.length}</span>`;
  // Apply project color to tabs
  document.documentElement.style.setProperty('--proj-accent', p.color);
  setProjTab(activeProjTab);
}

function setProjTab(tab, el) {
  activeProjTab = tab;
  document.querySelectorAll('.project-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  else document.querySelectorAll('.project-tab').forEach(t => { if(t.textContent.toLowerCase().replace(/\s/g,'-').includes(tab.replace('proj-',''))|| (tab==='instructions'&&t.textContent==='Instructions') || (tab==='docs'&&t.textContent==='Living Docs') || (tab==='kb'&&t.textContent==='Knowledge Base') || (tab==='proj-tasks'&&t.textContent==='Tasks') || (tab==='proj-links'&&t.textContent==='Links')) t.classList.add('active'); });
  document.querySelectorAll('.proj-tab-panel').forEach(p=>p.style.display='none');
  const panel = document.getElementById('proj-panel-'+tab);
  if(panel) panel.style.display = 'block';
  if(tab==='instructions') loadProjInstructions();
  if(tab==='docs') renderProjDocs();
  if(tab==='kb') renderKB();
  if(tab==='proj-tasks') renderProjTasks();
  if(tab==='proj-links') renderProjLinks();
}

// Instructions
function loadProjInstructions() {
  const p = getProject(activeProject);
  if(!p) return;
  document.getElementById('proj-instructions-editor').innerHTML = p.instructions || '';
}
let projInstrTimer = null;
function onProjInstructionsChange() {
  clearTimeout(projInstrTimer);
  projInstrTimer = setTimeout(() => {
    const p = getProject(activeProject);
    if(p) { p.instructions = document.getElementById('proj-instructions-editor').innerHTML; p.updated = new Date().toISOString(); save(); }
  }, 1000);
}

// Project Living Docs
function renderProjDocs() {
  const p = getProject(activeProject);
  if(!p) return;
  const docs = S.specs.filter(s => s.projectId === activeProject || s.global);
  const unassigned = S.specs.filter(s => !s.projectId && !s.global);
  const grid = document.getElementById('proj-docs-grid');
  let html = '';
  if(!docs.length && !unassigned.length) {
    html = '<div class="kb-empty">No living docs for this project. Click + to add one.</div>';
  } else {
    html = docs.map(d => {
      const sc = d.sections ? d.sections.length : 0;
      const dt = d.updated ? new Date(d.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
      const previewSec = d.sections && d.sections.find(s=>s.body);
      const previewRaw = previewSec ? previewSec.body.replace(/<[^>]+>/g,'').substring(0,100) : (d.sections && d.sections[0] ? d.sections[0].title : '');
      const preview = previewRaw;
      const ic = d.icon||'file'; const c = d.color||'#8b8b8b'; const path = specSectionIcon(ic);
      return `<div class="proj-doc-card" onclick="goToLivingDoc('${d.id}')">
        <div style="display:flex;align-items:center;gap:6px"><span style="color:${c};display:flex"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><div class="proj-doc-card-title">${esc(d.title||'Untitled')}</div></div>
        <div class="proj-doc-card-meta"><span>${sc} sections</span><span>${dt}</span></div>
        <div class="proj-doc-card-preview">${esc(preview)}</div>
      </div>`;
    }).join('');
    if(unassigned.length) {
      html += `<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">${unassigned.length} unassigned doc${unassigned.length>1?'s':''}</div>
        ${unassigned.map(d => `<div class="proj-doc-card" style="opacity:0.6;cursor:pointer" onclick="assignDocToProject('${d.id}')">
          <div class="proj-doc-card-title">${esc(d.title||'Untitled')}</div>
          <div style="font-size:9px;color:var(--accent);margin-top:4px">Click to assign to this project</div>
        </div>`).join('')}
      </div>`;
    }
  }
  grid.innerHTML = html;
}
function assignDocToProject(docId) {
  const doc = S.specs.find(s => String(s.id) === String(docId));
  if(!doc || !activeProject) return;
  doc.projectId = activeProject;
  doc.updated = new Date().toISOString();
  save();
  renderProjDocs();
  toast('Doc assigned to project');
}
function newProjLivingDoc() {
  snapshotSpec();
  const s = {id:Date.now(), title:'', projectId:activeProject, sections:[{id:Date.now()+1,title:'Overview',body:'',collapsed:false}], created:new Date().toISOString(), updated:new Date().toISOString()};
  S.specs.unshift(s);
  S.activeSpec = s.id;
  save();
  switchSection('specs', document.querySelector('.sidebar-item:nth-child(5)'));
  toast('Living Doc created — editing now');
}
function goToLivingDoc(id) {
  S.activeSpec = id;
  save();
  switchSection('specs', null);
  document.querySelectorAll('.sidebar-item').forEach(i => { if(i.textContent.includes('Living Docs')) { i.classList.add('active'); } else { i.classList.remove('active'); }});
}

// Knowledge Base
function renderKB() {
  const items = getKBItems(activeProject);
  const q = (document.getElementById('kb-search')?.value||'').toLowerCase();
  let filtered = items;
  if(q) filtered = filtered.filter(k => (k.name+' '+k.description+' '+(k.tags||[]).join(' ')).toLowerCase().includes(q));
  const grid = document.getElementById('kb-grid');
  grid.innerHTML = !filtered.length ? '<div class="kb-empty">No knowledge base items yet. Click + Add Item to start building.</div>' :
    filtered.map(k => {
      const typeClass = 'kb-type-'+(k.type||'other');
      const hasImg = k.type === 'img' && k.content;
      return `<div class="kb-card" onclick="openKBViewer('${k.id}')" draggable="true" ondragstart="kbDragStart(event,'${k.id}')">
        <div class="kb-card-actions">
          <button class="btn btn-sm btn-ghost kb-card-drag" draggable="false" title="Drag to whiteboard">&#x2630;</button>
          <button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();confirmDeleteKB('${k.id}')">x</button>
        </div>
        <div class="kb-card-header">
          <span class="kb-card-type ${typeClass}">${(k.type||'other').toUpperCase()}</span>
          <span class="kb-card-name">${esc(k.name)}</span>
        </div>
        <div class="kb-card-desc">${esc(k.description||'')}</div>
        ${hasImg ? `<img class="kb-card-img" src="${k.content}" alt="${escA(k.name)}">` : ''}
        ${k.tags && k.tags.length ? `<div class="kb-card-tags">${k.tags.map(t=>`<span class="kb-card-tag">${esc(t)}</span>`).join('')}</div>` : ''}
      </div>`;
    }).join('');
}

// KB Modal
function openKBModal(id) {
  editingKBId = id || null;
  kbImageData = null;
  document.getElementById('kb-modal-title').textContent = id ? 'Edit Knowledge Base Item' : 'Add to Knowledge Base';
  if(id) {
    const k = (S.knowledgeBase||[]).find(x=>x.id===id);
    if(k) {
      if(k.type==='md'||k.type==='txt'||k.type==='json') { setKBModalTab('text'); document.getElementById('kbm-text-name').value=k.name; document.getElementById('kbm-text-content').value=k.content||''; }
      else if(k.type==='img') { setKBModalTab('image'); document.getElementById('kbm-img-name').value=k.name; if(k.content){kbImageData=k.content;document.getElementById('kbm-img-preview').style.display='block';document.getElementById('kbm-img-preview-img').src=k.content;} }
      else if(k.type==='url') { setKBModalTab('url'); document.getElementById('kbm-url-name').value=k.name; document.getElementById('kbm-url-url').value=k.url||''; }
      else { setKBModalTab('file'); document.getElementById('kbm-file-name').value=k.name; document.getElementById('kbm-file-path').value=k.filePath||''; document.getElementById('kbm-file-type').value=k.type||'other'; }
      document.getElementById('kbm-desc').value=k.description||'';
      document.getElementById('kbm-tags').value=(k.tags||[]).join(', ');
    }
  } else {
    setKBModalTab('text');
    ['kbm-text-name','kbm-text-content','kbm-file-name','kbm-file-path','kbm-url-name','kbm-url-url','kbm-img-name','kbm-desc','kbm-tags'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    document.getElementById('kbm-img-preview').style.display='none';
  }
  document.getElementById('kb-modal').classList.add('open');
}
function closeKBModal() { document.getElementById('kb-modal').classList.remove('open'); editingKBId=null; kbImageData=null; }
function setKBModalTab(tab, el) {
  kbModalTab = tab;
  document.querySelectorAll('.kb-modal-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  else document.querySelectorAll('.kb-modal-tab').forEach(t => { if((tab==='text'&&t.textContent.includes('Text'))||(tab==='file'&&t.textContent.includes('File'))||(tab==='url'&&t.textContent==='URL')||(tab==='image'&&t.textContent==='Image')) t.classList.add('active'); });
  document.querySelectorAll('.kb-modal-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('kb-panel-'+tab).classList.add('active');
}
function handleKBImageFile(input) {
  const file = input.files[0];
  if(!file) return;
  if(file.size > 500*1024) { toast('Image too large (>500KB). Use file reference instead.'); return; }
  const reader = new FileReader();
  reader.onload = e => { kbImageData = e.target.result; document.getElementById('kbm-img-preview').style.display='block'; document.getElementById('kbm-img-preview-img').src = kbImageData; };
  reader.readAsDataURL(file);
}
function saveKBItem() {
  if(!S.knowledgeBase) S.knowledgeBase = [];
  let item;
  if(kbModalTab==='text') {
    const name = document.getElementById('kbm-text-name').value.trim();
    const content = document.getElementById('kbm-text-content').value.trim();
    if(!name) { toast('Name required'); return; }
    item = { name, type:'md', storage:'inline', content, filePath:null, url:null };
  } else if(kbModalTab==='file') {
    const name = document.getElementById('kbm-file-name').value.trim();
    const path = document.getElementById('kbm-file-path').value.trim();
    const type = document.getElementById('kbm-file-type').value;
    if(!name) { toast('Name required'); return; }
    item = { name, type, storage:'reference', content:null, filePath:path, url:null };
  } else if(kbModalTab==='url') {
    const name = document.getElementById('kbm-url-name').value.trim();
    const url = document.getElementById('kbm-url-url').value.trim();
    if(!name||!url) { toast('Name and URL required'); return; }
    item = { name, type:'url', storage:'inline', content:null, filePath:null, url };
  } else if(kbModalTab==='image') {
    const name = document.getElementById('kbm-img-name').value.trim();
    if(!name||!kbImageData) { toast('Name and image required'); return; }
    item = { name, type:'img', storage:'inline', content:kbImageData, filePath:null, url:null };
  }
  item.description = document.getElementById('kbm-desc').value.trim();
  item.tags = document.getElementById('kbm-tags').value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
  item.projectId = activeProject;
  if(editingKBId) {
    const existing = S.knowledgeBase.find(k=>k.id===editingKBId);
    if(existing) Object.assign(existing, item, {updated:new Date().toISOString()});
  } else {
    item.id = 'kb_'+Date.now();
    item.created = new Date().toISOString();
    item.updated = new Date().toISOString();
    S.knowledgeBase.push(item);
  }
  save(); closeKBModal(); renderKB(); toast(editingKBId?'Updated':'Added');
}

// KB Viewer
let viewingKBId = null;
function openKBViewer(id) {
  viewingKBId = id;
  const k = (S.knowledgeBase||[]).find(x=>x.id===id);
  if(!k) return;
  document.getElementById('kbv-type').textContent = (k.type||'other').toUpperCase();
  document.getElementById('kbv-type').className = 'kb-card-type kb-type-'+(k.type||'other');
  document.getElementById('kbv-name').textContent = k.name;
  document.getElementById('kbv-desc').textContent = k.description||'';
  const contentEl = document.getElementById('kbv-content');
  const imageEl = document.getElementById('kbv-image');
  const pathEl = document.getElementById('kbv-path');
  contentEl.style.display = 'none'; imageEl.style.display = 'none'; pathEl.style.display = 'none';
  if(k.type==='img' && k.content) { imageEl.style.display='block'; document.getElementById('kbv-image-img').src=k.content; }
  else if(k.content) { contentEl.style.display='block'; contentEl.innerHTML=parseWikiLinks(esc(k.content)); }
  else if(k.url) { contentEl.style.display='block'; contentEl.innerHTML=`<a href="${escA(k.url)}" target="_blank" style="color:var(--accent)">${esc(k.url)}</a>`; }
  if(k.filePath) { pathEl.style.display='block'; pathEl.textContent='File: '+k.filePath; }
  document.getElementById('kbv-tags').innerHTML = (k.tags||[]).map(t=>`<span class="kb-card-tag">${esc(t)}</span>`).join('');
  document.getElementById('kb-viewer-modal').classList.add('open');
}
function closeKBViewer() { document.getElementById('kb-viewer-modal').classList.remove('open'); viewingKBId=null; }
function editKBItem() { closeKBViewer(); openKBModal(viewingKBId); }
function deleteKBItem() { if(!viewingKBId) return; S.knowledgeBase = (S.knowledgeBase||[]).filter(k=>k.id!==viewingKBId); save(); closeKBViewer(); renderKB(); toast('Deleted'); }
function confirmDeleteKB(id) { S.knowledgeBase = (S.knowledgeBase||[]).filter(k=>k.id!==id); save(); renderKB(); toast('Deleted'); }

// KB drag to whiteboard
function kbDragStart(e, id) {
  e.dataTransfer.setData('text/plain', 'kb:'+id);
  e.dataTransfer.effectAllowed = 'copy';
}

// Project Tasks — uses projectId (preferred) or falls back to project name match
function getProjectTasks(projId) {
  const p = getProject(projId);
  if(!p) return [];
  return S.tasks.filter(t => t.projectId === projId || (!t.projectId && t.project === p.name));
}
function renderProjTasks() {
  const p = getProject(activeProject);
  if(!p) return;
  const tasks = getProjectTasks(activeProject);
  const el = document.getElementById('proj-task-rows');
  el.innerHTML = tasks.map(t => `<div class="task-row ${t.status==='done'?'completed':''}" style="grid-template-columns:36px 1fr 110px 100px 50px">
    <div class="task-checkbox ${t.status==='done'?'checked':''}" onclick="toggleTask(${t.id});setTimeout(()=>renderProjTasks(),50)"></div>
    <div><input type="text" class="task-title-input" value="${escA(t.title)}" onchange="updateTask(${t.id},'title',this.value)" placeholder="Task name..."></div>
    <div><select class="task-select" onchange="updateTask(${t.id},'status',this.value);setTimeout(()=>renderProjTasks(),50)"><option value="todo" ${t.status==='todo'?'selected':''}>To Do</option><option value="progress" ${t.status==='progress'?'selected':''}>In Progress</option><option value="done" ${t.status==='done'?'selected':''}>Done</option><option value="blocked" ${t.status==='blocked'?'selected':''}>Blocked</option></select></div>
    <div><input type="date" class="task-select" value="${t.due||''}" onchange="updateTask(${t.id},'due',this.value)"></div>
    <div class="task-actions" style="opacity:1"><button class="task-action-btn del" onclick="deleteTask(${t.id});setTimeout(()=>renderProjTasks(),50)">x</button></div>
  </div>`).join('') + `<div class="add-task-row" onclick="addProjTask()">+ Add task</div>`;
}
function addProjTask() {
  const p = getProject(activeProject);
  if(!p) return;
  S.tasks.unshift({id:Date.now(), title:'', status:'todo', priority:'p1', project:p.name, projectId:activeProject, due:new Date().toISOString().split('T')[0], created:new Date().toISOString()});
  save(); renderProjTasks(); renderTasks();
  setTimeout(()=>{const i=document.querySelector('#proj-task-rows .task-title-input');if(i)i.focus();},50);
}

// Project Links
function renderProjLinks() {
  const p = getProject(activeProject);
  if(!p) return;
  const links = S.links.filter(l => l.projectId === activeProject);
  const grid = document.getElementById('proj-links-grid');
  grid.innerHTML = !links.length ? '<div class="kb-empty">No links for this project.</div>' :
    links.map(l => `<div class="link-card" onclick="window.open('${escA(l.url)}','_blank')">
      <div class="link-card-title">${esc(l.title)}</div>
      <div class="link-card-url">${esc(l.url)}</div>
      ${l.desc?`<div class="link-card-desc">${parseWikiLinks(esc(l.desc))}</div>`:''}
      <div class="link-card-footer">${l.category?`<span class="badge badge-blue">${esc(l.category)}</span>`:''}
        <div class="link-card-actions"><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('${escA(l.url)}')">Copy</button><button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();removeProjLink('${l.id}')">Del</button></div>
      </div>
    </div>`).join('');
}
function openProjLinkModal() {
  editingLinkId = null;
  document.getElementById('link-modal-title').textContent = 'Add Link';
  document.getElementById('lm-title').value='';document.getElementById('lm-url').value='';document.getElementById('lm-category').value='';document.getElementById('lm-desc').value='';
  document.getElementById('link-modal').classList.add('open');
}
function removeProjLink(id) { const l = S.links.find(x=>x.id==id); if(l) { l.projectId=null; save(); renderProjLinks(); toast('Removed from project'); }}

// Project Modal
function openNewProjectModal() { editingProjectId=null; document.getElementById('project-modal-title').textContent='New Project'; document.getElementById('pm-name').value=''; document.getElementById('pm-icon').value='folder'; document.getElementById('pm-status').value='active'; document.getElementById('pm-color').value='#4ade80'; updatePmIconPreview(); updatePmColorSelection(); document.getElementById('project-modal').classList.add('open'); setTimeout(()=>document.getElementById('pm-name').focus(),100); }
function editProject() {
  const p = getProject(activeProject);
  if(!p) return;
  editingProjectId = p.id;
  document.getElementById('project-modal-title').textContent = 'Edit Project';
  document.getElementById('pm-name').value = p.name;
  document.getElementById('pm-icon').value = p.icon;
  document.getElementById('pm-status').value = p.status;
  document.getElementById('pm-color').value = p.color;
  updatePmIconPreview();
  updatePmColorSelection();
  document.getElementById('project-modal').classList.add('open');
}
function closeProjectModal() { document.getElementById('project-modal').classList.remove('open'); editingProjectId=null; }
function saveProject() {
  const name = document.getElementById('pm-name').value.trim();
  if(!name) { toast('Name required'); return; }
  const icon = document.getElementById('pm-icon').value;
  const status = document.getElementById('pm-status').value;
  const color = document.getElementById('pm-color').value;
  if(!S.projects) S.projects = [];
  if(editingProjectId) {
    const p = getProject(editingProjectId);
    if(p) { p.name=name; p.icon=icon; p.status=status; p.color=color; p.updated=new Date().toISOString(); }
  } else {
    const p = { id:'proj_'+Date.now(), name, icon, status, color, instructions:'', created:new Date().toISOString(), updated:new Date().toISOString() };
    S.projects.push(p);
    activeProject = p.id;
  }
  save(); closeProjectModal(); renderProjectsSidebar();
  if(activeProject) { openProject(activeProject); }
  toast(editingProjectId?'Updated':'Created');
}
function archiveProject() {
  const p = getProject(activeProject);
  if(!p) return;
  if(!confirm('Archive "'+p.name+'"? This marks it as complete.')) return;
  p.status = 'complete';
  save(); renderProjectsSidebar(); renderProjectView(); toast('Archived');
}
function updatePmIconPreview() {
  const icon = document.getElementById('pm-icon').value;
  const color = document.getElementById('pm-color').value;
  document.getElementById('pm-icon-preview').innerHTML = getIconSVG(icon, 20);
  document.getElementById('pm-icon-preview').style.color = color;
}
function setPmColor(c) { document.getElementById('pm-color').value=c; updatePmColorSelection(); updatePmIconPreview(); }
function updatePmColorSelection() {
  const c = document.getElementById('pm-color').value;
  document.querySelectorAll('.pm-color-opt').forEach(el => { el.classList.toggle('selected', el.dataset.color===c); });
}

// Icon Picker
function openIconPicker() {
  const grid = document.getElementById('icon-picker-grid');
  const current = document.getElementById('pm-icon').value;
  grid.innerHTML = ICON_KEYS.map(k => `<div class="icon-picker-item ${k===current?'selected':''}" onclick="selectIcon('${k}')" title="${k}">${getIconSVG(k,18)}</div>`).join('');
  document.getElementById('icon-picker-modal').classList.add('open');
}
function closeIconPicker() { document.getElementById('icon-picker-modal').classList.remove('open'); }
function selectIcon(k) {
  document.getElementById('pm-icon').value = k;
  updatePmIconPreview();
  document.querySelectorAll('.icon-picker-item').forEach(el => el.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  closeIconPicker();
}

// Image paste handler
document.addEventListener('paste', e => {
  if(!document.getElementById('kb-modal').classList.contains('open')) return;
  if(kbModalTab !== 'image') return;
  const items = e.clipboardData?.items;
  if(!items) return;
  for(let i=0; i<items.length; i++) {
    if(items[i].type.startsWith('image/')) {
      const file = items[i].getAsFile();
      if(file.size > 500*1024) { toast('Image too large (>500KB)'); return; }
      const reader = new FileReader();
      reader.onload = ev => { kbImageData = ev.target.result; document.getElementById('kbm-img-preview').style.display='block'; document.getElementById('kbm-img-preview-img').src=kbImageData; };
      reader.readAsDataURL(file);
      e.preventDefault();
      return;
    }
  }
});

// Seed projects
function seedProjects() {
  if(S._seeded) return;
  if(S.projects && S.projects.length) { S._seeded = true; return; }
  S.projects = [];
  S.knowledgeBase = [];
  const now = new Date().toISOString();

  // Project 1: SM App Rebuild
  const smApp = {
    id: 'proj_sm_app', name: 'SM App Rebuild', icon: 'code', status: 'active', color: '#8b5cf6',
    instructions: '<h1>SM App Rebuild - Developer Situation</h1><h2>Vision</h2><p>"Ableton of Movement" - a movement composition app that treats movement like music production.</p><h2>For Tomorrow\'s Developer Call</h2><p><b>Primary Objectives:</b></p><ol><li>Clarify codebase ownership</li><li>Understand current deployment pipeline</li><li>Define handoff requirements</li><li>Establish realistic timeline</li></ol><h2>Key Questions</h2><ol><li>Where does the current codebase live?</li><li>What\'s the deployment process?</li><li>What do we need from them to take over?</li><li>What\'s the minimum viable handoff?</li><li>Are there vendor lock-ins or proprietary dependencies?</li></ol><h2>Assets You OWN</h2><ul><li>Domain: saturnomovement.com (admin@saturnomovement.com, Cloudflare, 2FA)</li><li>Stripe: Verified owner, 2FA + authenticator, payouts to your bank</li><li>Vimeo: Company email + card, all videos accessible</li><li>iOS Developer Account: Transferred to admin@saturnomovement.com</li><li>GitHub: sm-app-copy-v1 (your clone of the codebase)</li><li>Cloudflare: Full admin access, 2-step auth</li><li>Backups: Database and code fully backed up and cloned</li></ul><h2>What Softzee Still Controls</h2><ul><li>Server hosting (AWS, his infrastructure)</li><li>Original GitHub repo (Shajeel/sm-website-app)</li><li>Deployment pipeline</li><li>Android Keystore (.jks)</li><li>Backend environment variables and secrets</li></ul><h2>Financial Dispute</h2><ul><li>Phase 1: $35K agreed, $31.8K paid - COMPLETED</li><li>Website: $5K paid - COMPLETED</li><li>Phase 2: $30K agreed, $12.6K paid - 65% complete (Softzee\'s claim)</li><li>Softzee claims: $15.7K remaining</li><li>Softzee demands: Payment before full handover</li></ul><h2>App Tech Stack</h2><ul><li>Frontend: Next.js (App Router) + React/TypeScript</li><li>Backend: Node.js (Next.js API routes on AWS)</li><li>Payments: Stripe ($33.49/mo or $329/yr)</li><li>Video: Vimeo (300+ hours)</li><li>Mobile: React Native or native iOS/Android</li><li>Auth: Email, Google, Apple Sign-In</li><li>Programs: CF1-CF4, Yoga, Rings, Home (6+ programs)</li></ul><h2>Rebuild Timeline</h2><table><tr><th>Layer</th><th>Gabo + Claude</th><th>Junior Dev</th><th>Senior Dev</th></tr><tr><td>Landing Page</td><td>1-2 weeks</td><td>2-3 weeks</td><td>3-5 days</td></tr><tr><td>Web App</td><td>2-3 months</td><td>3-5 months</td><td>4-6 weeks</td></tr><tr><td>Mobile (PWA)</td><td>+2 weeks</td><td>+4 weeks</td><td>+1 week</td></tr></table><p><b>Recommendation:</b> PWA first (no App Store drama), native later.</p><h2>Strategic Recommendations</h2><ol><li>Don\'t pay remaining $15.7K until full handover</li><li>Ship bonus.saturnomovement.com FIRST - revenue TODAY</li><li>Landing page can be rebuilt in a weekend</li><li>Study sm-app-copy-v1: map database schema</li><li>Web app on managed stack: Vercel + Supabase</li></ol><h2>Gabo\'s Statement</h2><blockquote>"1 month ago was one thing, today.... I am confident I can build saturno movement app in a week if I wanted to even if I didn\'t have the source code, which I do."</blockquote>',
    created: now, updated: now
  };
  S.projects.push(smApp);

  // KB items for SM App
  S.knowledgeBase.push(
    { id:'kb_dev_call', projectId:'proj_sm_app', name:'Developer Call Prep - TOMORROW', type:'md', storage:'inline',
      content:'# Developer Call Prep Doc\nDate: Tomorrow\nWith: Softzee team\nGoal: Understand ownership, get access, define handoff\n\n## BEFORE THE CALL\n- [ ] Confirm repo access\n- [ ] List all services/APIs the app uses\n- [ ] Identify hosting/deployment setup\n- [ ] Review contracts\n\n## QUESTIONS TO ASK\n### Ownership & Access\n1. "What parts of the codebase are proprietary vs ours?"\n2. "Can we get full repo access today?"\n3. "Who has admin access to deployment platforms?"\n\n### Technical Architecture\n4. "What third-party services does this rely on?"\n5. "Walk me through how updates get pushed live"\n6. "What\'s the database situation?"\n\n### Handoff\n7. "What\'s the cleanest path to us taking over?"\n8. "What documentation exists?"\n9. "Can you do a recorded walkthrough of the codebase?"\n\n## RED FLAGS\n- Vague answers about ownership\n- Reluctance to share repo access\n- Hidden dependencies or vendor lock-in\n- No documentation\n- "It\'s complicated" without specifics\n\n## IDEAL OUTCOME\n- Full repo access granted\n- Clear list of all dependencies\n- Written handoff timeline with milestones\n- Recorded architecture walkthrough scheduled\n\n## NOTES DURING CALL\n(Fill in during the call)\n### What we learned:\n### Action items:\n### Follow-up needed:',
      description:'Prep doc for developer call - questions, red flags, ideal outcomes', tags:['developer','call','prep','priority'], created:now, updated:now },
    { id:'kb_app_vision', projectId:'proj_sm_app', name:'App Vision - Ableton of Movement', type:'md', storage:'inline',
      content:'# Saturno Movement App Vision\n\n## The Concept\n"Ableton of Movement" - treat movement composition like music production.\n\n## Core Metaphor\n| Music (Ableton) | Movement (SM App) |\n|---|---|\n| Tracks | Movement sequences |\n| Clips | Individual exercises |\n| Arrangement | Workout flow |\n| Effects | Progressions/regressions |\n| Tempo | Pace/rest intervals |\n| Mix | Balance of modalities |\n\n## Key Features\n1. Drag-and-drop workout builder\n2. Movement library (video clips)\n3. Progression paths\n4. Templates\n5. Export (to PDF, video, calendar)\n\n## Differentiators\n- Not just "pick exercises" - COMPOSE movement\n- Visual timeline interface\n- Modular, remixable workouts',
      description:'The Ableton of Movement vision for the app', tags:['vision','product','app'], created:now, updated:now },
    { id:'kb_softzee', projectId:'proj_sm_app', name:'Softzee Situation Summary', type:'md', storage:'inline',
      content:'# Softzee Situation\n\n## What We Need to Clarify\n1. Code ownership - Do we own the codebase?\n2. Data ownership - User data, content, analytics\n3. Deployment control - Can we deploy without them?\n4. Dependencies - What breaks if we part ways?\n\n## Possible Outcomes\n### Best Case\nFull handoff, clean break, documentation provided.\n### Acceptable Case\nTransition period, they support handoff.\n### Worst Case\nVendor lock-in, need full rebuild.\n\n## Decision Framework\nIf handoff cost > rebuild cost: REBUILD\nIf handoff time > 3 months: CONSIDER REBUILD\nIf trust is broken: REBUILD',
      description:'Summary of the developer situation', tags:['softzee','developer','situation'], created:now, updated:now },
    { id:'kb_rescue_docs', projectId:'proj_sm_app', name:'Rescue Docs (iCloud)', type:'pdf', storage:'reference',
      content:null, filePath:'~/Library/Mobile Documents/com~apple~CloudDocs/00_AI_HUB/\u{1F6A8}sm-app--rescue/', url:null,
      description:'Security audit, action plan, final dossier, iOS rebuild checklist, conversation export, bug list - all in iCloud', tags:['legal','developer','security'], created:now, updated:now }
  );

  // Project 2: Saturno Bonus
  const bonus = {
    id: 'proj_saturno_bonus', name: 'Saturno Bonus', icon: 'gift', status: 'active', color: '#4ade80',
    instructions: '<h1>Saturno Bonus - Customer Bonus Vault</h1><h2>Purpose</h2><p>Customer-facing bonus page with tools, music, and CF4 content for BF25 buyers.</p><h2>Deployment</h2><table><tr><th>Environment</th><th>URL</th><th>Status</th></tr><tr><td>Production</td><td>saturno-bonus-omega.vercel.app</td><td>LIVE (verified Feb 16)</td></tr><tr><td>Custom Domain</td><td>bonus.saturnomovement.com</td><td>PENDING (Cloudflare CNAME)</td></tr><tr><td>Repo</td><td>github.com/gabosaturno11/saturno-bonus</td><td>Private</td></tr></table><h2>Repository Structure</h2><pre>~/dev/saturno-bonus/\n  index.html          (main bonus page ~1,720 lines)\n  gate.html           (password gate)\n  experience.html     (8-zone scrolling journey)\n  admin.html          (SATURNO COMMAND dashboard)\n  api/                (config, admin-verify, brevo, verify)\n  tools/              (60 HTML tools - top level)\n  pdfs/               (15 PDFs - top level)\n  audio/              (36 tracks - gitignored, needs CDN)\n  music/              (gitignored)\n  video/              (app-promo.mp4 - gitignored)\n  assets/             (logos, css, js)\n  manifest.json       (PWA)\n  middleware.js       (auth protection)</pre><h2>Current Status (Feb 16)</h2><ul><li>LIVE: gate 200, index 302 (auth), tools 302 (auth)</li><li>44 tools visible (19 training + 25 experience), 3 internal hidden</li><li>15 PDFs, 36 tracks in music player</li><li>All FORGE refs removed, fully rebranded to VAULT</li><li>All 60 tools: Sora font, #050711 bg, vault back button</li><li>62 tool+PDF paths verified - zero broken references</li><li>Galaxy zoom with photorealistic canvas planet textures</li></ul><h2>Blockers (need Gabo)</h2><ul><li>Domain: bonus.saturnomovement.com CNAME in Cloudflare</li><li>Brevo: BREVO_API_KEY + BREVO_LIST_ID in Vercel env</li><li>Auth: VAULT_PASSWORD + VAULT_TOKEN in Vercel env</li><li>Audio CDN solution (audio/ is gitignored)</li><li>Physical device testing (mobile/tablet)</li></ul><h2>Domain Setup</h2><p>Gabo adds CNAME in Cloudflare: <code>bonus</code> -> <code>cname.vercel-dns.com</code></p><p>Then run: <code>vercel domains add bonus.saturnomovement.com</code></p>',
    created: now, updated: now
  };
  S.projects.push(bonus);

  S.knowledgeBase.push(
    { id:'kb_bonus_deploy', projectId:'proj_saturno_bonus', name:'Deployment Status', type:'md', storage:'inline',
      content:'# Deployment Status\nLive URL: saturno-bonus-omega.vercel.app\nRepo: github.com/gabosaturno11/saturno-bonus\nLatest commit: 856ca02 (Feb 16 cleanup)\n\n## Verified (Feb 16)\n- gate.html: 200 (public)\n- index.html: 302 (auth redirect, correct)\n- tools/*: 302 (auth redirect, correct)\n- ASTRA: 200\n\n## Checklist\n- [x] Vercel deployed (200)\n- [x] GitHub repo (private)\n- [x] All paths remapped (150+ refs)\n- [x] titan-forge refs removed from customer-facing files\n- [x] FORGE -> VAULT branding complete (nav, titles, PDF headers)\n- [x] 62 tool+PDF paths verified (zero broken)\n- [x] All 60 tools: Sora font, #050711 bg, vault back button\n- [x] Galaxy zoom photorealistic planets (canvas textures)\n- [x] THE BOOK removed from Coming Soon\n- [x] Audio error graceful (Streaming coming soon)\n- [x] 15 PDFs on disk match JS data\n- [x] 36 tracks in music player match data\n- [x] 44 tools visible (19 training + 25 experience)\n- [x] 3 internal tools hidden\n- [ ] Custom domain (bonus.saturnomovement.com)\n- [ ] Brevo email capture (needs env vars)\n- [ ] VAULT_PASSWORD + VAULT_TOKEN env vars\n- [ ] Audio CDN solution\n- [ ] Physical device testing',
      description:'Current deployment status and verified checklist', tags:['deployment','vercel','status','verified'], created:now, updated:now },
    { id:'kb_bonus_shipping', projectId:'proj_saturno_bonus', name:'Shipping Plan', type:'md', storage:'inline',
      content:'# Shipping Plan\n\n## Phase 1: Sample Quality Bar\n- ONE sample tool (template for quality)\n- ONE sample PDF (conversion template)\n- Music source locations identified\n\n## Phase 2: Batch Production\n- 100 tools audited and fixed\n- 100 PDFs generated (transcript-to-PDF tool)\n- Music organized into album subfolders with artwork\n\n## Phase 3: Assembly\n- All content wired into bonus page\n- Brevo email capture connected\n- Video embedded\n- Final QA\n\n## Phase 4: Launch\n- Deploy to bonus.saturnomovement.com\n- Email BF25 customers\n- Monitor analytics',
      description:'The shipping plan for bonus page launch', tags:['shipping','plan','priority'], created:now, updated:now }
  );

  // Project 3: Book (AOC)
  S.projects.push({
    id:'proj_book', name:'Book (AOC)', icon:'book', status:'active', color:'#f59e0b',
    instructions:'<h1>The Art of Calisthenics - Book Submission</h1><h2>Publisher</h2><p>Victory Belt Publishing - $20K advance</p><h2>Status</h2><p>Approved, pending submission of final package.</p><h2>Submission Package</h2><ul><li>Introductory Letter</li><li>Expanded TOC</li><li>Sample Chapters (Ch 1, 2, 11)</li><li>Overview Document</li></ul><h2>Location</h2><p><code>~/Downloads/_ORGANIZED/aoc-book/</code></p><h2>Current Blocker</h2><p>Organization, not creation. Content EXISTS.</p>',
    created:now, updated:now
  });

  // Project 4: HBS Program
  S.projects.push({
    id:'proj_hbs', name:'HBS Program', icon:'target', status:'paused', color:'#06b6d4',
    instructions:'<h1>Handbalancing System (HBS)</h1><h2>Solar System Progression</h2><ul><li>SUN: Foundation (wrist, shoulder, core)</li><li>MERCURY: Wall Work</li><li>VENUS: Kick-Up</li><li>EARTH: Balance (freestanding)</li><li>MARS: Shapes</li><li>JUPITER: Press</li><li>SATURN: One-Arm (mastery)</li></ul><h2>Location</h2><p><code>/Volumes/SSK Drive/HBS/</code> (8.3GB)</p><h2>Status</h2><p>Filming mode. Content exists on SSK Drive.</p>',
    created:now, updated:now
  });

  // Project 5: De Aqui a Saturno
  S.projects.push({
    id:'proj_karina', name:'De Aqui a Saturno', icon:'heart', status:'complete', color:'#ec4899',
    instructions:'<h1>De Aqui a Saturno</h1><h2>Valentine\'s Day Experience for Karina</h2><p>Crystal cosmic scroll experience: gate -> 18 chapters -> epic end -> 11 love dimensions -> finale</p><h2>Deployment</h2><ul><li>Live: de-aqui-a-saturno.vercel.app</li><li>Repo: github.com/gabosaturno11/de-aqui-a-saturno (private)</li></ul><h2>Features</h2><ul><li>Real piano audio (dual-track crossfade)</li><li>Real couple videos</li><li>Glassmorphism, ambient orbs, star parallax</li><li>11 love dimensions with unique SVG icons</li><li>KS monogram in finale</li><li>Hidden alien Easter egg</li></ul><p><b>Gabo\'s reaction:</b> "dude wtf I am crying" / "the UI is INSANE"</p>',
    created:now, updated:now
  });

  // Project 6: Claude Code (The Kernel)
  S.projects.push({
    id:'proj_claude_code', name:'Claude Code', icon:'terminal', status:'active', color:'#a78bfa',
    instructions:'<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div><h1>Claude Code - Session Continuity Kernel</h1><h2>Purpose</h2><p>This project is the SINGLE SOURCE OF TRUTH for every Claude Code session. Any new Claude reads this project first and knows exactly what to do without asking Gabo.</p><h2>Rules That NEVER Change</h2><ol><li>~/dev/ is canonical for ALL repos - NOT Desktop, NOT iCloud</li><li>NO DELETE - archive, never delete</li><li>Every Gabo message -> save to backend as-is (project/title/text)</li><li>Commit + deploy after EVERY meaningful change</li><li>Dark theme only, no emojis in code</li><li>Custom over SaaS, always</li><li>DO NOT ASK GABO - read the logs and specs, then execute</li></ol><h2>Active Repos</h2><table><tr><th>Repo</th><th>Local</th><th>Live</th></tr><tr><td>astra-command-center</td><td>~/dev/astra-command-center/</td><td>astra-command-center-sigma.vercel.app</td></tr><tr><td>titan-forge</td><td>~/dev/titan-forge/</td><td>titan-forge-ten.vercel.app</td></tr><tr><td>saturno-bonus</td><td>~/dev/saturno-bonus/</td><td>saturno-bonus-omega.vercel.app</td></tr><tr><td>de-aqui-a-saturno</td><td>~/dev/de-aqui-a-saturno/</td><td>de-aqui-a-saturno-jet.vercel.app</td></tr></table><h2>Machine Context</h2><ul><li>C2 iMac: username Gabosaturno (CAPITAL G)</li><li>C1 MacBook Pro: username gabosaturno (lowercase)</li><li>GitHub: gabosaturno11</li><li>titan-forge is 3.1GB - deploy via rsync to /tmp/ (exclude music/audio/video/.git)</li></ul><h2>Design Constraints</h2><ul><li>Pure black backgrounds (#000000 or #09090b)</li><li>Purple-blue accents (#6c3aff or #8b5cf6)</li><li>Cyan secondary (#00CFFF or #22d3ee)</li><li>Mint green for ASTRA (#4ade80)</li><li>Sora font for customer pages</li><li>Dark theme ONLY</li></ul><h2>Gabo Context</h2><ul><li>Running company ALONE - 3 clients, immigration, finances, 2 companies, book deadline</li><li>Developer LEFT - building everything solo with Claude</li><li>Does NOT want to babysit Claude - autonomous plans that run for hours</li><li>DURABILITY over speed - things that LAST</li></ul><h2>How to Use This Project</h2><p>1. Export this project as MD (click Export button above)</p><p>2. The exported file goes to the local repo as CLAUDE.md</p><p>3. Next Claude Code session reads it automatically</p><p>4. Update KB items below as state changes</p>',
    created:now, updated:now
  });

  // Project 7: Nexus Capture (Extension + Private Founder Space)
  S.projects.push({
    id:'proj_nexus_capture', name:'Nexus Capture', icon:'zap', status:'active', color:'#06b6d4',
    instructions:'<h1>Nexus Capture</h1><h2>Chrome Extension + Private Founder OS</h2><p>Universal highlight capture extension that routes to ASTRA backend. Currently unpacked/local only (not on Chrome Web Store).</p><h2>Extension</h2><ul><li>Repo: ~/dev/nexus-capture/</li><li>Manifest V3, 8 categories: idea, quote, code, insight, todo, book, research, thought</li><li>Keyboard shortcut: Cmd+Shift+S</li><li>Routes captures to astra-command-center-sigma.vercel.app/api/capture</li><li>Auth: Bearer token (ASTRA_ADMIN_PASSWORD)</li></ul><h2>Future: Private Founder Space</h2><p>A minimalistic, password-gated private space inside ASTRA for Gabo only. Alien SVG icon in corner as entry point. Behind auth wall.</p><h3>Vision</h3><ul><li>Extension captures land here first (private inbox)</li><li>Content from SATURNO_CREATOR_HUB.html migrated in: captions vault, content vault, writing hub</li><li>Minimalistic version of victory-belt-cc tools</li><li>Test zone for new features before they go public</li><li>Eventually: sellable Founder OS product (non-developer friendly)</li></ul><h3>Source Reference</h3><ul><li>SATURNO_CREATOR_HUB.html: ~/Desktop/CLAUDE NOT HERE/NOT A DEPLOYMENT ZONE/victory-belt-cc/SATURNO_CREATOR_HUB.html</li><li>Subpages: GABO_CONTENT_VAULT.html, GABO_ARCHIVE_VAULT.html, GABO_CAPTIONS_CATEGORIZED.csv, SATURNO_WRITING_HUB.html, SATURNO_PROGRESSION_TRACKER.html, FOCUS_TIMER.html</li></ul><h3>Design</h3><ul><li>Dark theme, minimal, alien SVG motif</li><li>Password-gated (separate from ASTRA admin)</li><li>Toggle ON/OFF for extension routing</li></ul><h2>Chrome Web Store</h2><p>NOT published yet. Needs: $5 dev account, privacy policy, configurable backend URL, review process. For now: unpacked extension on C2 iMac only.</p><h2>ASTRA as Product</h2><p>ASTRA has potential as a sellable Founder OS. Non-developer friendly. Once polished, this becomes a product for founders who want a command center without code.</p>',
    created:now, updated:now
  });
  S.knowledgeBase.push(
    { id:'kb_nexus_vision', projectId:'proj_nexus_capture', name:'Nexus Capture + Founder OS Vision', type:'md', storage:'inline',
      content:'# Nexus Capture + Private Founder Space\n\n## Current State (Feb 19, 2026)\n- Chrome extension: LOCAL ONLY (unpacked, dev mode)\n- Captures route to ASTRA API with Bearer auth\n- All API endpoints locked (GET and POST require auth)\n- Not on Chrome Web Store\n\n## Gabo Vision (Feb 19)\n> "set up a private place just for me... minimalistic alien svg on some corner... my FULLY private space aside from this convo so I can test shit or eventually with the extension that would be the place"\n> "ASTRA has so much potential for a founder OS selling standpoint that once it turns into the beast it is becoming, we will sell it"\n> "treat it as a place for a founder that is a non-developer"\n\n## Future Extension Flow\n1. Extension has password/PIN screen on first use\n2. Once unlocked: toggle "Send to ASTRA" ON/OFF\n3. When ON: captures go to private ASTRA backend (Bearer auth)\n4. When OFF: captures stay local\n\n## Private Space Features (from Creator Hub)\n- Captions vault (GABO_CAPTIONS_CATEGORIZED.csv)\n- Content vault (GABO_CONTENT_VAULT.html)\n- Writing hub (SATURNO_WRITING_HUB.html)\n- Progression tracker\n- Focus timer\n- Archive vault\n- All minimalistic, dark theme, behind auth wall\n\n## Chrome Web Store Checklist\n- [ ] $5 developer account\n- [ ] Privacy policy page\n- [ ] Make backend URL configurable (not hardcoded)\n- [ ] Remove any hardcoded secrets\n- [ ] Submit for review\n\n## Product Potential\nASTRA as Founder OS: command center for non-developers.\nExtension as capture layer. Private space as inbox.\nSell as SaaS once polished.',
      description:'Full vision doc for Nexus Capture extension and private founder space', tags:['nexus','extension','founder-os','vision','product'], created:now, updated:now },
    { id:'kb_nexus_security', projectId:'proj_nexus_capture', name:'API Security Audit (Feb 19)', type:'md', storage:'inline',
      content:'# ASTRA API Security Audit - Feb 19, 2026\n\n## All Endpoints Locked\n| Endpoint | GET | POST |\n|----------|-----|------|\n| /api/state | 401 | 401 |\n| /api/capture | 401 | 401 |\n| /api/transcripts | 401 | 401 |\n| /api/pipeline | 401 | 401 |\n| /api/transcribe | N/A | 401 |\n| /api/query | N/A | 401 |\n| /api/health | 200 (public, safe) | N/A |\n\n## Auth Method\nBearer token via ASTRA_ADMIN_PASSWORD env var in Vercel.\nFrontend stores password in localStorage, prompts once.\nExtension sends same Bearer header.\n\n## Why NOT Vercel Deployment Protection\nWould block extension and scripts (no interactive session cookie).\nBearer token auth is machine-friendly and works everywhere.\n\n## Commits\n- a50cf35: Remove hardcoded password\n- 0dba84c: Fix capture.js auth\n- 02ad39a: Lock pipeline/transcribe/query\n- 5ac20fa: Lock GET endpoints (state/capture/transcripts)',
      description:'Security audit showing all endpoints locked', tags:['security','api','audit'], created:now, updated:now }
  );

  // KB items for Claude Code project
  S.knowledgeBase.push(
    { id:'kb_cc_session_log', projectId:'proj_claude_code', name:'Session Log - Feb 16 Cleanup', type:'md', storage:'inline',
      content:'# Session Log - Feb 16, 2026 (Autonomous Cleanup)\n\n## 9-Phase Cleanup Completed\nGabo left for 2 hours. Claude ran autonomous 9-phase cleanup across both repos.\n\n### saturno-bonus (9 commits)\n1. Galaxy zoom: photorealistic canvas planet textures, sun corona, Saturn rings\n2. Bigger planets + wider orbits for visible detail\n3. Broken links fixed (deleted PDF, nonexistent onboarding/studio/hub/command pages)\n4. titan-forge refs updated to saturno-bonus in nexus, master-hub, package-lock\n5. Nav labels FORGE -> VAULT in 9 tool files\n6. UX: THE BOOK removed from Coming Soon, audio error msg improved\n7. Page titles: 7 files SATURNO FORGE -> SATURNO VAULT\n8. PDF headers: titan.html + batch-generator.html FORGE -> VAULT\n9. constellation-builder.html: JetBrains Mono -> Sora in canvas\n\n### astra-command-center (2 commits)\n1. ASTRA seed data: 8 URL/path inconsistencies fixed (-omega, -sigma, stale counts)\n2. Cleanup log added to logs/\n\n## Quality Audit Results\n- 62/62 tool+PDF paths verified — ZERO broken references\n- 6 training tools deep-audited — all production-ready\n- 6 experience tools deep-audited — all production-ready\n- All 60 tools: Sora font, #050711 bg, vault back button\n- Deploy verified: gate 200, index 302, tools 302, ASTRA 200\n\n## Git State\n- saturno-bonus: CLEAN, latest `856ca02`\n- astra-command-center: CLEAN, latest `65f8293`\n- 30 messages in backend (ids -1 to 29)\n\n## Remaining (needs Gabo)\n- Brevo env vars, VAULT_PASSWORD/TOKEN, domain CNAME, audio CDN, device testing',
      description:'Feb 16 autonomous cleanup session results', tags:['session','log','cleanup','state'], created:now, updated:now },
    { id:'kb_cc_gabo_rules', projectId:'proj_claude_code', name:'Gabo Rules (Permanent)', type:'md', storage:'inline',
      content:'# Rules That Never Change\n\n1. ~/dev/ is canonical for ALL repos\n2. NO DELETE - archive only\n3. Every Gabo message -> backend as-is\n4. Commit + deploy after EVERY change\n5. Dark theme only\n6. Custom over SaaS\n7. DO NOT ASK - read logs, execute\n8. BOOK FIRST (Goal 1 priority)\n9. Desktop is NOT a battlefield\n10. planet-logo.png is THE logo (white planet silhouette)\n11. Audio 404s on Vercel (gitignored) - needs CDN\n12. Brevo email needs BREVO_API_KEY + BREVO_LIST_ID in Vercel env\n13. CONNECT dont build - 150+ tools exist\n14. Save context aggressively - 9-hour sessions are normal',
      description:'Permanent rules that never change across sessions', tags:['rules','permanent','kernel'], created:now, updated:now },
    { id:'kb_cc_messages', projectId:'proj_claude_code', name:'Gabo Messages Backend', type:'md', storage:'inline',
      content:'# Gabo Messages Backend\n\n**Location:** ~/dev/saturno-bonus/logs/gabo-messages.json\n\n## Messages (30 total, ids -1 to 29)\n- #-1: READ ALL MESSAGES (pinned)\n- #0: NORTH STAR (pinned)\n- #1-7: Shipping plan, decouple, ASTRA upgrade, specs, GO BUILD (Feb 14-15)\n- #8-16: Session start, goal 1 continuity, every change commit, how plan fails, 8h infallible, claimed done too early, fix kernel, 40-item TODO, save specs in logs (Feb 16 AM)\n- #17-23: Fix continuity, system didnt work, titan-forge confirms pattern, no clue, calendar fixed, do not build save msgs only, prove you wrong (Feb 16 PM)\n- #24-29: Galaxy zoom planets, speed priority, full deployment audit, ASTRA consistency audit, 2h autonomous cleanup, save fix script (Feb 16 EVE)\n\n## Rule\nDefault = save EVERY message Gabo sends.\nOnly skip if Gabo says "dont save".',
      description:'Backend message log tracking - 30 messages', tags:['messages','backend','log'], created:now, updated:now },
    { id:'kb_cc_handoff', projectId:'proj_claude_code', name:'Next Claude Handoff (copy-paste)', type:'md', storage:'inline',
      content:'# Next Claude Handoff\n\nPaste this into a new Claude Code session:\n\n```\nRead ~/dev/saturno-bonus/CLAUDE.md and ~/dev/astra-command-center/CLAUDE.md, then ~/dev/saturno-bonus/logs/gabo-messages.json. ASTRA live: astra-command-center-sigma.vercel.app — Bonus live: saturno-bonus-omega.vercel.app. Don\'t ask where we are.\n```\n\n## Live URLs\n- **ASTRA:** https://astra-command-center-sigma.vercel.app\n- **Bonus (gate):** https://saturno-bonus-omega.vercel.app/gate.html\n- **Bonus password:** saturno2025\n\n## Local Paths\n- `~/dev/saturno-bonus/` — THE bonus page repo\n- `~/dev/astra-command-center/` — ASTRA command center\n- `~/dev/titan-forge/` — internal tools (bonus MOVED OUT)\n- `~/dev/de-aqui-a-saturno/` — Valentine\'s experience\n\n## Files Next Claude MUST Read\n1. `~/.claude/CLAUDE.md` — global kernel (auto-loaded)\n2. `~/.claude/projects/-Users-Gabosaturno/memory/MEMORY.md` — session state (auto-loaded)\n3. `~/dev/saturno-bonus/CLAUDE.md` — bonus project state\n4. `~/dev/saturno-bonus/logs/gabo-messages.json` — 31 messages, real context\n5. `~/dev/astra-command-center/CLAUDE.md` — ASTRA project state\n\n## GitHub\n- Account: gabosaturno11\n- All repos private\n- Deploy: git push main -> Vercel auto-deploys\n\n## Git Email\ngabo@saturnomovement.com (all repos)',
      description:'Copy-paste handoff block for next Claude Code session', tags:['handoff','next-claude','code','copy-paste'], created:now, updated:now }
  );
  S._seeded = true;
}

// Handle KB drop on whiteboard
function handleWbDrop(e) {
  const data = e.dataTransfer?.getData('text/plain');
  if(data && data.startsWith('kb:')) {
    e.preventDefault();
    const kbId = data.replace('kb:','');
    const k = (S.knowledgeBase||[]).find(x=>x.id===kbId);
    if(!k) return;
    const p = wbScreenToCanvas(e.clientX, e.clientY);
    const typeColors = {md:'#3b82f6',pdf:'#ef4444',img:'#22c55e',url:'#8b5cf6',txt:'#6b7280',json:'#eab308',other:'#6b7280'};
    const n = wbAddNode(p.x-80, p.y-40, '['+k.type.toUpperCase()+'] '+k.name, k.description||'', typeColors[k.type]||'#3b82f6', 200, 90);
    n.docRef = kbId;
    n.docType = k.type;
    wbSaveState();
    toast('Added to whiteboard');
  }
}

// projectId assignment for links is handled directly in saveLink()

// === GLOBAL ===
function exportAll(){snapshotWriter();snapshotSpec();if(activeProject){const p=getProject(activeProject);if(p){p.instructions=document.getElementById('proj-instructions-editor')?.innerHTML||p.instructions;}}const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-hub-'+new Date().toISOString().split('T')[0]+'.json';a.click();toast('Exported');}
function exportSummary(){
  snapshotWriter();snapshotSpec();
  const today=new Date().toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const done=S.tasks.filter(t=>t.status==='done');
  const overdue=active.filter(t=>t.due&&t.due<today);
  const priorities={p0:active.filter(t=>t.priority==='p0').length,p1:active.filter(t=>t.priority==='p1').length,p2:active.filter(t=>t.priority==='p2').length,p3:active.filter(t=>t.priority==='p3').length};
  let md='# SATURNO HUB Summary\n';
  md+=`**Generated:** ${new Date().toLocaleString()}\n\n`;
  md+='---\n\n## Tasks\n';
  md+=`- **Active:** ${active.length} | **Done:** ${done.length} | **Overdue:** ${overdue.length}\n`;
  md+=`- **By Priority:** P0=${priorities.p0} P1=${priorities.p1} P2=${priorities.p2} P3=${priorities.p3}\n\n`;
  if(overdue.length){md+='### Overdue\n';overdue.forEach(t=>{md+=`- [${t.priority||'p2'}] ${t.title} (due ${t.due})\n`;});md+='\n';}
  const todayTasks=active.filter(t=>t.due===today);
  if(todayTasks.length){md+='### Due Today\n';todayTasks.forEach(t=>{md+=`- [${t.priority||'p2'}] ${t.title}\n`;});md+='\n';}
  md+='## Content\n';
  md+=`- **Items:** ${S.content.length}\n`;
  const totalW=S.content.reduce((s,c)=>(c.body||'').trim().split(/\s+/).filter(x=>x.length).length+s,0);
  md+=`- **Total words:** ${totalW.toLocaleString()}\n\n`;
  md+='## Documents\n';
  md+=`- **Writer docs:** ${(S.docs||[]).length}\n`;
  md+=`- **Living Docs:** ${(S.specs||[]).length}\n\n`;
  md+='## Links\n';
  md+=`- **Total:** ${(S.links||[]).length}\n`;
  const cats=[...new Set((S.links||[]).map(l=>l.category).filter(Boolean))];
  if(cats.length)md+=`- **Categories:** ${cats.join(', ')}\n`;
  md+='\n## Projects\n';
  (S.projects||[]).forEach(p=>{
    const pt=S.tasks.filter(t=>(t.projectId||t.project)===p.id);
    const pa=pt.filter(t=>t.status!=='done').length;
    md+=`- **${p.name}** (${p.status||'active'}) — ${pa} active tasks\n`;
  });
  md+='\n## Repos\n';
  (S.repos||[]).forEach(r=>{md+=`- ${r.name} — ${r.live||'no live URL'} (${r.status||'unknown'})\n`;});
  md+='\n---\n*Exported from SATURNO HUB*\n';
  navigator.clipboard.writeText(md).then(()=>toast('Summary copied to clipboard')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-summary-'+today+'.md';a.click();toast('Summary downloaded');
  });
}
function dailyDashboard(){
  const today=new Date().toISOString().split('T')[0];
  const todayLabel=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const active=S.tasks.filter(t=>t.status!=='done');
  const overdue=active.filter(t=>t.due&&t.due<today);
  const dueToday=active.filter(t=>t.due===today);
  const inProgress=active.filter(t=>t.status==='progress');
  const blocked=active.filter(t=>t.status==='blocked');
  const doneToday=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at&&e.at.startsWith(today)));
  const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString()));
  let md='# Daily Dashboard: '+todayLabel+'\n\n';
  md+='## Priority Focus\n';
  if(overdue.length){md+='### OVERDUE ('+overdue.length+')\n';overdue.forEach(t=>md+='- ['+t.priority+'] '+t.title+' (due '+t.due+')\n');md+='\n';}
  if(dueToday.length){md+='### Due Today ('+dueToday.length+')\n';dueToday.forEach(t=>md+='- ['+t.priority+'] '+t.title+(t.project?' ['+t.project+']':'')+'\n');md+='\n';}
  if(inProgress.length){md+='### In Progress ('+inProgress.length+')\n';inProgress.forEach(t=>md+='- '+t.title+(t.timeStarted?' (timer running)':'')+(t.estimate?' ~'+t.estimate:'')+'\n');md+='\n';}
  if(blocked.length){md+='### Blocked ('+blocked.length+')\n';blocked.forEach(t=>md+='- '+t.title+(t.blockedBy?' (by: '+t.blockedBy+')':'')+'\n');md+='\n';}
  md+='## Stats\n';
  md+='- Tasks: '+active.length+' active, '+doneToday.length+' done today, '+doneThisWeek.length+' done this week\n';
  md+='- Content: '+S.content.length+' items\n';
  md+='- Documents: '+S.docs.length+' docs, '+S.specs.length+' living docs\n';
  md+='- Links: '+S.links.length+'\n';
  const tracked=S.tasks.filter(t=>t.timeSpent||t.timeStarted);
  if(tracked.length){let total=0;tracked.forEach(t=>{let m=t.timeSpent||0;if(t.timeStarted)m+=Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);total+=m;});md+='- Time tracked: '+formatTimeSpent(total)+' across '+tracked.length+' tasks\n';}
  md+='\n---\n*Generated from SATURNO HUB*\n';
  navigator.clipboard.writeText(md).then(()=>toast('Daily dashboard copied to clipboard'));
}
function dataStats(){
  const raw=localStorage.getItem(SK)||'';const bytes=new Blob([raw]).size;const kb=(bytes/1024).toFixed(1);
  const taskBytes=new Blob([JSON.stringify(S.tasks)]).size;
  const contentBytes=new Blob([JSON.stringify(S.content)]).size;
  const docsBytes=new Blob([JSON.stringify(S.docs)]).size;
  const specsBytes=new Blob([JSON.stringify(S.specs||[])]).size;
  const linksBytes=new Blob([JSON.stringify(S.links)]).size;
  const kbBytes=new Blob([JSON.stringify(S.knowledgeBase||[])]).size;
  const format=b=>(b/1024).toFixed(1)+'KB';
  const msg=`Storage: ${kb}KB total\n\nTasks: ${S.tasks.length} items (${format(taskBytes)})\nContent: ${S.content.length} items (${format(contentBytes)})\nDocs: ${(S.docs||[]).length} items (${format(docsBytes)})\nSpecs: ${(S.specs||[]).length} items (${format(specsBytes)})\nLinks: ${S.links.length} items (${format(linksBytes)})\nKB: ${(S.knowledgeBase||[]).length} items (${format(kbBytes)})\nRepos: ${(S.repos||[]).length}\nProjects: ${(S.projects||[]).length}\nArchived: ${(S.archivedTasks||[]).length} tasks`;
  toast(msg.split('\n')[0]);
  navigator.clipboard.writeText(msg).then(()=>toast('Stats copied to clipboard'));
}
function timeReport(){
  const tracked=S.tasks.filter(t=>t.timeSpent||t.timeStarted);
  if(!tracked.length){toast('No tasks with tracked time');return;}
  let total=0;
  let md='# Time Report\n'+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n\n';
  tracked.sort((a,b)=>(b.timeSpent||0)-(a.timeSpent||0));
  tracked.forEach(t=>{
    let mins=t.timeSpent||0;
    if(t.timeStarted)mins+=Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);
    total+=mins;
    md+=`- **${t.title||'Untitled'}** (${t.status}) — ${formatTimeSpent(mins)}${t.project?' ['+t.project+']':''}\n`;
  });
  md+=`\n**Total tracked: ${formatTimeSpent(total)}** across ${tracked.length} tasks`;
  navigator.clipboard.writeText(md).then(()=>toast('Time report copied — '+formatTimeSpent(total)+' total'));
}
function importAll(){
  // Auto-backup before import (UNDO safety net)
  const backup = localStorage.getItem(SK);
  if(backup) { localStorage.setItem(SK+'_backup', backup); localStorage.setItem(SK+'_backup_time', new Date().toISOString()); }
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const f=e.target.files[0],r=new FileReader();r.onload=ev=>{try{S={content:[],tasks:[],links:[],docs:[],specs:[],activeDoc:null,activeSpec:null,whiteboard:{},projects:[],knowledgeBase:[],folders:[],...JSON.parse(ev.target.result)};if(!S.projects)S.projects=[];if(!S.knowledgeBase)S.knowledgeBase=[];save();renderProjectsSidebar();switchSection(currentSection||'content',document.querySelector('.sidebar-item.active'));toast('Imported (backup saved — click Undo Import to revert)');}catch(e){toast('Invalid JSON');}};r.readAsText(f);};inp.click();
}
function undoImport(){
  const backup = localStorage.getItem(SK+'_backup');
  if(!backup) { toast('No backup available'); return; }
  const time = localStorage.getItem(SK+'_backup_time');
  S = {content:[],tasks:[],links:[],docs:[],specs:[],activeDoc:null,activeSpec:null,whiteboard:{},projects:[],knowledgeBase:[],...JSON.parse(backup)};
  if(!S.projects)S.projects=[];if(!S.knowledgeBase)S.knowledgeBase=[];
  save();renderProjectsSidebar();switchSection('content',document.querySelector('.sidebar-item'));
  toast('Reverted to backup from '+(time||'unknown'));
}

// === PROJECT EXPORT ===
let exportMenuOpen = false;
function showExportMenu(e) {
  e.stopPropagation();
  if(exportMenuOpen) { closeExportMenu(); return; }
  const existing = document.querySelector('.export-menu');
  if(existing) existing.remove();
  const menu = document.createElement('div');
  menu.className = 'export-menu';
  menu.innerHTML = `
    <div class="export-menu-item" onclick="exportProjectMD()">
      <span class="export-icon">MD</span>
      <div><div class="export-menu-label">Markdown</div><div class="export-menu-desc">Full project as .md file</div></div>
    </div>
    <div class="export-menu-item" onclick="exportProjectJSON()">
      <span class="export-icon">{ }</span>
      <div><div class="export-menu-label">JSON</div><div class="export-menu-desc">Raw data for import</div></div>
    </div>
    <div class="export-menu-item" onclick="copyProjectMD()">
      <span class="export-icon">CP</span>
      <div><div class="export-menu-label">Copy as Markdown</div><div class="export-menu-desc">Copy to clipboard</div></div>
    </div>
  `;
  document.querySelector('.project-header-actions').appendChild(menu);
  exportMenuOpen = true;
  setTimeout(() => document.addEventListener('click', closeExportMenu, {once:true}), 10);
}
function closeExportMenu() {
  const m = document.querySelector('.export-menu');
  if(m) m.remove();
  exportMenuOpen = false;
}
function buildProjectMD() {
  const p = getProject(activeProject);
  if(!p) return '';
  const kbItems = (S.knowledgeBase||[]).filter(k => k.projectId === activeProject);
  const docs = (S.specs||[]).filter(s => s.projectId === activeProject);
  const tasks = getProjectTasks(activeProject);
  const links = (S.links||[]).filter(l => l.projectId === activeProject);
  // Convert HTML instructions to readable text
  const div = document.createElement('div');
  div.innerHTML = p.instructions || '';
  const instrText = div.innerText || div.textContent || '';
  let md = `# ${p.name}\n`;
  md += `**Status:** ${p.status} | **Icon:** ${p.icon} | **Color:** ${p.color}\n`;
  md += `**Updated:** ${p.updated || p.created}\n\n`;
  md += `---\n\n## Instructions\n\n${instrText}\n\n`;
  if(kbItems.length) {
    md += `---\n\n## Knowledge Base (${kbItems.length} items)\n\n`;
    kbItems.forEach(k => {
      md += `### ${k.name}\n`;
      md += `**Type:** ${k.type} | **Storage:** ${k.storage}\n`;
      if(k.description) md += `${k.description}\n`;
      if(k.tags && k.tags.length) md += `**Tags:** ${k.tags.join(', ')}\n`;
      if(k.content && k.type !== 'img') md += `\n${k.content}\n`;
      if(k.filePath) md += `**File:** ${k.filePath}\n`;
      if(k.url) md += `**URL:** ${k.url}\n`;
      md += '\n';
    });
  }
  if(docs.length) {
    md += `---\n\n## Living Docs (${docs.length})\n\n`;
    docs.forEach(d => {
      md += `### ${d.title}\n`;
      if(d.sections) d.sections.forEach(s => {
        md += `#### ${s.title}\n`;
        const sdiv = document.createElement('div');
        sdiv.innerHTML = s.body || '';
        md += (sdiv.innerText || '') + '\n\n';
      });
    });
  }
  if(tasks.length) {
    md += `---\n\n## Tasks (${tasks.length})\n\n`;
    tasks.forEach(t => {
      const check = t.status === 'done' ? 'x' : ' ';
      md += `- [${check}] ${t.title} (${t.status}${t.due ? ', due: '+t.due : ''})\n`;
    });
    md += '\n';
  }
  if(links.length) {
    md += `---\n\n## Links (${links.length})\n\n`;
    links.forEach(l => {
      md += `- [${l.title}](${l.url})${l.desc ? ' — '+l.desc : ''}\n`;
    });
    md += '\n';
  }
  md += `---\n\n*Exported from ASTRA Command Center on ${new Date().toISOString().split('T')[0]}*\n`;
  return md;
}
function exportProjectMD() {
  const p = getProject(activeProject);
  if(!p) return;
  const md = buildProjectMD();
  const blob = new Blob([md], {type:'text/markdown'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-') + '.md';
  a.click();
  closeExportMenu();
  toast('Exported as Markdown');
}
function exportProjectJSON() {
  const p = getProject(activeProject);
  if(!p) return;
  const data = {
    project: p,
    knowledgeBase: (S.knowledgeBase||[]).filter(k => k.projectId === activeProject),
    livingDocs: (S.specs||[]).filter(s => s.projectId === activeProject),
    tasks: getProjectTasks(activeProject),
    links: (S.links||[]).filter(l => l.projectId === activeProject),
    exportedAt: new Date().toISOString(),
    exportedFrom: 'ASTRA Command Center'
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-') + '.json';
  a.click();
  closeExportMenu();
  toast('Exported as JSON');
}
function copyProjectMD() {
  const md = buildProjectMD();
  navigator.clipboard.writeText(md).then(() => {
    closeExportMenu();
    toast('Copied to clipboard');
  }).catch(() => {
    closeExportMenu();
    toast('Copy failed — try Export instead');
  });
}

// === VOICE INPUT ===
let voiceTarget = null, voiceActive = false, voiceRecorder = null, voiceChunks = [];
function initVoice() { /* MediaRecorder init happens on toggle */ }
async function toggleVoice(target) {
  voiceTarget = target;
  if(voiceActive && voiceRecorder && voiceRecorder.state === 'recording') {
    voiceRecorder.stop();
    voiceActive = false;
    updateVoiceUI();
    toast('Processing with Whisper...');
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    voiceChunks = [];
    voiceRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    voiceRecorder.ondataavailable = e => { if(e.data.size > 0) voiceChunks.push(e.data); };
    voiceRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(voiceChunks, { type: 'audio/webm' });
      if(blob.size < 100) { toast('Recording too short'); return; }
      toast('Transcribing...');
      try {
        const fd = new FormData();
        fd.append('audio', blob, 'recording.webm');
        const res = await fetch(ASTRA_API + '/api/transcribe', { method: 'POST', headers: { 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW }, body: fd });
        const data = await res.json();
        if(data.ok && data.text) {
          const el = voiceTarget === 'writer' ? document.getElementById('writer-editor') : document.querySelector('.specs-section-editor:focus') || document.querySelector('.specs-section-editor');
          if(el) { el.focus(); document.execCommand('insertText', false, data.text + ' '); if(voiceTarget==='writer') onWriterChange(); else onSpecChange(); }
          toast('Whisper: ' + data.text.substring(0, 60) + (data.text.length > 60 ? '...' : ''));
        } else { toast('Transcription failed: ' + (data.error || 'unknown')); }
      } catch(e) { toast('Whisper error: ' + e.message); }
    };
    voiceRecorder.start();
    voiceActive = true;
    updateVoiceUI();
    toast('Recording... click again to stop');
  } catch(e) { toast('Mic access denied'); }
}
function updateVoiceUI() {
  const wb = document.getElementById('writer-voice-btn'), sb = document.getElementById('specs-voice-btn');
  if(wb) wb.classList.toggle('recording', voiceActive && voiceTarget === 'writer');
  if(sb) sb.classList.toggle('recording', voiceActive && voiceTarget === 'specs');
}

// === WHITEBOARD ENGINE ===
let wbNodes = [], wbConns = [], wbTool = 'select', wbScale = 1, wbPanX = 0, wbPanY = 0;
let wbDrag = null, wbConnStart = null, wbPanning = false, wbPanStart = null;
let wbSelected = null, wbResizing = null, wbGrid = true;
let wbHistory = [], wbHistoryIdx = -1, wbNodeId = 100;
const COLORS = ['#3b82f6','#8b5cf6','#06b6d4','#22c55e','#eab308','#f97316','#ef4444','#ec4899'];
const STICKY_COLORS = ['#fef08a','#bbf7d0','#bfdbfe','#fbcfe8','#fde68a','#c4b5fd'];

function wbSaveState() {
  wbHistory = wbHistory.slice(0, wbHistoryIdx + 1);
  wbHistory.push(JSON.stringify({nodes:wbNodes,conns:wbConns}));
  if(wbHistory.length > 50) wbHistory.shift();
  wbHistoryIdx = wbHistory.length - 1;
  wbPersist();
}
function wbUndo() { if(wbHistoryIdx > 0) { wbHistoryIdx--; wbRestoreHistory(); }}
function wbRedo() { if(wbHistoryIdx < wbHistory.length - 1) { wbHistoryIdx++; wbRestoreHistory(); }}
function wbRestoreHistory() { const d = JSON.parse(wbHistory[wbHistoryIdx]); wbNodes = d.nodes; wbConns = d.conns; wbRender(); wbPersist(); }
function wbPersist() { if(!S.whiteboard) S.whiteboard = {}; S.whiteboard = {nodes:wbNodes,conns:wbConns,panX:wbPanX,panY:wbPanY,scale:wbScale}; save(); }
function wbLoadState() { if(S.whiteboard) { wbNodes = S.whiteboard.nodes || []; wbConns = S.whiteboard.conns || []; wbPanX = S.whiteboard.panX || 0; wbPanY = S.whiteboard.panY || 0; wbScale = S.whiteboard.scale || 1; wbNodeId = Math.max(100, ...wbNodes.map(n=>n.id)) + 1; } wbSaveState(); }

function wbSetTool(t) { wbTool = t; document.querySelectorAll('.wb-tool[data-tool]').forEach(b => b.classList.toggle('active', b.dataset.tool === t)); const w = document.getElementById('wb-canvas-wrap'); w.style.cursor = t==='hand'?'grab':t==='connect'?'crosshair':t==='node'||t==='text'||t==='sticky'?'cell':'default'; }
function wbToggleGrid() { wbGrid = !wbGrid; wbRender(); toast(wbGrid ? 'Grid on' : 'Grid off'); }
function wbZoom(d) { wbScale = Math.max(0.2, Math.min(3, wbScale + d)); document.getElementById('wb-zoom-level').textContent = Math.round(wbScale * 100) + '%'; wbUpdateTransform(); wbUpdateMinimap(); }
function wbWheel(e) { e.preventDefault(); wbZoom(e.deltaY > 0 ? -0.05 : 0.05); }
function wbUpdateTransform() { document.getElementById('wb-canvas').style.transform = `translate(${wbPanX}px,${wbPanY}px) scale(${wbScale})`; }

function wbSnap(v) { return wbGrid ? Math.round(v / 20) * 20 : v; }
function wbScreenToCanvas(x, y) { const r = document.getElementById('wb-canvas-wrap').getBoundingClientRect(); return { x: (x - r.left - wbPanX) / wbScale, y: (y - r.top - wbPanY) / wbScale }; }

function wbAddNode(x, y, title, body, color, w, h, type) {
  const n = { id: wbNodeId++, x: wbSnap(x), y: wbSnap(y), w: w||160, h: h||80, title: title||'', body: body||'', color: color||COLORS[0], type: type||'node' };
  wbNodes.push(n);
  wbSaveState();
  wbRender();
  return n;
}
function wbDuplicateNode(id){
  const n=wbNodes.find(x=>x.id===id);if(!n)return;
  wbAddNode(n.x+30,n.y+30,n.title+' (copy)',n.body,n.color,n.w,n.h,n.type);
  toast('Node duplicated');
}

function wbRender() {
  const canvas = document.getElementById('wb-canvas');
  const svgEl = document.getElementById('wb-svg');
  // Grid
  let gridHtml = '';
  if(wbGrid) {
    const gs = 20;
    gridHtml = `<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="wbgrid" width="${gs}" height="${gs}" patternUnits="userSpaceOnUse"><path d="M ${gs} 0 L 0 0 0 ${gs}" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="0.5"/></pattern></defs><rect width="100%" height="100%" fill="url(#wbgrid)"/></svg>`;
  }
  // Nodes
  let nodesHtml = wbNodes.map(n => {
    const isSel = wbSelected === n.id;
    const isSticky = n.type === 'sticky';
    const bg = isSticky ? n.color : 'var(--bg-surface)';
    const textColor = isSticky ? '#1a1a24' : 'var(--text)';
    return `<div class="wb-node ${isSel?'selected':''}" data-id="${n.id}" style="left:${n.x}px;top:${n.y}px;width:${n.w}px;min-height:${n.h}px;background:${bg}" onmousedown="wbNodeDown(event,${n.id})">
      ${!isSticky?`<div class="wb-node-color" style="background:${n.color}"></div>`:''}
      <div class="wb-node-header" contenteditable="true" style="color:${textColor}" onblur="wbNodeEdit(${n.id},'title',this.textContent)" onclick="event.stopPropagation()">${esc(n.title)}</div>
      <div class="wb-node-body" contenteditable="true" style="color:${isSticky?'#333':'var(--text-secondary)'}" onblur="wbNodeEdit(${n.id},'body',this.textContent)" onclick="event.stopPropagation()">${esc(n.body)}</div>
      <button class="wb-node-del" onclick="event.stopPropagation();wbDeleteNode(${n.id})">x</button>
      <button class="wb-node-dup" onclick="event.stopPropagation();wbDuplicateNode(${n.id})" style="position:absolute;top:-8px;right:14px;width:18px;height:18px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:20" title="Duplicate">+</button>
      <button class="wb-node-color-btn" onclick="event.stopPropagation();wbPickColor(${n.id})" style="position:absolute;top:2px;right:20px;width:14px;height:14px;border:none;border-radius:50%;background:${n.color};cursor:pointer;opacity:0;transition:opacity 0.15s" title="Change color"></button>
      <div class="wb-node-resize" onmousedown="event.stopPropagation();wbResizeStart(event,${n.id})"></div>
      <div class="wb-node-port wb-port-right" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'right')"></div>
      <div class="wb-node-port wb-port-bottom" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'bottom')"></div>
      <div class="wb-node-port wb-port-left" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'left')"></div>
      <div class="wb-node-port wb-port-top" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'top')"></div>
    </div>`;
  }).join('');
  // SVG connections
  let svgPaths = wbConns.map(c => {
    const from = wbNodes.find(n => n.id === c.from);
    const to = wbNodes.find(n => n.id === c.to);
    if(!from || !to) return '';
    const fx = from.x + from.w / 2, fy = from.y + from.h / 2;
    const tx = to.x + to.w / 2, ty = to.y + to.h / 2;
    const mx = (fx + tx) / 2, my = (fy + ty) / 2;
    const dx = tx - fx, dy = ty - fy;
    const cx1 = fx + dx * 0.4, cy1 = fy;
    const cx2 = tx - dx * 0.4, cy2 = ty;
    return `<path d="M${fx},${fy} C${cx1},${cy1} ${cx2},${cy2} ${tx},${ty}" fill="none" stroke="${c.color||'rgba(59,130,246,0.5)'}" stroke-width="2" marker-end="url(#arrow)"/>`;
  }).join('');
  const svgContent = `<defs><marker id="arrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="rgba(59,130,246,0.6)"/></marker></defs>${svgPaths}`;
  canvas.innerHTML = `<div class="wb-grid">${gridHtml}</div><svg class="wb-svg" style="width:5000px;height:5000px">${svgContent}</svg>${nodesHtml}`;
  wbUpdateTransform();
  wbUpdateMinimap();
}

function wbUpdateMinimap() {
  const mm = document.getElementById('wb-minimap');
  if(!wbNodes.length) { mm.innerHTML = ''; return; }
  const minX = Math.min(...wbNodes.map(n=>n.x)), maxX = Math.max(...wbNodes.map(n=>n.x+n.w));
  const minY = Math.min(...wbNodes.map(n=>n.y)), maxY = Math.max(...wbNodes.map(n=>n.y+n.h));
  const pad = 100, rw = maxX - minX + pad * 2, rh = maxY - minY + pad * 2;
  const mmW = 160, mmH = 100, sx = mmW / rw, sy = mmH / rh, s = Math.min(sx, sy);
  const wrap = document.getElementById('wb-canvas-wrap');
  const vx = (-wbPanX / wbScale - minX + pad) * s, vy = (-wbPanY / wbScale - minY + pad) * s;
  const vw = (wrap.clientWidth / wbScale) * s, vh = (wrap.clientHeight / wbScale) * s;
  mm.innerHTML = wbNodes.map(n => `<div class="wb-minimap-node" style="left:${(n.x-minX+pad)*s}px;top:${(n.y-minY+pad)*s}px;width:${Math.max(2,n.w*s)}px;height:${Math.max(2,n.h*s)}px"></div>`).join('') + `<div class="wb-minimap-viewport" style="left:${vx}px;top:${vy}px;width:${vw}px;height:${vh}px"></div>`;
}

function wbNodeDown(e, id) {
  e.stopPropagation();
  if(wbTool === 'connect') return;
  wbSelected = id;
  const n = wbNodes.find(x => x.id === id);
  if(!n) return;
  wbDrag = { id, ox: e.clientX, oy: e.clientY, sx: n.x, sy: n.y };
  wbRender();
}

function wbCanvasDown(e) {
  if(e.button === 2 || wbTool === 'hand') { wbPanning = true; wbPanStart = { x: e.clientX - wbPanX, y: e.clientY - wbPanY }; document.getElementById('wb-canvas-wrap').style.cursor = 'grabbing'; return; }
  if(wbTool === 'node') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 80, p.y - 40, 'New Node', ''); return; }
  if(wbTool === 'text') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 60, p.y - 20, 'Text', '', '#8b5cf6', 140, 50, 'text'); return; }
  if(wbTool === 'sticky') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 70, p.y - 50, '', 'Note...', STICKY_COLORS[Math.floor(Math.random()*STICKY_COLORS.length)], 160, 120, 'sticky'); return; }
  wbSelected = null; wbRender();
}

function wbCanvasMove(e) {
  if(wbPanning && wbPanStart) { wbPanX = e.clientX - wbPanStart.x; wbPanY = e.clientY - wbPanStart.y; wbUpdateTransform(); wbUpdateMinimap(); return; }
  if(wbDrag) { const n = wbNodes.find(x => x.id === wbDrag.id); if(n) { n.x = wbSnap(wbDrag.sx + (e.clientX - wbDrag.ox) / wbScale); n.y = wbSnap(wbDrag.sy + (e.clientY - wbDrag.oy) / wbScale); wbRender(); } return; }
  if(wbResizing) { const n = wbNodes.find(x => x.id === wbResizing.id); if(n) { n.w = Math.max(80, wbSnap(wbResizing.sw + (e.clientX - wbResizing.ox) / wbScale)); n.h = Math.max(40, wbSnap(wbResizing.sh + (e.clientY - wbResizing.oy) / wbScale)); wbRender(); } return; }
}

function wbCanvasUp(e) {
  if(wbDrag) { wbSaveState(); }
  if(wbResizing) { wbSaveState(); }
  if(wbPanning) { wbPersist(); }
  wbDrag = null; wbPanning = false; wbPanStart = null; wbResizing = null;
  document.getElementById('wb-canvas-wrap').style.cursor = wbTool === 'hand' ? 'grab' : wbTool === 'connect' ? 'crosshair' : wbTool === 'node' || wbTool === 'text' || wbTool === 'sticky' ? 'cell' : 'default';
}

function wbResizeStart(e, id) { const n = wbNodes.find(x => x.id === id); if(n) wbResizing = { id, ox: e.clientX, oy: e.clientY, sw: n.w, sh: n.h }; }
function wbNodeEdit(id, field, val) { const n = wbNodes.find(x => x.id === id); if(n) { n[field] = val; wbSaveState(); }}
function wbPickColor(id){
  const n=wbNodes.find(x=>x.id===id);if(!n)return;
  const colors=['#4ade80','#22d3ee','#3b82f6','#a855f7','#f472b6','#f87171','#fbbf24','#fb923c','#6366f1','#14b8a6','#ef4444','#84cc16'];
  const el=document.createElement('div');
  el.style.cssText='position:fixed;z-index:9999;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:8px;display:grid;grid-template-columns:repeat(4,24px);gap:4px;box-shadow:0 8px 24px rgba(0,0,0,0.5)';
  el.style.left=(event.clientX-40)+'px';el.style.top=(event.clientY+10)+'px';
  colors.forEach(c=>{const b=document.createElement('div');b.style.cssText='width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid '+(n.color===c?'white':'transparent');b.style.background=c;b.onclick=()=>{n.color=c;wbSaveState();wbRender();el.remove();};el.appendChild(b);});
  document.body.appendChild(el);
  const close=e=>{if(!el.contains(e.target)){el.remove();document.removeEventListener('mousedown',close);}};
  setTimeout(()=>document.addEventListener('mousedown',close),10);
}
function wbDeleteNode(id) { wbNodes = wbNodes.filter(n => n.id !== id); wbConns = wbConns.filter(c => c.from !== id && c.to !== id); if(wbSelected === id) wbSelected = null; wbSaveState(); wbRender(); toast('Deleted'); }
function wbConnStartFn(e, id, port) { wbConnStart = { id, port }; wbTool = 'connect'; document.getElementById('wb-canvas-wrap').style.cursor = 'crosshair'; document.addEventListener('mouseup', wbConnEnd, { once: true }); }
function wbConnEnd(e) {
  if(!wbConnStart) return;
  const el = document.elementFromPoint(e.clientX, e.clientY);
  const nodeEl = el?.closest?.('.wb-node');
  if(nodeEl) {
    const toId = parseInt(nodeEl.dataset.id);
    if(toId !== wbConnStart.id && !wbConns.find(c => c.from === wbConnStart.id && c.to === toId)) {
      wbConns.push({ from: wbConnStart.id, to: toId, color: 'rgba(59,130,246,0.5)' });
      wbSaveState(); wbRender();
    }
  }
  wbConnStart = null; wbSetTool('select');
}

function wbClearAll() { if(!wbNodes.length) return; wbNodes = []; wbConns = []; wbSelected = null; wbSaveState(); wbRender(); toast('Cleared'); }
function wbFitView() {
  if(!wbNodes.length) return;
  const wrap = document.getElementById('wb-canvas-wrap');
  const minX = Math.min(...wbNodes.map(n=>n.x)), maxX = Math.max(...wbNodes.map(n=>n.x+n.w));
  const minY = Math.min(...wbNodes.map(n=>n.y)), maxY = Math.max(...wbNodes.map(n=>n.y+n.h));
  const rw = maxX - minX + 100, rh = maxY - minY + 100;
  wbScale = Math.min(wrap.clientWidth / rw, wrap.clientHeight / rh, 1.5);
  wbPanX = (wrap.clientWidth - rw * wbScale) / 2 - minX * wbScale + 50 * wbScale;
  wbPanY = (wrap.clientHeight - rh * wbScale) / 2 - minY * wbScale + 50 * wbScale;
  document.getElementById('wb-zoom-level').textContent = Math.round(wbScale * 100) + '%';
  wbUpdateTransform(); wbUpdateMinimap(); wbPersist();
}

function wbAutoLayout() {
  if(!wbNodes.length) return;
  const cols = Math.ceil(Math.sqrt(wbNodes.length));
  wbNodes.forEach((n, i) => { n.x = (i % cols) * 220 + 60; n.y = Math.floor(i / cols) * 140 + 60; });
  wbSaveState(); wbRender(); wbFitView(); toast('Auto-arranged');
}

function wbExport(fmt) {
  if(!fmt) return;
  if(fmt === 'json') { const blob = new Blob([JSON.stringify({nodes:wbNodes,conns:wbConns},null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.json'; a.click(); toast('JSON exported'); return; }
  if(fmt === 'png' || fmt === 'svg') {
    const canvas = document.createElement('canvas');
    const minX = wbNodes.length ? Math.min(...wbNodes.map(n=>n.x)) - 40 : 0;
    const minY = wbNodes.length ? Math.min(...wbNodes.map(n=>n.y)) - 40 : 0;
    const maxX = wbNodes.length ? Math.max(...wbNodes.map(n=>n.x+n.w)) + 40 : 800;
    const maxY = wbNodes.length ? Math.max(...wbNodes.map(n=>n.y+n.h)) + 40 : 600;
    const w = maxX - minX, h = maxY - minY;
    if(fmt === 'svg') {
      let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><rect width="${w}" height="${h}" fill="#0a0a0f"/>`;
      wbConns.forEach(c => { const from = wbNodes.find(n=>n.id===c.from), to = wbNodes.find(n=>n.id===c.to); if(from&&to) svg += `<line x1="${from.x+from.w/2-minX}" y1="${from.y+from.h/2-minY}" x2="${to.x+to.w/2-minX}" y2="${to.y+to.h/2-minY}" stroke="#3b82f6" stroke-width="2"/>`; });
      wbNodes.forEach(n => { svg += `<rect x="${n.x-minX}" y="${n.y-minY}" width="${n.w}" height="${n.h}" rx="6" fill="${n.type==='sticky'?n.color:'#12121a'}" stroke="#3b82f6" stroke-width="1"/><text x="${n.x-minX+10}" y="${n.y-minY+20}" fill="${n.type==='sticky'?'#1a1a24':'#fff'}" font-size="12" font-family="system-ui">${esc(n.title)}</text>`; });
      svg += '</svg>';
      const blob = new Blob([svg],{type:'image/svg+xml'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.svg'; a.click(); toast('SVG exported');
    } else {
      canvas.width = w * 2; canvas.height = h * 2;
      const ctx = canvas.getContext('2d');
      ctx.scale(2, 2); ctx.fillStyle = '#0a0a0f'; ctx.fillRect(0, 0, w, h);
      wbConns.forEach(c => { const from = wbNodes.find(n=>n.id===c.from), to = wbNodes.find(n=>n.id===c.to); if(from&&to) { ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(from.x+from.w/2-minX, from.y+from.h/2-minY); ctx.lineTo(to.x+to.w/2-minX, to.y+to.h/2-minY); ctx.stroke(); }});
      wbNodes.forEach(n => { ctx.fillStyle = n.type==='sticky'?n.color:'#12121a'; ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 1.5; const rx = 6; const nx = n.x-minX, ny = n.y-minY; ctx.beginPath(); ctx.roundRect(nx, ny, n.w, n.h, rx); ctx.fill(); ctx.stroke(); ctx.fillStyle = n.type==='sticky'?'#1a1a24':'#fff'; ctx.font = '600 12px system-ui'; ctx.fillText(n.title, nx+10, ny+22); ctx.fillStyle = n.type==='sticky'?'#333':'rgba(255,255,255,0.6)'; ctx.font = '10px system-ui'; ctx.fillText(n.body, nx+10, ny+40); });
      canvas.toBlob(blob => { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.png'; a.click(); toast('PNG exported'); });
    }
  }
}

function wbImportJSON(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const f=e.target.files[0],r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.nodes&&Array.isArray(d.nodes)){wbNodes=d.nodes;wbConns=d.conns||[];wbNodeId=Math.max(...wbNodes.map(n=>n.id||0),100)+1;wbSaveState();wbRender();wbFitView();toast('Imported '+wbNodes.length+' nodes');}else{toast('Invalid whiteboard JSON');}}catch(e){toast('Parse error: '+e.message);}};r.readAsText(f);};inp.click();
}
function wbNodeCount(){return wbNodes.length+' nodes, '+wbConns.length+' connections';}

// === TEMPLATES ===
const WB_TEMPLATES = [
  { name: 'Blank Canvas', icon: '+', desc: 'Start from scratch', nodes: [] },
  { name: 'Mind Map', icon: 'MM', desc: 'Central idea with branches', nodes: [{t:'Central Idea',b:'Main topic',x:400,y:250,c:'#3b82f6',w:180,h:80},{t:'Branch 1',b:'',x:100,y:100,c:'#8b5cf6'},{t:'Branch 2',b:'',x:700,y:100,c:'#06b6d4'},{t:'Branch 3',b:'',x:100,y:400,c:'#22c55e'},{t:'Branch 4',b:'',x:700,y:400,c:'#f97316'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: 'Eisenhower Matrix', icon: 'EM', desc: 'Urgent vs Important', nodes: [{t:'URGENT + IMPORTANT',b:'Do first',x:60,y:60,c:'#ef4444',w:280,h:200},{t:'NOT URGENT + IMPORTANT',b:'Schedule it',x:380,y:60,c:'#eab308',w:280,h:200},{t:'URGENT + NOT IMPORTANT',b:'Delegate it',x:60,y:300,c:'#f97316',w:280,h:200},{t:'NOT URGENT + NOT IMPORTANT',b:'Eliminate it',x:380,y:300,c:'#22c55e',w:280,h:200}] },
  { name: 'SWOT Analysis', icon: 'SW', desc: 'Strengths, Weaknesses, Opportunities, Threats', nodes: [{t:'STRENGTHS',b:'Internal positive',x:60,y:60,c:'#22c55e',w:280,h:200},{t:'WEAKNESSES',b:'Internal negative',x:380,y:60,c:'#ef4444',w:280,h:200},{t:'OPPORTUNITIES',b:'External positive',x:60,y:300,c:'#3b82f6',w:280,h:200},{t:'THREATS',b:'External negative',x:380,y:300,c:'#f97316',w:280,h:200}] },
  { name: 'Project Roadmap', icon: 'PR', desc: 'Timeline with milestones', nodes: [{t:'Q1 2026',b:'Foundation',x:60,y:160,c:'#3b82f6'},{t:'Q2 2026',b:'Growth',x:260,y:160,c:'#06b6d4'},{t:'Q3 2026',b:'Scale',x:460,y:160,c:'#8b5cf6'},{t:'Q4 2026',b:'Optimize',x:660,y:160,c:'#22c55e'}], conns:[[0,1],[1,2],[2,3]] },
  { name: 'Org Chart', icon: 'OC', desc: 'Organizational hierarchy', nodes: [{t:'CEO / Founder',b:'Gabo',x:300,y:40,c:'#3b82f6',w:180},{t:'Product',b:'App + Platform',x:80,y:180,c:'#8b5cf6'},{t:'Content',b:'Brand + Social',x:300,y:180,c:'#06b6d4'},{t:'Operations',b:'Finance + Legal',x:520,y:180,c:'#22c55e'},{t:'Engineering',b:'Code + Infra',x:80,y:320,c:'#f97316'},{t:'Community',b:'Coaching',x:520,y:320,c:'#ec4899'}], conns:[[0,1],[0,2],[0,3],[1,4],[3,5]] },
  { name: 'User Persona', icon: 'UP', desc: 'Customer avatar profile', nodes: [{t:'PERSONA',b:'Name, Age, Location',x:250,y:40,c:'#8b5cf6',w:200,h:80},{t:'Goals',b:'What they want to achieve',x:60,y:180,c:'#22c55e',w:200,h:100},{t:'Pain Points',b:'Frustrations and blocks',x:300,y:180,c:'#ef4444',w:200,h:100},{t:'Behaviors',b:'How they act',x:540,y:180,c:'#3b82f6',w:200,h:100},{t:'Motivations',b:'Why they buy',x:180,y:340,c:'#eab308',w:200,h:100},{t:'Channels',b:'Where they are',x:420,y:340,c:'#06b6d4',w:200,h:100}], conns:[[0,1],[0,2],[0,3],[1,4],[3,5]] },
  { name: 'Content Calendar', icon: 'CC', desc: 'Weekly content plan', nodes: [{t:'Monday',b:'Caption + Reel',x:60,y:100,c:'#3b82f6'},{t:'Tuesday',b:'Quote card',x:260,y:100,c:'#8b5cf6'},{t:'Wednesday',b:'YouTube',x:460,y:100,c:'#ef4444'},{t:'Thursday',b:'Carousel',x:60,y:240,c:'#22c55e'},{t:'Friday',b:'Story + Engagement',x:260,y:240,c:'#eab308'},{t:'Weekend',b:'Rest or batch',x:460,y:240,c:'#06b6d4'}] },
  { name: 'Product Breakdown', icon: 'PB', desc: 'Feature hierarchy', nodes: [{t:'PRODUCT',b:'Saturno Movement',x:300,y:40,c:'#3b82f6',w:180},{t:'Calisthenics',b:'Program 1',x:60,y:180,c:'#8b5cf6'},{t:'Yoga',b:'Program 2',x:280,y:180,c:'#22c55e'},{t:'Rings',b:'Program 3',x:500,y:180,c:'#f97316'},{t:'App',b:'Platform',x:280,y:320,c:'#06b6d4'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: 'Stakeholder Map', icon: 'SM', desc: 'Key relationships', nodes: [{t:'Gabo (Center)',b:'Founder',x:280,y:200,c:'#3b82f6',w:160,h:80},{t:'Customers',b:'3M+ followers',x:80,y:60,c:'#22c55e'},{t:'Victory Belt',b:'Publisher',x:480,y:60,c:'#8b5cf6'},{t:'Clients',b:'1:1 Coaching',x:80,y:360,c:'#eab308'},{t:'Community',b:'SM Academy',x:480,y:360,c:'#06b6d4'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: '5 Whys', icon: '5W', desc: 'Root cause analysis', nodes: [{t:'Problem',b:'Define the issue',x:300,y:40,c:'#ef4444',w:200},{t:'Why 1?',b:'First cause',x:300,y:140,c:'#f97316'},{t:'Why 2?',b:'Deeper cause',x:300,y:240,c:'#eab308'},{t:'Why 3?',b:'Even deeper',x:300,y:340,c:'#22c55e'},{t:'Why 4?',b:'Getting close',x:300,y:440,c:'#3b82f6'},{t:'Why 5? = Root Cause',b:'The real issue',x:300,y:540,c:'#8b5cf6',w:200}], conns:[[0,1],[1,2],[2,3],[3,4],[4,5]] },
  { name: 'Impact Mapping', icon: 'IM', desc: 'Goal to deliverables', nodes: [{t:'GOAL',b:'Revenue $50K/mo',x:40,y:200,c:'#3b82f6',w:160},{t:'Actor 1',b:'Customers',x:260,y:100,c:'#22c55e'},{t:'Actor 2',b:'Followers',x:260,y:300,c:'#8b5cf6'},{t:'Impact',b:'Subscribe monthly',x:460,y:100,c:'#eab308'},{t:'Impact',b:'Buy book',x:460,y:300,c:'#f97316'},{t:'Deliverable',b:'App + Content',x:660,y:200,c:'#06b6d4',w:160}], conns:[[0,1],[0,2],[1,3],[2,4],[3,5],[4,5]] },
  { name: 'RACI Matrix', icon: 'RA', desc: 'Responsibility assignment', nodes: [{t:'RESPONSIBLE',b:'Does the work',x:60,y:60,c:'#3b82f6',w:200,h:120},{t:'ACCOUNTABLE',b:'Owns the outcome',x:300,y:60,c:'#ef4444',w:200,h:120},{t:'CONSULTED',b:'Provides input',x:60,y:220,c:'#eab308',w:200,h:120},{t:'INFORMED',b:'Kept in the loop',x:300,y:220,c:'#22c55e',w:200,h:120}] },
  { name: 'Action Plan', icon: 'AP', desc: 'Steps with owners', nodes: [{t:'Objective',b:'What we achieve',x:280,y:40,c:'#3b82f6',w:200},{t:'Step 1',b:'Owner: | Due:',x:60,y:160,c:'#22c55e'},{t:'Step 2',b:'Owner: | Due:',x:280,y:160,c:'#8b5cf6'},{t:'Step 3',b:'Owner: | Due:',x:500,y:160,c:'#06b6d4'},{t:'Result',b:'Expected outcome',x:280,y:300,c:'#eab308',w:200}], conns:[[0,1],[0,2],[0,3],[1,4],[2,4],[3,4]] },
  { name: 'Gap Analysis', icon: 'GA', desc: 'Current vs Target state', nodes: [{t:'CURRENT STATE',b:'Where we are now',x:60,y:140,c:'#f97316',w:220,h:140},{t:'TARGET STATE',b:'Where we want to be',x:480,y:140,c:'#22c55e',w:220,h:140},{t:'GAP',b:'What needs to change',x:270,y:340,c:'#ef4444',w:220,h:100},{t:'ACTIONS',b:'How to close the gap',x:270,y:60,c:'#3b82f6',w:220,h:60}], conns:[[0,2],[1,2],[2,3]] },
  { name: 'Communication Plan', icon: 'CP', desc: 'Channels and frequency', nodes: [{t:'Instagram',b:'Daily: Captions + Reels',x:60,y:60,c:'#ec4899'},{t:'YouTube',b:'Weekly: Long-form',x:280,y:60,c:'#ef4444'},{t:'Email',b:'Bi-weekly: Newsletter',x:500,y:60,c:'#3b82f6'},{t:'Website',b:'Always: Blog + SEO',x:60,y:220,c:'#22c55e'},{t:'Community',b:'Daily: DMs + Comments',x:280,y:220,c:'#8b5cf6'},{t:'Podcast',b:'Monthly: Guest spots',x:500,y:220,c:'#eab308'}] },
  { name: 'Service Blueprint', icon: 'SB', desc: 'User journey map', nodes: [{t:'Discover',b:'Find on social',x:60,y:60,c:'#3b82f6'},{t:'Explore',b:'Visit website',x:240,y:60,c:'#06b6d4'},{t:'Sign Up',b:'Free trial / purchase',x:420,y:60,c:'#22c55e'},{t:'Onboard',b:'First workout',x:600,y:60,c:'#8b5cf6'},{t:'Engage',b:'Daily use',x:420,y:200,c:'#eab308'},{t:'Advocate',b:'Refer friends',x:600,y:200,c:'#ec4899'}], conns:[[0,1],[1,2],[2,3],[3,4],[4,5]] },
  { name: 'Priority Matrix', icon: 'PM', desc: 'Effort vs Impact', nodes: [{t:'HIGH IMPACT + LOW EFFORT',b:'Quick Wins - DO FIRST',x:60,y:60,c:'#22c55e',w:260,h:180},{t:'HIGH IMPACT + HIGH EFFORT',b:'Major Projects - PLAN',x:360,y:60,c:'#3b82f6',w:260,h:180},{t:'LOW IMPACT + LOW EFFORT',b:'Fill-ins - IF TIME',x:60,y:280,c:'#eab308',w:260,h:180},{t:'LOW IMPACT + HIGH EFFORT',b:'Thankless Tasks - SKIP',x:360,y:280,c:'#ef4444',w:260,h:180}] },
  { name: 'Flowchart', icon: 'FC', desc: 'Process flow with decisions', nodes: [{t:'START',b:'Begin process',x:280,y:40,c:'#22c55e',w:160,h:60},{t:'Step 1',b:'Action',x:280,y:140,c:'#3b82f6'},{t:'Decision?',b:'Yes or No',x:280,y:260,c:'#eab308',w:160,h:80},{t:'Path A',b:'If yes',x:80,y:380,c:'#8b5cf6'},{t:'Path B',b:'If no',x:480,y:380,c:'#f97316'},{t:'END',b:'Done',x:280,y:500,c:'#ef4444',w:160,h:60}], conns:[[0,1],[1,2],[2,3],[2,4],[3,5],[4,5]] },
  { name: 'HBS Solar System', icon: 'HB', desc: 'Handstand progression planets', nodes: [{t:'SUN: Foundation',b:'Wrist prep, shoulder mobility',x:300,y:200,c:'#eab308',w:180,h:80},{t:'MERCURY: Wall Work',b:'Chest-to-wall, back-to-wall',x:80,y:60,c:'#94a3b8'},{t:'VENUS: Kick-Up',b:'Tuck, straddle, pike entries',x:540,y:60,c:'#f97316'},{t:'EARTH: Balance',b:'Freestanding skill',x:80,y:360,c:'#3b82f6'},{t:'MARS: Shapes',b:'Tuck, straddle, pike, OA prep',x:540,y:360,c:'#ef4444'},{t:'JUPITER: Press',b:'Press to handstand',x:300,y:60,c:'#f97316'},{t:'SATURN: One-Arm',b:'Mastery territory',x:300,y:360,c:'#8b5cf6'}], conns:[[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]] },
  { name: 'Revenue Roadmap', icon: 'RR', desc: 'Revenue unlock path', nodes: [{t:'BOOK: $20K',b:'Victory Belt submission',x:60,y:160,c:'#22c55e',w:180},{t:'BF25 DELIVERY',b:'Trust + Retention',x:280,y:60,c:'#eab308'},{t:'DAILY CONTENT',b:'1 post/day visibility',x:280,y:260,c:'#3b82f6'},{t:'SM APP',b:'$37/mo subscriptions',x:500,y:160,c:'#8b5cf6',w:180},{t:'TARGET: $50-100K/mo',b:'Enterprise scale',x:720,y:160,c:'#ef4444',w:200}], conns:[[0,1],[0,2],[0,3],[1,3],[2,3],[3,4]] },
];

function openTplModal() {
  const g = document.getElementById('wb-tpl-grid');
  g.innerHTML = WB_TEMPLATES.map((t, i) => `<div class="wb-tpl-card" onclick="applyTemplate(${i})"><div class="wb-tpl-icon">${t.icon}</div><div class="wb-tpl-name">${t.name}</div><div class="wb-tpl-desc">${t.desc}</div></div>`).join('');
  document.getElementById('wb-tpl-modal').classList.add('open');
}
function closeTplModal() { document.getElementById('wb-tpl-modal').classList.remove('open'); }
function applyTemplate(idx) {
  const t = WB_TEMPLATES[idx];
  closeTplModal();
  if(t.nodes.length === 0) { wbNodes = []; wbConns = []; }
  else {
    wbNodes = t.nodes.map((n, i) => ({ id: wbNodeId + i, x: n.x || 100, y: n.y || 100, w: n.w || 160, h: n.h || 80, title: n.t || '', body: n.b || '', color: n.c || COLORS[i % COLORS.length], type: n.type || 'node' }));
    wbConns = (t.conns || []).map(c => ({ from: wbNodeId + c[0], to: wbNodeId + c[1], color: 'rgba(59,130,246,0.5)' }));
    wbNodeId += t.nodes.length + 1;
  }
  wbPanX = 0; wbPanY = 0; wbScale = 1;
  wbSaveState(); wbRender();
  setTimeout(() => wbFitView(), 50);
  toast('Template: ' + t.name);
}

// Keyboard shortcuts for whiteboard
document.addEventListener('keydown', e => {
  if(currentSection !== 'whiteboard') return;
  if(e.target.contentEditable === 'true' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  switch(e.key.toLowerCase()) {
    case 'v': wbSetTool('select'); break;
    case 'h': wbSetTool('hand'); break;
    case 'n': wbSetTool('node'); break;
    case 'c': wbSetTool('connect'); break;
    case 't': wbSetTool('text'); break;
    case 's': wbSetTool('sticky'); break;
    case 'g': wbToggleGrid(); break;
    case 'delete': case 'backspace': if(wbSelected) { wbDeleteNode(wbSelected); } break;
    case 'z': if(e.metaKey || e.ctrlKey) { e.preventDefault(); if(e.shiftKey) wbRedo(); else wbUndo(); } break;
    case '=': case '+': wbZoom(0.1); break;
    case '-': wbZoom(-0.1); break;
    case '0': wbScale = 1; wbPanX = 0; wbPanY = 0; document.getElementById('wb-zoom-level').textContent = '100%'; wbUpdateTransform(); wbUpdateMinimap(); break;
  }
});

// === SEED LINKS ===
function seedLinks() {
  if(!S.links.length) {
    S.links = [
      {id:2001,title:'Saturno Vault (Vercel)',url:'https://saturno-bonus-omega.vercel.app',category:'deployment',desc:'Primary deployment - password: saturno2025',created:new Date().toISOString()},
      {id:2002,title:'Saturno Vault Gate',url:'https://saturno-bonus-omega.vercel.app/gate.html',category:'deployment',desc:'Customer password gate for bonus vault',created:new Date().toISOString()},
      {id:2003,title:'GitHub: titan-forge',url:'https://github.com/gabosaturno11/titan-forge',category:'repo',desc:'Main vault repo (Vercel deploys from here)',created:new Date().toISOString()},
      {id:2004,title:'GitHub: victory-belt-cc',url:'https://github.com/gabosaturno11/victory-belt-cc',category:'repo',desc:'Victory Belt Command Center',created:new Date().toISOString()},
      {id:2005,title:'GitHub Pages: Titan Forge',url:'https://gabosaturno11.github.io/titan-forge/',category:'deployment',desc:'GH Pages (BROKEN - logo 404, stale gh-pages branch)',created:new Date().toISOString()},
      {id:2006,title:'Saturno Movement',url:'https://saturnomovement.com',category:'brand',desc:'Main brand site - Calisthenics/Yoga/Rings programs',created:new Date().toISOString()},
      {id:2007,title:'Google Calendar',url:'https://calendar.google.com',category:'tool',desc:'Calendar',created:new Date().toISOString()},
      {id:2008,title:'GitHub: saturno-hub',url:'https://github.com/gabosaturno11/saturno-hub',category:'repo',desc:'Saturno Hub starter',created:new Date().toISOString()},
      {id:2009,title:'Interactive TOC Editor',url:'https://gabosaturno11.github.io/interactive-toc-editor/',category:'deployment',desc:'Book TOC editor',created:new Date().toISOString()},
      {id:2010,title:'Saturno Solar System',url:'https://gabosaturno11.github.io/saturno-solar-system/',category:'deployment',desc:'Interactive solar system',created:new Date().toISOString()},
      {id:2011,title:'De Aqui a Saturno',url:'https://de-aqui-a-saturno.vercel.app',category:'deployment',desc:'Valentine\'s Day experience for Karina — Vimeo videos, piano crossfade, crystal cosmic scroll',created:new Date().toISOString()},
      {id:2012,title:'GitHub: de-aqui-a-saturno',url:'https://github.com/gabosaturno11/de-aqui-a-saturno',category:'repo',desc:'Private repo — Valentine\'s experience source',created:new Date().toISOString()},
      {id:2013,title:'ASTRA Command Center',url:'https://astra-command-center-sigma.vercel.app',category:'deployment',desc:'Endel-inspired 7-section command center',created:new Date().toISOString()},
      {id:2014,title:'GitHub: astra-command-center',url:'https://github.com/gabosaturno11/astra-command-center',category:'repo',desc:'ASTRA source repo',created:new Date().toISOString()},
      {id:2015,title:'Vimeo Developer',url:'https://developer.vimeo.com/apps',category:'tool',desc:'Vimeo API — app: ASTRA LLMs, account: admin@saturnomovement.com',created:new Date().toISOString()},
      {id:2016,title:'Saturno Bonus (Vercel)',url:'https://saturno-bonus-omega.vercel.app',category:'deployment',desc:'Customer bonus page — decoupled from titan-forge',created:new Date().toISOString()},
      {id:2017,title:'GitHub: saturno-bonus',url:'https://github.com/gabosaturno11/saturno-bonus',category:'repo',desc:'Private repo — clean bonus-only repo with bonuses/ folder',created:new Date().toISOString()},
      {id:2018,title:'SATURNO COMMAND',url:'https://saturno-bonus-omega.vercel.app/command',category:'deployment',desc:'Admin dashboard — tool toggles, config API',created:new Date().toISOString()},
      {id:2019,title:'Cloudflare Dashboard',url:'https://dash.cloudflare.com/',category:'tool',desc:'DNS management — admin@saturnomovement.com, 2FA enabled',created:new Date().toISOString()},
      {id:2020,title:'Stripe Dashboard',url:'https://dashboard.stripe.com/',category:'tool',desc:'Payment management — 2FA + authenticator',created:new Date().toISOString()},
      {id:2021,title:'GitHub: sm-app-copy-v1',url:'https://github.com/gabosaturno11/sm-app-copy-v1',category:'repo',desc:'Clone of Saturno Movement app codebase (from Softzee)',created:new Date().toISOString()},
    ];
  }
}

// === FOLDER SYSTEM ===
function getFolders() { return S.folders || []; }
function addFolder(name, parentId) {
  if(!S.folders) S.folders = [];
  const f = { id: 'folder_' + Date.now(), name: name || 'New Folder', parentId: parentId || null, created: new Date().toISOString() };
  S.folders.push(f);
  save();
  return f;
}
function deleteFolder(id) {
  S.folders = (S.folders||[]).filter(f => f.id !== id);
  // Unassign items from deleted folder
  S.content.forEach(c => { if(c.folderId === id) c.folderId = null; });
  S.tasks.forEach(t => { if(t.folderId === id) t.folderId = null; });
  S.docs.forEach(d => { if(d.folderId === id) d.folderId = null; });
  S.specs.forEach(s => { if(s.folderId === id) s.folderId = null; });
  S.links.forEach(l => { if(l.folderId === id) l.folderId = null; });
  save();
}
function renameFolder(id, name) {
  const f = (S.folders||[]).find(x => x.id === id);
  if(f) { f.name = name; save(); }
}
function moveToFolder(itemType, itemId, folderId) {
  const collections = { content: S.content, tasks: S.tasks, docs: S.docs, specs: S.specs, links: S.links };
  const col = collections[itemType];
  if(!col) return;
  const item = col.find(x => x.id === itemId || x.id == itemId);
  if(item) { item.folderId = folderId; save(); toast('Moved to folder'); }
}

// === FOLDER TREE UI ===
let activeFolderId = null;
function renderFolderTree() {
  const el = document.getElementById('sidebar-folder-tree');
  if(!el) return;
  const folders = getFolders();
  if(!folders.length) {
    el.innerHTML = '<div style="font-size:10px;color:var(--text-muted);padding:4px 8px">No folders yet</div>';
    return;
  }
  const rootFolders = folders.filter(f => !f.parentId);
  el.innerHTML = renderFolderLevel(rootFolders, folders, 0);
}
function renderFolderLevel(items, all, depth) {
  return items.map(f => {
    const children = all.filter(c => c.parentId === f.id);
    const count = countFolderItems(f.id);
    const isActive = activeFolderId === f.id;
    const indent = depth * 12;
    let html = `<div class="folder-item ${isActive ? 'active' : ''}" style="padding-left:${8 + indent}px" onclick="selectFolder('${f.id}')" oncontextmenu="event.preventDefault();folderContextMenu(event,'${f.id}')" ondragover="event.preventDefault();this.style.background='var(--accent-glow)'" ondragleave="this.style.background=''" ondrop="event.preventDefault();this.style.background='';folderDrop(event,'${f.id}')">`;
    html += `<span class="folder-item-icon">${children.length ? (isActive ? 'v' : '>') : '-'}</span>`;
    html += `<span class="folder-item-name">${esc(f.name)}</span>`;
    if(count > 0) html += `<span class="folder-item-count">${count}</span>`;
    html += '</div>';
    if(children.length && isActive) {
      html += renderFolderLevel(children, all, depth + 1);
    }
    return html;
  }).join('');
}
function countFolderItems(folderId) {
  let count = 0;
  S.content.forEach(c => { if(c.folderId === folderId) count++; });
  S.tasks.forEach(t => { if(t.folderId === folderId) count++; });
  S.docs.forEach(d => { if(d.folderId === folderId) count++; });
  S.specs.forEach(s => { if(s.folderId === folderId) count++; });
  S.links.forEach(l => { if(l.folderId === folderId) count++; });
  return count;
}
function selectFolder(id) {
  activeFolderId = activeFolderId === id ? null : id;
  renderFolderTree();
}
function addFolderFromSidebar() {
  const name = prompt('Folder name:');
  if(!name || !name.trim()) return;
  addFolder(name.trim());
  renderFolderTree();
  toast('Folder created');
}
function folderDrop(event, folderId) {
  const data = event.dataTransfer.getData('text/plain');
  if(!data) return;
  try {
    const { type, id } = JSON.parse(data);
    if(type && id) { moveToFolder(type, id, folderId); renderFolderTree(); }
  } catch(e) {}
}
function folderContextMenu(event, id) {
  const action = prompt('Folder action: (r)ename, (d)elete, (s)ub-folder');
  if(!action) return;
  const a = action.toLowerCase().trim();
  if(a === 'r' || a === 'rename') {
    const f = (S.folders||[]).find(x => x.id === id);
    const name = prompt('New name:', f ? f.name : '');
    if(name && name.trim()) { renameFolder(id, name.trim()); renderFolderTree(); toast('Renamed'); }
  } else if(a === 'd' || a === 'delete') {
    deleteFolder(id); activeFolderId = null; renderFolderTree(); toast('Folder deleted');
  } else if(a === 's' || a === 'sub-folder') {
    const name = prompt('Sub-folder name:');
    if(name && name.trim()) { addFolder(name.trim(), id); renderFolderTree(); toast('Sub-folder created'); }
  }
}

// === MINI KNOWLEDGE GRAPH ===
let graphNodes = [], graphEdges = [], graphAnimId = null;
function buildGraph() {
  graphNodes = []; graphEdges = [];
  const colors = { project: '#4ade80', doc: '#22d3ee', spec: '#a78bfa', task: '#fbbf24', kb: '#fb923c' };
  // Add project nodes
  (S.projects||[]).forEach(p => {
    graphNodes.push({ id: 'p_'+p.id, label: p.name, type: 'project', color: colors.project, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Add doc nodes
  S.docs.forEach(d => {
    graphNodes.push({ id: 'd_'+d.id, label: d.title||'Untitled', type: 'doc', color: colors.doc, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Add spec nodes
  S.specs.forEach(s => {
    graphNodes.push({ id: 's_'+s.id, label: s.title||'Untitled', type: 'spec', color: colors.spec, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Build edges from wiki-links
  S.docs.forEach(d => {
    if(!d.body) return;
    const links = d.body.match(/\[\[([^\]]+)\]\]/g)||[];
    links.forEach(m => {
      const name = m.slice(2,-2).trim();
      const target = findLinkedItem(name);
      if(target) {
        const srcId = 'd_'+d.id;
        let tgtId = '';
        if(target.type==='project') tgtId='p_'+target.id;
        else if(target.type==='doc') tgtId='d_'+target.id;
        else if(target.type==='spec') tgtId='s_'+target.id;
        if(tgtId && graphNodes.find(n=>n.id===tgtId)) graphEdges.push({from:srcId,to:tgtId});
      }
    });
  });
  S.specs.forEach(s => {
    (s.sections||[]).forEach(sec => {
      if(!sec.body) return;
      const links = sec.body.match(/\[\[([^\]]+)\]\]/g)||[];
      links.forEach(m => {
        const name = m.slice(2,-2).trim();
        const target = findLinkedItem(name);
        if(target) {
          const srcId = 's_'+s.id;
          let tgtId = '';
          if(target.type==='project') tgtId='p_'+target.id;
          else if(target.type==='doc') tgtId='d_'+target.id;
          else if(target.type==='spec') tgtId='s_'+target.id;
          if(tgtId && graphNodes.find(n=>n.id===tgtId)) graphEdges.push({from:srcId,to:tgtId});
        }
      });
    });
  });
  // Connect KB items to their projects
  (S.knowledgeBase||[]).forEach(k => {
    if(k.projectId) {
      const projNode = graphNodes.find(n=>n.id==='p_'+k.projectId);
      if(projNode) {
        graphNodes.push({ id: 'k_'+k.id, label: k.name, type: 'kb', color: colors.kb, x: projNode.x+Math.random()*40-20, y: projNode.y+Math.random()*40-20, vx:0, vy:0 });
        graphEdges.push({from:'p_'+k.projectId,to:'k_'+k.id});
      }
    }
  });
  // Limit to max 30 nodes for performance
  if(graphNodes.length > 30) graphNodes = graphNodes.slice(0, 30);
}
function renderGraph() {
  const canvas = document.getElementById('ctx-graph-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  buildGraph();
  if(!graphNodes.length) {
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Add items + [[links]] to see connections', w/2, h/2);
    return;
  }
  let steps = 80;
  function simulate() {
    const k = 0.01, repulsion = 800, damping = 0.85;
    graphNodes.forEach(n => { n.vx = 0; n.vy = 0; });
    // Repulsion
    for(let i=0;i<graphNodes.length;i++) {
      for(let j=i+1;j<graphNodes.length;j++) {
        let dx=graphNodes[j].x-graphNodes[i].x, dy=graphNodes[j].y-graphNodes[i].y;
        let dist=Math.sqrt(dx*dx+dy*dy)+1;
        let f=repulsion/(dist*dist);
        graphNodes[i].vx -= dx/dist*f; graphNodes[i].vy -= dy/dist*f;
        graphNodes[j].vx += dx/dist*f; graphNodes[j].vy += dy/dist*f;
      }
    }
    // Attraction along edges
    graphEdges.forEach(e => {
      const a=graphNodes.find(n=>n.id===e.from), b=graphNodes.find(n=>n.id===e.to);
      if(!a||!b) return;
      let dx=b.x-a.x, dy=b.y-a.y, dist=Math.sqrt(dx*dx+dy*dy)+1;
      let f=dist*k;
      a.vx += dx*f; a.vy += dy*f;
      b.vx -= dx*f; b.vy -= dy*f;
    });
    // Center gravity
    graphNodes.forEach(n => {
      n.vx += (w/2-n.x)*0.002;
      n.vy += (h/2-n.y)*0.002;
      n.vx *= damping; n.vy *= damping;
      n.x += n.vx; n.y += n.vy;
      n.x = Math.max(10, Math.min(w-10, n.x));
      n.y = Math.max(10, Math.min(h-10, n.y));
    });
  }
  for(let i=0;i<steps;i++) simulate();
  // Draw
  ctx.clearRect(0,0,w,h);
  // Edges
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  graphEdges.forEach(e => {
    const a=graphNodes.find(n=>n.id===e.from), b=graphNodes.find(n=>n.id===e.to);
    if(!a||!b) return;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  });
  // Nodes
  graphNodes.forEach(n => {
    const r = n.type==='project' ? 5 : 3;
    ctx.beginPath(); ctx.arc(n.x,n.y,r,0,Math.PI*2);
    ctx.fillStyle = n.color; ctx.globalAlpha = 0.7; ctx.fill(); ctx.globalAlpha = 1;
    // Label
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.font = '8px system-ui';
    ctx.textAlign = 'center';
    const label = n.label.length > 12 ? n.label.slice(0,11) + '..' : n.label;
    ctx.fillText(label, n.x, n.y - r - 3);
  });
}

// === CROSS-LINKING [[wiki-links]] ===
function parseWikiLinks(html) {
  if(!html) return html;
  return html.replace(/\[\[([^\]]+)\]\]/g, (match, linkText) => {
    const target = findLinkedItem(linkText.trim());
    if(target) {
      return `<span class="wiki-link" onclick="navigateToItem('${target.type}','${target.id}')" title="${esc(target.desc)}" style="color:var(--accent);cursor:pointer;border-bottom:1px dashed var(--accent);padding-bottom:1px">${esc(linkText)}</span>`;
    }
    return `<span class="wiki-link-broken" style="color:var(--red);cursor:help;border-bottom:1px dashed var(--red)" title="Not found: ${esc(linkText)}">${esc(linkText)}</span>`;
  });
}
function findLinkedItem(name) {
  const nl = name.toLowerCase();
  // Search projects
  const proj = (S.projects||[]).find(p => p.name.toLowerCase() === nl);
  if(proj) return { type: 'project', id: proj.id, desc: 'Project: ' + proj.name };
  // Search docs
  const doc = S.docs.find(d => d.title && d.title.toLowerCase() === nl);
  if(doc) return { type: 'doc', id: doc.id, desc: 'Document: ' + doc.title };
  // Search specs
  const spec = S.specs.find(s => s.title && s.title.toLowerCase() === nl);
  if(spec) return { type: 'spec', id: spec.id, desc: 'Living Doc: ' + spec.title };
  // Search KB items
  const kb = (S.knowledgeBase||[]).find(k => k.name && k.name.toLowerCase() === nl);
  if(kb) return { type: 'kb', id: kb.id, desc: 'KB: ' + kb.name };
  // Search tasks
  const task = S.tasks.find(t => t.title && t.title.toLowerCase() === nl);
  if(task) return { type: 'task', id: task.id, desc: 'Task: ' + task.title };
  return null;
}
function navigateToItem(type, id) {
  if(type === 'project') { openProject(id); }
  else if(type === 'doc') { switchDoc(parseInt(id) || id); switchSection('writer', null); }
  else if(type === 'spec') { switchSpec(parseInt(id) || id); switchSection('specs', null); }
  else if(type === 'kb') { openKBViewer(id); }
  else if(type === 'task') { switchSection('tasks', null); toast('Task: ' + (S.tasks.find(t => t.id == id)?.title || '')); }
}
function getBacklinks(itemType, itemName) {
  const nl = '[[' + itemName + ']]';
  const results = [];
  S.docs.forEach(d => { if(d.body && d.body.includes(nl)) results.push({ type: 'doc', title: d.title || 'Untitled', id: d.id }); });
  S.specs.forEach(s => {
    (s.sections || []).forEach(sec => {
      if(sec.body && sec.body.includes(nl)) results.push({ type: 'spec', title: s.title + ' > ' + sec.title, id: s.id });
    });
  });
  (S.projects||[]).forEach(p => {
    if(p.instructions && p.instructions.includes(nl)) results.push({ type: 'project', title: p.name, id: p.id });
  });
  return results;
}

// === COMMAND PALETTE ===
let cmdIdx = 0;
function openCommandPalette() {
  document.getElementById('cmd-overlay').classList.add('open');
  const inp = document.getElementById('cmd-input');
  inp.value = '';
  cmdIdx = 0;
  cmdSearch();
  setTimeout(() => inp.focus(), 50);
}
function closeCommandPalette() {
  document.getElementById('cmd-overlay').classList.remove('open');
}
function cmdGetItems(q) {
  const items = [];
  const ql = (q || '').toLowerCase();
  // Recent items (show when no query)
  if(!ql && recentItems.length) {
    recentItems.forEach(r => {
      items.push({title:r.title, desc:'Recent - '+r.type, icon:'*', type:'recent', action:()=>navigateToItem(r.type, r.id)});
    });
  }
  // Sections
  const sections = [
    {title:'Content',desc:'Content vault',icon:'C',action:()=>switchSection('content',document.querySelector('.sidebar-item'))},
    {title:'Tasks',desc:'Task manager',icon:'T',action:()=>switchSection('tasks',null)},
    {title:'Calendar',desc:'Calendar view',icon:'D',action:()=>switchSection('calendar',null)},
    {title:'Writing Hub',desc:'Document editor',icon:'W',action:()=>switchSection('writer',null)},
    {title:'Living Docs',desc:'Structured documents',icon:'S',action:()=>switchSection('specs',null)},
    {title:'Links',desc:'Link directory',icon:'L',action:()=>switchSection('links',null)},
    {title:'Whiteboard',desc:'Visual canvas',icon:'B',action:()=>switchSection('whiteboard',null)},
    {title:'Pipeline',desc:'Audio/text processing pipeline',icon:'P',action:()=>switchSection('pipeline',null)},
    {title:'Repos',desc:'Connected repositories',icon:'R',action:()=>switchSection('repos',null)},
  ];
  sections.forEach(s => {
    if(!ql || s.title.toLowerCase().includes(ql) || s.desc.toLowerCase().includes(ql))
      items.push({...s, type:'section'});
  });
  // Projects
  (S.projects||[]).forEach(p => {
    if(!ql || p.name.toLowerCase().includes(ql))
      items.push({title:p.name, desc:'Project - '+p.status, icon:p.icon?getIconSVG(p.icon,14):'P', type:'project', action:()=>openProject(p.id)});
  });
  // Tasks
  S.tasks.forEach(t => {
    if(t.title && (!ql || t.title.toLowerCase().includes(ql) || (t.description||'').toLowerCase().includes(ql)))
      items.push({title:t.title, desc:t.status+' - '+(t.project||'No project')+(t.description?' - '+t.description.substring(0,40):''), icon:'T', type:'task', action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
  });
  // Docs
  S.docs.forEach(d => {
    if(d.title && (!ql || d.title.toLowerCase().includes(ql)))
      items.push({title:d.title, desc:'Document', icon:'W', type:'doc', action:()=>{switchDoc(d.id);switchSection('writer',null);}});
  });
  // Living Docs
  S.specs.forEach(s => {
    if(s.title && (!ql || s.title.toLowerCase().includes(ql)))
      items.push({title:s.title, desc:'Living Doc - '+(s.sections?s.sections.length:0)+' sections', icon:'S', type:'spec', action:()=>{switchSpec(s.id);switchSection('specs',null);}});
  });
  // KB Items
  (S.knowledgeBase||[]).forEach(k => {
    if(k.name && (!ql || k.name.toLowerCase().includes(ql)))
      items.push({title:k.name, desc:'KB - '+k.type, icon:'K', type:'kb', action:()=>{const proj = (S.projects||[]).find(p=>p.id===k.projectId); if(proj){openProject(proj.id);setProjTab('kb');} openKBViewer(k.id);}});
  });
  // Content (search body text)
  if(ql) {
    S.content.filter(c=>c.body.toLowerCase().includes(ql)).slice(0,5).forEach(c => {
      items.push({title:c.body.substring(0,60)+(c.body.length>60?'...':''), desc:'Content - '+c.type+(c.theme?' / '+c.theme:''), icon:'C', type:'content', action:()=>{switchSection('content',null);document.getElementById('content-search').value=ql;renderContent();}});
    });
  }
  // Links
  S.links.forEach(l => {
    if(l.title && (!ql || l.title.toLowerCase().includes(ql) || l.url.toLowerCase().includes(ql)))
      items.push({title:l.title, desc:l.url, icon:'L', type:'link', action:()=>window.open(l.url,'_blank')});
  });
  // Actions
  if(!ql || 'new task'.includes(ql)) items.push({title:'New Task', desc:'Create a new task', icon:'+', type:'action', action:addTask});
  if(!ql || 'new document'.includes(ql)) items.push({title:'New Document', desc:'Create a new document', icon:'+', type:'action', action:newDoc});
  if(!ql || 'new project'.includes(ql)) items.push({title:'New Project', desc:'Create a new project', icon:'+', type:'action', action:openNewProjectModal});
  if(!ql || 'export'.includes(ql)) items.push({title:'Export All', desc:'Export all data as JSON', icon:'E', type:'action', action:exportAll});
  if(!ql || 'stats storage data'.includes(ql)) items.push({title:'Data Stats', desc:'Show storage breakdown by section', icon:'#', type:'action', action:()=>{closeCommandPalette();dataStats();}});
  if(!ql || 'focus timer'.includes(ql)) items.push({title:'Focus Timer', desc:'Open focus timer in context panel', icon:'FT', type:'action', action:()=>{if(!document.querySelector('.app').classList.contains('context-open'))toggleContextPanel();}});
  if(!ql || 'quick capture'.includes(ql)) items.push({title:'Quick Capture', desc:'Add task/content instantly (Cmd+Shift+N)', icon:'+', type:'action', action:()=>{closeCommandPalette();qcOpen();}});
  if(!ql || 'today'.includes(ql)) items.push({title:'Today View', desc:'See tasks due today + overdue', icon:'*', type:'action', action:()=>{closeCommandPalette();showTodayView();}});
  if(!ql || 'standup daily'.includes(ql)) items.push({title:'Daily Standup', desc:'Copy standup summary to clipboard', icon:'S', type:'action', action:()=>{closeCommandPalette();generateStandup();}});
  if(!ql || 'export content'.includes(ql)) items.push({title:'Export Content', desc:'Copy all content as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportContent();}});
  if(!ql || 'export tasks'.includes(ql)) items.push({title:'Export Tasks', desc:'Copy filtered tasks as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportTasks();}});
  if(!ql || 'export links bookmarks'.includes(ql)) items.push({title:'Export Links', desc:'Copy all links as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportLinks();}});
  if(!ql || 'export week calendar summary'.includes(ql)) items.push({title:'Export Week', desc:'Copy this weeks tasks as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportWeek();}});
  if(!ql || 'archive'.includes(ql)) items.push({title:'Archive Completed', desc:'Move done tasks to archive', icon:'A', type:'action', action:()=>{closeCommandPalette();archiveCompletedTasks();}});
  if(!ql || 'shortcuts help'.includes(ql)) items.push({title:'Keyboard Shortcuts', desc:'Show all shortcuts (Cmd+/)', icon:'?', type:'action', action:()=>{closeCommandPalette();document.getElementById('shortcuts-modal').classList.add('open');}});
  if(!ql || 'zen writer'.includes(ql)) items.push({title:'Zen Writer', desc:'Distraction-free writing mode', icon:'Z', type:'action', action:()=>{closeCommandPalette();zenOpen();}});
  if(!ql || 'focus mode'.includes(ql)) items.push({title:'Toggle Focus Mode', desc:'Hide sidebar for focused work', icon:'F', type:'action', action:()=>{closeCommandPalette();const app=document.querySelector('.app');setMode(app.classList.contains('mode-focus')?'default':'focus');}});
  if(!ql || 'ics calendar export'.includes(ql)) items.push({title:'Export Calendar', desc:'Export tasks as .ics for Google Calendar', icon:'C', type:'action', action:()=>{closeCommandPalette();exportICS();}});
  if(!ql || 'random inspiration content'.includes(ql)) items.push({title:'Random Content', desc:'Pick a random content item for inspiration', icon:'?', type:'action', action:()=>{closeCommandPalette();switchSection('content',null);setTimeout(randomContent,100);}});
  if(!ql || 'export summary markdown report'.includes(ql)) items.push({title:'Export Summary', desc:'Copy hub summary as Markdown', icon:'S', type:'action', action:()=>{closeCommandPalette();exportSummary();}});
  if(!ql || 'repo health check ping'.includes(ql)) items.push({title:'Repo Health Check', desc:'Ping all live repo URLs', icon:'R', type:'action', action:()=>{closeCommandPalette();repoHealthCheck();}});
  if(!ql || 'time report hours tracked'.includes(ql)) items.push({title:'Time Report', desc:'Show time tracked per task', icon:'T', type:'action', action:()=>{closeCommandPalette();timeReport();}});
  if(!ql || 'zen writer write focus'.includes(ql)) items.push({title:'Zen Writer', desc:'Full-screen distraction-free writing (Cmd+Shift+W)', icon:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>', type:'action', action:()=>{closeCommandPalette();zenOpen();}});
  if(!ql || 'daily dashboard digest briefing morning'.includes(ql)) items.push({title:'Daily Dashboard', desc:'Full daily briefing copied to clipboard', icon:'*', type:'action', action:()=>{closeCommandPalette();dailyDashboard();}});
  if(!ql || 'import ics calendar'.includes(ql)) items.push({title:'Import ICS', desc:'Import .ics calendar file as tasks', icon:'C', type:'action', action:()=>{closeCommandPalette();importICS();}});
  // Open specific docs in Zen Writer
  if(ql && ('zen '.includes(ql.substring(0,4)) || ql.startsWith('zen '))) {
    S.docs.forEach(function(d) {
      if(d.title) items.push({title:'Zen: ' + d.title, desc:'Open in Zen Writer', icon:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>', type:'action', action:function(){ closeCommandPalette(); zenOpen(d.id); }});
    });
  }
  return items.slice(0, 20);
}
function cmdSearch() {
  const q = document.getElementById('cmd-input').value;
  const items = cmdGetItems(q);
  cmdIdx = 0;
  const el = document.getElementById('cmd-results');
  if(!items.length) { el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:12px">No results</div>'; return; }
  el.innerHTML = items.map((it, i) => {
    const iconHtml = it.icon.startsWith('<') ? it.icon : `<span>${it.icon}</span>`;
    return `<div class="cmd-item ${i===0?'active':''}" data-idx="${i}" onclick="cmdExec(${i})" onmouseenter="cmdHover(${i})">
      <div class="cmd-item-icon">${iconHtml}</div>
      <div class="cmd-item-text"><div class="cmd-item-title">${esc(it.title)}</div><div class="cmd-item-desc">${esc(it.desc||'')}</div></div>
      <span class="cmd-item-badge">${it.type}</span>
    </div>`;
  }).join('');
}
function cmdHover(i) { cmdIdx = i; cmdHighlight(); }
function cmdHighlight() {
  document.querySelectorAll('.cmd-item').forEach((el, i) => el.classList.toggle('active', i === cmdIdx));
  const active = document.querySelector('.cmd-item.active');
  if(active) active.scrollIntoView({block:'nearest'});
}
function cmdKeydown(e) {
  const items = document.querySelectorAll('.cmd-item');
  if(e.key === 'ArrowDown') { e.preventDefault(); cmdIdx = Math.min(cmdIdx + 1, items.length - 1); cmdHighlight(); }
  else if(e.key === 'ArrowUp') { e.preventDefault(); cmdIdx = Math.max(cmdIdx - 1, 0); cmdHighlight(); }
  else if(e.key === 'Enter') { e.preventDefault(); cmdExec(cmdIdx); }
  else if(e.key === 'Escape') { closeCommandPalette(); }
}
function cmdExec(idx) {
  const items = cmdGetItems(document.getElementById('cmd-input').value);
  if(items[idx] && items[idx].action) { closeCommandPalette(); items[idx].action(); }
}

// === MODE SWITCHING ===
let currentMode = 'default';
function setMode(mode) {
  currentMode = mode;
  const app = document.querySelector('.app');
  app.classList.remove('mode-focus', 'mode-extended');
  // Close project panel in focus mode — no sidebar means no way to navigate
  if(mode === 'focus') {
    app.classList.add('mode-focus');
    if(app.classList.contains('project-open')) closeProjectPanel();
    app.classList.remove('context-open');
  }
  if(mode === 'extended') {
    app.classList.add('mode-extended');
    if(app.classList.contains('project-open')) closeProjectPanel();
    if(!app.classList.contains('context-open')) app.classList.add('context-open');
    updateContextStats();
  }
  if(mode === 'default') {
    app.classList.remove('context-open');
  }
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mode-'+mode+'-btn').classList.add('active');
}

// === SIDEBAR TOGGLE ===
function toggleSidebar() {
  const app = document.querySelector('.app');
  app.classList.toggle('sidebar-collapsed');
  localStorage.setItem('sidebar-collapsed', app.classList.contains('sidebar-collapsed') ? '1' : '');
}
function openMobileSidebar(){document.querySelector('.sidebar').classList.add('mobile-open');document.getElementById('mobile-overlay').classList.add('open');}
function closeMobileSidebar(){document.querySelector('.sidebar').classList.remove('mobile-open');document.getElementById('mobile-overlay').classList.remove('open');}

// === CONTEXT PANEL ===
function toggleContextPanel() {
  const app = document.querySelector('.app');
  if(app.classList.contains('project-open')) {
    closeProjectPanel();
  }
  app.classList.toggle('context-open');
  updateContextStats();
}

// === PANEL RESIZING ===
(function initResize() {
  document.addEventListener('DOMContentLoaded', () => {
    const sidebarHandle = document.getElementById('sidebar-resize');
    const contextHandle = document.getElementById('context-resize');
    const root = document.documentElement;
    let resizing = null;
    function onMouseDown(e, type) {
      e.preventDefault();
      resizing = type;
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      const handle = type === 'sidebar' ? sidebarHandle : contextHandle;
      if(handle) handle.classList.add('dragging');
    }
    if(sidebarHandle) sidebarHandle.addEventListener('mousedown', e => onMouseDown(e, 'sidebar'));
    if(contextHandle) contextHandle.addEventListener('mousedown', e => onMouseDown(e, 'context'));
    document.addEventListener('mousemove', e => {
      if(!resizing) return;
      if(resizing === 'sidebar') {
        const w = Math.max(160, Math.min(400, e.clientX));
        root.style.setProperty('--sidebar-width', w + 'px');
      } else if(resizing === 'context') {
        const w = Math.max(200, Math.min(500, window.innerWidth - e.clientX));
        root.style.setProperty('--context-width', w + 'px');
      }
    });
    document.addEventListener('mouseup', () => {
      if(!resizing) return;
      const handle = resizing === 'sidebar' ? sidebarHandle : contextHandle;
      if(handle) handle.classList.remove('dragging');
      resizing = null;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    });
  });
})();

function updateContextStats() {
  const activeTasks = S.tasks.filter(t => t.status !== 'done').length;
  const el = id => { const e = document.getElementById(id); if(e) return e; return {textContent:''}; };
  el('ctx-stat-tasks').textContent = activeTasks;
  el('ctx-stat-docs').textContent = S.docs.length + S.specs.length;
  el('ctx-stat-projects').textContent = (S.projects||[]).length;
  el('ctx-stat-kb').textContent = (S.knowledgeBase||[]).length;
  updateContextRelated();
  renderGraph();
}
function updateContextRelated() {
  const el = document.getElementById('ctx-related-items');
  if(!el) return;
  let html = '';
  if(currentSection === 'writer') {
    const doc = getActiveDoc();
    if(doc && doc.title) {
      const backlinks = getBacklinks('doc', doc.title);
      if(backlinks.length) {
        html += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Backlinks to "' + esc(doc.title) + '":</div>';
        backlinks.forEach(bl => {
          html += '<div class="context-item" onclick="navigateToItem(\'' + bl.type + '\',\'' + bl.id + '\')"><span class="context-item-icon">' + bl.type[0].toUpperCase() + '</span>' + esc(bl.title) + '</div>';
        });
      }
    }
  } else if(currentSection === 'specs') {
    const spec = getActiveSpec();
    if(spec && spec.title) {
      const backlinks = getBacklinks('spec', spec.title);
      if(backlinks.length) {
        html += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Backlinks to "' + esc(spec.title) + '":</div>';
        backlinks.forEach(bl => {
          html += '<div class="context-item" onclick="navigateToItem(\'' + bl.type + '\',\'' + bl.id + '\')"><span class="context-item-icon">' + bl.type[0].toUpperCase() + '</span>' + esc(bl.title) + '</div>';
        });
      }
    }
  } else if(currentSection === 'tasks') {
    // Show overdue tasks
    const today = new Date().toISOString().split('T')[0];
    const overdue = S.tasks.filter(t => t.due && t.due < today && t.status !== 'done');
    if(overdue.length) {
      html += '<div style="font-size:9px;color:var(--red);margin-bottom:6px">Overdue (' + overdue.length + '):</div>';
      overdue.slice(0, 5).forEach(t => {
        html += '<div class="context-item" style="color:var(--red)"><span class="context-item-icon">!</span>' + esc(t.title || 'Untitled') + '</div>';
      });
    }
    // Show today's tasks
    const todayTasks = S.tasks.filter(t => t.due === today && t.status !== 'done');
    if(todayTasks.length) {
      html += '<div style="font-size:9px;color:var(--accent);margin-bottom:6px;margin-top:8px">Today (' + todayTasks.length + '):</div>';
      todayTasks.forEach(t => {
        html += '<div class="context-item"><span class="context-item-icon">*</span>' + esc(t.title || 'Untitled') + '</div>';
      });
    }
  }
  if(!html) html = '<div style="font-size:10px;color:var(--text-muted);padding:4px 0">No related items for current view</div>';
  el.innerHTML = html;
}

// === FOCUS TIMER (Embedded) ===
let ftDuration = 1500, ftTimeLeft = 1500, ftRunning = false, ftPaused = false, ftInterval = null;
let ftCategory = 'Writing', ftColor = '#4ade80';
function ftToggle() {
  if(!ftRunning && !ftPaused) ftStart();
  else if(ftRunning) ftPause();
  else ftResume();
}
let ftTaskId=null;
function ftStartForTask(id){
  const t=S.tasks.find(x=>x.id===id);if(!t)return;
  ftTaskId=id;
  ftSetCat(null,t.title.substring(0,20)||'Task','#4ade80');
  ftReset();
  if(!document.querySelector('.app').classList.contains('context-open'))toggleContextPanel();
  closeTaskDetail();
  ftToggle();
  if(!t.timeStarted){t.timeStarted=new Date().toISOString();if(t.status==='todo'){t.status='progress';if(!t.log)t.log=[];t.log.push({from:'todo',to:'progress',at:t.timeStarted});}save();}
  toast('Focus timer started for: '+t.title.substring(0,30));
}
function ftStart() {
  ftRunning = true; ftPaused = false;
  document.getElementById('ft-btn').textContent = 'Pause';
  document.getElementById('ft-btn').classList.add('running');
  document.getElementById('ft-time-adjust').style.opacity = '0.3';
  ftInterval = setInterval(() => {
    ftTimeLeft--;
    ftUpdateDisplay();
    if(ftTimeLeft <= 0) ftComplete();
  }, 1000);
}
function ftPause() {
  ftRunning = false; ftPaused = true;
  clearInterval(ftInterval);
  document.getElementById('ft-btn').textContent = 'Resume';
  document.getElementById('ft-btn').classList.remove('running');
}
function ftResume() { ftStart(); }
function ftComplete() {
  ftRunning = false; ftPaused = false;
  clearInterval(ftInterval);
  document.getElementById('ft-btn').textContent = 'Done!';
  document.getElementById('ft-btn').classList.remove('running');
  ftPlaySound();
  setTimeout(ftReset, 3000);
}
function ftReset() {
  ftRunning = false; ftPaused = false;
  clearInterval(ftInterval);
  ftTimeLeft = ftDuration;
  document.getElementById('ft-btn').textContent = 'Start';
  document.getElementById('ft-btn').classList.remove('running');
  document.getElementById('ft-time-adjust').style.opacity = '1';
  ftUpdateDisplay();
}
function ftUpdateDisplay() {
  const m = Math.floor(ftTimeLeft / 60), s = ftTimeLeft % 60;
  document.getElementById('ft-time').textContent = m + ':' + String(s).padStart(2, '0');
  const progress = 1 - (ftTimeLeft / ftDuration);
  const circumference = 2 * Math.PI * 70;
  const offset = circumference * (1 - progress);
  const prog = document.getElementById('ft-progress');
  if(prog) { prog.style.strokeDasharray = circumference; prog.style.strokeDashoffset = offset; prog.style.stroke = ftColor; }
}
function ftAdjust(min) {
  if(ftRunning || ftPaused) return;
  ftDuration = Math.max(300, Math.min(7200, ftDuration + min * 60));
  ftTimeLeft = ftDuration;
  document.getElementById('ft-duration-label').textContent = Math.floor(ftDuration / 60) + ' min';
  ftUpdateDisplay();
}
function ftSetCat(el, name, color) {
  ftCategory = name; ftColor = color;
  document.querySelectorAll('.ft-cat').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('ft-label').textContent = name;
  ftUpdateDisplay();
}
function ftPlaySound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator(), gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.frequency.setValueAtTime(600, ctx.currentTime + 0.1);
    osc.frequency.setValueAtTime(800, ctx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.5);
  } catch(e) {}
}

// === CLOUD SYNC (Vercel Blob Backend) ===
const ASTRA_API = window.location.origin;
let ASTRA_ADMIN_PW = localStorage.getItem('astra_admin_pw') || '';
let cloudSyncTimer = null;
let lastCloudSync = 0;
const CLOUD_SYNC_INTERVAL = 30000;

function ensureAdminPW() {
  if (ASTRA_ADMIN_PW) return true;
  var pw = prompt('Enter ASTRA admin password for cloud sync:');
  if (!pw) return false;
  ASTRA_ADMIN_PW = pw;
  localStorage.setItem('astra_admin_pw', pw);
  return true;
}

function setCloudIndicator(state) {
  const el = document.getElementById('cloud-sync-indicator');
  if(!el) return;
  if(state==='syncing') { el.style.opacity='1'; el.style.color='var(--accent-cyan)'; el.title='Syncing...'; }
  else if(state==='synced') { el.style.opacity='0.7'; el.style.color='var(--green)'; el.title='Synced '+(new Date().toLocaleTimeString())+' — click to sync'; }
  else if(state==='error') { el.style.opacity='0.8'; el.style.color='var(--red)'; el.title='Sync failed — click to retry'; }
  else { el.style.opacity='0.4'; el.style.color='var(--text-muted)'; el.title='Not synced — click to sync'; }
}
async function cloudSave(silent) {
  if (!ASTRA_ADMIN_PW && silent) return { ok: false };
  if (!ensureAdminPW()) return { ok: false };
  setCloudIndicator('syncing');
  try {
    const state = JSON.parse(localStorage.getItem(SK) || '{}');
    const res = await fetch(ASTRA_API + '/api/state', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify(state)
    });
    const data = await res.json();
    if (data.ok) {
      lastCloudSync = Date.now();
      setCloudIndicator('synced');
      if (!silent) toast('Synced to cloud (v' + data.version + ')');
    } else if (data.error === 'Unauthorized') {
      localStorage.removeItem('astra_admin_pw');
      ASTRA_ADMIN_PW = '';
      setCloudIndicator('error');
      if (!silent) toast('Wrong password. Try Cmd+S again.');
    } else {
      setCloudIndicator('error');
    }
    return data;
  } catch(e) { setCloudIndicator('error'); if (!silent) toast('Cloud sync error: ' + e.message); return { ok: false }; }
}

function scheduleCloudSync() {
  if (cloudSyncTimer) clearTimeout(cloudSyncTimer);
  cloudSyncTimer = setTimeout(function() { cloudSave(true); }, CLOUD_SYNC_INTERVAL);
}

async function cloudLoad() {
  if (!ensureAdminPW()) return;
  try {
    const res = await fetch(ASTRA_API + '/api/state', {
      headers: { 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW }
    });
    const data = await res.json();
    if (data._source === 'blob' && (data.projects || data.tasks || data.docs || data.content)) {
      delete data._source; delete data._savedAt; delete data._version;
      localStorage.setItem(SK, JSON.stringify(data));
      location.reload();
    } else if (data._source === 'none' || data._source === 'empty') {
      toast('No cloud state yet — saving current state');
      cloudSave(false);
    } else { toast('No cloud state found'); }
  } catch(e) { toast('Cloud load error: ' + e.message); }
}

async function logTranscript(text, source) {
  try {
    await fetch(ASTRA_API + '/api/transcripts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify({ text, source: source || 'astra-voice', tags: ['voice-input'] })
    });
  } catch(e) { /* silent fail for transcript logging */ }
}

async function queryAstra(type, params) {
  try {
    const res = await fetch(ASTRA_API + '/api/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify({ type, ...params })
    });
    return await res.json();
  } catch(e) { return { ok: false, error: e.message }; }
}

// === INIT ===
load();
seedLinks();
seedProjects();
migrateV2();
save();
if(localStorage.getItem('sidebar-collapsed')) document.querySelector('.app').classList.add('sidebar-collapsed');
initVoice();
wbLoadState();
renderContent();renderTasks();renderCalendar();renderWriter();renderSpecs();renderLinks();renderProjectsSidebar();renderFolderTree();updateStorage();
ftUpdateDisplay();updateContextStats();
setTimeout(function(){ cloudSave(true); }, 3000);
// Whiteboard drop handler for KB items
document.getElementById('panel-whiteboard')?.addEventListener('drop', handleWbDrop);
document.getElementById('panel-whiteboard')?.addEventListener('dragover', e => { if(e.dataTransfer?.types?.includes('text/plain')) e.preventDefault(); });
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
window.addEventListener('beforeunload',()=>{if(zenIsOpen)zenSnapshot();snapshotWriter();snapshotSpec();wbPersist();save();});
document.addEventListener('keydown',e=>{
  // Command Palette: Cmd+K
  if((e.metaKey||e.ctrlKey) && e.key==='k') { e.preventDefault(); openCommandPalette(); return; }
  // Cmd+Shift+W: toggle Zen Writer
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='w'||e.key==='W')) { e.preventDefault(); if(zenIsOpen) zenClose(); else zenOpen(); return; }
  // Cmd+S: save (Zen Writer version save or workspace save)
  if((e.metaKey||e.ctrlKey) && e.key==='s') { e.preventDefault(); if(zenIsOpen){ zenSaveVersion(); } else { snapshotWriter(); snapshotSpec(); wbPersist(); save(); cloudSave(); } return; }
  // Skip shortcuts when typing in inputs
  const inInput = e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.contentEditable==='true';
  if(e.key==='Escape'){
    if(zenIsOpen) { zenClose(); return; }
    if(document.getElementById('task-detail-modal').classList.contains('open')) { closeTaskDetail(); return; }
    if(document.getElementById('cmd-overlay').classList.contains('open')) { closeCommandPalette(); return; }
    document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));
    if(activeProject) closeProjectPanel();
  }
  if(inInput) return;
  // Cmd+number: switch sections
  if((e.metaKey||e.ctrlKey) && e.key>='1' && e.key<='9') {
    e.preventDefault();
    const sections = ['content','tasks','calendar','writer','specs','links','whiteboard','pipeline','repos'];
    const idx = parseInt(e.key)-1;
    if(sections[idx]) {
      const items = document.querySelectorAll('.sidebar-item');
      switchSection(sections[idx], items[idx]||null);
    }
    return;
  }
  // Cmd+Shift+N: quick capture
  if((e.metaKey||e.ctrlKey) && e.shiftKey && e.key==='n') { e.preventDefault(); qcOpen(); return; }
  // Cmd+Shift+T: new task from anywhere
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='t'||e.key==='T')) { e.preventDefault(); switchSection('tasks',document.querySelectorAll('.sidebar-item')[1]||null); setTimeout(()=>addTask(),100); return; }
  // Cmd+B: toggle sidebar
  if((e.metaKey||e.ctrlKey) && e.key==='b' && !e.shiftKey) { e.preventDefault(); toggleSidebar(); return; }
  // Cmd+Shift+D: today view
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='d'||e.key==='D')) { e.preventDefault(); showTodayView(); return; }
  // Cmd+Shift+F: toggle focus mode
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='f'||e.key==='F')) { e.preventDefault(); const app=document.querySelector('.app');const isFocus=app.classList.contains('mode-focus');setMode(isFocus?'default':'focus'); return; }
  // Cmd+Shift+W: open Zen Writer
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='w'||e.key==='W')) { e.preventDefault(); zenOpen(); return; }
  // Cmd+Shift+E: export current section
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='e'||e.key==='E')) { e.preventDefault(); if(currentSection==='tasks')exportTasks();else if(currentSection==='content')exportContent();else if(currentSection==='links')exportLinks();else if(currentSection==='calendar')exportWeek();else if(currentSection==='writer'){writerExport('clipboard');}else toast('No export for this section'); return; }
  // Cmd+N: new item in current section
  if((e.metaKey||e.ctrlKey) && e.key==='n' && !e.shiftKey) {
    e.preventDefault();
    if(currentSection==='content') openContentModal();
    else if(currentSection==='tasks') addTask();
    else if(currentSection==='writer') newDoc();
    else if(currentSection==='specs') newSpec();
    else if(currentSection==='links') openLinkModal();
    return;
  }
  // Cmd+Z: undo last delete (content)
  if((e.metaKey||e.ctrlKey) && e.key==='z' && !e.shiftKey) { if(lastDeletedContent){e.preventDefault();undoDeleteContent();return;} if(lastDeletedLink){e.preventDefault();undoDeleteLink();return;} }
  // Cmd+E: toggle context panel
  if((e.metaKey||e.ctrlKey) && e.key==='e') { e.preventDefault(); toggleContextPanel(); return; }
  // Cmd+\\: toggle focus mode
  if((e.metaKey||e.ctrlKey) && e.key==='\\') { e.preventDefault(); setMode(currentMode==='focus'?'default':'focus'); return; }
  // Cmd+/: show shortcuts help
  if((e.metaKey||e.ctrlKey) && e.key==='/') { e.preventDefault(); document.getElementById('shortcuts-modal').classList.toggle('open'); return; }
});

// === RESIZE HANDLE FOR PROJECT PANEL ===
(function(){
  const handle = document.getElementById('project-resize-handle');
  const root = document.documentElement;
  let dragging = false;
  let startX, startWidth;
  handle.addEventListener('mousedown', e => {
    dragging = true;
    handle.classList.add('dragging');
    startX = e.clientX;
    startWidth = document.getElementById('panel-project').offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if(!dragging) return;
    const delta = startX - e.clientX;
    const newWidth = Math.max(280, Math.min(800, startWidth + delta));
    root.style.setProperty('--project-width', newWidth + 'px');
  });
  document.addEventListener('mouseup', () => {
    if(!dragging) return;
    dragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  });
})();

// === PIPELINE ===
let plRecorder=null, plChunks=[], plRecording=false, plRecStart=0, plRecTimer=null, plAudioBlob=null, plTranscriptText='', plSynthesisText='', plApiOk=null;
function plCheckApi(){
  if(!ASTRA_ADMIN_PW){document.getElementById('pl-status-dot').style.background='var(--text-muted)';document.getElementById('pl-status-dot').title='No password set';document.getElementById('pl-onboarding').style.display='block';return;}
  fetch(ASTRA_API+'/api/health',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}}).then(r=>r.json()).then(d=>{
    plApiOk=true;document.getElementById('pl-status-dot').style.background='var(--green)';document.getElementById('pl-status-dot').title='API connected';document.getElementById('pl-onboarding').style.display='none';
  }).catch(()=>{
    plApiOk=false;document.getElementById('pl-status-dot').style.background='var(--orange)';document.getElementById('pl-status-dot').title='API unreachable';document.getElementById('pl-onboarding').style.display='block';
  });
}
function plSaveLocal(entry){if(!S.pipelineHistory)S.pipelineHistory=[];S.pipelineHistory.unshift(entry);if(S.pipelineHistory.length>50)S.pipelineHistory.length=50;save();}

function plToggleRecord() {
  const btn=document.getElementById('pl-record-btn');
  const indicator=document.getElementById('pl-recording');
  if(plRecording && plRecorder && plRecorder.state==='recording') {
    plRecorder.stop();
    plRecording=false;
    btn.textContent='Record Mic';
    btn.classList.remove('active');
    indicator.style.display='none';
    clearInterval(plRecTimer);
    toast('Processing audio...');
    return;
  }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
    plChunks=[];
    plRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'});
    plRecorder.ondataavailable=e=>{if(e.data.size>0)plChunks.push(e.data);};
    plRecorder.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      plAudioBlob=new Blob(plChunks,{type:'audio/webm'});
      const preview=document.getElementById('pl-input-preview');
      preview.style.display='block';
      preview.textContent='Audio recorded ('+Math.round(plAudioBlob.size/1024)+'KB). Ready to process.';
      toast('Audio ready — set your prompt and hit Process');
    };
    plRecorder.start();
    plRecording=true;
    btn.textContent='Stop Recording';
    btn.classList.add('active');
    indicator.style.display='flex';
    plRecStart=Date.now();
    plRecTimer=setInterval(()=>{
      document.getElementById('pl-rec-time').textContent='Recording... '+Math.floor((Date.now()-plRecStart)/1000)+'s';
    },1000);
    toast('Recording...');
  }).catch(()=>toast('Mic access denied'));
}

function plUploadFile(input) {
  const file=input.files[0];
  if(!file) return;
  plAudioBlob=file;
  const preview=document.getElementById('pl-input-preview');
  preview.style.display='block';
  preview.textContent='File: '+file.name+' ('+Math.round(file.size/1024)+'KB). Ready to process.';
  toast('Audio loaded — set your prompt and hit Process');
  input.value='';
}

// Pipeline drop zone for text/audio files
(function(){
  const panel=document.getElementById('panel-pipeline');
  if(!panel)return;
  panel.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='copy';panel.style.outline='2px dashed var(--accent)';});
  panel.addEventListener('dragleave',()=>{panel.style.outline='none';});
  panel.addEventListener('drop',e=>{
    e.preventDefault();panel.style.outline='none';
    const file=e.dataTransfer.files[0];if(!file)return;
    if(file.type.startsWith('audio/')){plAudioBlob=file;const p=document.getElementById('pl-input-preview');p.style.display='block';p.textContent='Audio: '+file.name+' ('+Math.round(file.size/1024)+'KB)';toast('Audio loaded');}
    else if(file.type.startsWith('text/')||file.name.endsWith('.txt')||file.name.endsWith('.md')){
      const r=new FileReader();r.onload=()=>{plAudioBlob=null;plTranscriptText=r.result;const p=document.getElementById('pl-input-preview');p.style.display='block';p.textContent=plTranscriptText.length>300?plTranscriptText.substring(0,300)+'...':plTranscriptText;toast('Text loaded from '+file.name);};r.readAsText(file);
    }else{toast('Drop audio or text files');}
  });
})();
function plPasteText() {
  navigator.clipboard.readText().then(text=>{
    if(!text){toast('Clipboard empty');return;}
    plAudioBlob=null;
    plTranscriptText=text;
    const preview=document.getElementById('pl-input-preview');
    preview.style.display='block';
    const wc=text.trim().split(/\s+/).filter(x=>x.length).length;
    preview.innerHTML='<div style="font-size:8px;color:var(--accent);margin-bottom:4px">'+text.length+' chars / '+wc+' words</div>'+(text.length>300?esc(text.substring(0,300))+'...':esc(text));
    toast('Text pasted — set your prompt and hit Process');
  }).catch(()=>toast('Cannot read clipboard'));
}

async function plProcess() {
  const prompt=document.getElementById('pl-prompt').value.trim();
  if(!prompt){toast('Enter a prompt first');return;}
  if(!plAudioBlob && !plTranscriptText){toast('Record, upload, or paste something first');return;}

  const btn=document.getElementById('pl-process-btn');
  btn.textContent='Processing...';
  btn.disabled=true;

  try {
    const source=document.getElementById('pl-source').value;
    let res;
    if(plAudioBlob) {
      const fd=new FormData();
      fd.append('audio',plAudioBlob,plAudioBlob.name||'recording.webm');
      fd.append('prompt',prompt);
      fd.append('source',source);
      res=await fetch(ASTRA_API+'/api/pipeline',{method:'POST',headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW},body:fd});
    } else {
      res=await fetch(ASTRA_API+'/api/pipeline',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+ASTRA_ADMIN_PW},body:JSON.stringify({text:plTranscriptText,prompt:prompt,source:source})});
    }
    const data=await res.json();
    if(data.ok) {
      plTranscriptText=data.transcript||'';
      plSynthesisText=data.synthesis||'';
      const resultDiv=document.getElementById('pl-result');
      resultDiv.style.display='block';
      if(data.inputType==='audio'&&data.transcript) {
        document.getElementById('pl-transcript-box').style.display='block';
        document.getElementById('pl-transcript-text').textContent=data.transcript;
      } else {
        document.getElementById('pl-transcript-box').style.display='none';
      }
      document.getElementById('pl-synthesis-text').textContent=data.synthesis;
      plSaveLocal({id:data.pipelineId||('p_'+Date.now()),inputType:data.inputType||'text',prompt:prompt,preview:(data.synthesis||'').substring(0,200),source:source,createdAt:new Date().toISOString()});
      toast('Pipeline complete!');
    } else {
      toast('Error: '+(data.error||'unknown'));
    }
  } catch(e) {
    // Fallback: local text processing if API unavailable
    if(plTranscriptText){
      const result=plLocalProcess(plTranscriptText,prompt);
      plSynthesisText=result;
      document.getElementById('pl-result').style.display='block';
      document.getElementById('pl-transcript-box').style.display='none';
      document.getElementById('pl-synthesis-text').textContent=result;
      plSaveLocal({id:'p_'+Date.now(),inputType:'text',prompt:prompt,preview:result.substring(0,200),source:document.getElementById('pl-source').value,createdAt:new Date().toISOString()});
      toast('Processed locally (API unavailable)');
    } else {
      toast('Pipeline error: '+e.message);
    }
  } finally {
    btn.textContent='Process Pipeline';
    btn.disabled=false;
  }
}
function plLocalProcess(text,prompt){
  const words=text.trim().split(/\s+/).filter(x=>x.length);
  const sentences=text.split(/[.!?]+/).map(s=>s.trim()).filter(Boolean);
  const pl=prompt.toLowerCase();
  if(pl.includes('summar')){return'Summary (local):\n\n'+sentences.slice(0,Math.min(5,Math.ceil(sentences.length/3))).map(s=>'- '+s+'.').join('\n')+'\n\nStats: '+words.length+' words, '+sentences.length+' sentences.';}
  if(pl.includes('action')||pl.includes('task')||pl.includes('checklist')){const actions=sentences.filter(s=>/\b(need|must|should|will|todo|action|fix|add|create|build|update|check|review|send|schedule)\b/i.test(s));return'Action Items (local):\n\n'+(actions.length?actions.map(a=>'[ ] '+a+'.').join('\n'):'No explicit action items found.\n\nAll sentences:\n'+sentences.map(s=>'[ ] '+s+'.').join('\n'));}
  if(pl.includes('clean')||pl.includes('grammar')){return text.replace(/\s+/g,' ').replace(/\s([,.!?;:])/g,'$1').replace(/([.!?])\s*/g,'$1 ').trim();}
  if(pl.includes('count')||pl.includes('stat')){const chars=text.length;const paras=text.split(/\n\s*\n/).filter(Boolean).length;const uniq=[...new Set(words.map(w=>w.toLowerCase()))].length;return'Text Statistics:\n\nWords: '+words.length+'\nCharacters: '+chars+'\nSentences: '+sentences.length+'\nParagraphs: '+paras+'\nUnique words: '+uniq+'\nAvg words/sentence: '+Math.round(words.length/Math.max(1,sentences.length))+'\nReading time: '+Math.max(1,Math.ceil(words.length/238))+' min';}
  if(pl.includes('keyword')||pl.includes('frequent')||pl.includes('top word')){const freq={};words.forEach(w=>{const lw=w.toLowerCase().replace(/[^a-z0-9]/g,'');if(lw.length>3){freq[lw]=(freq[lw]||0)+1;}});const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,20);return'Top Keywords (local):\n\n'+sorted.map(([w,c])=>w+': '+c+' times').join('\n');}
  if(pl.includes('bullet')||pl.includes('list')){return'Bullet Points (local):\n\n'+sentences.map(s=>'- '+s.charAt(0).toUpperCase()+s.slice(1)+'.').join('\n');}
  if(pl.includes('question')||pl.includes('faq')){const qs=sentences.filter(s=>/\?|who|what|when|where|why|how|which|can|could|should|would|is|are|do|does/i.test(s));return'Questions Found (local):\n\n'+(qs.length?qs.map(q=>'Q: '+q+(q.endsWith('?')?'':'?')).join('\n\n'):'No explicit questions found in the text.');}
  if(pl.includes('headline')||pl.includes('title')){const caps=sentences.slice(0,5).map(s=>{const w=s.split(/\s+/).slice(0,8).join(' ');return w.split(' ').map(x=>x.charAt(0).toUpperCase()+x.slice(1).toLowerCase()).join(' ');});return'Headline Suggestions (local):\n\n'+caps.map((h,i)=>(i+1)+'. '+h).join('\n');}
  return'Processed text (local - API unavailable):\n\nInput: '+words.length+' words, '+sentences.length+' sentences.\n\nKey sentences:\n'+sentences.slice(0,5).map(s=>'- '+s+'.').join('\n')+'\n\nNote: For advanced processing (AI summarization, translation, etc.), configure OPENAI_API_KEY in Vercel environment variables.';
}
function plSaveTemplate(){
  const prompt=document.getElementById('pl-prompt').value.trim();
  if(!prompt){toast('Write a prompt first');return;}
  const name=window.prompt('Template name:',prompt.substring(0,30));
  if(!name)return;
  if(!S.pipelineTemplates)S.pipelineTemplates=[];
  S.pipelineTemplates.push({name:name.trim(),prompt,created:new Date().toISOString()});
  save();plRenderCustomTemplates();toast('Template saved: '+name.trim());
}
function plRenderCustomTemplates(){
  const el=document.getElementById('pl-custom-templates');if(!el)return;
  const tpls=S.pipelineTemplates||[];
  if(!tpls.length){el.innerHTML='';return;}
  el.innerHTML=tpls.map((t,i)=>`<button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='${escA(t.prompt)}'" style="font-size:8px;padding:2px 6px;border-color:rgba(74,222,128,0.15)" title="${escA(t.prompt)}">${esc(t.name)}</button><span style="font-size:7px;color:var(--text-muted);cursor:pointer;opacity:0.4" onclick="plDeleteTemplate(${i})" title="Delete template">x</span>`).join('');
}
function plDeleteTemplate(idx){
  if(!S.pipelineTemplates||!S.pipelineTemplates[idx])return;
  S.pipelineTemplates.splice(idx,1);save();plRenderCustomTemplates();toast('Template deleted');
}

function plCopyResult() {
  const text=document.getElementById('pl-synthesis-text').textContent;
  navigator.clipboard.writeText(text).then(()=>toast('Copied!')).catch(()=>toast('Copy failed'));
}

function plSaveCapture() {
  fetch(ASTRA_API+'/api/capture',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+ASTRA_ADMIN_PW},body:JSON.stringify({
    content:plSynthesisText,category:'pipeline',source:'pipeline-ui',sourceTitle:'Pipeline Result',type:'synthesis',tags:['pipeline','processed']
  })}).then(r=>r.json()).then(d=>{
    if(d.ok) toast('Saved to ASTRA!');
    else toast('Save error');
  }).catch(()=>toast('Save failed'));
}
function plSaveToContent(){
  const text=plSynthesisText||document.getElementById('pl-synthesis-text').textContent;
  if(!text){toast('No result to save');return;}
  const prompt=document.getElementById('pl-prompt').value.trim();
  const src=document.getElementById('pl-source').value.replace('pipeline-','');
  S.content.unshift({id:Date.now(),body:text,theme:'pipeline',tags:['pipeline',src].filter(Boolean),created:new Date().toISOString()});
  save();toast('Saved to Content section');
  if(currentSection==='content')renderContent();
}

async function plLoadHistory() {
  const histDiv=document.getElementById('pl-history');
  const listDiv=document.getElementById('pl-history-list');
  histDiv.style.display=histDiv.style.display==='none'?'block':'none';
  if(histDiv.style.display==='none') return;
  listDiv.innerHTML='<div style="font-size:10px;color:var(--text-muted)">Loading...</div>';
  let results=[];
  let source='none';
  try {
    if(ASTRA_ADMIN_PW){
      const res=await fetch(ASTRA_API+'/api/pipeline',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}});
      const data=await res.json();
      if(data.ok && data.results && data.results.length>0){results=data.results;source='cloud';}
    }
  } catch(e){}
  if(!results.length && S.pipelineHistory && S.pipelineHistory.length){results=S.pipelineHistory;source='local';}
  const hq=(document.getElementById('pl-history-search')?.value||'').toLowerCase();
  if(hq)results=results.filter(r=>((r.preview||'')+(r.prompt||'')+(r.source||'')).toLowerCase().includes(hq));
  if(results.length>0){
    const srcColors={'pipeline-manual':'var(--accent)','pipeline-whatsapp':'#25d366','pipeline-voice':'#a855f7','pipeline-capture':'#fbbf24'};
    listDiv.innerHTML=(source==='local'?'<div style="font-size:9px;color:var(--text-muted);margin-bottom:8px;padding:4px 8px;background:var(--bg-elevated);border-radius:3px">Showing local history ('+results.length+' entries)</div>':'')+results.map((r,i)=>{const full=r.preview||'';const short=full.length>150?full.substring(0,150)+'...':full;const sc=srcColors[r.source]||'var(--text-muted)';const srcLabel=(r.source||'').replace('pipeline-','');return '<div style="padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;margin-bottom:8px;cursor:pointer" onclick="this.querySelector(\'.pl-full\').style.display=this.querySelector(\'.pl-full\').style.display===\'none\'?\'block\':\'none\';this.querySelector(\'.pl-short\').style.display=this.querySelector(\'.pl-short\').style.display===\'none\'?\'block\':\'none\'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:4px"><div style="display:flex;gap:4px;align-items:center"><span class="badge badge-blue" style="font-size:9px">'+esc(r.inputType||'text')+'</span><span style="font-size:8px;padding:2px 6px;border-radius:3px;border:1px solid '+sc+';color:'+sc+'">'+esc(srcLabel||'manual')+'</span></div><span style="font-size:9px;color:var(--text-muted)">'+new Date(r.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})+'</span></div>'+(r.prompt?'<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;font-style:italic;border-left:2px solid var(--accent);padding-left:8px">'+esc(r.prompt)+'</div>':'')+'<div class="pl-short" style="font-size:11px;line-height:1.5;color:var(--text-secondary)">'+esc(short)+(full.length>150?' <span style="color:var(--accent);font-size:9px">[click to expand]</span>':'')+'</div><div class="pl-full" style="display:none;font-size:11px;line-height:1.6;color:var(--text);white-space:pre-wrap">'+esc(full)+'</div><div style="display:flex;gap:4px;margin-top:8px" onclick="event.stopPropagation()"><button class="btn btn-sm btn-ghost" onclick="navigator.clipboard.writeText('+JSON.stringify(full).replace(/'/g,"\\'")+');toast(\'Copied\')">Copy</button><button class="btn btn-sm btn-ghost btn-danger" onclick="plDeleteEntry('+i+');event.stopPropagation()">Delete</button></div></div>';}).join('');
  } else {
    listDiv.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">P</div><div style="font-size:11px">No pipeline history yet</div><div style="font-size:10px;margin-top:4px">Paste text, write a prompt, and hit Process</div></div>';
  }
}

function plDeleteEntry(idx){
  if(!confirm('Delete this pipeline entry?'))return;
  if(S.pipelineHistory&&S.pipelineHistory[idx]){S.pipelineHistory.splice(idx,1);save();plLoadHistory();plLoadHistory();toast('Deleted');}
}
function plClearResult(){
  document.getElementById('pl-result').style.display='none';
  document.getElementById('pl-input-preview').style.display='none';
  plAudioBlob=null;plTranscriptText='';plSynthesisText='';
  document.getElementById('pl-prompt').value='';
}
async function plViewEntry(id) {
  try {
    const res=await fetch(ASTRA_API+'/api/pipeline',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}});
    const data=await res.json();
    const entry=(data.results||[]).find(r=>r.id===id);
    if(entry) {
      document.getElementById('pl-synthesis-text').textContent=entry.preview||'(load full entry)';
      document.getElementById('pl-result').style.display='block';
      toast('Loaded: '+id);
    }
  } catch(e) { toast('Error loading entry'); }
}

// === REPOS ===
function timeAgo(dateStr){
  if(!dateStr)return '';
  const d=new Date(dateStr),now=new Date(),ms=now-d,s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60),dy=Math.floor(h/24);
  if(dy>30)return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if(dy>0)return dy+'d ago';if(h>0)return h+'h ago';if(m>0)return m+'m ago';return 'just now';
}
function reposRefresh() {
  if(!S.repos || !S.repos.length) {
    S.repos = [
      { name:'astra-command-center', github:'https://github.com/gabosaturno11/astra-command-center', live:'https://astra-command-center-sigma.vercel.app', role:'backend-hub', status:'active', desc:'ASTRA V2 command center, project hub, KB, whiteboard, API backend', updatedAt:new Date().toISOString() },
      { name:'saturno-bonus', github:'https://github.com/gabosaturno11/saturno-bonus', live:'https://saturno-bonus-omega.vercel.app', role:'customer-facing', status:'active', desc:'Bonus vault for SM Academy customers. 60 tools, 15 PDFs, music player.', updatedAt:new Date().toISOString() },
      { name:'titan-forge', github:'https://github.com/gabosaturno11/titan-forge', live:'https://titan-forge-ten.vercel.app', role:'internal-tools', status:'active', desc:'Internal tools collection. Bonus page moved out to saturno-bonus.', updatedAt:new Date().toISOString() },
      { name:'de-aqui-a-saturno', github:'https://github.com/gabosaturno11/de-aqui-a-saturno', live:'https://de-aqui-a-saturno-jet.vercel.app', role:'experience', status:'complete', desc:'Valentine crystal cosmic scroll. Gate, 18 chapters, 11 love dimensions.', updatedAt:'2026-02-14T00:00:00Z' },
      { name:'nexus-capture', github:'https://github.com/gabosaturno11/nexus-capture', live:null, role:'extension', status:'active', desc:'Chrome extension for universal highlight capture. Routes to ASTRA API.', updatedAt:new Date().toISOString() },
    ];
    save();
  }
  const grid=document.getElementById('repos-grid');
  if(!grid) return;
  const rq=(document.getElementById('repo-search')?.value||'').toLowerCase();
  let repos=S.repos||[];
  if(rq)repos=repos.filter(r=>(r.name+' '+r.role+' '+r.desc+' '+r.status).toLowerCase().includes(rq));
  const cntEl=document.getElementById('repos-count');if(cntEl)cntEl.textContent=(S.repos||[]).length;
  const roleColors={'backend-hub':'var(--accent)','customer-facing':'#22d3ee','internal-tools':'#a855f7','experience':'#f472b6','extension':'#fbbf24'};
  const roleIcons={'backend-hub':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/></svg>','customer-facing':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>','internal-tools':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>','experience':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>','extension':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>'};
  if(!repos.length){grid.innerHTML=`<div style="text-align:center;padding:30px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">R</div><div style="font-size:12px">${rq?'No matching repos':'No repos connected'}</div><div style="font-size:10px;margin-top:4px">${rq?'Try a different filter':'Click + Add to connect a repository'}</div></div>`;return;}
  grid.innerHTML=repos.map(r=>{
    const rc=roleColors[r.role]||'var(--text-muted)';
    const sc=r.status==='active'?'var(--green)':r.status==='complete'?'var(--accent-cyan)':'var(--text-muted)';
    const icon=roleIcons[r.role]||'';
    return `<div style="padding:14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);transition:all 0.15s" onmouseenter="this.style.borderColor='rgba(255,255,255,0.08)'" onmouseleave="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span style="color:${rc};flex-shrink:0">${icon}</span>
        <span style="font-size:13px;font-weight:600;color:var(--text);flex:1">${esc(r.name)}</span>
        <span style="width:8px;height:8px;border-radius:50%;background:${sc}" title="${r.status}"></span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.06em;color:${rc}">${esc(r.role)}</span>
        ${r.updatedAt?'<span style="font-size:8px;color:var(--text-muted)">'+timeAgo(r.updatedAt)+'</span>':''}
      </div>
      <div style="font-size:11px;color:var(--text-secondary);margin-bottom:${r.notes||r.lastCommit||r.stack?'4':'10'}px;line-height:1.5">${esc(r.desc)}</div>${r.stack?`<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px">${r.stack.split(',').map(t=>`<span style="font-size:7px;padding:1px 5px;border-radius:8px;border:1px solid rgba(74,222,128,0.2);color:var(--accent);letter-spacing:0.03em">${esc(t.trim())}</span>`).join('')}</div>`:''}${r.lastCommit?`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px;font-family:var(--mono);padding:3px 6px;background:var(--bg-deep);border-radius:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">last: ${esc(r.lastCommit)}</div>`:''}${r.notes?`<div style="font-size:10px;color:var(--accent);margin-bottom:10px;padding:4px 6px;background:rgba(74,222,128,0.04);border-radius:4px;border-left:2px solid var(--accent);line-height:1.4">${esc(r.notes)}</div>`:''}
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <a href="${escA(r.github)}" target="_blank" style="font-size:10px;color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:3px"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg> repo</a>
        ${r.live?`<a href="${escA(r.live)}" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:${r.lastCheck?(r.lastCheckOk?'var(--green)':'var(--red)'):'var(--green)'};display:inline-block"></span> live${r.lastCheck?' ('+timeAgo(r.lastCheck)+')':''}</a>`:'<span style="font-size:10px;color:var(--text-muted)">local only</span>'}
        <span style="flex:1"></span>
        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();openRepoModal('${escA(r.name)}')" style="font-size:9px;padding:2px 6px">Edit</button>
        <button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();deleteRepo('${escA(r.name)}')" style="font-size:9px;padding:2px 6px">Del</button>
      </div>
    </div>`;
  }).join('');
}

async function repoHealthCheck(){
  const repos=(S.repos||[]).filter(r=>r.live);
  if(!repos.length){toast('No repos with live URLs');return;}
  toast('Checking '+repos.length+' live URLs...');
  let ok=0,fail=0;
  for(const r of repos){
    try{
      const res=await fetch(r.live,{mode:'no-cors',signal:AbortSignal.timeout(5000)});
      r.lastCheck=new Date().toISOString();r.lastCheckOk=true;ok++;
    }catch(e){r.lastCheck=new Date().toISOString();r.lastCheckOk=false;fail++;}
  }
  save();reposRefresh();toast(ok+' up, '+fail+' down');
}

// === REPO MODAL ===
let editingRepoName=null;
function openRepoModal(name){
  editingRepoName=name||null;
  document.getElementById('repo-modal-title').textContent=name?'Edit Repo':'Add Repo';
  if(name){
    const r=(S.repos||[]).find(x=>x.name===name);
    if(r){document.getElementById('rm-name').value=r.name;document.getElementById('rm-github').value=r.github||'';document.getElementById('rm-live').value=r.live||'';document.getElementById('rm-role').value=r.role||'other';document.getElementById('rm-status').value=r.status||'active';document.getElementById('rm-desc').value=r.desc||'';document.getElementById('rm-notes').value=r.notes||'';document.getElementById('rm-lastcommit').value=r.lastCommit||'';document.getElementById('rm-stack').value=r.stack||'';}
  } else {
    document.getElementById('rm-name').value='';document.getElementById('rm-github').value='';document.getElementById('rm-live').value='';document.getElementById('rm-role').value='other';document.getElementById('rm-status').value='active';document.getElementById('rm-desc').value='';document.getElementById('rm-notes').value='';document.getElementById('rm-lastcommit').value='';document.getElementById('rm-stack').value='';
  }
  document.getElementById('repo-modal').classList.add('open');
  setTimeout(()=>document.getElementById('rm-name').focus(),100);
}
function closeRepoModal(){document.getElementById('repo-modal').classList.remove('open');editingRepoName=null;}
function saveRepo(){
  const name=document.getElementById('rm-name').value.trim();
  if(!name){toast('Name required');return;}
  const notes=document.getElementById('rm-notes').value.trim();
  const lastCommit=document.getElementById('rm-lastcommit').value.trim();
  const stack=document.getElementById('rm-stack').value.trim();
  const data={name,github:document.getElementById('rm-github').value.trim(),live:document.getElementById('rm-live').value.trim()||null,role:document.getElementById('rm-role').value,status:document.getElementById('rm-status').value,desc:document.getElementById('rm-desc').value.trim(),notes:notes||undefined,lastCommit:lastCommit||undefined,stack:stack||undefined,updatedAt:new Date().toISOString()};
  if(!S.repos)S.repos=[];
  if(editingRepoName){
    const idx=S.repos.findIndex(r=>r.name===editingRepoName);
    if(idx>=0)S.repos[idx]=data;
    else S.repos.push(data);
  } else {
    if(S.repos.find(r=>r.name===name)){toast('Repo already exists');return;}
    S.repos.push(data);
  }
  save();closeRepoModal();reposRefresh();toast(editingRepoName?'Updated':'Added');
}
function deleteRepo(name){
  if(!confirm('Delete repo "'+name+'"?'))return;
  S.repos=(S.repos||[]).filter(r=>r.name!==name);
  save();reposRefresh();toast('Deleted');
}
async function reposHealthCheck(){
  const repos=(S.repos||[]).filter(r=>r.live);
  if(!repos.length){toast('No live URLs to check');return;}
  toast('Checking '+repos.length+' live URLs...');
  const results=await Promise.allSettled(repos.map(r=>fetch(r.live,{mode:'no-cors',cache:'no-cache'}).then(()=>({name:r.name,ok:true})).catch(()=>({name:r.name,ok:false}))));
  const summary=results.map(r=>r.value||r.reason);
  const up=summary.filter(s=>s&&s.ok).length;
  toast(up+'/'+repos.length+' repos responding');
  summary.forEach(s=>{if(s){const repo=(S.repos||[]).find(r=>r.name===s.name);if(repo){repo.lastCheck=new Date().toISOString();repo.lastCheckOk=s.ok;}}});
  save();reposRefresh();
}

if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{});}
</script>
</body>
</html>
