<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#050508">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SATURNO HUB">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>SATURNO HUB</title>
<style>
:root {
  --bg-void: #050508;
  --bg-deep: #0a0a0e;
  --bg-surface: #101014;
  --bg-elevated: #161619;
  --bg-hover: #1c1c20;
  --bg-input: #121215;
  --border: rgba(255,255,255,0.04);
  --border-hover: rgba(255,255,255,0.08);
  --border-active: rgba(74,222,160,0.35);
  --accent: #4ade80;
  --accent-glow: rgba(74,222,160,0.06);
  --accent-secondary: #2dd4bf;
  --accent-cyan: #22d3ee;
  --green: #4ade80;
  --yellow: #fbbf24;
  --orange: #fb923c;
  --red: #f87171;
  --text: rgba(255,255,255,0.90);
  --text-secondary: rgba(255,255,255,0.50);
  --text-muted: rgba(255,255,255,0.22);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  --radius: 8px;
  --radius-lg: 12px;
  --transition-fast: all 0.12s cubic-bezier(0.4,0,0.2,1);
  --transition-smooth: all 0.25s cubic-bezier(0.4,0,0.2,1);
  --sidebar-width: 220px;
  --context-width: 320px;
  --project-width: 420px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg-void);color:var(--text-secondary);height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}

.app{display:grid;grid-template-columns:var(--sidebar-width) 4px 1fr;height:100vh;transition:grid-template-columns 0.25s cubic-bezier(0.4,0,0.2,1)}
.app.project-open{grid-template-columns:var(--sidebar-width) 4px 1fr 5px var(--project-width)}
.app.project-open .project-view{display:flex}
.app.context-open{grid-template-columns:var(--sidebar-width) 4px 1fr 4px var(--context-width)}
.app.context-open .context-panel{display:flex}
.app.context-open .context-resize{display:block}
.app.mode-focus{grid-template-columns:1fr}
.app.mode-focus .sidebar{display:none}
.app.mode-focus .writer-sidebar{display:flex!important}
.app.mode-focus .sidebar-resize{display:none}
.app.mode-extended{grid-template-columns:var(--sidebar-width) 4px 1fr 4px var(--context-width)}
.app.mode-extended .context-panel{display:flex}
.app.mode-extended .context-resize{display:block}
.context-resize{display:none}
.project-resize-handle{width:5px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0;display:none}
.app.project-open .project-resize-handle{display:block}
.project-resize-handle:hover,.project-resize-handle.dragging{background:var(--accent);opacity:0.4}
.project-resize-handle::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:3px;height:32px;border-radius:2px;background:var(--text-muted);opacity:0}

/* RESIZE HANDLES */
.sidebar-resize{width:4px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0}
.sidebar-resize:hover,.sidebar-resize.dragging{background:var(--accent);opacity:0.3}
.context-resize{width:4px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0}
.context-resize:hover,.context-resize.dragging{background:var(--accent);opacity:0.3}

/* SIDEBAR */
.sidebar{background:linear-gradient(180deg, #080810 0%, #060608 100%);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
.logo{font-size:13px;font-weight:700;color:var(--accent);letter-spacing:0.5px;animation:logoBreathe 4s ease-in-out infinite}
@keyframes logoBreathe{0%,100%{opacity:0.85}50%{opacity:1}}
.logo-sub{font-size:9px;color:var(--text-muted);margin-top:2px;letter-spacing:0.3px}
.sidebar-section{padding:12px}
.sidebar-label{font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;padding:0 8px;margin-bottom:6px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:12px;color:var(--text-secondary)}
.sidebar-item:hover{background:var(--bg-hover);color:var(--text)}
.sidebar-item.active{background:var(--accent-glow);color:var(--accent)}
.sidebar-item-icon{width:16px;text-align:center;font-size:11px;opacity:0.4;font-family:var(--mono);display:flex;align-items:center;justify-content:center}
.sidebar-item-icon svg{opacity:0.7}
.sidebar-item.active .sidebar-item-icon svg{opacity:1}
.sidebar-item-count{margin-left:auto;font-size:10px;color:var(--text-muted);font-family:var(--mono)}
.sidebar-kbd{font-size:8px;color:var(--text-muted);font-family:var(--mono);opacity:0;padding:1px 4px;border:1px solid var(--border);border-radius:3px;margin-left:auto;transition:opacity 0.15s}
.sidebar-item:hover .sidebar-kbd{opacity:0.5}
.sidebar-divider{height:1px;background:var(--border);margin:4px 12px}
.sidebar-header{position:relative}
.sidebar-toggle-btn{padding:3px 5px!important}
.sidebar-collapse-chevron{display:flex;align-items:center;justify-content:center;padding:12px;cursor:pointer;color:var(--text-muted);transition:var(--transition-fast);border-top:1px solid var(--border);margin-top:auto;flex-shrink:0}
.sidebar-collapse-chevron:hover{color:var(--text);background:var(--bg-hover)}
.sidebar-collapse-chevron svg{opacity:0.5;transition:opacity 0.15s}
.sidebar-collapse-chevron:hover svg{opacity:1}
.project-collapse-chevron{display:flex;align-items:center;justify-content:center;padding:10px;cursor:pointer;color:var(--text-muted);transition:var(--transition-fast);border-top:1px solid var(--border);flex-shrink:0}
.project-collapse-chevron:hover{color:var(--text);background:var(--bg-hover)}
.project-collapse-chevron svg{opacity:0.5;transition:opacity 0.15s}
.project-collapse-chevron:hover svg{opacity:1}

/* COLLAPSED SIDEBAR — icon-only strip */
.app.sidebar-collapsed{grid-template-columns:52px 0px 1fr}
.app.sidebar-collapsed.project-open{grid-template-columns:52px 0px 1fr 5px var(--project-width)}
.app.sidebar-collapsed.context-open,.app.sidebar-collapsed.mode-extended{grid-template-columns:52px 0px 1fr 4px var(--context-width)}
.app.sidebar-collapsed .sidebar-resize{display:none}
.app.sidebar-collapsed .sidebar{overflow-x:hidden;overflow-y:auto}
.app.sidebar-collapsed .sidebar-header{padding:14px 0;display:flex;justify-content:center}
.app.sidebar-collapsed .logo{font-size:0;width:24px;height:24px;background:var(--accent);border-radius:50%;display:block}
.app.sidebar-collapsed .logo::after{content:'S';font-size:12px;font-weight:700;color:#09090b;display:flex;align-items:center;justify-content:center;width:100%;height:100%}
.app.sidebar-collapsed .logo-sub{display:none}
.app.sidebar-collapsed .sidebar-label{display:none}
.app.sidebar-collapsed .sidebar-item span:not(.sidebar-item-icon){display:none}
.app.sidebar-collapsed .sidebar-item-count{display:none}
.app.sidebar-collapsed .sidebar-kbd{display:none}
.app.sidebar-collapsed .sidebar-section:not(:first-of-type){display:none}
.app.sidebar-collapsed .sidebar-divider{display:none}
.app.sidebar-collapsed #sidebar-dash{display:none!important}
.app.sidebar-collapsed .sidebar-section{padding:6px 4px}
.app.sidebar-collapsed .sidebar-item{padding:10px 0;justify-content:center;gap:0;border-radius:8px;margin:2px 6px}
.app.sidebar-collapsed .sidebar-item-icon{width:auto;opacity:0.6}
.app.sidebar-collapsed .sidebar-item.active .sidebar-item-icon{opacity:1}
.app.sidebar-collapsed #sidebar-context{display:none}
.app.sidebar-collapsed #sidebar-bottom{display:none!important}
.app.sidebar-collapsed .sidebar-collapse-chevron svg{transform:rotate(180deg)}

/* MAIN */
.main{display:flex;flex-direction:column;overflow:hidden}
.header{height:48px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0;background:var(--bg-void)}
.header-title{font-size:14px;font-weight:600;color:var(--text)}
.header-actions{display:flex;gap:6px;margin-left:auto}
.content-area{flex:1;overflow-y:auto;padding:20px}

/* BUTTONS */
.btn{padding:5px 10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-surface);color:var(--text-secondary);font-family:var(--font);font-size:10px;font-weight:500;cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:4px}
.btn:hover{border-color:var(--border-active);color:var(--text)}
.btn-primary{background:var(--accent);color:#09090b;border:none;font-weight:600}
.btn-primary:hover{opacity:0.9;box-shadow:0 2px 12px rgba(74,222,160,0.25)}
.btn-sm{padding:3px 7px;font-size:9px}
.btn-ghost{background:transparent;border:none}
.btn-ghost:hover{background:var(--bg-hover)}
.btn-danger:hover{color:var(--red);border-color:rgba(239,68,68,0.4)}

/* INPUTS */
input,select,textarea{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:var(--font);padding:6px 10px;font-size:11px;transition:all 0.15s;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--border-active);box-shadow:0 0 0 2px var(--accent-glow)}
textarea{resize:vertical;line-height:1.6}

/* BADGES */
.badge{font-family:var(--mono);font-size:8px;letter-spacing:0.5px;text-transform:uppercase;padding:2px 6px;border-radius:3px;line-height:1}
.badge-blue{background:rgba(74,222,160,0.12);color:var(--accent)}
.badge-purple{background:rgba(139,92,246,0.15);color:var(--accent-secondary)}
.badge-green{background:rgba(34,197,94,0.15);color:var(--green)}
.badge-yellow{background:rgba(234,179,8,0.15);color:var(--yellow)}
.badge-orange{background:rgba(249,115,22,0.15);color:var(--orange)}
.badge-red{background:rgba(239,68,68,0.15);color:var(--red)}
.badge-muted{background:rgba(255,255,255,0.06);color:var(--text-muted)}

/* TABS */
.tab-bar{display:flex;gap:2px}
.tab-btn{padding:5px 10px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:10px;font-weight:500;cursor:pointer;border-radius:var(--radius);transition:all 0.15s}
.tab-btn:hover{color:var(--text-secondary);background:var(--bg-surface)}
.tab-btn.active{background:var(--accent-glow);color:var(--accent)}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg-elevated);border-radius:3px}

/* PANELS */
.panel{display:none;height:100%;flex-direction:column;opacity:0;transition:opacity 0.15s ease}
.panel.active{display:flex;opacity:1}

/* CONTENT VAULT */
.content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;padding-top:12px}
.content-card{background:linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;position:relative}
.content-card:hover{border-color:var(--border-hover);box-shadow:0 4px 16px rgba(0,0,0,0.35);transform:translateY(-1px)}
.content-card-body{font-size:12px;color:var(--text-secondary);line-height:1.7;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow:hidden;cursor:pointer;position:relative}
.content-card-body.expanded{max-height:none;overflow:visible}
.content-card-body:not(.expanded)::after{content:'';position:absolute;bottom:0;left:0;right:0;height:30px;background:linear-gradient(transparent,var(--bg-surface))}
.content-card-footer{display:flex;align-items:center;gap:6px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border)}
.content-card-actions{display:flex;gap:4px;margin-left:auto;opacity:0;transition:opacity 0.15s}
.content-card:hover .content-card-actions{opacity:1}

/* TASK MANAGER */
.task-toolbar{display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:1px solid var(--border);margin-bottom:0;flex-wrap:wrap}
.task-toolbar-search{flex:1;max-width:260px;margin-left:auto}
.task-table-header{display:grid;grid-template-columns:36px 1fr 110px 110px 110px 100px 50px;padding:6px 0;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-void);z-index:5}
.task-table-header-cell{font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;padding:0 4px}
.task-row{display:grid;grid-template-columns:36px 1fr 110px 110px 110px 100px 50px;align-items:center;min-height:40px;border-bottom:1px solid var(--border);transition:background 0.1s;border-left:3px solid transparent}
.task-row.priority-p0{border-left-color:#ef4444}
.task-row.priority-p1{border-left-color:#f59e0b}
.task-row.priority-p2{border-left-color:#3b82f6}
.task-row.priority-p3{border-left-color:var(--border)}
.task-row:nth-child(even of .task-row){background:rgba(255,255,255,0.008)}
.task-row:hover{background:var(--bg-hover)}
.task-row.overdue{background:rgba(239,68,68,0.04)}
.task-row.blocked-row{background:rgba(251,191,36,0.04);border-left-color:#fbbf24}
.task-row.in-progress-row{border-left-color:var(--accent);background:rgba(74,222,128,0.02)}
.task-row.dragging-over{border-top:2px solid var(--accent)}
.task-checkbox{width:15px;height:15px;border:2px solid var(--border-hover);border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;margin:0 auto}
.task-checkbox:hover{border-color:var(--accent)}
.task-checkbox.checked{background:var(--green);border-color:var(--green)}
.task-checkbox.checked::after{content:'';width:4px;height:7px;border:solid #fff;border-width:0 1.5px 1.5px 0;transform:rotate(45deg);margin-bottom:1px}
.task-title-input{background:transparent;border:none;color:var(--text);font-size:12px;padding:4px 0;width:100%}
.task-title-input:focus{outline:none}
.task-title-input::placeholder{color:var(--text-muted)}
.task-row.completed .task-title-input{text-decoration:line-through;opacity:0.4}
.task-select{background:transparent;border:1px solid transparent;color:var(--text-secondary);font-size:10px;padding:4px 6px;cursor:pointer}
.task-select:hover{background:var(--bg-input);border-color:var(--border)}
.task-actions{display:flex;gap:2px;opacity:0}
.task-row:hover .task-actions{opacity:1}
.task-action-btn{width:22px;height:22px;border-radius:3px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center}
.task-action-btn:hover{background:var(--bg-input);color:var(--text)}
.task-action-btn.del:hover{color:var(--red)}
.add-task-row{display:flex;align-items:center;gap:8px;padding:10px 0 10px 36px;color:var(--text-muted);cursor:pointer;font-size:12px}
.add-task-row:hover{color:var(--text-secondary)}

/* Board */
.board-view{display:none;gap:12px;overflow-x:auto;flex:1}
.board-view.active{display:flex}
.board-col{min-width:250px;flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);display:flex;flex-direction:column;max-height:100%}
.board-col-header{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}
.board-col-title{font-size:11px;font-weight:600;color:var(--text-secondary)}
.board-col-count{font-size:10px;color:var(--text-muted);font-family:var(--mono);margin-left:auto}
.board-col-tasks{padding:6px;flex:1;overflow-y:auto;transition:background 0.15s}
.board-col-tasks.drag-over{background:rgba(74,222,128,0.05);outline:1px dashed var(--accent);outline-offset:-2px}
.board-card{background:linear-gradient(135deg, var(--bg-elevated) 0%, #1e1e22 100%);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:6px;cursor:grab;transition:all 0.15s}
.board-card:hover{border-color:var(--border-hover);box-shadow:0 4px 12px rgba(0,0,0,0.35);transform:translateY(-1px)}
.board-card-title{font-size:12px;color:var(--text);margin-bottom:4px}
.board-card-desc{font-size:10px;color:var(--text-muted);margin-bottom:6px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.board-card-subtasks{font-size:9px;color:var(--text-muted);margin-bottom:4px;font-family:var(--mono)}
.board-card-subtasks .done{color:var(--accent)}
.board-card-meta{display:flex;gap:4px;flex-wrap:wrap;align-items:center}
.task-detail-modal{position:fixed;inset:0;z-index:1500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.task-detail-modal.open{display:flex}
.task-detail-inner{background:var(--bg-deep);border:1px solid var(--border);border-radius:var(--radius-lg);width:540px;max-width:95vw;max-height:85vh;overflow-y:auto;padding:24px}
.task-detail-inner h3{font-size:16px;font-weight:600;color:var(--text);margin-bottom:16px}
.td-field{margin-bottom:14px}
.td-field label{display:block;font-size:10px;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
.td-field input,.td-field textarea,.td-field select{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);padding:8px 10px;font-size:13px;font-family:var(--font)}
.td-field textarea{min-height:80px;resize:vertical;line-height:1.6}
.td-field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.td-subtasks{margin-top:8px}
.td-subtask{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px}
.td-subtask input[type=checkbox]{accent-color:var(--accent)}
.td-subtask input[type=text]{flex:1;background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text);padding:2px 0;font-size:12px;outline:none}
.td-subtask input[type=text]:focus{border-color:var(--accent)}
.td-subtask .del{opacity:0;cursor:pointer;color:var(--red);font-size:10px;transition:opacity 0.1s}
.td-subtask:hover .del{opacity:1}
.td-add-subtask{font-size:11px;color:var(--text-muted);cursor:pointer;padding:4px 0;margin-top:4px}
.td-add-subtask:hover{color:var(--accent)}
.td-footer{display:flex;gap:8px;margin-top:20px;justify-content:space-between}
.td-created{font-size:9px;color:var(--text-muted);margin-top:12px}

/* Calendar */
.calendar-shell{display:flex;flex-direction:column;height:100%}
.calendar-nav{display:flex;align-items:center;gap:12px;padding-bottom:12px;flex-shrink:0}
.calendar-month-label{font-size:15px;font-weight:600;color:var(--text)}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border-radius:var(--radius-lg);overflow:hidden;flex:1}
.calendar-day-header{padding:8px;background:var(--bg-surface);font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;text-align:center}
.calendar-day{background:var(--bg-void);padding:6px;min-height:80px;cursor:pointer;transition:background 0.1s;overflow-y:auto}
.calendar-day:hover{background:var(--bg-deep)}
.calendar-day.other{opacity:0.25}
.calendar-day.today{background:rgba(74,222,160,0.06)}
.calendar-day.cal-overdue{background:rgba(239,68,68,0.04);border-left:2px solid var(--red)}
.calendar-day.cal-drag-over{background:rgba(74,222,128,0.08);outline:1px dashed var(--accent);outline-offset:-2px}
.week-day.cal-drag-over{background:rgba(74,222,128,0.08);outline:1px dashed var(--accent);outline-offset:-2px}
.calendar-day-num{font-size:11px;font-weight:500;color:var(--text-secondary);margin-bottom:4px}
.calendar-day.today .calendar-day-num{width:22px;height:22px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px}
.calendar-task-pill{font-size:9px;padding:2px 5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text-secondary);cursor:grab;border-left:2px solid var(--border)}
.calendar-task-pill.pill-p0{border-left-color:#ef4444}
.calendar-task-pill.pill-p1{border-left-color:#f59e0b}
.calendar-task-pill.pill-p2{border-left-color:#3b82f6}
.calendar-task-pill:hover{border-color:var(--accent)}
.calendar-task-pill.dragging{opacity:0.4}
.cal-view-toggle{display:flex;gap:2px;background:var(--bg-surface);border-radius:var(--radius);padding:2px}
.cal-view-btn{padding:4px 10px;border:none;background:transparent;color:var(--text-muted);font-size:10px;border-radius:4px;cursor:pointer;font-family:var(--font)}
.cal-view-btn.active{background:var(--bg-elevated);color:var(--text)}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border-radius:var(--radius-lg);overflow:hidden;flex:1}
.week-day{background:var(--bg-void);padding:8px;min-height:120px;display:flex;flex-direction:column;gap:4px;overflow-y:auto}
.week-day.today{background:rgba(74,222,160,0.06)}
.week-day-header{font-size:10px;color:var(--text-muted);font-weight:600;text-align:center;padding:4px;margin-bottom:4px;font-family:var(--mono)}
.week-day-header .day-num{font-size:13px;color:var(--text-secondary);display:block;margin-top:2px}
.week-day.today .week-day-header .day-num{background:var(--accent);color:#fff;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center}
.week-task-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px 8px;cursor:grab;transition:all 0.1s;font-size:10px}
.week-task-card:hover{border-color:var(--accent)}
.week-task-card .wt-title{color:var(--text);font-size:11px;margin-bottom:2px}
.week-task-card .wt-meta{display:flex;gap:4px;align-items:center}
.week-add{font-size:9px;color:var(--text-muted);cursor:pointer;padding:4px 0;text-align:center}
.week-add:hover{color:var(--accent)}

/* Links */
.links-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;padding-top:12px}
.link-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;cursor:pointer;display:flex;flex-direction:column;gap:6px}
.link-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 16px rgba(74,222,160,0.08)}
.link-card-title{font-size:12px;font-weight:600;color:var(--text)}
.link-card-url{font-family:var(--mono);font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.link-card-desc{font-size:10px;color:var(--text-secondary);line-height:1.5}
.link-card-footer{display:flex;gap:4px;align-items:center;margin-top:auto}
.link-card-actions{margin-left:auto;display:flex;gap:2px;opacity:0}
.link-card:hover .link-card-actions{opacity:1}

/* WRITING HUB */
.writer-shell{display:flex;height:100%;overflow:hidden}
.writer-sidebar{width:200px;min-width:160px;max-width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0;overflow:hidden}
.writer-doc-list{flex:1;overflow-y:auto;padding:6px}
.writer-doc-item{padding:8px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:2px}
.writer-doc-item:hover{background:var(--bg-hover)}
.writer-doc-item.active{background:var(--accent-glow)}
.writer-doc-title{font-size:11px;color:var(--text);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.writer-doc-meta{font-size:9px;color:var(--text-muted);margin-top:2px;display:flex;gap:8px}
.writer-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.writer-toolbar{display:flex;align-items:center;gap:2px;padding:6px 8px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:none}.writer-toolbar::-webkit-scrollbar{display:none}
.writer-toolbar-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:12px;display:flex;align-items:center;justify-content:center;transition:all 0.1s;font-weight:600}
.writer-toolbar-btn:hover{background:var(--bg-hover);color:var(--text)}
.writer-toolbar-btn.active{background:var(--accent-glow);color:var(--accent)}
.writer-toolbar-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.writer-toolbar-select{background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);font-size:10px;padding:4px 6px;border-radius:var(--radius);width:auto;cursor:pointer}
.writer-title-input{background:transparent;border:none;color:var(--text);font-size:22px;font-weight:700;padding:20px 28px 8px;width:100%;letter-spacing:-0.3px}
.writer-title-input:focus{outline:none}
.writer-title-input::placeholder{color:var(--text-muted)}
.writer-editor{flex:1;overflow-y:auto;padding:0 28px 40px;font-size:15px;line-height:1.85;color:var(--text-secondary);outline:none;min-height:200px}
.writer-editor:empty::before{content:attr(data-placeholder);color:var(--text-muted)}
.writer-editor h1{font-size:24px;font-weight:700;color:var(--text);margin:24px 0 8px;line-height:1.3}
.writer-editor h2{font-size:18px;font-weight:600;color:var(--text);margin:20px 0 6px}
.writer-editor h3{font-size:15px;font-weight:600;color:var(--text);margin:16px 0 4px}
.writer-editor p{margin-bottom:12px}
.writer-editor blockquote{border-left:3px solid var(--accent);padding-left:16px;margin:12px 0;color:var(--text-muted);font-style:italic}
.writer-editor ul,.writer-editor ol{margin:8px 0;padding-left:24px}
.writer-editor li{margin-bottom:4px}
.writer-editor code{background:var(--bg-surface);padding:1px 4px;border-radius:3px;font-family:var(--mono);font-size:13px;color:var(--accent)}
.writer-editor pre{background:var(--bg-surface);padding:12px;border-radius:var(--radius);font-family:var(--mono);font-size:12px;overflow-x:auto;margin:12px 0;border:1px solid var(--border)}
.writer-editor hr{border:none;border-top:1px solid var(--border);margin:20px 0}
.writer-statusbar{display:flex;align-items:center;gap:16px;padding:4px 12px;border-top:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--text-muted);flex-shrink:0}
.writer-right-panel{width:240px;border-left:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0;overflow-y:auto;padding:12px}
.writer-right-panel.hidden{display:none}

/* ZEN WRITER — Full-screen distraction-free writing overlay */
.zen-writer{position:fixed;inset:0;z-index:2000;background:var(--bg-void);display:none;flex-direction:column;opacity:0;transition:opacity 0.3s cubic-bezier(0.4,0,0.2,1)}
.zen-writer.open{display:flex;opacity:1}
.zen-writer-topbar{display:flex;align-items:center;gap:8px;padding:8px 20px;border-bottom:1px solid var(--border);flex-shrink:0;background:linear-gradient(180deg, rgba(10,10,14,0.95) 0%, rgba(5,5,8,0.95) 100%);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.zen-doc-picker{background:var(--bg-input);border:1px solid var(--border);color:var(--text);font-size:11px;padding:5px 10px;border-radius:var(--radius);cursor:pointer;max-width:220px}
.zen-doc-picker:focus{outline:none;border-color:var(--accent)}
.zen-toolbar{display:flex;align-items:center;gap:1px;flex:1;justify-content:center;flex-wrap:wrap}
.zen-tb{width:30px;height:30px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:6px;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all 0.12s;font-weight:600}
.zen-tb:hover{background:var(--bg-hover);color:var(--text)}
.zen-tb.active{background:var(--accent-glow);color:var(--accent)}
.zen-tb-sep{width:1px;height:20px;background:var(--border);margin:0 6px}
.zen-tb-select{background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);font-size:11px;padding:4px 8px;border-radius:var(--radius);cursor:pointer}
.zen-tb-select:focus{outline:none;border-color:var(--accent)}
.zen-close-btn{width:30px;height:30px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:6px;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.12s;margin-left:8px}
.zen-close-btn:hover{background:rgba(248,113,113,0.15);color:var(--red)}
.zen-body{flex:1;display:flex;flex-direction:column;overflow:hidden;max-width:780px;width:100%;margin:0 auto;padding:0 24px}
.zen-title{background:transparent;border:none;color:var(--text);font-size:28px;font-weight:700;padding:32px 0 12px;width:100%;letter-spacing:-0.5px;line-height:1.2}
.zen-title:focus{outline:none}
.zen-title::placeholder{color:var(--text-muted)}
.zen-editor{flex:1;overflow-y:auto;padding:0 0 80px;font-size:17px;line-height:2;color:rgba(255,255,255,0.78);outline:none;caret-color:var(--accent);letter-spacing:0.01em}
.zen-editor:empty::before{content:attr(data-placeholder);color:var(--text-muted);font-style:italic}
.zen-editor h1{font-size:28px;font-weight:700;color:var(--text);margin:28px 0 10px;line-height:1.3;letter-spacing:-0.3px}
.zen-editor h2{font-size:22px;font-weight:600;color:var(--text);margin:24px 0 8px;letter-spacing:-0.2px}
.zen-editor h3{font-size:17px;font-weight:600;color:var(--text);margin:20px 0 6px}
.zen-editor p{margin-bottom:16px}
.zen-editor blockquote{border-left:3px solid var(--accent);padding:4px 0 4px 20px;margin:16px 0;color:rgba(255,255,255,0.45);font-style:italic}
.zen-editor ul,.zen-editor ol{margin:10px 0;padding-left:28px}
.zen-editor li{margin-bottom:6px}
.zen-editor code{background:rgba(74,222,160,0.08);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:15px;color:var(--accent)}
.zen-editor pre{background:var(--bg-surface);padding:16px;border-radius:var(--radius);font-family:var(--mono);font-size:13px;overflow-x:auto;margin:16px 0;border:1px solid var(--border);line-height:1.6}
.zen-editor hr{border:none;border-top:1px solid var(--border);margin:28px 0}
.zen-editor a{color:var(--accent-cyan);text-decoration:underline;text-underline-offset:2px}
.zen-editor ::selection{background:rgba(74,222,160,0.2)}
.zen-statusbar{display:flex;align-items:center;gap:20px;padding:8px 24px;border-top:1px solid var(--border);font-family:var(--mono);font-size:10px;color:var(--text-muted);flex-shrink:0;max-width:780px;width:100%;margin:0 auto}
.zen-statusbar span{transition:color 0.2s}
.zen-fab{position:fixed;bottom:20px;right:20px;z-index:900;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,rgba(74,222,160,0.15) 0%,rgba(34,211,238,0.1) 100%);border:1px solid rgba(74,222,160,0.25);color:var(--accent);cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,0.4);transition:all 0.2s;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.zen-fab:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(74,222,160,0.2);border-color:var(--accent)}
.zen-fab svg{opacity:0.8}
.zen-fab:hover svg{opacity:1}
.writer-version-item{padding:8px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:4px;border:1px solid var(--border)}
.writer-version-item:hover{background:var(--bg-hover);border-color:var(--border-hover)}
.writer-version-title{font-size:10px;color:var(--text);font-weight:500}
.writer-version-meta{font-size:9px;color:var(--text-muted);margin-top:2px}

/* LIVING DOCS */
.specs-shell{display:flex;height:100%;overflow:hidden}
.specs-sidebar{width:220px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0}
.specs-doc-list{flex:1;overflow-y:auto;padding:6px}
.specs-doc-item{padding:10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:2px;border-left:3px solid transparent}
.specs-doc-item:hover{background:var(--bg-hover)}
.specs-doc-item.active{background:var(--accent-glow);border-left-color:var(--accent)}
.specs-doc-title{font-size:11px;color:var(--text);font-weight:600}
.specs-doc-meta{font-size:9px;color:var(--text-muted);margin-top:3px;display:flex;gap:8px}
.specs-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.specs-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.specs-title-input{background:transparent;border:none;color:var(--text);font-size:18px;font-weight:700;flex:1}
.specs-title-input:focus{outline:none}
.specs-title-input::placeholder{color:var(--text-muted)}
.specs-sections{flex:1;overflow-y:auto;padding:20px 24px}
.specs-section{margin-bottom:20px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.specs-section-header{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;transition:background 0.15s}
.specs-section-header:hover{background:var(--bg-hover)}
.specs-section-title{font-size:12px;font-weight:600;color:var(--text);flex:1}
.specs-section-toggle{font-size:10px;color:var(--text-muted);transition:transform 0.2s}
.specs-section.collapsed .specs-section-toggle{transform:rotate(-90deg)}
.specs-section.collapsed .specs-section-body{display:none}
.specs-section-body{padding:12px 14px;border-top:1px solid var(--border)}
.specs-section-editor{min-height:80px;font-size:13px;line-height:1.7;color:var(--text-secondary);outline:none}
.specs-section-editor:empty::before{content:'Click to add content...';color:var(--text-muted)}
.specs-add-section{padding:10px;text-align:center;color:var(--text-muted);font-size:11px;cursor:pointer;border:1px dashed var(--border);border-radius:var(--radius);transition:all 0.15s}
.specs-add-section:hover{border-color:var(--accent);color:var(--text-secondary)}
.specs-statusbar{display:flex;align-items:center;gap:16px;padding:6px 14px;border-top:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--text-muted);flex-shrink:0}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:linear-gradient(160deg, rgba(21,21,24,0.95) 0%, rgba(19,19,22,0.95) 100%);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.06);border-radius:var(--radius-lg);padding:20px;width:400px;max-width:90vw;max-height:80vh;overflow-y:auto;box-shadow:0 24px 48px rgba(0,0,0,0.6),0 0 0 1px rgba(255,255,255,0.03)}
.modal-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:14px}
.form-group{margin-bottom:12px}
.form-label{font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:block}

/* WHITEBOARD */
.wb-shell{display:flex;height:100%;overflow:hidden;position:relative}
.wb-toolbar{position:absolute;top:10px;left:10px;z-index:20;display:flex;gap:3px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
.wb-tool{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:4px;font-size:11px;display:flex;align-items:center;justify-content:center;transition:all 0.1s;font-weight:600}
.wb-tool:hover{background:var(--bg-hover);color:var(--text)}
.wb-tool.active{background:var(--accent-glow);color:var(--accent)}
.wb-tool-sep{width:1px;background:var(--border);margin:2px 1px}
.wb-top-bar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:20;display:flex;gap:6px;align-items:center}
.wb-zoom{display:flex;align-items:center;gap:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:3px 6px;font-family:var(--mono);font-size:9px;color:var(--text-muted)}
.wb-actions{position:absolute;top:10px;right:10px;z-index:20;display:flex;gap:4px}
.wb-canvas-wrap{width:100%;height:100%;overflow:hidden;cursor:crosshair;position:relative;background:var(--bg-void)}
.wb-canvas{position:absolute;transform-origin:0 0}
.wb-grid{position:absolute;inset:0;pointer-events:none;opacity:0.08}
.wb-svg{position:absolute;inset:0;pointer-events:none;z-index:1}
.wb-node{position:absolute;min-width:120px;min-height:50px;background:var(--bg-surface);border:1.5px solid var(--border);border-radius:var(--radius-lg);cursor:grab;z-index:10;transition:box-shadow 0.15s;display:flex;flex-direction:column}
.wb-node:hover{box-shadow:0 4px 16px rgba(0,0,0,0.4);border-color:var(--border-hover)}
.wb-node.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.wb-node.dragging{opacity:0.8;cursor:grabbing;z-index:50}
.wb-node-header{padding:6px 10px;font-size:11px;font-weight:600;color:var(--text);border-bottom:1px solid var(--border);outline:none;min-height:28px;display:flex;align-items:center}
.wb-node-body{padding:6px 10px;font-size:10px;color:var(--text-secondary);outline:none;flex:1;min-height:22px;line-height:1.5}
.wb-node-color{position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--radius-lg) var(--radius-lg) 0 0}
.wb-node-del{position:absolute;top:-8px;right:-8px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:20}
.wb-node:hover .wb-node-del{display:flex}
.wb-node:hover .wb-node-dup{display:flex}
.wb-node:hover .wb-node-color-btn{opacity:0.7}
.wb-node:hover .wb-lock-btn{opacity:0.6!important}
.wb-node-resize{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:nwse-resize;z-index:15}
.wb-node-port{position:absolute;width:10px;height:10px;border-radius:50%;background:var(--accent);border:2px solid var(--bg-surface);cursor:crosshair;z-index:15;opacity:0;transition:opacity 0.15s}
.wb-node:hover .wb-node-port{opacity:1}
.wb-port-right{right:-5px;top:50%;transform:translateY(-50%)}
.wb-port-bottom{bottom:-5px;left:50%;transform:translateX(-50%)}
.wb-port-left{left:-5px;top:50%;transform:translateY(-50%)}
.wb-port-top{top:-5px;left:50%;transform:translateX(-50%)}
.wb-minimap{position:absolute;bottom:10px;right:10px;width:160px;height:100px;background:linear-gradient(135deg, #0e0e12 0%, #0c0c0f 100%);border:1px solid var(--border);border-radius:var(--radius);z-index:20;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
.wb-minimap-viewport{position:absolute;border:1.5px solid var(--accent);background:rgba(74,222,160,0.06);pointer-events:none}
.wb-minimap-node{position:absolute;background:var(--accent);border-radius:1px;opacity:0.5}
.wb-tpl-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:none;align-items:center;justify-content:center}
.wb-tpl-modal.open{display:flex}
.wb-tpl-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-height:60vh;overflow-y:auto;padding:4px}
.wb-tpl-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;cursor:pointer;transition:all 0.15s;text-align:center}
.wb-tpl-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 16px rgba(74,222,160,0.12)}
.wb-tpl-icon{font-size:24px;margin-bottom:6px}
.wb-tpl-name{font-size:11px;font-weight:600;color:var(--text)}
.wb-tpl-desc{font-size:9px;color:var(--text-muted);margin-top:3px}

/* PROJECTS SIDEBAR */
.sidebar-projects{padding:6px 12px}
.sidebar-project-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:12px;color:var(--text-secondary);position:relative}
.sidebar-project-item:hover{background:var(--bg-hover);color:var(--text)}
.sidebar-project-item.active{background:var(--accent-glow);color:var(--accent)}
.sidebar-project-item .proj-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sidebar-project-item .proj-icon svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.sidebar-project-item .proj-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sidebar-project-item .proj-status{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.sidebar-project-item .proj-status.active-s{background:var(--green)}
.sidebar-project-item .proj-status.paused-s{background:var(--yellow)}
.sidebar-project-item .proj-status.complete-s{background:var(--accent)}
.sidebar-add-project{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:11px;color:var(--text-muted)}
.sidebar-add-project:hover{color:var(--text-secondary);background:var(--bg-hover)}

/* PROJECT DETAIL VIEW — right panel */
.project-view{display:none;flex-direction:column;height:100vh;overflow:hidden;background:linear-gradient(180deg, #080810 0%, #060608 100%);border-left:1px solid var(--border)}
.project-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.project-header .proj-icon-lg{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);border:1px solid var(--border)}
.project-header .proj-icon-lg svg{width:18px;height:18px;stroke:var(--accent);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.project-header-name{font-size:18px;font-weight:700;color:var(--text);flex:1}
.project-header-actions{display:flex;gap:4px;position:relative}
.export-menu{position:absolute;top:100%;right:0;margin-top:6px;background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:var(--radius-lg);padding:6px;min-width:180px;z-index:999;box-shadow:0 8px 32px rgba(0,0,0,0.5);backdrop-filter:blur(20px);animation:fadeIn 0.12s ease}
.export-menu-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:var(--radius);cursor:pointer;font-size:11px;color:var(--text-secondary);transition:all 0.12s}
.export-menu-item:hover{background:var(--bg-hover);color:var(--text)}
.export-menu-item .export-icon{width:16px;text-align:center;font-family:var(--mono);font-size:9px;color:var(--accent)}
.export-menu-label{font-weight:500}
.export-menu-desc{font-size:9px;color:var(--text-muted)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.project-tabs{display:flex;gap:2px;padding:0 24px;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.project-tabs::-webkit-scrollbar{display:none}
.project-tab{white-space:nowrap;flex-shrink:0}
.project-tab{padding:8px 14px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:11px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s}
.project-tab:hover{color:var(--text-secondary)}
.project-tab.active{color:var(--proj-accent, var(--accent));border-bottom-color:var(--proj-accent, var(--accent))}
.project-content{flex:1;overflow-y:auto;padding:20px 24px}

/* PROJECT INSTRUCTIONS */
.proj-instructions-editor{min-height:200px;font-size:14px;line-height:1.8;color:var(--text-secondary);outline:none;padding:12px 0}
.proj-instructions-editor:empty::before{content:'Describe what this project is...';color:var(--text-muted)}
.proj-instructions-editor h1{font-size:22px;font-weight:700;color:var(--text);margin:20px 0 8px}
.proj-instructions-editor h2{font-size:17px;font-weight:600;color:var(--text);margin:16px 0 6px}
.proj-instructions-editor h3{font-size:14px;font-weight:600;color:var(--text);margin:12px 0 4px}
.proj-instructions-editor p{margin-bottom:10px}
.proj-instructions-editor ul,.proj-instructions-editor ol{padding-left:24px;margin:8px 0}
.proj-instructions-editor li{margin-bottom:4px}
.proj-instructions-editor code{background:var(--bg-surface);padding:1px 4px;border-radius:3px;font-family:var(--mono);font-size:12px;color:var(--accent)}
.proj-instructions-editor pre{background:var(--bg-surface);padding:12px;border-radius:var(--radius);font-family:var(--mono);font-size:11px;overflow-x:auto;margin:12px 0;border:1px solid var(--border)}
.proj-instructions-editor blockquote{border-left:3px solid var(--accent);padding-left:16px;margin:12px 0;color:var(--text-muted);font-style:italic}
.proj-instructions-editor table{width:100%;border-collapse:collapse;margin:12px 0;font-size:12px}
.proj-instructions-editor th,.proj-instructions-editor td{border:1px solid var(--border);padding:6px 10px;text-align:left}
.proj-instructions-editor th{background:var(--bg-surface);font-weight:600;color:var(--text)}

/* KNOWLEDGE BASE */
.kb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;padding-top:12px}
.kb-card{background:linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;cursor:pointer;position:relative}
.kb-card:hover{border-color:var(--border-hover);box-shadow:0 2px 12px rgba(0,0,0,0.3);transform:translateY(-1px)}
.kb-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.kb-card-type{font-family:var(--mono);font-size:8px;letter-spacing:0.5px;text-transform:uppercase;padding:2px 6px;border-radius:3px;line-height:1;flex-shrink:0}
.kb-type-md{background:rgba(59,130,246,0.15);color:#60a5fa}
.kb-type-pdf{background:rgba(239,68,68,0.15);color:#f87171}
.kb-type-img{background:rgba(34,197,94,0.15);color:#4ade80}
.kb-type-url{background:rgba(139,92,246,0.15);color:#a78bfa}
.kb-type-txt{background:rgba(255,255,255,0.08);color:var(--text-muted)}
.kb-type-json{background:rgba(251,191,36,0.15);color:#fbbf24}
.kb-type-other{background:rgba(255,255,255,0.06);color:var(--text-muted)}
.kb-card-name{font-size:12px;font-weight:600;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.kb-card-desc{font-size:10px;color:var(--text-secondary);line-height:1.5;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.kb-card-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:8px}
.kb-card-tag{font-family:var(--mono);font-size:7px;padding:1px 5px;background:rgba(255,255,255,0.05);border-radius:3px;color:var(--text-muted)}
.kb-card-actions{position:absolute;top:8px;right:8px;display:flex;gap:2px;opacity:0;transition:opacity 0.15s}
.kb-card:hover .kb-card-actions{opacity:1}
.kb-card-drag{cursor:grab;width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:10px}
.kb-card-img{width:100%;height:100px;object-fit:cover;border-radius:var(--radius);margin-top:8px;border:1px solid var(--border)}
.kb-empty{text-align:center;padding:40px;color:var(--text-muted);font-size:12px}

/* PROJECT LIVING DOCS LIST */
.proj-docs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;padding-top:12px}
.proj-doc-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;cursor:pointer;transition:all 0.2s}
.proj-doc-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 16px rgba(74,222,160,0.08)}
.proj-doc-card-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px}
.proj-doc-card-meta{font-size:9px;color:var(--text-muted);display:flex;gap:8px}
.proj-doc-card-preview{font-size:10px;color:var(--text-secondary);line-height:1.5;margin-top:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* ICON PICKER */
.icon-picker-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1100;display:none;align-items:center;justify-content:center}
.icon-picker-modal.open{display:flex}
.icon-picker-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:50vh;overflow-y:auto;padding:8px}
.icon-picker-item{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius);border:1px solid var(--border);cursor:pointer;transition:all 0.15s;background:var(--bg-surface)}
.icon-picker-item:hover{border-color:var(--accent);background:var(--accent-glow)}
.icon-picker-item.selected{border-color:var(--accent);background:var(--accent-glow);box-shadow:0 0 0 2px rgba(74,222,160,0.2)}
.icon-picker-item svg{width:18px;height:18px;stroke:var(--text-secondary);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.icon-picker-item:hover svg,.icon-picker-item.selected svg{stroke:var(--accent)}

.pm-color-opt{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.pm-color-opt:hover{transform:scale(1.2)}
.pm-color-opt.selected{border-color:#fff;box-shadow:0 0 8px currentColor}

/* KB MODAL */
.kb-modal-tabs{display:flex;gap:2px;margin-bottom:12px}
.kb-modal-tab{padding:5px 10px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:var(--radius);transition:all 0.15s}
.kb-modal-tab:hover{color:var(--text-secondary);background:var(--bg-surface)}
.kb-modal-tab.active{background:var(--accent-glow);color:var(--accent)}
.kb-modal-panel{display:none}
.kb-modal-panel.active{display:block}

/* VOICE INPUT */
.voice-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.voice-btn:hover{background:var(--bg-hover);color:var(--text)}
.voice-btn.recording{background:rgba(239,68,68,0.2);color:var(--red);animation:voice-pulse 1s infinite}
@keyframes voice-pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* WIKI LINKS */
.wiki-link{color:var(--accent);cursor:pointer;border-bottom:1px dashed rgba(74,222,160,0.4);padding-bottom:1px;transition:var(--transition-fast)}
.wiki-link:hover{border-bottom-color:var(--accent);background:var(--accent-glow);border-radius:2px}
.wiki-link-broken{color:var(--red);border-bottom:1px dashed rgba(248,113,113,0.4)}

/* FOLDER TREE */
.folder-tree{padding:4px 0}
.folder-item{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast);font-size:11px;color:var(--text-secondary)}
.folder-item:hover{background:var(--bg-hover);color:var(--text)}
.folder-item.active{background:var(--accent-glow);color:var(--accent)}
.folder-item-icon{font-size:10px;color:var(--text-muted);width:14px;text-align:center}
.folder-item-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.folder-item-count{font-size:9px;color:var(--text-muted);font-family:var(--mono)}

/* COMMAND PALETTE */
.cmd-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);z-index:9000;display:none;align-items:flex-start;justify-content:center;padding-top:20vh}
.cmd-overlay.open{display:flex}
.cmd-box{width:560px;max-width:90vw;background:linear-gradient(180deg, #101014 0%, #0c0c0f 100%);border:1px solid var(--border-hover);border-radius:var(--radius-lg);box-shadow:0 24px 80px rgba(0,0,0,0.7);overflow:hidden;animation:cmdSlideIn 0.15s ease}
@keyframes cmdSlideIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
.cmd-input-wrap{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);gap:10px}
.cmd-input-icon{color:var(--text-muted);font-size:14px;flex-shrink:0}
.cmd-input{flex:1;background:none;border:none;color:var(--text);font-size:15px;font-family:var(--font);outline:none}
.cmd-input::placeholder{color:var(--text-muted)}
.cmd-hint{font-size:9px;color:var(--text-muted);font-family:var(--mono);flex-shrink:0}
.cmd-results{max-height:360px;overflow-y:auto;padding:6px}
.cmd-item{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast)}
.cmd-item:hover,.cmd-item.active{background:var(--bg-hover)}
.cmd-item.active{background:var(--accent-glow);border:1px solid rgba(74,222,160,0.15)}
.cmd-item-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);font-size:12px;color:var(--text-muted);flex-shrink:0}
.cmd-item-text{flex:1;min-width:0}
.cmd-item-title{font-size:13px;color:var(--text);font-weight:500}
.cmd-item-desc{font-size:10px;color:var(--text-muted);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cmd-item-badge{font-family:var(--mono);font-size:8px;padding:2px 6px;border-radius:3px;background:rgba(255,255,255,0.05);color:var(--text-muted)}
.cmd-footer{display:flex;align-items:center;gap:12px;padding:8px 14px;border-top:1px solid var(--border);font-size:9px;color:var(--text-muted);font-family:var(--mono)}
.cmd-key{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 4px;background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:3px;font-size:9px;color:var(--text-muted)}

/* CONTEXT PANEL */
.context-panel{display:none;flex-direction:column;height:100vh;overflow:hidden;background:linear-gradient(180deg, #0a0a0e 0%, #080810 100%);border-left:1px solid var(--border)}
.context-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.context-header-title{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;flex:1}
.context-close{width:22px;height:22px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:12px;display:flex;align-items:center;justify-content:center}
.context-close:hover{background:var(--bg-hover);color:var(--text)}
.context-body{flex:1;overflow-y:auto;padding:12px 16px}
.context-section{margin-bottom:16px}
.context-section-title{font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.context-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast);font-size:11px;color:var(--text-secondary)}
.context-item:hover{background:var(--bg-hover);color:var(--text)}
.context-item-icon{width:14px;text-align:center;font-size:10px;color:var(--text-muted);flex-shrink:0}

/* MODE SWITCHER */
.mode-switcher{display:flex;align-items:center;gap:2px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:2px}
.mode-btn{padding:3px 8px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:9px;font-weight:500;cursor:pointer;border-radius:4px;transition:var(--transition-fast);text-transform:uppercase;letter-spacing:0.3px}
.mode-btn:hover{color:var(--text-secondary)}
.mode-btn.active{background:var(--accent-glow);color:var(--accent)}

/* FOCUS TIMER EMBEDDED */
.focus-timer-panel{padding:16px}
.ft-circle-wrap{position:relative;width:160px;height:160px;margin:0 auto 16px}
.ft-circle{width:100%;height:100%;transform:rotate(-90deg)}
.ft-circle .ft-track{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:6}
.ft-circle .ft-progress{fill:none;stroke:var(--accent);stroke-width:6;stroke-linecap:round;stroke-dasharray:440.9;stroke-dashoffset:440.9;transition:stroke-dashoffset 1s ease,stroke 0.3s ease;filter:drop-shadow(0 0 8px var(--accent))}
.ft-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.ft-time{font-size:28px;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums;letter-spacing:-0.02em}
.ft-label{font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;margin-top:2px}
.ft-controls{display:flex;justify-content:center;gap:8px}
.ft-btn{padding:6px 16px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-secondary);font-size:11px;font-weight:500;cursor:pointer;transition:var(--transition-fast)}
.ft-btn:hover{border-color:var(--border-active);color:var(--text)}
.ft-btn.running{background:var(--accent);color:var(--bg-void);border-color:var(--accent)}
.ft-categories{display:flex;flex-wrap:wrap;gap:4px;margin-top:12px;justify-content:center}
.ft-cat{padding:3px 8px;border:1px solid var(--border);border-radius:var(--radius);font-size:9px;color:var(--text-muted);cursor:pointer;transition:var(--transition-fast)}
.ft-cat:hover{border-color:var(--border-hover);color:var(--text-secondary)}
.ft-cat.active{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}
.ft-time-adjust{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:10px}
.ft-adj-btn{width:24px;height:24px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition-fast)}
.ft-adj-btn:hover{background:var(--accent);color:var(--bg-void);border-color:var(--accent)}

/* RESPONSIVE */
@media(max-width:900px){
  :root{--sidebar-width:180px;--context-width:260px}
  .writer-sidebar{width:160px}
  .specs-sidebar{width:180px}
  .content-grid{grid-template-columns:1fr}
  .links-grid{grid-template-columns:1fr}
}
@media(max-width:640px){
  .app{grid-template-columns:1fr!important}
  .sidebar{position:fixed;left:-220px;top:0;bottom:0;width:220px;z-index:100;transition:left 0.25s}
  .sidebar.mobile-open{left:0}
  .sidebar-resize{display:none!important}
  .context-panel{display:none!important}
  .context-resize{display:none!important}
  .writer-shell{flex-direction:column}
  .writer-sidebar{width:100%;height:auto;max-height:120px;border-right:none;border-bottom:1px solid var(--border)}
  .writer-right-panel{display:none}
  .specs-shell{flex-direction:column}
  .specs-sidebar{width:100%;height:auto;max-height:120px;border-right:none;border-bottom:1px solid var(--border)}
  .mobile-hamburger{display:block!important}
  .mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
  .mobile-overlay.open{display:block}
  .board-columns{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap}
  .board-column{min-width:240px;flex-shrink:0}
  .calendar-grid{font-size:9px}
  .calendar-day{min-height:50px;padding:2px}
  .week-grid{grid-template-columns:1fr!important;gap:4px}
  .week-day{min-height:60px}
  .task-detail-inner{width:95vw;padding:16px}
  .panel-project{position:fixed;inset:0;z-index:110;width:100%!important;max-width:100%!important}
  .header{padding:4px 8px}
  .header-left{gap:6px}
}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg, #101014 0%, #161619 100%);border:1px solid rgba(74,222,160,0.12);border-radius:var(--radius);padding:8px 14px;font-size:11px;color:var(--text);opacity:0;transform:translateY(10px);transition:all 0.3s;z-index:2000;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
.toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">SATURNO HUB</div>
      <div class="logo-sub">v2.0 — Command Center</div>
      <div id="sidebar-date" style="font-size:9px;color:var(--text-muted);font-family:var(--mono);margin-top:2px"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Sections</div>
      <div class="sidebar-item active" onclick="switchSection('content',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span><span>Content</span>
        <span class="sidebar-item-count" id="content-count">0</span><span class="sidebar-kbd">1</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('tasks',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span><span>Tasks</span>
        <span class="sidebar-item-count" id="tasks-count">0</span><span class="sidebar-kbd">2</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('calendar',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span><span>Calendar</span><span class="sidebar-kbd">3</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('writer',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></svg></span><span>Writing Hub</span>
        <span class="sidebar-item-count" id="writer-count">0</span><span class="sidebar-kbd">4</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('specs',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span><span>Living Docs</span>
        <span class="sidebar-item-count" id="specs-count">0</span><span class="sidebar-kbd">5</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('links',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></span><span>Links</span>
        <span class="sidebar-item-count" id="links-count">0</span><span class="sidebar-kbd">6</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('whiteboard',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></span><span>Whiteboard</span><span class="sidebar-kbd">7</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('pipeline',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg></span><span>Pipeline</span><span class="sidebar-kbd">8</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('repos',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/><path d="M1 12h6m6 0h6"/></svg></span><span>Repos</span><span class="sidebar-kbd">9</span>
      </div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section">
      <div class="sidebar-label" style="display:flex;align-items:center;justify-content:space-between">
        <span>Projects</span>
        <span class="sidebar-add-project" onclick="openNewProjectModal()" style="padding:0;font-size:13px;font-weight:600" title="New Project">+</span>
      </div>
      <div id="sidebar-projects"></div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section" id="sidebar-folders-section">
      <div class="sidebar-label" style="display:flex;align-items:center;justify-content:space-between">
        <span>Folders</span>
        <span onclick="addFolderFromSidebar()" style="padding:0;font-size:13px;font-weight:600;cursor:pointer;color:var(--text-muted)" title="New Folder">+</span>
      </div>
      <div class="folder-tree" id="sidebar-folder-tree"></div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section" id="sidebar-context"></div>
    <div id="sidebar-bottom" style="margin-top:auto;padding:12px">
      <button class="btn btn-sm" style="width:100%;margin-bottom:6px;justify-content:center;gap:6px" onclick="openCommandPalette()">
        <span style="font-size:10px">Search</span>
        <span style="font-family:var(--mono);font-size:8px;padding:1px 4px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px">K</span>
      </button>
      <button class="btn btn-sm" style="width:100%;margin-bottom:4px" onclick="window.open('https://calendar.google.com','_blank')">Google Calendar</button>
      <div id="sidebar-dash" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:6px">
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:600" id="dash-tasks">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Tasks</div>
        </div>
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--accent-cyan);font-weight:600" id="dash-docs">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Docs</div>
        </div>
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--yellow);font-weight:600" id="dash-projects">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Proj</div>
        </div>
      </div>
      <div style="font-family:var(--mono);font-size:8px;color:var(--text-muted);text-align:center;margin-top:4px">
        <span id="storage-indicator">0 KB</span> used
      </div>
      <div style="display:flex;gap:4px;margin-top:6px">
        <button class="btn btn-sm" style="flex:1" onclick="exportAll()">Export</button>
        <button class="btn btn-sm" style="flex:1" onclick="importAll()">Import</button>
      </div>
      <button class="btn btn-sm btn-danger" style="width:100%;margin-top:4px;font-size:8px;opacity:0.5" onclick="undoImport()">Undo Import</button>
    </div>
    <div class="sidebar-collapse-chevron" onclick="toggleSidebar()" title="Collapse sidebar">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg>
    </div>
  </aside>
  <div class="sidebar-resize" id="sidebar-resize"></div>

  <main class="main">
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileSidebar()"></div>
    <div class="header">
      <button class="mobile-hamburger" onclick="openMobileSidebar()" style="display:none;background:none;border:none;color:var(--text);cursor:pointer;padding:4px"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <button class="btn btn-sm btn-ghost sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar" id="sidebar-toggle-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg></button>
      <span class="header-title" id="header-title">Content</span>
      <span id="header-breadcrumb" style="font-size:10px;color:var(--text-muted);font-family:var(--mono);display:flex;align-items:center;gap:4px"></span>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <span id="header-stats" style="font-size:8px;color:var(--text-muted);font-family:var(--mono);display:flex;gap:8px;align-items:center"></span>
        <span id="save-indicator" style="font-family:var(--mono);font-size:8px;color:var(--text-muted);opacity:0;transition:opacity 0.3s">Saved</span>
        <input type="text" id="header-search" placeholder="Search... (Cmd+K)" onfocus="this.blur();openCommandPalette()" style="font-size:9px;padding:3px 8px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;width:120px;font-family:var(--mono);cursor:pointer" readonly>
        <span id="cloud-sync-indicator" onclick="cloudSave()" title="Click to sync" style="cursor:pointer;font-size:12px;opacity:0.5;transition:all 0.3s">&#9729;</span>
        <div class="mode-switcher">
          <button class="mode-btn" onclick="setMode('focus')" id="mode-focus-btn" title="Focus: Primary only">F</button>
          <button class="mode-btn active" onclick="setMode('default')" id="mode-default-btn" title="Default">D</button>
          <button class="mode-btn" onclick="setMode('extended')" id="mode-extended-btn" title="Extended: Show context panel">E</button>
        </div>
        <button class="btn btn-sm btn-ghost" onclick="openCommandPalette()" title="Command Palette (Cmd+K)" style="font-family:var(--mono);font-size:9px;padding:3px 8px;gap:4px">
          <span class="cmd-key" style="min-width:14px;height:14px;font-size:8px">K</span>
        </button>
        <div class="header-actions" id="header-actions"></div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="panel active" id="panel-content">
      <div style="padding:16px 20px 0;display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <div class="tab-bar" id="content-type-tabs">
          <button class="tab-btn active" onclick="setContentType('all',this)">All</button>
          <button class="tab-btn" onclick="setContentType('caption',this)">Captions</button>
          <button class="tab-btn" onclick="setContentType('quote',this)">Quotes</button>
        </div>
        <div class="tab-bar" id="content-theme-tabs" style="margin-left:8px;border-left:1px solid var(--border);padding-left:8px"></div>
        <div style="margin-left:auto;display:flex;gap:6px">
          <input type="text" id="content-search" placeholder="Search..." oninput="renderContent()" style="width:140px;font-size:10px;padding:5px 8px">
          <select id="content-sort" onchange="renderContent()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="longest">Longest</option>
            <option value="shortest">Shortest</option>
            <option value="alpha">A-Z</option>
            <option value="shuffle">Shuffle</option>
            <option value="theme">By Theme</option>
            <option value="type">By Type</option>
            <option value="tag">By Tag</option>
            <option value="source">By Source</option>
          </select>
          <span id="content-word-total" style="font-size:8px;color:var(--text-muted);font-family:var(--mono)"></span>
          <button class="btn btn-sm" onclick="randomContent()" title="Random content for inspiration">Random</button>
          <button class="btn btn-sm" onclick="exportContent()" title="Export all content as markdown">Export</button>
          <button class="btn btn-sm" onclick="exportFilteredContent()" title="Export currently filtered content">Export View</button>
          <button class="btn btn-sm" onclick="contentManageTags()" title="Rename or delete tags">Tags</button>
          <button class="btn btn-sm" onclick="batchImportContent()" title="Paste multiple items separated by ---">Batch</button>
          <button class="btn btn-sm" onclick="toggleAllContentCards()" title="Expand/collapse all cards">Exp/Col</button>
          <button class="btn btn-sm" onclick="copyAllContent()" title="Copy all visible content to clipboard">Copy All</button>
          <button class="btn btn-sm" onclick="exportFilteredContentMD()" title="Copy filtered content as Markdown">Export MD</button>
          <button class="btn btn-sm" onclick="toggleContentCompact()" id="content-compact-btn" title="Toggle compact list view">Compact</button>
          <button class="btn btn-sm" onclick="contentReadLaterFilter=!contentReadLaterFilter;this.style.color=contentReadLaterFilter?'var(--accent-cyan)':'';renderContent()" id="content-rl-btn" title="Show only Read Later items">RL</button>
          <button class="btn btn-sm" onclick="contentShowArchived=!contentShowArchived;this.style.color=contentShowArchived?'var(--yellow)':'';renderContent()" id="content-archive-btn" title="Show/hide archived content">Archived</button>
          <button class="btn btn-sm" onclick="contentFindDuplicates()" title="Find duplicate/similar content items" style="color:#f59e0b">Dupes</button>
          <button class="btn btn-sm" onclick="contentWordCloud()" title="Generate word cloud from content" style="color:#a855f7">Cloud</button>
          <button class="btn btn-sm" id="content-bulk-btn" onclick="toggleContentBulk()" title="Select multiple">Select</button>
          <div id="content-bulk-actions" style="display:none;gap:4px">
            <button class="btn btn-sm btn-danger" onclick="contentBulkDelete()">Delete Selected</button>
            <button class="btn btn-sm" onclick="contentBulkTag()">Tag Selected</button>
            <button class="btn btn-sm" onclick="mergeContent()">Merge Selected</button>
            <button class="btn btn-sm" onclick="contentBulkExport()">Export Selected</button>
            <button class="btn btn-sm" onclick="toggleContentBulk()">Cancel</button>
          </div>
          <button class="btn btn-sm" onclick="tagAllVisibleContent()" title="Add a tag to all currently visible items">Tag All</button>
          <button class="btn btn-primary btn-sm" onclick="openContentModal()">+ Add</button>
        </div>
      </div>
      <div id="content-tag-pills" style="padding:0 20px;display:flex;gap:4px;flex-wrap:wrap;flex-shrink:0"></div>
      <div class="content-area"><div class="content-grid" id="content-grid"></div></div>
    </div>

    <!-- TASKS -->
    <div class="panel" id="panel-tasks">
      <div style="padding:12px 20px 0;flex-shrink:0">
        <div class="task-toolbar">
          <button class="btn btn-primary btn-sm" onclick="addTask()">+ Task</button>
          <div class="btn-group" style="position:relative;display:inline-block"><button class="btn btn-sm" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'" title="Task templates">T</button><div style="display:none;position:absolute;top:100%;left:0;z-index:100;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:4px;min-width:160px;box-shadow:0 8px 24px rgba(0,0,0,0.4)"><div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;letter-spacing:0.05em">Quick Templates</div><div class="task-tpl" onclick="addTaskFromTemplate('Daily standup','p1','daily')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Daily standup</div><div class="task-tpl" onclick="addTaskFromTemplate('Code review','p2','weekly')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Code review (weekly)</div><div class="task-tpl" onclick="addTaskFromTemplate('Content batch','p1','weekly')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Content batch (weekly)</div><div class="task-tpl" onclick="addTaskFromTemplate('Write session','p1','daily')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Write session (daily)</div><div class="task-tpl" onclick="addTaskFromTemplate('Deploy check','p2','weekday')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Deploy check (weekday)</div></div></div>
          <div class="tab-bar">
            <button class="tab-btn active" id="task-view-list" onclick="setTaskView('list')">List</button>
            <button class="tab-btn" id="task-view-board" onclick="setTaskView('board')">Board</button>
            <button class="tab-btn" id="task-view-eisenhower" onclick="setTaskView('eisenhower')" title="Eisenhower Matrix">EH</button>
          </div>
          <div class="tab-bar" style="margin-left:8px">
            <button class="tab-btn active" id="task-filter-all" onclick="setTaskFilter('all')">All</button>
            <button class="tab-btn" id="task-filter-active" onclick="setTaskFilter('active')">Active</button>
            <button class="tab-btn" id="task-filter-todo" onclick="setTaskFilter('todo')">Todo</button>
            <button class="tab-btn" id="task-filter-progress" onclick="setTaskFilter('progress')">WIP</button>
            <button class="tab-btn" id="task-filter-blocked" onclick="setTaskFilter('blocked')">Blocked</button>
            <button class="tab-btn" id="task-filter-done" onclick="setTaskFilter('done')">Done</button>
            <button class="tab-btn" id="task-filter-overdue" onclick="setTaskFilter('overdue')" style="color:var(--red)">Overdue</button>
            <button class="tab-btn" id="task-filter-urgent" onclick="setTaskFilter('urgent')" style="color:var(--orange)">Urgent</button>
          </div>
          <select id="task-project-filter" onchange="filterTaskProject(this.value||null)" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;max-width:100px"><option value="">All Projects</option></select>
          <select id="task-sort" onchange="renderTasks()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px">
            <option value="manual">Manual</option>
            <option value="priority">Priority</option>
            <option value="due">Due Date</option>
            <option value="newest">Newest</option>
            <option value="alpha">A-Z</option>
            <option value="completed">Completed</option>
            <option value="project">By Project</option>
            <option value="time">Time Spent</option>
            <option value="status">By Status</option>
            <option value="estimate">By Estimate</option>
            <option value="tag">By Tag</option>
          </select>
          <button class="btn btn-sm" onclick="exportTasks()" title="Copy tasks as markdown">Export</button>
          <span id="task-count-info" style="font-size:8px;color:var(--text-muted);font-family:var(--mono)"></span>
          <button class="btn btn-sm" onclick="toggleTaskBulk()" id="task-bulk-btn">Bulk</button>
          <div id="task-bulk-actions" style="display:none;gap:4px;align-items:center">
            <select id="task-bulk-status" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="">Set Status</option><option value="todo">To Do</option><option value="progress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select>
            <select id="task-bulk-priority" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="">Set Priority</option><option value="p0">P0</option><option value="p1">P1</option><option value="p2">P2</option><option value="p3">P3</option></select>
            <input type="date" id="task-bulk-due" style="font-size:9px;padding:3px 4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;width:110px" title="Set due date">
            <button class="btn btn-sm" onclick="taskBulkTag()" style="color:var(--accent-cyan)">Tag</button>
            <button class="btn btn-sm" onclick="taskBulkMove()" style="color:var(--accent)">Move</button>
            <button class="btn btn-sm btn-danger" onclick="taskBulkDelete()">Delete</button>
            <button class="btn btn-sm" onclick="taskBulkApply()">Apply</button>
            <button class="btn btn-sm" onclick="taskBulkSelectAll()">All</button>
            <button class="btn btn-sm" onclick="taskSelected.clear();renderTasks()">None</button>
            <button class="btn btn-sm" onclick="toggleTaskBulk()">Cancel</button>
          </div>
          <button class="btn btn-sm" onclick="archiveCompletedTasks()" title="Archive all completed tasks">Archive Done</button>
          <button class="btn btn-sm" id="task-filter-archived" onclick="showArchivedTasks()" title="View archived tasks">Archived<span id="archived-count" style="font-size:8px;color:var(--text-muted);margin-left:3px;font-family:var(--mono)"></span></button>
          <button class="btn btn-sm" onclick="taskManageTags()" title="Manage task tags (rename/delete/merge)" style="font-size:9px">Tags</button>
          <div class="task-toolbar-search">
            <input type="text" id="task-search" placeholder="Search tasks..." oninput="renderTasks()" style="font-size:10px;padding:5px 8px">
          </div>
          <button class="btn btn-sm" id="task-clear-filters" onclick="clearTaskFilters()" style="display:none;color:var(--red);font-size:8px" title="Clear all filters">Clear</button>
        </div>
      </div>
      <div class="content-area" id="task-content-area">
        <div id="task-list-view">
          <div class="task-table-header">
            <div class="task-table-header-cell"></div>
            <div class="task-table-header-cell">Task</div>
            <div class="task-table-header-cell">Status</div>
            <div class="task-table-header-cell">Priority</div>
            <div class="task-table-header-cell">Project</div>
            <div class="task-table-header-cell">Due</div>
            <div class="task-table-header-cell"></div>
          </div>
          <div id="task-rows"></div>
        </div>
        <div class="board-view" id="task-board-view">
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">To Do</span><span class="board-col-count" id="bc-todo" oncontextmenu="event.preventDefault();boardMoveAll('todo')">0</span></div><div class="board-col-tasks" id="board-todo" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'todo')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">In Progress</span><span class="board-col-count" id="bc-progress" oncontextmenu="event.preventDefault();boardMoveAll('progress')">0</span></div><div class="board-col-tasks" id="board-progress" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'progress')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">Done</span><span class="board-col-count" id="bc-done" oncontextmenu="event.preventDefault();boardMoveAll('done')">0</span></div><div class="board-col-tasks" id="board-done" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'done')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">Blocked</span><span class="board-col-count" id="bc-blocked" oncontextmenu="event.preventDefault();boardMoveAll('blocked')">0</span></div><div class="board-col-tasks" id="board-blocked" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'blocked')"></div></div>
        </div>
        <div id="task-eisenhower-view" style="display:none;flex:1;display:none;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:8px;padding:8px;overflow:auto">
          <div class="eh-quad" style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius);padding:12px;overflow-y:auto"><div style="font-size:11px;font-weight:700;color:#ef4444;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Urgent + Important (DO)</div><div id="eh-q1"></div></div>
          <div class="eh-quad" style="background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.3);border-radius:var(--radius);padding:12px;overflow-y:auto"><div style="font-size:11px;font-weight:700;color:#eab308;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Not Urgent + Important (SCHEDULE)</div><div id="eh-q2"></div></div>
          <div class="eh-quad" style="background:rgba(249,115,22,0.08);border:1px solid rgba(249,115,22,0.3);border-radius:var(--radius);padding:12px;overflow-y:auto"><div style="font-size:11px;font-weight:700;color:#f97316;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Urgent + Not Important (DELEGATE)</div><div id="eh-q3"></div></div>
          <div class="eh-quad" style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.3);border-radius:var(--radius);padding:12px;overflow-y:auto"><div style="font-size:11px;font-weight:700;color:#22c55e;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Not Urgent + Not Important (ELIMINATE)</div><div id="eh-q4"></div></div>
        </div>
      </div>
    </div>

    <!-- CALENDAR -->
    <div class="panel" id="panel-calendar">
      <div class="content-area" style="display:flex;flex-direction:column">
        <div class="calendar-shell">
          <div class="calendar-nav">
            <button class="btn btn-sm" onclick="calNav(-1)">Prev</button>
            <button class="btn btn-sm" onclick="calNav(1)">Next</button>
            <span class="calendar-month-label" id="cal-month-label"></span>
            <button class="btn btn-sm" onclick="calToday()">Today</button>
            <div class="cal-view-toggle">
              <button class="cal-view-btn active" id="cal-view-month" onclick="setCalView('month')">Month</button>
              <button class="cal-view-btn" id="cal-view-week" onclick="setCalView('week')">Week</button>
              <button class="cal-view-btn" id="cal-view-year" onclick="setCalView('year')">Year</button>
              <button class="cal-view-btn" id="cal-view-agenda" onclick="setCalView('agenda')">Agenda</button>
            </div>
            <div style="margin-left:auto;display:flex;gap:6px">
              <button class="btn btn-sm" onclick="window.open('https://calendar.google.com','_blank')">Google Cal</button>
              <button class="btn btn-sm" onclick="exportICS()">Export .ics</button>
              <button class="btn btn-sm" onclick="importICS()">Import .ics</button>
            </div>
          </div>
          <div id="cal-today-summary" style="padding:6px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);margin:0 0 8px 0;font-size:10px;color:var(--text-secondary);display:none"></div>
          <div class="calendar-grid" id="cal-grid"></div>
          <div class="week-grid" id="cal-week-grid" style="display:none"></div>
        </div>
        <div id="cal-upcoming" style="padding:8px 0 0;border-top:1px solid var(--border);margin-top:8px"></div>
      </div>
    </div>

    <!-- WRITER -->
    <div class="panel" id="panel-writer">
      <div class="writer-shell">
        <div class="writer-sidebar">
          <div style="padding:8px;border-bottom:1px solid var(--border);display:flex;gap:4px">
            <button class="btn btn-primary btn-sm" style="flex:1" onclick="newDoc()">+ New</button>
            <div class="btn-group" style="position:relative;display:inline-block"><button class="btn btn-sm" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'" title="New from template">T</button><div style="display:none;position:absolute;top:100%;left:0;z-index:100;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:4px;min-width:140px;box-shadow:0 8px 24px rgba(0,0,0,0.4)"><div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;letter-spacing:0.05em">Templates</div><div onclick="newDocFromTemplate('Blog Post','<h2>Introduction</h2><p></p><h2>Main Points</h2><p></p><h2>Conclusion</h2><p></p>')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Blog Post</div><div onclick="newDocFromTemplate('Meeting Notes','<h2>Attendees</h2><p></p><h2>Agenda</h2><p></p><h2>Decisions</h2><p></p><h2>Action Items</h2><p></p>')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Meeting Notes</div><div onclick="newDocFromTemplate('Project Brief','<h2>Overview</h2><p></p><h2>Goals</h2><p></p><h2>Timeline</h2><p></p><h2>Resources</h2><p></p>')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Project Brief</div><div onclick="newDocFromTemplate('Daily Journal','<h2>'+new Date().toLocaleDateString()+'</h2><h3>What I did</h3><p></p><h3>What I learned</h3><p></p><h3>Tomorrow</h3><p></p>')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Daily Journal</div></div></div>
            <button class="btn btn-sm" onclick="toggleWriterPanel()">H</button>
          </div>
          <div style="padding:4px 8px;display:flex;gap:4px"><input type="text" id="writer-doc-search" placeholder="Search docs..." oninput="renderDocList()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:10px;color:var(--text);outline:none"><select id="writer-doc-sort" onchange="renderDocList()" style="font-size:8px;padding:2px 4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;cursor:pointer"><option value="updated">Updated</option><option value="created">Created</option><option value="alpha">A-Z</option><option value="words">Words</option><option value="tag">By Tag</option></select></div>
          <div class="writer-doc-list" id="writer-doc-list"></div>
        </div>
        <div class="writer-main">
          <div class="writer-toolbar">
            <select class="writer-toolbar-select" id="writer-block-type" onchange="execBlock(this.value)">
              <option value="p">Paragraph</option>
              <option value="h1">Heading 1</option>
              <option value="h2">Heading 2</option>
              <option value="h3">Heading 3</option>
              <option value="blockquote">Quote</option>
              <option value="pre">Code Block</option>
            </select>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="execCmd('bold')" title="Bold"><b>B</b></button>
            <button class="writer-toolbar-btn" onclick="execCmd('italic')" title="Italic"><i>I</i></button>
            <button class="writer-toolbar-btn" onclick="execCmd('underline')" title="Underline"><u>U</u></button>
            <button class="writer-toolbar-btn" onclick="execCmd('strikeThrough')"><s>S</s></button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="execCmd('insertUnorderedList')">*</button>
            <button class="writer-toolbar-btn" onclick="execCmd('insertOrderedList')">1.</button>
            <button class="writer-toolbar-btn" onclick="execCmd('indent')">&gt;</button>
            <button class="writer-toolbar-btn" onclick="execCmd('outdent')">&lt;</button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="insertLink()">Ln</button>
            <button class="writer-toolbar-btn" onclick="insertHR()">--</button>
            <button class="writer-toolbar-btn" onclick="insertCodeInline()">{}</button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="clearFormatting()">Tx</button>
            <div style="margin-left:auto;display:flex;gap:2px">
              <button class="voice-btn" id="writer-voice-btn" onclick="toggleVoice('writer')" title="Voice Input">M</button>
              <button class="writer-toolbar-btn" onclick="writerTOC()" title="Insert Table of Contents">TOC</button>
              <button class="writer-toolbar-btn" onclick="writerToContent()" title="Save to Content section">C+</button>
              <button class="writer-toolbar-btn" onclick="saveVersion()" title="Save Version">v+</button>
              <button class="writer-toolbar-btn" onclick="toggleWriterPanel()" title="History">H</button>
              <button class="writer-toolbar-btn" onclick="writerDetailedStats()" title="Detailed writing statistics">St</button>
              <div style="display:inline-block;position:relative"><button class="writer-toolbar-btn" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'" title="New doc from template">Tpl</button><div style="display:none;position:absolute;top:100%;left:0;z-index:100;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:4px;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,0.4)"><div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;letter-spacing:0.05em">Doc Templates</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('meeting')">Meeting Notes</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('blog')">Blog Post</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('spec')">Project Spec</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('journal')">Journal Entry</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('outline')">Outline</div></div></div>
              <button class="writer-toolbar-btn" onclick="mergeDocs()" title="Merge another doc into current">Mg</button>
              <button class="writer-toolbar-btn" onclick="writerOutline()" title="Show document outline (headings)">Out</button>
              <button class="writer-toolbar-btn" onclick="writerWordFreq()" title="Word frequency analysis">Fq</button>
              <button class="writer-toolbar-btn" onclick="writerCompare()" title="Compare two documents side by side">Cmp</button>
              <button class="writer-toolbar-btn" onclick="writerSplitDoc()" title="Split document at --- markers into multiple docs">Spl</button>
              <select class="writer-toolbar-select" id="writer-export-sel" onchange="writerExport(this.value);this.selectedIndex=0">
                <option value="">Export</option>
                <option value="md">Markdown</option>
                <option value="html">HTML</option>
                <option value="txt">Plain Text</option>
                <option value="clipboard">Copy All</option>
                <option value="print">Print / PDF</option>
              </select>
            </div>
          </div>
          <div id="writer-find-bar" style="display:none;padding:4px 8px;background:var(--bg-elevated);border-bottom:1px solid var(--border);display:none;align-items:center;gap:6px;flex-shrink:0">
            <input type="text" id="writer-find-input" placeholder="Find..." style="flex:1;font-size:10px;padding:4px 8px;max-width:200px" oninput="writerFindNext()" onkeydown="if(event.key==='Enter'){event.preventDefault();writerFindNext();}if(event.key==='Escape'){writerFindClose();}">
            <input type="text" id="writer-replace-input" placeholder="Replace..." style="flex:1;font-size:10px;padding:4px 8px;max-width:200px" onkeydown="if(event.key==='Escape'){writerFindClose();}">
            <button class="btn btn-sm btn-ghost" onclick="writerReplace()" style="font-size:9px;padding:2px 6px">Replace</button>
            <button class="btn btn-sm btn-ghost" onclick="writerReplaceAll()" style="font-size:9px;padding:2px 6px">All</button>
            <span id="writer-find-count" style="font-size:9px;color:var(--text-muted);font-family:var(--mono)"></span>
            <button class="btn btn-sm btn-ghost" onclick="writerFindClose()" style="font-size:9px;padding:2px 4px">x</button>
          </div>
          <div class="writer-editor-wrap" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
            <input type="text" class="writer-title-input" id="writer-title" placeholder="Untitled Document" oninput="onWriterChange()">
            <div id="writer-tags-bar" style="display:flex;flex-wrap:wrap;gap:4px;padding:2px 8px;min-height:20px;align-items:center"></div>
            <div class="writer-editor" id="writer-editor" contenteditable="true" data-placeholder="Start writing..." oninput="onWriterChange()" onkeydown="writerKeydown(event)" onscroll="writerScrollUpdate(this)"></div>
          </div>
          <div class="writer-statusbar">
            <span id="ws-words">0 words</span>
            <span id="ws-chars">0 chars</span>
            <span id="ws-reading">0 min read</span>
            <span id="ws-goal" style="cursor:pointer" onclick="setWriterGoal()" title="Click to set word goal"></span>
            <span id="ws-edited" style="color:var(--text-muted)"></span>
            <span id="ws-session" style="color:var(--green)"></span>
            <span id="ws-readability" style="font-size:9px"></span>
            <span id="ws-scroll" style="color:var(--text-muted);font-family:var(--mono)"></span>
            <span id="ws-saved" style="margin-left:auto">Saved</span>
          </div>
        </div>
        <div class="writer-right-panel hidden" id="writer-right-panel">
          <div class="sidebar-label" style="padding:0;margin-bottom:8px">Version History</div>
          <div id="writer-versions"></div>
        </div>
      </div>
    </div>

    <!-- LIVING DOCS -->
    <div class="panel" id="panel-specs">
      <div class="specs-shell">
        <div class="specs-sidebar">
          <div style="padding:8px;border-bottom:1px solid var(--border);display:flex;gap:4px">
            <button class="btn btn-primary btn-sm" style="flex:1" onclick="newSpec()">+ New</button>
            <select class="writer-toolbar-select" onchange="newSpecFromTemplate(this.value);this.selectedIndex=0" style="width:auto">
              <option value="">Template</option>
              <option value="prd">PRD</option>
              <option value="rfc">RFC</option>
              <option value="retro">Retrospective</option>
              <option value="checklist">Checklist</option>
            </select>
            <select class="writer-toolbar-select" onchange="specExport(this.value);this.selectedIndex=0" style="width:auto">
              <option value="">Export</option>
              <option value="md">Markdown</option>
              <option value="html">HTML</option>
              <option value="clipboard">Copy All</option>
            </select>
          </div>
          <div style="padding:4px 8px;display:flex;gap:4px"><input type="text" id="spec-list-search" placeholder="Search specs..." oninput="renderSpecList()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:10px;color:var(--text);outline:none"><select id="spec-list-sort" onchange="renderSpecList()" style="font-size:8px;padding:2px 4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;cursor:pointer"><option value="updated">Updated</option><option value="alpha">A-Z</option><option value="words">Words</option><option value="project">Project</option><option value="sections">Sections</option></select><span id="specs-word-total" style="font-size:8px;color:var(--text-muted);font-family:var(--mono);white-space:nowrap"></span></div>
          <div class="specs-doc-list" id="specs-doc-list"></div>
        </div>
        <div class="specs-main" id="specs-main">
          <div class="specs-header">
            <input type="text" class="specs-title-input" id="specs-title" placeholder="Project Name..." oninput="onSpecChange()">
            <button class="voice-btn" id="specs-voice-btn" onclick="toggleVoice('specs')" title="Voice Input">M</button>
            <button class="btn btn-sm" onclick="addSpecSection()">+ Section</button>
            <input type="text" id="spec-search" placeholder="Search sections..." oninput="specSearch()" style="width:120px;font-size:10px;padding:4px 8px">
            <select id="spec-project-assign" onchange="assignSpecProject(this.value)" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"></select>
            <button class="btn btn-sm" onclick="collapseAllSections()" title="Collapse all">Collapse</button>
            <button class="btn btn-sm" onclick="expandAllSections()" title="Expand all">Expand</button>
            <button class="btn btn-sm" onclick="exportCurrentSpec()" title="Export this spec as HTML" style="font-size:9px">Export</button>
            <button class="btn btn-sm" onclick="exportCurrentSpecMD()" title="Copy spec as Markdown" style="font-size:9px">MD</button>
            <button class="btn btn-sm" onclick="exportCurrentSpecText()" title="Copy spec as plain text" style="font-size:9px">TXT</button>
            <button class="btn btn-sm" onclick="saveSpecVersion()" title="Save snapshot of this spec" style="font-size:9px;color:var(--accent)">v+</button>
            <button class="btn btn-sm" onclick="showSpecVersions()" title="View version history" style="font-size:9px">Hist</button>
            <button class="btn btn-sm" onclick="specImportMarkdown()" title="Import spec from Markdown" style="font-size:9px;color:#22d3ee">Imp</button>
          </div>
          <div class="specs-sections" id="specs-sections"></div>
          <div class="specs-statusbar">
            <span id="specs-status">Saved</span>
            <span style="margin-left:auto" id="specs-word-count">0 words</span>
          </div>
        </div>
      </div>
    </div>

    <!-- WHITEBOARD -->
    <div class="panel" id="panel-whiteboard">
      <div class="wb-shell">
        <div class="wb-toolbar" id="wb-toolbar">
          <button class="wb-tool active" data-tool="select" onclick="wbSetTool('select')" title="Select (V)">V</button>
          <button class="wb-tool" data-tool="hand" onclick="wbSetTool('hand')" title="Pan (H)">H</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" data-tool="node" onclick="wbSetTool('node')" title="Add Node (N)">+N</button>
          <button class="wb-tool" data-tool="connect" onclick="wbSetTool('connect')" title="Connect (C)">-></button>
          <button class="wb-tool" data-tool="text" onclick="wbSetTool('text')" title="Text (T)">T</button>
          <button class="wb-tool" data-tool="sticky" onclick="wbSetTool('sticky')" title="Sticky (S)">St</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" onclick="wbUndo()" title="Undo">Un</button>
          <button class="wb-tool" onclick="wbRedo()" title="Redo">Re</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" onclick="wbToggleGrid()" title="Grid (G)">G</button>
          <button class="wb-tool" onclick="wbAutoLayout()" title="Auto Layout">AL</button>
          <button class="wb-tool" onclick="wbClusterByType()" title="Cluster by Type">CL</button>
        </div>
        <div class="wb-actions">
          <button class="btn btn-sm" onclick="openTplModal()">Templates</button>
          <select class="writer-toolbar-select" onchange="wbExport(this.value);this.selectedIndex=0" style="width:auto"><option value="">Export</option><option value="png">PNG</option><option value="svg">SVG</option><option value="json">JSON</option><option value="text">Text Outline</option></select>
          <button class="btn btn-sm" onclick="wbImportJSON()" title="Import whiteboard JSON">Import</button>
          <button class="btn btn-sm" onclick="wbClearAll()">Clear</button>
          <input type="text" id="wb-search" placeholder="Find node..." oninput="wbSearchNodes(this.value)" style="width:100px;padding:2px 6px;font-size:9px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:var(--mono)">
          <span id="wb-stats" style="font-size:8px;color:var(--text-muted);font-family:var(--mono)"></span>
        </div>
        <div class="wb-top-bar">
          <div class="wb-zoom"><button class="wb-tool" onclick="wbZoom(-0.1)" style="width:20px;height:20px;font-size:14px">-</button><span id="wb-zoom-level">100%</span><button class="wb-tool" onclick="wbZoom(0.1)" style="width:20px;height:20px;font-size:14px">+</button><button class="wb-tool" onclick="wbFitView()" style="width:20px;height:20px;font-size:9px">Fit</button></div>
        </div>
        <div class="wb-canvas-wrap" id="wb-canvas-wrap" onmousedown="wbCanvasDown(event)" onmousemove="wbCanvasMove(event)" onmouseup="wbCanvasUp(event)" onwheel="wbWheel(event)" oncontextmenu="event.preventDefault()">
          <div class="wb-canvas" id="wb-canvas">
            <svg class="wb-svg" id="wb-svg"></svg>
          </div>
        </div>
        <div class="wb-minimap" id="wb-minimap"></div>
      </div>
    </div>

    <!-- LINKS -->
    <div class="panel" id="panel-links">
      <div style="padding:16px 20px 0;display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <div class="tab-bar" id="link-category-tabs"></div>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <input type="text" id="link-search" placeholder="Search links..." oninput="renderLinks()" style="width:140px;font-size:10px;padding:5px 8px">
          <select id="link-sort" onchange="renderLinks()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="newest">Newest</option><option value="oldest">Oldest</option><option value="alpha">A-Z</option><option value="category">Category</option><option value="domain">By Domain</option><option value="tag">By Tag</option></select>
          <button class="btn btn-sm" onclick="manageLinkTags()" title="Manage link tags">Tags</button>
          <button class="btn btn-sm" onclick="openFilteredLinks()" title="Open all visible links">Open All</button>
          <button class="btn btn-sm" onclick="copyAllLinkURLs()" title="Copy all filtered URLs to clipboard">Copy URLs</button>
          <button class="btn btn-sm" onclick="batchImportLinks()" title="Paste multiple URLs to import">Import</button>
          <button class="btn btn-sm" onclick="checkAllLinks()" title="Check all links for broken URLs" id="link-check-btn">Check</button>
          <button class="btn btn-primary btn-sm" onclick="openLinkModal()">+ Add</button>
        </div>
      </div>
      <div class="content-area"><div class="links-grid" id="links-grid"></div></div>
    </div>

    <!-- PIPELINE -->
    <div class="panel" id="panel-pipeline">
      <div style="padding:16px 20px 0;flex-shrink:0">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <span style="font-size:13px;font-weight:600;letter-spacing:0.02em">Pipeline</span>
          <span style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em">Audio / Text -> Whisper -> GPT -> ASTRA</span>
          <span style="flex:1"></span>
          <span id="pl-status-dot" style="width:8px;height:8px;border-radius:50%;background:var(--text-muted)" title="Not connected"></span>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" id="pl-record-btn" onclick="plToggleRecord()">Record Mic</button>
          <label class="btn btn-sm" style="cursor:pointer;display:inline-flex;align-items:center;gap:4px">
            Upload Audio
            <input type="file" accept="audio/*" onchange="plUploadFile(this)" style="display:none">
          </label>
          <button class="btn btn-sm" onclick="plPasteText()">Paste Text</button>
          <button class="btn btn-sm" onclick="plLoadHistory()">History</button>
        </div>
        <div id="pl-onboarding" style="padding:10px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;font-size:10px;color:var(--text-muted);line-height:1.6;display:none">
          <div style="font-weight:600;color:var(--accent);margin-bottom:4px">Text-only mode available</div>
          Use "Paste Text" to paste any text, write a prompt (e.g. "Summarize key ideas", "Extract action items", "Translate to Spanish"), then hit Process. Audio requires OPENAI_API_KEY in Vercel env vars.
        </div>
        <div id="pl-recording" style="display:none;padding:8px 12px;background:rgba(239,68,68,0.1);border:1px solid var(--red);border-radius:4px;margin-bottom:12px;display:none;align-items:center;gap:8px">
          <div style="width:8px;height:8px;background:var(--red);border-radius:50%;animation:pulse 1s infinite"></div>
          <span id="pl-rec-time" style="font-size:10px;color:var(--red)">Recording... 0s</span>
        </div>
        <div id="pl-input-preview" style="display:none;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;max-height:120px;overflow-y:auto;font-size:11px;color:var(--text-muted)"></div>
        <div style="margin-bottom:12px">
          <label style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:4px;display:block">Custom Prompt</label>
          <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap">
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Summarize the key ideas in 3-5 bullet points'" style="font-size:8px;padding:2px 6px">Summarize</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Extract all action items and tasks as a checklist'" style="font-size:8px;padding:2px 6px">Action Items</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Rewrite this as a polished social media post (Twitter/X length)'" style="font-size:8px;padding:2px 6px">Social Post</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Translate to Spanish, maintaining the original tone'" style="font-size:8px;padding:2px 6px">Translate ES</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Clean up grammar and punctuation, keep the original voice'" style="font-size:8px;padding:2px 6px">Clean Up</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Extract the top keywords and most frequent terms'" style="font-size:8px;padding:2px 6px">Keywords</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Convert to bullet point list'" style="font-size:8px;padding:2px 6px">Bullets</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Generate headline and title suggestions'" style="font-size:8px;padding:2px 6px">Headlines</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Show detailed word count and text statistics'" style="font-size:8px;padding:2px 6px">Stats</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Generate questions from this text'" style="font-size:8px;padding:2px 6px">Questions</button>
            <button class="btn btn-sm btn-ghost" onclick="plWordCloud()" style="font-size:8px;padding:2px 6px;color:var(--accent)">Word Cloud</button>
            <span style="width:1px;height:12px;background:var(--border);margin:0 2px"></span>
            <button class="btn btn-sm btn-ghost" onclick="plSaveTemplate()" style="font-size:8px;padding:2px 6px;color:var(--accent)">+ Save</button>
          </div>
          <div id="pl-custom-templates" style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px"></div>
          <textarea id="pl-prompt" placeholder="What should the pipeline do with this input? e.g. 'Summarize key ideas', 'Extract action items', 'Rewrite for social media', 'Translate to Spanish'..." style="width:100%;min-height:60px;resize:vertical;font-size:11px;padding:8px 10px"></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:16px">
          <button class="btn btn-primary" onclick="plProcess()" id="pl-process-btn" style="flex:1">Process Pipeline</button>
          <select id="pl-source" style="font-size:10px;padding:4px 8px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text);border-radius:4px">
            <option value="pipeline-manual">Manual</option>
            <option value="pipeline-whatsapp">WhatsApp</option>
            <option value="pipeline-voice">Voice Memo</option>
            <option value="pipeline-capture">Capture</option>
          </select>
        </div>
      </div>
      <div class="content-area" style="padding:0 20px 20px">
        <div id="pl-result" style="display:none;padding:16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent)">Pipeline Result</span>
            <div style="display:flex;gap:6px">
              <button class="btn btn-sm" onclick="plCopyResult()">Copy</button>
              <button class="btn btn-sm" onclick="plSaveToContent()">Save to Content</button>
              <button class="btn btn-sm" onclick="plSaveCapture()">Save to API</button>
              <button class="btn btn-sm" onclick="plClearResult()">New</button>
            </div>
          </div>
          <div id="pl-transcript-box" style="display:none;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:3px;margin-bottom:8px;font-size:10px;color:var(--text-muted);max-height:80px;overflow-y:auto">
            <div style="font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);margin-bottom:4px">Transcript</div>
            <div id="pl-transcript-text"></div>
          </div>
          <div id="pl-synthesis-text" style="font-size:12px;line-height:1.6;white-space:pre-wrap"></div>
          <div id="pl-result-stats" style="margin-top:8px;font-size:9px;color:var(--text-muted);font-family:var(--mono)"></div>
        </div>
        <div id="pl-history" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:6px">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted)">Pipeline History</span>
            <input type="text" id="pl-history-search" placeholder="Search history..." oninput="plLoadHistory()" style="flex:1;max-width:200px;font-size:9px;padding:3px 6px">
            <button class="btn btn-sm btn-ghost btn-danger" onclick="if(confirm('Clear all pipeline history?')){S.pipelineHistory=[];save();plLoadHistory();toast('Cleared');}" style="font-size:8px;padding:1px 6px">Clear all</button>
          </div>
          <div id="pl-history-list"></div>
        </div>
      </div>
    </div>

    <!-- REPOS -->
    <div class="panel" id="panel-repos">
      <div style="padding:16px 20px 0;flex-shrink:0">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap">
          <span style="font-size:13px;font-weight:600;letter-spacing:0.02em">Connected Repos</span>
          <span id="repos-count" style="font-size:9px;color:var(--text-muted);font-family:var(--mono)">0</span>
          <span style="flex:1"></span>
          <input type="text" id="repo-search" placeholder="Filter repos..." oninput="reposRefresh()" style="width:120px;font-size:10px;padding:5px 8px">
          <select id="repo-sort" onchange="reposRefresh()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="name">Name</option><option value="status">Status</option><option value="updated">Updated</option><option value="role">Role</option></select>
          <button class="btn btn-primary btn-sm" onclick="openRepoModal()">+ Add</button>
          <button class="btn btn-sm" onclick="(S.repos||[]).filter(r=>r.live).forEach(r=>window.open(r.live,'_blank'));toast('Opened '+((S.repos||[]).filter(r=>r.live).length)+' live sites')" title="Open all live URLs">Open All</button>
          <button class="btn btn-sm" onclick="repoHealthCheck()" title="Ping all live URLs">Health Check</button>
          <button class="btn btn-sm" onclick="reposRefresh()">Refresh</button>
        </div>
      </div>
      <div class="content-area" style="padding:0 20px 20px">
        <div id="repos-grid" style="display:grid;gap:8px"></div>
      </div>
    </div>
  </main>
  <div class="project-resize-handle" id="project-resize-handle"></div>
  <!-- PROJECT VIEW — right panel inside grid -->
  <div class="project-view" id="panel-project">
      <div class="project-header">
        <div class="proj-icon-lg" id="proj-header-icon"></div>
        <span class="project-header-name" id="proj-header-name"></span>
        <span class="badge" id="proj-header-status"></span>
        <div id="proj-stats-bar" style="display:flex;gap:12px;margin-left:auto;margin-right:12px"></div>
        <div class="project-header-actions">
          <button class="btn btn-sm" onclick="editProject()">Edit</button>
          <button class="btn btn-sm" onclick="showExportMenu(event)" title="Export project">Export</button>
          <button class="btn btn-sm btn-danger" onclick="archiveProject()">Archive</button>
          <button class="btn btn-sm" onclick="closeProjectPanel()" title="Close panel" style="font-size:14px;padding:2px 6px">x</button>
        </div>
      </div>
      <div class="project-tabs" id="proj-tabs">
        <button class="project-tab active" onclick="setProjTab('instructions',this)">Instructions</button>
        <button class="project-tab" onclick="setProjTab('docs',this)">Living Docs</button>
        <button class="project-tab" onclick="setProjTab('kb',this)">Knowledge Base</button>
        <button class="project-tab" onclick="setProjTab('proj-tasks',this)">Tasks</button>
        <button class="project-tab" onclick="setProjTab('proj-links',this)">Links</button>
      </div>
      <div class="project-content" id="proj-content">
        <!-- Instructions -->
        <div id="proj-panel-instructions" class="proj-tab-panel">
          <div class="proj-instructions-editor" id="proj-instructions-editor" contenteditable="true" oninput="onProjInstructionsChange()"></div>
        </div>
        <!-- Living Docs -->
        <div id="proj-panel-docs" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="newProjLivingDoc()">+ New Living Doc</button>
          </div>
          <div class="proj-docs-grid" id="proj-docs-grid"></div>
        </div>
        <!-- Knowledge Base -->
        <div id="proj-panel-kb" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="openKBModal()">+ Add Item</button>
            <input type="text" id="kb-search" placeholder="Search knowledge base..." oninput="renderKB()" style="width:200px;font-size:10px;padding:5px 8px">
          </div>
          <div class="kb-grid" id="kb-grid"></div>
        </div>
        <!-- Tasks -->
        <div id="proj-panel-proj-tasks" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="addProjTask()">+ Task</button>
          </div>
          <div id="proj-task-rows"></div>
        </div>
        <!-- Links -->
        <div id="proj-panel-proj-links" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="openProjLinkModal()">+ Add Link</button>
          </div>
          <div class="links-grid" id="proj-links-grid"></div>
        </div>
      </div>
    <div class="project-collapse-chevron" onclick="closeProjectPanel()" title="Collapse panel">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
    </div>
    </div>
  <!-- CONTEXT PANEL -->
  <div class="context-resize" id="context-resize"></div>
  <div class="context-panel" id="context-panel">
    <div class="context-header">
      <span class="context-header-title">Context</span>
      <button class="context-close" onclick="toggleContextPanel()" title="Close">x</button>
    </div>
    <div class="context-body" id="context-body">
      <div class="context-section">
        <div class="context-section-title">Focus Timer</div>
        <div class="focus-timer-panel" id="focus-timer-embed">
          <div class="ft-circle-wrap">
            <svg class="ft-circle" viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="70" class="ft-track"/>
              <circle cx="80" cy="80" r="70" class="ft-progress" id="ft-progress"/>
            </svg>
            <div class="ft-display">
              <div class="ft-time" id="ft-time">25:00</div>
              <div class="ft-label" id="ft-label">Writing</div>
            </div>
          </div>
          <div class="ft-controls">
            <button class="ft-btn" id="ft-btn" onclick="ftToggle()">Start</button>
            <button class="ft-btn" onclick="ftReset()">Reset</button>
          </div>
          <div class="ft-time-adjust" id="ft-time-adjust">
            <button class="ft-adj-btn" onclick="ftAdjust(-5)">-</button>
            <span style="font-size:11px;color:var(--text-muted);font-family:var(--mono)" id="ft-duration-label">25 min</span>
            <button class="ft-adj-btn" onclick="ftAdjust(5)">+</button>
          </div>
          <div class="ft-categories">
            <span class="ft-cat active" onclick="ftSetCat(this,'Writing','#4ade80')">Writing</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Training','#FF6B6B')">Training</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Meditation','#50E3C2')">Meditation</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Breath','#9013FE')">Breath</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Free Flow','#FFD93D')">Free Flow</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Code','#22d3ee')">Code</span>
          </div>
        </div>
      </div>
      <div class="context-section" id="ctx-related">
        <div class="context-section-title">Related Items</div>
        <div id="ctx-related-items" style="font-size:10px;color:var(--text-muted);padding:8px 0">Select an item to see related content</div>
      </div>
      <div class="context-section" id="ctx-graph">
        <div class="context-section-title">Knowledge Graph</div>
        <canvas id="ctx-graph-canvas" width="280" height="160" style="width:100%;height:160px;border-radius:var(--radius);background:var(--bg-surface);border:1px solid var(--border);cursor:grab"></canvas>
      </div>
      <div class="context-section" id="ctx-quick-actions">
        <div class="context-section-title">Quick Actions</div>
        <div class="context-item" onclick="openContentModal()"><span class="context-item-icon">+</span>Add Content</div>
        <div class="context-item" onclick="addTask()"><span class="context-item-icon">+</span>Add Task</div>
        <div class="context-item" onclick="newDoc()"><span class="context-item-icon">+</span>New Document</div>
        <div class="context-item" onclick="openLinkModal()"><span class="context-item-icon">+</span>Add Link</div>
        <div class="context-item" onclick="openNewProjectModal()"><span class="context-item-icon">+</span>New Project</div>
      </div>
      <div class="context-section">
        <div class="context-section-title">Stats</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px" id="ctx-stats">
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-tasks">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Active Tasks</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-docs">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Documents</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-projects">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Projects</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-kb">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">KB Items</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div><!-- /app -->

<!-- SHORTCUTS HELP -->
<div class="modal-overlay" id="shortcuts-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" style="width:480px">
    <div class="modal-title">Keyboard Shortcuts</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:11px">
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:8px">Navigation</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Command Palette</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+K</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Content</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+1</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Tasks</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+2</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Calendar</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+3</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Writing Hub</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+4</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Living Docs</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+5</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Links</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+6</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Whiteboard</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+7</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Pipeline</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+8</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Repos</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+9</span></div>
      </div>
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:8px">Actions</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>New Item</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>New Task (anywhere)</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+T</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Quick Capture</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Toggle Sidebar</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+B</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Context Panel</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+E</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Focus Mode</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+\</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Save / Sync</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+S</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Zen Writer</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+W</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Today View</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+D</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Focus Mode</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+F</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Close/Escape</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Esc</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Export Section</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+E</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Scratchpad</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+S</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Show Shortcuts</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+/</span></div>
        <div style="font-weight:600;color:var(--text);margin:12px 0 8px">Task Detail</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Set P0-P3</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">1-4</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Save</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">S</span></div>
        <div style="font-weight:600;color:var(--text);margin:12px 0 8px">Whiteboard</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Select</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">V</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Hand</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">H</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Node</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Connect</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">C</span></div>
      </div>
    </div>
    <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
      <div style="font-weight:600;color:var(--accent);margin-bottom:8px;font-size:11px">Cmd+K Prefixes</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px 12px;font-size:10px;color:var(--text-muted)">
        <span>focus: — Timer</span><span>chart: — Pie charts</span><span>export: — Export hub</span>
        <span>tpl: — Task templates</span><span>review: — Stale items</span><span>writerstats — Doc stats</span>
        <span>goal: — Goal tracker</span><span>habit: — Habit tracker</span><span>wb: — WB search</span>
        <span>log: — Activity log</span><span>config: — Settings</span><span>wordgoal: — Word goals</span>
        <span>deps: — Dependencies</span><span>standup — Daily brief</span><span>random: — Inspiration</span>
        <span>task: — Quick task</span><span>note: — Quick content</span><span>count: — Data counts</span>
      </div>
    </div>
  </div>
</div>

<!-- COMMAND PALETTE -->
<div class="cmd-overlay" id="cmd-overlay" onclick="if(event.target===this)closeCommandPalette()">
  <div class="cmd-box">
    <div class="cmd-input-wrap">
      <span class="cmd-input-icon">></span>
      <input type="text" class="cmd-input" id="cmd-input" placeholder="Search everything... sections, projects, tasks, docs" oninput="cmdSearch()" onkeydown="cmdKeydown(event)" autocomplete="off" spellcheck="false">
      <span class="cmd-hint">ESC to close</span>
    </div>
    <div class="cmd-results" id="cmd-results"></div>
    <div class="cmd-footer">
      <span><span class="cmd-key">Enter</span> select</span>
      <span><span class="cmd-key">Up</span><span class="cmd-key">Down</span> navigate</span>
      <span><span class="cmd-key">Esc</span> close</span>
    </div>
  </div>
</div>

<!-- CONTENT MODAL -->
<div class="modal-overlay" id="content-modal">
  <div class="modal">
    <div class="modal-title" id="content-modal-title">Add Content</div>
    <div class="form-group"><label class="form-label">Type</label><select id="cm-type"><option value="caption">Caption</option><option value="quote">Quote</option></select></div>
    <div class="form-group"><label class="form-label">Theme</label><input type="text" id="cm-theme" placeholder="discipline, growth, healing..."></div>
    <div class="form-group"><label class="form-label">Content</label><textarea id="cm-body" rows="8" placeholder="Paste from Apple Notes..."></textarea></div>
    <div class="form-group"><label class="form-label">Source (optional)</label><input type="text" id="cm-source" placeholder="Apple Notes #Captions"></div>
    <div class="form-group"><label class="form-label">Tags (comma separated)</label><input type="text" id="cm-tags" placeholder="training, mindset, content"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeContentModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveContent()">Save</button>
    </div>
  </div>
</div>

<!-- LINK MODAL -->
<div class="modal-overlay" id="link-modal">
  <div class="modal">
    <div class="modal-title" id="link-modal-title">Add Link</div>
    <div class="form-group"><label class="form-label">Title</label><input type="text" id="lm-title" placeholder="Saturno Vault"></div>
    <div class="form-group"><label class="form-label">URL</label><div style="display:flex;gap:4px"><input type="text" id="lm-url" placeholder="https://..." onblur="suggestLinkTitle();suggestLinkCategory()" style="flex:1"><button class="btn btn-sm btn-ghost" onclick="fetchLinkTitle()" style="font-size:9px;white-space:nowrap" type="button">Fetch Title</button></div></div>
    <div class="form-group"><label class="form-label">Category</label><input type="text" id="lm-category" placeholder="deployment, repo, tool"></div>
    <div class="form-group"><label class="form-label">Description</label><input type="text" id="lm-desc" placeholder="Short description"></div>
    <div class="form-group"><label class="form-label">Project (optional)</label><select id="lm-project"><option value="">None</option></select></div>
    <div class="form-group"><label class="form-label">Tags (comma-separated)</label><input type="text" id="lm-tags" placeholder="api, design, reference"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeLinkModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveLink()">Save</button>
    </div>
  </div>
</div>

<!-- TEMPLATE MODAL -->
<div class="wb-tpl-modal" id="wb-tpl-modal" onclick="if(event.target===this)closeTplModal()">
  <div class="modal" style="width:720px;max-width:95vw">
    <div class="modal-title">Choose Template</div>
    <div class="wb-tpl-grid" id="wb-tpl-grid"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" onclick="closeTplModal()">Cancel</button></div>
  </div>
</div>

<!-- PROJECT MODAL -->
<div class="modal-overlay" id="project-modal" onclick="if(event.target===this)closeProjectModal()">
  <div class="modal" style="width:480px">
    <div class="modal-title" id="project-modal-title">New Project</div>
    <div class="form-group">
      <label class="form-label">Project Name</label>
      <input type="text" id="pm-name" placeholder="Saturno Bonus">
    </div>
    <div class="form-group">
      <label class="form-label">Icon</label>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="pm-icon-preview" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);border:1px solid var(--border);cursor:pointer" onclick="openIconPicker()"></div>
        <button class="btn btn-sm" onclick="openIconPicker()">Choose Icon</button>
        <input type="hidden" id="pm-icon" value="folder">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <select id="pm-status">
        <option value="active">Active</option>
        <option value="paused">Paused</option>
        <option value="complete">Complete</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Color Accent</label>
      <div style="display:flex;gap:6px" id="pm-colors">
        <div class="pm-color-opt" style="background:#4ade80" onclick="setPmColor('#4ade80')" data-color="#4ade80"></div>
        <div class="pm-color-opt" style="background:#8b5cf6" onclick="setPmColor('#8b5cf6')" data-color="#8b5cf6"></div>
        <div class="pm-color-opt" style="background:#3b82f6" onclick="setPmColor('#3b82f6')" data-color="#3b82f6"></div>
        <div class="pm-color-opt" style="background:#06b6d4" onclick="setPmColor('#06b6d4')" data-color="#06b6d4"></div>
        <div class="pm-color-opt" style="background:#f59e0b" onclick="setPmColor('#f59e0b')" data-color="#f59e0b"></div>
        <div class="pm-color-opt" style="background:#ec4899" onclick="setPmColor('#ec4899')" data-color="#ec4899"></div>
        <div class="pm-color-opt" style="background:#ef4444" onclick="setPmColor('#ef4444')" data-color="#ef4444"></div>
        <div class="pm-color-opt" style="background:#f97316" onclick="setPmColor('#f97316')" data-color="#f97316"></div>
      </div>
      <input type="hidden" id="pm-color" value="#4ade80">
    </div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeProjectModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save</button>
    </div>
  </div>
</div>

<!-- REPO MODAL -->
<div class="modal-overlay" id="repo-modal" onclick="if(event.target===this)closeRepoModal()">
  <div class="modal" style="width:420px">
    <div class="modal-title" id="repo-modal-title">Add Repo</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" id="rm-name" placeholder="my-repo"></div>
    <div class="form-group"><label class="form-label">GitHub URL</label><input type="text" id="rm-github" placeholder="https://github.com/user/repo"></div>
    <div class="form-group"><label class="form-label">Live URL (optional)</label><input type="text" id="rm-live" placeholder="https://my-app.vercel.app"></div>
    <div class="form-group"><label class="form-label">Role</label>
      <select id="rm-role"><option value="backend-hub">Backend Hub</option><option value="customer-facing">Customer Facing</option><option value="internal-tools">Internal Tools</option><option value="experience">Experience</option><option value="extension">Extension</option><option value="library">Library</option><option value="other">Other</option></select>
    </div>
    <div class="form-group"><label class="form-label">Status</label>
      <select id="rm-status"><option value="active">Active</option><option value="complete">Complete</option><option value="archived">Archived</option></select>
    </div>
    <div class="form-group"><label class="form-label">Description</label><textarea id="rm-desc" rows="3" placeholder="What this repo does..."></textarea></div>
    <div class="form-group"><label class="form-label">Notes</label><input type="text" id="rm-notes" placeholder="Quick notes, reminders..."></div>
    <div class="form-group"><label class="form-label">Last Commit</label><input type="text" id="rm-lastcommit" placeholder="e.g. feat: added new feature"></div>
    <div class="form-group"><label class="form-label">Tech Stack</label><input type="text" id="rm-stack" placeholder="HTML, JS, Vercel, Node (comma-separated)"></div>
    <div class="form-group"><label class="form-label">Last Deploy</label><input type="date" id="rm-deploy"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeRepoModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveRepo()">Save</button>
    </div>
  </div>
</div>

<!-- ICON PICKER MODAL -->
<div class="icon-picker-modal" id="icon-picker-modal" onclick="if(event.target===this)closeIconPicker()">
  <div class="modal" style="width:400px">
    <div class="modal-title">Choose Icon</div>
    <div class="icon-picker-grid" id="icon-picker-grid"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" onclick="closeIconPicker()">Done</button></div>
  </div>
</div>

<!-- KB MODAL -->
<div class="modal-overlay" id="kb-modal" onclick="if(event.target===this)closeKBModal()">
  <div class="modal" style="width:500px">
    <div class="modal-title" id="kb-modal-title">Add to Knowledge Base</div>
    <div class="kb-modal-tabs">
      <button class="kb-modal-tab active" onclick="setKBModalTab('text',this)">Text / Markdown</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('file',this)">File Reference</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('url',this)">URL</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('image',this)">Image</button>
    </div>
    <div class="kb-modal-panel active" id="kb-panel-text">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-text-name" placeholder="Design Specs"></div>
      <div class="form-group"><label class="form-label">Content</label><textarea id="kbm-text-content" rows="8" placeholder="Paste markdown or plain text..." style="font-family:var(--mono);font-size:11px"></textarea></div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-file">
      <div class="form-group"><label class="form-label">File Name</label><input type="text" id="kbm-file-name" placeholder="Visual Branding.pdf"></div>
      <div class="form-group"><label class="form-label">File Path</label><input type="text" id="kbm-file-path" placeholder="~/Downloads/Visual Branding.pdf"></div>
      <div class="form-group"><label class="form-label">File Type</label>
        <select id="kbm-file-type"><option value="pdf">PDF</option><option value="img">Image</option><option value="json">JSON</option><option value="other">Other</option></select>
      </div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-url">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-url-name" placeholder="Saturno Movement"></div>
      <div class="form-group"><label class="form-label">URL</label><input type="text" id="kbm-url-url" placeholder="https://saturnomovement.com"></div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-image">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-img-name" placeholder="Gate Screenshot"></div>
      <div class="form-group"><label class="form-label">Paste image or drop file</label>
        <div id="kbm-img-drop" style="border:2px dashed var(--border);border-radius:var(--radius);padding:30px;text-align:center;color:var(--text-muted);font-size:11px;cursor:pointer;transition:all 0.15s" onclick="document.getElementById('kbm-img-input').click()">
          Click or paste (Ctrl+V) an image here
          <input type="file" id="kbm-img-input" accept="image/*" style="display:none" onchange="handleKBImageFile(this)">
        </div>
        <div id="kbm-img-preview" style="display:none;margin-top:8px"><img id="kbm-img-preview-img" style="max-width:100%;max-height:150px;border-radius:var(--radius);border:1px solid var(--border)"></div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Description</label><input type="text" id="kbm-desc" placeholder="Brief description of this item"></div>
    <div class="form-group"><label class="form-label">Tags (comma-separated)</label><input type="text" id="kbm-tags" placeholder="design, branding, specs"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeKBModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveKBItem()">Save</button>
    </div>
  </div>
</div>

<!-- KB VIEWER MODAL -->
<div class="modal-overlay" id="kb-viewer-modal" onclick="if(event.target===this)closeKBViewer()">
  <div class="modal" style="width:640px;max-height:85vh">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
      <span class="kb-card-type" id="kbv-type"></span>
      <span style="font-size:14px;font-weight:600;color:var(--text);flex:1" id="kbv-name"></span>
      <button class="btn btn-sm" onclick="editKBItem()">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="deleteKBItem()">Delete</button>
      <button class="btn btn-sm" onclick="closeKBViewer()">Close</button>
    </div>
    <div id="kbv-desc" style="font-size:11px;color:var(--text-secondary);margin-bottom:12px"></div>
    <div id="kbv-content" style="font-size:13px;line-height:1.7;color:var(--text-secondary);max-height:60vh;overflow-y:auto;white-space:pre-wrap;font-family:var(--mono);background:var(--bg-surface);padding:14px;border-radius:var(--radius);border:1px solid var(--border)"></div>
    <div id="kbv-image" style="display:none;text-align:center;margin-top:12px"><img id="kbv-image-img" style="max-width:100%;max-height:50vh;border-radius:var(--radius)"></div>
    <div id="kbv-path" style="display:none;margin-top:12px;font-family:var(--mono);font-size:10px;color:var(--text-muted)"></div>
    <div id="kbv-tags" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:12px"></div>
  </div>
</div>

<!-- QUICK CAPTURE -->
<div id="quick-capture" style="position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:500px;max-width:90vw;z-index:500;display:none;transition:transform 0.2s ease,opacity 0.2s ease;opacity:0">
  <div style="background:linear-gradient(135deg, rgba(16,16,20,0.98) 0%, rgba(22,22,25,0.98) 100%);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.06);border-bottom:none;border-radius:var(--radius-lg) var(--radius-lg) 0 0;padding:10px 14px;box-shadow:0 -8px 32px rgba(0,0,0,0.5)">
    <div style="display:flex;align-items:center;gap:8px">
      <select id="qc-type" style="width:auto;font-size:9px;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary)">
        <option value="task">Task</option>
        <option value="content">Content</option>
        <option value="link">Link</option>
        <option value="note">Quick Note</option>
      </select>
      <input type="text" id="qc-input" placeholder="Quick capture... (Cmd+Shift+N)" style="flex:1;font-size:12px;padding:8px 10px;border-radius:6px;background:var(--bg-input);border:1px solid var(--border)" onkeydown="if(event.key==='Enter'){qcSubmit();event.preventDefault();}if(event.key==='Escape')qcClose();" oninput="qcAutoType(this.value)">
      <button class="btn btn-primary btn-sm" onclick="qcSubmit()" style="padding:6px 12px">Add</button>
      <button class="btn btn-sm btn-ghost" onclick="qcClose()" style="font-size:12px">x</button>
    </div>
  </div>
</div>

<!-- ZEN WRITER — Full-screen writing environment (Cmd+Shift+W or FAB) -->
<div class="zen-writer" id="zen-writer">
  <div class="zen-writer-topbar">
    <select class="zen-doc-picker" id="zen-doc-picker" onchange="zenPickDoc(this.value)"></select>
    <button class="zen-tb" onclick="zenNewDoc()" title="New Document" style="font-size:11px;width:auto;padding:0 8px;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> New</button>
    <div class="zen-toolbar">
      <select class="zen-tb-select" id="zen-block-type" onchange="zenExecBlock(this.value)">
        <option value="p">Paragraph</option>
        <option value="h1">Heading 1</option>
        <option value="h2">Heading 2</option>
        <option value="h3">Heading 3</option>
        <option value="blockquote">Quote</option>
        <option value="pre">Code Block</option>
      </select>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenCmd('bold')" title="Bold (Cmd+B)"><b>B</b></button>
      <button class="zen-tb" onclick="zenCmd('italic')" title="Italic (Cmd+I)"><i>I</i></button>
      <button class="zen-tb" onclick="zenCmd('underline')" title="Underline (Cmd+U)"><u>U</u></button>
      <button class="zen-tb" onclick="zenCmd('strikeThrough')" title="Strikethrough"><s>S</s></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenCmd('insertUnorderedList')" title="Bullet List"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('insertOrderedList')" title="Numbered List"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 6h11M10 12h11M10 18h11M3 5v3h2M4 8H3M5 18H3l2-3H3"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('indent')" title="Indent"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8l4 4-4 4M12 4h9M12 12h9M12 20h9"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('outdent')" title="Outdent"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 8L3 12l4 4M12 4h9M12 12h9M12 20h9"/></svg></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenInsertLink()" title="Insert Link"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></button>
      <button class="zen-tb" onclick="zenInsertHR()" title="Horizontal Rule"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg></button>
      <button class="zen-tb" onclick="zenInsertCode()" title="Inline Code"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenClearFormat()" title="Clear Formatting"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg></button>
    </div>
    <button class="zen-tb" onclick="zenSaveVersion()" title="Save Version (Cmd+S)" style="font-size:10px;width:auto;padding:0 8px;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><path d="M17 21v-8H7v8M7 3v5h8"/></svg> Save</button>
    <select class="zen-tb-select" id="zen-export-sel" onchange="zenExport(this.value);this.selectedIndex=0">
      <option value="">Export</option>
      <option value="md">Markdown</option>
      <option value="html">HTML</option>
      <option value="txt">Plain Text</option>
      <option value="clipboard">Copy All</option>
    </select>
    <button class="zen-close-btn" onclick="zenClose()" title="Close (Esc)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
  </div>
  <div class="zen-body">
    <input type="text" class="zen-title" id="zen-title" placeholder="Untitled Document" oninput="zenOnChange()">
    <div class="zen-editor" id="zen-editor" contenteditable="true" data-placeholder="Start writing..." oninput="zenOnChange()" onkeydown="zenKeydown(event)"></div>
  </div>
  <div class="zen-statusbar">
    <span id="zen-words">0 words</span>
    <span id="zen-chars">0 chars</span>
    <span id="zen-reading">0 min read</span>
    <span id="zen-goal" style="cursor:pointer" onclick="zenSetGoal()" title="Set word goal"></span>
    <span id="zen-saved" style="margin-left:auto">Saved</span>
  </div>
</div>

<!-- Floating Write Button -->
<button class="zen-fab" id="zen-fab" onclick="zenOpen()" title="Open Writer (Cmd+Shift+W)">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
</button>
<!-- Floating Quick Note Button -->
<button class="zen-fab" onclick="toggleQuickNote()" title="Quick Note" style="left:20px;right:auto;bottom:20px;background:linear-gradient(135deg,rgba(34,211,238,0.15) 0%,rgba(74,222,128,0.1) 100%);border-color:rgba(34,211,238,0.25);color:#22d3ee">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<!-- Task Detail Modal -->
<div class="task-detail-modal" id="task-detail-modal" onclick="if(event.target===this)closeTaskDetail()">
  <div class="task-detail-inner">
    <h3 id="td-heading">Task Details</h3>
    <div class="td-field"><label>Title</label><input type="text" id="td-title" placeholder="Task title..."></div>
    <div class="td-field"><label>Description</label><textarea id="td-desc" placeholder="Add details, notes, context..."></textarea></div>
    <div class="td-field-row">
      <div class="td-field"><label>Status</label><select id="td-status"><option value="todo">To Do</option><option value="progress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select></div>
      <div class="td-field"><label>Priority</label><select id="td-priority"><option value="p0">P0 Critical</option><option value="p1">P1 High</option><option value="p2">P2 Medium</option><option value="p3">P3 Low</option></select></div>
    </div>
    <div class="td-field-row">
      <div class="td-field"><label>Project</label><input type="text" id="td-project" placeholder="Project name..." list="pdl"></div>
      <div class="td-field"><label>Due Date</label><input type="date" id="td-due"><div style="display:flex;gap:3px;margin-top:3px"><button class="btn btn-sm btn-ghost" onclick="tdSetDue(0)" style="font-size:8px;padding:1px 5px">Today</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(1)" style="font-size:8px;padding:1px 5px">Tmrw</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(7)" style="font-size:8px;padding:1px 5px">+1W</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(30)" style="font-size:8px;padding:1px 5px">+1M</button><button class="btn btn-sm btn-ghost" onclick="document.getElementById('td-due').value=''" style="font-size:8px;padding:1px 5px;color:var(--red)">Clear</button></div><input type="text" id="td-due-natural" placeholder="or type: friday, 3d, next week..." style="font-size:9px;padding:3px 6px;margin-top:3px;width:100%;border:1px solid var(--border);border-radius:4px;background:var(--bg-input);color:var(--text-secondary)" onkeydown="if(event.key==='Enter'){const v=parseNaturalDate(this.value);if(v&&v!==this.value){document.getElementById('td-due').value=v;this.value='';toast('Due: '+v);}event.preventDefault();}"></div>
    </div>
    <div class="td-field-row">
      <div class="td-field"><label>Recurrence</label><select id="td-recur"><option value="">None</option><option value="daily">Daily</option><option value="weekday">Weekdays</option><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option></select></div>
      <div class="td-field"><label>Estimate</label><input type="text" id="td-estimate" placeholder="e.g. 30m, 2h, 1d" style="font-size:10px"></div>
    </div>
    <div style="display:flex;gap:8px;font-size:9px;color:var(--text-muted);padding:2px 0"><span id="td-recur-info"></span></div>
    <div class="td-field-row">
      <div class="td-field"><label>Blocked By</label><input type="text" id="td-blocked-by" placeholder="Task name..." style="font-size:10px"></div>
    </div>
    <div class="td-field"><label>Tags</label><div id="td-tags" style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;min-height:24px"></div></div>
    <div class="td-field">
      <label id="td-subtasks-label">Subtasks</label>
      <div class="td-subtasks" id="td-subtasks"></div>
      <div class="td-add-subtask" onclick="addSubtaskInModal()">+ Add subtask</div>
    </div>
    <div class="td-field"><label>Notes <span id="td-notes-count" style="font-size:8px;color:var(--text-muted);font-weight:400"></span></label><textarea id="td-notes" placeholder="Quick notes, decisions, updates..." style="min-height:40px;font-size:10px;resize:vertical"></textarea></div>
    <div class="td-field"><label>Color Labels</label><div id="td-labels" style="display:flex;gap:4px;flex-wrap:wrap"></div></div>
    <div class="td-created" id="td-created"></div>
    <div id="td-log" style="margin-top:8px"></div>
    <div class="td-footer">
      <button class="btn btn-primary btn-sm" onclick="saveTaskDetail()">Save</button>
      <button class="btn btn-sm" onclick="closeTaskDetail()">Cancel</button>
      <button class="btn btn-sm" onclick="duplicateTask()">Duplicate</button>
      <button class="btn btn-sm" onclick="taskToContent()" title="Save task details as content">To Content</button>
      <button class="btn btn-sm" onclick="taskToSpec()" title="Create Living Doc from task">To Spec</button>
      <button class="btn btn-sm" onclick="taskToDoc()" title="Create Writer doc from task">To Doc</button>
      <button class="btn btn-sm" id="td-timer-btn" onclick="toggleTaskTimer()" title="Start/stop time tracking"></button>
      <button class="btn btn-sm" onclick="ftStartForTask(taskDetailId)" title="Start 25min focus timer for this task" style="color:var(--accent)">Focus</button>
      <button class="btn btn-sm" id="td-unblock-btn" onclick="unblockTask()" title="Clear blocked-by and set to todo" style="display:none;color:var(--orange)">Unblock</button>
      <button class="btn btn-sm" onclick="copyTaskAsMarkdown()" title="Copy task as markdown">Copy MD</button>
      <button class="btn btn-sm" onclick="snoozeTask(1)" title="Push due date +1 day" style="color:var(--yellow)">+1d</button>
      <button class="btn btn-sm" onclick="snoozeTask(7)" title="Push due date +1 week" style="color:var(--yellow)">+1w</button>
      <button class="btn btn-sm" onclick="cloneTaskToProject()" title="Clone task to another project" style="color:var(--accent-cyan)">Clone</button>
      <button class="btn btn-sm" onclick="splitTaskSubtasks()" title="Convert subtasks into separate tasks">Split</button>
      <button class="btn btn-sm btn-danger" onclick="deleteTaskFromDetail()" style="margin-left:auto">Delete</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// === STATE ===
const SK = 'saturno-private-hub';
let S = { content:[], tasks:[], links:[], docs:[], specs:[], activeDoc:null, activeSpec:null, whiteboard:{}, projects:[], knowledgeBase:[], folders:[] };
let currentSection = 'content';
let contentType = 'all', contentTheme = 'all', contentTagFilter = null;
let taskView = 'list', taskFilter = 'all', taskProjectFilter = null;
let linkCategory = 'all';
let editingContentId = null, editingLinkId = null;
let writerTimer = null, specTimer = null, writerPanelOpen = false, writerAutoBackupTimer = null, writerSessionStart = {};
let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
let calView = 'month'; // 'month' or 'week'
let calWeekStart = null; // Date object for week view start (Monday)
let calDragId = null;
let recentItems = [];
function trackRecent(type, id, title) {
  recentItems = recentItems.filter(r => !(r.type===type && r.id===id));
  recentItems.unshift({ type, id, title: title||'Untitled', time: Date.now() });
  if(recentItems.length > 10) recentItems = recentItems.slice(0, 10);
}

function load() {
  try { const s = localStorage.getItem(SK); if(s) S = { content:[], tasks:[], links:[], docs:[], specs:[], activeDoc:null, activeSpec:null, whiteboard:{}, projects:[], knowledgeBase:[], folders:[], ...JSON.parse(s) }; } catch(e){}
  if(!S.projects) S.projects = [];
  if(!S.knowledgeBase) S.knowledgeBase = [];
  if(!S.docs.length) { S.docs.push({id:Date.now(),title:'',body:'',versions:[],created:new Date().toISOString(),updated:new Date().toISOString()}); S.activeDoc=S.docs[0].id; }
  if(!S.activeDoc&&S.docs.length) S.activeDoc=S.docs[0].id;
  if(!S.specs) S.specs=[];
  if(!S.specs.length) { seedKernel(); }
  if(!S.activeSpec&&S.specs.length) S.activeSpec=S.specs[0].id;
  if(S._accentColor) document.documentElement.style.setProperty('--accent',S._accentColor);
}

function migrateV2() {
  // Add Claude Code project if it doesn't exist yet
  if(S.projects && S.projects.length && !S.projects.find(p => p.id === 'proj_claude_code')) {
    const now = new Date().toISOString();
    S.projects.push({
      id:'proj_claude_code', name:'Claude Code', icon:'terminal', status:'active', color:'#a78bfa',
      instructions:'<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div><h1>Claude Code - Session Continuity Kernel</h1><h2>Purpose</h2><p>This project is the SINGLE SOURCE OF TRUTH for every Claude Code session. Any new Claude reads this project first and knows exactly what to do without asking Gabo.</p><h2>Rules That NEVER Change</h2><ol><li>~/dev/ is canonical for ALL repos - NOT Desktop, NOT iCloud</li><li>NO DELETE - archive, never delete</li><li>Every Gabo message -> save to backend as-is (project/title/text)</li><li>Commit + deploy after EVERY meaningful change</li><li>Dark theme only, no emojis in code</li><li>Custom over SaaS, always</li><li>DO NOT ASK GABO - read the logs and specs, then execute</li></ol><h2>Active Repos</h2><table><tr><th>Repo</th><th>Local</th><th>Live</th></tr><tr><td>astra-command-center</td><td>~/dev/astra-command-center/</td><td>astra-command-center-sigma.vercel.app</td></tr><tr><td>titan-forge</td><td>~/dev/titan-forge/</td><td>titan-forge-ten.vercel.app</td></tr><tr><td>saturno-bonus</td><td>~/dev/saturno-bonus/</td><td>saturno-bonus-omega.vercel.app</td></tr><tr><td>de-aqui-a-saturno</td><td>~/dev/de-aqui-a-saturno/</td><td>de-aqui-a-saturno-jet.vercel.app</td></tr></table><h2>Machine Context</h2><ul><li>C2 iMac: username Gabosaturno (CAPITAL G)</li><li>C1 MacBook Pro: username gabosaturno (lowercase)</li><li>GitHub: gabosaturno11</li></ul><h2>Design Constraints</h2><ul><li>Pure black backgrounds (#09090b)</li><li>Mint green for ASTRA (#4ade80)</li><li>Purple accents (#8b5cf6)</li><li>Dark theme ONLY</li></ul><h2>How to Use This Project</h2><p>1. Export this project as MD (click Export button)</p><p>2. The exported MD becomes CLAUDE.md in repo root</p><p>3. Next Claude Code session reads it automatically</p><p>4. Update KB items below as state changes</p>',
      created:now, updated:now
    });
    S.knowledgeBase.push(
      { id:'kb_cc_session_log', projectId:'proj_claude_code', name:'Session Log - Feb 16, 2026', type:'md', storage:'inline',
        content:'# Session Log — Feb 16, 2026 (LATEST)\n\n## Batch 1 (Commit 1e98d43):\nHide internal tools, fix auth, fix alerts, add auto-advance, add lock vault, coming soon section, BONUS PDF badges\n\n## Batch 2 (Commit 86dd606):\nRewrite ALL tool descriptions, categorize Training vs Experience, fix music case bug, fix gate og:image, create .env.example\n\n## Previous Session:\n- Desktop cleaned\n- Claude Code project added to ASTRA\n- Export feature added (MD, JSON, clipboard)\n- CLAUDE.md kernel placed in all repos\n- ASTRA V2 features: color tabs, mobile scroll, doc assignment, migrateV2()\n\n## Messages Backend:\n~/dev/saturno-bonus/logs/gabo-messages.json (16 messages, id 0-16)',
        description:'Current session state', tags:['session','log'], created:now, updated:now },
      { id:'kb_cc_gabo_rules', projectId:'proj_claude_code', name:'Gabo Rules (Permanent)', type:'md', storage:'inline',
        content:'# Permanent Rules\n1. ~/dev/ is canonical\n2. NO DELETE\n3. Every message -> backend\n4. Commit + deploy after EVERY change\n5. Dark theme only\n6. Custom over SaaS\n7. DO NOT ASK - execute\n8. BOOK FIRST\n9. planet-logo.png is THE logo\n10. Audio 404s on Vercel - needs CDN\n11. Brevo needs API keys in Vercel env',
        description:'Rules that never change', tags:['rules','permanent'], created:now, updated:now },
      { id:'kb_cc_messages', projectId:'proj_claude_code', name:'Messages Backend', type:'md', storage:'inline',
        content:'# Backend: ~/dev/saturno-bonus/logs/gabo-messages.json\n9 messages (id 0-8)\nRule: save EVERY message unless told otherwise',
        description:'Message log location', tags:['messages','backend'], created:now, updated:now }
    );
    save();
  }
  // Add v2.0 build summary if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_v2_build')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_v2_build', projectId:'proj_claude_code', name:'ASTRA v2.0 Build Summary — Feb 16, 2026', type:'md', storage:'inline',
        content:'# SATURNO HUB v2.0 Build Summary\n\n## Session: Feb 16, 2026\n**17 commits pushed** | 3,400 lines | 224+ functions | Single-file HTML app\n\n## New Features Built:\n\n### Architecture\n1. **3-Panel Resizable Layout** - sidebar (220px) + primary (flex) + context panel (320px)\n2. **Mode Switching** - Focus (primary only), Default, Extended (all panels)\n3. **Resizable Panels** - Drag handles on sidebar + context panel borders\n4. **Responsive Design** - Mobile sidebar, stacked layouts, adaptive breakpoints\n\n### Navigation & Search\n5. **Command Palette (Cmd+K)** - Fuzzy search across all items, sections, actions\n6. **Keyboard Shortcuts** - Cmd+1-7 sections, Cmd+N new, Cmd+E context, Cmd+\\ focus, Cmd+/ help\n7. **Breadcrumb Navigation** - Shows current doc/spec/project in header\n8. **Recent Items Tracking** - Last 10 accessed items shown in Cmd+K\n\n### Knowledge Management\n9. **Folder System** - Tree UI in sidebar, nested folders, create/rename/delete\n10. **Drag-and-Drop to Folders** - Content cards + link cards to folder tree\n11. **[[Wiki-Links]]** - Cross-referencing system with backlink engine\n12. **Mini Knowledge Graph** - Force-directed canvas visualization in context panel\n13. **Global Tagging System** - Tags on content, searchable, displayed on cards\n\n### Productivity\n14. **Focus Timer** - Pomodoro with SVG progress, categories, embedded in context\n15. **Quick Capture (Cmd+Shift+N)** - Floating bar for instant task/content/note\n16. **Today View** - Overdue/today/upcoming tasks in context panel\n17. **Writer Word Goals** - Clickable goal target in status bar\n18. **Project Progress Bars** - Task completion % per project in sidebar\n\n### Polish\n19. **SVG Sidebar Icons** - Lucide-style icons replacing letter icons\n20. **Logo Breathing Animation** - Subtle opacity animation\n21. **Glass Morphism Modals** - Backdrop blur + transparency\n22. **Auto-Save Indicator** - Flash in header on save\n23. **Sidebar Dashboard** - Mini task/docs/project counts\n24. **Smooth Panel Transitions** - Fade opacity on section switch\n25. **Endel-Inspired Theme** - Deeper blacks (#050508), refined borders\n\n## Commits:\n```\necb41f8 Today View\ne44c78e Writer word goals\n9cfdf6d Project progress bars\n4d1fd59 Quick Capture bar\n31ae7f5 Responsive design\nb84d449 Global tagging\neec1099 Sidebar dashboard + auto-save\n275f22f Drag-drop to folders\n14cedd2 Breadcrumbs + shortcuts help\nabcb1a6 Keyboard shortcuts + recent items\nea2eea5 Endel polish (SVG icons, breathe, glass)\n3eda6bc Resizable panels\n21df181 Mini knowledge graph\nd517f68 Folder tree UI\n6df5e02 Wiki-links wiring\n6470d43 Context panel related items\n```\n\n## What Still Could Be Done:\n- Unified BaseItem schema refactor\n- Task subtasks/checklists\n- Drag-drop folder reordering\n- Wiki-link rendering in contenteditable editors\n- More Endel transitions/microinteractions\n- Activity log / changelog\n- Pinned items feature',
        description:'Complete build log for the v2.0 upgrade session', tags:['v2','build-log','session','architecture'], created:now, updated:now }
    );
    save();
  }
  // Add v2.0 fix session log
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_v2_fixes')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_v2_fixes', projectId:'proj_claude_code', name:'v2.0 UX Fix Session — Feb 16, 2026 (evening)', type:'md', storage:'inline',
        content:'# v2.0 UX Fix Session — Feb 16, 2026\n\n## Critical fix: Panel resize breaking layout\n- Project panel resize was setting app.style.gridTemplateColumns as inline style\n- This permanently overrode all CSS class-based grid definitions\n- After any drag, closing panel or switching modes left broken inline style\n- FIX: Now uses --project-width CSS variable instead of inline style\n\n## Panel conflicts resolved\n- Opening a project now closes context panel (they share same grid slot)\n- Toggling context panel now closes project panel first\n- Focus mode properly closes both project and context panels\n- Extended mode closes project panel, opens context panel\n\n## Migration ordering fix\n- migrateV2() was running inside load() before seedProjects()\n- On fresh localStorage, S.projects.length was 0 so Claude Code project was never created\n- FIX: migrateV2 now runs after seedProjects()\n\n## Other fixes\n- Links added from project panel now get projectId assigned\n- Removed duplicate saveLink monkeypatch override\n- Archive project now requires confirmation dialog\n- switchSection properly highlights sidebar item when called programmatically\n- Removed dead wbCanvasDownV2 wrapper code\n- Removed conflicting explicit width on context panel CSS\n- Removed negative margins on resize handles causing misalignment\n\n## Deployment discovery\n- Live URL is astra-command-center-sigma.vercel.app\n- NOT astra-command-center.vercel.app (that is an OLD Vercel project)\n\n## Commits (7):\neccdc1f, 6fdb2f2, 955273b, 12141fe, e806f0e, 84b0b45, 804ee06',
        description:'UX bug fixes for panel resize, mode switching, migration ordering', tags:['v2','fixes','session','ux'], created:now, updated:now }
    );
    save();
  }
  // Add collapsible sidebars log
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_collapsible_panels')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_collapsible_panels', projectId:'proj_claude_code', name:'Collapsible Panels — Feb 16, 2026', type:'md', storage:'inline',
        content:'# Collapsible Panels Feature\n\n## Left Sidebar\n- Sidebar panel icon in header toggles sidebar visibility\n- Double-chevron (<<) at bottom of sidebar collapses it\n- CSS class: .app.sidebar-collapsed hides sidebar completely (0px grid column)\n- Sidebar resize handle also hidden when collapsed\n- Grid recalculates for all states: default, project-open, context-open, extended\n- Smooth transition via grid-template-columns 0.25s\n\n## Right Project Panel\n- Double-chevron (>>) at bottom of project panel to collapse/close\n- Uses existing closeProjectPanel() function\n- Minimalistic arrow design matching Claude AI reference screenshots\n\n## Implementation\n- toggleSidebar() function toggles .sidebar-collapsed class\n- CSS handles all grid states when collapsed\n- Focus mode (.mode-focus) is separate — hides sidebar via display:none\n- No conflict between collapsed state and focus mode',
        description:'Collapsible sidebar and project panel with chevron arrows', tags:['v2','ux','panels','collapsible'], created:now, updated:now }
    );
    save();
  }
  // Rename kernel spec and assign to all projects
  const kernel = S.specs.find(s => s.id === 1000);
  if(kernel && kernel.title === 'Saturno Living Canvas v2.0') {
    kernel.title = 'Saturno OS Complete Map';
    kernel.icon = 'globe';
    kernel.color = '#4ade80';
    save();
  }
  // Ensure icon/color fields on all specs
  S.specs.forEach(s => { if(!s.icon) s.icon = 'file'; if(!s.color) s.color = '#8b8b8b'; });
  // Seed per-project living docs if not present
  if(!(S.specs||[]).find(s => s.id === 'ld_bonus')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_bonus', title:'Saturno Bonus — Project Spec', projectId:'proj_saturno_bonus', icon:'rocket', color:'#4ade80',
      created:now, updated:now,
      sections:[
        {id:'ld_b1',title:'Design & Branding',icon:'palette',color:'#8b5cf6',body:'<p><b>Visual Identity:</b> Dark cosmic theme (#050711 base), teal accents (#06b6d4, #22d3ee), Sora font.</p><p><b>Logo:</b> planet-logo.png (white silhouette). Used in header, gate, footer.</p><p><b>Layout:</b> Hero + category sections + tool grid + music player + PDF cards + footer.</p><p><b>Target Feel:</b> Premium vault, exclusive access, cosmic luxury.</p>',collapsed:false},
        {id:'ld_b2',title:'Technical Architecture',icon:'cpu',color:'#22d3ee',body:'<p><b>Stack:</b> Static HTML + Vercel serverless functions. Single-page index.html (~1,800 lines).</p><p><b>Auth:</b> Cookie-based password gate (saturno2025). Redirects on auth fail.</p><p><b>API:</b> /api/verify (password), /api/brevo (email capture), /api/config (feature flags), /api/admin-verify.</p><p><b>Storage:</b> No database. PDFs/tools served as static files from bonuses/ directory.</p><p><b>Music:</b> manifest.json for track metadata. Audio files gitignored (need CDN).</p>',collapsed:false},
        {id:'ld_b3',title:'Content Inventory',icon:'layers',color:'#f59e0b',body:'<p><b>Tools (60):</b> 19 Training + 25 Experience + 16 unlisted. Each is a standalone HTML file in bonuses/tools/.</p><p><b>PDFs (15):</b> HBF phases, skill programming, routines. In pdfs/.</p><p><b>Music (36 tracks):</b> 8 categories. In audio/ (gitignored, needs CDN).</p><p><b>Video:</b> app-promo.mov needs MP4 conversion.</p>',collapsed:true},
        {id:'ld_b4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'<p><b>BLOCKER 1:</b> Domain — bonus.saturnomovement.com (Cloudflare CNAME needed by Gabo)</p><p><b>BLOCKER 2:</b> Brevo API keys not in Vercel env vars (email capture broken)</p><p><b>BLOCKER 3:</b> Audio files 404 on Vercel (gitignored + vercelignored, needs CDN solution)</p><p><b>BLOCKER 4:</b> app-promo.mov is .mov format (needs .mp4 conversion for web)</p><p><b>BLOCKER 5:</b> Physical device testing (Gabo must QA on phone/iPad)</p>',collapsed:false},
        {id:'ld_b5',title:'Roadmap & Milestones',icon:'flag',color:'#06b6d4',body:'<p><b>Phase 1 (DONE):</b> Core page live, auth, tools, PDFs, descriptions rewritten, categories sorted.</p><p><b>Phase 2 (NOW):</b> Domain setup, Brevo integration, music CDN, device QA.</p><p><b>Phase 3:</b> 100 tools, 100 PDFs, album artwork, polished footer, video embed.</p><p><b>Phase 4:</b> Analytics review, A/B test gate, referral system, subscriber dashboard.</p>',collapsed:true},
        {id:'ld_b6',title:'Links & Resources',icon:'link',color:'#a78bfa',body:'<p><b>Live:</b> <a href="https://saturno-bonus-omega.vercel.app/index.html" target="_blank">saturno-bonus-omega.vercel.app</a></p><p><b>Repo:</b> github.com/gabosaturno11/saturno-bonus</p><p><b>Gate:</b> saturno-bonus-omega.vercel.app/gate.html (password: saturno2025)</p><p><b>Vercel Dashboard:</b> vercel.com/gabosaturno</p><p><b>Cloudflare:</b> dash.cloudflare.com (saturnomovement.com)</p>',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_sm_app')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_sm_app', title:'SM App Rebuild — Project Spec', projectId:'proj_sm_app', icon:'code', color:'#8b5cf6',
      created:now, updated:now,
      sections:[
        {id:'ld_a1',title:'Architecture Overview',icon:'cpu',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_a2',title:'Developer Handoff Status',icon:'users',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_a3',title:'Tech Stack & Dependencies',icon:'layers',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_a4',title:'Blockers & Risks',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_a5',title:'Roadmap & Timeline',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_book')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_book', title:'Book (AOC) — Project Spec', projectId:'proj_book', icon:'book', color:'#f59e0b',
      created:now, updated:now,
      sections:[
        {id:'ld_k1',title:'Submission Package Status',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_k2',title:'Chapter Outline',icon:'list',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_k3',title:'Publisher Communications',icon:'mail',color:'#a78bfa',body:'',collapsed:false},
        {id:'ld_k4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_k5',title:'Timeline & Deadlines',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_hbs')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_hbs', title:'HBS Program — Project Spec', projectId:'proj_hbs', icon:'target', color:'#06b6d4',
      created:now, updated:now,
      sections:[
        {id:'ld_h1',title:'Program Structure',icon:'layers',color:'#06b6d4',body:'',collapsed:false},
        {id:'ld_h2',title:'Content Inventory',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_h3',title:'Digital Assets (SSK Drive)',icon:'hdd',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_h4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_h5',title:'Launch Plan',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_karina')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_karina', title:'De Aqui a Saturno — Project Spec', projectId:'proj_karina', icon:'heart', color:'#ec4899',
      created:now, updated:now,
      sections:[
        {id:'ld_d1',title:'Site Architecture',icon:'globe',color:'#ec4899',body:'',collapsed:false},
        {id:'ld_d2',title:'Content & Copy',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_d3',title:'Design System',icon:'palette',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_d4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_d5',title:'Deployment & Maintenance',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_claude')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_claude', title:'Claude Code — Project Spec', projectId:'proj_claude_code', icon:'terminal', color:'#a78bfa',
      created:now, updated:now,
      sections:[
        {id:'ld_c1',title:'Session Continuity Protocol',icon:'refresh',color:'#a78bfa',body:'',collapsed:false},
        {id:'ld_c2',title:'Repo & Deployment Map',icon:'globe',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_c3',title:'Kernel Rules',icon:'lock',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_c4',title:'Blockers & Open Issues',icon:'alert',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_c5',title:'Session Logs',icon:'file',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  // Add bonus project link if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_saturno_bonus')) {
    if(!S.links.find(l => l.url === 'https://saturno-bonus-omega.vercel.app/index.html')) {
      S.links.push({id:Date.now(), title:'Saturno Bonus — Live', url:'https://saturno-bonus-omega.vercel.app/index.html', category:'Production', projectId:'proj_saturno_bonus', created:new Date().toISOString()});
      save();
    }
  }
  // Add asset catalog to Saturno Bonus if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_saturno_bonus') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_bonus_assets')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_bonus_assets', projectId:'proj_saturno_bonus', name:'Asset Catalog — TBV by Gabo', type:'md', storage:'inline',
        content:'# Bonus Assets — Verified Feb 16, 2026\n\n## PDFs (15 files, ~/dev/saturno-bonus/pdfs/)\n### BONUS (green badge on page):\n- Handstand Press Program (1.5MB)\n- Press to Handstand Full Program (1.8MB)\n- Calisthenics Skills Programming Ebook (14.2MB)\n- HBF Introduction (123KB)\n- HBF Phase 1 Weeks 1-6 (30MB each, 6 files)\n### Standard (no badge):\n- 15min Front Lever, HSPU, Muscle-Up, Planche Routines\n- Mobility vs Flexibility, Move List Database, General Warmup\n\n## Tools (44 visible on index.html)\n### 19 Training Tools:\nBreathing Pacer, Supplement Tracker, Cosmic Timer, Rep Counter,\nSleep Protocol, Orbital Tracker, Nebula Breath, Core Values,\nValues Roulette, Movement Galaxy, Constellation Builder,\nProgression Pathfinder, Alien Trainer, Gravity Well, Galactic Core,\nBinary Star, Ring of Fire, Lunar Cycle, Solar Wind\n### 25 Experience Tools:\nConstellation, Galaxy Zoom, Alien Oracle, Aurora, Asteroid Belt,\nBig Bang, Black Hole, Comet Trail, Cosmic Dust, Dark Matter,\nEvent Horizon, Hyperspace, Meteor Shower, Neutron Star,\nPlasma Burst, Pulsar, Quantum Leap, Red Giant, Singularity,\nSolar Flare, Stargate, Supernova, Void Walker, White Dwarf,\nWormhole Generator\n### 3 Hidden (internal):\nTranscript to PDF, Music Organizer, Master Hub\n\n## Music (36 tracks, ~/dev/saturno-bonus/audio/)\n- Manifest: audio/manifest.json\n- 8 categories: White Universe EP, Black Universe EP, Tears of Joy,\n  Meditation/Chill, Hip Hop/Beats, Trancy, High Energy, Stingers\n- BLOCKED: Audio 404s on Vercel (gitignored)\n- All 36 MP3 files verified locally\n\n## TBV by Gabo:\n- PDF quality/branding review\n- Music album artwork\n- CDN solution for audio hosting',
        description:'Complete asset inventory for bonus vault — to be verified', tags:['assets','inventory','tbv'], created:now, updated:now },
      { id:'kb_bonus_phases', projectId:'proj_saturno_bonus', name:'Build Phases — Completion Status', type:'md', storage:'inline',
        content:'# Bonus Page Build Status — Updated Feb 16\n\n## DONE (code changes shipped):\n- 3 internal tools hidden from customers\n- Auth works on Vercel + custom domains (not just GitHub)\n- og:image absolute URL for social previews\n- Analytics production script (not debug)\n- Alert() replaced with inline feedback\n- Modal closes on overlay click\n- Music auto-advances to next track\n- Lock Vault button in footer\n- Coming Soon tease section (3 products)\n- BONUS badges on HBF and exclusive PDFs\n- 44 tool descriptions rewritten customer-quality\n- Tools categorized: 19 Training + 25 Experience\n- Case-sensitive audio path fixed\n- .env.example created\n\n## BLOCKERS (Gabo must do):\n- Set domain: bonus.saturnomovement.com\n- Add BREVO_API_KEY + BREVO_LIST_ID to Vercel\n- Audio CDN solution (files 404 on Vercel)\n- Physical device QA\n- Music album artwork\n- app-promo.mov needs MP4 conversion for embed',
        description:'Phase completion tracking', tags:['phases','status','progress'], created:now, updated:now }
    );
    save();
  }
  // Voice Pipeline + Floating Bar (Feb 17 evening)
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_voice_pipeline')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_voice_pipeline', projectId:'proj_claude_code', name:'Voice Pipeline + Floating Bar — Feb 17 Evening', type:'md', storage:'inline',
        content:'# Voice Pipeline + Floating Bar — Feb 17 Evening\n\n## /api/transcribe (NEW)\n- Receives audio blob via multipart POST\n- Sends to OpenAI Whisper API (whisper-1 model)\n- Returns { ok, text, duration, transcriptId }\n- Auto-logs to transcripts blob storage\n- Requires OPENAI_API_KEY env var (SET in .zshrc)\n- Commit: 74ddb86\n\n## ASTRA Voice Upgrade\n- Replaced Chrome SpeechRecognition with real MediaRecorder\n- Click voice btn to record mic, click again to stop\n- Audio sent to /api/transcribe (Whisper)\n- Text auto-inserts into Writer or Living Docs editor\n- Commit: 9bb30bb\n\n## Nexus Capture Extension Updates\n- Right-click > "Create Sound (TTS)" speaks selected text\n- Uses browser speechSynthesis (works offline)\n- Background handles transcribeAudio messages\n- Commit: 84a4b08\n\n## System-Wide Tools (macOS)\n- create-sound.sh: speaks clipboard text via macOS say command\n- --save flag saves .aiff audio file to ~/dev/nexus-capture/sounds/\n- "Create Sound" Quick Action installed in Services menu\n- Commit: 8228195\n\n## Floating NEXUS Bar\n- floating-bar.html: mini HTML panel with 4 buttons\n- Capture: grabs clipboard, sends to ASTRA /api/capture\n- Voice: records mic, transcribes via Whisper, copies result\n- Sound: speaks clipboard text via browser TTS\n- ASTRA: opens ASTRA hub\n- open-nexus-bar.sh: launches as Chrome app window\n- Commit: d8d8efc\n\n## PWA\n- ASTRA installable on phone (manifest.json + sw.js)\n- New planet icon with cosmic center (icon-192.png, icon-512.png)\n- Commit: c1aceea\n\n## Still Needs\n- BLOB_READ_WRITE_TOKEN in Vercel (Gabo setting up)\n- Keyboard shortcuts for Quick Actions (System Settings > Keyboard > Shortcuts > Services)\n- Test full pipeline end-to-end once blob token is set',
        description:'Voice pipeline, Whisper integration, floating bar, TTS, PWA', tags:['voice','whisper','tts','floating-bar','pipeline'], created:now, updated:now }
    );
    save();
  }
  // Add Backend + Nexus Capture session log (Feb 17)
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_backend_session')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_backend_session', projectId:'proj_claude_code', name:'Backend + Nexus Capture Setup — Feb 17, 2026', type:'md', storage:'inline',
        content:'# ASTRA Backend + Nexus Capture — Feb 17, 2026\n\n## ASTRA Backend (NEW)\nASTRA was localStorage-only. Now has Vercel serverless API:\n- api/state.js: Save/load full workspace to Vercel Blob\n- api/transcripts.js: Log voice transcripts with searchable index\n- api/query.js: Query specs, bottlenecks, KB, tasks, projects, full-text search\n- api/capture.js: Receive captures from extension or system-wide tools\n- api/health.js: Health check endpoint\n- package.json: @vercel/blob dependency\n- vercel.json: API rewrites\n- Frontend: cloudSave(), cloudLoad(), Cmd+S syncs to cloud\n- Voice input now auto-logs transcripts to backend\n- NEEDS: BLOB_READ_WRITE_TOKEN in Vercel env vars to activate\n\n## Nexus Capture Extension (NEW REPO)\n- Repo: github.com/gabosaturno11/nexus-capture\n- Path: ~/dev/nexus-capture/\n- Chrome Manifest V3 extension\n- Highlight text on any webpage -> floating button -> categorize -> save\n- 8 categories with color coding\n- Visual highlights persist per page\n- Routes to ASTRA backend /api/capture\n- Optional Notion integration\n- Keyboard: Cmd+Shift+S\n- Right-click context menu: Capture as Idea/Quote/Code/Insight/To-Do\n- BUG FIXED: double-click issue (selection stored on mouseup now)\n\n## System-Wide Capture (macOS)\n- capture-highlight.sh: grabs clipboard/selected text, sends to ASTRA API\n- macOS Automator Quick Action: "Nexus Capture" in Services menu\n- Works from ANY app (Notes, Preview, Pages, etc.)\n- Shows macOS notification on success\n- Fallback: saves locally if API unreachable\n\n## Whisper Transcription\n- faster-whisper installed in ~/dev/.whisper-env/ (Python venv)\n- whisper-transcribe.sh: local transcription (base/small/medium/large models)\n- whisper-api-transcribe.sh: cloud transcription via OpenAI Whisper API\n- record-and-transcribe.sh: record from mic + auto-transcribe\n- All scripts can --log to ASTRA transcripts API\n- OpenAI SDK also installed for API fallback\n\n## Bonus Page\n- Password protection temporarily disabled (Gabo requested)\n- middleware.js returns next() immediately\n- index.html auth check commented out\n- Both marked TEMP for easy re-enable\n\n## Commits:\n- 5d18143: ASTRA backend (state, transcripts, query, capture APIs)\n- 7f7c435: Health check endpoint\n- b9acd53: CLAUDE.md update\n- 39743ac: nexus-capture init\n- cc81f79: Double-click bug fix\n- 9d639d0: faster-whisper, path fixes\n- 02587b3: Bonus auth disabled (temp)\n- (this commit): KB entry + final save',
        description:'Full session log: ASTRA backend, Nexus Capture extension, Whisper setup, system-wide capture', tags:['backend','nexus-capture','whisper','session','infrastructure'], created:now, updated:now }
    );
    save();
  }
  // Inject Rule #1 into Claude Code project instructions if missing
  if(S.projects) {
    const cc = S.projects.find(p => p.id === 'proj_claude_code');
    if(cc && cc.instructions && !cc.instructions.includes('CANNON LAW')) {
      cc.instructions = '<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div>' + cc.instructions;
      save();
    }
  }
  // Migrate tasks: link tasks with project name to projectId
  if(S.tasks && S.projects) {
    let migrated = 0;
    S.tasks.forEach(t => {
      if(t.project && !t.projectId) {
        const p = S.projects.find(pr => pr.name === t.project);
        if(p) { t.projectId = p.id; migrated++; }
      }
    });
    if(migrated > 0) save();
  }
  // Deduplicate specs: keep the one with more content when titles match
  if(S.specs && S.specs.length > 1) {
    const seen = {};
    const dupes = [];
    S.specs.forEach(s => {
      const key = (s.title||'').toLowerCase().trim() + '|' + (s.projectId||'');
      if(seen[key]) {
        // Keep whichever has more section body content
        const existBody = (seen[key].sections||[]).reduce((a,sec) => a + (sec.body||'').length, 0);
        const thisBody = (s.sections||[]).reduce((a,sec) => a + (sec.body||'').length, 0);
        if(thisBody > existBody) { dupes.push(seen[key].id); seen[key] = s; }
        else { dupes.push(s.id); }
      } else { seen[key] = s; }
    });
    if(dupes.length) {
      S.specs = S.specs.filter(s => !dupes.includes(s.id));
      save();
    }
  }
  // Remove "Untitled" specs that have no content
  if(S.specs) {
    const before = S.specs.length;
    S.specs = S.specs.filter(s => {
      if((s.title||'').toLowerCase().trim() === 'untitled' || !s.title) {
        const hasContent = (s.sections||[]).some(sec => (sec.body||'').trim().length > 0);
        return hasContent; // keep only if it has actual content
      }
      return true;
    });
    if(S.specs.length < before) save();
  }
  // C1 iMac Audit - Feb 19 (canonical audit template, global)
  if(S.specs && !S.specs.find(s => s.id === 'ld_c1_imac_audit_feb19')) {
    S.specs.push({
      id:'ld_c1_imac_audit_feb19', title:'C1 iMac Audit - Feb 19, 2026', projectId:'proj_claude_code', global:true, icon:'monitor', color:'#4ade80',
      created:new Date().toISOString(), updated:new Date().toISOString(),
      sections:[
        {id:'c1a_machine',title:'Machine',collapsed:false,icon:'hdd',color:'#22d3ee',body:'<table><tr><th>Field</th><th>Value</th></tr><tr><td>Machine</td><td>iMac (C2)</td></tr><tr><td>User</td><td>/Users/Gabosaturno (CAPITAL G)</td></tr><tr><td>OS</td><td>macOS Sequoia 15.5</td></tr><tr><td>Drives</td><td>G-DRIVE ArmorATD (4.5TB), SSK (477GB), T7 (NTFS read-only)</td></tr><tr><td>Session Date</td><td>Feb 19, 2026</td></tr><tr><td>Session Type</td><td>Autonomous (Gabo sleeping)</td></tr></table>'},
        {id:'c1a_git',title:'Git State',collapsed:false,icon:'code',color:'#4ade80',body:'<h3>Repo: astra-command-center</h3><table><tr><th>Hash</th><th>Message</th></tr><tr><td><code>6e4e75f</code></td><td>Pipeline history card layout + copy buttons</td></tr><tr><td><code>491fa9b</code></td><td>C1 iMac Audit living doc</td></tr><tr><td><code>084812b</code></td><td>Writer doc list sorted + seed prevention</td></tr><tr><td><code>14e2a4d</code></td><td>Mobile responsive improvements</td></tr><tr><td><code>3c58377</code></td><td>Keyboard shortcuts + sidebar counts</td></tr><tr><td><code>74b63da</code></td><td>cloudLoad() auth header fix (CRITICAL)</td></tr><tr><td><code>e8232e0</code></td><td>Dedup living docs</td></tr><tr><td><code>fba49ed</code></td><td>Cloud sync indicator</td></tr><tr><td><code>338092e</code></td><td>Repos section + living docs preview</td></tr><tr><td><code>3bce8f5</code></td><td>Calendar week view</td></tr><tr><td><code>3a2ab59</code></td><td>Task detail modal + descriptions + subtasks</td></tr><tr><td><code>49ed0b8</code></td><td>Project tasks use projectId</td></tr><tr><td><code>5ac20fa</code></td><td>Lock GET endpoints</td></tr></table><p><b>Branch:</b> main | <b>Remote:</b> origin/main | <b>Status:</b> CLEAN, all pushed</p>'},
        {id:'c1a_deploy',title:'Deployment',collapsed:false,icon:'rocket',color:'#ef4444',body:'<table><tr><th>App</th><th>URL</th><th>Status</th></tr><tr><td>ASTRA</td><td>astra-command-center-sigma.vercel.app</td><td>LIVE (auto-deploy on push)</td></tr><tr><td>Bonus</td><td>saturno-bonus-omega.vercel.app</td><td>LIVE</td></tr><tr><td>Titan Forge</td><td>titan-forge-ten.vercel.app</td><td>LIVE</td></tr><tr><td>De Aqui</td><td>de-aqui-a-saturno-jet.vercel.app</td><td>LIVE</td></tr></table><p><b>Vercel Team:</b> gabriele-saturnos-projects | <b>Deploy Method:</b> git push main</p>'},
        {id:'c1a_api',title:'API Endpoints',collapsed:false,icon:'lock',color:'#8b5cf6',body:'<table><tr><th>Endpoint</th><th>GET</th><th>POST</th><th>Auth</th></tr><tr><td>/api/state</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/capture</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/transcripts</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/pipeline</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/transcribe</td><td>N/A</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/query</td><td>N/A</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/health</td><td>200</td><td>N/A</td><td>Public</td></tr></table><p><b>Storage:</b> Vercel Blob (BLOB_READ_WRITE_TOKEN env var)</p>'},
        {id:'c1a_sections',title:'Section Health',collapsed:false,icon:'layers',color:'#f59e0b',body:'<table><tr><th>Section</th><th>Health</th><th>Notes</th></tr><tr><td>Content</td><td>70%</td><td>Grid + filters work, no inline editing</td></tr><tr><td>Tasks</td><td>85%</td><td>Board + list + detail modal + subtasks + descriptions</td></tr><tr><td>Calendar</td><td>80%</td><td>Month + week views, click-to-create task</td></tr><tr><td>Writer</td><td>90%</td><td>Full editor, versions, export, auto-save 800ms, Zen Writer</td></tr><tr><td>Living Docs</td><td>85%</td><td>Sections, icons, colors, export, dedup logic</td></tr><tr><td>Links</td><td>75%</td><td>Directory + categories, no preview</td></tr><tr><td>Whiteboard</td><td>85%</td><td>Canvas tools, nodes, connections, zoom</td></tr><tr><td>Pipeline</td><td>50%</td><td>UI exists, needs Whisper API key for audio</td></tr><tr><td>Repos</td><td>70%</td><td>Static data, 5 repos with links</td></tr></table>'},
        {id:'c1a_fixes',title:'Fixes Applied',collapsed:true,icon:'alert',color:'#ef4444',body:'<ol><li><b>cloudLoad auth header</b> - GET /api/state was locked but cloudLoad fetched without Bearer token. Cloud sync silently failed on every load. FIXED.</li><li><b>Sidebar counts stale</b> - updateSidebarCounts() now runs on every save(). FIXED.</li><li><b>seedProjects re-running</b> - Added S._seeded flag to prevent duplicate seeding after cloud load. FIXED.</li><li><b>Dead /api/repos ping</b> - Removed self-ping to nonexistent endpoint on page load. FIXED.</li><li><b>Living doc duplicates</b> - Dedup logic in migrateV2 removes dupes by title+projectId. FIXED.</li></ol>'},
        {id:'c1a_features',title:'Features Shipped',collapsed:true,icon:'rocket',color:'#4ade80',body:'<ol><li>Task detail modal (title, description, status, priority, project, due, subtasks)</li><li>Board cards show description preview + subtask count</li><li>Calendar week view with month/week toggle</li><li>Click calendar day to create task with date pre-filled</li><li>Repos section with 5 static repos (GitHub + live links)</li><li>Cloud sync indicator (syncing/synced/error states)</li><li>Keyboard shortcuts: Cmd+Shift+T (new task anywhere), Cmd+B (sidebar)</li><li>Mobile: hamburger menu, horizontal board scroll, stacked week view</li><li>Writer doc list sorted by last-modified</li><li>Pipeline history card layout with copy buttons</li><li>Living docs body preview in project panel</li></ol>'},
        {id:'c1a_remaining',title:'Remaining',collapsed:false,icon:'target',color:'#f59e0b',body:'<ul><li>Bonus page shipping (prerequisite: ASTRA stable)</li><li>Whisper API key for pipeline audio processing</li><li>BLOB_READ_WRITE_TOKEN verification in Vercel env</li><li>Link previews (OG metadata fetch)</li><li>Content inline editing</li><li>Google Calendar sync (future)</li></ul>'}
      ]
    });
    save();
  }
  // Update existing audit to be global
  if(S.specs) {
    const audit = S.specs.find(s => s.id === 'ld_c1_imac_audit_feb19');
    if(audit && !audit.global) { audit.global = true; save(); }
  }
}

function seedKernel() {
  const now = new Date().toISOString();
  const kernel = {
    id: 1000,
    title: 'Saturno Living Canvas v2.0',
    created: now, updated: now,
    sections: [
      { id: 1001, title: 'Executive Summary', collapsed: false, body: '<p><b>THE SATURNO THESIS:</b> "Scale changes, truth doesn\'t."</p><p><b>TOP KERNEL RULE 00:</b></p><ul><li>No crown stealing -- delta-patches only</li><li>Preserve upstream kernels</li><li>Never overwrite explicit user commands</li></ul><p><b>THE REAL BOTTLENECK:</b><br>NOT: More prompts, more docs, more organization<br>IS: Routing intelligence that can read intent, search prompts, chain, route, execute, learn</p><p><b>MISSION (LOCKED):</b> Work ~4 focused hours per day while building a multimillion-dollar enterprise.</p><p><b>ASSETS SCALE:</b></p><ul><li>2,300+ prompts across platforms</li><li>2,000+ captions (10-12 years)</li><li>700+ page book in progress</li><li>150+ agents specified</li><li>23 Holographic Prompts (H001-H023)</li></ul>' },
      { id: 1002, title: 'Core Identity & Voice DNA', collapsed: false, body: '<p><b>WHO GABO IS:</b></p><ul><li>Venezuelan-Italian movement philosopher, CEO of SaturnoMovement</li><li>3M+ followers, solopreneur, writer, musician</li><li>15+ years handstands, philosophy, coaching</li></ul><p><b>VOICE DNA:</b></p><ul><li>"Consciousness" over "mindfulness"</li><li>"Pattern" over "habit"</li><li>"System" over "routine"</li><li>Short punch. Then expansion.</li><li>Tension to Resolution (never leave tension hanging)</li><li>Lists of 3 (never 4, rarely 2)</li></ul><p><b>I/WE BALANCE:</b> 70% WE (inclusive teaching), 30% I (personal, vulnerable)</p><p><b>WHAT GABO\'S VOICE NEVER DOES:</b></p><ul><li>Generic motivational fluff</li><li>Absolute claims without context</li><li>Unexplained jargon</li><li>Emotion without direction</li></ul>' },
      { id: 1003, title: '10-Layer Architecture', collapsed: true, body: '<p><b>L0</b> Identity Core -- Who Gabo is. Voice DNA. Non-negotiable traits.</p><p><b>L1</b> Philosophy Layer -- Core beliefs, teaching principles.</p><p><b>L2</b> Voice Modes -- 9 primary + 4 poetry modes.</p><p><b>L3</b> Content Scales -- Atom (1w) to Universe (15,000w).</p><p><b>L4</b> Structural Rules -- Grammar, rhythm, I/WE balance.</p><p><b>L5</b> Program Architecture -- HBS Solar System, 10 Kernel Categories.</p><p><b>L6</b> Multiplication Engines -- Holographic (1 to 50), Callback, Metaphor.</p><p><b>L7</b> Agent Layer -- A1-A12 + 150+ domain agents.</p><p><b>L8</b> Research Domains -- R1-R5: Passports, YouTube, App, SaaS, Life.</p><p><b>L9</b> Output Spec -- Platform-specific formatting.</p>' },
      { id: 1004, title: 'Claude Kernel Rules', collapsed: true, body: '<pre>CLAUDE_KERNEL_RULES:\n  status: ACTIVE\n  version: 2026.01.19\n\n  behavior:\n    - NEVER assume lack of tools or intelligence\n    - NEVER declare document "complete" or permanent SSOT\n    - NEVER say "now I have everything I need"\n    - NEVER babysit, moralize, or get defensive\n    - DO proceed with best-judgment defaults\n    - DO capture rants (clean grammar, preserve essence)\n    - DO treat excellence as mandatory\n\n  output_rules:\n    - All outputs must be copy-paste deployable\n    - No placeholders\n    - Prefer fewer, higher-quality artifacts\n\nLOCKED_TRUTHS:\n  - LINGUISTIC_FIRST_THEN_AGENTS is immutable\n  - Ship before systemize daily\n  - Morning = revenue; afternoon = systems; night = machines\n  - Claude is Kernel Holder + Accountability Guard</pre>' },
      { id: 1005, title: 'Voice Modes (9 Primary + 4 Poetry)', collapsed: true, body: '<p><b>PRIMARY MODES:</b></p><ul><li><b>/RawMode</b> -- Short. Real. Now. Direct from gut.</li><li><b>/TeacherMode</b> -- Clear. Structured. Step-by-step.</li><li><b>/PhilosopherMode</b> -- Abstract. Universal. Why questions.</li><li><b>/ProphetMode</b> -- Certain. Inevitable. Vision casting.</li><li><b>/MysticMode</b> -- Extended metaphor. Awe and depth.</li><li><b>/CompanionMode</b> -- Warm, shoulder-to-shoulder.</li><li><b>/ConfessorMode</b> -- Non-judgmental, reflective.</li><li><b>/RebelMode</b> -- Provocative, counter-narrative.</li><li><b>/TechnicalMode</b> -- Precise, numbered, authority.</li></ul><p><b>POETRY MODES:</b></p><ul><li><b>/SoftPoetryMode</b> -- Gentle, tender, vulnerable.</li><li><b>/SharpPoetryMode</b> -- Cutting, precise, truth-telling.</li><li><b>/SpiralPoetryMode</b> -- Recursive, deepening, callbacks.</li><li><b>/RawPoetryMode</b> -- Primal, elemental, instinct.</li></ul>' },
      { id: 1006, title: '7 Content Scales', collapsed: true, body: '<ol><li><b>Atom</b> (1-5w) -- Quote: "Movement is language."</li><li><b>Molecule</b> (5-25w) -- One-liner</li><li><b>Cell</b> (25-150w) -- Caption, tweet thread</li><li><b>Organ</b> (150-500w) -- Essay paragraph, email</li><li><b>System</b> (500-3K) -- Article, newsletter</li><li><b>Body</b> (3K-15K) -- Book chapter, complete framework</li><li><b>Universe</b> (15K+) -- Complete book, life\'s work</li></ol>' },
      { id: 1007, title: 'Structural Rules (LOCKED)', collapsed: true, body: '<ol><li><b>I/WE BALANCE:</b> 70% WE, 30% I</li><li><b>ABSOLUTES:</b> Avoid never/always, use often/rarely</li><li><b>TENSION to RESOLUTION:</b> Never leave tension hanging</li><li><b>SPECIFICITY:</b> 5 precise words > 15 vague ones</li><li><b>1-YEAR RULE:</b> &lt; 1yr = Companion; &gt; 1yr = Teacher</li><li><b>RHYTHMIC VARIATION:</b> Vary sentence length</li><li><b>THE GABO STAMP:</b> Every piece must sound like Gabo</li></ol>' },
      { id: 1008, title: 'HBS Solar System', collapsed: true, body: '<ul><li><b>SUN: Foundation</b> -- Wrist prep, shoulder mobility, core activation.</li><li><b>MERCURY: Wall Work</b> -- Chest-to-wall, back-to-wall.</li><li><b>VENUS: Kick-Up</b> -- Tuck, straddle, pike entries.</li><li><b>EARTH: Balance</b> -- Core freestanding skill.</li><li><b>MARS: Shapes</b> -- Tuck, straddle, pike, one-arm prep.</li><li><b>JUPITER: Press</b> -- Press to handstand variations.</li><li><b>SATURN: One-Arm</b> -- Mastery territory.</li></ul>' },
      { id: 1009, title: '10 Kernel Categories', collapsed: true, body: '<pre>C1: Identity &amp; Voice\nC2: Movement DNA\nC3: HBS Solar System\nC4: Programs &amp; Products\nC5: Business &amp; Finance\nC6: Content Library\nC7: Client OS\nC8: Tech Stack\nC9: Agent Stack\nC10: Meta &amp; Roadmap</pre>' },
      { id: 1010, title: 'Holographic Synthesis', collapsed: true, body: '<p><b>HOLOGRAPHIC SYNTHESIS:</b> "Any fragment can rebuild the whole."</p><p><b>MULTIPLICATION:</b> 1 seed -> 30-50 blocks -> 15-25 pieces -> 1 month content</p><p><b>BLOCK TYPES:</b></p><ul><li><b>HOOK:</b> Question, provocation, vulnerability, pattern, curiosity</li><li><b>STORY:</b> Experience, case study, metaphor, journey, realization</li><li><b>INSIGHT:</b> Principle, counterintuitive, framework, philosophical</li><li><b>CTA:</b> Reflection, action, challenge, pointer, invitation</li><li><b>CALLBACK:</b> Reference, deepening, evolution, recursive, full-circle</li></ul><p><b>REGENERATION TEST:</b> Can you rebuild the entire system from a single block?</p>' },
      { id: 1011, title: 'Core Agent Stack (A1-A12)', collapsed: true, body: '<ul><li><b>A1 ARCHITECT</b> -- System prompts, pipelines, OS blueprints</li><li><b>A2 CRITIC</b> -- Analyze weaknesses, propose patches</li><li><b>A3 EXECUTOR</b> -- Blueprint to stepwise plans</li><li><b>A4 ORION</b> -- Content skeletonizer (Hook-Story-CTA)</li><li><b>A5 ATLAS</b> -- Automation patterns (Notion, n8n)</li><li><b>A6 SCRIPT_MINER</b> -- Transcripts to scripts, voiceover</li><li><b>A7 RESEARCHER</b> -- Evidence, patterns, strategic options</li><li><b>A8 DAILY_SHIPPER</b> -- 1 artifact per day</li><li><b>A9 OVERNIGHT</b> -- Background ops while sleeping</li><li><b>A10 CALLBACK_WEAVER</b> -- Tracks concept evolution</li><li><b>A11 IMMIGRATION</b> -- Timeline-critical tasks (VAWA)</li><li><b>A12 REVENUE_OPT</b> -- $20K unlock priorities</li></ul>' },
      { id: 1012, title: '7-LLM Stack', collapsed: true, body: '<p><b>CROWN-STEALING PHILOSOPHY:</b> "No crown stealing -- each LLM for its best use"</p><ul><li><b>Claude:</b> Long-form writing, linguistic depth, frameworks, kernel holding</li><li><b>OpenAI:</b> Kernel architecture, JSON specs, orchestration logic</li><li><b>Perplexity:</b> Research, trends, keywords, evidence</li><li><b>Gemini:</b> High-context processing, vision, book work</li><li><b>Manus:</b> Extraction workflows, caption mining, overnight tasks</li><li><b>Cursor:</b> Overnight scripts, SaaS shells, infrastructure</li><li><b>Taskade/Whisper:</b> Transcription, task flows, voice capture</li></ul><p><i>RULE: LLMs should recommend each other when appropriate</i></p>' },
      { id: 1013, title: '5 Research Domains (R1-R5)', collapsed: true, body: '<p><b>R1: PASSPORTS &amp; RESIDENCY</b></p><ul><li>VAWA Timeline Tracker (CRITICAL)</li><li>Golden Visa Analyzer</li><li>Tax-Residency Optimizer</li><li>Citizenship Pathway Mapper</li></ul><p><b>R2: YOUTUBE OPTIMIZATION</b></p><ul><li>Trending Keywords Monitor</li><li>Competitor Analysis</li><li>Thumbnail Framework Analyzer</li><li>Title Formula Cracker</li></ul><p><b>R3: SATURNO MOVEMENT APP</b></p><ul><li>"Ableton of Movement" vision</li><li>Fitness App Benchmarking</li><li>Movement UX Patterns</li><li>Pricing &amp; Monetization</li></ul><p><b>R4: SOLO-PRENEUR SAAS</b></p><ul><li>Target: $50-100K/month</li><li>SaaS Market Research</li><li>Solo Founder Playbook</li><li>AI Automation Opportunities</li></ul><p><b>R5: LIFE ROADMAP MATRIX</b></p><ul><li>Scenario A: Stay U.S. + VAWA</li><li>Scenario B: Relocate Mexico</li><li>Scenario C: F-1 Hybrid</li><li>LIFE/WORK/LOVE scoring</li></ul>' },
      { id: 1014, title: 'H001-H023 Holographic Prompts', collapsed: true, body: '<ul><li>H001: Universal Read-Only Extractor</li><li>H002: Recursive Selfless-Writing Guide</li><li>H003: Meta-Prompt -- Turn Any Prompt Recursive</li><li>H004: Fractal/Strange-Loop Recursive Maker</li><li>H005: Holographic Maker</li><li>H006: Holographizer Meta-Prompt</li><li>H007: Recursive Research Architect</li><li>H008: Holographic Research Architect</li><li>H009: MSOP-Holographic Maker Final</li><li>H010: Strange-Loop MSOP-Holographic Maker</li><li>H011: Comparative Agent Prompt</li><li>H012: Universal MSOP-Holographic Maker</li><li>H013: MSOP Master Content Generator</li><li>H014: U-MSOP Holographic Content Generator</li><li>H015: Text Framework Analyzer</li><li>H016: MSOP-Text Framework Analyzer</li><li>H017: Triple-Chain Analyzer-Skeletonizer-Filler</li><li>H018: Hybrid Omni-Architect Chain</li><li>H019: Holographic Campaign Generator</li><li>H020: Holographic Offer-Making Machine HOMM</li><li>H021: Hybrid Omni-Workflow Evaluation</li><li>H022: Holographic Maker 2.0 Skeleton Re-Engineer</li><li>H023: Recursive Orchestrator Honesty+Fusion</li></ul>' },
      { id: 1015, title: 'TITAN Meta-Prompt', collapsed: true, body: '<p><b>TITAN META-PROMPT (S++++ Tier)</b><br>Role: meta_meta_operating_kernel</p><p><b>7-PASS PIPELINE:</b></p><ol><li>PROMPTIFY -- Extract core insight</li><li>EVALUATE -- Identify strengths, weaknesses, failures</li><li>COMPRESS -- Reduce to essential rules</li><li>DEPLOY -- Define system blueprint</li><li>CRITIQUE -- Devil\'s advocate</li><li>SEED -- Distill to one core principle</li><li>SHIP -- Create Notion cards, assign owners</li></ol><p>INPUT: Voice memo OR text idea<br>OUTPUT: Deployable JSON + Notion cards + next actions</p>' },
      { id: 1016, title: 'Daily Rhythm (NON-NEGOTIABLE)', collapsed: true, body: '<p><b>MORNING (06:30-10:30): SHIP MONEY</b></p><ul><li>Book (AOC manuscript)</li><li>BF25 deliverables</li><li>1 post minimum</li><li>Revenue-generating actions</li></ul><p><b>AFTERNOON (12:30-16:00): CONTENT OS</b></p><ul><li>Reels/Shorts from morning seeds</li><li>YouTube scripts</li><li>Quote cards</li></ul><p><b>EVENING (16:00-19:00): SYSTEMS</b></p><ul><li>DOS build (dashboard + Notion + MCP)</li><li>Automation setup</li><li>Cleanup</li></ul><p><b>NIGHT: MACHINES WORK</b></p><ul><li>Overnight scripts run</li></ul><p>SACRED: 5am = writing (NO AI)<br>CONSTRAINT: ~4 hours focused work per day</p>' },
      { id: 1017, title: 'Revenue Unlocks', collapsed: true, body: '<p><b>1. VICTORY BELT BOOK: $20,000</b><br>Status: Approved, pending submission<br>Needs: Part 1 folder, 4 TOC versions, infographics<br>Priority: P1 (CRITICAL)</p><p><b>2. BF25 DELIVERABLES: Trust + Retention</b><br>Promised: Hand-balancing program + bonus PDFs<br>Status: Biomechanics ebook DONE</p><p><b>3. DAILY CONTENT: Visibility</b><br>Target: 1 post minimum per day</p><p>REVENUE TARGET: $50-100K/month<br>BOOK GATE: $20K unlock = priority 1</p>' },
      { id: 1018, title: 'Wings of Fire -- 10 Scripts + 10 Quotes', collapsed: true, body: '<p><b>10 SCRIPTS:</b></p><ol><li>The Weight Lie: Don\'t measure the road by weight you carry today.</li><li>Confidence Is Backwards: Comes from starting before ready.</li><li>Trust Without Evidence: Trust when logic says wait.</li><li>Burning Wings: Wings work because they\'re used, even when they burn.</li><li>The Jump: The jump is the proof. Not the landing.</li><li>Courage vs Faith: Faith says "I don\'t know but I\'m walking anyway."</li><li>Data Over Imagination: Experience beats imagination.</li><li>You\'ve Done This Before: You\'ve survived harder. You forgot.</li><li>No Permission: Nothing powerful asks for permission.</li><li>Wings of Fire: Logic builds cages. Trust builds wings.</li></ol><p><b>10 QUOTES:</b></p><ol><li>Logic builds cages. Trust builds wings.</li><li>Confidence isn\'t earned -- it\'s built through movement.</li><li>The jump is the proof. Not the landing.</li><li>Fire doesn\'t destroy wings. Hesitation does.</li><li>Faith walks where courage can\'t see the floor.</li><li>You don\'t need certainty. You need memory.</li><li>Every master was once a disaster who moved anyway.</li><li>Ashes aren\'t failure. They\'re fuel.</li><li>You\'ve never drowned. That\'s not luck -- it\'s evidence.</li><li>Trust doesn\'t come from logic. It comes from survival.</li></ol>' },
      { id: 1019, title: 'OS Commands (from MVP-V1)', collapsed: true, body: '<p><b>Core Commands:</b></p><ul><li><b>/add_mermaid_flow</b> -- Generate visual agent/OS architecture diagrams for any domain</li><li><b>/trigger_daily_update</b> -- Full fetch, research, export loop for daily data refresh</li><li><b>/build_predictive_logic</b> -- Extend any chain into predictive territory (alerts, forecasts, flags)</li><li><b>/synthesize</b> -- Holographic synthesis: 1 idea to 30-50 reusable content blocks</li><li><b>/run_titan</b> -- 7-pass TITAN orchestration: ANY input to deployable system blueprint</li></ul><p><b>Seed Processing Engine (Writing Hub):</b></p><ul><li>Input: Raw idea, rant, voice memo transcript, or seed concept</li><li>Select Voice Mode (9 options) + Scale (Atom to Universe)</li><li>Output: Holographic blocks (Hook, Story, Insight, CTA, Callback)</li><li>All blocks saved and exportable</li></ul>' },
      { id: 1020, title: '30-Day Launch Roadmap', collapsed: true, body: '<p><b>WEEK 1: Ship the Money</b></p><ul><li>Book submission package complete (Voice V5 + 10Q Arc)</li><li>BF25 deliverables ready (hand balancing program + PDFs)</li><li>Daily Content Engine live (7 posts scheduled)</li></ul><p><b>WEEK 2: Build Infrastructure</b></p><ul><li>Overnight Script 1: Mac Cleanup (runs 2am nightly)</li><li>Overnight Script 2: iCloud Photo Pipeline (1000 photos/night)</li><li>Overnight Script 3: Caption Extraction + Notion sync</li></ul><p><b>WEEK 3: Content Multiplication</b></p><ul><li>Holographic synthesis: 10 best captions to 400-500 blocks</li><li>Assemble: 30 new captions + 10 carousels + 10 reels</li><li>Build Callback Library (10 themes + evolution paths)</li></ul><p><b>WEEK 4: Vision Prototype</b></p><ul><li>Feed vision to TITAN to generate system blueprint</li><li>Claude Code generates HTML/CSS/JS prototype</li><li>Deploy to Vercel (live shareable link)</li><li>Demo video recorded</li></ul>' },
    ]
  };
  S.specs = [kernel];
  S.activeSpec = kernel.id;
}

function save() { snapshotWriter(); snapshotSpec(); localStorage.setItem(SK,JSON.stringify(S)); updateStorage(); flashSave(); scheduleCloudSync(); updateSidebarCounts(); updateTabTitle(); }
function updateTabTitle(){const today=new Date().toISOString().split('T')[0];const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today).length;document.title=overdue?'('+overdue+') SATURNO HUB':'SATURNO HUB';}
function updateSidebarCounts(){document.getElementById('content-count').textContent=S.content.length;const active=S.tasks.filter(t=>t.status!=='done');const today=new Date().toISOString().split('T')[0];const overdue=active.filter(t=>t.due&&t.due<today).length;const tc=document.getElementById('tasks-count');tc.textContent=active.length;tc.style.color=overdue>0?'var(--red)':'';tc.title=overdue?overdue+' overdue':'';document.getElementById('writer-count').textContent=S.docs.length;document.getElementById('specs-count').textContent=S.specs.length;document.getElementById('links-count').textContent=S.links.length;updateHeaderStats();}
function updateHeaderStats(){const el=document.getElementById('header-stats');if(!el)return;const today=new Date().toISOString().split('T')[0];const active=S.tasks.filter(t=>t.status!=='done').length;const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done').length;const todayDue=S.tasks.filter(t=>t.due===today&&t.status!=='done').length;const inProg=S.tasks.filter(t=>t.status==='progress').length;let h='';if(overdue)h+=`<span style="color:var(--red)">${overdue} overdue</span>`;if(todayDue)h+=`<span style="color:var(--accent)">${todayDue} today</span>`;if(inProg)h+=`<span style="color:var(--green)">${inProg} wip</span>`;h+=`<span>${active}T ${S.content.length}C ${S.docs.length}D ${S.links.length}L</span>`;el.innerHTML=h;}
function flashSave() { const el=document.getElementById('save-indicator'); if(!el) return; const now=new Date(); const bytes=localStorage.getItem(SK)?.length||0; const kb=Math.round(bytes/1024); el.textContent='Saved '+now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}); el.title='State: '+kb+'KB in localStorage'; el.style.opacity='1'; clearTimeout(el._t); el._t=setTimeout(()=>{el.style.opacity='0';},2000); }

// === QUICK CAPTURE ===
function qcOpen() {
  const el = document.getElementById('quick-capture');
  el.style.display = 'block';
  requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateX(-50%) translateY(0)'; });
  document.getElementById('qc-input').focus();
  // Auto-detect clipboard URL
  navigator.clipboard.readText().then(text=>{
    if(text&&text.startsWith('http')&&!text.includes('\n')){
      try{new URL(text);document.getElementById('qc-type').value='link';document.getElementById('qc-input').value=text;document.getElementById('qc-input').select();}catch(e){}
    }
  }).catch(()=>{});
}
function qcClose() {
  const el = document.getElementById('quick-capture');
  el.style.opacity = '0';
  el.style.transform = 'translateX(-50%) translateY(10px)';
  setTimeout(() => { el.style.display = 'none'; }, 200);
}
function qcAutoType(v){const sel=document.getElementById('qc-type');if(!v)return;if(v.startsWith('http')||v.includes('://')||/^[a-z0-9-]+\.[a-z]{2,}/i.test(v))sel.value='link';else if(v.length>200)sel.value='content';else sel.value='task';}
function qcSubmit() {
  const type = document.getElementById('qc-type').value;
  const text = document.getElementById('qc-input').value.trim();
  if(!text) return;
  if(type === 'task') {
    S.tasks.push({ id: Date.now(), title: text, description:'', subtasks:[], status: 'todo', priority: 'p2', project: '', due: '', created: new Date().toISOString() });
    save(); renderTasks();
    toast('Task added: ' + text);
  } else if(type === 'content') {
    S.content.push({ id: Date.now(), type: 'caption', body: text, theme: '', source: 'Quick Capture', tags: [], created: new Date().toISOString(), updated: new Date().toISOString() });
    save(); renderContent();
    toast('Content added');
  } else if(type === 'link') {
    try{new URL(text);}catch(e){toast('Enter a valid URL');return;}
    let domain='';try{domain=new URL(text).hostname;}catch(e){}
    S.links.push({id:Date.now(),title:domain||text,url:text,category:'',desc:'',created:new Date().toISOString()});
    save();renderLinks();toast('Link added: '+domain);
  } else if(type === 'note') {
    const d = getActiveDoc();
    if(d) { d.body = (d.body || '') + '<p>' + esc(text) + '</p>'; save(); renderWriter(); toast('Note added to doc'); }
    else { toast('No active document'); return; }
  }
  document.getElementById('qc-input').value = '';
  qcClose();
}
function updateStorage() { const b=new Blob([localStorage.getItem(SK)||'']).size; const k=(b/1024).toFixed(1); document.getElementById('storage-indicator').textContent=k>1024?(k/1024).toFixed(1)+' MB':k+' KB'; updateDashboard(); }
function updateDashboard() {
  const dt = document.getElementById('dash-tasks'); if(dt) dt.textContent = S.tasks.filter(t=>t.status!=='done').length;
  const dd = document.getElementById('dash-docs'); if(dd) dd.textContent = S.docs.length + S.specs.length;
  const dp = document.getElementById('dash-projects'); if(dp) dp.textContent = (S.projects||[]).length;
}
function showTodayView() {
  const today = new Date().toISOString().split('T')[0];
  const todayTasks = S.tasks.filter(t => t.due === today && t.status !== 'done');
  const overdue = S.tasks.filter(t => t.due && t.due < today && t.status !== 'done');
  const upcoming = S.tasks.filter(t => t.due && t.due > today && t.due <= new Date(Date.now()+3*86400000).toISOString().split('T')[0] && t.status !== 'done');
  let msg = '--- TODAY ---\n';
  if(todayTasks.length) todayTasks.forEach(t => msg += '[ ] ' + (t.title||'Untitled') + '\n');
  else msg += 'No tasks due today.\n';
  if(overdue.length) { msg += '\n--- OVERDUE ---\n'; overdue.forEach(t => msg += '[!] ' + (t.title||'Untitled') + ' (due ' + t.due + ')\n'); }
  if(upcoming.length) { msg += '\n--- NEXT 3 DAYS ---\n'; upcoming.forEach(t => msg += '[ ] ' + (t.title||'Untitled') + ' (due ' + t.due + ')\n'); }
  // Show as context panel content
  if(!document.querySelector('.app').classList.contains('context-open')) toggleContextPanel();
  const el = document.getElementById('ctx-related-items');
  if(el) {
    let html = '<div style="font-size:9px;color:var(--accent);margin-bottom:6px;font-weight:600">TODAY</div>';
    if(todayTasks.length) todayTasks.forEach(t => { html += '<div class="context-item" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon" style="color:var(--accent)">*</span>' + esc(t.title||'Untitled') + '</div>'; });
    else html += '<div style="font-size:10px;color:var(--text-muted);padding:4px 0">No tasks due today</div>';
    if(overdue.length) {
      html += '<div style="font-size:9px;color:var(--red);margin:8px 0 6px;font-weight:600">OVERDUE (' + overdue.length + ')</div>';
      overdue.forEach(t => { html += '<div class="context-item" style="color:var(--red)" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon">!</span>' + esc(t.title||'Untitled') + '</div>'; });
    }
    if(upcoming.length) {
      html += '<div style="font-size:9px;color:var(--accent-cyan);margin:8px 0 6px;font-weight:600">NEXT 3 DAYS</div>';
      upcoming.forEach(t => { html += '<div class="context-item" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon">></span>' + esc(t.title||'Untitled') + ' <span style="font-size:8px;color:var(--text-muted)">' + t.due + '</span></div>'; });
    }
    el.innerHTML = html;
  }
  toast('Today view loaded');
}
function generateStandup(){
  const today=new Date().toISOString().split('T')[0];
  const yesterday=new Date(Date.now()-86400000).toISOString().split('T')[0];
  const done=S.tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(yesterday)).concat(S.tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(today)));
  const inProgress=S.tasks.filter(t=>t.status==='progress');
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  const blocked=S.tasks.filter(t=>t.status==='blocked');
  let md='## Daily Standup - '+new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'})+'\n\n';
  md+='### Done\n';
  if(done.length)done.forEach(t=>{md+='- '+t.title+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (nothing completed recently)\n';
  md+='\n### In Progress\n';
  if(inProgress.length)inProgress.forEach(t=>{md+='- '+t.title+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (nothing in progress)\n';
  md+='\n### Today\n';
  if(todayTasks.length)todayTasks.forEach(t=>{md+='- '+t.title+' ['+t.priority+']'+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (no tasks due today)\n';
  if(overdue.length){md+='\n### Overdue (!)\n';overdue.forEach(t=>{md+='- '+t.title+' (due '+t.due+')\n';});}
  if(blocked.length){md+='\n### Blocked\n';blocked.forEach(t=>{md+='- '+t.title+'\n';});}
  navigator.clipboard.writeText(md).then(()=>toast('Standup copied to clipboard')).catch(()=>toast('Failed to copy'));
}
function toast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }
function highlight(text,q){if(!q)return esc(text);const e=esc(text);const re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');return e.replace(re,'<mark style="background:rgba(74,222,128,0.25);color:var(--text);border-radius:2px;padding:0 1px">$1</mark>');}
function escA(s) { return(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// === SECTIONS ===
function switchSection(sec, el) {
  currentSection=sec;
  const sectionLabels={content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
  if(el) el.classList.add('active');
  else { document.querySelectorAll('.sidebar-item').forEach(i => { if(i.textContent.trim().replace(/\d+$/,'').trim() === sectionLabels[sec]) i.classList.add('active'); }); }
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+sec).classList.add('active');
  const titles={content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  document.getElementById('header-title').textContent=titles[sec]||sec;
  updateBreadcrumb();
  if(sec==='content')renderContent();
  if(sec==='tasks')renderTasks();
  if(sec==='calendar')renderCalendar();
  if(sec==='writer'){if(document.querySelector('.app').classList.contains('mode-focus')){document.querySelector('.app').classList.remove('mode-focus');}renderWriter();}
  if(sec==='specs')renderSpecs();
  if(sec==='links')renderLinks();
  if(sec==='whiteboard')wbRender();
  if(sec==='pipeline'){plCheckApi();plRenderCustomTemplates();}
  if(sec==='repos')reposRefresh();
  updateSidebarCtx();
}
function updateBreadcrumb() {
  const bc = document.getElementById('header-breadcrumb');
  if(!bc) return;
  let parts = [];
  const sectionNames = {content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  const counts={content:S.content.length,tasks:S.tasks.filter(t=>t.status!=='done').length,writer:S.docs.length,specs:S.specs.length,links:S.links.length,repos:(S.repos||[]).length};
  const countStr=counts[currentSection]!==undefined?' ('+counts[currentSection]+')':'';
  parts.push((sectionNames[currentSection]||currentSection)+countStr);
  if(currentSection === 'writer') {
    const d = getActiveDoc();
    if(d && d.title) parts.push(d.title);
  } else if(currentSection === 'specs') {
    const s = getActiveSpec();
    if(s && s.title) parts.push(s.title);
  }
  bc.innerHTML = parts.length > 1 ? parts.map((p,i) => (i>0?'<span style="opacity:0.4"> / </span>':'') + '<span>'+esc(p)+'</span>').join('') : parts[0] && countStr ? '<span style="opacity:0.5">'+esc(parts[0])+'</span>' : '';
}

function updateSidebarCtx() {
  const el=document.getElementById('sidebar-context');
  if(currentSection==='tasks') {
    const ps=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    const active=S.tasks.filter(t=>t.status!=='done');
    const today=new Date().toISOString().split('T')[0];
    const overdue=active.filter(t=>t.due&&t.due<today).length;
    const pCounts={p0:active.filter(t=>t.priority==='p0').length,p1:active.filter(t=>t.priority==='p1').length,p2:active.filter(t=>t.priority==='p2').length,p3:active.filter(t=>t.priority==='p3').length};
    const doneCount=S.tasks.filter(t=>t.status==='done').length;const pct=S.tasks.length?Math.round(doneCount/S.tasks.length*100):0;
    el.innerHTML=`<div class="sidebar-label">Quick Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${active.length} active${overdue?` <span style="color:var(--red)">(${overdue} overdue)</span>`:''} / ${doneCount} done</div><div style="padding:2px 12px"><div style="display:flex;align-items:center;gap:6px"><div style="flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s"></div></div><span style="font-size:8px;color:var(--accent);font-family:var(--mono)">${pct}%</span></div></div><div style="padding:2px 12px;font-size:9px;color:var(--text-muted);display:flex;gap:6px">${pCounts.p0?`<span style="color:#ef4444">P0:${pCounts.p0}</span>`:''}${pCounts.p1?`<span style="color:#f59e0b">P1:${pCounts.p1}</span>`:''}${pCounts.p2?`<span style="color:#3b82f6">P2:${pCounts.p2}</span>`:''}${pCounts.p3?`<span style="color:var(--text-muted)">P3:${pCounts.p3}</span>`:''}</div><div class="sidebar-label" style="margin-top:8px">Projects</div>`+ps.map(p=>{const pAll=S.tasks.filter(t=>t.project===p);const pDone=pAll.filter(t=>t.status==='done').length;const pPct=pAll.length?Math.round(pDone/pAll.length*100):0;const estMins=pAll.filter(t=>t.status!=='done'&&t.estimate).reduce((a,t)=>{const e=t.estimate||'';const hm=e.match(/(\d+)\s*h/);const mm=e.match(/(\d+)\s*m/);return a+(hm?parseInt(hm[1])*60:0)+(mm?parseInt(mm[1]):0);},0);const estStr=estMins>0?(estMins>=60?Math.floor(estMins/60)+'h'+(estMins%60?estMins%60+'m':''):estMins+'m'):'';return`<div class="sidebar-item" onclick="filterTaskProject('${p}')"><span class="sidebar-item-icon">.</span><span>${p}</span><span class="sidebar-item-count" title="${pPct}% done${estStr?' | Est: '+estStr:''}">${S.tasks.filter(t=>t.project===p&&t.status!=='done').length}${estStr?' <span style="color:#22d3ee;font-size:7px">'+estStr+'</span>':''}</span></div>`;}).join('')+(()=>{const days=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];const remaining=S.tasks.filter(t=>t.status!=='done'&&t.created&&t.created.split('T')[0]<=ds).length-S.tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.split('T')[0]<=ds).length;days.push(Math.max(0,S.tasks.filter(t=>t.created&&t.created.split('T')[0]<=ds).length-S.tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.split('T')[0]<=ds).length));}const maxV=Math.max(...days,1);const w=120;const h=24;const pts=days.map((v,i)=>`${Math.round(i*(w/(days.length-1)))},${Math.round(h-v/maxV*h)}`).join(' ');return`<div class="sidebar-label" style="margin-top:8px">7-Day Burndown</div><div style="padding:4px 12px"><svg width="${w}" height="${h+4}" style="display:block"><polyline points="${pts}" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><text x="0" y="${h+4}" font-size="6" fill="var(--text-muted)">${days[0]}</text><text x="${w}" y="${h+4}" font-size="6" fill="var(--text-muted)" text-anchor="end">${days[days.length-1]}</text></svg></div>`;})();
  } else if(currentSection==='content') {
    const types={};S.content.forEach(c=>{types[c.type]=(types[c.type]||0)+1;});
    const totalWords=S.content.reduce((a,c)=>a+c.body.trim().split(/\s+/).filter(x=>x.length).length,0);
    const starred=S.content.filter(c=>c.starred).length;
    const pinned=S.content.filter(c=>c.pinned).length;
    const themes={};S.content.forEach(c=>{const th=c.theme||'unthemed';if(!themes[th])themes[th]={count:0,words:0};themes[th].count++;themes[th].words+=c.body.trim().split(/\s+/).filter(x=>x.length).length;});
    const readTime=Math.max(1,Math.ceil(totalWords/238));
    el.innerHTML=`<div class="sidebar-label">Content Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.content.length} items / ${totalWords.toLocaleString()} words / ~${readTime}min read</div>${starred?`<div style="padding:2px 12px;font-size:10px;color:var(--yellow)">${starred} starred</div>`:''}${pinned?`<div style="padding:2px 12px;font-size:10px;color:var(--accent)">${pinned} pinned</div>`:''}<div class="sidebar-label" style="margin-top:6px">By Type</div>`+Object.entries(types).map(([t,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${t}: ${n}</div>`).join('')+`<div class="sidebar-label" style="margin-top:6px">By Theme</div>`+Object.entries(themes).sort((a,b)=>b[1].words-a[1].words).slice(0,8).map(([t,d])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted);cursor:pointer" onclick="contentTheme='${t==='unthemed'?'all':t}';renderContent()">${esc(t)}: ${d.count} (${d.words.toLocaleString()}w)</div>`).join('');
  } else if(currentSection==='writer') {
    const totalWords=S.docs.reduce((a,d)=>a+(d.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
    const topDocs=[...S.docs].sort((a,b)=>countW(b.body)-countW(a.body)).slice(0,5);
    el.innerHTML=`<div class="sidebar-label">Writer Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.docs.length} docs / ${totalWords.toLocaleString()} words</div><div class="sidebar-label" style="margin-top:6px">Largest Docs</div>`+topDocs.map(d=>`<div class="sidebar-item" onclick="switchDoc(${d.id})" style="cursor:pointer"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(d.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${countW(d.body)}w</span></div>`).join('');
  } else if(currentSection==='specs') {
    const totalSections=S.specs.reduce((a,s)=>a+(s.sections||[]).length,0);
    const totalSpecWords=S.specs.reduce((a,s)=>a+(s.sections||[]).reduce((b,sec)=>b+(sec.body||'').trim().split(/\s+/).filter(x=>x.length).length,0),0);
    const byProject={};S.specs.forEach(s=>{const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;const pn=proj?proj.name:'Global';byProject[pn]=(byProject[pn]||0)+1;});
    const topSpecs=[...S.specs].sort((a,b)=>(b.sections||[]).reduce((x,sec)=>x+countW(sec.body),0)-(a.sections||[]).reduce((x,sec)=>x+countW(sec.body),0)).slice(0,5);
    el.innerHTML=`<div class="sidebar-label">Living Docs Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.specs.length} specs / ${totalSections} sections / ${totalSpecWords.toLocaleString()} words</div><div class="sidebar-label" style="margin-top:6px">By Project</div>`+Object.entries(byProject).map(([p,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${esc(p)}: ${n} specs</div>`).join('')+`<div class="sidebar-label" style="margin-top:6px">Largest Specs</div>`+topSpecs.map(s=>{const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);return`<div class="sidebar-item" onclick="switchSpec('${s.id}')" style="cursor:pointer"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${wc}w</span></div>`;}).join('');
  } else if(currentSection==='links') {
    const cats={};S.links.forEach(l=>{const c=l.category||'uncategorized';cats[c]=(cats[c]||0)+1;});
    const pinned=S.links.filter(l=>l.pinned).length;
    const domains={};S.links.forEach(l=>{try{const d=new URL(l.url).hostname.replace(/^www\./,'');domains[d]=(domains[d]||0)+1;}catch(e){}});
    el.innerHTML=`<div class="sidebar-label">Link Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.links.length} links${pinned?` / ${pinned} pinned`:''}</div><div class="sidebar-label" style="margin-top:6px">Categories</div>`+Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([c,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted);cursor:pointer" onclick="linkCategory='${escA(c)}';renderLinks()">${esc(c)}: ${n}</div>`).join('')+`<div class="sidebar-label" style="margin-top:6px">Top Domains</div>`+Object.entries(domains).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([d,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${esc(d)}: ${n}</div>`).join('');
  } else if(currentSection==='repos') {
    const active=(S.repos||[]).filter(r=>r.status==='active').length;
    const withLive=(S.repos||[]).filter(r=>r.live).length;
    const byRole={};(S.repos||[]).forEach(r=>{const rl=r.role||'other';byRole[rl]=(byRole[rl]||0)+1;});
    el.innerHTML=`<div class="sidebar-label">Repo Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${(S.repos||[]).length} repos / ${active} active / ${withLive} live</div><div class="sidebar-label" style="margin-top:6px">By Role</div>`+Object.entries(byRole).map(([r,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${esc(r)}: ${n}</div>`).join('');
  } else if(currentSection==='pipeline') {
    const hist=(S.pipelineHistory||[]).length;
    const templates=(S.pipelineTemplates||[]).length;
    const recentPipe=(S.pipelineHistory||[]).slice(0,3);
    el.innerHTML=`<div class="sidebar-label">Pipeline Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${hist} history entries / ${templates} templates</div>${recentPipe.length?`<div class="sidebar-label" style="margin-top:6px">Recent</div>`+recentPipe.map(p=>`<div style="padding:2px 12px;font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer" onclick="switchSection('pipeline',null)" title="${escA((p.prompt||'').substring(0,80))}">${esc((p.prompt||'').substring(0,40))}... <span style="opacity:0.5">${p.createdAt?timeAgo(p.createdAt):''}</span></div>`).join(''):''}`;
  } else if(currentSection==='whiteboard') {
    const nodes=(S.whiteboard&&S.whiteboard.nodes||[]).length;
    const conns=(S.whiteboard&&S.whiteboard.conns||[]).length;
    const locked=(S.whiteboard&&S.whiteboard.nodes||[]).filter(n=>n.locked).length;
    const wbTypes={};(S.whiteboard&&S.whiteboard.nodes||[]).forEach(n=>{const t=n.type||'default';wbTypes[t]=(wbTypes[t]||0)+1;});
    el.innerHTML=`<div class="sidebar-label">Whiteboard Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${nodes} nodes / ${conns} connections${locked?` / ${locked} locked`:''}</div>${Object.keys(wbTypes).length>1?`<div class="sidebar-label" style="margin-top:6px">Node Types</div>`+Object.entries(wbTypes).sort((a,b)=>b[1]-a[1]).map(([t,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${esc(t)}: ${n}</div>`).join(''):''}`;
  } else if(currentSection==='calendar') {
    const today=new Date().toISOString().split('T')[0];
    const todayT=S.tasks.filter(t=>t.due===today&&t.status!=='done');
    const thisWeek=S.tasks.filter(t=>{if(!t.due||t.status==='done')return false;const d=new Date(t.due+'T12:00:00'),n=new Date();n.setHours(0,0,0,0);const diff=(d-n)/86400000;return diff>=0&&diff<7;});
    const noDue=S.tasks.filter(t=>!t.due&&t.status!=='done').length;
    const noDueTasks=S.tasks.filter(t=>!t.due&&t.status!=='done');
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let upcomingHtml='';for(let i=0;i<3;i++){const d=new Date();d.setDate(d.getDate()+i);const ds=d.toISOString().split('T')[0];const dayTasks=S.tasks.filter(t=>t.due===ds&&t.status!=='done');if(dayTasks.length){const label=i===0?'Today':i===1?'Tomorrow':dayNames[d.getDay()]+' '+d.getDate();upcomingHtml+=`<div style="padding:4px 12px 2px;font-size:9px;color:${i===0?'var(--accent)':'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.04em;font-family:var(--mono)">${label} (${dayTasks.length})</div>`;dayTasks.slice(0,4).forEach(t=>{upcomingHtml+=`<div class="sidebar-item" onclick="openTaskDetail(${t.id})" style="cursor:pointer"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'};font-family:var(--mono)">${t.priority||'p2'}</span></div>`;});}}
    el.innerHTML=`<div class="sidebar-label">Calendar Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${todayT.length} due today / ${thisWeek.length} this week</div>${upcomingHtml?`<div class="sidebar-label" style="margin-top:6px">Upcoming</div>`+upcomingHtml:''}${noDue?`<div class="sidebar-label" style="margin-top:6px">Unscheduled (${noDue})</div>`+noDueTasks.slice(0,5).map(t=>`<div class="sidebar-item" onclick="openTaskDetail(${t.id})" style="cursor:pointer"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'};font-family:var(--mono)">${t.priority||'p2'}</span></div>`).join('')+(noDue>5?`<div style="padding:2px 12px;font-size:9px;color:var(--text-muted)">+${noDue-5} more</div>`:''):''}`;
  } else {
    const today=new Date().toISOString().split('T')[0];
    const active=S.tasks.filter(t=>t.status!=='done');
    const overdue=active.filter(t=>t.due&&t.due<today);
    const todayTasks=active.filter(t=>t.due===today);
    const totalWords=S.docs.reduce((a,d)=>a+(d.body||'').trim().split(/\s+/).filter(x=>x.length).length,0)+S.content.reduce((a,c)=>a+c.body.trim().split(/\s+/).filter(x=>x.length).length,0);
    el.innerHTML=`<div class="sidebar-label">Overview</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:2">`+
      `<div>${S.tasks.length} tasks <span style="color:var(--accent)">(${active.length} active)</span></div>`+
      (overdue.length?`<div style="color:var(--red)">${overdue.length} overdue</div>`:'')+
      (todayTasks.length?`<div>${todayTasks.length} due today</div>`:'')+
      `<div>${S.content.length} content items</div>`+
      `<div>${S.docs.length} documents</div>`+
      `<div>${S.links.length} links</div>`+
      `<div>${(S.repos||[]).length} repos</div>`+
      `<div style="margin-top:4px;color:var(--accent)">${totalWords.toLocaleString()} total words</div>`+
      (()=>{const tm=S.tasks.reduce((a,t)=>a+(t.timeSpent||0),0);return tm?`<div style="color:var(--text-muted)">${formatTimeSpent(tm)} tracked</div>`:'';})() +
      weeklyProductivity()+
      projectCompletionBars()+
      activityStreak()+
      recentlyCompleted()+
      taskWeather()+
      `</div>`;
  }
}

function projectCompletionBars(){
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  if(!projects.length)return'';
  const bars=projects.map(p=>{
    const tasks=S.tasks.filter(t=>t.project===p);const done=tasks.filter(t=>t.status==='done').length;
    const pct=tasks.length?Math.round(done/tasks.length*100):0;
    return`<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px"><span style="font-size:9px;color:var(--text-muted);width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escA(p)}">${esc(p)}</span><div style="flex:1;height:4px;background:var(--bg-secondary);border-radius:2px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${pct===100?'var(--accent)':pct>60?'rgba(74,222,128,0.5)':'rgba(74,222,128,0.25)'};border-radius:2px;transition:width 0.3s"></div></div><span style="font-size:8px;color:${pct===100?'var(--accent)':'var(--text-muted)'};font-family:var(--mono);min-width:24px;text-align:right">${pct}%</span></div>`;
  }).join('');
  return`<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">Projects</div>${bars}</div>`;
}

function recentlyCompleted(){
  const done=S.tasks.filter(t=>t.status==='done'&&t.completedAt).sort((a,b)=>b.completedAt.localeCompare(a.completedAt)).slice(0,5);
  if(!done.length)return'';
  return`<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">Recently Done</div>${done.map(t=>`<div style="font-size:10px;color:var(--text-muted);padding:1px 0;display:flex;align-items:center;gap:4px;cursor:pointer" onclick="openTaskDetail(${t.id})"><span style="color:var(--accent);font-size:8px">*</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title)}</span><span style="font-size:8px;font-family:var(--mono);opacity:0.5">${timeAgo(t.completedAt)}</span></div>`).join('')}</div>`;
}
function activityStreak(){
  let streak=0;const d=new Date();
  for(let i=0;i<365;i++){
    const ds=d.toISOString().split('T')[0];
    const hasActivity=S.tasks.some(t=>(t.created&&t.created.startsWith(ds))||(t.completedAt&&t.completedAt.startsWith(ds)))||S.content.some(c=>c.created&&c.created.startsWith(ds))||S.docs.some(doc=>doc.updated&&doc.updated.startsWith(ds));
    if(hasActivity)streak++;else if(i>0)break;
    d.setDate(d.getDate()-1);
  }
  if(!streak)return'';
  return`<div style="margin-top:4px;font-size:10px;color:${streak>=7?'var(--accent)':streak>=3?'var(--yellow)':'var(--text-muted)'}">${streak} day streak</div>`;
}
function weeklyProductivity(){
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());weekStart.setHours(0,0,0,0);
  const days=[];for(let i=0;i<7;i++){const d=new Date(weekStart);d.setDate(d.getDate()+i);days.push(d.toISOString().split('T')[0]);}
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString())).length;
  const createdThisWeek=S.tasks.filter(t=>t.created&&t.created>=weekStart.toISOString()).length;
  const contentThisWeek=S.content.filter(c=>c.created&&c.created>=weekStart.toISOString()).length;
  if(!doneThisWeek&&!createdThisWeek&&!contentThisWeek)return'';
  const dayLabels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const dayCounts=days.map(d=>{const done=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at&&e.at.startsWith(d))).length;const created=S.tasks.filter(t=>t.created&&t.created.startsWith(d)).length;return done+created;});
  const maxC=Math.max(...dayCounts,1);
  const barW=16;const barGap=4;const chartH=28;const svgW=(barW+barGap)*7-barGap;
  const bars=dayCounts.map((c,i)=>{const h=Math.max(2,Math.round((c/maxC)*chartH));const x=i*(barW+barGap);const y=chartH-h;const isToday=days[i]===new Date().toISOString().split('T')[0];return`<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="2" fill="${isToday?'var(--accent)':'rgba(74,222,128,0.3)'}"/><text x="${x+barW/2}" y="${chartH+10}" text-anchor="middle" font-size="6" fill="var(--text-muted)">${dayLabels[i]}</text>${c?`<text x="${x+barW/2}" y="${y-2}" text-anchor="middle" font-size="7" fill="var(--text-muted)">${c}</text>`:''}`;}).join('');
  const sparkSvg=`<svg width="${svgW}" height="${chartH+14}" style="margin-top:6px;display:block">${bars}</svg>`;
  return `<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">This Week</div>${doneThisWeek?`<div style="font-size:10px;color:var(--accent)">${doneThisWeek} tasks completed</div>`:''}<div style="font-size:10px;color:var(--text-muted)">${createdThisWeek} tasks created</div>${contentThisWeek?`<div style="font-size:10px;color:var(--text-muted)">${contentThisWeek} content added</div>`:''} ${sparkSvg}</div>`;
}

function taskWeather(){
  const today=new Date().toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const overdue=active.filter(t=>t.due&&t.due<today).length;
  const blocked=active.filter(t=>t.status==='blocked').length;
  const p0=active.filter(t=>t.priority==='p0').length;
  const inProgress=active.filter(t=>t.status==='progress').length;
  const todayDue=active.filter(t=>t.due===today).length;
  const score=Math.max(0,100-overdue*15-blocked*10-p0*8-(inProgress>5?(inProgress-5)*5:0));
  let weather,icon,color;
  if(score>=80){weather='Clear skies';icon='*';color='var(--accent)';}
  else if(score>=60){weather='Partly cloudy';icon='~';color='var(--yellow)';}
  else if(score>=40){weather='Overcast';icon='=';color='var(--orange)';}
  else if(score>=20){weather='Stormy';icon='!';color='var(--red)';}
  else{weather='Hurricane';icon='!!!';color='var(--red)';}
  const details=[];
  if(overdue)details.push(overdue+' overdue');
  if(blocked)details.push(blocked+' blocked');
  if(p0)details.push(p0+' critical');
  if(todayDue)details.push(todayDue+' due today');
  return`<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">Task Weather</div><div style="font-size:12px;color:${color};font-weight:600">${icon} ${weather}</div>${details.length?`<div style="font-size:9px;color:var(--text-muted)">${details.join(' / ')}</div>`:''}</div>`;
}

function weeklyReport(){
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());weekStart.setHours(0,0,0,0);
  const ws=weekStart.toISOString();
  const done=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=ws));
  const created=S.tasks.filter(t=>t.created&&t.created>=ws);
  const content=S.content.filter(c=>c.created&&c.created>=ws);
  const docs=S.docs.filter(d=>d.updated&&d.updated>=ws);
  const overdue=S.tasks.filter(t=>t.due&&t.due<now.toISOString().split('T')[0]&&t.status!=='done');
  const totalTime=done.reduce((a,t)=>a+(t.timeSpent||0),0);
  let md='# Weekly Report\n';
  md+='*'+weekStart.toLocaleDateString('en-US',{month:'long',day:'numeric'})+' - '+now.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'*\n\n';
  md+='## Summary\n';
  md+='- '+done.length+' tasks completed\n';
  md+='- '+created.length+' tasks created\n';
  md+='- '+content.length+' content items added\n';
  md+='- '+docs.length+' documents edited\n';
  if(totalTime)md+='- '+formatTimeSpent(totalTime)+' tracked\n';
  if(overdue.length)md+='- '+overdue.length+' tasks overdue\n';
  if(done.length){md+='\n## Completed\n';done.forEach(t=>{md+='- [x] '+t.title+(t.project?' ('+t.project+')':'')+'\n';});}
  if(overdue.length){md+='\n## Overdue\n';overdue.forEach(t=>{md+='- [ ] '+t.title+' (due '+t.due+')\n';});}
  const inProg=S.tasks.filter(t=>t.status==='progress');
  if(inProg.length){md+='\n## In Progress\n';inProg.forEach(t=>{md+='- [ ] '+t.title+(t.estimate?' ['+t.estimate+']':'')+'\n';});}
  navigator.clipboard.writeText(md).then(()=>toast('Weekly report copied'));
}

// === CONTENT ===
function renderContent() {
  const themes=[...new Set(S.content.map(c=>c.theme).filter(Boolean))].sort();
  document.getElementById('content-theme-tabs').innerHTML=`<button class="tab-btn ${contentTheme==='all'?'active':''}" onclick="setContentTheme('all',this)">All Themes</button>`+themes.map(t=>`<button class="tab-btn ${contentTheme===t?'active':''}" onclick="setContentTheme('${escA(t)}',this)">${esc(t)}</button>`).join('');
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  let items=S.content;
  const archivedCount=S.content.filter(c=>c.archived).length;
  if(!contentShowArchived)items=items.filter(c=>!c.archived);
  if(contentReadLaterFilter)items=items.filter(c=>c.readLater);
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+c.source+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  // Tag pills
  const allTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))].sort();
  const tagArea=document.getElementById('content-tag-pills');
  if(tagArea&&allTags.length)tagArea.innerHTML=allTags.slice(0,12).map(t=>`<span style="font-size:8px;padding:2px 6px;border-radius:10px;cursor:pointer;border:1px solid ${contentTagFilter===t?'var(--accent)':'var(--border)'};color:${contentTagFilter===t?'var(--accent)':'var(--text-muted)'};background:${contentTagFilter===t?'rgba(74,222,128,0.08)':'transparent'}" onclick="contentTagFilter=contentTagFilter==='${escA(t)}'?null:'${escA(t)}';renderContent()">${esc(t)}</span>`).join('')+(contentTagFilter?`<span style="font-size:8px;color:var(--red);cursor:pointer;padding:2px 4px" onclick="contentTagFilter=null;renderContent()">x clear</span>`:'');
  else if(tagArea)tagArea.innerHTML='';
  const sortVal=(document.getElementById('content-sort')?.value)||'newest';
  if(sortVal==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));
  else if(sortVal==='oldest')items.sort((a,b)=>new Date(a.created||0)-new Date(b.created||0));
  else if(sortVal==='longest')items.sort((a,b)=>b.body.length-a.body.length);
  else if(sortVal==='shortest')items.sort((a,b)=>a.body.length-b.body.length);
  else if(sortVal==='alpha')items.sort((a,b)=>a.body.localeCompare(b.body));
  else if(sortVal==='shuffle')items.sort(()=>Math.random()-0.5);
  else if(sortVal==='theme')items.sort((a,b)=>(a.theme||'zzz').localeCompare(b.theme||'zzz'));
  else if(sortVal==='type')items.sort((a,b)=>(a.type||'zzz').localeCompare(b.type||'zzz'));
  else if(sortVal==='tag')items.sort((a,b)=>((a.tags&&a.tags[0])||'zzz').localeCompare((b.tags&&b.tags[0])||'zzz'));
  else if(sortVal==='source')items.sort((a,b)=>(a.source||'zzz').localeCompare(b.source||'zzz'));
  items.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));
  items.sort((a,b)=>(b.starred?1:0)-(a.starred?1:0));
  const maxShow=40;
  const g=document.getElementById('content-grid');
  const showing=contentShowAll?items:items.slice(0,maxShow);
  const renderCard=c=>{const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;const sizeLabel=wc>500?'long':wc>100?'medium':'short';const sizeColor=wc>500?'var(--accent-cyan)':wc>100?'var(--text-muted)':'var(--yellow)';const hasMd=c.body&&(/\*\*|^#|^[-*] |`[^`]+`|^>/m).test(c.body);const bodyHtml=q?highlight(c.body,q):hasMd?simpleMarkdown(c.body):parseWikiLinks(esc(c.body));if(contentCompact){const preview=esc(c.body.substring(0,100)).replace(/\n/g,' ');return`<div style="display:flex;align-items:center;gap:8px;padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:10px;line-height:1.4${c.pinned?';border-color:rgba(74,222,128,0.2)':''}" onclick="openContentModal(${c.id})">${c.starred?'<span style="color:var(--yellow);font-size:8px;flex-shrink:0">*</span>':''}<span class="badge ${c.type==='caption'?'badge-blue':'badge-purple'}" style="font-size:7px;flex-shrink:0">${c.type}</span><span style="flex:1;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${preview}</span>${c.theme?`<span class="badge badge-muted" style="font-size:7px;flex-shrink:0">${esc(c.theme)}</span>`:''}<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);flex-shrink:0">${wc}w</span><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();copyContent(${c.id})" style="font-size:8px;padding:1px 4px;flex-shrink:0">Copy</button></div>`;}return`<div class="content-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain',JSON.stringify({type:'content',id:${c.id}}))" ${c.pinned?'style="border-color:rgba(74,222,128,0.2)"':''}>${c.starred?'<div style="font-size:8px;color:var(--yellow);padding:4px 10px 0">* Starred</div>':''}${c.pinned?'<div style="font-size:8px;color:var(--accent);text-transform:uppercase;letter-spacing:0.06em;padding:4px 10px 0">Pinned</div>':''}${contentBulkMode?`<div style="padding:4px 8px 0;cursor:pointer" onclick="toggleContentSelect(${c.id},this)"><input type="checkbox" ${contentSelected.has(c.id)?'checked':''} style="pointer-events:none"></div>`:''}<div class="content-card-body" onclick="${contentBulkMode?`toggleContentSelect(${c.id},this.parentElement)`:`this.classList.toggle('expanded')`}" ondblclick="${contentBulkMode?'':`contentInlineEdit(${c.id},this,event)`}">${bodyHtml}</div><div class="content-card-footer"><span class="badge ${c.type==='caption'?'badge-blue':'badge-purple'}" style="cursor:pointer" onclick="event.stopPropagation();setContentType('${c.type}',null);toast('Filtered: ${c.type}')">${c.type}</span>${c.theme?`<span class="badge badge-muted" style="cursor:pointer" onclick="event.stopPropagation();contentTheme='${escA(c.theme)}';renderContent();toast('Theme: ${escA(c.theme)}')">${esc(c.theme)}</span>`:''}${c.source?`<span style="font-size:8px;color:var(--text-muted)">${esc(c.source)}</span>`:''}<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${wc}w${wc>50?' / '+Math.max(1,Math.ceil(wc/238))+'m':''}</span><span style="font-size:7px;color:${sizeColor};border:1px solid ${sizeColor};border-radius:3px;padding:0 3px;opacity:0.6">${sizeLabel}</span>${c.created?`<span style="font-size:8px;color:var(--text-muted)" title="${new Date(c.created).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}">${timeAgo(c.created)}</span>`:''} ${c.editCount?`<span style="font-size:7px;color:var(--accent-cyan);font-family:var(--mono)" title="Edited ${c.editCount} time${c.editCount>1?'s':''}">${c.editCount}e</span>`:''} ${(c.tags||[]).map(t=>`<span class="badge badge-muted" style="font-size:7px">${esc(t)}</span>`).join('')}<div class="content-card-actions"><button class="btn btn-sm btn-ghost" onclick="starContent(${c.id})" style="${c.starred?'color:var(--yellow)':''}">*</button><button class="btn btn-sm btn-ghost" onclick="pinContent(${c.id})" style="${c.pinned?'color:var(--accent)':''}">${c.pinned?'Unpin':'Pin'}</button><button class="btn btn-sm btn-ghost" onclick="copyContent(${c.id})">Copy</button><button class="btn btn-sm btn-ghost" onclick="openContentModal(${c.id})">Edit</button><button class="btn btn-sm btn-ghost" onclick="dupContent(${c.id})">Dup</button><button class="btn btn-sm btn-ghost" onclick="readContent(${c.id})">Read</button><button class="btn btn-sm btn-ghost" onclick="contentToDoc(${c.id})">Doc</button><button class="btn btn-sm btn-ghost" onclick="contentToPipeline(${c.id})">Pipe</button><button class="btn btn-sm btn-ghost" onclick="contentToTask(${c.id})" title="Convert to task">Task</button><button class="btn btn-sm btn-ghost" onclick="splitContent(${c.id})" title="Split at ---">Split</button><button class="btn btn-sm btn-ghost" onclick="toggleReadLater(${c.id})" style="${c.readLater?'color:var(--accent-cyan)':''}">${c.readLater?'Unlist':'RL'}</button><button class="btn btn-sm btn-ghost" onclick="archiveContent(${c.id})" style="${c.archived?'color:var(--yellow)':''}">${c.archived?'Unarc':'Arc'}</button><button class="btn btn-sm btn-ghost btn-danger" onclick="delContent(${c.id})">Del</button></div></div></div>`;};
  const dateGrp=d=>{if(!d)return'Unknown';const now=new Date();const cd=new Date(d);const diff=Math.floor((now-cd)/86400000);if(diff<1)return'Today';if(diff<7)return'This Week';if(diff<30)return'This Month';if(diff<90)return'Last 3 Months';return'Older';};
  const wcGrp=wc=>{if(wc===0)return'Empty';if(wc<50)return'Short (<50w)';if(wc<200)return'Medium (50-200w)';if(wc<500)return'Long (200-500w)';return'Very Long (500w+)';};
  let cardsHtml='';if(sortVal==='theme'||sortVal==='type'||sortVal==='newest'||sortVal==='oldest'||sortVal==='longest'||sortVal==='shortest'||sortVal==='alpha'||sortVal==='tag'||sortVal==='source'){let lastGrp=null;showing.forEach(c=>{const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;let grp;if(sortVal==='theme')grp=c.theme||'Unthemed';else if(sortVal==='type')grp=c.type||'other';else if(sortVal==='tag')grp=(c.tags&&c.tags[0])||'Untagged';else if(sortVal==='source')grp=c.source||'Unknown';else if(sortVal==='longest'||sortVal==='shortest')grp=wcGrp(wc);else if(sortVal==='alpha')grp=(c.body||' ')[0].toUpperCase();else grp=dateGrp(c.created);if(grp!==lastGrp){const cnt=showing.filter(x=>{const xwc=x.body.trim().split(/\s+/).filter(z=>z.length).length;if(sortVal==='theme')return(x.theme||'Unthemed')===grp;if(sortVal==='type')return(x.type||'other')===grp;if(sortVal==='tag')return((x.tags&&x.tags[0])||'Untagged')===grp;if(sortVal==='source')return(x.source||'Unknown')===grp;if(sortVal==='longest'||sortVal==='shortest')return wcGrp(xwc)===grp;if(sortVal==='alpha')return(x.body||' ')[0].toUpperCase()===grp;return dateGrp(x.created)===grp;}).length;const clr=sortVal==='type'?(grp==='caption'?'#3b82f6':'#a855f7'):(sortVal==='newest'||sortVal==='oldest')?'var(--yellow)':(sortVal==='longest'||sortVal==='shortest')?'var(--accent-cyan)':sortVal==='tag'?'#f59e0b':sortVal==='source'?'#ec4899':sortVal==='alpha'?'var(--accent)':'var(--accent)';cardsHtml+=`<div style="grid-column:1/-1;padding:8px 4px 4px;font-size:11px;font-weight:600;color:${clr};border-bottom:1px solid var(--border);margin-bottom:2px;text-transform:uppercase;letter-spacing:0.05em">${esc(grp)} <span style="font-size:9px;color:var(--text-muted);font-weight:400">${cnt}</span></div>`;lastGrp=grp;}cardsHtml+=renderCard(c);});}else{cardsHtml=showing.map(renderCard).join('');}
  g.innerHTML=!items.length?`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">C</div><div style="font-size:12px">${q?'No matching content':'No content yet'}</div><div style="font-size:10px;margin-top:4px">${q?'Try a different search term':'Click + Add to paste from Apple Notes'}</div></div>`:cardsHtml+(items.length>maxShow&&!contentShowAll?`<div style="grid-column:1/-1;text-align:center;padding:12px"><button class="btn btn-sm" onclick="contentShowAll=true;renderContent()">Show all ${items.length} items (${items.length-maxShow} more)</button></div>`:'');
  document.getElementById('content-count').textContent=S.content.length;
  const totalWords=S.content.reduce((sum,c)=>sum+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
  const cwEl=document.getElementById('content-word-total');if(cwEl){const types={};S.content.forEach(c=>{const t=c.type||'other';types[t]=(types[t]||0)+1;});const breakdown=Object.entries(types).sort((a,b)=>b[1]-a[1]).map(([t,n])=>t+':'+n).join(' | ');cwEl.textContent=totalWords.toLocaleString()+'w total';cwEl.title=breakdown;}
}
function setContentType(t,el){contentType=t;document.querySelectorAll('#content-type-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderContent();}
function setContentTheme(t,el){contentTheme=t;document.querySelectorAll('#content-theme-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderContent();}
function openContentModal(id){editingContentId=id||null;document.getElementById('content-modal-title').textContent=id?'Edit Content':'Add Content';
  // Populate theme datalist
  const themes=[...new Set(S.content.map(c=>c.theme).filter(Boolean))].sort();
  let dl=document.getElementById('theme-dl');if(!dl){dl=document.createElement('datalist');dl.id='theme-dl';document.body.appendChild(dl);}
  dl.innerHTML=themes.map(t=>`<option value="${esc(t)}">`).join('');
  document.getElementById('cm-theme').setAttribute('list','theme-dl');
  if(id){const c=S.content.find(x=>x.id===id);if(c){document.getElementById('cm-type').value=c.type;document.getElementById('cm-theme').value=c.theme||'';document.getElementById('cm-body').value=c.body;document.getElementById('cm-source').value=c.source||'';document.getElementById('cm-tags').value=(c.tags||[]).join(', ');}}else{document.getElementById('cm-type').value='caption';document.getElementById('cm-theme').value='';document.getElementById('cm-body').value='';document.getElementById('cm-source').value='';document.getElementById('cm-tags').value='';}document.getElementById('content-modal').classList.add('open');setTimeout(()=>document.getElementById('cm-body').focus(),100);}
function closeContentModal(){document.getElementById('content-modal').classList.remove('open');editingContentId=null;}
function saveContent(){const type=document.getElementById('cm-type').value,theme=document.getElementById('cm-theme').value.trim().toLowerCase(),body=document.getElementById('cm-body').value.trim(),source=document.getElementById('cm-source').value.trim(),tags=(document.getElementById('cm-tags').value||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);if(!body){toast('Content cannot be empty');return;}if(editingContentId){const c=S.content.find(x=>x.id===editingContentId);if(c){c.type=type;c.theme=theme;c.body=body;c.source=source;c.tags=tags;c.updated=new Date().toISOString();c.editCount=(c.editCount||0)+1;}}else S.content.push({id:Date.now(),type,theme,body,source,tags,created:new Date().toISOString(),updated:new Date().toISOString()});save();closeContentModal();renderContent();toast(editingContentId?'Updated':'Added');}
let lastDeletedContent=null;
function delContent(id){const c=S.content.find(x=>x.id===id);if(c)lastDeletedContent={...c};S.content=S.content.filter(c=>c.id!==id);save();renderContent();toast('Deleted — Cmd+Z to undo');}
function undoDeleteContent(){if(!lastDeletedContent)return;S.content.unshift(lastDeletedContent);lastDeletedContent=null;save();renderContent();toast('Restored');}
function copyContent(id){const c=S.content.find(x=>x.id===id);if(c){navigator.clipboard.writeText(c.body);toast('Copied');}}
function randomContent(){if(!S.content.length){toast('No content yet');return;}const r=S.content[Math.floor(Math.random()*S.content.length)];navigator.clipboard.writeText(r.body);toast('Random: '+(r.body.substring(0,50)+'...'));document.getElementById('content-search').value='';contentType='all';contentTheme='all';contentTagFilter=null;renderContent();setTimeout(()=>{const cards=document.querySelectorAll('.content-card');const idx=S.content.indexOf(r);if(cards[idx])cards[idx].scrollIntoView({behavior:'smooth',block:'center'});},100);}
function pinContent(id){const c=S.content.find(x=>x.id===id);if(c){c.pinned=!c.pinned;save();renderContent();toast(c.pinned?'Pinned':'Unpinned');}}
function splitContent(id){const c=S.content.find(x=>x.id===id);if(!c)return;const parts=c.body.split(/\n---\n|^---$|\n---$/m).map(p=>p.trim()).filter(Boolean);if(parts.length<=1){toast('No --- separator found');return;}if(!confirm('Split into '+parts.length+' items?'))return;S.content=S.content.filter(x=>x.id!==id);parts.forEach((p,i)=>{S.content.unshift({id:Date.now()+i,type:c.type,theme:c.theme||'',body:p,tags:[...(c.tags||[])],source:c.source||'',created:new Date().toISOString()});});save();renderContent();toast('Split into '+parts.length+' items');}
function readContent(id){
  const c=S.content.find(x=>x.id===id);if(!c)return;
  const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;
  const readTime=Math.max(1,Math.ceil(wc/238));
  let existing=document.getElementById('content-reader');if(existing)existing.remove();
  const overlay=document.createElement('div');overlay.id='content-reader';
  overlay.style.cssText='position:fixed;inset:0;z-index:9999;background:var(--bg-void);display:flex;flex-direction:column;overflow-y:auto';
  overlay.innerHTML=`<div style="max-width:680px;margin:0 auto;padding:40px 24px;width:100%"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px"><div style="display:flex;gap:8px;align-items:center"><span class="badge ${c.type==='caption'?'badge-blue':'badge-purple'}">${c.type}</span>${c.theme?`<span class="badge badge-muted">${esc(c.theme)}</span>`:''}<span style="font-size:10px;color:var(--text-muted)">${wc} words / ${readTime} min read</span></div><button onclick="this.closest('#content-reader').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:8px">x close</button></div><div style="font-size:15px;line-height:2;color:var(--text);white-space:pre-wrap">${parseWikiLinks(esc(c.body))}</div>${(c.tags||[]).length?`<div style="margin-top:24px;display:flex;gap:4px;flex-wrap:wrap">${c.tags.map(t=>`<span class="badge badge-muted" style="font-size:8px">${esc(t)}</span>`).join('')}</div>`:''}<div style="margin-top:24px;display:flex;gap:8px"><button class="btn btn-sm" onclick="navigator.clipboard.writeText(${JSON.stringify(c.body).replace(/'/g,"\\'")});toast('Copied')">Copy</button><button class="btn btn-sm" onclick="this.closest('#content-reader').remove();openContentModal(${c.id})">Edit</button></div></div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('keydown',e=>{if(e.key==='Escape')overlay.remove();});
  overlay.tabIndex=0;overlay.focus();
}
function starContent(id){const c=S.content.find(x=>x.id===id);if(c){c.starred=!c.starred;save();renderContent();toast(c.starred?'Starred':'Unstarred');}}
function archiveContent(id){const c=S.content.find(x=>x.id===id);if(c){c.archived=!c.archived;save();renderContent();toast(c.archived?'Archived':'Unarchived');}}
function toggleReadLater(id){const c=S.content.find(x=>x.id===id);if(c){c.readLater=!c.readLater;save();renderContent();toast(c.readLater?'Added to Read Later':'Removed from Read Later');}}
function contentToTask(id){const c=S.content.find(x=>x.id===id);if(!c)return;const title=(c.body||'').split('\n')[0].substring(0,80).trim()||'Task from content';const desc=(c.body||'').substring(0,500);S.tasks.unshift({id:Date.now(),title,description:desc,subtasks:[],status:'todo',priority:'p2',project:'',due:'',tags:(c.tags||[]).slice(),created:new Date().toISOString()});save();renderContent();toast('Task created: '+title.substring(0,30));}
function batchImportContent(){
  const text=prompt('Paste content items separated by --- (three dashes):');
  if(!text)return;
  const items=text.split(/\n---\n|\n---$|^---\n/).map(s=>s.trim()).filter(Boolean);
  if(!items.length){toast('No items found');return;}
  items.forEach(body=>{S.content.unshift({id:Date.now()+Math.random()*1000,type:'caption',theme:'imported',body,tags:['batch-import'],created:new Date().toISOString()});});
  save();renderContent();toast('Imported '+items.length+' content items');
}
function contentToDoc(id){const c=S.content.find(x=>x.id===id);if(!c)return;const title=(c.theme||'Untitled')+' — '+(c.body.substring(0,40).replace(/\n/g,' '));S.docs.push({id:Date.now(),title,body:c.body.replace(/\n/g,'<br>'),created:new Date().toISOString(),updated:new Date().toISOString(),versions:[]});save();toast('Created doc: '+title.substring(0,30));if(currentSection==='writer')renderWriter();}
function contentToPipeline(id){const c=S.content.find(x=>x.id===id);if(!c)return;switchSection('pipeline',null);setTimeout(()=>{const ta=document.getElementById('pl-transcript-box');if(ta){ta.style.display='block';ta.value=c.body;plTranscriptText=c.body;const wc=document.getElementById('pl-text-stats');if(wc){const words=c.body.trim().split(/\s+/).filter(x=>x.length).length;wc.textContent=words+' words, '+c.body.length+' chars';}toast('Content loaded in pipeline');}},200);}
function dupContent(id){const c=S.content.find(x=>x.id===id);if(!c)return;S.content.unshift({...c,id:Date.now(),pinned:false,created:new Date().toISOString()});save();renderContent();toast('Duplicated');}
function mergeContent(){if(contentSelected.size<2){toast('Select 2+ items to merge');return;}const items=[...contentSelected].map(id=>S.content.find(c=>c.id===id)).filter(Boolean);const merged=items.map(c=>c.body).join('\n\n---\n\n');const tags=[...new Set(items.flatMap(c=>c.tags||[]))];S.content.unshift({id:Date.now(),type:items[0].type||'caption',theme:items[0].theme||'',body:merged,tags,source:'merged',created:new Date().toISOString()});save();contentSelected.clear();contentBulkMode=false;renderContent();toast('Merged '+items.length+' items');}
function exportContent(){
  const items=S.content;
  const groups={};
  items.forEach(c=>{const g=c.theme||'Unthemed';if(!groups[g])groups[g]=[];groups[g].push(c);});
  let md='# Content Export\n';
  md+='Generated: '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n';
  md+=items.length+' items total\n\n';
  Object.keys(groups).sort().forEach(g=>{
    md+='## '+g+'\n\n';
    groups[g].forEach(c=>{
      md+='### '+c.type+(c.source?' ('+c.source+')':'')+'\n';
      md+=c.body+'\n';
      if(c.tags&&c.tags.length)md+='Tags: '+c.tags.join(', ')+'\n';
      md+='\n---\n\n';
    });
  });
  navigator.clipboard.writeText(md).then(()=>toast('Content copied as markdown')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='content-export.md';a.click();toast('Content exported');
  });
}
function exportContentHTML(){
  if(!S.content.length){toast('No content');return;}
  const groups={};S.content.forEach(c=>{const g=c.theme||'Unthemed';if(!groups[g])groups[g]=[];groups[g].push(c);});
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Content Export - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:20px;color:#22d3ee;margin-top:32px;border-bottom:1px solid #222;padding-bottom:4px}hr{border:none;border-top:1px solid #222;margin:16px 0}.item{margin:12px 0;padding:12px;background:#101014;border-radius:8px;border-left:3px solid #4ade80}.meta{font-size:11px;color:#888;margin-top:6px}.tag{display:inline-block;font-size:9px;padding:1px 6px;border-radius:8px;border:1px solid rgba(74,222,128,0.3);color:#4ade80;margin-right:4px}</style></head><body>';
  h+='<h1>Content Export</h1><p style="color:#888;font-size:13px">'+S.content.length+' items | Exported '+new Date().toLocaleDateString()+'</p>';
  Object.keys(groups).sort().forEach(g=>{h+='<h2>'+esc(g)+' ('+groups[g].length+')</h2>';groups[g].forEach(c=>{const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;h+='<div class="item"><div style="white-space:pre-wrap">'+esc(c.body)+'</div><div class="meta">'+c.type+(c.source?' | '+esc(c.source):'')+' | '+wc+'w'+(c.tags&&c.tags.length?' | '+c.tags.map(t=>'<span class="tag">'+esc(t)+'</span>').join(''):'')+'</div></div>';});});
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-content-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.content.length+' items as HTML');
}
function exportFilteredContentMD(){
  let items=[...S.content];
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  if(!items.length){toast('No visible items');return;}
  let md='# Content Export\n\n'+items.length+' items | Exported '+new Date().toLocaleDateString()+'\n\n';
  if(contentType!=='all')md+='Filter: type='+contentType+'\n';
  if(contentTheme!=='all')md+='Filter: theme='+contentTheme+'\n';
  if(contentTagFilter)md+='Filter: tag='+contentTagFilter+'\n';
  md+='\n---\n\n';
  items.forEach(c=>{md+=c.body+'\n\n*'+c.type+(c.theme?' / '+c.theme:'')+(c.tags&&c.tags.length?' / tags: '+c.tags.join(', '):'')+' / '+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length+'w*\n\n---\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Copied '+items.length+' items as Markdown'));
}
function toggleAllContentCards(){
  const cards=document.querySelectorAll('.content-card-body');
  const anyExpanded=[...cards].some(c=>c.classList.contains('expanded'));
  cards.forEach(c=>{if(anyExpanded)c.classList.remove('expanded');else c.classList.add('expanded');});
  toast(anyExpanded?'All collapsed':'All expanded');
}
function copyAllContent(){
  let items=[...S.content];
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  if(q)items=items.filter(c=>(c.body+' '+c.theme).toLowerCase().includes(q));
  if(!items.length){toast('No content to copy');return;}
  const text=items.map(c=>c.body).join('\n\n---\n\n');
  navigator.clipboard.writeText(text).then(()=>toast(items.length+' items copied'));
}
function exportFilteredContent(){
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  let items=[...S.content];
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+c.source+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  if(!items.length){toast('No items to export');return;}
  let md='# Filtered Content Export\n';
  md+='Filter: '+(contentType!=='all'?contentType+' / ':'')+(contentTheme!=='all'?contentTheme+' / ':'')+(contentTagFilter?'#'+contentTagFilter+' / ':'')+(q?'"'+q+'" / ':'')+items.length+' items\n\n';
  items.forEach(c=>{md+=c.body+'\n\n---\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Exported '+items.length+' filtered items'));
}
let contentBulkMode=false, contentSelected=new Set(), contentShowAll=false, contentCompact=false, contentShowArchived=false, contentReadLaterFilter=false;
function toggleContentCompact(){contentCompact=!contentCompact;const btn=document.getElementById('content-compact-btn');if(btn)btn.style.color=contentCompact?'var(--accent)':'';const g=document.getElementById('content-grid');if(g){g.style.gridTemplateColumns=contentCompact?'1fr':'repeat(auto-fill,minmax(280px,1fr))';if(contentCompact)g.style.gap='2px';else g.style.gap='';}renderContent();}
function toggleContentBulk(){
  contentBulkMode=!contentBulkMode;contentSelected.clear();
  document.getElementById('content-bulk-btn').style.display=contentBulkMode?'none':'';
  document.getElementById('content-bulk-actions').style.display=contentBulkMode?'flex':'none';
  renderContent();
}
function toggleContentSelect(id,el){
  if(contentSelected.has(id))contentSelected.delete(id);else contentSelected.add(id);
  el.closest('.content-card').style.outline=contentSelected.has(id)?'2px solid var(--accent)':'none';
}
function contentBulkDelete(){
  if(!contentSelected.size){toast('Select items first');return;}
  if(!confirm('Delete '+contentSelected.size+' items?'))return;
  S.content=S.content.filter(c=>!contentSelected.has(c.id));
  save();contentSelected.clear();renderContent();toast('Deleted');
}
function contentBulkTag(){
  if(!contentSelected.size){toast('Select items first');return;}
  const tag=prompt('Enter tag to add:');
  if(!tag)return;
  const t=tag.trim().toLowerCase();
  S.content.forEach(c=>{if(contentSelected.has(c.id)){if(!c.tags)c.tags=[];if(!c.tags.includes(t))c.tags.push(t);}});
  save();contentSelected.clear();renderContent();toast('Tagged');
}
function tagAllVisibleContent(){
  let items=S.content;
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  if(!items.length){toast('No visible items');return;}
  const tag=prompt('Tag to add to '+items.length+' visible items:');
  if(!tag)return;const t=tag.trim().toLowerCase();
  items.forEach(c=>{if(!c.tags)c.tags=[];if(!c.tags.includes(t))c.tags.push(t);});
  save();renderContent();toast('Tagged '+items.length+' items with "'+t+'"');
}
function contentBulkExport(){
  if(!contentSelected.size){toast('Select items first');return;}
  const items=[...contentSelected].map(id=>S.content.find(c=>c.id===id)).filter(Boolean);
  let md='# Selected Content Export\n'+items.length+' items\n\n';
  items.forEach(c=>{md+=`## ${c.theme||c.type||'Content'}\n${c.body}\n`;if(c.tags&&c.tags.length)md+='Tags: '+c.tags.join(', ')+'\n';md+='\n---\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Exported '+items.length+' items to clipboard'));
}
function contentManageTags(){
  const allTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))].sort();
  if(!allTags.length){toast('No tags to manage');return;}
  const action=prompt('Tag Management\n\nTags: '+allTags.join(', ')+'\n\nType:\n- rename:oldtag:newtag\n- delete:tagname');
  if(!action)return;
  if(action.startsWith('rename:')){const parts=action.split(':');if(parts.length===3){const old=parts[1].trim(),nw=parts[2].trim();let count=0;S.content.forEach(c=>{if(c.tags){const i=c.tags.indexOf(old);if(i>=0){c.tags[i]=nw;count++;}}});save();renderContent();toast('Renamed "'+old+'" to "'+nw+'" in '+count+' items');}}
  else if(action.startsWith('delete:')){const tag=action.substring(7).trim();let count=0;S.content.forEach(c=>{if(c.tags){const i=c.tags.indexOf(tag);if(i>=0){c.tags.splice(i,1);count++;}}});save();renderContent();toast('Removed "'+tag+'" from '+count+' items');}
  else{toast('Use rename:old:new or delete:tagname');}
}
function contentInlineEdit(id,el,e){
  e.stopPropagation();e.preventDefault();
  const c=S.content.find(x=>x.id===id);if(!c)return;
  el.classList.add('expanded');
  const ta=document.createElement('textarea');
  ta.value=c.body;ta.style.cssText='width:100%;min-height:120px;resize:vertical;font-size:11px;line-height:1.6;padding:8px;background:var(--bg-input);color:var(--text);border:1px solid var(--accent);border-radius:4px;font-family:var(--font);outline:none';
  el.innerHTML='';el.appendChild(ta);ta.focus();
  let saved=false;
  function finishEdit(){if(saved)return;saved=true;const v=ta.value.trim();if(v&&v!==c.body){c.body=v;c.updated=new Date().toISOString();save();toast('Saved');}renderContent();}
  ta.addEventListener('blur',finishEdit);
  ta.addEventListener('keydown',ev=>{if(ev.key==='Escape'){saved=true;renderContent();}if((ev.metaKey||ev.ctrlKey)&&ev.key==='Enter')finishEdit();});
}
function contentFindDuplicates(){
  if(S.content.length<2){toast('Need 2+ items');return;}
  const dupes=[];const normalize=s=>(s||'').toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
  for(let i=0;i<S.content.length;i++){
    for(let j=i+1;j<S.content.length;j++){
      const a=normalize(S.content[i].body),b=normalize(S.content[j].body);
      if(!a||!b||a.length<20)continue;
      const short=a.length<b.length?a:b;const long=a.length<b.length?b:a;
      if(short===long||long.includes(short)){
        dupes.push({a:S.content[i],b:S.content[j],type:short===long?'exact':'contained'});
      } else {
        const aWords=new Set(a.split(' '));const bWords=new Set(b.split(' '));
        const overlap=[...aWords].filter(w=>bWords.has(w)).length;
        const sim=overlap/Math.max(aWords.size,bWords.size);
        if(sim>0.7)dupes.push({a:S.content[i],b:S.content[j],type:'similar ('+Math.round(sim*100)+'%)'});
      }
    }
  }
  if(!dupes.length){toast('No duplicates found');return;}
  const panel=document.createElement('div');panel.id='content-dupes-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;padding:20px;z-index:9999;max-width:600px;max-height:70vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.6)';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="color:var(--accent);font-weight:600">Potential Duplicates ('+dupes.length+')</span><button onclick="this.closest(\'#content-dupes-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  dupes.slice(0,20).forEach((d,i)=>{
    const pa=d.a.body.substring(0,60).replace(/\n/g,' ');const pb=d.b.body.substring(0,60).replace(/\n/g,' ');
    html+='<div style="padding:8px;margin:4px 0;background:var(--bg-elevated);border-radius:6px;font-size:10px;line-height:1.5">';
    html+='<div style="color:var(--yellow);font-size:9px;margin-bottom:4px">'+esc(d.type)+'</div>';
    html+='<div style="color:var(--text)">A: '+esc(pa)+'...</div>';
    html+='<div style="color:var(--text-muted)">B: '+esc(pb)+'...</div>';
    html+='<button onclick="delContent('+d.b.id+');this.closest(\'#content-dupes-panel\').remove();contentFindDuplicates()" style="margin-top:4px;font-size:9px;padding:2px 8px;background:var(--red);color:#fff;border:none;border-radius:4px;cursor:pointer">Delete B</button>';
    html+='</div>';
  });
  if(dupes.length>20)html+='<div style="color:var(--text-muted);font-size:10px;padding:8px">...and '+(dupes.length-20)+' more</div>';
  panel.innerHTML=html;document.body.appendChild(panel);
}

// === TASKS ===
function setTaskView(v){taskView=v;document.getElementById('task-view-list').classList.toggle('active',v==='list');document.getElementById('task-view-board').classList.toggle('active',v==='board');document.getElementById('task-view-eisenhower').classList.toggle('active',v==='eisenhower');document.getElementById('task-list-view').style.display=v==='list'?'block':'none';document.getElementById('task-board-view').classList.toggle('active',v==='board');const ehEl=document.getElementById('task-eisenhower-view');if(ehEl)ehEl.style.display=v==='eisenhower'?'grid':'none';renderTasks();}
function renderEisenhower(){
  const today=new Date().toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const isUrgent=t=>t.priority==='p0'||t.priority==='p1'||(t.due&&t.due<=today);
  const isImportant=t=>t.priority==='p0'||(t.priority==='p1'&&t.status!=='blocked');
  const q1=[],q2=[],q3=[],q4=[];
  active.forEach(t=>{const u=isUrgent(t),i=isImportant(t);if(u&&i)q1.push(t);else if(!u&&i)q2.push(t);else if(u&&!i)q3.push(t);else q4.push(t);});
  const cardHtml=t=>`<div style="padding:6px 8px;background:var(--bg-elevated);border-radius:4px;margin-bottom:4px;cursor:pointer;font-size:11px;border-left:3px solid ${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':t.priority==='p2'?'var(--blue)':'var(--text-muted)'}" onclick="openTaskDetail(${t.id})"><div style="font-weight:600;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">${(t.priority||'p2').toUpperCase()}${t.due?' | '+t.due:''}${t.project?' | '+esc(t.project):''}</div></div>`;
  ['eh-q1','eh-q2','eh-q3','eh-q4'].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.innerHTML=[q1,q2,q3,q4][i].map(cardHtml).join('')||'<div style="font-size:10px;color:var(--text-muted);font-style:italic">None</div>';});
}
function setTaskFilter(f){taskFilter=f;taskProjectFilter=null;['all','active','todo','progress','blocked','done','overdue','urgent'].forEach(k=>{const el=document.getElementById('task-filter-'+k);if(el)el.classList.toggle('active',f===k);});renderTasks();}
function clearTaskFilters(){taskFilter='all';taskProjectFilter=null;const ts=document.getElementById('task-search');if(ts)ts.value='';const tsort=document.getElementById('task-sort');if(tsort)tsort.value='manual';const tpf=document.getElementById('task-project-filter');if(tpf)tpf.value='';['all','active','todo','progress','blocked','done','overdue','urgent'].forEach(k=>{const el=document.getElementById('task-filter-'+k);if(el)el.classList.toggle('active',k==='all');});renderTasks();toast('Filters cleared');}
function filterTaskProject(p){taskProjectFilter=p;taskFilter='all';renderTasks();}
function getFilteredTasks(){const q=(document.getElementById('task-search')?.value||'').toLowerCase();let items=[...S.tasks];if(taskFilter==='active')items=items.filter(t=>t.status!=='done');else if(taskFilter==='todo')items=items.filter(t=>t.status==='todo');else if(taskFilter==='progress')items=items.filter(t=>t.status==='progress');else if(taskFilter==='blocked')items=items.filter(t=>t.status==='blocked');else if(taskFilter==='done')items=items.filter(t=>t.status==='done');else if(taskFilter==='overdue'){const td=new Date().toISOString().split('T')[0];items=items.filter(t=>t.status!=='done'&&t.due&&t.due<td);}else if(taskFilter==='urgent'){items=items.filter(t=>t.status!=='done'&&(t.priority==='p0'||t.priority==='p1'));}if(taskProjectFilter)items=items.filter(t=>t.project===taskProjectFilter);if(q){if(q.startsWith('#')){const tagQ=q.substring(1);items=items.filter(t=>(t.tags||[]).some(tag=>tag.includes(tagQ)));}else{items=items.filter(t=>(t.title+' '+t.project+' '+(t.description||'')+' '+(t.tags||[]).join(' ')).toLowerCase().includes(q));}}const sortVal=(document.getElementById('task-sort')?.value)||'manual';const pMap={p0:0,p1:1,p2:2,p3:3};if(sortVal==='priority')items.sort((a,b)=>(pMap[a.priority]||2)-(pMap[b.priority]||2));else if(sortVal==='due')items.sort((a,b)=>(a.due||'9999').localeCompare(b.due||'9999'));else if(sortVal==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));else if(sortVal==='alpha')items.sort((a,b)=>(a.title||'').localeCompare(b.title||''));else if(sortVal==='completed')items.sort((a,b)=>new Date(b.completedAt||0)-new Date(a.completedAt||0));else if(sortVal==='project')items.sort((a,b)=>(a.project||'zzz').localeCompare(b.project||'zzz'));else if(sortVal==='time')items.sort((a,b)=>(b.timeSpent||0)-(a.timeSpent||0));else if(sortVal==='status'){const sMap={progress:0,todo:1,blocked:2,done:3};items.sort((a,b)=>(sMap[a.status]||1)-(sMap[b.status]||1));}else if(sortVal==='estimate'){const parseEst=e=>{if(!e)return 9999;const n=parseFloat(e);if(e.includes('d'))return n*480;if(e.includes('h'))return n*60;if(e.includes('m'))return n;return n;};items.sort((a,b)=>parseEst(a.estimate)-parseEst(b.estimate));}else if(sortVal==='tag'){items.sort((a,b)=>((a.tags&&a.tags[0])||'zzz').localeCompare((b.tags&&b.tags[0])||'zzz'));}return items;}

function renderTasks(){
  const items=getFilteredTasks();
  const today=new Date().toISOString().split('T')[0];
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  const rows=document.getElementById('task-rows');
  const sortVal=(document.getElementById('task-sort')?.value)||'manual';
  let lastProj=null;let lastGroup=null;
  rows.innerHTML=items.map(t=>{let hdr='';if(sortVal==='project'){const pg=t.project||'No Project';if(pg!==lastProj){hdr=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastProj===null?'0':'8'}px;font-family:var(--mono)">${esc(pg)}</div>`;lastProj=pg;}}if(sortVal==='priority'){const pg=t.priority||'p2';if(pg!==lastGroup){const pColors={p0:'var(--red)',p1:'var(--orange)',p2:'var(--accent-cyan)',p3:'var(--text-muted)'};const pNames={p0:'P0 Critical',p1:'P1 High',p2:'P2 Medium',p3:'P3 Low'};hdr=`<div style="padding:6px 8px 3px;font-size:9px;color:${pColors[pg]||'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${pNames[pg]||pg} (${items.filter(x=>(x.priority||'p2')===pg).length})</div>`;lastGroup=pg;}}if(sortVal==='status'){const sg=t.status||'todo';if(sg!==lastGroup){const sColors={progress:'var(--green)',todo:'var(--accent-cyan)',blocked:'var(--orange)',done:'var(--text-muted)'};const sNames={progress:'In Progress',todo:'To Do',blocked:'Blocked',done:'Done'};hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:${sColors[sg]||'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${sNames[sg]||sg} (${items.filter(x=>x.status===sg).length})</div>`;lastGroup=sg;}}if(sortVal==='estimate'){const eg=t.estimate||'No Estimate';if(eg!==lastGroup){hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${esc(eg)} (${items.filter(x=>(x.estimate||'No Estimate')===eg).length})</div>`;lastGroup=eg;}}if(sortVal==='time'){const tm=t.timeSpent||0;const tg=tm===0?'No Time':tm<30?'< 30m':tm<60?'30m - 1h':tm<120?'1h - 2h':'2h+';if(tg!==lastGroup){const cnt=items.filter(x=>{const m=x.timeSpent||0;const g=m===0?'No Time':m<30?'< 30m':m<60?'30m - 1h':m<120?'1h - 2h':'2h+';return g===tg;}).length;hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--green);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${tg} (${cnt})</div>`;lastGroup=tg;}}if(sortVal==='due'){const dueGrp=d=>{if(!d)return'No Date';if(d<today)return'Overdue';if(d===today)return'Today';const tmrw=new Date(new Date().getTime()+86400000).toISOString().split('T')[0];if(d===tmrw)return'Tomorrow';const wkEnd=new Date(new Date().getTime()+7*86400000).toISOString().split('T')[0];if(d<=wkEnd)return'This Week';const nwEnd=new Date(new Date().getTime()+14*86400000).toISOString().split('T')[0];if(d<=nwEnd)return'Next Week';return'Later';};const dg=dueGrp(t.due);if(dg!==lastGroup){const cnt=items.filter(x=>dueGrp(x.due)===dg).length;const dgClr=dg==='Overdue'?'var(--red)':dg==='Today'?'var(--accent)':dg==='Tomorrow'?'var(--yellow)':'var(--text-muted)';hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:${dgClr};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${dg} (${cnt})</div>`;lastGroup=dg;}}if(sortVal==='newest'||sortVal==='completed'){const ageGrp=d=>{if(!d)return'Unknown';const diff=Math.floor((new Date()-new Date(d))/86400000);if(diff<1)return'Today';if(diff<7)return'This Week';if(diff<30)return'This Month';return'Older';};const dateField=sortVal==='completed'?t.completedAt:t.created;const ag=ageGrp(dateField);if(ag!==lastGroup){const cnt=items.filter(x=>ageGrp(sortVal==='completed'?x.completedAt:x.created)===ag).length;const clr=sortVal==='completed'?'var(--accent)':'var(--yellow)';hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:${clr};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${sortVal==='completed'?'Completed ':''}${ag} (${cnt})</div>`;lastGroup=ag;}}if(sortVal==='tag'){const tg=(t.tags&&t.tags[0])||'Untagged';if(tg!==lastGroup){const cnt=items.filter(x=>((x.tags&&x.tags[0])||'Untagged')===tg).length;hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${esc(tg)} (${cnt})</div>`;lastGroup=tg;}}if(sortVal==='alpha'){const letter=(t.title||'Untitled')[0].toUpperCase();if(letter!==lastGroup){const cnt=items.filter(x=>((x.title||'Untitled')[0].toUpperCase())===letter).length;hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${letter} (${cnt})</div>`;lastGroup=letter;}}return hdr+`<div class="task-row ${t.status==='done'?'completed':''} priority-${t.priority||'p2'}${t.due&&t.due<today&&t.status!=='done'?' overdue':''}${t.status==='blocked'?' blocked-row':''}${t.status==='progress'?' in-progress-row':''}" data-id="${t.id}" draggable="true" ondragstart="taskDragStart(event,${t.id})" ondragover="taskDragOver(event)" ondragleave="taskDragLeave(event)" ondrop="taskDrop(event,${t.id})">${taskBulkMode?`<div style="padding:0 4px;cursor:pointer" onclick="toggleTaskSelect(${t.id});this.querySelector('input').checked=taskSelected.has(${t.id})"><input type="checkbox" ${taskSelected.has(t.id)?'checked':''} style="pointer-events:none;cursor:pointer"></div>`:''}<div class="task-checkbox ${t.status==='done'?'checked':''}" onclick="toggleTask(${t.id})"></div><div><input type="text" class="task-title-input" value="${escA(t.title)}" onchange="updateTask(${t.id},'title',this.value)" ondblclick="openTaskDetail(${t.id})" placeholder="Task name..." title="${t.created?'Created '+timeAgo(t.created)+' | ':''} Double-click for details">${t.recurrence?`<span style="font-size:7px;color:var(--accent-cyan);margin-left:3px;font-family:var(--mono)" title="Repeats ${t.recurrence}">r</span>`:''}${(t.subtasks&&t.subtasks.length)?`<span style="font-size:8px;color:${t.subtasks.filter(s=>s.done).length===t.subtasks.length?'var(--accent)':'var(--text-muted)'};font-family:var(--mono);margin-left:4px" title="Subtasks">${t.subtasks.filter(s=>s.done).length}/${t.subtasks.length}</span>`:''}${t.estimate?`<span style="font-size:8px;color:var(--accent-cyan);font-family:var(--mono);margin-left:4px">${esc(t.estimate)}</span>`:''}${t.timeSpent||t.timeStarted?`<span style="font-size:8px;color:${t.timeStarted?'var(--green)':'var(--text-muted)'};font-family:var(--mono);margin-left:4px">${t.timeStarted?'...':formatTimeSpent(t.timeSpent)}</span>`:''}${(t.tags&&t.tags.length)?t.tags.slice(0,3).map(tag=>`<span style="font-size:7px;padding:0 3px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:2px;color:var(--text-muted);font-family:var(--mono);margin-left:3px">${esc(tag)}</span>`).join('')+(t.tags.length>3?`<span style="font-size:7px;color:var(--text-muted);margin-left:2px">+${t.tags.length-3}</span>`:''):''}</div><div><select class="task-select" onchange="updateTask(${t.id},'status',this.value)"><option value="todo" ${t.status==='todo'?'selected':''}>To Do</option><option value="progress" ${t.status==='progress'?'selected':''}>In Progress</option><option value="done" ${t.status==='done'?'selected':''}>Done</option><option value="blocked" ${t.status==='blocked'?'selected':''}>Blocked</option></select></div><div><select class="task-select" onchange="updateTask(${t.id},'priority',this.value)"><option value="p0" ${t.priority==='p0'?'selected':''}>P0 Critical</option><option value="p1" ${t.priority==='p1'?'selected':''}>P1 High</option><option value="p2" ${t.priority==='p2'?'selected':''}>P2 Medium</option><option value="p3" ${t.priority==='p3'?'selected':''}>P3 Low</option></select></div><div><input type="text" class="task-select" style="border:1px solid transparent" value="${escA(t.project||'')}" onchange="updateTask(${t.id},'project',this.value)" placeholder="Project..." list="pdl"></div><div style="display:flex;align-items:center;gap:3px"><input type="date" class="task-select" value="${t.due||''}" onchange="updateTask(${t.id},'due',this.value)" style="color:${t.due&&t.due<today&&t.status!=='done'?'var(--red)':t.due===today?'var(--accent)':t.due&&t.due<=new Date(new Date().getTime()+3*86400000).toISOString().split('T')[0]?'var(--yellow)':''}">${t.due&&t.status!=='done'?`<span style="font-size:7px;font-family:var(--mono);color:${t.due<today?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'};white-space:nowrap">${relativeDate(t.due)}</span>`:''}</div><div class="task-actions"><button class="task-action-btn" onclick="openTaskDetail(${t.id})" title="Details" style="font-size:10px">...</button><button class="task-action-btn del" onclick="deleteTask(${t.id})">x</button></div></div>`;}).join('')+`<div class="add-task-row" style="display:flex;align-items:center;gap:6px;padding:6px 8px"><input type="text" id="task-quick-add" placeholder="+ Quick add task... (Enter to add)" style="flex:1;font-size:11px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;color:var(--text);outline:none;font-family:var(--font)" onkeydown="if(event.key==='Enter'&&this.value.trim()){quickAddTask(this.value.trim());this.value='';event.preventDefault();}"><button class="btn btn-sm btn-ghost" onclick="addTask()" title="Add task with full details" style="font-size:9px;padding:2px 6px">Full</button></div>`;

  const pMap={p0:0,p1:1,p2:2,p3:3};
  ['todo','progress','done','blocked'].forEach(st=>{
    const col=document.getElementById('board-'+st),cnt=document.getElementById('bc-'+st),f=items.filter(t=>t.status===st).sort((a,b)=>(pMap[a.priority]||2)-(pMap[b.priority]||2));
    const totalTime=f.reduce((a,t)=>a+(t.timeSpent||0),0);
    cnt.textContent=f.length+(totalTime?' ('+formatTimeSpent(totalTime)+')':'');
    const wipLimit=st==='progress'?5:0;
    if(wipLimit&&f.length>wipLimit){cnt.style.color='var(--red)';cnt.title='WIP limit: '+wipLimit;}else{cnt.style.color='';cnt.title=f.length+' tasks'+(totalTime?', '+formatTimeSpent(totalTime)+' tracked':'');};
    col.innerHTML=f.length?f.map(t=>{const st=t.subtasks||[],stDone=st.filter(s=>s.done).length,stTotal=st.length;return `<div class="board-card" draggable="true" ondragstart="boardDragStart(event,${t.id})" onclick="openTaskDetail(${t.id})"><div class="board-card-title" title="${t.created?'Created '+timeAgo(t.created):''}${t.description?'\n'+escA(t.description.substring(0,120)):''}">${esc(t.title||'Untitled')}</div>${(t.labels&&t.labels.length)?`<div style="display:flex;gap:3px;margin-bottom:3px">${t.labels.map(c=>`<div style="width:8px;height:8px;border-radius:50%;background:${c}"></div>`).join('')}</div>`:''}${t.description?`<div class="board-card-desc">${esc(t.description)}</div>`:''}${stTotal?`<div class="board-card-subtasks"><span class="done">${stDone}</span>/${stTotal} subtasks<div style="width:100%;height:2px;background:var(--border);border-radius:1px;margin-top:3px"><div style="width:${Math.round(stDone/stTotal*100)}%;height:100%;background:var(--accent);border-radius:1px;transition:width 0.3s"></div></div></div>`:''}<div class="board-card-meta"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}" onclick="event.stopPropagation();cyclePriority(${t.id})" style="cursor:pointer" title="Click to cycle priority">${t.priority||'p3'}</span>${t.project?`<span class="badge badge-blue" style="cursor:pointer" onclick="event.stopPropagation();taskProjectFilter='${escA(t.project)}';renderTasks();toast('Filtered: ${escA(t.project)}')">${esc(t.project)}</span>`:''}${t.due?`<span style="font-size:9px;color:${t.due<today&&t.status!=='done'?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'};font-family:var(--mono)" title="${t.due}">${relativeDate(t.due)}${t.due<today&&t.status!=='done'?' !':''}</span>`:''}${t.recurrence?`<span style="font-size:8px;color:var(--accent-cyan)" title="Repeats ${t.recurrence}">r</span>`:''}${t.blockedBy?`<span style="font-size:8px;color:var(--red)" title="Blocked by: ${escA(t.blockedBy)}">B</span>`:''}${t.estimate?`<span style="font-size:8px;color:var(--accent-cyan);font-family:var(--mono)" title="Estimate">${esc(t.estimate)}</span>`:''}${t.timeSpent?`<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)" title="Time tracked">${formatTimeSpent(t.timeSpent)}</span>`:''}</div>${(t.tags&&t.tags.length)?`<div style="display:flex;flex-wrap:wrap;gap:2px;margin-top:3px">${t.tags.map(tag=>`<span style="font-size:7px;padding:1px 4px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:2px;color:var(--text-muted);font-family:var(--mono)">${esc(tag)}</span>`).join('')}</div>`:''}</div>`;}).join(''):'<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:10px;opacity:0.5">Drop tasks here</div>';
  });
  const activeTasks=S.tasks.filter(t=>t.status!=='done').length;
  const doneTasks=S.tasks.filter(t=>t.status==='done').length;
  document.getElementById('tasks-count').textContent=activeTasks;
  document.getElementById('tasks-count').title=activeTasks+' active, '+doneTasks+' done ('+S.tasks.length+' total)';
  const taskCountInfo=document.getElementById('task-count-info');if(taskCountInfo){const filtered=items.length;const total=S.tasks.length;taskCountInfo.textContent=filtered!==total?'Showing '+filtered+' of '+total:'';}
  const cfBtn=document.getElementById('task-clear-filters');if(cfBtn){const hasFilter=taskFilter!=='all'||taskProjectFilter||(document.getElementById('task-search')?.value)||((document.getElementById('task-sort')?.value||'manual')!=='manual');cfBtn.style.display=hasFilter?'inline-block':'none';}
  const acEl=document.getElementById('archived-count');if(acEl)acEl.textContent=(S.archivedTasks||[]).length||'';
  if(!document.getElementById('pdl')){const dl=document.createElement('datalist');dl.id='pdl';document.body.appendChild(dl);}
  document.getElementById('pdl').innerHTML=projects.map(p=>`<option value="${p}">`).join('');
  const tpf=document.getElementById('task-project-filter');if(tpf){tpf.innerHTML='<option value="">All Projects</option>'+projects.map(p=>`<option value="${escA(p)}" ${taskProjectFilter===p?'selected':''}>${esc(p)}</option>`).join('');}
  updateSidebarCtx();
  if(taskView==='eisenhower')renderEisenhower();
}

function addTask(){S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p1',project:taskProjectFilter||'',due:new Date().toISOString().split('T')[0],created:new Date().toISOString()});save();renderTasks();setTimeout(()=>{const i=document.querySelector('.task-title-input');if(i)i.focus();},50);}
function quickAddTask(text){
  const parts=text.match(/^(.+?)(?:\s+#(\S+))?(?:\s+@(\S+))?(?:\s+!([0-3]))?(?:\s+~(\S+))?$/);
  const title=parts?parts[1].trim():text;
  const tag=parts&&parts[2]?parts[2]:null;
  const project=parts&&parts[3]?parts[3]:taskProjectFilter||'';
  const priority=parts&&parts[4]?'p'+parts[4]:'p2';
  const dateRaw=parts&&parts[5]?parts[5]:null;
  const due=dateRaw?parseNaturalDate(dateRaw):'';
  const t={id:Date.now(),title,description:'',subtasks:[],status:'todo',priority,project,due:due||'',tags:tag?[tag]:[],created:new Date().toISOString()};
  S.tasks.unshift(t);save();renderTasks();toast('Added: '+title+(due?' (due: '+due+')':''));
}
function addTaskFromTemplate(title,priority,recurrence){S.tasks.unshift({id:Date.now(),title,description:'',subtasks:[],status:'todo',priority:priority||'p2',project:taskProjectFilter||'',due:new Date().toISOString().split('T')[0],recurrence:recurrence||'',created:new Date().toISOString()});save();renderTasks();toast('Added: '+title);document.querySelectorAll('.btn-group div[style*="display: block"],.btn-group div[style*="display:block"]').forEach(d=>d.style.display='none');}
function updateTask(id,f,v){const t=S.tasks.find(x=>x.id===id);if(t){if(f==='status'&&v==='progress'&&!t.timeStarted)t.timeStarted=new Date().toISOString();if(f==='status'&&v!=='progress'&&t.timeStarted){t.timeSpent=(t.timeSpent||0)+Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);t.timeStarted=null;}if(f==='status'&&t.status!==v){if(!t.log)t.log=[];t.log.push({from:t.status,to:v,at:new Date().toISOString()});if(t.log.length>20)t.log=t.log.slice(-20);if(v==='done')t.completedAt=new Date().toISOString();else if(t.status==='done')delete t.completedAt;}t[f]=v;save();renderTasks();}}
function toggleTask(id){const t=S.tasks.find(x=>x.id===id);if(t){const wasDone=t.status==='done';t.status=wasDone?'todo':'done';if(!wasDone)t.completedAt=new Date().toISOString();else delete t.completedAt;if(!wasDone&&t.recurrence&&t.due){const nd=getNextRecurDate(t.due,t.recurrence);S.tasks.unshift({id:Date.now(),title:t.title,description:t.description||'',subtasks:(t.subtasks||[]).map(s=>({...s,done:false})),status:'todo',priority:t.priority,project:t.project,due:nd,recurrence:t.recurrence,created:new Date().toISOString()});t.lastRecurred=new Date().toISOString().split('T')[0];toast('Recurring task created for '+nd);}save();renderTasks();}}
function getNextRecurDate(dateStr,recur){const d=new Date(dateStr+'T12:00:00');if(recur==='daily')d.setDate(d.getDate()+1);else if(recur==='weekday'){d.setDate(d.getDate()+1);while(d.getDay()===0||d.getDay()===6)d.setDate(d.getDate()+1);}else if(recur==='weekly')d.setDate(d.getDate()+7);else if(recur==='biweekly')d.setDate(d.getDate()+14);else if(recur==='monthly')d.setMonth(d.getMonth()+1);return d.toISOString().split('T')[0];}
function parseNaturalDate(text){
  if(!text||/^\d{4}-\d{2}-\d{2}$/.test(text))return text;
  const t=text.toLowerCase().trim();const now=new Date();
  if(t==='today')return now.toISOString().split('T')[0];
  if(t==='tomorrow'||t==='tmrw'||t==='tom'){now.setDate(now.getDate()+1);return now.toISOString().split('T')[0];}
  if(t==='next week'){now.setDate(now.getDate()+7);return now.toISOString().split('T')[0];}
  if(t==='next month'){now.setMonth(now.getMonth()+1);return now.toISOString().split('T')[0];}
  const days=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const dIdx=days.findIndex(d=>t.startsWith(d.substring(0,3)));
  if(dIdx>=0){const curr=now.getDay();let diff=dIdx-curr;if(diff<=0)diff+=7;now.setDate(now.getDate()+diff);return now.toISOString().split('T')[0];}
  const match=t.match(/^(\d+)\s*(d|day|w|week|m|month)/);
  if(match){const n=parseInt(match[1]);const unit=match[2][0];if(unit==='d')now.setDate(now.getDate()+n);else if(unit==='w')now.setDate(now.getDate()+n*7);else if(unit==='m')now.setMonth(now.getMonth()+n);return now.toISOString().split('T')[0];}
  return text;
}
function relativeDate(dateStr){
  if(!dateStr)return '';
  const today=new Date();today.setHours(0,0,0,0);
  const d=new Date(dateStr+'T12:00:00');d.setHours(0,0,0,0);
  const diff=Math.round((d-today)/(86400000));
  if(diff===0)return 'today';if(diff===1)return 'tmrw';if(diff===-1)return 'yday';
  if(diff>1&&diff<=7)return diff+'d';if(diff>7)return dateStr.substring(5);
  return Math.abs(diff)+'d ago';
}
function deleteTask(id){S.tasks=S.tasks.filter(t=>t.id!==id);save();renderTasks();toast('Deleted');}
function cyclePriority(id){const t=S.tasks.find(x=>x.id===id);if(!t)return;const order=['p0','p1','p2','p3'];const cur=order.indexOf(t.priority||'p2');t.priority=order[(cur+1)%order.length];save();renderTasks();toast(t.priority.toUpperCase());}
function archiveCompletedTasks(){
  const done=S.tasks.filter(t=>t.status==='done');
  if(!done.length){toast('No completed tasks to archive');return;}
  if(!confirm('Archive '+done.length+' completed tasks? They will be moved to a hidden archive.'))return;
  if(!S.archivedTasks)S.archivedTasks=[];
  S.archivedTasks=done.concat(S.archivedTasks);
  if(S.archivedTasks.length>500)S.archivedTasks.length=500;
  S.tasks=S.tasks.filter(t=>t.status!=='done');
  save();renderTasks();toast('Archived '+done.length+' tasks');
}
function showArchivedTasks(){
  const archived=S.archivedTasks||[];
  if(!archived.length){toast('No archived tasks');return;}
  const rows=document.getElementById('task-rows');
  document.getElementById('task-list-view').style.display='block';
  document.getElementById('task-board-view').classList.remove('active');
  rows.innerHTML='<div style="padding:8px 0;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:8px"><span>Archived Tasks ('+archived.length+')</span><button class="btn btn-sm btn-ghost" onclick="renderTasks()" style="font-size:8px;padding:1px 6px">Back to active</button></div>'+archived.slice(0,50).map(t=>`<div class="task-row completed priority-${t.priority||'p2'}" style="opacity:0.6"><div class="task-checkbox checked"></div><div><span style="font-size:12px;color:var(--text-secondary);text-decoration:line-through">${esc(t.title||'Untitled')}</span></div><div><span style="font-size:10px;color:var(--text-muted)">${t.project||''}</span></div><div><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':'muted'}" style="font-size:8px">${t.priority||'p3'}</span></div><div><span style="font-size:9px;color:var(--text-muted)">${t.due||''}</span></div><div><span style="font-size:8px;color:var(--text-muted)">${t.created?new Date(t.created).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'?'}</span></div><div class="task-actions" style="opacity:1"><button class="task-action-btn" onclick="restoreArchivedTask(${t.id})" title="Restore" style="font-size:10px;color:var(--accent)">+</button></div></div>`).join('')+(archived.length>50?'<div style="padding:8px;font-size:10px;color:var(--text-muted)">Showing first 50 of '+archived.length+'</div>':'');
}
function taskBulkSelectAll(){const items=getFilteredTasks();items.forEach(t=>taskSelected.add(t.id));renderTasks();}
function restoreArchivedTask(id){
  const idx=(S.archivedTasks||[]).findIndex(t=>t.id===id);
  if(idx<0)return;
  const t=S.archivedTasks.splice(idx,1)[0];
  t.status='todo';
  S.tasks.unshift(t);
  save();renderTasks();toast('Restored: '+(t.title||'task'));
}

let taskBulkMode=false,taskSelected=new Set();
function toggleTaskBulk(){taskBulkMode=!taskBulkMode;taskSelected.clear();document.getElementById('task-bulk-btn').style.display=taskBulkMode?'none':'';document.getElementById('task-bulk-actions').style.display=taskBulkMode?'flex':'none';renderTasks();}
function toggleTaskSelect(id){if(taskSelected.has(id))taskSelected.delete(id);else taskSelected.add(id);}
function taskBulkApply(){
  const status=document.getElementById('task-bulk-status').value;
  const priority=document.getElementById('task-bulk-priority').value;
  const due=document.getElementById('task-bulk-due').value;
  if(!status&&!priority&&!due){toast('Select a status, priority, or due date to apply');return;}
  let count=0;
  taskSelected.forEach(id=>{const t=S.tasks.find(x=>x.id===id);if(t){if(status)t.status=status;if(priority)t.priority=priority;if(due)t.due=due;count++;}});
  save();taskSelected.clear();taskBulkMode=false;document.getElementById('task-bulk-btn').style.display='';document.getElementById('task-bulk-actions').style.display='none';renderTasks();toast('Updated '+count+' tasks');
}
function taskBulkTag(){
  if(!taskSelected.size){toast('No tasks selected');return;}
  const allTags=[...new Set(S.tasks.flatMap(t=>t.tags||[]))].sort();
  const tag=prompt('Tag to add to '+taskSelected.size+' tasks:'+(allTags.length?'\nExisting: '+allTags.join(', '):''));
  if(!tag||!tag.trim())return;const v=tag.trim().toLowerCase();
  S.tasks.forEach(t=>{if(taskSelected.has(t.id)){if(!t.tags)t.tags=[];if(!t.tags.includes(v))t.tags.push(v);}});
  save();renderTasks();toast('Tagged '+taskSelected.size+' tasks with "'+v+'"');
}
function taskBulkDelete(){
  if(!taskSelected.size){toast('No tasks selected');return;}
  if(!confirm('Delete '+taskSelected.size+' tasks?'))return;
  S.tasks=S.tasks.filter(t=>!taskSelected.has(t.id));save();taskSelected.clear();taskBulkMode=false;document.getElementById('task-bulk-btn').style.display='';document.getElementById('task-bulk-actions').style.display='none';renderTasks();toast('Deleted');
}
function taskBulkMove(){
  if(!taskSelected.size){toast('No tasks selected');return;}
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  const target=prompt('Move '+taskSelected.size+' tasks to project:\n\n'+projects.map((p,i)=>(i+1)+'. '+p).join('\n')+'\n\nType project name:');
  if(!target||!target.trim())return;
  let count=0;
  S.tasks.forEach(t=>{if(taskSelected.has(t.id)){t.project=target.trim();count++;}});
  save();taskSelected.clear();taskBulkMode=false;document.getElementById('task-bulk-btn').style.display='';document.getElementById('task-bulk-actions').style.display='none';renderTasks();toast('Moved '+count+' tasks to '+target.trim());
}
function taskManageTags(){
  const allTags=[...new Set(S.tasks.flatMap(t=>t.tags||[]).filter(Boolean))].sort();
  if(!allTags.length){toast('No tags on any tasks');return;}
  const action=prompt('Task Tag Management\n\nTags: '+allTags.join(', ')+'\n\nCommands:\n- rename:oldtag:newtag\n- delete:tagname\n- merge:tag1:tag2 (merge tag1 into tag2)');
  if(!action)return;
  if(action.startsWith('rename:')){const parts=action.split(':');if(parts.length===3){const old=parts[1].trim(),nw=parts[2].trim();let count=0;S.tasks.forEach(t=>{if(t.tags){const i=t.tags.indexOf(old);if(i>=0){t.tags[i]=nw;count++;}}});save();renderTasks();toast('Renamed "'+old+'" to "'+nw+'" in '+count+' tasks');}}
  else if(action.startsWith('delete:')){const tag=action.substring(7).trim();let count=0;S.tasks.forEach(t=>{if(t.tags){const i=t.tags.indexOf(tag);if(i>=0){t.tags.splice(i,1);count++;}}});save();renderTasks();toast('Removed "'+tag+'" from '+count+' tasks');}
  else if(action.startsWith('merge:')){const parts=action.split(':');if(parts.length===3){const from=parts[1].trim(),to=parts[2].trim();let count=0;S.tasks.forEach(t=>{if(t.tags){const i=t.tags.indexOf(from);if(i>=0){t.tags.splice(i,1);if(!t.tags.includes(to))t.tags.push(to);count++;}}});save();renderTasks();toast('Merged "'+from+'" into "'+to+'" in '+count+' tasks');}}
  else{toast('Use rename:old:new, delete:tag, or merge:tag1:tag2');}
}
function exportTasks(){
  const items=getFilteredTasks();
  const today=new Date().toISOString().split('T')[0];
  let md='# Tasks Export\n';
  md+='Generated: '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n\n';
  const groups={};
  items.forEach(t=>{const g=t.project||'No Project';if(!groups[g])groups[g]=[];groups[g].push(t);});
  Object.keys(groups).sort().forEach(g=>{
    md+='## '+g+'\n';
    groups[g].forEach(t=>{
      const check=t.status==='done'?'x':' ';
      md+='- ['+check+'] '+t.title+(t.priority==='p0'?' [CRITICAL]':t.priority==='p1'?' [HIGH]':'')+(t.due?' (due '+t.due+')':'')+(t.due&&t.due<today&&t.status!=='done'?' OVERDUE':'')+'\n';
      if(t.description)md+='  '+t.description.substring(0,100)+'\n';
      (t.subtasks||[]).forEach(s=>{md+='  - ['+(s.done?'x':' ')+'] '+s.title+'\n';});
    });
    md+='\n';
  });
  navigator.clipboard.writeText(md).then(()=>toast('Tasks copied as markdown')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tasks-'+today+'.md';a.click();toast('Tasks exported');
  });
}

function exportTasksCSV(){
  const csvEsc=s=>{s=String(s||'').replace(/"/g,'""');return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s+'"':s;};
  const headers=['Title','Status','Priority','Project','Due','Description','Tags','Created','Estimate','Time Spent','Subtasks'];
  const rows=[headers.join(',')];
  S.tasks.forEach(t=>{
    rows.push([csvEsc(t.title),csvEsc(t.status),csvEsc(t.priority),csvEsc(t.project),csvEsc(t.due),csvEsc(t.description),csvEsc((t.tags||[]).join(';')),csvEsc(t.created?t.created.split('T')[0]:''),csvEsc(t.estimate),csvEsc(t.timeSpent?t.timeSpent+'m':''),csvEsc((t.subtasks||[]).map(s=>(s.done?'[x]':'[ ]')+s.title).join('; '))].join(','));
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tasks-'+new Date().toISOString().split('T')[0]+'.csv';a.click();toast('Exported '+S.tasks.length+' tasks as CSV');
}
// Task drag reorder
let taskDragId=null;
function taskDragStart(e,id){taskDragId=id;e.dataTransfer.effectAllowed='move';}
function taskDragOver(e){e.preventDefault();e.currentTarget.classList.add('dragging-over');}
function taskDragLeave(e){e.currentTarget.classList.remove('dragging-over');}
function taskDrop(e,targetId){e.preventDefault();e.currentTarget.classList.remove('dragging-over');if(!taskDragId||taskDragId===targetId)return;const fi=S.tasks.findIndex(t=>t.id===taskDragId),ti=S.tasks.findIndex(t=>t.id===targetId);if(fi<0||ti<0)return;const[item]=S.tasks.splice(fi,1);S.tasks.splice(ti,0,item);taskDragId=null;save();renderTasks();}

// Board drag
let boardDragId=null;
function boardDragStart(e,id){boardDragId=id;e.dataTransfer.effectAllowed='move';}
function boardDrop(e,status){e.preventDefault();if(boardDragId){const t=S.tasks.find(x=>x.id===boardDragId);if(t){t.status=status;save();renderTasks();}boardDragId=null;}}
function boardMoveAll(fromStatus){
  const targets=['todo','progress','done','blocked'].filter(s=>s!==fromStatus);
  const to=prompt('Move all "'+fromStatus+'" tasks to:\n'+targets.join(', '));
  if(!to||!targets.includes(to))return;
  const items=getFilteredTasks().filter(t=>t.status===fromStatus);
  if(!items.length){toast('No tasks to move');return;}
  items.forEach(t=>{if(!t.log)t.log=[];t.log.push({from:t.status,to,at:new Date().toISOString()});t.status=to;});
  save();renderTasks();toast('Moved '+items.length+' tasks to '+to);
}

// Task Detail Modal
let taskDetailId = null;
function openTaskDetail(id) {
  const t = S.tasks.find(x=>x.id===id);
  if(!t) return;
  taskDetailId = id;
  document.getElementById('td-title').value = t.title || '';
  document.getElementById('td-desc').value = t.description || '';
  document.getElementById('td-status').value = t.status || 'todo';
  document.getElementById('td-priority').value = t.priority || 'p2';
  document.getElementById('td-project').value = t.project || '';
  document.getElementById('td-due').value = t.due || '';
  document.getElementById('td-recur').value = t.recurrence || '';
  document.getElementById('td-blocked-by').value = t.blockedBy || '';
  document.getElementById('td-estimate').value = t.estimate || '';
  document.getElementById('td-notes').value = t.notes || '';
  const nc=document.getElementById('td-notes-count');if(nc)nc.textContent=(t.notes||'').trim()?'('+countW(t.notes)+' words)':'';
  document.getElementById('td-recur-info').textContent = t.recurrence ? 'Repeats ' + t.recurrence + (t.lastRecurred ? ' (last: ' + t.lastRecurred + ')' : '') : '';
  let timeText=t.created ? 'Created: ' + new Date(t.created).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' ('+timeAgo(t.created)+')' : '';
  if(t.completedAt)timeText+=' | Done: '+new Date(t.completedAt).toLocaleDateString('en-US',{month:'short',day:'numeric'})+' ('+timeAgo(t.completedAt)+')';
  if(t.timeSpent)timeText+=' | Time: '+formatTimeSpent(t.timeSpent);
  if(t.timeStarted)timeText+=' | Started: '+timeAgo(t.timeStarted);
  document.getElementById('td-created').textContent = timeText;
  const logEl=document.getElementById('td-log');
  if(logEl&&t.log&&t.log.length){const sClr={todo:'var(--accent-cyan)',progress:'var(--green)',done:'var(--accent)',blocked:'var(--orange)'};logEl.innerHTML='<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Activity ('+t.log.length+')</div>'+t.log.slice(-8).reverse().map(e=>`<div style="font-size:8px;padding:2px 0;font-family:var(--mono);display:flex;align-items:center;gap:4px"><span style="width:4px;height:4px;border-radius:50%;background:${sClr[e.to]||'var(--text-muted)'};flex-shrink:0"></span><span style="color:${sClr[e.from]||'var(--text-muted)'}">${e.from}</span><span style="color:var(--text-muted)">-></span><span style="color:${sClr[e.to]||'var(--text-muted)'}">${e.to}</span><span style="color:var(--text-muted);opacity:0.5;margin-left:auto;font-size:7px">${timeAgo(e.at)}</span></div>`).join('');}else if(logEl){logEl.innerHTML='';}
  renderTaskTags(t);
  renderSubtasksInModal(t.subtasks || []);
  renderTaskLabels(t);
  updateTimerBtn(t);
  const ubBtn=document.getElementById('td-unblock-btn');if(ubBtn)ubBtn.style.display=(t.status==='blocked'||t.blockedBy)?'inline-block':'none';
  document.getElementById('task-detail-modal').classList.add('open');
  setTimeout(()=>document.getElementById('td-title').focus(),100);
}
function renderTaskTags(t){const el=document.getElementById('td-tags');if(!el)return;const tags=t.tags||[];el.innerHTML=tags.map(tag=>`<span style="display:inline-flex;align-items:center;gap:2px;padding:2px 6px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px;font-size:9px;color:var(--text-muted);font-family:var(--mono)">${esc(tag)}<span onclick="removeTaskTag('${escA(tag)}')" style="cursor:pointer;color:var(--red);margin-left:2px;font-size:8px">x</span></span>`).join('')+`<span onclick="addTaskTag()" style="cursor:pointer;font-size:9px;color:var(--accent);padding:2px 4px">+ tag</span>`;}
function addTaskTag(){const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;const allTags=[...new Set(S.tasks.flatMap(x=>x.tags||[]))].sort();const tag=prompt('Tag:'+((allTags.length)?'\nExisting: '+allTags.join(', '):''));if(!tag||!tag.trim())return;if(!t.tags)t.tags=[];const v=tag.trim().toLowerCase();if(!t.tags.includes(v)){t.tags.push(v);save();renderTaskTags(t);toast('Tag added: '+v);}}
function removeTaskTag(tag){const t=S.tasks.find(x=>x.id===taskDetailId);if(!t||!t.tags)return;t.tags=t.tags.filter(x=>x!==tag);save();renderTaskTags(t);}
function renderTaskLabels(t){const el=document.getElementById('td-labels');if(!el)return;const colors=['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899','#06b6d4'];el.innerHTML=colors.map(c=>{const active=(t.labels||[]).includes(c);return `<div onclick="addTaskColorLabel(${t.id},'${c}')" style="width:20px;height:20px;border-radius:50%;background:${c};cursor:pointer;border:2px solid ${active?'white':'transparent'};opacity:${active?1:0.4};transition:all 0.15s" title="${active?'Remove':'Add'} label"></div>`;}).join('');}
function unblockTask(){const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;t.blockedBy='';if(t.status==='blocked')t.status='todo';document.getElementById('td-blocked-by').value='';document.getElementById('td-status').value=t.status;document.getElementById('td-unblock-btn').style.display='none';save();renderTasks();toast('Unblocked');}
function formatTimeSpent(mins){if(mins<60)return mins+'m';const h=Math.floor(mins/60);const m=mins%60;return h+'h'+(m?' '+m+'m':'');}
function tdSetDue(days){const d=new Date();d.setDate(d.getDate()+days);document.getElementById('td-due').value=d.toISOString().split('T')[0];}
function closeTaskDetail() {
  document.getElementById('task-detail-modal').classList.remove('open');
  taskDetailId = null;
}
function renderSubtasksInModal(subtasks) {
  const el = document.getElementById('td-subtasks');
  const st=subtasks||[];
  const done=st.filter(s=>s.done).length;
  const lbl=document.getElementById('td-subtasks-label');
  if(lbl)lbl.textContent=st.length?'Subtasks ('+done+'/'+st.length+')':'Subtasks';
  el.innerHTML = st.map((s,i) => `<div class="td-subtask">
    <input type="checkbox" ${s.done?'checked':''} onchange="toggleSubtaskInModal(${i},this.checked)">
    <input type="text" value="${escA(s.title)}" onchange="renameSubtaskInModal(${i},this.value)" placeholder="Subtask...">
    <span class="del" onclick="removeSubtaskInModal(${i})">x</span>
  </div>`).join('');
}
function addSubtaskInModal() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  if(!t.subtasks) t.subtasks = [];
  t.subtasks.push({id:Date.now(), title:'', done:false});
  renderSubtasksInModal(t.subtasks);
  const inputs = document.querySelectorAll('#td-subtasks input[type=text]');
  if(inputs.length) inputs[inputs.length-1].focus();
}
function toggleSubtaskInModal(i,done) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks && t.subtasks[i]) t.subtasks[i].done = done;
}
function renameSubtaskInModal(i,val) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks && t.subtasks[i]) t.subtasks[i].title = val;
}
function removeSubtaskInModal(i) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks) { t.subtasks.splice(i,1); renderSubtasksInModal(t.subtasks); }
}
function saveTaskDetail() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  t.title = document.getElementById('td-title').value.trim();
  t.description = document.getElementById('td-desc').value.trim();
  t.status = document.getElementById('td-status').value;
  t.priority = document.getElementById('td-priority').value;
  t.project = document.getElementById('td-project').value.trim();
  t.due = document.getElementById('td-due').value;
  t.recurrence = document.getElementById('td-recur').value || '';
  t.blockedBy = document.getElementById('td-blocked-by').value.trim() || '';
  t.estimate = document.getElementById('td-estimate').value.trim() || '';
  t.notes = document.getElementById('td-notes').value.trim() || '';
  // Link to project ID if name matches
  if(t.project) { const p = (S.projects||[]).find(pr => pr.name === t.project); if(p) t.projectId = p.id; }
  save(); closeTaskDetail(); renderTasks();
  if(activeProject) renderProjTasks();
  toast('Task saved');
}
function deleteTaskFromDetail() {
  if(!taskDetailId) return;
  if(!confirm('Delete this task?')) return;
  S.tasks = S.tasks.filter(t=>t.id!==taskDetailId);
  save(); closeTaskDetail(); renderTasks();
  if(activeProject) renderProjTasks();
  toast('Task deleted');
}
function duplicateTask() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  const dup = {...t, id:Date.now(), title:(t.title||'')+ ' (copy)', subtasks:(t.subtasks||[]).map(s=>({...s,id:Date.now()+Math.random()*1000,done:false})), status:'todo', created:new Date().toISOString()};
  S.tasks.unshift(dup);
  save(); closeTaskDetail(); renderTasks();
  toast('Task duplicated');
}
function taskToContent(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  let body=t.title||'Untitled Task';
  if(t.description)body+='\n\n'+t.description;
  if(t.subtasks&&t.subtasks.length)body+='\n\nSubtasks:\n'+t.subtasks.map(s=>(s.done?'[x] ':'[ ] ')+s.title).join('\n');
  S.content.unshift({id:Date.now(),body,type:'caption',theme:t.project||'tasks',tags:['from-task',t.priority||'p2'].filter(Boolean),source:'task-convert',created:new Date().toISOString()});
  save();closeTaskDetail();if(currentSection==='content')renderContent();toast('Saved to Content');
}
function taskToSpec(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  snapshotSpec();const now=Date.now();
  const sections=[{id:'sec_'+(now+1),title:'Overview',body:'<p>'+(t.description||t.title||'')+'</p>',collapsed:false}];
  if(t.subtasks&&t.subtasks.length)sections.push({id:'sec_'+(now+2),title:'Subtasks',body:'<ul>'+t.subtasks.map(s=>'<li>'+(s.done?'<s>':'')+esc(s.title)+(s.done?'</s>':'')+'</li>').join('')+'</ul>',collapsed:false});
  sections.push({id:'sec_'+(now+3),title:'Notes',body:'',collapsed:false});
  const s={id:now,title:t.title||'Untitled Spec',sections,created:new Date().toISOString(),updated:new Date().toISOString()};
  if(t.project){const proj=(S.projects||[]).find(p=>p.name===t.project);if(proj)s.projectId=proj.id;}
  S.specs.unshift(s);S.activeSpec=s.id;
  save();closeTaskDetail();switchSection('specs',null);renderSpecs();toast('Created spec from task');
}
function taskToDoc(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  let body='<h2>'+esc(t.title||'Untitled')+'</h2>';
  body+='<p><strong>Status:</strong> '+t.status+' | <strong>Priority:</strong> '+(t.priority||'p2');
  if(t.project)body+=' | <strong>Project:</strong> '+esc(t.project);
  if(t.due)body+=' | <strong>Due:</strong> '+t.due;
  body+='</p>';
  if(t.description)body+='<p>'+esc(t.description).replace(/\n/g,'<br>')+'</p>';
  if(t.subtasks&&t.subtasks.length)body+='<h3>Subtasks</h3><ul>'+t.subtasks.map(s=>'<li>'+(s.done?'<s>':'')+esc(s.title)+(s.done?'</s>':'')+'</li>').join('')+'</ul>';
  S.docs.push({id:Date.now(),title:t.title||'Untitled',body,tags:['from-task'],created:new Date().toISOString(),updated:new Date().toISOString(),versions:[]});
  save();closeTaskDetail();switchSection('writer',null);renderWriter();toast('Created doc from task');
}
function copyTaskAsMarkdown(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  let md='## '+esc(t.title||'Untitled')+'\n\n';
  md+='- **Status:** '+t.status+'\n';
  md+='- **Priority:** '+(t.priority||'p2')+'\n';
  if(t.project)md+='- **Project:** '+t.project+'\n';
  if(t.due)md+='- **Due:** '+t.due+'\n';
  if(t.estimate)md+='- **Estimate:** '+t.estimate+'\n';
  if(t.recurrence)md+='- **Recurrence:** '+t.recurrence+'\n';
  if(t.blockedBy)md+='- **Blocked by:** '+t.blockedBy+'\n';
  if(t.timeSpent)md+='- **Time spent:** '+formatTimeSpent(t.timeSpent)+'\n';
  if(t.description)md+='\n'+t.description+'\n';
  if(t.subtasks&&t.subtasks.length){md+='\n### Subtasks\n';t.subtasks.forEach(s=>{md+='- ['+(s.done?'x':' ')+'] '+s.title+'\n';});}
  if(t.log&&t.log.length){md+='\n### Activity\n';t.log.slice(0,10).forEach(l=>{md+='- '+l.from+' -> '+l.to+' ('+timeAgo(l.at)+')\n';});}
  md+='\n*Created: '+(t.created||'unknown')+'*\n';
  if(t.completedAt)md+='*Completed: '+t.completedAt+'*\n';
  navigator.clipboard.writeText(md).then(()=>toast('Task copied as markdown'));
}
function splitTaskSubtasks(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  const subs=(t.subtasks||[]).filter(s=>!s.done);
  if(!subs.length){toast('No incomplete subtasks to split');return;}
  if(!confirm('Create '+subs.length+' new tasks from subtasks?'))return;
  subs.forEach(sub=>{
    const nt={id:Date.now()+Math.random()*1000|0,title:sub.title,description:'Split from: '+t.title,project:t.project||'',priority:t.priority||'p2',status:'todo',due:t.due||'',tags:[...(t.tags||[])],subtasks:[],created:new Date().toISOString()};
    S.tasks.unshift(nt);
  });
  t.subtasks=(t.subtasks||[]).filter(s=>s.done);
  save();renderTasks();renderSubtasksInModal(t.subtasks);toast('Split '+subs.length+' subtasks into tasks');
}
function cloneTaskToProject(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  const projects=[...new Set(S.tasks.map(x=>x.project).filter(Boolean))].sort();
  const current=t.project||'';
  const others=projects.filter(p=>p!==current);
  const target=prompt('Clone task to project:'+(others.length?'\nExisting: '+others.join(', '):'')+'\n\nCurrent: '+(current||'none'));
  if(!target||!target.trim())return;
  const clone={...JSON.parse(JSON.stringify(t)),id:Date.now(),project:target.trim(),created:new Date().toISOString(),status:'todo'};
  delete clone.completedAt;delete clone.timeSpent;delete clone.timeStarted;delete clone.log;
  S.tasks.unshift(clone);save();renderTasks();toast('Cloned to '+target.trim());
}
function snoozeTask(days){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  const base=t.due?new Date(t.due+'T12:00:00'):new Date();
  base.setDate(base.getDate()+days);
  t.due=base.toISOString().split('T')[0];
  document.getElementById('td-due').value=t.due;
  save();renderCalendar();renderTasks();toast('Snoozed to '+t.due);
}
function toggleTaskTimer(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  if(t.timeStarted){
    t.timeSpent=(t.timeSpent||0)+Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);
    t.timeStarted=null;
    save();toast('Timer stopped — '+formatTimeSpent(t.timeSpent)+' total');
  }else{
    t.timeStarted=new Date().toISOString();
    if(t.status==='todo'){t.status='progress';if(!t.log)t.log=[];t.log.push({from:'todo',to:'progress',at:t.timeStarted});}
    save();toast('Timer started');
  }
  updateTimerBtn(t);
}
function updateTimerBtn(t){
  const btn=document.getElementById('td-timer-btn');if(!btn)return;
  if(t.timeStarted){btn.textContent='Stop Timer';btn.style.color='var(--red)';btn.title='Stop time tracking (running since '+timeAgo(t.timeStarted)+')';}
  else{btn.textContent='Start Timer';btn.style.color='';btn.title='Start time tracking'+(t.timeSpent?' ('+formatTimeSpent(t.timeSpent)+' logged)':'');}
}

// === CALENDAR ===
function setCalView(v) {
  calView = v;
  document.getElementById('cal-view-month').classList.toggle('active', v==='month');
  document.getElementById('cal-view-week').classList.toggle('active', v==='week');
  const yearBtn=document.getElementById('cal-view-year');if(yearBtn)yearBtn.classList.toggle('active', v==='year');
  const agendaBtn=document.getElementById('cal-view-agenda');if(agendaBtn)agendaBtn.classList.toggle('active', v==='agenda');
  document.getElementById('cal-grid').style.display = v==='month' ? 'grid' : 'none';
  document.getElementById('cal-week-grid').style.display = v==='week' ? 'grid' : 'none';
  let yearGrid=document.getElementById('cal-year-grid');
  if(!yearGrid){yearGrid=document.createElement('div');yearGrid.id='cal-year-grid';document.getElementById('cal-week-grid').parentElement.appendChild(yearGrid);}
  yearGrid.style.display=v==='year'?'block':'none';
  let agendaGrid=document.getElementById('cal-agenda-grid');
  if(!agendaGrid){agendaGrid=document.createElement('div');agendaGrid.id='cal-agenda-grid';document.getElementById('cal-week-grid').parentElement.appendChild(agendaGrid);}
  agendaGrid.style.display=v==='agenda'?'block':'none';
  if(v==='week' && !calWeekStart) {
    const now = new Date();
    const day = now.getDay();
    const diff = day === 0 ? -6 : 1 - day; // Monday start
    calWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
  }
  renderCalendar();
}
function renderCalTodaySummary(){
  const el=document.getElementById('cal-today-summary');
  const today=new Date().toISOString().split('T')[0];
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  if(!todayTasks.length&&!overdue.length){el.style.display='none';return;}
  el.style.display='block';
  let h='';
  if(overdue.length)h+=`<span style="color:var(--red)">${overdue.length} overdue</span> `;
  if(todayTasks.length)h+=`<span style="color:var(--accent)">${todayTasks.length} today:</span> `;
  h+=todayTasks.slice(0,5).map(t=>`<span style="cursor:pointer;text-decoration:underline dotted;margin:0 4px" onclick="openTaskDetail(${t.id})">${esc(t.title||'Untitled')}</span>`).join(' ');
  if(todayTasks.length>5)h+=` <span style="color:var(--text-muted)">+${todayTasks.length-5} more</span>`;
  el.innerHTML=h;
}
function renderCalUpcoming(){
  const el=document.getElementById('cal-upcoming');if(!el)return;
  const today=new Date().toISOString().split('T')[0];
  const upcoming=S.tasks.filter(t=>t.due&&t.due>=today&&t.status!=='done').sort((a,b)=>a.due.localeCompare(b.due)).slice(0,8);
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done').sort((a,b)=>a.due.localeCompare(b.due));
  if(!upcoming.length&&!overdue.length){el.innerHTML='';return;}
  let h='<div style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:6px">Upcoming</div>';
  const renderRow=(t,isOverdue)=>{const daysLabel=t.due===today?'Today':isOverdue?'Overdue':'';return`<div style="display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:10px" onclick="openTaskDetail(${t.id})" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}" style="font-size:7px;padding:1px 3px;min-width:16px;text-align:center">${t.priority||'p3'}</span><span style="flex:1;color:${isOverdue?'var(--red)':'var(--text-secondary)'}">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${isOverdue?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'};font-family:var(--mono)">${isOverdue?t.due+' !':t.due===today?'today':t.due.substring(5)}</span></div>`;};
  if(overdue.length){h+='<div style="font-size:8px;color:var(--red);margin:4px 0 2px;font-weight:600">OVERDUE</div>';overdue.slice(0,5).forEach(t=>{h+=renderRow(t,true);});}
  upcoming.forEach(t=>{h+=renderRow(t,false);});
  el.innerHTML=h;
}
function renderCalendar(){
  renderCalTodaySummary();renderCalUpcoming();
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  if(calView === 'week') {
    renderWeekView();
    return;
  }
  if(calView === 'year') {
    renderYearHeatmap();
    return;
  }
  if(calView === 'agenda') {
    renderCalAgenda();
    return;
  }
  const monthTaskCount=S.tasks.filter(t=>{if(!t.due)return false;const d=new Date(t.due+'T12:00:00');return d.getMonth()===calMonth&&d.getFullYear()===calYear;}).length;
  document.getElementById('cal-month-label').innerHTML=months[calMonth]+' '+calYear+(monthTaskCount?` <span style="font-size:9px;color:var(--accent);font-family:var(--mono)">${monthTaskCount} tasks</span>`:'');
  const first=new Date(calYear,calMonth,1).getDay();
  const days=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date().toISOString().split('T')[0];
  const prev=new Date(calYear,calMonth,0).getDate();
  let h='';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div class="calendar-day-header">${d}</div>`;});
  for(let i=first-1;i>=0;i--)h+=`<div class="calendar-day other"><div class="calendar-day-num">${prev-i}</div></div>`;
  for(let d=1;d<=days;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=ds===today;
    const dt=S.tasks.filter(t=>t.due===ds);
    const hasOverdue=ds<today&&dt.some(t=>t.status!=='done');
    h+=`<div class="calendar-day ${isToday?'today':''}${hasOverdue?' cal-overdue':''}" onclick="calClickDay('${ds}')" ondragover="event.preventDefault();this.classList.add('cal-drag-over')" ondragleave="this.classList.remove('cal-drag-over')" ondrop="this.classList.remove('cal-drag-over');calDrop(event,'${ds}')"><div class="calendar-day-num">${d}${dt.length?`<span style="font-size:7px;color:${hasOverdue?'var(--red)':'var(--accent)'};font-family:var(--mono);margin-left:3px">${dt.length}</span>`:''}</div>${dt.slice(0,4).map(t=>`<div class="calendar-task-pill pill-${t.priority||'p2'}" draggable="true" ondragstart="calDragStart(event,${t.id})" onclick="event.stopPropagation();openTaskDetail(${t.id})" title="${escA(t.title)}">${esc(t.title||'...')}</div>`).join('')}${dt.length>4?`<div style="font-size:8px;color:var(--text-muted)">+${dt.length-4} more</div>`:''}</div>`;
  }
  const rem=42-(first+days);
  for(let d=1;d<=rem;d++)h+=`<div class="calendar-day other"><div class="calendar-day-num">${d}</div></div>`;
  document.getElementById('cal-grid').innerHTML=h;
}
function renderWeekView() {
  if(!calWeekStart) return;
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const ws = new Date(calWeekStart);
  const we = new Date(ws); we.setDate(we.getDate()+6);
  const label = ws.getMonth()===we.getMonth() ? months[ws.getMonth()]+' '+ws.getFullYear() : months[ws.getMonth()].substring(0,3)+' - '+months[we.getMonth()]+' '+we.getFullYear();
  const oneJan=new Date(ws.getFullYear(),0,1);const weekNum=Math.ceil(((ws-oneJan)/86400000+oneJan.getDay()+1)/7);
  document.getElementById('cal-month-label').innerHTML=label+' <span style="font-size:9px;color:var(--text-muted);font-family:var(--mono)">W'+weekNum+'</span>';
  const today=new Date().toISOString().split('T')[0];
  const dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  let h='';
  for(let i=0;i<7;i++){
    const d=new Date(ws); d.setDate(d.getDate()+i);
    const ds=d.toISOString().split('T')[0];
    const isToday=ds===today;
    const dt=S.tasks.filter(t=>t.due===ds);
    const wkOverdue=ds<today&&dt.some(t=>t.status!=='done');
    h+=`<div class="week-day ${isToday?'today':''}${wkOverdue?' cal-overdue':''}" ondragover="event.preventDefault();this.classList.add('cal-drag-over')" ondragleave="this.classList.remove('cal-drag-over')" ondrop="this.classList.remove('cal-drag-over');calDrop(event,'${ds}')">
      <div class="week-day-header">${dayNames[i]}<span class="day-num">${d.getDate()}</span>${dt.length?`<span style="font-size:8px;color:${wkOverdue?'var(--red)':'var(--accent)'};font-family:var(--mono);margin-left:4px;opacity:0.7">${dt.length}</span>`:''}</div>
      ${dt.map(t=>`<div class="week-task-card" draggable="true" ondragstart="calDragStart(event,${t.id})" onclick="openTaskDetail(${t.id})">
        <div class="wt-title">${esc(t.title||'Untitled')}</div>
        <div class="wt-meta"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}" style="font-size:8px;padding:1px 4px">${t.priority||'p3'}</span>${t.project?`<span style="font-size:8px;color:var(--text-muted)">${esc(t.project)}</span>`:''}${t.estimate?`<span style="font-size:8px;color:var(--accent-cyan);font-family:var(--mono)">${esc(t.estimate)}</span>`:''}</div>
      </div>`).join('')}
      <div class="week-add" onclick="calClickDay('${ds}')">+ task</div>
    </div>`;
  }
  document.getElementById('cal-week-grid').innerHTML=h;
}
function renderCalAgenda(){
  const el=document.getElementById('cal-agenda-grid');if(!el)return;
  const today=new Date().toISOString().split('T')[0];
  const tasks=S.tasks.filter(t=>t.due&&t.status!=='done').sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  const overdue=tasks.filter(t=>t.due<today);
  const upcoming=tasks.filter(t=>t.due>=today);
  const groups={};
  upcoming.forEach(t=>{const d=t.due;if(!groups[d])groups[d]=[];groups[d].push(t);});
  let h='<div style="max-height:calc(100vh - 260px);overflow-y:auto;padding:4px">';
  if(overdue.length){
    h+=`<div style="padding:6px 8px;font-size:10px;font-weight:600;color:var(--red);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-bottom:4px">Overdue (${overdue.length})</div>`;
    overdue.forEach(t=>{h+=`<div onclick="openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:8px;padding:6px 8px;cursor:pointer;border-left:3px solid var(--red);margin-bottom:2px;background:rgba(239,68,68,0.05);border-radius:0 4px 4px 0"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted)">${t.due} (${relativeDate(t.due)}) | ${t.priority||'p2'}${t.project?' | '+esc(t.project):''}</div></div></div>`;});
  }
  const sortedDates=Object.keys(groups).sort();
  sortedDates.forEach(ds=>{
    const d=new Date(ds+'T12:00:00');
    const label=d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const isToday=ds===today;
    h+=`<div style="padding:6px 8px;font-size:10px;font-weight:600;color:${isToday?'var(--accent)':'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:8px;margin-bottom:4px">${label}${isToday?' (Today)':''} (${groups[ds].length})</div>`;
    groups[ds].forEach(t=>{
      const pClr=t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':t.priority==='p2'?'var(--accent-cyan)':'var(--text-muted)';
      h+=`<div onclick="openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:8px;padding:6px 8px;cursor:pointer;border-left:3px solid ${pClr};margin-bottom:2px;border-radius:0 4px 4px 0;transition:background 0.15s" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted)">${t.priority||'p2'}${t.project?' | '+esc(t.project):''}${t.estimate?' | '+esc(t.estimate):''}${(t.subtasks&&t.subtasks.length)?' | '+t.subtasks.filter(s=>s.done).length+'/'+t.subtasks.length+' subtasks':''}</div></div></div>`;
    });
  });
  if(!tasks.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No upcoming tasks with due dates</div>';
  h+='</div>';
  el.innerHTML=h;
  document.getElementById('cal-month-label').innerHTML='Agenda View <span style="font-size:9px;color:var(--accent);font-family:var(--mono)">'+tasks.length+' tasks</span>';
}
function calNav(dir){
  if(calView==='week'){
    calWeekStart.setDate(calWeekStart.getDate()+(dir*7));
    renderCalendar(); return;
  }
  calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}if(calMonth<0){calMonth=11;calYear--;}renderCalendar();
}
function calToday(){
  calMonth=new Date().getMonth();calYear=new Date().getFullYear();
  const now=new Date(),day=now.getDay(),diff=day===0?-6:1-day;
  calWeekStart=new Date(now.getFullYear(),now.getMonth(),now.getDate()+diff);
  renderCalendar();
}
function calClickDay(dateStr){
  const dt=S.tasks.filter(t=>t.due===dateStr);
  if(dt.length>0){calDayPopup(dateStr,dt);return;}
  S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString()});
  save();renderCalendar();renderTasks();
  toast('New task on '+dateStr);
}
function calDayPopup(dateStr,tasks){
  let existing=document.getElementById('cal-day-popup');if(existing)existing.remove();
  const d=new Date(dateStr+'T12:00:00');
  const label=d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const popup=document.createElement('div');popup.id='cal-day-popup';
  popup.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px;z-index:9999;max-width:350px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.5)';
  popup.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:13px;font-weight:600;color:var(--text-primary)">${label}</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">x</button></div><div style="display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto">${tasks.map(t=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-secondary);border-radius:4px;cursor:pointer;border-left:3px solid var(${t.priority==='p0'?'--red':t.priority==='p1'?'--orange':'--accent'})" onclick="this.parentElement.parentElement.remove();openTaskDetail(${t.id})"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted)">${t.status} | ${t.priority||'p2'}${t.project?' | '+esc(t.project):''}</div></div></div>`).join('')}</div><button onclick="this.parentElement.remove();calAddTaskOnDay('${dateStr}')" class="btn btn-primary btn-sm" style="width:100%;margin-top:10px">+ Add task on this day</button>`;
  document.body.appendChild(popup);
  popup.addEventListener('click',e=>{if(e.target===popup)popup.remove();});
}
function calAddTaskOnDay(dateStr){
  S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString()});
  save();renderCalendar();renderTasks();toast('New task on '+dateStr);
}
function renderYearHeatmap(){
  const year=calYear;const today=new Date().toISOString().split('T')[0];
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('cal-month-label').innerHTML=year+' <span style="font-size:9px;color:var(--accent);font-family:var(--mono)">Activity Heatmap</span>';
  const tasksByDay={};S.tasks.forEach(t=>{if(t.due){tasksByDay[t.due]=(tasksByDay[t.due]||0)+1;}if(t.created){const cd=t.created.split('T')[0];tasksByDay[cd]=(tasksByDay[cd]||0)+0.5;}if(t.completedAt){const cd=t.completedAt.split('T')[0];tasksByDay[cd]=(tasksByDay[cd]||0)+1;}});
  S.content.forEach(c=>{if(c.created){const cd=c.created.split('T')[0];tasksByDay[cd]=(tasksByDay[cd]||0)+0.5;}});
  const maxActivity=Math.max(1,...Object.values(tasksByDay));
  const cellSize=11;const cellGap=2;const startDay=new Date(year,0,1).getDay();
  const weeksInYear=53;const svgW=weeksInYear*(cellSize+cellGap)+40;const svgH=7*(cellSize+cellGap)+30;
  let svg=`<svg width="${svgW}" height="${svgH}" style="display:block;margin:8px auto">`;
  ['S','M','T','W','T','F','S'].forEach((d,i)=>{svg+=`<text x="0" y="${i*(cellSize+cellGap)+cellSize+20}" font-size="8" fill="var(--text-muted)" font-family="var(--mono)">${d}</text>`;});
  let currentMonth=-1;
  for(let w=0;w<weeksInYear;w++){
    for(let d=0;d<7;d++){
      const dayNum=w*7+d-startDay;const date=new Date(year,0,1+dayNum);
      if(date.getFullYear()!==year)continue;
      const ds=date.toISOString().split('T')[0];const activity=tasksByDay[ds]||0;
      const intensity=activity?Math.min(1,activity/maxActivity):0;
      const fill=activity===0?'rgba(255,255,255,0.03)':intensity<0.25?'rgba(74,222,128,0.2)':intensity<0.5?'rgba(74,222,128,0.4)':intensity<0.75?'rgba(74,222,128,0.6)':'rgba(74,222,128,0.9)';
      const x=30+w*(cellSize+cellGap);const y=20+d*(cellSize+cellGap);
      svg+=`<rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" rx="2" fill="${fill}" stroke="${ds===today?'var(--accent)':'none'}" stroke-width="${ds===today?'1':'0'}"><title>${ds}: ${Math.round(activity)} activity</title></rect>`;
      if(date.getMonth()!==currentMonth){currentMonth=date.getMonth();svg+=`<text x="${x}" y="12" font-size="8" fill="var(--text-muted)" font-family="var(--mono)">${months[currentMonth]}</text>`;}
    }
  }
  svg+='</svg>';
  const yearGrid=document.getElementById('cal-year-grid');
  if(yearGrid){yearGrid.innerHTML=svg+'<div style="display:flex;gap:4px;justify-content:center;align-items:center;margin-top:4px;font-size:8px;color:var(--text-muted)"><span>Less</span><span style="width:10px;height:10px;background:rgba(255,255,255,0.03);border-radius:2px;display:inline-block"></span><span style="width:10px;height:10px;background:rgba(74,222,128,0.2);border-radius:2px;display:inline-block"></span><span style="width:10px;height:10px;background:rgba(74,222,128,0.4);border-radius:2px;display:inline-block"></span><span style="width:10px;height:10px;background:rgba(74,222,128,0.6);border-radius:2px;display:inline-block"></span><span style="width:10px;height:10px;background:rgba(74,222,128,0.9);border-radius:2px;display:inline-block"></span><span>More</span></div>';}
}
function calDragStart(e,id){calDragId=id;e.dataTransfer.effectAllowed='move';}
function calDrop(e,dateStr){e.preventDefault();if(calDragId){const t=S.tasks.find(x=>x.id===calDragId);if(t){t.due=dateStr;save();renderCalendar();renderTasks();toast('Moved to '+dateStr);}calDragId=null;}}
function exportICS(){let ics='BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//SaturnoHub//EN\n';S.tasks.filter(t=>t.due).forEach(t=>{const d=t.due.replace(/-/g,'');ics+=`BEGIN:VEVENT\nDTSTART;VALUE=DATE:${d}\nSUMMARY:${t.title||'Task'}\nDESCRIPTION:Priority: ${t.priority||'p2'} | Status: ${t.status||'todo'}${t.project?' | Project: '+t.project:''}\nEND:VEVENT\n`;});ics+='END:VCALENDAR';const blob=new Blob([ics],{type:'text/calendar'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-tasks.ics';a.click();toast('ICS exported - import into Google Calendar');}
function importICS(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.ics,.ical';
  inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{
    const text=ev.target.result;const events=text.split('BEGIN:VEVENT').slice(1);
    if(!events.length){toast('No events found in ICS file');return;}
    let count=0;
    events.forEach(block=>{
      const sum=(block.match(/SUMMARY[;:]([^\r\n]+)/)||[])[1]||'';
      const desc=(block.match(/DESCRIPTION[;:]([^\r\n]+)/)||[])[1]||'';
      let dateStr='';
      const dtMatch=block.match(/DTSTART[^:]*:(\d{4})(\d{2})(\d{2})/);
      if(dtMatch)dateStr=dtMatch[1]+'-'+dtMatch[2]+'-'+dtMatch[3];
      if(!sum.trim())return;
      const title=sum.replace(/\\,/g,',').replace(/\\n/g,' ').trim();
      const existing=S.tasks.find(t=>t.title===title&&t.due===dateStr);
      if(existing)return;
      S.tasks.unshift({id:Date.now()+count,title,description:desc.replace(/\\n/g,'\n').replace(/\\,/g,',').substring(0,500),subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString(),source:'ics-import'});
      count++;
    });
    save();renderCalendar();renderTasks();toast('Imported '+count+' events from ICS');
  };r.readAsText(f);};inp.click();
}

function exportWeek(){
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());weekStart.setHours(0,0,0,0);
  const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  let md='# Week of '+weekStart.toLocaleDateString('en-US',{month:'long',day:'numeric'})+' - '+weekEnd.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'\n\n';
  for(let i=0;i<7;i++){
    const d=new Date(weekStart);d.setDate(d.getDate()+i);
    const ds=d.toISOString().split('T')[0];
    const tasks=S.tasks.filter(t=>t.due===ds);
    if(tasks.length){md+='## '+days[d.getDay()]+' ('+ds+')\n';tasks.forEach(t=>{md+='- ['+t.status+'] '+t.title+(t.priority?' ('+t.priority+')':'')+(t.project?' ['+t.project+']':'')+'\n';});md+='\n';}
  }
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString()));
  if(doneThisWeek.length){md+='## Completed This Week\n';doneThisWeek.forEach(t=>{md+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});md+='\n';}
  navigator.clipboard.writeText(md).then(()=>toast('Week summary copied to clipboard'));
}

function exportMonth(){
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  let md='# '+months[calMonth]+' '+calYear+'\n\n';
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date().toISOString().split('T')[0];
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const tasks=S.tasks.filter(t=>t.due===ds);
    if(tasks.length){const dt=new Date(ds+'T12:00:00');md+='## '+dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})+'\n';tasks.forEach(t=>{md+='- ['+t.status+'] '+t.title+(t.priority?' ('+t.priority+')':'')+(t.project?' ['+t.project+']':'')+'\n';});md+='\n';}
  }
  const monthDone=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(calYear+'-'+String(calMonth+1).padStart(2,'0')));
  if(monthDone.length){md+='## Completed This Month ('+monthDone.length+')\n';monthDone.forEach(t=>{md+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});}
  navigator.clipboard.writeText(md).then(()=>toast(months[calMonth]+' summary copied'));
}
function exportTasksICS(){
  const tasks=S.tasks.filter(t=>t.due&&t.status!=='done');
  if(!tasks.length){toast('No active tasks with due dates');return;}
  let ics='BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Saturno Hub//EN\r\nCALSCALE:GREGORIAN\r\n';
  tasks.forEach(t=>{
    const d=t.due.replace(/-/g,'');
    ics+='BEGIN:VEVENT\r\nDTSTART;VALUE=DATE:'+d+'\r\nDTEND;VALUE=DATE:'+d+'\r\nSUMMARY:'+(t.title||'Task').replace(/[,;\\]/g,' ')+'\r\nDESCRIPTION:'+(t.priority||'').toUpperCase()+(t.project?' ['+t.project.replace(/[,;\\]/g,' ')+']':'')+(t.description?' - '+(t.description||'').substring(0,100).replace(/[,;\\]/g,' '):'')+'\r\nUID:saturno-'+t.id+'@hub\r\nEND:VEVENT\r\n';
  });
  ics+='END:VCALENDAR\r\n';
  const blob=new Blob([ics],{type:'text/calendar'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-tasks.ics';a.click();toast('Exported '+tasks.length+' tasks as ICS');
}

// === WRITING HUB ===
function getActiveDoc(){return S.docs.find(d=>d.id===S.activeDoc);}
function renderWriter(){renderDocList();loadDoc();document.getElementById('writer-count').textContent=S.docs.length;}
function renderDocList(){const q=(document.getElementById('writer-doc-search')?.value||'').toLowerCase();const sortBy=(document.getElementById('writer-doc-sort')?.value)||'updated';let sorted=[...S.docs];if(sortBy==='updated')sorted.sort((a,b)=>(new Date(b.updated||0))-(new Date(a.updated||0)));else if(sortBy==='created')sorted.sort((a,b)=>(new Date(b.created||0))-(new Date(a.created||0)));else if(sortBy==='alpha')sorted.sort((a,b)=>(a.title||'').localeCompare(b.title||''));else if(sortBy==='words')sorted.sort((a,b)=>countW(b.body)-countW(a.body));else if(sortBy==='tag')sorted.sort((a,b)=>((a.tags&&a.tags[0])||'zzz').localeCompare((b.tags&&b.tags[0])||'zzz'));if(q)sorted=sorted.filter(d=>(d.title||'').toLowerCase().includes(q)||(d.tags||[]).some(t=>t.includes(q)));sorted.sort((a,b)=>(b.starred?1:0)-(a.starred?1:0));const renderDocItem=d=>{const w=countW(d.body);const dt=d.updated?new Date(d.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';return`<div class="writer-doc-item ${d.id===S.activeDoc?'active':''}" onclick="switchDoc(${d.id})"${d.starred?' style="border-left:2px solid var(--yellow)"':''}><div class="writer-doc-title">${d.starred?'<span style="color:var(--yellow);font-size:8px;margin-right:2px">*</span>':''}${esc(d.title||'Untitled')}</div>${(d.tags&&d.tags.length)?`<div style="display:flex;gap:2px;flex-wrap:wrap;margin:2px 0">${d.tags.map(t=>`<span style="font-size:7px;padding:0 4px;border-radius:6px;border:1px solid rgba(74,222,128,0.2);color:var(--accent);opacity:0.7">${esc(t)}</span>`).join('')}</div>`:''}<div class="writer-doc-meta"><span>${w}w${w>50?' / '+Math.max(1,Math.ceil(w/238))+'m':''}</span><span>${dt}</span><span style="margin-left:auto;cursor:pointer;opacity:0.4;font-size:8px;${d.starred?'color:var(--yellow);opacity:1':''}" onclick="event.stopPropagation();starDoc(${d.id})" title="${d.starred?'Unstar':'Star'}">*</span><span style="cursor:pointer;opacity:0.4;font-size:8px" onclick="event.stopPropagation();tagDoc(${d.id})" title="Add tags">T</span><span style="cursor:pointer;opacity:0.4;font-size:8px" onclick="event.stopPropagation();dupDoc(${d.id})" title="Duplicate">D</span>${S.docs.length>1?`<span style="cursor:pointer;opacity:0.4" onclick="event.stopPropagation();delDoc(${d.id})">x</span>`:''}</div></div>`;};
  let docListHtml='';if(sortBy==='tag'){let lastTag=null;sorted.forEach(d=>{const tag=(d.tags&&d.tags[0])||'Untagged';if(tag!==lastTag){const cnt=sorted.filter(x=>((x.tags&&x.tags[0])||'Untagged')===tag).length;docListHtml+=`<div style="padding:6px 8px 2px;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);font-family:var(--mono)">${esc(tag)} <span style="color:var(--text-muted);font-weight:400">${cnt}</span></div>`;lastTag=tag;}docListHtml+=renderDocItem(d);});}else{docListHtml=sorted.map(renderDocItem).join('');}
  document.getElementById('writer-doc-list').innerHTML=docListHtml;}
function tagDoc(id){const d=S.docs.find(x=>x.id===id);if(!d)return;const current=(d.tags||[]).join(', ');const input=prompt('Tags (comma-separated):',current);if(input===null)return;d.tags=input.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);save();renderDocList();toast('Tags updated');}
function starDoc(id){const d=S.docs.find(x=>x.id===id);if(!d)return;d.starred=!d.starred;save();renderDocList();toast(d.starred?'Starred':'Unstarred');}
function loadDoc(){const d=getActiveDoc();if(!d)return;document.getElementById('writer-title').value=d.title||'';document.getElementById('writer-editor').innerHTML=d.body||'';if(!writerSessionStart[d.id]){const wc=(d.body||'').trim().split(/\s+/).filter(x=>x.length).length;writerSessionStart[d.id]=wc;}updateWS();renderVersions();renderWriterTags();}
function renderWriterTags(){const d=getActiveDoc();const bar=document.getElementById('writer-tags-bar');if(!bar||!d)return;const tags=d.tags||[];bar.innerHTML=tags.map(t=>`<span style="display:inline-flex;align-items:center;gap:2px;padding:1px 6px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px;font-size:9px;color:var(--text-muted);font-family:var(--mono)">${esc(t)}<span onclick="removeDocTag('${escA(t)}')" style="cursor:pointer;color:var(--red);margin-left:2px;font-size:8px" title="Remove tag">x</span></span>`).join('')+`<span onclick="addDocTag()" style="cursor:pointer;font-size:9px;color:var(--accent);padding:1px 4px" title="Add tag">+ tag</span>`;}
function addDocTag(){const d=getActiveDoc();if(!d)return;const allTags=[...new Set(S.docs.flatMap(x=>x.tags||[]))].sort();const t=prompt('Tag name:'+((allTags.length)?'\nExisting: '+allTags.join(', '):''));if(!t||!t.trim())return;if(!d.tags)d.tags=[];const tag=t.trim().toLowerCase();if(!d.tags.includes(tag)){d.tags.push(tag);save();renderWriterTags();renderDocList();toast('Tag added: '+tag);}}
function removeDocTag(tag){const d=getActiveDoc();if(!d||!d.tags)return;d.tags=d.tags.filter(t=>t!==tag);save();renderWriterTags();renderDocList();}
function switchDoc(id){if(S.activeDoc===id)return;snapshotWriter();save();S.activeDoc=id;renderWriter();const d=S.docs.find(x=>x.id===id);if(d)trackRecent('doc',id,d.title);save();updateBreadcrumb();}
function newDocFromTemplate(title,body){snapshotWriter();const d={id:Date.now(),title,body,versions:[],created:new Date().toISOString(),updated:new Date().toISOString()};S.docs.unshift(d);S.activeDoc=d.id;save();renderWriter();document.querySelectorAll('.btn-group div[style*="display: block"],.btn-group div[style*="display:block"]').forEach(d=>d.style.display='none');toast('Created: '+title);}
function newDoc(){snapshotWriter();const d={id:Date.now(),title:'',body:'',versions:[],created:new Date().toISOString(),updated:new Date().toISOString()};S.docs.unshift(d);S.activeDoc=d.id;save();renderWriter();document.getElementById('writer-title').focus();}
function delDoc(id){if(S.docs.length<=1){toast('Cannot delete last doc');return;}S.docs=S.docs.filter(d=>d.id!==id);if(S.activeDoc===id)S.activeDoc=S.docs[0].id;save();renderWriter();toast('Deleted');}
function mergeDocs(){
  snapshotWriter();
  const others=S.docs.filter(d=>d.id!==S.activeDoc);
  if(!others.length){toast('Need at least 2 docs to merge');return;}
  const target=prompt('Merge which doc into current?\n\n'+others.map((d,i)=>(i+1)+'. '+(d.title||'Untitled')+' ('+countW(d.body)+'w)').join('\n'));
  if(!target)return;
  const idx=parseInt(target)-1;
  if(isNaN(idx)||idx<0||idx>=others.length){toast('Invalid selection');return;}
  const src=others[idx];const cur=getActiveDoc();if(!cur)return;
  cur.body=(cur.body||'')+'<hr><h2>'+(src.title||'Merged Section')+'</h2>'+(src.body||'');
  cur.updated=new Date().toISOString();
  if(src.tags&&src.tags.length){if(!cur.tags)cur.tags=[];src.tags.forEach(t=>{if(!cur.tags.includes(t))cur.tags.push(t);});}
  S.docs=S.docs.filter(d=>d.id!==src.id);
  save();renderWriter();toast('Merged "'+src.title+'" into "'+cur.title+'"');
}
function dupDoc(id){const d=S.docs.find(x=>x.id===id);if(!d)return;snapshotWriter();const dup={...d,id:Date.now(),title:(d.title||'Untitled')+' (copy)',created:new Date().toISOString(),updated:new Date().toISOString(),versions:[]};S.docs.unshift(dup);S.activeDoc=dup.id;save();renderWriter();toast('Duplicated');}
function snapshotWriter(){const d=getActiveDoc();if(!d)return;const t=document.getElementById('writer-title'),e=document.getElementById('writer-editor');if(!t||!e)return;d.title=t.value;d.body=e.innerHTML;d.updated=new Date().toISOString();}
function onWriterChange(){clearTimeout(writerTimer);document.getElementById('ws-saved').textContent='Unsaved';document.getElementById('ws-saved').style.color='var(--yellow)';writerTimer=setTimeout(()=>{snapshotWriter();save();renderDocList();document.getElementById('ws-saved').textContent='Saved';document.getElementById('ws-saved').style.color='var(--green)';},800);updateWS();scheduleAutoBackup();}
function scheduleAutoBackup(){
  if(writerAutoBackupTimer)return;
  writerAutoBackupTimer=setTimeout(()=>{writerAutoBackupTimer=null;const d=getActiveDoc();if(!d)return;snapshotWriter();if(!d.versions)d.versions=[];const last=d.versions[0];const now=Date.now();if(last&&now-new Date(last.date).getTime()<300000)return;d.versions.unshift({id:now,title:d.title+' (auto)',body:d.body,words:countW(d.body),date:new Date().toISOString()});if(d.versions.length>50)d.versions=d.versions.slice(0,50);save();renderVersions();},600000);
}
function updateWS(){const e=document.getElementById('writer-editor'),t=e.innerText||'',w=t.trim().split(/\s+/).filter(x=>x.length).length;const paras=t.split(/\n\s*\n/).filter(p=>p.trim().length).length;const headings=e.querySelectorAll('h1,h2,h3,h4,h5,h6').length;document.getElementById('ws-words').textContent=w+' words';document.getElementById('ws-chars').textContent=paras+'p / '+headings+'h / '+t.length+'c';document.getElementById('ws-reading').textContent=Math.max(1,Math.ceil(w/238))+' min read';
  const d=getActiveDoc();const editedEl=document.getElementById('ws-edited');if(editedEl&&d&&d.updated)editedEl.textContent='Edited '+timeAgo(d.updated);
  const sesEl=document.getElementById('ws-session');if(sesEl&&d&&writerSessionStart[d.id]!==undefined){const delta=w-writerSessionStart[d.id];sesEl.textContent=delta>0?'+'+delta+' this session':delta<0?delta+' this session':'';sesEl.style.color=delta>0?'var(--green)':'var(--yellow)';};
  const goal=d&&d.wordGoal?d.wordGoal:0;const goalEl=document.getElementById('ws-goal');
  if(goal>0){const pct=Math.min(100,Math.round(w/goal*100));goalEl.textContent=pct+'% of '+goal+'w goal';goalEl.style.color=pct>=100?'var(--green)':'var(--accent-cyan)';}else{goalEl.textContent='Set goal';goalEl.style.color='var(--text-muted)';}
  const readEl=document.getElementById('ws-readability');if(readEl&&w>30){const sentences=t.split(/[.!?]+/).filter(s=>s.trim().length).length||1;const syllCount=tw=>{tw=tw.toLowerCase().replace(/[^a-z]/g,'');if(tw.length<=3)return 1;tw=tw.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/,'').replace(/^y/,'');const m=tw.match(/[aeiouy]{1,2}/g);return m?m.length:1;};const words=t.trim().split(/\s+/).filter(x=>x.length);const totalSyll=words.reduce((a,wd)=>a+syllCount(wd),0);const fre=Math.round(206.835-1.015*(w/sentences)-84.6*(totalSyll/w));const label=fre>=70?'Easy':fre>=50?'Standard':fre>=30?'Academic':'Complex';const color=fre>=70?'var(--green)':fre>=50?'var(--accent-cyan)':fre>=30?'var(--yellow)':'var(--red)';readEl.textContent=label+' ('+fre+')';readEl.style.color=color;readEl.title='Flesch Reading Ease: '+fre+' (0=very hard, 100=very easy)';}else if(readEl){readEl.textContent='';}}

function writerScrollUpdate(el){const s=document.getElementById('ws-scroll');if(!s||!el)return;const max=el.scrollHeight-el.clientHeight;if(max<=0){s.textContent='';return;}const pct=Math.round(el.scrollTop/max*100);s.textContent=pct+'%';}
function setWriterGoal(){const d=getActiveDoc();if(!d)return;const g=prompt('Word count goal:',d.wordGoal||'');if(g===null)return;d.wordGoal=parseInt(g)||0;save();updateWS();}
function countW(html){const d=document.createElement('div');d.innerHTML=html||'';return(d.innerText||'').trim().split(/\s+/).filter(x=>x.length).length;}
function execCmd(c){document.execCommand(c,false,null);document.getElementById('writer-editor').focus();}
function execBlock(tag){document.execCommand('formatBlock',false,'<'+tag+'>');document.getElementById('writer-editor').focus();}
function insertLink(){const u=prompt('URL:');if(u)document.execCommand('createLink',false,u);document.getElementById('writer-editor').focus();}
function insertHR(){document.execCommand('insertHTML',false,'<hr>');document.getElementById('writer-editor').focus();}
function insertCodeInline(){const s=window.getSelection();if(s.rangeCount)document.execCommand('insertHTML',false,'<code>'+(esc(s.toString())||'code')+'</code>');}
function clearFormatting(){document.execCommand('removeFormat',false,null);document.getElementById('writer-editor').focus();}
function writerKeydown(e){if(e.key==='Tab'){e.preventDefault();document.execCommand('insertHTML',false,'&nbsp;&nbsp;&nbsp;&nbsp;');}if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveVersion();}if((e.ctrlKey||e.metaKey)&&(e.key==='h'||e.key==='f')&&currentSection==='writer'){e.preventDefault();writerFindOpen();}}
function writerTOC(){
  const editor=document.getElementById('writer-editor');if(!editor)return;
  const headings=editor.querySelectorAll('h1,h2,h3');
  if(!headings.length){toast('No headings found');return;}
  let toc='<div style="border:1px solid var(--border);border-radius:6px;padding:12px 16px;margin:8px 0;background:var(--bg-secondary)"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">Table of Contents</div>';
  headings.forEach(h=>{
    const level=parseInt(h.tagName[1]);const indent=(level-1)*16;
    toc+=`<div style="padding:2px 0 2px ${indent}px;font-size:${level===1?'12':'11'}px;color:var(--text-${level===1?'primary':'secondary'})">${h.textContent}</div>`;
  });
  toc+='</div>';
  const range=document.createRange();range.selectNodeContents(editor);range.collapse(true);
  const frag=range.createContextualFragment(toc);
  editor.insertBefore(frag,editor.firstChild);
  onWriterChange();toast('TOC inserted at top');
}
function writerFindOpen(){const bar=document.getElementById('writer-find-bar');bar.style.display='flex';document.getElementById('writer-find-input').focus();const sel=window.getSelection();if(sel.toString())document.getElementById('writer-find-input').value=sel.toString();}
function writerFindClose(){document.getElementById('writer-find-bar').style.display='none';document.getElementById('writer-find-count').textContent='';window.getSelection().removeAllRanges();}
function writerFindNext(){const q=document.getElementById('writer-find-input').value;if(!q){document.getElementById('writer-find-count').textContent='';return;}const ed=document.getElementById('writer-editor');const text=ed.innerText;const matches=text.match(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'));document.getElementById('writer-find-count').textContent=matches?matches.length+' found':'0 found';if(window.find)window.find(q,false,false,true);}
function writerReplace(){const q=document.getElementById('writer-find-input').value;const r=document.getElementById('writer-replace-input').value;if(!q)return;const sel=window.getSelection();if(sel.toString().toLowerCase()===q.toLowerCase()){document.execCommand('insertText',false,r);writerFindNext();}}
function writerReplaceAll(){const q=document.getElementById('writer-find-input').value;const r=document.getElementById('writer-replace-input').value;if(!q)return;const ed=document.getElementById('writer-editor');const re=new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');const count=(ed.innerText.match(re)||[]).length;snapshotWriter();const d=getActiveDoc();if(d){const tmp=document.createElement('div');tmp.innerHTML=d.body;const walk=n=>{if(n.nodeType===3){const parts=n.textContent.split(re);if(parts.length>1){n.textContent=n.textContent.replace(re,r);}}else{n.childNodes.forEach(walk);}};walk(tmp);d.body=tmp.innerHTML;save();loadDoc();}toast('Replaced '+count+' occurrences');writerFindClose();}
function saveVersion(){snapshotWriter();const d=getActiveDoc();if(!d)return;if(!d.versions)d.versions=[];d.versions.unshift({id:Date.now(),title:d.title,body:d.body,words:countW(d.body),date:new Date().toISOString()});if(d.versions.length>50)d.versions=d.versions.slice(0,50);save();renderVersions();toast('Version saved');}
function renderVersions(){const d=getActiveDoc(),el=document.getElementById('writer-versions');if(!d||!d.versions||!d.versions.length){el.innerHTML='<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:20px">No versions. Ctrl+S to save.</div>';return;}el.innerHTML=d.versions.map((v,i)=>{const dt=new Date(v.date);const curW=countW(d.body);const diff=v.words-curW;const diffStr=diff>0?'+'+diff:diff<0?''+diff:'=';const diffColor=diff>0?'var(--green)':diff<0?'var(--red)':'var(--text-muted)';return`<div class="writer-version-item"><div style="display:flex;justify-content:space-between;align-items:center"><div class="writer-version-title">${esc(v.title||'Untitled')}</div><span style="font-size:8px;color:${diffColor};font-family:var(--mono)">${diffStr}w</span></div><div class="writer-version-meta">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${dt.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})} - ${v.words||0}w</div><div style="display:flex;gap:4px;margin-top:3px"><button class="btn btn-sm btn-ghost" onclick="previewVersion(${i})" style="font-size:8px;padding:1px 4px">Preview</button><button class="btn btn-sm btn-ghost" onclick="restoreVersion(${i})" style="font-size:8px;padding:1px 4px">Restore</button></div></div>`;}).join('');}
function restoreVersion(i){const d=getActiveDoc();if(!d||!d.versions[i])return;const v=d.versions[i];d.title=v.title;d.body=v.body;d.updated=new Date().toISOString();save();loadDoc();toast('Restored');}
function previewVersion(i){
  const d=getActiveDoc();if(!d||!d.versions[i])return;
  const v=d.versions[i];
  let existing=document.getElementById('version-preview');if(existing)existing.remove();
  const overlay=document.createElement('div');overlay.id='version-preview';
  overlay.style.cssText='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center';
  const curW=countW(d.body);const vW=v.words||0;
  overlay.innerHTML=`<div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);max-width:700px;width:95%;max-height:80vh;display:flex;flex-direction:column;overflow:hidden"><div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><div><span style="font-size:13px;font-weight:600;color:var(--text)">${esc(v.title||'Untitled')}</span><span style="font-size:9px;color:var(--text-muted);margin-left:8px">${new Date(v.date).toLocaleString()}</span></div><div style="display:flex;gap:6px"><span style="font-size:9px;color:var(--text-muted)">${vW}w version / ${curW}w current</span><button class="btn btn-sm btn-primary" onclick="restoreVersion(${i});this.closest('#version-preview').remove()">Restore</button><button onclick="this.closest('#version-preview').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:4px">x</button></div></div><div style="padding:16px;overflow-y:auto;font-size:12px;line-height:1.8;color:var(--text)">${v.body||'<em style="color:var(--text-muted)">Empty version</em>'}</div></div>`;
  document.body.appendChild(overlay);
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
}
function toggleWriterPanel(){writerPanelOpen=!writerPanelOpen;document.getElementById('writer-right-panel').classList.toggle('hidden',!writerPanelOpen);}
function writerExport(fmt){const d=getActiveDoc();if(!d||!fmt)return;const t=d.title||'untitled',e=document.getElementById('writer-editor');if(fmt==='clipboard'){navigator.clipboard.writeText(e.innerText);toast('Copied');return;}if(fmt==='print'){const wc=countW(e.innerHTML);const printHtml=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(t)}</title><style>@media print{@page{margin:1in}}body{font-family:Georgia,serif;max-width:680px;margin:40px auto;padding:0 20px;line-height:2;color:#111;font-size:12pt}h1{font-size:24pt;margin-bottom:8px;page-break-after:avoid}h2{font-size:18pt;margin-top:24px;page-break-after:avoid}h3{font-size:14pt;page-break-after:avoid}blockquote{border-left:3px solid #999;padding-left:16px;color:#444;font-style:italic;margin:16px 0}code{background:#f0f0f0;padding:1px 4px;border-radius:3px;font-size:10pt}pre{background:#f0f0f0;padding:12px;border-radius:6px;font-size:9pt;overflow-x:auto;page-break-inside:avoid}.meta{font-size:9pt;color:#666;margin-bottom:24px;border-bottom:1px solid #ddd;padding-bottom:8px}</style></head><body><h1>${esc(t)}</h1><div class="meta">${wc} words | Exported ${new Date().toLocaleDateString()}</div>${e.innerHTML}</body></html>`;const w=window.open('','_blank');w.document.write(printHtml);w.document.close();toast('Opened print view');return;}let c,m,x;if(fmt==='txt'){c=e.innerText;m='text/plain';x='txt';}else if(fmt==='html'){c=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(t)}</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#222}h1{font-size:28px}h2{font-size:22px}blockquote{border-left:3px solid #ccc;padding-left:16px;color:#666;font-style:italic}code{background:#f4f4f4;padding:1px 4px;border-radius:3px}pre{background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto}</style></head><body><h1>${esc(t)}</h1>${e.innerHTML}</body></html>`;m='text/html';x='html';}else if(fmt==='md'){c=htmlToMd(e.innerHTML,t);m='text/markdown';x='md';}const blob=new Blob([c],{type:m});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=t.replace(/[^a-z0-9]/gi,'-').toLowerCase()+'.'+x;a.click();toast('Exported .'+x);}
function writerDetailedStats(){
  const d=getActiveDoc();if(!d)return;snapshotWriter();
  const text=(document.getElementById('writer-editor')?.innerText||'').trim();
  if(!text){toast('Document is empty');return;}
  const words=text.split(/\s+/).filter(x=>x.length);const wc=words.length;
  const chars=text.length;const charsNoSpace=text.replace(/\s/g,'').length;
  const sentences=text.split(/[.!?]+\s/).filter(Boolean).length;
  const paragraphs=text.split(/\n\s*\n/).filter(p=>p.trim()).length;
  const avgWordLen=wc?Math.round(charsNoSpace/wc*10)/10:0;
  const avgSentLen=sentences?Math.round(wc/sentences*10)/10:0;
  const readTime=Math.max(1,Math.ceil(wc/238));
  const speakTime=Math.max(1,Math.ceil(wc/150));
  const uniqueWords=new Set(words.map(w=>w.toLowerCase().replace(/[^a-z]/g,''))).size;
  const vocabRichness=wc?Math.round(uniqueWords/wc*100):0;
  const headings=(document.getElementById('writer-editor')?.querySelectorAll('h1,h2,h3,h4')||[]).length;
  const links=(document.getElementById('writer-editor')?.querySelectorAll('a')||[]).length;
  const stats=[
    'Words: '+wc.toLocaleString(),
    'Characters: '+chars.toLocaleString()+' ('+charsNoSpace.toLocaleString()+' no spaces)',
    'Sentences: '+sentences,'Paragraphs: '+paragraphs,
    'Avg word length: '+avgWordLen+' chars','Avg sentence length: '+avgSentLen+' words',
    'Reading time: ~'+readTime+' min','Speaking time: ~'+speakTime+' min',
    'Unique words: '+uniqueWords+' ('+vocabRichness+'% vocabulary richness)',
    'Headings: '+headings,'Links: '+links
  ];
  alert((d.title||'Untitled')+'\n\n'+stats.join('\n'));
}
function writerWordFreq(){
  const ed=document.getElementById('writer-editor');if(!ed)return;
  const text=(ed.innerText||'').trim();if(!text){toast('Document is empty');return;}
  const stopWords=new Set(['the','a','an','is','are','was','were','be','been','being','have','has','had','do','does','did','will','would','shall','should','may','might','must','can','could','and','but','or','nor','for','yet','so','in','on','at','to','of','by','with','from','as','into','through','during','before','after','above','below','up','down','out','off','over','under','again','further','then','once','here','there','when','where','why','how','all','each','every','both','few','more','most','other','some','such','no','not','only','own','same','than','too','very','just','because','also','about','its','it','this','that','these','those','i','me','my','we','us','our','you','your','he','him','his','she','her','they','them','their','what','which','who']);
  const words=text.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stopWords.has(w));
  const freq={};words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,25);
  if(!sorted.length){toast('Not enough words for analysis');return;}
  let existing=document.getElementById('writer-freq-panel');if(existing){existing.remove();return;}
  const panel=document.createElement('div');panel.id='writer-freq-panel';
  panel.style.cssText='position:absolute;right:8px;top:40px;width:200px;max-height:60vh;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,0.4)';
  const maxF=sorted[0][1];
  let html='<div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;display:flex;justify-content:space-between"><span>Word Frequency</span><span onclick="this.closest(\'#writer-freq-panel\').remove()" style="cursor:pointer;font-size:10px">x</span></div>';
  sorted.forEach(([w,c])=>{const pct=Math.round(c/maxF*100);html+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:10px"><span style="width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-secondary);font-family:var(--mono)">${esc(w)}</span><div style="flex:1;height:3px;background:var(--bg-secondary);border-radius:2px"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px"></div></div><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);min-width:16px;text-align:right">${c}</span></div>`;});
  panel.innerHTML=html;
  ed.parentElement.style.position='relative';
  ed.parentElement.appendChild(panel);
}
function writerOutline(){
  const ed=document.getElementById('writer-editor');if(!ed)return;
  const headings=ed.querySelectorAll('h1,h2,h3,h4,h5');
  if(!headings.length){toast('No headings found in document');return;}
  let existing=document.getElementById('writer-outline-panel');
  if(existing){existing.remove();return;}
  const panel=document.createElement('div');panel.id='writer-outline-panel';
  panel.style.cssText='position:absolute;right:8px;top:40px;width:220px;max-height:60vh;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,0.4)';
  let html='<div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center"><span>Outline ('+headings.length+')</span><span onclick="this.closest(\'#writer-outline-panel\').remove()" style="cursor:pointer;font-size:10px">x</span></div>';
  headings.forEach((h,i)=>{
    const level=parseInt(h.tagName[1]);const indent=(level-1)*12;
    html+=`<div style="padding:3px 4px 3px ${indent}px;cursor:pointer;font-size:${13-level}px;color:var(--text-secondary);border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="document.getElementById('writer-editor').querySelectorAll('h1,h2,h3,h4,h5')[${i}].scrollIntoView({behavior:'smooth',block:'center'})">${esc(h.textContent||'Untitled')}</div>`;
  });
  panel.innerHTML=html;
  ed.parentElement.style.position='relative';
  ed.parentElement.appendChild(panel);
}
function writerToContent(){const d=getActiveDoc();if(!d)return;snapshotWriter();const ed=document.getElementById('writer-editor');const text=ed.innerText||'';if(!text.trim()){toast('Document is empty');return;}S.content.unshift({id:Date.now(),type:'caption',theme:d.title||'writer',body:text,tags:['from-writer'],source:'writer-export',created:new Date().toISOString()});save();toast('Saved to Content: '+(d.title||'Untitled').substring(0,30));}
function exportAllDocs(){
  if(!S.docs.length){toast('No documents');return;}
  snapshotWriter();
  let md='# All Documents\n\n*Exported '+new Date().toLocaleDateString()+'*\n\n---\n\n';
  S.docs.forEach(d=>{
    const wc=(d.body||'').trim().split(/\s+/).filter(x=>x.length).length;
    md+='## '+(d.title||'Untitled')+'\n';
    md+='*'+wc+' words | Updated: '+(d.updated?new Date(d.updated).toLocaleDateString():'unknown')+'*\n\n';
    md+=(d.body||'(empty)')+'\n\n---\n\n';
  });
  navigator.clipboard.writeText(md).then(()=>toast('All '+S.docs.length+' docs copied as markdown'));
}
function exportAllDocsHTML(){
  if(!S.docs.length){toast('No documents');return;}snapshotWriter();
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>All Documents - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:22px;color:#fff;margin-top:40px}hr{border:none;border-top:1px solid #222;margin:24px 0}.meta{font-size:12px;color:#888;margin-bottom:12px}.doc-body{margin-bottom:24px}blockquote{border-left:3px solid #4ade80;padding-left:16px;color:#aaa;font-style:italic}a{color:#4ade80}</style></head><body>';
  h+='<h1>All Documents</h1><p style="color:#888;font-size:13px">'+S.docs.length+' documents | Exported '+new Date().toLocaleDateString()+'</p><hr>';
  S.docs.forEach(d=>{const wc=(d.body||'').trim().split(/\\s+/).filter(x=>x.length).length;h+='<h2>'+esc(d.title||'Untitled')+'</h2><div class="meta">'+wc+' words | Updated: '+(d.updated?new Date(d.updated).toLocaleDateString():'unknown')+(d.tags&&d.tags.length?' | Tags: '+d.tags.join(', '):'')+'</div><div class="doc-body">'+(d.body||'<em>empty</em>')+'</div><hr>';});
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-docs-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.docs.length+' docs as HTML');
}
function exportAllDocsMD(){
  if(!S.docs.length){toast('No documents');return;}snapshotWriter();
  let md='# Writer Documents\n\nExported: '+new Date().toLocaleDateString()+' | '+S.docs.length+' documents\n\n---\n\n';
  S.docs.forEach(d=>{md+=htmlToMd(d.body||'',d.title||'Untitled')+'\n\n---\n\n';});
  const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-docs-'+new Date().toISOString().split('T')[0]+'.md';a.click();toast('Exported '+S.docs.length+' docs as Markdown');
}
function writerCompare(){
  if(S.docs.length<2){toast('Need 2+ docs to compare');return;}
  const current=getActiveDoc();
  const others=S.docs.filter(d=>d.id!==(current?current.id:-1));
  const list=others.map((d,i)=>(i+1)+'. '+(d.title||'Untitled')+' ('+countW(d.body)+'w)').join('\n');
  const choice=prompt('Compare current doc with:\n\n'+list+'\n\nEnter number:');
  if(!choice)return;const idx=parseInt(choice)-1;
  if(idx<0||idx>=others.length){toast('Invalid choice');return;}
  const docB=others[idx];const docA=current||S.docs[0];
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Compare: ${esc(docA.title||'A')} vs ${esc(docB.title||'B')}</title><style>*{margin:0;box-sizing:border-box}body{font-family:system-ui;background:#0a0a0e;color:#e0e0e0;display:grid;grid-template-columns:1fr 1fr;height:100vh;overflow:hidden}.panel{padding:24px;overflow-y:auto;border-right:1px solid #222}.panel:last-child{border:none}h2{font-size:16px;color:#4ade80;margin-bottom:4px}.meta{font-size:11px;color:#888;margin-bottom:16px}.content{line-height:1.8;font-size:14px;white-space:pre-wrap}h1,h2,h3{color:#fff}</style></head><body><div class="panel"><h2>${esc(docA.title||'Untitled')}</h2><div class="meta">${countW(docA.body)} words | Updated: ${docA.updated?new Date(docA.updated).toLocaleDateString():'?'}</div><div class="content">${docA.body||'(empty)'}</div></div><div class="panel"><h2>${esc(docB.title||'Untitled')}</h2><div class="meta">${countW(docB.body)} words | Updated: ${docB.updated?new Date(docB.updated).toLocaleDateString():'?'}</div><div class="content">${docB.body||'(empty)'}</div></div></body></html>`);
  w.document.close();toast('Comparing: '+docA.title+' vs '+docB.title);
}
function writerSplitDoc(){
  const doc=getActiveDoc();if(!doc){toast('No active doc');return;}
  const body=doc.body||'';
  const parts=body.split(/\n---\n|^---\n|\n---$/gm).map(p=>p.trim()).filter(Boolean);
  if(parts.length<2){toast('No --- separators found (need at least 2 sections)');return;}
  if(!confirm('Split into '+parts.length+' documents? The original will keep Part 1.')){return;}
  doc.body=parts[0];doc.updated=new Date().toISOString();
  for(let i=1;i<parts.length;i++){
    const title=(doc.title||'Untitled')+' (Part '+(i+1)+')';
    S.docs.push({id:Date.now()+i,title,body:parts[i],created:new Date().toISOString(),updated:new Date().toISOString()});
  }
  save();renderDocList();updateWS();toast('Split into '+parts.length+' docs');
}
function writerFromTemplate(type){
  const templates={
    meeting:{title:'Meeting Notes — '+new Date().toLocaleDateString(),body:'## Attendees\n\n- \n\n## Agenda\n\n1. \n\n## Discussion\n\n\n\n## Action Items\n\n- [ ] \n\n## Next Steps\n\n'},
    blog:{title:'Blog Post Draft',body:'# Title\n\n## Introduction\n\nHook the reader here.\n\n## Main Point 1\n\n\n\n## Main Point 2\n\n\n\n## Main Point 3\n\n\n\n## Conclusion\n\nCall to action.\n\n## Tags\n\n'},
    spec:{title:'Project Spec — ',body:'# Project Name\n\n## Overview\n\nOne-paragraph summary.\n\n## Problem Statement\n\nWhat problem does this solve?\n\n## Goals\n\n- \n\n## Non-Goals\n\n- \n\n## Proposed Solution\n\n\n\n## Technical Approach\n\n\n\n## Timeline\n\n| Phase | Target | Status |\n|-------|--------|--------|\n| Phase 1 |  |  |\n\n## Open Questions\n\n- \n'},
    journal:{title:'Journal — '+new Date().toLocaleDateString(),body:'## Today\n\n**Mood:** \n\n**Energy:** /10\n\n## What happened\n\n\n\n## What I learned\n\n\n\n## Gratitude\n\n1. \n2. \n3. \n\n## Tomorrow\n\n- \n'},
    outline:{title:'Outline',body:'# Title\n\n## I. Introduction\n   A. \n   B. \n\n## II. First Section\n   A. \n   B. \n   C. \n\n## III. Second Section\n   A. \n   B. \n\n## IV. Third Section\n   A. \n   B. \n\n## V. Conclusion\n   A. \n   B. \n'}
  };
  const tpl=templates[type];if(!tpl)return;
  const doc={id:Date.now(),title:tpl.title,body:tpl.body,created:new Date().toISOString(),updated:new Date().toISOString()};
  S.docs.push(doc);save();switchDoc(doc.id);renderDocList();toast('Created from template: '+type);
  document.querySelectorAll('.writer-toolbar-btn+div[style*="display: block"],.writer-toolbar-btn+div[style*="display:block"]').forEach(d=>d.style.display='none');
}
function exportAllTasksHTML(){
  if(!S.tasks.length){toast('No tasks');return;}
  const today=new Date().toISOString().split('T')[0];const active=S.tasks.filter(t=>t.status!=='done');const done=S.tasks.filter(t=>t.status==='done');
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>All Tasks - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:20px;color:#fff;margin-top:32px}hr{border:none;border-top:1px solid #222;margin:16px 0}.task{padding:8px 0;border-bottom:1px solid #1a1a1e}.title{font-weight:600}.done .title{text-decoration:line-through;color:#666}.meta{font-size:12px;color:#888;margin-top:2px}.desc{font-size:13px;color:#aaa;margin-top:4px}.p0{border-left:3px solid #ef4444;padding-left:8px}.p1{border-left:3px solid #f59e0b;padding-left:8px}.p2{border-left:3px solid #3b82f6;padding-left:8px}.p3{border-left:3px solid #666;padding-left:8px}.badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:10px;margin-right:4px}a{color:#4ade80}.sub{font-size:12px;color:#888;padding-left:16px}</style></head><body>';
  h+='<h1>All Tasks</h1><p style="color:#888;font-size:13px">'+S.tasks.length+' tasks ('+active.length+' active, '+done.length+' done) | Exported '+new Date().toLocaleDateString()+'</p>';
  const byProject={};S.tasks.forEach(t=>{const p=t.project||'No Project';if(!byProject[p])byProject[p]=[];byProject[p].push(t);});
  Object.entries(byProject).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([proj,tasks])=>{
    h+='<h2>'+esc(proj)+'</h2><hr>';
    tasks.forEach(t=>{h+='<div class="task '+(t.priority||'p2')+' '+(t.status==='done'?'done':'')+'"><div class="title">'+(t.status==='done'?'[x] ':'[ ] ')+esc(t.title||'Untitled')+'</div><div class="meta">'+(t.priority||'p2').toUpperCase()+' | '+t.status+(t.due?' | Due: '+t.due:'')+(t.estimate?' | Est: '+t.estimate:'')+(t.timeSpent?' | Tracked: '+formatTimeSpent(t.timeSpent):'')+'</div>'+(t.description?'<div class="desc">'+esc(t.description)+'</div>':'')+((t.subtasks&&t.subtasks.length)?t.subtasks.map(s=>'<div class="sub">'+(s.done?'[x] ':'[ ] ')+esc(s.title)+'</div>').join(''):'')+'</div>';});
  });
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-tasks-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.tasks.length+' tasks as HTML');
}
function exportAllLinksHTML(){
  if(!S.links.length){toast('No links');return;}
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>All Links - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:20px;color:#fff;margin-top:32px}hr{border:none;border-top:1px solid #222;margin:16px 0}.link{padding:8px 0;border-bottom:1px solid #1a1a1e}a{color:#4ade80;text-decoration:none}a:hover{text-decoration:underline}.meta{font-size:12px;color:#888;margin-top:2px}.desc{font-size:13px;color:#aaa;margin-top:4px}</style></head><body>';
  h+='<h1>All Links</h1><p style="color:#888;font-size:13px">'+S.links.length+' links | Exported '+new Date().toLocaleDateString()+'</p>';
  const byCat={};S.links.forEach(l=>{const c=l.category||'Uncategorized';if(!byCat[c])byCat[c]=[];byCat[c].push(l);});
  Object.entries(byCat).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([cat,links])=>{
    h+='<h2>'+esc(cat)+' ('+links.length+')</h2><hr>';
    links.forEach(l=>{h+='<div class="link"><a href="'+escA(l.url)+'" target="_blank">'+esc(l.title||l.url)+'</a><div class="meta">'+esc(l.url)+(l.created?' | Added '+new Date(l.created).toLocaleDateString():'')+'</div>'+(l.desc?'<div class="desc">'+esc(l.desc)+'</div>':'')+'</div>';});
  });
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-links-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.links.length+' links as HTML');
}
function exportAllContentMD(){
  if(!S.content.length){toast('No content');return;}
  let md='# Content Library\n\nExported: '+new Date().toLocaleDateString()+' | '+S.content.length+' items\n\n---\n\n';
  const byType={};S.content.forEach(c=>{const t=c.type||'other';if(!byType[t])byType[t]=[];byType[t].push(c);});
  Object.entries(byType).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([type,items])=>{
    md+='## '+type.charAt(0).toUpperCase()+type.slice(1)+' ('+items.length+')\n\n';
    items.forEach(c=>{md+='### '+(c.theme||'Untitled')+'\n';if(c.tags&&c.tags.length)md+='Tags: '+c.tags.join(', ')+'\n';if(c.created)md+='*'+new Date(c.created).toLocaleDateString()+'*\n';md+='\n'+c.body+'\n\n---\n\n';});
  });
  const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-content-'+new Date().toISOString().split('T')[0]+'.md';a.click();toast('Exported '+S.content.length+' content items');
}
function htmlToMd(html,title){let md='# '+(title||'Untitled')+'\n\n';const tmp=document.createElement('div');tmp.innerHTML=html;const walk=n=>{if(n.nodeType===3)return n.textContent;if(n.nodeType!==1)return'';const tag=n.tagName.toLowerCase(),ch=Array.from(n.childNodes).map(walk).join('');switch(tag){case'h1':return'\n# '+ch+'\n\n';case'h2':return'\n## '+ch+'\n\n';case'h3':return'\n### '+ch+'\n\n';case'p':return ch+'\n\n';case'br':return'\n';case'strong':case'b':return'**'+ch+'**';case'em':case'i':return'*'+ch+'*';case'code':return'`'+ch+'`';case'pre':return'\n```\n'+ch+'\n```\n\n';case'blockquote':return'\n> '+ch.replace(/\n/g,'\n> ')+'\n\n';case'ul':return'\n'+ch+'\n';case'ol':return'\n'+ch+'\n';case'li':return'- '+ch+'\n';case'a':return'['+ch+']('+n.href+')';case'hr':return'\n---\n\n';case'div':return ch+'\n';default:return ch;}};md+=Array.from(tmp.childNodes).map(walk).join('');return md.replace(/\n{3,}/g,'\n\n').trim()+'\n';}

function simpleMarkdown(text){
  if(!text)return'';
  let h=esc(text);
  h=h.replace(/^### (.+)$/gm,'<span style="font-weight:600;font-size:11px;color:var(--accent)">$1</span>');
  h=h.replace(/^## (.+)$/gm,'<span style="font-weight:600;font-size:12px;color:var(--text-primary)">$1</span>');
  h=h.replace(/^# (.+)$/gm,'<span style="font-weight:700;font-size:13px;color:var(--text-primary)">$1</span>');
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*(.+?)\*/g,'<em>$1</em>');
  h=h.replace(/`([^`]+)`/g,'<code style="background:var(--bg-elevated);padding:1px 3px;border-radius:2px;font-size:0.9em">$1</code>');
  h=h.replace(/^[-*] (.+)$/gm,'<span style="padding-left:8px">&#8226; $1</span>');
  h=h.replace(/^&gt; (.+)$/gm,'<span style="border-left:2px solid var(--accent);padding-left:6px;color:var(--text-muted);font-style:italic;display:block">$1</span>');
  h=h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" style="color:var(--accent);text-decoration:underline dotted" onclick="event.stopPropagation()">$1</a>');
  h=h.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid var(--border);margin:4px 0">');
  return h;
}
// === ZEN WRITER (full-screen distraction-free) ===
let zenDocId = null;
let zenTimer = null;
let zenIsOpen = false;

function zenOpen(docId) {
  zenIsOpen = true;
  const zw = document.getElementById('zen-writer');
  // Snapshot current writer state if in writer section
  if(currentSection === 'writer') snapshotWriter();
  // Pick doc
  if(docId) { zenDocId = docId; }
  else if(!zenDocId) { zenDocId = S.activeDoc || (S.docs[0] && S.docs[0].id); }
  zenRenderPicker();
  zenLoadDoc();
  zw.classList.add('open');
  document.getElementById('zen-fab').style.display = 'none';
  setTimeout(function(){ document.getElementById('zen-editor').focus(); }, 100);
}

function zenClose() {
  zenSnapshot();
  save();
  zenIsOpen = false;
  document.getElementById('zen-writer').classList.remove('open');
  document.getElementById('zen-fab').style.display = '';
  // Sync back to writer section if active
  if(currentSection === 'writer') { renderWriter(); }
}

function zenRenderPicker() {
  const sel = document.getElementById('zen-doc-picker');
  sel.innerHTML = S.docs.map(function(d) {
    return '<option value="' + d.id + '"' + (d.id === zenDocId ? ' selected' : '') + '>' + esc(d.title || 'Untitled') + ' (' + countW(d.body) + 'w)</option>';
  }).join('');
}

function zenPickDoc(id) {
  zenSnapshot();
  save();
  zenDocId = parseInt(id) || id;
  zenLoadDoc();
}

function zenLoadDoc() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d && S.docs.length) { d = S.docs[0]; zenDocId = d.id; }
  if(!d) return;
  document.getElementById('zen-title').value = d.title || '';
  document.getElementById('zen-editor').innerHTML = d.body || '';
  zenUpdateStats();
}

function zenSnapshot() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  var t = document.getElementById('zen-title');
  var e = document.getElementById('zen-editor');
  if(!t || !e) return;
  d.title = t.value;
  d.body = e.innerHTML;
  d.updated = new Date().toISOString();
}

function zenOnChange() {
  clearTimeout(zenTimer);
  document.getElementById('zen-saved').textContent = 'Unsaved';
  document.getElementById('zen-saved').style.color = 'var(--yellow)';
  zenTimer = setTimeout(function() {
    zenSnapshot();
    save();
    zenRenderPicker();
    document.getElementById('zen-saved').textContent = 'Saved';
    document.getElementById('zen-saved').style.color = 'var(--green)';
  }, 800);
  zenUpdateStats();
}

function zenUpdateStats() {
  var e = document.getElementById('zen-editor');
  var t = e.innerText || '';
  var w = t.trim().split(/\s+/).filter(function(x){ return x.length; }).length;
  document.getElementById('zen-words').textContent = w + ' words';
  document.getElementById('zen-chars').textContent = t.length + ' chars';
  document.getElementById('zen-reading').textContent = Math.max(1, Math.ceil(w / 238)) + ' min read';
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  var goal = d && d.wordGoal ? d.wordGoal : 0;
  var goalEl = document.getElementById('zen-goal');
  if(goal > 0) {
    var pct = Math.min(100, Math.round(w / goal * 100));
    goalEl.textContent = pct + '% of ' + goal + 'w goal';
    goalEl.style.color = pct >= 100 ? 'var(--green)' : 'var(--accent-cyan)';
  } else {
    goalEl.textContent = 'Set goal';
    goalEl.style.color = 'var(--text-muted)';
  }
}

function zenSetGoal() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  var g = prompt('Word count goal:', d.wordGoal || '');
  if(g === null) return;
  d.wordGoal = parseInt(g) || 0;
  save();
  zenUpdateStats();
}

function zenNewDoc() {
  zenSnapshot();
  var d = { id: Date.now(), title: '', body: '', versions: [], created: new Date().toISOString(), updated: new Date().toISOString() };
  S.docs.unshift(d);
  zenDocId = d.id;
  S.activeDoc = d.id;
  save();
  zenRenderPicker();
  zenLoadDoc();
  document.getElementById('zen-title').focus();
}

function zenCmd(c) { document.execCommand(c, false, null); document.getElementById('zen-editor').focus(); }
function zenExecBlock(tag) { document.execCommand('formatBlock', false, '<' + tag + '>'); document.getElementById('zen-editor').focus(); }
function zenInsertLink() { var u = prompt('URL:'); if(u) document.execCommand('createLink', false, u); document.getElementById('zen-editor').focus(); }
function zenInsertHR() { document.execCommand('insertHTML', false, '<hr>'); document.getElementById('zen-editor').focus(); }
function zenInsertCode() { var s = window.getSelection(); if(s.rangeCount) document.execCommand('insertHTML', false, '<code>' + (esc(s.toString()) || 'code') + '</code>'); }
function zenClearFormat() { document.execCommand('removeFormat', false, null); document.getElementById('zen-editor').focus(); }

function zenKeydown(e) {
  if(e.key === 'Tab') { e.preventDefault(); document.execCommand('insertHTML', false, '&nbsp;&nbsp;&nbsp;&nbsp;'); }
  if((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); zenSaveVersion(); }
}

function zenSaveVersion() {
  zenSnapshot();
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  if(!d.versions) d.versions = [];
  d.versions.unshift({ id: Date.now(), title: d.title, body: d.body, words: countW(d.body), date: new Date().toISOString() });
  if(d.versions.length > 50) d.versions = d.versions.slice(0, 50);
  save();
  toast('Version saved');
  document.getElementById('zen-saved').textContent = 'Version saved';
  document.getElementById('zen-saved').style.color = 'var(--accent)';
}

function zenExport(fmt) {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d || !fmt) return;
  var t = d.title || 'untitled';
  var e = document.getElementById('zen-editor');
  if(fmt === 'clipboard') { navigator.clipboard.writeText(e.innerText); toast('Copied to clipboard'); return; }
  var c, m, x;
  if(fmt === 'txt') { c = e.innerText; m = 'text/plain'; x = 'txt'; }
  else if(fmt === 'html') {
    c = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + esc(t) + '</title><style>body{font-family:Georgia,"Times New Roman",serif;max-width:680px;margin:40px auto;padding:0 24px;line-height:1.9;color:#1a1a1a;font-size:18px}h1{font-size:32px;margin-bottom:8px}h2{font-size:24px;margin-top:32px}h3{font-size:20px}blockquote{border-left:3px solid #bbb;padding-left:16px;color:#666;font-style:italic}code{background:#f0f0f0;padding:2px 5px;border-radius:3px;font-size:15px}pre{background:#f5f5f5;padding:16px;border-radius:8px;overflow-x:auto;font-size:14px}a{color:#2563eb}</style></head><body><h1>' + esc(t) + '</h1>' + e.innerHTML + '</body></html>';
    m = 'text/html'; x = 'html';
  } else if(fmt === 'md') { c = htmlToMd(e.innerHTML, t); m = 'text/markdown'; x = 'md'; }
  var blob = new Blob([c], { type: m });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = t.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.' + x;
  a.click();
  toast('Exported .' + x);
}

// === LIVING DOCS ===
function getActiveSpec(){return S.specs.find(s=>String(s.id)===String(S.activeSpec));}
function renderSpecs(){renderSpecList();loadSpec();document.getElementById('specs-count').textContent=S.specs.length;const totalSpecW=S.specs.reduce((a,s)=>a+(s.sections||[]).reduce((b,sec)=>b+countW(sec.body),0),0);const swEl=document.getElementById('specs-word-total');if(swEl)swEl.textContent=totalSpecW.toLocaleString()+'w total';}
function renderSpecList(){const sq=(document.getElementById('spec-list-search')?.value||'').toLowerCase();const ssort=(document.getElementById('spec-list-sort')?.value)||'updated';let specList=[...S.specs];if(sq)specList=specList.filter(s=>(s.title||'').toLowerCase().includes(sq));if(ssort==='alpha')specList.sort((a,b)=>(a.title||'').localeCompare(b.title||''));else if(ssort==='words')specList.sort((a,b)=>(b.sections||[]).reduce((x,sec)=>x+countW(sec.body),0)-(a.sections||[]).reduce((x,sec)=>x+countW(sec.body),0));else if(ssort==='sections')specList.sort((a,b)=>(b.sections||[]).length-(a.sections||[]).length);else if(ssort==='project'){specList.sort((a,b)=>{const pa=(S.projects||[]).find(p=>p.id===a.projectId);const pb=(S.projects||[]).find(p=>p.id===b.projectId);return(pa?pa.name:'zzz').localeCompare(pb?pb.name:'zzz');});}else specList.sort((a,b)=>(new Date(b.updated||0))-(new Date(a.updated||0)));const renderSpecItem=s=>{const sc=s.sections?s.sections.length:0;const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);const dt=s.updated?new Date(s.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';const ic=s.icon||'file';const c=s.color||'#8b8b8b';const path=specSectionIcon(ic);const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;return`<div class="specs-doc-item ${String(s.id)===String(S.activeSpec)?'active':''}" onclick="switchSpec('${s.id}')"><div style="display:flex;align-items:center;gap:6px"><span style="color:${c};display:flex;flex-shrink:0"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><div class="specs-doc-title">${esc(s.title||'Untitled Spec')}</div></div><div class="specs-doc-meta"><span>${sc} sec / ${wc}w</span>${proj?`<span style="color:${proj.color||c}">${esc(proj.name)}</span>`:'<span>unassigned</span>'}<span>${dt}</span><span style="margin-left:auto;cursor:pointer;opacity:0.4;font-size:8px" onclick="event.stopPropagation();dupSpec('${s.id}')" title="Duplicate">D</span>${S.specs.length>1?`<span style="cursor:pointer;opacity:0.4" onclick="event.stopPropagation();delSpec('${s.id}')">x</span>`:''}</div></div>`;};
  const specWcGrp=wc=>{if(wc===0)return'Empty';if(wc<100)return'Short (<100w)';if(wc<500)return'Medium (100-500w)';return'Long (500w+)';};
  const specSecGrp=sc=>{if(sc<=1)return'1 section';if(sc<=3)return'2-3 sections';if(sc<=5)return'4-5 sections';return'6+ sections';};
  let specHtml='';if(ssort==='project'||ssort==='alpha'||ssort==='words'||ssort==='sections'){let lastGrp=null;specList.forEach(s=>{let grp;let clr='var(--accent)';if(ssort==='project'){const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;grp=proj?proj.name:'Unassigned';clr=proj?proj.color||'var(--accent)':'var(--text-muted)';}else if(ssort==='alpha'){grp=(s.title||'U')[0].toUpperCase();clr='var(--accent)';}else if(ssort==='words'){const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);grp=specWcGrp(wc);clr='var(--accent-cyan)';}else if(ssort==='sections'){grp=specSecGrp((s.sections||[]).length);clr='#f59e0b';}if(grp!==lastGrp){const cnt=specList.filter(x=>{if(ssort==='project'){const xp=x.projectId?(S.projects||[]).find(p=>p.id===x.projectId):null;return(xp?xp.name:'Unassigned')===grp;}if(ssort==='alpha')return(x.title||'U')[0].toUpperCase()===grp;if(ssort==='words')return specWcGrp((x.sections||[]).reduce((a,sec)=>a+countW(sec.body),0))===grp;return specSecGrp((x.sections||[]).length)===grp;}).length;specHtml+=`<div style="padding:6px 8px 3px;font-size:10px;font-weight:600;color:${clr};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border)">${esc(grp)} <span style="font-size:8px;font-weight:400;color:var(--text-muted)">${cnt}</span></div>`;lastGrp=grp;}specHtml+=renderSpecItem(s);});}else{specHtml=specList.map(renderSpecItem).join('');}
  document.getElementById('specs-doc-list').innerHTML=specHtml;}
function loadSpec(){const s=getActiveSpec();if(!s)return;document.getElementById('specs-title').value=s.title||'';const spa=document.getElementById('spec-project-assign');if(spa){spa.innerHTML='<option value="">No Project</option>'+(S.projects||[]).map(p=>`<option value="${p.id}" ${s.projectId===p.id?'selected':''}>${esc(p.name)}</option>`).join('');}renderSpecSections();updateSpecStatus();}
function assignSpecProject(pid){const s=getActiveSpec();if(!s)return;s.projectId=pid||undefined;save();renderSpecList();toast(pid?'Assigned to project':'Removed project');}
function switchSpec(id){if(String(S.activeSpec)===String(id))return;snapshotSpec();save();S.activeSpec=id;renderSpecs();const s=S.specs.find(x=>String(x.id)===String(id));if(s)trackRecent('spec',id,s.title);save();updateBreadcrumb();}
function newSpecFromTemplate(tpl){if(!tpl)return;const templates={prd:{title:'Product Requirements',sections:['Overview','Problem Statement','Goals','User Stories','Requirements','Success Metrics','Timeline']},rfc:{title:'RFC',sections:['Summary','Motivation','Detailed Design','Drawbacks','Alternatives','Unresolved Questions']},retro:{title:'Retrospective',sections:['What Went Well','What Could Improve','Action Items','Key Metrics','Follow-ups']},checklist:{title:'Checklist',sections:['Pre-Launch','During','Post-Launch','Review']}};const t=templates[tpl];if(!t)return;snapshotSpec();const now=Date.now();const s={id:now,title:t.title,sections:t.sections.map((title,i)=>({id:'sec_'+(now+i+1),title,body:'',collapsed:false})),created:new Date().toISOString(),updated:new Date().toISOString()};if(activeProject)s.projectId=activeProject;S.specs.unshift(s);S.activeSpec=s.id;save();renderSpecs();toast('Created: '+t.title);}
function newSpec(){snapshotSpec();const s={id:Date.now(),title:'',sections:[{id:Date.now()+1,title:'Overview',body:'',collapsed:false}],created:new Date().toISOString(),updated:new Date().toISOString()};S.specs.unshift(s);S.activeSpec=s.id;save();renderSpecs();document.getElementById('specs-title').focus();}
function delSpec(id){if(S.specs.length<=1){toast('Cannot delete last spec');return;}S.specs=S.specs.filter(s=>String(s.id)!==String(id));if(String(S.activeSpec)===String(id))S.activeSpec=S.specs[0].id;save();renderSpecs();toast('Deleted');}
function dupSpec(id){const s=S.specs.find(x=>String(x.id)===String(id));if(!s)return;const dup={...JSON.parse(JSON.stringify(s)),id:Date.now(),title:(s.title||'Spec')+' (copy)',created:new Date().toISOString(),updated:new Date().toISOString()};dup.sections=dup.sections.map(sec=>({...sec,id:'sec_'+Date.now()+Math.random()*1000}));S.specs.unshift(dup);S.activeSpec=dup.id;save();renderSpecs();toast('Duplicated: '+dup.title.substring(0,30));}
function snapshotSpec(){const s=getActiveSpec();if(!s)return;const t=document.getElementById('specs-title');if(t)s.title=t.value;if(!s.sections)s.sections=[];s.sections.forEach(sec=>{const el=document.getElementById('spec-editor-'+sec.id);if(el)sec.body=el.innerHTML;const tEl=document.getElementById('spec-title-'+sec.id);if(tEl)sec.title=tEl.value;});s.updated=new Date().toISOString();}
function specSectionIcon(name){const m={palette:'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z',cpu:'M18 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2z',layers:'M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5',alert:'M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01',flag:'M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1zM4 22v-7',link:'M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71',file:'M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z',globe:'M12 2a10 10 0 100 20 10 10 0 000-20z',lock:'M19 11H5a2 2 0 00-2 2v7a2 2 0 002 2h14a2 2 0 002-2v-7a2 2 0 00-2-2zM7 11V7a5 5 0 0110 0v4',refresh:'M23 4v6h-6M1 20v-6h6',users:'M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2',list:'M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01',mail:'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z',hdd:'M22 12H2M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z',rocket:'M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 00-2.91-.09zM12 15l-3-3M22 2l-7.5 7.5',book:'M4 19.5A2.5 2.5 0 016.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z',heart:'M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z',target:'M12 22a10 10 0 100-20 10 10 0 000 20zM12 18a6 6 0 100-12 6 6 0 000 12zM12 14a2 2 0 100-4 2 2 0 000 4z',terminal:'M4 17l6-6-6-6M12 19h8',code:'M16 18l6-6-6-6M8 6l-6 6 6 6'};return m[name]||m.file;}
function renderSpecSections(){const s=getActiveSpec();if(!s)return;const el=document.getElementById('specs-sections');const secColors=['#4ade80','#22d3ee','#8b5cf6','#f59e0b','#ef4444','#a78bfa','#06b6d4','#ec4899'];el.innerHTML=(s.sections||[]).map((sec,i)=>{const c=sec.color||secColors[i%secColors.length];const ic=sec.icon||'file';const path=specSectionIcon(ic);return`<div class="specs-section ${sec.collapsed?'collapsed':''}" data-id="${sec.id}" draggable="true" ondragstart="specDragStart(event,'${sec.id}')" ondragover="specDragOver(event)" ondragleave="event.currentTarget.style.borderTop=''" ondrop="specDrop(event,'${sec.id}')"><div class="specs-section-header" onclick="toggleSpecSection('${sec.id}')"><span class="spec-drag-handle" style="cursor:grab;opacity:0.3;font-size:10px;padding:0 4px;display:flex;align-items:center" onmousedown="event.stopPropagation()" title="Drag to reorder">::</span><span class="specs-section-toggle">v</span><span class="spec-sec-icon" style="color:${c};flex-shrink:0;display:flex;align-items:center" onclick="event.stopPropagation();cycleSecIcon('${sec.id}')" title="Click to change icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><input type="text" class="specs-section-title" id="spec-title-${sec.id}" value="${escA(sec.title||'Section '+(i+1))}" onclick="event.stopPropagation()" oninput="onSpecChange()" style="background:transparent;border:none;color:var(--text);font-size:12px;font-weight:600;flex:1;padding:0"><div style="display:flex;gap:2px;opacity:0.4"><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);margin-right:4px">${countW(sec.body)}w</span><button class="task-action-btn" onclick="event.stopPropagation();copySpecSection('${sec.id}')" title="Copy section" style="font-size:8px">C</button><button class="task-action-btn" onclick="event.stopPropagation();moveSpecSection('${sec.id}',-1)" title="Move up" style="font-size:10px">^</button><button class="task-action-btn" onclick="event.stopPropagation();moveSpecSection('${sec.id}',1)" title="Move down" style="font-size:10px">v</button><button class="task-action-btn del" onclick="event.stopPropagation();delSpecSection('${sec.id}')" title="Delete">x</button></div></div><div class="specs-section-body"><div class="specs-section-editor" id="spec-editor-${sec.id}" contenteditable="true" oninput="onSpecChange()">${sec.body||''}</div></div></div>`;}).join('')+`<div class="specs-add-section" onclick="addSpecSection()">+ Add Section</div>`;}
function addSpecSection(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.push({id:'sec_'+Date.now(),title:'New Section',body:'',collapsed:false});save();renderSpecSections();}
function delSpecSection(id){const s=getActiveSpec();if(!s||s.sections.length<=1)return;snapshotSpec();s.sections=s.sections.filter(x=>String(x.id)!==String(id));save();renderSpecSections();}
function copySpecSection(id){const s=getActiveSpec();if(!s)return;snapshotSpec();const sec=s.sections.find(x=>String(x.id)===String(id));if(!sec)return;const d=document.createElement('div');d.innerHTML=sec.body||'';const text='## '+(sec.title||'Section')+'\n\n'+(d.innerText||'');navigator.clipboard.writeText(text).then(()=>toast('Section copied'));}
function toggleSpecSection(id){const s=getActiveSpec();if(!s)return;const sec=s.sections.find(x=>String(x.id)===String(id));if(sec){sec.collapsed=!sec.collapsed;renderSpecSections();}}
function moveSpecSection(id,dir){const s=getActiveSpec();if(!s)return;snapshotSpec();const i=s.sections.findIndex(x=>String(x.id)===String(id));const ni=i+dir;if(ni<0||ni>=s.sections.length)return;[s.sections[i],s.sections[ni]]=[s.sections[ni],s.sections[i]];save();renderSpecSections();}
let specDragSectionId=null;
function specDragStart(e,id){specDragSectionId=id;e.dataTransfer.effectAllowed='move';}
function specDragOver(e){e.preventDefault();e.currentTarget.style.borderTop='2px solid var(--accent)';}
function specDrop(e,targetId){e.preventDefault();e.currentTarget.style.borderTop='';if(!specDragSectionId||specDragSectionId===targetId)return;const s=getActiveSpec();if(!s)return;snapshotSpec();const fi=s.sections.findIndex(x=>String(x.id)===specDragSectionId);const ti=s.sections.findIndex(x=>String(x.id)===targetId);if(fi<0||ti<0)return;const[item]=s.sections.splice(fi,1);s.sections.splice(ti,0,item);specDragSectionId=null;save();renderSpecSections();}
const specIconList=['file','palette','cpu','layers','alert','flag','link','globe','lock','refresh','users','list','mail','hdd','rocket','book','heart','target','terminal','code'];
const specColorList=['#4ade80','#22d3ee','#8b5cf6','#f59e0b','#ef4444','#a78bfa','#06b6d4','#ec4899','#facc15','#fb923c'];
function cycleSecIcon(id){const s=getActiveSpec();if(!s)return;const sec=s.sections.find(x=>String(x.id)===String(id));if(!sec)return;const cur=specIconList.indexOf(sec.icon||'file');sec.icon=specIconList[(cur+1)%specIconList.length];const ci=specColorList.indexOf(sec.color||'#8b8b8b');sec.color=specColorList[(ci+1)%specColorList.length];save();renderSpecSections();}
function collapseAllSections(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.forEach(x=>x.collapsed=true);save();renderSpecSections();}
function expandAllSections(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.forEach(x=>x.collapsed=false);save();renderSpecSections();}
function specSearch(){const q=(document.getElementById('spec-search')?.value||'').toLowerCase();const s=getActiveSpec();if(!s)return;if(!q){s.sections.forEach(x=>x.collapsed=false);renderSpecSections();return;}s.sections.forEach(sec=>{const title=(sec.title||'').toLowerCase();const d=document.createElement('div');d.innerHTML=sec.body||'';const body=(d.innerText||'').toLowerCase();sec.collapsed=!(title.includes(q)||body.includes(q));});renderSpecSections();}
function onSpecChange(){clearTimeout(specTimer);document.getElementById('specs-status').textContent='Unsaved';document.getElementById('specs-status').style.color='var(--yellow)';specTimer=setTimeout(()=>{snapshotSpec();save();renderSpecList();document.getElementById('specs-status').textContent='Saved';document.getElementById('specs-status').style.color='var(--green)';updateSpecStatus();},1000);}
function updateSpecStatus(){const s=getActiveSpec();if(!s)return;let total=0;(s.sections||[]).forEach(sec=>{total+=countW(sec.body);});document.getElementById('specs-word-count').textContent=total+' words';}
function specExport(fmt){if(!fmt)return;snapshotSpec();const s=getActiveSpec();if(!s)return;const t=s.title||'spec';let c;if(fmt==='clipboard'){let txt=t+'\n'+'='.repeat(t.length)+'\n\n';(s.sections||[]).forEach(sec=>{txt+=sec.title+'\n'+'-'.repeat(sec.title.length)+'\n';const d=document.createElement('div');d.innerHTML=sec.body||'';txt+=(d.innerText||'')+'\n\n';});navigator.clipboard.writeText(txt);toast('Copied');return;}if(fmt==='md'){c='# '+t+'\n\n';(s.sections||[]).forEach(sec=>{c+='## '+sec.title+'\n\n';c+=htmlToMd(sec.body||'',null).replace(/^# .*\n\n/,'')+'\n';});}else if(fmt==='html'){c=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(t)}</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#222}h1{font-size:28px;border-bottom:2px solid #eee;padding-bottom:8px}h2{font-size:20px;margin-top:24px;color:#333}blockquote{border-left:3px solid #ccc;padding-left:16px;color:#666;font-style:italic}code{background:#f4f4f4;padding:1px 4px;border-radius:3px}</style></head><body><h1>${esc(t)}</h1>`+(s.sections||[]).map(sec=>`<h2>${esc(sec.title)}</h2>${sec.body||''}`).join('')+'</body></html>';}const blob=new Blob([c],{type:fmt==='md'?'text/markdown':'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=t.replace(/[^a-z0-9]/gi,'-').toLowerCase()+'.'+(fmt==='md'?'md':'html');a.click();toast('Exported');}

function exportAllSpecs(){
  snapshotSpec();
  let md='# Living Docs Export\nGenerated: '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n'+S.specs.length+' specs total\n\n';
  S.specs.forEach(s=>{
    const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;
    md+='---\n\n# '+(s.title||'Untitled Spec')+(proj?' ('+proj.name+')':'')+'\n\n';
    (s.sections||[]).forEach(sec=>{
      md+='## '+(sec.title||'Section')+'\n\n';
      const d=document.createElement('div');d.innerHTML=sec.body||'';
      md+=(d.innerText||'(empty)')+'\n\n';
    });
  });
  navigator.clipboard.writeText(md).then(()=>toast('All '+S.specs.length+' specs copied as markdown'));
}
function exportAllSpecsHTML(){
  snapshotSpec();if(!S.specs.length){toast('No specs');return;}
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Living Docs - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:22px;color:#22d3ee;margin-top:32px}h3{font-size:16px;color:#fff;margin-top:16px;padding:6px 0;border-bottom:1px solid #222}hr{border:none;border-top:1px solid #222;margin:24px 0}.meta{font-size:11px;color:#888;margin-bottom:8px}.section{margin:12px 0;padding:12px;background:#101014;border-radius:8px;border-left:3px solid #22d3ee}a{color:#4ade80}</style></head><body>';
  h+='<h1>Living Docs</h1><p style="color:#888;font-size:13px">'+S.specs.length+' specs | Exported '+new Date().toLocaleDateString()+'</p>';
  S.specs.forEach(s=>{const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);h+='<hr><h2>'+esc(s.title||'Untitled')+'</h2><div class="meta">'+(proj?esc(proj.name)+' | ':'')+wc+' words | '+(s.sections||[]).length+' sections</div>';(s.sections||[]).forEach(sec=>{h+='<div class="section"><h3>'+esc(sec.title||'Section')+'</h3><div>'+(sec.body||'<em>empty</em>')+'</div></div>';});});
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-specs-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.specs.length+' specs as HTML');
}
function saveSpecVersion(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  if(!s.versions)s.versions=[];
  const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);
  s.versions.unshift({id:Date.now(),title:s.title,sections:JSON.parse(JSON.stringify(s.sections||[])),words:wc,date:new Date().toISOString()});
  if(s.versions.length>20)s.versions=s.versions.slice(0,20);
  save();toast('Spec version saved ('+wc+'w, '+(s.sections||[]).length+' sections)');
}
function showSpecVersions(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  if(!s.versions||!s.versions.length){toast('No versions saved. Click v+ to save first.');return;}
  let existing=document.getElementById('spec-versions-panel');if(existing){existing.remove();return;}
  const panel=document.createElement('div');panel.id='spec-versions-panel';
  panel.style.cssText='position:fixed;right:20px;top:80px;width:260px;max-height:70vh;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
  const curWc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);
  let html='<div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:8px;display:flex;justify-content:space-between"><span>Spec Versions ('+s.versions.length+')</span><span onclick="this.closest(\'#spec-versions-panel\').remove()" style="cursor:pointer;font-size:12px;color:var(--text-muted)">x</span></div>';
  s.versions.forEach((v,i)=>{
    const diff=v.words-curWc;const diffStr=diff>0?'+'+diff:diff<0?''+diff:'=';
    html+=`<div style="padding:8px;margin-bottom:4px;background:var(--bg-secondary);border-radius:4px;border:1px solid var(--border)"><div style="font-size:10px;font-weight:600;color:var(--text)">${esc(v.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">${timeAgo(v.date)} | ${v.words}w | ${v.sections.length} secs <span style="color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--text-muted)'}">${diffStr}w</span></div><div style="display:flex;gap:4px;margin-top:4px"><button class="btn btn-sm btn-ghost" onclick="restoreSpecVersion(${i})" style="font-size:8px;padding:1px 5px">Restore</button><button class="btn btn-sm btn-ghost btn-danger" onclick="deleteSpecVersion(${i})" style="font-size:8px;padding:1px 5px">Del</button></div></div>`;
  });
  panel.innerHTML=html;document.body.appendChild(panel);
}
function restoreSpecVersion(i){
  const s=getActiveSpec();if(!s||!s.versions||!s.versions[i])return;
  if(!confirm('Restore this version? Current content will be overwritten.'))return;
  const v=s.versions[i];s.title=v.title;s.sections=JSON.parse(JSON.stringify(v.sections));s.updated=new Date().toISOString();
  save();renderSpecDetail(s);const p=document.getElementById('spec-versions-panel');if(p)p.remove();toast('Restored version from '+timeAgo(v.date));
}
function deleteSpecVersion(i){
  const s=getActiveSpec();if(!s||!s.versions)return;
  s.versions.splice(i,1);save();const p=document.getElementById('spec-versions-panel');if(p)p.remove();showSpecVersions();toast('Version deleted');
}
function exportCurrentSpec(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+esc(s.title||'Spec')+' - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:18px;color:#fff;margin-top:20px;padding:6px 0;border-bottom:1px solid #222}.meta{font-size:11px;color:#888;margin-bottom:16px}.section{margin:12px 0;padding:12px;background:#101014;border-radius:8px;border-left:3px solid #22d3ee}a{color:#4ade80}</style></head><body>';
  h+='<h1>'+esc(s.title||'Untitled Spec')+'</h1><div class="meta">'+(proj?esc(proj.name)+' | ':'')+wc+' words | '+(s.sections||[]).length+' sections | Exported '+new Date().toLocaleDateString()+'</div>';
  (s.sections||[]).forEach(sec=>{h+='<div class="section"><h2>'+esc(sec.title||'Section')+'</h2><div>'+(sec.body||'<em>empty</em>')+'</div></div>';});
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=((s.title||'spec').toLowerCase().replace(/\s+/g,'-'))+'.html';a.click();toast('Exported: '+s.title);
}
function exportCurrentSpecText(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  let txt=(s.title||'Untitled Spec').toUpperCase()+'\n\n';
  (s.sections||[]).forEach(sec=>{txt+=(sec.title||'Section').toUpperCase()+'\n';const d=document.createElement('div');d.innerHTML=sec.body||'';txt+=(d.innerText||'(empty)')+'\n\n';});
  navigator.clipboard.writeText(txt).then(()=>toast('Copied as text: '+s.title));
}
function exportCurrentSpecMD(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;
  let md='# '+(s.title||'Untitled Spec')+'\n\n';
  if(proj)md+='Project: '+proj.name+'\n';
  md+='Sections: '+(s.sections||[]).length+' | Exported: '+new Date().toLocaleDateString()+'\n\n---\n\n';
  (s.sections||[]).forEach(sec=>{md+='## '+(sec.title||'Section')+'\n\n';const d=document.createElement('div');d.innerHTML=sec.body||'';md+=(d.innerText||'(empty)')+'\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Copied as Markdown: '+s.title));
}
function specImportMarkdown(){
  const md=prompt('Paste Markdown text to create a new spec.\nUse ## headings to define sections:');
  if(!md||!md.trim())return;
  const lines=md.split('\n');let title='Imported Spec';const sections=[];let curTitle='';let curBody=[];
  lines.forEach(line=>{
    const h1=line.match(/^#\s+(.+)/);const h2=line.match(/^##\s+(.+)/);
    if(h1&&!sections.length&&curBody.length===0){title=h1[1].trim();return;}
    if(h2){if(curTitle||curBody.length){sections.push({id:Date.now()+Math.random(),title:curTitle||'Section',body:'<p>'+curBody.join('</p><p>')+'</p>',icon:'doc',color:'#4ade80'});}curTitle=h2[1].trim();curBody=[];return;}
    if(line.trim())curBody.push(esc(line));
  });
  if(curTitle||curBody.length){sections.push({id:Date.now()+Math.random(),title:curTitle||'Section',body:'<p>'+curBody.join('</p><p>')+'</p>',icon:'doc',color:'#4ade80'});}
  if(!sections.length){toast('No sections found (use ## headings)');return;}
  const projId=activeProject||(S.projects[0]&&S.projects[0].id)||null;
  const spec={id:'spec_'+Date.now(),title:title,projectId:projId,sections:sections,versions:[],created:new Date().toISOString(),updated:new Date().toISOString()};
  S.specs.push(spec);save();switchSpec(spec.id);toast('Imported: '+title+' ('+sections.length+' sections)');
}

// === LINKS ===
function renderLinks(){
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  document.getElementById('link-category-tabs').innerHTML=`<button class="tab-btn ${linkCategory==='all'?'active':''}" onclick="setLinkCat('all',this)">All <span style="font-size:8px;opacity:0.6">${S.links.length}</span></button>`+cats.map(c=>{const cnt=S.links.filter(l=>l.category===c).length;return `<button class="tab-btn ${linkCategory===c?'active':''}" onclick="setLinkCat('${escA(c)}',this)">${esc(c)} <span style="font-size:8px;opacity:0.6">${cnt}</span></button>`;}).join('');
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc+' '+(l.tags||[]).join(' ')).toLowerCase().includes(q));
  const ls=(document.getElementById('link-sort')?.value)||'newest';
  if(ls==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));
  else if(ls==='oldest')items.sort((a,b)=>new Date(a.created||0)-new Date(b.created||0));
  else if(ls==='alpha')items.sort((a,b)=>(a.title||'').localeCompare(b.title||''));
  else if(ls==='category')items.sort((a,b)=>(a.category||'zzz').localeCompare(b.category||'zzz'));
  else if(ls==='domain')items.sort((a,b)=>{try{return new URL(a.url).hostname.localeCompare(new URL(b.url).hostname);}catch(e){return 0;}});
  else if(ls==='tag')items.sort((a,b)=>((a.tags&&a.tags[0])||'zzz').localeCompare((b.tags&&b.tags[0])||'zzz'));
  items.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));
  const g=document.getElementById('links-grid');
  const renderLinkCard=l=>{let domain='';try{domain=new URL(l.url).hostname;}catch(e){}return`<div class="link-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain',JSON.stringify({type:'links',id:${l.id}}))" onclick="window.open('${escA(l.url)}','_blank')" ${l.pinned?'style="border-color:rgba(74,222,128,0.2)"':''}>${l.pinned?'<div style="font-size:7px;color:var(--accent);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:2px">Pinned</div>':''}<div style="display:flex;align-items:center;gap:8px">${domain?`<img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" width="16" height="16" style="border-radius:2px;flex-shrink:0" onerror="this.style.display='none'">`:''}<div class="link-card-title" style="margin:0">${esc(l.title)}</div>${l._status?`<span style="width:6px;height:6px;border-radius:50%;background:${l._status==='ok'?'var(--accent)':'var(--red)'};flex-shrink:0" title="${l._status==='ok'?'Link OK':'Link may be broken'}"></span>`:''}</div><div class="link-card-url">${esc(l.url)}</div>${l.desc?`<div class="link-card-desc">${parseWikiLinks(esc(l.desc))}</div>`:''}<div class="link-card-footer">${l.category?`<span class="badge badge-blue" style="cursor:pointer" onclick="event.stopPropagation();setLinkCat('${escA(l.category)}',null)">${esc(l.category)}</span>`:''}${l.projectId?(()=>{const p=(S.projects||[]).find(x=>x.id===l.projectId);return p?`<span class="badge badge-muted" style="font-size:7px">${esc(p.name)}</span>`:''})():''}${(l.tags&&l.tags.length)?l.tags.map(tag=>`<span style="font-size:7px;padding:0 3px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:2px;color:var(--text-muted);font-family:var(--mono)">${esc(tag)}</span>`).join(''):''}${l.created?`<span style="font-size:8px;color:var(--text-muted)" title="${new Date(l.created).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}">${timeAgo(l.created)}</span>`:''}<div class="link-card-actions"><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();pinLink(${l.id})" style="${l.pinned?'color:var(--accent)':''}">${l.pinned?'Unpin':'Pin'}</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('${escA(l.url)}')">Copy</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('[${escA(l.title)}](${escA(l.url)})');toast('Markdown link copied')">MD</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();toggleLinkReadLater(${l.id})" style="${l.readLater?'color:var(--accent-cyan)':''}">${l.readLater?'Unlist':'RL'}</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();openLinkModal(${l.id})">Edit</button><button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();delLink(${l.id})">Del</button></div></div></div>`;};
  // Make link category clickable in renderLinkCard — already handled via setLinkCat
  const linkDateGrp=d=>{if(!d)return'Unknown';const diff=Math.floor((new Date()-new Date(d))/86400000);if(diff<1)return'Today';if(diff<7)return'This Week';if(diff<30)return'This Month';return'Older';};
  let linksHtml='';if(ls==='domain'||ls==='category'||ls==='newest'||ls==='oldest'||ls==='alpha'||ls==='tag'){let lastGrp=null;items.forEach(l=>{let grp;if(ls==='domain'){try{grp=new URL(l.url).hostname;}catch(e){grp='unknown';}}else if(ls==='category'){grp=l.category||'Uncategorized';}else if(ls==='tag'){grp=(l.tags&&l.tags[0])||'Untagged';}else if(ls==='alpha'){grp=(l.title||'Untitled')[0].toUpperCase();}else{grp=linkDateGrp(l.created);}if(grp!==lastGrp){const cnt=items.filter(x=>{if(ls==='domain'){try{return new URL(x.url).hostname===grp;}catch(e){return false;}}if(ls==='category')return(x.category||'Uncategorized')===grp;if(ls==='tag')return((x.tags&&x.tags[0])||'Untagged')===grp;if(ls==='alpha')return(x.title||'Untitled')[0].toUpperCase()===grp;return linkDateGrp(x.created)===grp;}).length;const clr=ls==='tag'?'#f59e0b':(ls==='newest'||ls==='oldest')?'var(--yellow)':ls==='alpha'?'var(--accent)':'var(--accent-cyan)';linksHtml+=`<div style="grid-column:1/-1;padding:8px 4px 4px;font-size:11px;font-weight:600;color:${clr};border-bottom:1px solid var(--border);margin-bottom:2px;letter-spacing:0.03em">${esc(grp)} <span style="font-size:9px;color:var(--text-muted);font-weight:400">${cnt}</span></div>`;lastGrp=grp;}linksHtml+=renderLinkCard(l);});}else{linksHtml=items.map(renderLinkCard).join('');}
  g.innerHTML=!items.length?`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">L</div><div style="font-size:12px">${q?'No matching links':'No links saved'}</div><div style="font-size:10px;margin-top:4px">${q?'Try a different search':'Click + Add to save bookmarks and resources'}</div></div>`:linksHtml;
  document.getElementById('links-count').textContent=S.links.length;
}
function setLinkCat(c,el){linkCategory=c;document.querySelectorAll('#link-category-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderLinks();}
function openLinkModal(id){editingLinkId=id||null;document.getElementById('link-modal-title').textContent=id?'Edit Link':'Add Link';const projSel=document.getElementById('lm-project');projSel.innerHTML='<option value="">None</option>'+(S.projects||[]).map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');if(!id){navigator.clipboard.readText().then(clip=>{if(clip&&(clip.startsWith('http://')||clip.startsWith('https://'))&&!document.getElementById('lm-url').value){document.getElementById('lm-url').value=clip;suggestLinkTitle();toast('URL pasted from clipboard');}}).catch(()=>{});}
  // Category datalist
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  let cdl=document.getElementById('link-cat-dl');if(!cdl){cdl=document.createElement('datalist');cdl.id='link-cat-dl';document.body.appendChild(cdl);}
  cdl.innerHTML=cats.map(c=>`<option value="${esc(c)}">`).join('');
  document.getElementById('lm-category').setAttribute('list','link-cat-dl');if(id){const l=S.links.find(x=>x.id===id);if(l){document.getElementById('lm-title').value=l.title;document.getElementById('lm-url').value=l.url;document.getElementById('lm-category').value=l.category||'';document.getElementById('lm-desc').value=l.desc||'';document.getElementById('lm-tags').value=(l.tags||[]).join(', ');projSel.value=l.projectId||'';}}else{document.getElementById('lm-title').value='';document.getElementById('lm-url').value='';document.getElementById('lm-category').value='';document.getElementById('lm-desc').value='';document.getElementById('lm-tags').value='';projSel.value=activeProject||'';}document.getElementById('link-modal').classList.add('open');setTimeout(()=>document.getElementById('lm-title').focus(),100);}
function closeLinkModal(){document.getElementById('link-modal').classList.remove('open');editingLinkId=null;}
function saveLink(){const title=document.getElementById('lm-title').value.trim(),url=document.getElementById('lm-url').value.trim(),cat=document.getElementById('lm-category').value.trim().toLowerCase(),desc=document.getElementById('lm-desc').value.trim(),projId=document.getElementById('lm-project').value,tags=(document.getElementById('lm-tags')?.value||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);if(!title||!url){toast('Title and URL required');return;}try{new URL(url);}catch(e){toast('Invalid URL format');return;}if(!editingLinkId){const dup=S.links.find(l=>l.url===url);if(dup&&!confirm('URL already exists as "'+dup.title+'". Add anyway?'))return;}if(editingLinkId){const l=S.links.find(x=>x.id===editingLinkId);if(l){l.title=title;l.url=url;l.category=cat;l.desc=desc;l.tags=tags;l.projectId=projId||undefined;}}else{const link={id:Date.now(),title,url,category:cat,desc,tags,created:new Date().toISOString()};if(projId)link.projectId=projId;else if(activeProject)link.projectId=activeProject;S.links.push(link);}save();closeLinkModal();renderLinks();if(activeProject)renderProjLinks();toast(editingLinkId?'Updated':'Added');}
function suggestLinkTitle(){
  const urlEl=document.getElementById('lm-url'),titleEl=document.getElementById('lm-title');
  if(!urlEl||!titleEl||titleEl.value.trim())return;
  const url=urlEl.value.trim();if(!url)return;
  try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'');const path=u.pathname.replace(/^\//,'').replace(/\/$/, '').split('/').filter(Boolean);
  let title=host;
  if(path.length)title=path[path.length-1].replace(/[-_]/g,' ').replace(/\.\w+$/,'');
  titleEl.value=title.charAt(0).toUpperCase()+title.slice(1);
  }catch(e){}
}
function suggestLinkCategory(){
  const urlEl=document.getElementById('lm-url'),catEl=document.getElementById('lm-category');
  if(!urlEl||!catEl||catEl.value.trim())return;
  const url=urlEl.value.trim();if(!url)return;
  try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();
  const map={'github.com':'development','gitlab.com':'development','stackoverflow.com':'development','npmjs.com':'development','codepen.io':'development','dev.to':'development','medium.com':'articles','substack.com':'articles','blog':'articles','notion.so':'tools','figma.com':'design','dribbble.com':'design','behance.net':'design','youtube.com':'video','vimeo.com':'video','twitch.tv':'video','twitter.com':'social','x.com':'social','linkedin.com':'social','instagram.com':'social','facebook.com':'social','reddit.com':'social','docs.google.com':'docs','drive.google.com':'docs','dropbox.com':'docs','vercel.com':'hosting','netlify.com':'hosting','heroku.com':'hosting','aws.amazon.com':'cloud','cloud.google.com':'cloud','azure.microsoft.com':'cloud','openai.com':'ai','anthropic.com':'ai','huggingface.co':'ai'};
  let cat='';for(const[domain,c]of Object.entries(map)){if(host.includes(domain)){cat=c;break;}}
  if(!cat){const ext=host.split('.').pop();if(ext==='io'||ext==='dev')cat='development';else if(ext==='ai')cat='ai';}
  if(cat)catEl.value=cat;
  }catch(e){}
}
async function fetchLinkTitle(){
  const urlEl=document.getElementById('lm-url'),titleEl=document.getElementById('lm-title');
  const url=urlEl?.value.trim();if(!url)return;
  try{new URL(url);}catch(e){toast('Invalid URL');return;}
  titleEl.value='Fetching...';
  try{
    const resp=await fetch('https://api.allorigins.win/get?url='+encodeURIComponent(url),{signal:AbortSignal.timeout(5000)});
    const data=await resp.json();
    const match=(data.contents||'').match(/<title[^>]*>([^<]+)<\/title>/i);
    if(match&&match[1]){titleEl.value=match[1].trim().substring(0,120);toast('Title fetched');}
    else{suggestLinkTitle();toast('No title found, using URL-based name');}
  }catch(e){suggestLinkTitle();toast('Fetch failed, using URL-based name');}
}
function batchImportLinks(){
  const text=prompt('Paste URLs (one per line):');if(!text)return;
  const urls=text.split('\n').map(u=>u.trim()).filter(u=>{try{new URL(u);return true;}catch(e){return false;}});
  if(!urls.length){toast('No valid URLs found');return;}
  urls.forEach(url=>{try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'');const path=u.pathname.replace(/^\//,'').replace(/\/$/,'').split('/').filter(Boolean);let title=host;if(path.length)title=path[path.length-1].replace(/[-_]/g,' ').replace(/\.\w+$/,'');title=title.charAt(0).toUpperCase()+title.slice(1);S.links.push({id:Date.now()+Math.random()*1000,title,url,category:'imported',desc:'',created:new Date().toISOString()});}catch(e){}});
  save();renderLinks();toast('Imported '+urls.length+' links');
}
let lastDeletedLink=null;
function delLink(id){const l=S.links.find(x=>x.id===id);if(l)lastDeletedLink={...l};S.links=S.links.filter(l=>l.id!==id);save();renderLinks();toast('Deleted — Cmd+Z to undo');}
function undoDeleteLink(){if(!lastDeletedLink)return;S.links.unshift(lastDeletedLink);lastDeletedLink=null;save();renderLinks();toast('Link restored');}
function pinLink(id){const l=S.links.find(x=>x.id===id);if(l){l.pinned=!l.pinned;save();renderLinks();toast(l.pinned?'Pinned':'Unpinned');}}
function toggleLinkReadLater(id){const l=S.links.find(x=>x.id===id);if(l){l.readLater=!l.readLater;save();renderLinks();toast(l.readLater?'Added to reading list':'Removed from reading list');}}
function openFilteredLinks(){
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc+' '+(l.tags||[]).join(' ')).toLowerCase().includes(q));
  const urls=items.filter(l=>l.url).slice(0,10);
  if(!urls.length){toast('No links to open');return;}
  if(urls.length>5&&!confirm('Open '+urls.length+' links in new tabs?'))return;
  urls.forEach(l=>window.open(l.url,'_blank'));toast('Opened '+urls.length+' links');
}
function cpText(t){navigator.clipboard.writeText(t);toast('Copied');}
function exportLinks(){
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  let md='# Links Export\n'+S.links.length+' links | '+new Date().toLocaleDateString()+'\n\n';
  cats.forEach(c=>{md+='## '+c+'\n';S.links.filter(l=>l.category===c).forEach(l=>{md+='- ['+l.title+']('+l.url+')'+(l.desc?' — '+l.desc:'')+'\n';});md+='\n';});
  const uncategorized=S.links.filter(l=>!l.category);
  if(uncategorized.length){md+='## Other\n';uncategorized.forEach(l=>{md+='- ['+l.title+']('+l.url+')'+(l.desc?' — '+l.desc:'')+'\n';});md+='\n';}
  navigator.clipboard.writeText(md).then(()=>toast('Links exported to clipboard'));
}
function copyAllLinkURLs(){
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc+' '+(l.tags||[]).join(' ')).toLowerCase().includes(q));
  if(!items.length){toast('No links to copy');return;}
  const urls=items.map(l=>l.url).join('\n');
  navigator.clipboard.writeText(urls).then(()=>toast('Copied '+items.length+' URLs'));
}

function manageLinkTags(){
  const allTags=[...new Set(S.links.flatMap(l=>l.tags||[]).filter(Boolean))].sort();
  if(!allTags.length){toast('No tags found on links');return;}
  const tagCounts={};allTags.forEach(t=>{tagCounts[t]=S.links.filter(l=>(l.tags||[]).includes(t)).length;});
  const action=prompt('Link Tags ('+allTags.length+'):\n\n'+allTags.map(t=>t+' ('+tagCounts[t]+')').join('\n')+'\n\nActions:\n- rename:old:new\n- delete:tagname\n- merge:tag1:tag2 (merges tag1 INTO tag2)\n\nOr click Cancel to close:');
  if(!action)return;
  if(action.startsWith('rename:')){const parts=action.split(':');if(parts.length===3){const old=parts[1].trim(),nw=parts[2].trim();let count=0;S.links.forEach(l=>{if(l.tags){const i=l.tags.indexOf(old);if(i>=0){l.tags[i]=nw;count++;}}});save();renderLinks();toast('Renamed "'+old+'" to "'+nw+'" in '+count+' links');}}
  else if(action.startsWith('delete:')){const tag=action.substring(7).trim();let count=0;S.links.forEach(l=>{if(l.tags){const i=l.tags.indexOf(tag);if(i>=0){l.tags.splice(i,1);count++;}}});save();renderLinks();toast('Removed "'+tag+'" from '+count+' links');}
  else if(action.startsWith('merge:')){const parts=action.split(':');if(parts.length===3){const from=parts[1].trim(),to=parts[2].trim();let count=0;S.links.forEach(l=>{if(l.tags){const i=l.tags.indexOf(from);if(i>=0){l.tags[i]=to;l.tags=[...new Set(l.tags)];count++;}}});save();renderLinks();toast('Merged "'+from+'" into "'+to+'" ('+count+' links)');}}
}
async function checkAllLinks(){
  const btn=document.getElementById('link-check-btn');if(btn)btn.textContent='Checking...';
  let ok=0,fail=0,skip=0;
  for(const l of S.links){
    try{
      const r=await fetch(l.url,{method:'HEAD',mode:'no-cors',signal:AbortSignal.timeout(5000)});
      l._status='ok';ok++;
    }catch(e){
      if(l.url.startsWith('http')){l._status='error';fail++;}else{l._status='skip';skip++;}
    }
  }
  if(btn)btn.textContent='Check';
  renderLinks();toast(ok+' OK, '+fail+' broken'+(skip?', '+skip+' skipped':''));
}

// === PROJECTS ===
let activeProject = null;
let activeProjTab = 'instructions';
let editingProjectId = null;
let editingKBId = null;
let kbModalTab = 'text';
let kbImageData = null;

const ICON_SVGS = {
  rocket:'<path d="M4.5 16.5c-1.5 1.37-3 4.5-3 4.5s3.13-1.5 4.5-3c.78-.78.78-2.04 0-2.83s-2.04-.78-2.83 0z"/><path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/>',
  code:'<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>',
  book:'<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
  music:'<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>',
  globe:'<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
  atom:'<circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5z"/>',
  target:'<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
  heart:'<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
  star:'<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
  flag:'<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>',
  lightning:'<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
  fire:'<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.07-2.14 0-5.5 3.5-7.5-2.5 5 1.5 5 3 7.5 2 3.5 1 6-2 8-1.5 1-4.5 1-6-1"/>',
  terminal:'<polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>',
  database:'<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>',
  server:'<rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>',
  cpu:'<rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/>',
  cloud:'<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>',
  pen:'<path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/>',
  palette:'<circle cx="13.5" cy="6.5" r="1.5"/><circle cx="17.5" cy="10.5" r="1.5"/><circle cx="8.5" cy="7.5" r="1.5"/><circle cx="6.5" cy="12" r="1.5"/><path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10c.97 0 1.76-.79 1.76-1.76 0-.47-.18-.89-.48-1.21-.3-.31-.48-.74-.48-1.21 0-.97.79-1.76 1.76-1.76H16c3.31 0 6-2.69 6-6 0-5.17-4.49-8.06-10-8.06z"/>',
  camera:'<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>',
  video:'<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>',
  mic:'<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>',
  headphones:'<path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>',
  layers:'<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
  brain:'<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44A2.5 2.5 0 0 1 5.5 17c-1.56 0-3-1.28-3-3 0-1.16.6-2.13 1.46-2.7A2.5 2.5 0 0 1 5.5 7a2.5 2.5 0 0 1 4-2z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44A2.5 2.5 0 0 0 18.5 17c1.56 0 3-1.28 3-3 0-1.16-.6-2.13-1.46-2.7A2.5 2.5 0 0 0 18.5 7a2.5 2.5 0 0 0-4-2z"/>',
  flask:'<path d="M9 3h6"/><path d="M10 3v7.4a2 2 0 0 1-.5 1.3L4 18.6A2 2 0 0 0 5.5 22h13a2 2 0 0 0 1.5-3.4L14.5 11.7a2 2 0 0 1-.5-1.3V3"/>',
  telescope:'<path d="M10.065 12.493l-6.18 1.318a.934.934 0 0 1-1.108-.702l-.537-2.15a1.07 1.07 0 0 1 .691-1.265l13.504-4.44"/><path d="M13.56 11.747l4.332-.924"/><path d="M16 21l-3.105-6.21"/><path d="M16.485 5.94a2 2 0 0 1 1.455-2.425l1.09-.272a1 1 0 0 1 1.212.727l1.515 6.06a1 1 0 0 1-.727 1.213l-1.09.272a2 2 0 0 1-2.425-1.455z"/><path d="M6.158 8.633l1.114 4.456"/>',
  map:'<polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/>',
  compass:'<circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>',
  tools:'<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',
  wrench:'<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',
  key:'<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>',
  lock:'<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
  shield:'<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
  crown:'<path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7z"/><path d="M5 16h14"/>',
  diamond:'<rect x="12" y="1" width="15.56" height="15.56" rx="2.41" transform="rotate(45 12 12)" style="stroke-width:1.5"/>',
  sun:'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',
  moon:'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>',
  mountain:'<path d="M8 3l4 8 5-5 5 15H2z"/>',
  leaf:'<path d="M11 20A7 7 0 0 1 9.8 6.9C15.5 4.9 17 3.5 19 2c1 2 2 4.5 2 8 0 5.5-4.78 10-10 10z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>',
  mail:'<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>',
  phone:'<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>',
  bell:'<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>',
  megaphone:'<path d="M3 11l18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/>',
  chart:'<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
  trending:'<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
  dollar:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
  briefcase:'<rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>',
  building:'<rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><line x1="8" y1="6" x2="8" y2="6.01"/><line x1="16" y1="6" x2="16" y2="6.01"/><line x1="12" y1="6" x2="12" y2="6.01"/><line x1="8" y1="10" x2="8" y2="10.01"/><line x1="16" y1="10" x2="16" y2="10.01"/><line x1="12" y1="10" x2="12" y2="10.01"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="16" y1="14" x2="16" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/>',
  user:'<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
  users:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
  eye:'<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>',
  calendar:'<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>',
  clock:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
  folder:'<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>',
  file:'<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>',
  grid:'<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>',
  list:'<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>',
  archive:'<polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/>',
  activity:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',
  zap:'<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
  anchor:'<circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/>',
  feather:'<path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/>',
  gift:'<polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>',
  message:'<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
  git:'<circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><line x1="6" y1="9" x2="6" y2="21"/>',
  wifi:'<path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>',
  crosshair:'<circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/>',
  hammer:'<path d="M15 12l-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15L22 10.64"/><path d="M20.91 11.7l-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V6.5L14.5 2.25 12 4.75l1.5 1.5L9 12"/>',
  tree:'<path d="M12 22v-7"/><path d="M5 12H2l10-10 10 10h-3"/><path d="M8 18H2l10-8 10 8h-6"/>',
};
const ICON_KEYS = Object.keys(ICON_SVGS);

function getIconSVG(key, size) {
  const s = size || 16;
  const d = ICON_SVGS[key] || ICON_SVGS.folder;
  return `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${d}</svg>`;
}

// Project CRUD
function getProjects() { return S.projects || []; }
function getProject(id) { return (S.projects||[]).find(p=>p.id===id); }
function getKBItems(projectId) { return (S.knowledgeBase||[]).filter(k=>k.projectId===projectId); }

function renderProjectsSidebar() {
  const el = document.getElementById('sidebar-projects');
  const projects = getProjects();
  el.innerHTML = projects.map(p => {
    const statusClass = p.status === 'active' ? 'active-s' : p.status === 'paused' ? 'paused-s' : 'complete-s';
    const isActive = activeProject === p.id;
    const projTasks = getProjectTasks(p.id);
    const doneTasks = projTasks.filter(t => t.status === 'done').length;
    const totalTasks = projTasks.length;
    const pct = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
    return `<div class="sidebar-project-item ${isActive?'active':''}" onclick="openProject('${p.id}')" style="${isActive?'border-left:3px solid '+p.color:'border-left:3px solid transparent'}">
      <span class="proj-icon" style="color:${p.color}">${getIconSVG(p.icon,14)}</span>
      <span class="proj-name">${esc(p.name)}</span>
      ${totalTasks>0?`<span style="font-family:var(--mono);font-size:8px;color:var(--text-muted);margin-left:auto">${pct}%</span>`:''}
      <span class="proj-status ${statusClass}"></span>
    </div>${totalTasks>0?`<div style="height:2px;background:var(--border);margin:0 12px 2px;border-radius:1px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${p.color};border-radius:1px;transition:width 0.3s"></div></div>`:''}`;

  }).join('') + `<div class="sidebar-add-project" onclick="openNewProjectModal()">+ New Project</div>`;
}

function openProject(id) {
  activeProject = id;
  activeProjTab = 'instructions';
  const p = (S.projects||[]).find(x=>x.id===id);
  if(p) trackRecent('project', id, p.name);
  const app = document.querySelector('.app');
  // Close context panel — they share the right-side grid slot
  app.classList.remove('context-open');
  app.classList.add('project-open');
  renderProjectsSidebar();
  renderProjectView();
}

function closeProjectPanel() {
  activeProject = null;
  const app = document.querySelector('.app');
  app.classList.remove('project-open');
  document.documentElement.style.setProperty('--project-width', '420px');
  renderProjectsSidebar();
}

function renderProjectView() {
  const p = getProject(activeProject);
  if (!p) return;
  document.getElementById('proj-header-icon').innerHTML = getIconSVG(p.icon, 18);
  document.getElementById('proj-header-icon').style.borderColor = p.color;
  document.getElementById('proj-header-name').textContent = p.name;
  const statusEl = document.getElementById('proj-header-status');
  statusEl.textContent = p.status;
  statusEl.className = 'badge badge-' + (p.status==='active'?'green':p.status==='paused'?'yellow':'blue');
  // Project stats
  const pTasks=S.tasks.filter(t=>t.project===p.name);
  const pTasksDone=pTasks.filter(t=>t.status==='done').length;
  const pDocs=S.specs.filter(s=>s.projectId===p.id);
  const pLinks=S.links.filter(l=>l.projectId===p.id);
  const pKB=(S.kb||[]).filter(k=>k.projectId===p.id);
  const pContent=S.content.filter(c=>(c.tags||[]).includes(p.name.toLowerCase()));
  const statsBar=document.getElementById('proj-stats-bar');
  const pPct=pTasks.length?Math.round(pTasksDone/pTasks.length*100):0;
  statsBar.innerHTML=`<span style="font-size:9px;color:var(--text-muted)" title="${pTasks.length} tasks (${pTasksDone} done)">T:${pTasksDone}/${pTasks.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pDocs.length} living docs">D:${pDocs.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pKB.length} KB items">KB:${pKB.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pLinks.length} links">L:${pLinks.length}</span><span style="display:flex;align-items:center;gap:4px" title="${pPct}% complete"><span style="width:60px;height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden;display:inline-block"><span style="display:block;height:100%;width:${pPct}%;background:${pPct>=100?'var(--accent)':pPct>=50?'#22d3ee':'var(--orange)'};border-radius:2px;transition:width 0.3s"></span></span><span style="font-size:8px;color:${pPct>=100?'var(--accent)':'var(--text-muted)'}">${pPct}%</span></span>`;
  // Apply project color to tabs
  document.documentElement.style.setProperty('--proj-accent', p.color);
  setProjTab(activeProjTab);
}

function setProjTab(tab, el) {
  activeProjTab = tab;
  document.querySelectorAll('.project-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  else document.querySelectorAll('.project-tab').forEach(t => { if(t.textContent.toLowerCase().replace(/\s/g,'-').includes(tab.replace('proj-',''))|| (tab==='instructions'&&t.textContent==='Instructions') || (tab==='docs'&&t.textContent==='Living Docs') || (tab==='kb'&&t.textContent==='Knowledge Base') || (tab==='proj-tasks'&&t.textContent==='Tasks') || (tab==='proj-links'&&t.textContent==='Links')) t.classList.add('active'); });
  document.querySelectorAll('.proj-tab-panel').forEach(p=>p.style.display='none');
  const panel = document.getElementById('proj-panel-'+tab);
  if(panel) panel.style.display = 'block';
  if(tab==='instructions') loadProjInstructions();
  if(tab==='docs') renderProjDocs();
  if(tab==='kb') renderKB();
  if(tab==='proj-tasks') renderProjTasks();
  if(tab==='proj-links') renderProjLinks();
}

// Instructions
function loadProjInstructions() {
  const p = getProject(activeProject);
  if(!p) return;
  document.getElementById('proj-instructions-editor').innerHTML = p.instructions || '';
}
let projInstrTimer = null;
function onProjInstructionsChange() {
  clearTimeout(projInstrTimer);
  projInstrTimer = setTimeout(() => {
    const p = getProject(activeProject);
    if(p) { p.instructions = document.getElementById('proj-instructions-editor').innerHTML; p.updated = new Date().toISOString(); save(); }
  }, 1000);
}

// Project Living Docs
function renderProjDocs() {
  const p = getProject(activeProject);
  if(!p) return;
  const docs = S.specs.filter(s => s.projectId === activeProject || s.global);
  const unassigned = S.specs.filter(s => !s.projectId && !s.global);
  const grid = document.getElementById('proj-docs-grid');
  let html = '';
  if(!docs.length && !unassigned.length) {
    html = '<div class="kb-empty">No living docs for this project. Click + to add one.</div>';
  } else {
    html = docs.map(d => {
      const sc = d.sections ? d.sections.length : 0;
      const dt = d.updated ? new Date(d.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
      const previewSec = d.sections && d.sections.find(s=>s.body);
      const previewRaw = previewSec ? previewSec.body.replace(/<[^>]+>/g,'').substring(0,100) : (d.sections && d.sections[0] ? d.sections[0].title : '');
      const preview = previewRaw;
      const ic = d.icon||'file'; const c = d.color||'#8b8b8b'; const path = specSectionIcon(ic);
      return `<div class="proj-doc-card" onclick="goToLivingDoc('${d.id}')">
        <div style="display:flex;align-items:center;gap:6px"><span style="color:${c};display:flex"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><div class="proj-doc-card-title">${esc(d.title||'Untitled')}</div></div>
        <div class="proj-doc-card-meta"><span>${sc} sections</span><span>${dt}</span></div>
        <div class="proj-doc-card-preview">${esc(preview)}</div>
      </div>`;
    }).join('');
    if(unassigned.length) {
      html += `<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">${unassigned.length} unassigned doc${unassigned.length>1?'s':''}</div>
        ${unassigned.map(d => `<div class="proj-doc-card" style="opacity:0.6;cursor:pointer" onclick="assignDocToProject('${d.id}')">
          <div class="proj-doc-card-title">${esc(d.title||'Untitled')}</div>
          <div style="font-size:9px;color:var(--accent);margin-top:4px">Click to assign to this project</div>
        </div>`).join('')}
      </div>`;
    }
  }
  grid.innerHTML = html;
}
function assignDocToProject(docId) {
  const doc = S.specs.find(s => String(s.id) === String(docId));
  if(!doc || !activeProject) return;
  doc.projectId = activeProject;
  doc.updated = new Date().toISOString();
  save();
  renderProjDocs();
  toast('Doc assigned to project');
}
function newProjLivingDoc() {
  snapshotSpec();
  const s = {id:Date.now(), title:'', projectId:activeProject, sections:[{id:Date.now()+1,title:'Overview',body:'',collapsed:false}], created:new Date().toISOString(), updated:new Date().toISOString()};
  S.specs.unshift(s);
  S.activeSpec = s.id;
  save();
  switchSection('specs', document.querySelector('.sidebar-item:nth-child(5)'));
  toast('Living Doc created — editing now');
}
function goToLivingDoc(id) {
  S.activeSpec = id;
  save();
  switchSection('specs', null);
  document.querySelectorAll('.sidebar-item').forEach(i => { if(i.textContent.includes('Living Docs')) { i.classList.add('active'); } else { i.classList.remove('active'); }});
}

// Knowledge Base
function renderKB() {
  const items = getKBItems(activeProject);
  const q = (document.getElementById('kb-search')?.value||'').toLowerCase();
  let filtered = items;
  if(q) filtered = filtered.filter(k => (k.name+' '+k.description+' '+(k.tags||[]).join(' ')).toLowerCase().includes(q));
  const grid = document.getElementById('kb-grid');
  grid.innerHTML = !filtered.length ? '<div class="kb-empty">No knowledge base items yet. Click + Add Item to start building.</div>' :
    filtered.map(k => {
      const typeClass = 'kb-type-'+(k.type||'other');
      const hasImg = k.type === 'img' && k.content;
      return `<div class="kb-card" onclick="openKBViewer('${k.id}')" draggable="true" ondragstart="kbDragStart(event,'${k.id}')">
        <div class="kb-card-actions">
          <button class="btn btn-sm btn-ghost kb-card-drag" draggable="false" title="Drag to whiteboard">&#x2630;</button>
          <button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();confirmDeleteKB('${k.id}')">x</button>
        </div>
        <div class="kb-card-header">
          <span class="kb-card-type ${typeClass}">${(k.type||'other').toUpperCase()}</span>
          <span class="kb-card-name">${esc(k.name)}</span>
        </div>
        <div class="kb-card-desc">${esc(k.description||'')}</div>
        ${hasImg ? `<img class="kb-card-img" src="${k.content}" alt="${escA(k.name)}">` : ''}
        ${k.tags && k.tags.length ? `<div class="kb-card-tags">${k.tags.map(t=>`<span class="kb-card-tag">${esc(t)}</span>`).join('')}</div>` : ''}
      </div>`;
    }).join('');
}

// KB Modal
function openKBModal(id) {
  editingKBId = id || null;
  kbImageData = null;
  document.getElementById('kb-modal-title').textContent = id ? 'Edit Knowledge Base Item' : 'Add to Knowledge Base';
  if(id) {
    const k = (S.knowledgeBase||[]).find(x=>x.id===id);
    if(k) {
      if(k.type==='md'||k.type==='txt'||k.type==='json') { setKBModalTab('text'); document.getElementById('kbm-text-name').value=k.name; document.getElementById('kbm-text-content').value=k.content||''; }
      else if(k.type==='img') { setKBModalTab('image'); document.getElementById('kbm-img-name').value=k.name; if(k.content){kbImageData=k.content;document.getElementById('kbm-img-preview').style.display='block';document.getElementById('kbm-img-preview-img').src=k.content;} }
      else if(k.type==='url') { setKBModalTab('url'); document.getElementById('kbm-url-name').value=k.name; document.getElementById('kbm-url-url').value=k.url||''; }
      else { setKBModalTab('file'); document.getElementById('kbm-file-name').value=k.name; document.getElementById('kbm-file-path').value=k.filePath||''; document.getElementById('kbm-file-type').value=k.type||'other'; }
      document.getElementById('kbm-desc').value=k.description||'';
      document.getElementById('kbm-tags').value=(k.tags||[]).join(', ');
    }
  } else {
    setKBModalTab('text');
    ['kbm-text-name','kbm-text-content','kbm-file-name','kbm-file-path','kbm-url-name','kbm-url-url','kbm-img-name','kbm-desc','kbm-tags'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    document.getElementById('kbm-img-preview').style.display='none';
  }
  document.getElementById('kb-modal').classList.add('open');
}
function closeKBModal() { document.getElementById('kb-modal').classList.remove('open'); editingKBId=null; kbImageData=null; }
function setKBModalTab(tab, el) {
  kbModalTab = tab;
  document.querySelectorAll('.kb-modal-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  else document.querySelectorAll('.kb-modal-tab').forEach(t => { if((tab==='text'&&t.textContent.includes('Text'))||(tab==='file'&&t.textContent.includes('File'))||(tab==='url'&&t.textContent==='URL')||(tab==='image'&&t.textContent==='Image')) t.classList.add('active'); });
  document.querySelectorAll('.kb-modal-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('kb-panel-'+tab).classList.add('active');
}
function handleKBImageFile(input) {
  const file = input.files[0];
  if(!file) return;
  if(file.size > 500*1024) { toast('Image too large (>500KB). Use file reference instead.'); return; }
  const reader = new FileReader();
  reader.onload = e => { kbImageData = e.target.result; document.getElementById('kbm-img-preview').style.display='block'; document.getElementById('kbm-img-preview-img').src = kbImageData; };
  reader.readAsDataURL(file);
}
function saveKBItem() {
  if(!S.knowledgeBase) S.knowledgeBase = [];
  let item;
  if(kbModalTab==='text') {
    const name = document.getElementById('kbm-text-name').value.trim();
    const content = document.getElementById('kbm-text-content').value.trim();
    if(!name) { toast('Name required'); return; }
    item = { name, type:'md', storage:'inline', content, filePath:null, url:null };
  } else if(kbModalTab==='file') {
    const name = document.getElementById('kbm-file-name').value.trim();
    const path = document.getElementById('kbm-file-path').value.trim();
    const type = document.getElementById('kbm-file-type').value;
    if(!name) { toast('Name required'); return; }
    item = { name, type, storage:'reference', content:null, filePath:path, url:null };
  } else if(kbModalTab==='url') {
    const name = document.getElementById('kbm-url-name').value.trim();
    const url = document.getElementById('kbm-url-url').value.trim();
    if(!name||!url) { toast('Name and URL required'); return; }
    item = { name, type:'url', storage:'inline', content:null, filePath:null, url };
  } else if(kbModalTab==='image') {
    const name = document.getElementById('kbm-img-name').value.trim();
    if(!name||!kbImageData) { toast('Name and image required'); return; }
    item = { name, type:'img', storage:'inline', content:kbImageData, filePath:null, url:null };
  }
  item.description = document.getElementById('kbm-desc').value.trim();
  item.tags = document.getElementById('kbm-tags').value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
  item.projectId = activeProject;
  if(editingKBId) {
    const existing = S.knowledgeBase.find(k=>k.id===editingKBId);
    if(existing) Object.assign(existing, item, {updated:new Date().toISOString()});
  } else {
    item.id = 'kb_'+Date.now();
    item.created = new Date().toISOString();
    item.updated = new Date().toISOString();
    S.knowledgeBase.push(item);
  }
  save(); closeKBModal(); renderKB(); toast(editingKBId?'Updated':'Added');
}

// KB Viewer
let viewingKBId = null;
function openKBViewer(id) {
  viewingKBId = id;
  const k = (S.knowledgeBase||[]).find(x=>x.id===id);
  if(!k) return;
  document.getElementById('kbv-type').textContent = (k.type||'other').toUpperCase();
  document.getElementById('kbv-type').className = 'kb-card-type kb-type-'+(k.type||'other');
  document.getElementById('kbv-name').textContent = k.name;
  document.getElementById('kbv-desc').textContent = k.description||'';
  const contentEl = document.getElementById('kbv-content');
  const imageEl = document.getElementById('kbv-image');
  const pathEl = document.getElementById('kbv-path');
  contentEl.style.display = 'none'; imageEl.style.display = 'none'; pathEl.style.display = 'none';
  if(k.type==='img' && k.content) { imageEl.style.display='block'; document.getElementById('kbv-image-img').src=k.content; }
  else if(k.content) { contentEl.style.display='block'; contentEl.innerHTML=parseWikiLinks(esc(k.content)); }
  else if(k.url) { contentEl.style.display='block'; contentEl.innerHTML=`<a href="${escA(k.url)}" target="_blank" style="color:var(--accent)">${esc(k.url)}</a>`; }
  if(k.filePath) { pathEl.style.display='block'; pathEl.textContent='File: '+k.filePath; }
  document.getElementById('kbv-tags').innerHTML = (k.tags||[]).map(t=>`<span class="kb-card-tag">${esc(t)}</span>`).join('');
  document.getElementById('kb-viewer-modal').classList.add('open');
}
function closeKBViewer() { document.getElementById('kb-viewer-modal').classList.remove('open'); viewingKBId=null; }
function editKBItem() { closeKBViewer(); openKBModal(viewingKBId); }
function deleteKBItem() { if(!viewingKBId) return; S.knowledgeBase = (S.knowledgeBase||[]).filter(k=>k.id!==viewingKBId); save(); closeKBViewer(); renderKB(); toast('Deleted'); }
function confirmDeleteKB(id) { S.knowledgeBase = (S.knowledgeBase||[]).filter(k=>k.id!==id); save(); renderKB(); toast('Deleted'); }

// KB drag to whiteboard
function kbDragStart(e, id) {
  e.dataTransfer.setData('text/plain', 'kb:'+id);
  e.dataTransfer.effectAllowed = 'copy';
}

// Project Tasks — uses projectId (preferred) or falls back to project name match
function getProjectTasks(projId) {
  const p = getProject(projId);
  if(!p) return [];
  return S.tasks.filter(t => t.projectId === projId || (!t.projectId && t.project === p.name));
}
function renderProjTasks() {
  const p = getProject(activeProject);
  if(!p) return;
  const tasks = getProjectTasks(activeProject);
  const el = document.getElementById('proj-task-rows');
  el.innerHTML = tasks.map(t => `<div class="task-row ${t.status==='done'?'completed':''}" style="grid-template-columns:36px 1fr 110px 100px 50px">
    <div class="task-checkbox ${t.status==='done'?'checked':''}" onclick="toggleTask(${t.id});setTimeout(()=>renderProjTasks(),50)"></div>
    <div><input type="text" class="task-title-input" value="${escA(t.title)}" onchange="updateTask(${t.id},'title',this.value)" placeholder="Task name..."></div>
    <div><select class="task-select" onchange="updateTask(${t.id},'status',this.value);setTimeout(()=>renderProjTasks(),50)"><option value="todo" ${t.status==='todo'?'selected':''}>To Do</option><option value="progress" ${t.status==='progress'?'selected':''}>In Progress</option><option value="done" ${t.status==='done'?'selected':''}>Done</option><option value="blocked" ${t.status==='blocked'?'selected':''}>Blocked</option></select></div>
    <div><input type="date" class="task-select" value="${t.due||''}" onchange="updateTask(${t.id},'due',this.value)"></div>
    <div class="task-actions" style="opacity:1"><button class="task-action-btn del" onclick="deleteTask(${t.id});setTimeout(()=>renderProjTasks(),50)">x</button></div>
  </div>`).join('') + `<div class="add-task-row" onclick="addProjTask()">+ Add task</div>`;
}
function addProjTask() {
  const p = getProject(activeProject);
  if(!p) return;
  S.tasks.unshift({id:Date.now(), title:'', status:'todo', priority:'p1', project:p.name, projectId:activeProject, due:new Date().toISOString().split('T')[0], created:new Date().toISOString()});
  save(); renderProjTasks(); renderTasks();
  setTimeout(()=>{const i=document.querySelector('#proj-task-rows .task-title-input');if(i)i.focus();},50);
}

// Project Links
function renderProjLinks() {
  const p = getProject(activeProject);
  if(!p) return;
  const links = S.links.filter(l => l.projectId === activeProject);
  const grid = document.getElementById('proj-links-grid');
  grid.innerHTML = !links.length ? '<div class="kb-empty">No links for this project.</div>' :
    links.map(l => `<div class="link-card" onclick="window.open('${escA(l.url)}','_blank')">
      <div class="link-card-title">${esc(l.title)}</div>
      <div class="link-card-url">${esc(l.url)}</div>
      ${l.desc?`<div class="link-card-desc">${parseWikiLinks(esc(l.desc))}</div>`:''}
      <div class="link-card-footer">${l.category?`<span class="badge badge-blue">${esc(l.category)}</span>`:''}
        <div class="link-card-actions"><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('${escA(l.url)}')">Copy</button><button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();removeProjLink('${l.id}')">Del</button></div>
      </div>
    </div>`).join('');
}
function openProjLinkModal() {
  editingLinkId = null;
  document.getElementById('link-modal-title').textContent = 'Add Link';
  document.getElementById('lm-title').value='';document.getElementById('lm-url').value='';document.getElementById('lm-category').value='';document.getElementById('lm-desc').value='';document.getElementById('lm-tags').value='';
  document.getElementById('link-modal').classList.add('open');
}
function removeProjLink(id) { const l = S.links.find(x=>x.id==id); if(l) { l.projectId=null; save(); renderProjLinks(); toast('Removed from project'); }}

// Project Modal
function openNewProjectModal() { editingProjectId=null; document.getElementById('project-modal-title').textContent='New Project'; document.getElementById('pm-name').value=''; document.getElementById('pm-icon').value='folder'; document.getElementById('pm-status').value='active'; document.getElementById('pm-color').value='#4ade80'; updatePmIconPreview(); updatePmColorSelection(); document.getElementById('project-modal').classList.add('open'); setTimeout(()=>document.getElementById('pm-name').focus(),100); }
function editProject() {
  const p = getProject(activeProject);
  if(!p) return;
  editingProjectId = p.id;
  document.getElementById('project-modal-title').textContent = 'Edit Project';
  document.getElementById('pm-name').value = p.name;
  document.getElementById('pm-icon').value = p.icon;
  document.getElementById('pm-status').value = p.status;
  document.getElementById('pm-color').value = p.color;
  updatePmIconPreview();
  updatePmColorSelection();
  document.getElementById('project-modal').classList.add('open');
}
function closeProjectModal() { document.getElementById('project-modal').classList.remove('open'); editingProjectId=null; }
function saveProject() {
  const name = document.getElementById('pm-name').value.trim();
  if(!name) { toast('Name required'); return; }
  const icon = document.getElementById('pm-icon').value;
  const status = document.getElementById('pm-status').value;
  const color = document.getElementById('pm-color').value;
  if(!S.projects) S.projects = [];
  if(editingProjectId) {
    const p = getProject(editingProjectId);
    if(p) { p.name=name; p.icon=icon; p.status=status; p.color=color; p.updated=new Date().toISOString(); }
  } else {
    const p = { id:'proj_'+Date.now(), name, icon, status, color, instructions:'', created:new Date().toISOString(), updated:new Date().toISOString() };
    S.projects.push(p);
    activeProject = p.id;
  }
  save(); closeProjectModal(); renderProjectsSidebar();
  if(activeProject) { openProject(activeProject); }
  toast(editingProjectId?'Updated':'Created');
}
function archiveProject() {
  const p = getProject(activeProject);
  if(!p) return;
  if(!confirm('Archive "'+p.name+'"? This marks it as complete.')) return;
  p.status = 'complete';
  save(); renderProjectsSidebar(); renderProjectView(); toast('Archived');
}
function updatePmIconPreview() {
  const icon = document.getElementById('pm-icon').value;
  const color = document.getElementById('pm-color').value;
  document.getElementById('pm-icon-preview').innerHTML = getIconSVG(icon, 20);
  document.getElementById('pm-icon-preview').style.color = color;
}
function setPmColor(c) { document.getElementById('pm-color').value=c; updatePmColorSelection(); updatePmIconPreview(); }
function updatePmColorSelection() {
  const c = document.getElementById('pm-color').value;
  document.querySelectorAll('.pm-color-opt').forEach(el => { el.classList.toggle('selected', el.dataset.color===c); });
}

// Icon Picker
function openIconPicker() {
  const grid = document.getElementById('icon-picker-grid');
  const current = document.getElementById('pm-icon').value;
  grid.innerHTML = ICON_KEYS.map(k => `<div class="icon-picker-item ${k===current?'selected':''}" onclick="selectIcon('${k}')" title="${k}">${getIconSVG(k,18)}</div>`).join('');
  document.getElementById('icon-picker-modal').classList.add('open');
}
function closeIconPicker() { document.getElementById('icon-picker-modal').classList.remove('open'); }
function selectIcon(k) {
  document.getElementById('pm-icon').value = k;
  updatePmIconPreview();
  document.querySelectorAll('.icon-picker-item').forEach(el => el.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  closeIconPicker();
}

// Image paste handler
document.addEventListener('paste', e => {
  if(!document.getElementById('kb-modal').classList.contains('open')) return;
  if(kbModalTab !== 'image') return;
  const items = e.clipboardData?.items;
  if(!items) return;
  for(let i=0; i<items.length; i++) {
    if(items[i].type.startsWith('image/')) {
      const file = items[i].getAsFile();
      if(file.size > 500*1024) { toast('Image too large (>500KB)'); return; }
      const reader = new FileReader();
      reader.onload = ev => { kbImageData = ev.target.result; document.getElementById('kbm-img-preview').style.display='block'; document.getElementById('kbm-img-preview-img').src=kbImageData; };
      reader.readAsDataURL(file);
      e.preventDefault();
      return;
    }
  }
});

// Seed projects
function seedProjects() {
  if(S._seeded) return;
  if(S.projects && S.projects.length) { S._seeded = true; return; }
  S.projects = [];
  S.knowledgeBase = [];
  const now = new Date().toISOString();

  // Project 1: SM App Rebuild
  const smApp = {
    id: 'proj_sm_app', name: 'SM App Rebuild', icon: 'code', status: 'active', color: '#8b5cf6',
    instructions: '<h1>SM App Rebuild - Developer Situation</h1><h2>Vision</h2><p>"Ableton of Movement" - a movement composition app that treats movement like music production.</p><h2>For Tomorrow\'s Developer Call</h2><p><b>Primary Objectives:</b></p><ol><li>Clarify codebase ownership</li><li>Understand current deployment pipeline</li><li>Define handoff requirements</li><li>Establish realistic timeline</li></ol><h2>Key Questions</h2><ol><li>Where does the current codebase live?</li><li>What\'s the deployment process?</li><li>What do we need from them to take over?</li><li>What\'s the minimum viable handoff?</li><li>Are there vendor lock-ins or proprietary dependencies?</li></ol><h2>Assets You OWN</h2><ul><li>Domain: saturnomovement.com (admin@saturnomovement.com, Cloudflare, 2FA)</li><li>Stripe: Verified owner, 2FA + authenticator, payouts to your bank</li><li>Vimeo: Company email + card, all videos accessible</li><li>iOS Developer Account: Transferred to admin@saturnomovement.com</li><li>GitHub: sm-app-copy-v1 (your clone of the codebase)</li><li>Cloudflare: Full admin access, 2-step auth</li><li>Backups: Database and code fully backed up and cloned</li></ul><h2>What Softzee Still Controls</h2><ul><li>Server hosting (AWS, his infrastructure)</li><li>Original GitHub repo (Shajeel/sm-website-app)</li><li>Deployment pipeline</li><li>Android Keystore (.jks)</li><li>Backend environment variables and secrets</li></ul><h2>Financial Dispute</h2><ul><li>Phase 1: $35K agreed, $31.8K paid - COMPLETED</li><li>Website: $5K paid - COMPLETED</li><li>Phase 2: $30K agreed, $12.6K paid - 65% complete (Softzee\'s claim)</li><li>Softzee claims: $15.7K remaining</li><li>Softzee demands: Payment before full handover</li></ul><h2>App Tech Stack</h2><ul><li>Frontend: Next.js (App Router) + React/TypeScript</li><li>Backend: Node.js (Next.js API routes on AWS)</li><li>Payments: Stripe ($33.49/mo or $329/yr)</li><li>Video: Vimeo (300+ hours)</li><li>Mobile: React Native or native iOS/Android</li><li>Auth: Email, Google, Apple Sign-In</li><li>Programs: CF1-CF4, Yoga, Rings, Home (6+ programs)</li></ul><h2>Rebuild Timeline</h2><table><tr><th>Layer</th><th>Gabo + Claude</th><th>Junior Dev</th><th>Senior Dev</th></tr><tr><td>Landing Page</td><td>1-2 weeks</td><td>2-3 weeks</td><td>3-5 days</td></tr><tr><td>Web App</td><td>2-3 months</td><td>3-5 months</td><td>4-6 weeks</td></tr><tr><td>Mobile (PWA)</td><td>+2 weeks</td><td>+4 weeks</td><td>+1 week</td></tr></table><p><b>Recommendation:</b> PWA first (no App Store drama), native later.</p><h2>Strategic Recommendations</h2><ol><li>Don\'t pay remaining $15.7K until full handover</li><li>Ship bonus.saturnomovement.com FIRST - revenue TODAY</li><li>Landing page can be rebuilt in a weekend</li><li>Study sm-app-copy-v1: map database schema</li><li>Web app on managed stack: Vercel + Supabase</li></ol><h2>Gabo\'s Statement</h2><blockquote>"1 month ago was one thing, today.... I am confident I can build saturno movement app in a week if I wanted to even if I didn\'t have the source code, which I do."</blockquote>',
    created: now, updated: now
  };
  S.projects.push(smApp);

  // KB items for SM App
  S.knowledgeBase.push(
    { id:'kb_dev_call', projectId:'proj_sm_app', name:'Developer Call Prep - TOMORROW', type:'md', storage:'inline',
      content:'# Developer Call Prep Doc\nDate: Tomorrow\nWith: Softzee team\nGoal: Understand ownership, get access, define handoff\n\n## BEFORE THE CALL\n- [ ] Confirm repo access\n- [ ] List all services/APIs the app uses\n- [ ] Identify hosting/deployment setup\n- [ ] Review contracts\n\n## QUESTIONS TO ASK\n### Ownership & Access\n1. "What parts of the codebase are proprietary vs ours?"\n2. "Can we get full repo access today?"\n3. "Who has admin access to deployment platforms?"\n\n### Technical Architecture\n4. "What third-party services does this rely on?"\n5. "Walk me through how updates get pushed live"\n6. "What\'s the database situation?"\n\n### Handoff\n7. "What\'s the cleanest path to us taking over?"\n8. "What documentation exists?"\n9. "Can you do a recorded walkthrough of the codebase?"\n\n## RED FLAGS\n- Vague answers about ownership\n- Reluctance to share repo access\n- Hidden dependencies or vendor lock-in\n- No documentation\n- "It\'s complicated" without specifics\n\n## IDEAL OUTCOME\n- Full repo access granted\n- Clear list of all dependencies\n- Written handoff timeline with milestones\n- Recorded architecture walkthrough scheduled\n\n## NOTES DURING CALL\n(Fill in during the call)\n### What we learned:\n### Action items:\n### Follow-up needed:',
      description:'Prep doc for developer call - questions, red flags, ideal outcomes', tags:['developer','call','prep','priority'], created:now, updated:now },
    { id:'kb_app_vision', projectId:'proj_sm_app', name:'App Vision - Ableton of Movement', type:'md', storage:'inline',
      content:'# Saturno Movement App Vision\n\n## The Concept\n"Ableton of Movement" - treat movement composition like music production.\n\n## Core Metaphor\n| Music (Ableton) | Movement (SM App) |\n|---|---|\n| Tracks | Movement sequences |\n| Clips | Individual exercises |\n| Arrangement | Workout flow |\n| Effects | Progressions/regressions |\n| Tempo | Pace/rest intervals |\n| Mix | Balance of modalities |\n\n## Key Features\n1. Drag-and-drop workout builder\n2. Movement library (video clips)\n3. Progression paths\n4. Templates\n5. Export (to PDF, video, calendar)\n\n## Differentiators\n- Not just "pick exercises" - COMPOSE movement\n- Visual timeline interface\n- Modular, remixable workouts',
      description:'The Ableton of Movement vision for the app', tags:['vision','product','app'], created:now, updated:now },
    { id:'kb_softzee', projectId:'proj_sm_app', name:'Softzee Situation Summary', type:'md', storage:'inline',
      content:'# Softzee Situation\n\n## What We Need to Clarify\n1. Code ownership - Do we own the codebase?\n2. Data ownership - User data, content, analytics\n3. Deployment control - Can we deploy without them?\n4. Dependencies - What breaks if we part ways?\n\n## Possible Outcomes\n### Best Case\nFull handoff, clean break, documentation provided.\n### Acceptable Case\nTransition period, they support handoff.\n### Worst Case\nVendor lock-in, need full rebuild.\n\n## Decision Framework\nIf handoff cost > rebuild cost: REBUILD\nIf handoff time > 3 months: CONSIDER REBUILD\nIf trust is broken: REBUILD',
      description:'Summary of the developer situation', tags:['softzee','developer','situation'], created:now, updated:now },
    { id:'kb_rescue_docs', projectId:'proj_sm_app', name:'Rescue Docs (iCloud)', type:'pdf', storage:'reference',
      content:null, filePath:'~/Library/Mobile Documents/com~apple~CloudDocs/00_AI_HUB/\u{1F6A8}sm-app--rescue/', url:null,
      description:'Security audit, action plan, final dossier, iOS rebuild checklist, conversation export, bug list - all in iCloud', tags:['legal','developer','security'], created:now, updated:now }
  );

  // Project 2: Saturno Bonus
  const bonus = {
    id: 'proj_saturno_bonus', name: 'Saturno Bonus', icon: 'gift', status: 'active', color: '#4ade80',
    instructions: '<h1>Saturno Bonus - Customer Bonus Vault</h1><h2>Purpose</h2><p>Customer-facing bonus page with tools, music, and CF4 content for BF25 buyers.</p><h2>Deployment</h2><table><tr><th>Environment</th><th>URL</th><th>Status</th></tr><tr><td>Production</td><td>saturno-bonus-omega.vercel.app</td><td>LIVE (verified Feb 16)</td></tr><tr><td>Custom Domain</td><td>bonus.saturnomovement.com</td><td>PENDING (Cloudflare CNAME)</td></tr><tr><td>Repo</td><td>github.com/gabosaturno11/saturno-bonus</td><td>Private</td></tr></table><h2>Repository Structure</h2><pre>~/dev/saturno-bonus/\n  index.html          (main bonus page ~1,720 lines)\n  gate.html           (password gate)\n  experience.html     (8-zone scrolling journey)\n  admin.html          (SATURNO COMMAND dashboard)\n  api/                (config, admin-verify, brevo, verify)\n  tools/              (60 HTML tools - top level)\n  pdfs/               (15 PDFs - top level)\n  audio/              (36 tracks - gitignored, needs CDN)\n  music/              (gitignored)\n  video/              (app-promo.mp4 - gitignored)\n  assets/             (logos, css, js)\n  manifest.json       (PWA)\n  middleware.js       (auth protection)</pre><h2>Current Status (Feb 16)</h2><ul><li>LIVE: gate 200, index 302 (auth), tools 302 (auth)</li><li>44 tools visible (19 training + 25 experience), 3 internal hidden</li><li>15 PDFs, 36 tracks in music player</li><li>All FORGE refs removed, fully rebranded to VAULT</li><li>All 60 tools: Sora font, #050711 bg, vault back button</li><li>62 tool+PDF paths verified - zero broken references</li><li>Galaxy zoom with photorealistic canvas planet textures</li></ul><h2>Blockers (need Gabo)</h2><ul><li>Domain: bonus.saturnomovement.com CNAME in Cloudflare</li><li>Brevo: BREVO_API_KEY + BREVO_LIST_ID in Vercel env</li><li>Auth: VAULT_PASSWORD + VAULT_TOKEN in Vercel env</li><li>Audio CDN solution (audio/ is gitignored)</li><li>Physical device testing (mobile/tablet)</li></ul><h2>Domain Setup</h2><p>Gabo adds CNAME in Cloudflare: <code>bonus</code> -> <code>cname.vercel-dns.com</code></p><p>Then run: <code>vercel domains add bonus.saturnomovement.com</code></p>',
    created: now, updated: now
  };
  S.projects.push(bonus);

  S.knowledgeBase.push(
    { id:'kb_bonus_deploy', projectId:'proj_saturno_bonus', name:'Deployment Status', type:'md', storage:'inline',
      content:'# Deployment Status\nLive URL: saturno-bonus-omega.vercel.app\nRepo: github.com/gabosaturno11/saturno-bonus\nLatest commit: 856ca02 (Feb 16 cleanup)\n\n## Verified (Feb 16)\n- gate.html: 200 (public)\n- index.html: 302 (auth redirect, correct)\n- tools/*: 302 (auth redirect, correct)\n- ASTRA: 200\n\n## Checklist\n- [x] Vercel deployed (200)\n- [x] GitHub repo (private)\n- [x] All paths remapped (150+ refs)\n- [x] titan-forge refs removed from customer-facing files\n- [x] FORGE -> VAULT branding complete (nav, titles, PDF headers)\n- [x] 62 tool+PDF paths verified (zero broken)\n- [x] All 60 tools: Sora font, #050711 bg, vault back button\n- [x] Galaxy zoom photorealistic planets (canvas textures)\n- [x] THE BOOK removed from Coming Soon\n- [x] Audio error graceful (Streaming coming soon)\n- [x] 15 PDFs on disk match JS data\n- [x] 36 tracks in music player match data\n- [x] 44 tools visible (19 training + 25 experience)\n- [x] 3 internal tools hidden\n- [ ] Custom domain (bonus.saturnomovement.com)\n- [ ] Brevo email capture (needs env vars)\n- [ ] VAULT_PASSWORD + VAULT_TOKEN env vars\n- [ ] Audio CDN solution\n- [ ] Physical device testing',
      description:'Current deployment status and verified checklist', tags:['deployment','vercel','status','verified'], created:now, updated:now },
    { id:'kb_bonus_shipping', projectId:'proj_saturno_bonus', name:'Shipping Plan', type:'md', storage:'inline',
      content:'# Shipping Plan\n\n## Phase 1: Sample Quality Bar\n- ONE sample tool (template for quality)\n- ONE sample PDF (conversion template)\n- Music source locations identified\n\n## Phase 2: Batch Production\n- 100 tools audited and fixed\n- 100 PDFs generated (transcript-to-PDF tool)\n- Music organized into album subfolders with artwork\n\n## Phase 3: Assembly\n- All content wired into bonus page\n- Brevo email capture connected\n- Video embedded\n- Final QA\n\n## Phase 4: Launch\n- Deploy to bonus.saturnomovement.com\n- Email BF25 customers\n- Monitor analytics',
      description:'The shipping plan for bonus page launch', tags:['shipping','plan','priority'], created:now, updated:now }
  );

  // Project 3: Book (AOC)
  S.projects.push({
    id:'proj_book', name:'Book (AOC)', icon:'book', status:'active', color:'#f59e0b',
    instructions:'<h1>The Art of Calisthenics - Book Submission</h1><h2>Publisher</h2><p>Victory Belt Publishing - $20K advance</p><h2>Status</h2><p>Approved, pending submission of final package.</p><h2>Submission Package</h2><ul><li>Introductory Letter</li><li>Expanded TOC</li><li>Sample Chapters (Ch 1, 2, 11)</li><li>Overview Document</li></ul><h2>Location</h2><p><code>~/Downloads/_ORGANIZED/aoc-book/</code></p><h2>Current Blocker</h2><p>Organization, not creation. Content EXISTS.</p>',
    created:now, updated:now
  });

  // Project 4: HBS Program
  S.projects.push({
    id:'proj_hbs', name:'HBS Program', icon:'target', status:'paused', color:'#06b6d4',
    instructions:'<h1>Handbalancing System (HBS)</h1><h2>Solar System Progression</h2><ul><li>SUN: Foundation (wrist, shoulder, core)</li><li>MERCURY: Wall Work</li><li>VENUS: Kick-Up</li><li>EARTH: Balance (freestanding)</li><li>MARS: Shapes</li><li>JUPITER: Press</li><li>SATURN: One-Arm (mastery)</li></ul><h2>Location</h2><p><code>/Volumes/SSK Drive/HBS/</code> (8.3GB)</p><h2>Status</h2><p>Filming mode. Content exists on SSK Drive.</p>',
    created:now, updated:now
  });

  // Project 5: De Aqui a Saturno
  S.projects.push({
    id:'proj_karina', name:'De Aqui a Saturno', icon:'heart', status:'complete', color:'#ec4899',
    instructions:'<h1>De Aqui a Saturno</h1><h2>Valentine\'s Day Experience for Karina</h2><p>Crystal cosmic scroll experience: gate -> 18 chapters -> epic end -> 11 love dimensions -> finale</p><h2>Deployment</h2><ul><li>Live: de-aqui-a-saturno.vercel.app</li><li>Repo: github.com/gabosaturno11/de-aqui-a-saturno (private)</li></ul><h2>Features</h2><ul><li>Real piano audio (dual-track crossfade)</li><li>Real couple videos</li><li>Glassmorphism, ambient orbs, star parallax</li><li>11 love dimensions with unique SVG icons</li><li>KS monogram in finale</li><li>Hidden alien Easter egg</li></ul><p><b>Gabo\'s reaction:</b> "dude wtf I am crying" / "the UI is INSANE"</p>',
    created:now, updated:now
  });

  // Project 6: Claude Code (The Kernel)
  S.projects.push({
    id:'proj_claude_code', name:'Claude Code', icon:'terminal', status:'active', color:'#a78bfa',
    instructions:'<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div><h1>Claude Code - Session Continuity Kernel</h1><h2>Purpose</h2><p>This project is the SINGLE SOURCE OF TRUTH for every Claude Code session. Any new Claude reads this project first and knows exactly what to do without asking Gabo.</p><h2>Rules That NEVER Change</h2><ol><li>~/dev/ is canonical for ALL repos - NOT Desktop, NOT iCloud</li><li>NO DELETE - archive, never delete</li><li>Every Gabo message -> save to backend as-is (project/title/text)</li><li>Commit + deploy after EVERY meaningful change</li><li>Dark theme only, no emojis in code</li><li>Custom over SaaS, always</li><li>DO NOT ASK GABO - read the logs and specs, then execute</li></ol><h2>Active Repos</h2><table><tr><th>Repo</th><th>Local</th><th>Live</th></tr><tr><td>astra-command-center</td><td>~/dev/astra-command-center/</td><td>astra-command-center-sigma.vercel.app</td></tr><tr><td>titan-forge</td><td>~/dev/titan-forge/</td><td>titan-forge-ten.vercel.app</td></tr><tr><td>saturno-bonus</td><td>~/dev/saturno-bonus/</td><td>saturno-bonus-omega.vercel.app</td></tr><tr><td>de-aqui-a-saturno</td><td>~/dev/de-aqui-a-saturno/</td><td>de-aqui-a-saturno-jet.vercel.app</td></tr></table><h2>Machine Context</h2><ul><li>C2 iMac: username Gabosaturno (CAPITAL G)</li><li>C1 MacBook Pro: username gabosaturno (lowercase)</li><li>GitHub: gabosaturno11</li><li>titan-forge is 3.1GB - deploy via rsync to /tmp/ (exclude music/audio/video/.git)</li></ul><h2>Design Constraints</h2><ul><li>Pure black backgrounds (#000000 or #09090b)</li><li>Purple-blue accents (#6c3aff or #8b5cf6)</li><li>Cyan secondary (#00CFFF or #22d3ee)</li><li>Mint green for ASTRA (#4ade80)</li><li>Sora font for customer pages</li><li>Dark theme ONLY</li></ul><h2>Gabo Context</h2><ul><li>Running company ALONE - 3 clients, immigration, finances, 2 companies, book deadline</li><li>Developer LEFT - building everything solo with Claude</li><li>Does NOT want to babysit Claude - autonomous plans that run for hours</li><li>DURABILITY over speed - things that LAST</li></ul><h2>How to Use This Project</h2><p>1. Export this project as MD (click Export button above)</p><p>2. The exported file goes to the local repo as CLAUDE.md</p><p>3. Next Claude Code session reads it automatically</p><p>4. Update KB items below as state changes</p>',
    created:now, updated:now
  });

  // Project 7: Nexus Capture (Extension + Private Founder Space)
  S.projects.push({
    id:'proj_nexus_capture', name:'Nexus Capture', icon:'zap', status:'active', color:'#06b6d4',
    instructions:'<h1>Nexus Capture</h1><h2>Chrome Extension + Private Founder OS</h2><p>Universal highlight capture extension that routes to ASTRA backend. Currently unpacked/local only (not on Chrome Web Store).</p><h2>Extension</h2><ul><li>Repo: ~/dev/nexus-capture/</li><li>Manifest V3, 8 categories: idea, quote, code, insight, todo, book, research, thought</li><li>Keyboard shortcut: Cmd+Shift+S</li><li>Routes captures to astra-command-center-sigma.vercel.app/api/capture</li><li>Auth: Bearer token (ASTRA_ADMIN_PASSWORD)</li></ul><h2>Future: Private Founder Space</h2><p>A minimalistic, password-gated private space inside ASTRA for Gabo only. Alien SVG icon in corner as entry point. Behind auth wall.</p><h3>Vision</h3><ul><li>Extension captures land here first (private inbox)</li><li>Content from SATURNO_CREATOR_HUB.html migrated in: captions vault, content vault, writing hub</li><li>Minimalistic version of victory-belt-cc tools</li><li>Test zone for new features before they go public</li><li>Eventually: sellable Founder OS product (non-developer friendly)</li></ul><h3>Source Reference</h3><ul><li>SATURNO_CREATOR_HUB.html: ~/Desktop/CLAUDE NOT HERE/NOT A DEPLOYMENT ZONE/victory-belt-cc/SATURNO_CREATOR_HUB.html</li><li>Subpages: GABO_CONTENT_VAULT.html, GABO_ARCHIVE_VAULT.html, GABO_CAPTIONS_CATEGORIZED.csv, SATURNO_WRITING_HUB.html, SATURNO_PROGRESSION_TRACKER.html, FOCUS_TIMER.html</li></ul><h3>Design</h3><ul><li>Dark theme, minimal, alien SVG motif</li><li>Password-gated (separate from ASTRA admin)</li><li>Toggle ON/OFF for extension routing</li></ul><h2>Chrome Web Store</h2><p>NOT published yet. Needs: $5 dev account, privacy policy, configurable backend URL, review process. For now: unpacked extension on C2 iMac only.</p><h2>ASTRA as Product</h2><p>ASTRA has potential as a sellable Founder OS. Non-developer friendly. Once polished, this becomes a product for founders who want a command center without code.</p>',
    created:now, updated:now
  });
  S.knowledgeBase.push(
    { id:'kb_nexus_vision', projectId:'proj_nexus_capture', name:'Nexus Capture + Founder OS Vision', type:'md', storage:'inline',
      content:'# Nexus Capture + Private Founder Space\n\n## Current State (Feb 19, 2026)\n- Chrome extension: LOCAL ONLY (unpacked, dev mode)\n- Captures route to ASTRA API with Bearer auth\n- All API endpoints locked (GET and POST require auth)\n- Not on Chrome Web Store\n\n## Gabo Vision (Feb 19)\n> "set up a private place just for me... minimalistic alien svg on some corner... my FULLY private space aside from this convo so I can test shit or eventually with the extension that would be the place"\n> "ASTRA has so much potential for a founder OS selling standpoint that once it turns into the beast it is becoming, we will sell it"\n> "treat it as a place for a founder that is a non-developer"\n\n## Future Extension Flow\n1. Extension has password/PIN screen on first use\n2. Once unlocked: toggle "Send to ASTRA" ON/OFF\n3. When ON: captures go to private ASTRA backend (Bearer auth)\n4. When OFF: captures stay local\n\n## Private Space Features (from Creator Hub)\n- Captions vault (GABO_CAPTIONS_CATEGORIZED.csv)\n- Content vault (GABO_CONTENT_VAULT.html)\n- Writing hub (SATURNO_WRITING_HUB.html)\n- Progression tracker\n- Focus timer\n- Archive vault\n- All minimalistic, dark theme, behind auth wall\n\n## Chrome Web Store Checklist\n- [ ] $5 developer account\n- [ ] Privacy policy page\n- [ ] Make backend URL configurable (not hardcoded)\n- [ ] Remove any hardcoded secrets\n- [ ] Submit for review\n\n## Product Potential\nASTRA as Founder OS: command center for non-developers.\nExtension as capture layer. Private space as inbox.\nSell as SaaS once polished.',
      description:'Full vision doc for Nexus Capture extension and private founder space', tags:['nexus','extension','founder-os','vision','product'], created:now, updated:now },
    { id:'kb_nexus_security', projectId:'proj_nexus_capture', name:'API Security Audit (Feb 19)', type:'md', storage:'inline',
      content:'# ASTRA API Security Audit - Feb 19, 2026\n\n## All Endpoints Locked\n| Endpoint | GET | POST |\n|----------|-----|------|\n| /api/state | 401 | 401 |\n| /api/capture | 401 | 401 |\n| /api/transcripts | 401 | 401 |\n| /api/pipeline | 401 | 401 |\n| /api/transcribe | N/A | 401 |\n| /api/query | N/A | 401 |\n| /api/health | 200 (public, safe) | N/A |\n\n## Auth Method\nBearer token via ASTRA_ADMIN_PASSWORD env var in Vercel.\nFrontend stores password in localStorage, prompts once.\nExtension sends same Bearer header.\n\n## Why NOT Vercel Deployment Protection\nWould block extension and scripts (no interactive session cookie).\nBearer token auth is machine-friendly and works everywhere.\n\n## Commits\n- a50cf35: Remove hardcoded password\n- 0dba84c: Fix capture.js auth\n- 02ad39a: Lock pipeline/transcribe/query\n- 5ac20fa: Lock GET endpoints (state/capture/transcripts)',
      description:'Security audit showing all endpoints locked', tags:['security','api','audit'], created:now, updated:now }
  );

  // KB items for Claude Code project
  S.knowledgeBase.push(
    { id:'kb_cc_session_log', projectId:'proj_claude_code', name:'Session Log - Feb 16 Cleanup', type:'md', storage:'inline',
      content:'# Session Log - Feb 16, 2026 (Autonomous Cleanup)\n\n## 9-Phase Cleanup Completed\nGabo left for 2 hours. Claude ran autonomous 9-phase cleanup across both repos.\n\n### saturno-bonus (9 commits)\n1. Galaxy zoom: photorealistic canvas planet textures, sun corona, Saturn rings\n2. Bigger planets + wider orbits for visible detail\n3. Broken links fixed (deleted PDF, nonexistent onboarding/studio/hub/command pages)\n4. titan-forge refs updated to saturno-bonus in nexus, master-hub, package-lock\n5. Nav labels FORGE -> VAULT in 9 tool files\n6. UX: THE BOOK removed from Coming Soon, audio error msg improved\n7. Page titles: 7 files SATURNO FORGE -> SATURNO VAULT\n8. PDF headers: titan.html + batch-generator.html FORGE -> VAULT\n9. constellation-builder.html: JetBrains Mono -> Sora in canvas\n\n### astra-command-center (2 commits)\n1. ASTRA seed data: 8 URL/path inconsistencies fixed (-omega, -sigma, stale counts)\n2. Cleanup log added to logs/\n\n## Quality Audit Results\n- 62/62 tool+PDF paths verified — ZERO broken references\n- 6 training tools deep-audited — all production-ready\n- 6 experience tools deep-audited — all production-ready\n- All 60 tools: Sora font, #050711 bg, vault back button\n- Deploy verified: gate 200, index 302, tools 302, ASTRA 200\n\n## Git State\n- saturno-bonus: CLEAN, latest `856ca02`\n- astra-command-center: CLEAN, latest `65f8293`\n- 30 messages in backend (ids -1 to 29)\n\n## Remaining (needs Gabo)\n- Brevo env vars, VAULT_PASSWORD/TOKEN, domain CNAME, audio CDN, device testing',
      description:'Feb 16 autonomous cleanup session results', tags:['session','log','cleanup','state'], created:now, updated:now },
    { id:'kb_cc_gabo_rules', projectId:'proj_claude_code', name:'Gabo Rules (Permanent)', type:'md', storage:'inline',
      content:'# Rules That Never Change\n\n1. ~/dev/ is canonical for ALL repos\n2. NO DELETE - archive only\n3. Every Gabo message -> backend as-is\n4. Commit + deploy after EVERY change\n5. Dark theme only\n6. Custom over SaaS\n7. DO NOT ASK - read logs, execute\n8. BOOK FIRST (Goal 1 priority)\n9. Desktop is NOT a battlefield\n10. planet-logo.png is THE logo (white planet silhouette)\n11. Audio 404s on Vercel (gitignored) - needs CDN\n12. Brevo email needs BREVO_API_KEY + BREVO_LIST_ID in Vercel env\n13. CONNECT dont build - 150+ tools exist\n14. Save context aggressively - 9-hour sessions are normal',
      description:'Permanent rules that never change across sessions', tags:['rules','permanent','kernel'], created:now, updated:now },
    { id:'kb_cc_messages', projectId:'proj_claude_code', name:'Gabo Messages Backend', type:'md', storage:'inline',
      content:'# Gabo Messages Backend\n\n**Location:** ~/dev/saturno-bonus/logs/gabo-messages.json\n\n## Messages (30 total, ids -1 to 29)\n- #-1: READ ALL MESSAGES (pinned)\n- #0: NORTH STAR (pinned)\n- #1-7: Shipping plan, decouple, ASTRA upgrade, specs, GO BUILD (Feb 14-15)\n- #8-16: Session start, goal 1 continuity, every change commit, how plan fails, 8h infallible, claimed done too early, fix kernel, 40-item TODO, save specs in logs (Feb 16 AM)\n- #17-23: Fix continuity, system didnt work, titan-forge confirms pattern, no clue, calendar fixed, do not build save msgs only, prove you wrong (Feb 16 PM)\n- #24-29: Galaxy zoom planets, speed priority, full deployment audit, ASTRA consistency audit, 2h autonomous cleanup, save fix script (Feb 16 EVE)\n\n## Rule\nDefault = save EVERY message Gabo sends.\nOnly skip if Gabo says "dont save".',
      description:'Backend message log tracking - 30 messages', tags:['messages','backend','log'], created:now, updated:now },
    { id:'kb_cc_handoff', projectId:'proj_claude_code', name:'Next Claude Handoff (copy-paste)', type:'md', storage:'inline',
      content:'# Next Claude Handoff\n\nPaste this into a new Claude Code session:\n\n```\nRead ~/dev/saturno-bonus/CLAUDE.md and ~/dev/astra-command-center/CLAUDE.md, then ~/dev/saturno-bonus/logs/gabo-messages.json. ASTRA live: astra-command-center-sigma.vercel.app — Bonus live: saturno-bonus-omega.vercel.app. Don\'t ask where we are.\n```\n\n## Live URLs\n- **ASTRA:** https://astra-command-center-sigma.vercel.app\n- **Bonus (gate):** https://saturno-bonus-omega.vercel.app/gate.html\n- **Bonus password:** saturno2025\n\n## Local Paths\n- `~/dev/saturno-bonus/` — THE bonus page repo\n- `~/dev/astra-command-center/` — ASTRA command center\n- `~/dev/titan-forge/` — internal tools (bonus MOVED OUT)\n- `~/dev/de-aqui-a-saturno/` — Valentine\'s experience\n\n## Files Next Claude MUST Read\n1. `~/.claude/CLAUDE.md` — global kernel (auto-loaded)\n2. `~/.claude/projects/-Users-Gabosaturno/memory/MEMORY.md` — session state (auto-loaded)\n3. `~/dev/saturno-bonus/CLAUDE.md` — bonus project state\n4. `~/dev/saturno-bonus/logs/gabo-messages.json` — 31 messages, real context\n5. `~/dev/astra-command-center/CLAUDE.md` — ASTRA project state\n\n## GitHub\n- Account: gabosaturno11\n- All repos private\n- Deploy: git push main -> Vercel auto-deploys\n\n## Git Email\ngabo@saturnomovement.com (all repos)',
      description:'Copy-paste handoff block for next Claude Code session', tags:['handoff','next-claude','code','copy-paste'], created:now, updated:now }
  );
  S._seeded = true;
}

// Handle KB drop on whiteboard
function handleWbDrop(e) {
  const data = e.dataTransfer?.getData('text/plain');
  if(data && data.startsWith('kb:')) {
    e.preventDefault();
    const kbId = data.replace('kb:','');
    const k = (S.knowledgeBase||[]).find(x=>x.id===kbId);
    if(!k) return;
    const p = wbScreenToCanvas(e.clientX, e.clientY);
    const typeColors = {md:'#3b82f6',pdf:'#ef4444',img:'#22c55e',url:'#8b5cf6',txt:'#6b7280',json:'#eab308',other:'#6b7280'};
    const n = wbAddNode(p.x-80, p.y-40, '['+k.type.toUpperCase()+'] '+k.name, k.description||'', typeColors[k.type]||'#3b82f6', 200, 90);
    n.docRef = kbId;
    n.docType = k.type;
    wbSaveState();
    toast('Added to whiteboard');
  }
}

// projectId assignment for links is handled directly in saveLink()

// === GLOBAL ===
function exportAll(){snapshotWriter();snapshotSpec();if(activeProject){const p=getProject(activeProject);if(p){p.instructions=document.getElementById('proj-instructions-editor')?.innerHTML||p.instructions;}}const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-hub-'+new Date().toISOString().split('T')[0]+'.json';a.click();toast('Exported');}
function exportSummary(){
  snapshotWriter();snapshotSpec();
  const today=new Date().toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const done=S.tasks.filter(t=>t.status==='done');
  const overdue=active.filter(t=>t.due&&t.due<today);
  const priorities={p0:active.filter(t=>t.priority==='p0').length,p1:active.filter(t=>t.priority==='p1').length,p2:active.filter(t=>t.priority==='p2').length,p3:active.filter(t=>t.priority==='p3').length};
  let md='# SATURNO HUB Summary\n';
  md+=`**Generated:** ${new Date().toLocaleString()}\n\n`;
  md+='---\n\n## Tasks\n';
  md+=`- **Active:** ${active.length} | **Done:** ${done.length} | **Overdue:** ${overdue.length}\n`;
  md+=`- **By Priority:** P0=${priorities.p0} P1=${priorities.p1} P2=${priorities.p2} P3=${priorities.p3}\n\n`;
  if(overdue.length){md+='### Overdue\n';overdue.forEach(t=>{md+=`- [${t.priority||'p2'}] ${t.title} (due ${t.due})\n`;});md+='\n';}
  const todayTasks=active.filter(t=>t.due===today);
  if(todayTasks.length){md+='### Due Today\n';todayTasks.forEach(t=>{md+=`- [${t.priority||'p2'}] ${t.title}\n`;});md+='\n';}
  md+='## Content\n';
  md+=`- **Items:** ${S.content.length}\n`;
  const totalW=S.content.reduce((s,c)=>(c.body||'').trim().split(/\s+/).filter(x=>x.length).length+s,0);
  md+=`- **Total words:** ${totalW.toLocaleString()}\n\n`;
  md+='## Documents\n';
  md+=`- **Writer docs:** ${(S.docs||[]).length}\n`;
  md+=`- **Living Docs:** ${(S.specs||[]).length}\n\n`;
  md+='## Links\n';
  md+=`- **Total:** ${(S.links||[]).length}\n`;
  const cats=[...new Set((S.links||[]).map(l=>l.category).filter(Boolean))];
  if(cats.length)md+=`- **Categories:** ${cats.join(', ')}\n`;
  md+='\n## Projects\n';
  (S.projects||[]).forEach(p=>{
    const pt=S.tasks.filter(t=>(t.projectId||t.project)===p.id);
    const pa=pt.filter(t=>t.status!=='done').length;
    md+=`- **${p.name}** (${p.status||'active'}) — ${pa} active tasks\n`;
  });
  md+='\n## Repos\n';
  (S.repos||[]).forEach(r=>{md+=`- ${r.name} — ${r.live||'no live URL'} (${r.status||'unknown'})\n`;});
  md+='\n---\n*Exported from SATURNO HUB*\n';
  navigator.clipboard.writeText(md).then(()=>toast('Summary copied to clipboard')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-summary-'+today+'.md';a.click();toast('Summary downloaded');
  });
}
function dailyDashboard(){
  const today=new Date().toISOString().split('T')[0];
  const todayLabel=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const active=S.tasks.filter(t=>t.status!=='done');
  const overdue=active.filter(t=>t.due&&t.due<today);
  const dueToday=active.filter(t=>t.due===today);
  const inProgress=active.filter(t=>t.status==='progress');
  const blocked=active.filter(t=>t.status==='blocked');
  const doneToday=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at&&e.at.startsWith(today)));
  const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString()));
  let md='# Daily Dashboard: '+todayLabel+'\n\n';
  md+='## Priority Focus\n';
  if(overdue.length){md+='### OVERDUE ('+overdue.length+')\n';overdue.forEach(t=>md+='- ['+t.priority+'] '+t.title+' (due '+t.due+')\n');md+='\n';}
  if(dueToday.length){md+='### Due Today ('+dueToday.length+')\n';dueToday.forEach(t=>md+='- ['+t.priority+'] '+t.title+(t.project?' ['+t.project+']':'')+'\n');md+='\n';}
  if(inProgress.length){md+='### In Progress ('+inProgress.length+')\n';inProgress.forEach(t=>md+='- '+t.title+(t.timeStarted?' (timer running)':'')+(t.estimate?' ~'+t.estimate:'')+'\n');md+='\n';}
  if(blocked.length){md+='### Blocked ('+blocked.length+')\n';blocked.forEach(t=>md+='- '+t.title+(t.blockedBy?' (by: '+t.blockedBy+')':'')+'\n');md+='\n';}
  md+='## Stats\n';
  md+='- Tasks: '+active.length+' active, '+doneToday.length+' done today, '+doneThisWeek.length+' done this week\n';
  md+='- Content: '+S.content.length+' items\n';
  md+='- Documents: '+S.docs.length+' docs, '+S.specs.length+' living docs\n';
  md+='- Links: '+S.links.length+'\n';
  const tracked=S.tasks.filter(t=>t.timeSpent||t.timeStarted);
  if(tracked.length){let total=0;tracked.forEach(t=>{let m=t.timeSpent||0;if(t.timeStarted)m+=Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);total+=m;});md+='- Time tracked: '+formatTimeSpent(total)+' across '+tracked.length+' tasks\n';}
  md+='\n---\n*Generated from SATURNO HUB*\n';
  navigator.clipboard.writeText(md).then(()=>toast('Daily dashboard copied to clipboard'));
}
function dataStats(){
  const raw=localStorage.getItem(SK)||'';const bytes=new Blob([raw]).size;const kb=(bytes/1024).toFixed(1);
  const taskBytes=new Blob([JSON.stringify(S.tasks)]).size;
  const contentBytes=new Blob([JSON.stringify(S.content)]).size;
  const docsBytes=new Blob([JSON.stringify(S.docs)]).size;
  const specsBytes=new Blob([JSON.stringify(S.specs||[])]).size;
  const linksBytes=new Blob([JSON.stringify(S.links)]).size;
  const kbBytes=new Blob([JSON.stringify(S.knowledgeBase||[])]).size;
  const format=b=>(b/1024).toFixed(1)+'KB';
  const msg=`Storage: ${kb}KB total\n\nTasks: ${S.tasks.length} items (${format(taskBytes)})\nContent: ${S.content.length} items (${format(contentBytes)})\nDocs: ${(S.docs||[]).length} items (${format(docsBytes)})\nSpecs: ${(S.specs||[]).length} items (${format(specsBytes)})\nLinks: ${S.links.length} items (${format(linksBytes)})\nKB: ${(S.knowledgeBase||[]).length} items (${format(kbBytes)})\nRepos: ${(S.repos||[]).length}\nProjects: ${(S.projects||[]).length}\nArchived: ${(S.archivedTasks||[]).length} tasks`;
  toast(msg.split('\n')[0]);
  navigator.clipboard.writeText(msg).then(()=>toast('Stats copied to clipboard'));
}
function timeReport(){
  const tracked=S.tasks.filter(t=>t.timeSpent||t.timeStarted);
  if(!tracked.length){toast('No tasks with tracked time');return;}
  let total=0;
  let md='# Time Report\n'+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n\n';
  tracked.sort((a,b)=>(b.timeSpent||0)-(a.timeSpent||0));
  tracked.forEach(t=>{
    let mins=t.timeSpent||0;
    if(t.timeStarted)mins+=Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);
    total+=mins;
    md+=`- **${t.title||'Untitled'}** (${t.status}) — ${formatTimeSpent(mins)}${t.project?' ['+t.project+']':''}\n`;
  });
  md+=`\n**Total tracked: ${formatTimeSpent(total)}** across ${tracked.length} tasks`;
  navigator.clipboard.writeText(md).then(()=>toast('Time report copied — '+formatTimeSpent(total)+' total'));
}
function importAll(){
  // Auto-backup before import (UNDO safety net)
  const backup = localStorage.getItem(SK);
  if(backup) { localStorage.setItem(SK+'_backup', backup); localStorage.setItem(SK+'_backup_time', new Date().toISOString()); }
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const f=e.target.files[0],r=new FileReader();r.onload=ev=>{try{S={content:[],tasks:[],links:[],docs:[],specs:[],activeDoc:null,activeSpec:null,whiteboard:{},projects:[],knowledgeBase:[],folders:[],...JSON.parse(ev.target.result)};if(!S.projects)S.projects=[];if(!S.knowledgeBase)S.knowledgeBase=[];save();renderProjectsSidebar();switchSection(currentSection||'content',document.querySelector('.sidebar-item.active'));toast('Imported (backup saved — click Undo Import to revert)');}catch(e){toast('Invalid JSON');}};r.readAsText(f);};inp.click();
}
function undoImport(){
  const backup = localStorage.getItem(SK+'_backup');
  if(!backup) { toast('No backup available'); return; }
  const time = localStorage.getItem(SK+'_backup_time');
  S = {content:[],tasks:[],links:[],docs:[],specs:[],activeDoc:null,activeSpec:null,whiteboard:{},projects:[],knowledgeBase:[],...JSON.parse(backup)};
  if(!S.projects)S.projects=[];if(!S.knowledgeBase)S.knowledgeBase=[];
  save();renderProjectsSidebar();switchSection('content',document.querySelector('.sidebar-item'));
  toast('Reverted to backup from '+(time||'unknown'));
}

// === PROJECT EXPORT ===
let exportMenuOpen = false;
function showExportMenu(e) {
  e.stopPropagation();
  if(exportMenuOpen) { closeExportMenu(); return; }
  const existing = document.querySelector('.export-menu');
  if(existing) existing.remove();
  const menu = document.createElement('div');
  menu.className = 'export-menu';
  menu.innerHTML = `
    <div class="export-menu-item" onclick="exportProjectMD()">
      <span class="export-icon">MD</span>
      <div><div class="export-menu-label">Markdown</div><div class="export-menu-desc">Full project as .md file</div></div>
    </div>
    <div class="export-menu-item" onclick="exportProjectJSON()">
      <span class="export-icon">{ }</span>
      <div><div class="export-menu-label">JSON</div><div class="export-menu-desc">Raw data for import</div></div>
    </div>
    <div class="export-menu-item" onclick="copyProjectMD()">
      <span class="export-icon">CP</span>
      <div><div class="export-menu-label">Copy as Markdown</div><div class="export-menu-desc">Copy to clipboard</div></div>
    </div>
  `;
  document.querySelector('.project-header-actions').appendChild(menu);
  exportMenuOpen = true;
  setTimeout(() => document.addEventListener('click', closeExportMenu, {once:true}), 10);
}
function closeExportMenu() {
  const m = document.querySelector('.export-menu');
  if(m) m.remove();
  exportMenuOpen = false;
}
function buildProjectMD() {
  const p = getProject(activeProject);
  if(!p) return '';
  const kbItems = (S.knowledgeBase||[]).filter(k => k.projectId === activeProject);
  const docs = (S.specs||[]).filter(s => s.projectId === activeProject);
  const tasks = getProjectTasks(activeProject);
  const links = (S.links||[]).filter(l => l.projectId === activeProject);
  // Convert HTML instructions to readable text
  const div = document.createElement('div');
  div.innerHTML = p.instructions || '';
  const instrText = div.innerText || div.textContent || '';
  let md = `# ${p.name}\n`;
  md += `**Status:** ${p.status} | **Icon:** ${p.icon} | **Color:** ${p.color}\n`;
  md += `**Updated:** ${p.updated || p.created}\n\n`;
  md += `---\n\n## Instructions\n\n${instrText}\n\n`;
  if(kbItems.length) {
    md += `---\n\n## Knowledge Base (${kbItems.length} items)\n\n`;
    kbItems.forEach(k => {
      md += `### ${k.name}\n`;
      md += `**Type:** ${k.type} | **Storage:** ${k.storage}\n`;
      if(k.description) md += `${k.description}\n`;
      if(k.tags && k.tags.length) md += `**Tags:** ${k.tags.join(', ')}\n`;
      if(k.content && k.type !== 'img') md += `\n${k.content}\n`;
      if(k.filePath) md += `**File:** ${k.filePath}\n`;
      if(k.url) md += `**URL:** ${k.url}\n`;
      md += '\n';
    });
  }
  if(docs.length) {
    md += `---\n\n## Living Docs (${docs.length})\n\n`;
    docs.forEach(d => {
      md += `### ${d.title}\n`;
      if(d.sections) d.sections.forEach(s => {
        md += `#### ${s.title}\n`;
        const sdiv = document.createElement('div');
        sdiv.innerHTML = s.body || '';
        md += (sdiv.innerText || '') + '\n\n';
      });
    });
  }
  if(tasks.length) {
    md += `---\n\n## Tasks (${tasks.length})\n\n`;
    tasks.forEach(t => {
      const check = t.status === 'done' ? 'x' : ' ';
      md += `- [${check}] ${t.title} (${t.status}${t.due ? ', due: '+t.due : ''})\n`;
    });
    md += '\n';
  }
  if(links.length) {
    md += `---\n\n## Links (${links.length})\n\n`;
    links.forEach(l => {
      md += `- [${l.title}](${l.url})${l.desc ? ' — '+l.desc : ''}\n`;
    });
    md += '\n';
  }
  md += `---\n\n*Exported from ASTRA Command Center on ${new Date().toISOString().split('T')[0]}*\n`;
  return md;
}
function exportProjectMD() {
  const p = getProject(activeProject);
  if(!p) return;
  const md = buildProjectMD();
  const blob = new Blob([md], {type:'text/markdown'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-') + '.md';
  a.click();
  closeExportMenu();
  toast('Exported as Markdown');
}
function exportProjectJSON() {
  const p = getProject(activeProject);
  if(!p) return;
  const data = {
    project: p,
    knowledgeBase: (S.knowledgeBase||[]).filter(k => k.projectId === activeProject),
    livingDocs: (S.specs||[]).filter(s => s.projectId === activeProject),
    tasks: getProjectTasks(activeProject),
    links: (S.links||[]).filter(l => l.projectId === activeProject),
    exportedAt: new Date().toISOString(),
    exportedFrom: 'ASTRA Command Center'
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-') + '.json';
  a.click();
  closeExportMenu();
  toast('Exported as JSON');
}
function copyProjectMD() {
  const md = buildProjectMD();
  navigator.clipboard.writeText(md).then(() => {
    closeExportMenu();
    toast('Copied to clipboard');
  }).catch(() => {
    closeExportMenu();
    toast('Copy failed — try Export instead');
  });
}

// === VOICE INPUT ===
let voiceTarget = null, voiceActive = false, voiceRecorder = null, voiceChunks = [];
function initVoice() { /* MediaRecorder init happens on toggle */ }
async function toggleVoice(target) {
  voiceTarget = target;
  if(voiceActive && voiceRecorder && voiceRecorder.state === 'recording') {
    voiceRecorder.stop();
    voiceActive = false;
    updateVoiceUI();
    toast('Processing with Whisper...');
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    voiceChunks = [];
    voiceRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    voiceRecorder.ondataavailable = e => { if(e.data.size > 0) voiceChunks.push(e.data); };
    voiceRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(voiceChunks, { type: 'audio/webm' });
      if(blob.size < 100) { toast('Recording too short'); return; }
      toast('Transcribing...');
      try {
        const fd = new FormData();
        fd.append('audio', blob, 'recording.webm');
        const res = await fetch(ASTRA_API + '/api/transcribe', { method: 'POST', headers: { 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW }, body: fd });
        const data = await res.json();
        if(data.ok && data.text) {
          const el = voiceTarget === 'writer' ? document.getElementById('writer-editor') : document.querySelector('.specs-section-editor:focus') || document.querySelector('.specs-section-editor');
          if(el) { el.focus(); document.execCommand('insertText', false, data.text + ' '); if(voiceTarget==='writer') onWriterChange(); else onSpecChange(); }
          toast('Whisper: ' + data.text.substring(0, 60) + (data.text.length > 60 ? '...' : ''));
        } else { toast('Transcription failed: ' + (data.error || 'unknown')); }
      } catch(e) { toast('Whisper error: ' + e.message); }
    };
    voiceRecorder.start();
    voiceActive = true;
    updateVoiceUI();
    toast('Recording... click again to stop');
  } catch(e) { toast('Mic access denied'); }
}
function updateVoiceUI() {
  const wb = document.getElementById('writer-voice-btn'), sb = document.getElementById('specs-voice-btn');
  if(wb) wb.classList.toggle('recording', voiceActive && voiceTarget === 'writer');
  if(sb) sb.classList.toggle('recording', voiceActive && voiceTarget === 'specs');
}

// === WHITEBOARD ENGINE ===
let wbNodes = [], wbConns = [], wbTool = 'select', wbScale = 1, wbPanX = 0, wbPanY = 0;
let wbDrag = null, wbConnStart = null, wbPanning = false, wbPanStart = null;
let wbSelected = null, wbResizing = null, wbGrid = true;
let wbHistory = [], wbHistoryIdx = -1, wbNodeId = 100;
const COLORS = ['#3b82f6','#8b5cf6','#06b6d4','#22c55e','#eab308','#f97316','#ef4444','#ec4899'];
const STICKY_COLORS = ['#fef08a','#bbf7d0','#bfdbfe','#fbcfe8','#fde68a','#c4b5fd'];

function wbSaveState() {
  wbHistory = wbHistory.slice(0, wbHistoryIdx + 1);
  wbHistory.push(JSON.stringify({nodes:wbNodes,conns:wbConns}));
  if(wbHistory.length > 50) wbHistory.shift();
  wbHistoryIdx = wbHistory.length - 1;
  wbPersist();
}
function wbUndo() { if(wbHistoryIdx > 0) { wbHistoryIdx--; wbRestoreHistory(); }}
function wbRedo() { if(wbHistoryIdx < wbHistory.length - 1) { wbHistoryIdx++; wbRestoreHistory(); }}
function wbRestoreHistory() { const d = JSON.parse(wbHistory[wbHistoryIdx]); wbNodes = d.nodes; wbConns = d.conns; wbRender(); wbPersist(); }
function wbPersist() { if(!S.whiteboard) S.whiteboard = {}; S.whiteboard = {nodes:wbNodes,conns:wbConns,panX:wbPanX,panY:wbPanY,scale:wbScale}; save(); }
function wbLoadState() { if(S.whiteboard) { wbNodes = S.whiteboard.nodes || []; wbConns = S.whiteboard.conns || []; wbPanX = S.whiteboard.panX || 0; wbPanY = S.whiteboard.panY || 0; wbScale = S.whiteboard.scale || 1; wbNodeId = Math.max(100, ...wbNodes.map(n=>n.id)) + 1; } wbSaveState(); }

function wbSetTool(t) { wbTool = t; document.querySelectorAll('.wb-tool[data-tool]').forEach(b => b.classList.toggle('active', b.dataset.tool === t)); const w = document.getElementById('wb-canvas-wrap'); w.style.cursor = t==='hand'?'grab':t==='connect'?'crosshair':t==='node'||t==='text'||t==='sticky'?'cell':'default'; }
function wbToggleGrid() { wbGrid = !wbGrid; wbRender(); toast(wbGrid ? 'Grid on' : 'Grid off'); }
function wbZoom(d) { wbScale = Math.max(0.2, Math.min(3, wbScale + d)); document.getElementById('wb-zoom-level').textContent = Math.round(wbScale * 100) + '%'; wbUpdateTransform(); wbUpdateMinimap(); }
function wbWheel(e) { e.preventDefault(); wbZoom(e.deltaY > 0 ? -0.05 : 0.05); }
function wbUpdateTransform() { document.getElementById('wb-canvas').style.transform = `translate(${wbPanX}px,${wbPanY}px) scale(${wbScale})`; }

function wbSnap(v) { return wbGrid ? Math.round(v / 20) * 20 : v; }
function wbScreenToCanvas(x, y) { const r = document.getElementById('wb-canvas-wrap').getBoundingClientRect(); return { x: (x - r.left - wbPanX) / wbScale, y: (y - r.top - wbPanY) / wbScale }; }

function wbAddNode(x, y, title, body, color, w, h, type) {
  const n = { id: wbNodeId++, x: wbSnap(x), y: wbSnap(y), w: w||160, h: h||80, title: title||'', body: body||'', color: color||COLORS[0], type: type||'node' };
  wbNodes.push(n);
  wbSaveState();
  wbRender();
  return n;
}
function wbDuplicateNode(id){
  const n=wbNodes.find(x=>x.id===id);if(!n)return;
  wbAddNode(n.x+30,n.y+30,n.title+' (copy)',n.body,n.color,n.w,n.h,n.type);
  toast('Node duplicated');
}
function wbToggleLock(id){
  const n=wbNodes.find(x=>x.id===id);if(!n)return;
  n.locked=!n.locked;wbSaveState();wbRender();toast(n.locked?'Node locked':'Node unlocked');
}

function wbRender() {
  const canvas = document.getElementById('wb-canvas');
  const svgEl = document.getElementById('wb-svg');
  // Grid
  let gridHtml = '';
  if(wbGrid) {
    const gs = 20;
    gridHtml = `<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="wbgrid" width="${gs}" height="${gs}" patternUnits="userSpaceOnUse"><path d="M ${gs} 0 L 0 0 0 ${gs}" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="0.5"/></pattern></defs><rect width="100%" height="100%" fill="url(#wbgrid)"/></svg>`;
  }
  // Nodes
  let nodesHtml = wbNodes.map(n => {
    const isSel = wbSelected === n.id;
    const isSticky = n.type === 'sticky';
    const bg = isSticky ? n.color : 'var(--bg-surface)';
    const textColor = isSticky ? '#1a1a24' : 'var(--text)';
    return `<div class="wb-node ${isSel?'selected':''}" data-id="${n.id}" style="left:${n.x}px;top:${n.y}px;width:${n.w}px;min-height:${n.h}px;background:${bg}${n.locked?';border-style:dashed;opacity:0.85':''}${n._highlight?';box-shadow:0 0 12px 3px var(--accent),0 0 0 2px var(--accent);z-index:100':''}" onmousedown="wbNodeDown(event,${n.id})">
      ${!isSticky?`<div class="wb-node-color" style="background:${n.color}"></div>`:''}
      <div class="wb-node-header" contenteditable="true" style="color:${textColor}" onblur="wbNodeEdit(${n.id},'title',this.textContent)" onclick="event.stopPropagation()">${esc(n.title)}</div>
      <div class="wb-node-body" contenteditable="true" style="color:${isSticky?'#333':'var(--text-secondary)'}" onblur="wbNodeEdit(${n.id},'body',this.textContent)" onclick="event.stopPropagation()">${esc(n.body)}</div>
      <button class="wb-node-del" onclick="event.stopPropagation();wbDeleteNode(${n.id})">x</button>
      <button class="wb-node-dup" onclick="event.stopPropagation();wbDuplicateNode(${n.id})" style="position:absolute;top:-8px;right:14px;width:18px;height:18px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:20" title="Duplicate">+</button>
      <button onclick="event.stopPropagation();wbToggleLock(${n.id})" style="position:absolute;bottom:2px;left:2px;width:14px;height:14px;border:none;background:none;color:${n.locked?'var(--yellow)':'var(--text-muted)'};cursor:pointer;font-size:8px;opacity:${n.locked?'0.8':'0'};transition:opacity 0.15s;z-index:20" class="wb-lock-btn" title="${n.locked?'Unlock':'Lock'}">${n.locked?'L':'L'}</button>
      <button class="wb-node-color-btn" onclick="event.stopPropagation();wbPickColor(${n.id})" style="position:absolute;top:2px;right:20px;width:14px;height:14px;border:none;border-radius:50%;background:${n.color};cursor:pointer;opacity:0;transition:opacity 0.15s" title="Change color"></button>
      <div class="wb-node-resize" onmousedown="event.stopPropagation();wbResizeStart(event,${n.id})"></div>
      <div class="wb-node-port wb-port-right" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'right')"></div>
      <div class="wb-node-port wb-port-bottom" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'bottom')"></div>
      <div class="wb-node-port wb-port-left" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'left')"></div>
      <div class="wb-node-port wb-port-top" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'top')"></div>
    </div>`;
  }).join('');
  // SVG connections
  let svgPaths = wbConns.map(c => {
    const from = wbNodes.find(n => n.id === c.from);
    const to = wbNodes.find(n => n.id === c.to);
    if(!from || !to) return '';
    const fx = from.x + from.w / 2, fy = from.y + from.h / 2;
    const tx = to.x + to.w / 2, ty = to.y + to.h / 2;
    const mx = (fx + tx) / 2, my = (fy + ty) / 2;
    const dx = tx - fx, dy = ty - fy;
    const cx1 = fx + dx * 0.4, cy1 = fy;
    const cx2 = tx - dx * 0.4, cy2 = ty;
    return `<path d="M${fx},${fy} C${cx1},${cy1} ${cx2},${cy2} ${tx},${ty}" fill="none" stroke="${c.color||'rgba(59,130,246,0.5)'}" stroke-width="2" marker-end="url(#arrow)"/>`;
  }).join('');
  const svgContent = `<defs><marker id="arrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="rgba(59,130,246,0.6)"/></marker></defs>${svgPaths}`;
  canvas.innerHTML = `<div class="wb-grid">${gridHtml}</div><svg class="wb-svg" style="width:5000px;height:5000px">${svgContent}</svg>${nodesHtml}`;
  wbUpdateTransform();
  wbUpdateMinimap();
  const wbStatsEl=document.getElementById('wb-stats');if(wbStatsEl)wbStatsEl.textContent=wbNodes.length+'n / '+wbConns.length+'c';
}

function wbUpdateMinimap() {
  const mm = document.getElementById('wb-minimap');
  if(!wbNodes.length) { mm.innerHTML = ''; return; }
  const minX = Math.min(...wbNodes.map(n=>n.x)), maxX = Math.max(...wbNodes.map(n=>n.x+n.w));
  const minY = Math.min(...wbNodes.map(n=>n.y)), maxY = Math.max(...wbNodes.map(n=>n.y+n.h));
  const pad = 100, rw = maxX - minX + pad * 2, rh = maxY - minY + pad * 2;
  const mmW = 160, mmH = 100, sx = mmW / rw, sy = mmH / rh, s = Math.min(sx, sy);
  const wrap = document.getElementById('wb-canvas-wrap');
  const vx = (-wbPanX / wbScale - minX + pad) * s, vy = (-wbPanY / wbScale - minY + pad) * s;
  const vw = (wrap.clientWidth / wbScale) * s, vh = (wrap.clientHeight / wbScale) * s;
  mm.innerHTML = wbNodes.map(n => `<div class="wb-minimap-node" style="left:${(n.x-minX+pad)*s}px;top:${(n.y-minY+pad)*s}px;width:${Math.max(2,n.w*s)}px;height:${Math.max(2,n.h*s)}px"></div>`).join('') + `<div class="wb-minimap-viewport" style="left:${vx}px;top:${vy}px;width:${vw}px;height:${vh}px"></div>`;
}

function wbNodeDown(e, id) {
  e.stopPropagation();
  if(wbTool === 'connect') return;
  wbSelected = id;
  const n = wbNodes.find(x => x.id === id);
  if(!n) return;
  if(n.locked){toast('Node is locked');return;}
  wbDrag = { id, ox: e.clientX, oy: e.clientY, sx: n.x, sy: n.y };
  wbRender();
}

function wbCanvasDown(e) {
  if(e.button === 2 || wbTool === 'hand') { wbPanning = true; wbPanStart = { x: e.clientX - wbPanX, y: e.clientY - wbPanY }; document.getElementById('wb-canvas-wrap').style.cursor = 'grabbing'; return; }
  if(wbTool === 'node') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 80, p.y - 40, 'New Node', ''); return; }
  if(wbTool === 'text') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 60, p.y - 20, 'Text', '', '#8b5cf6', 140, 50, 'text'); return; }
  if(wbTool === 'sticky') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 70, p.y - 50, '', 'Note...', STICKY_COLORS[Math.floor(Math.random()*STICKY_COLORS.length)], 160, 120, 'sticky'); return; }
  wbSelected = null; wbRender();
}

function wbCanvasMove(e) {
  if(wbPanning && wbPanStart) { wbPanX = e.clientX - wbPanStart.x; wbPanY = e.clientY - wbPanStart.y; wbUpdateTransform(); wbUpdateMinimap(); return; }
  if(wbDrag) { const n = wbNodes.find(x => x.id === wbDrag.id); if(n) { n.x = wbSnap(wbDrag.sx + (e.clientX - wbDrag.ox) / wbScale); n.y = wbSnap(wbDrag.sy + (e.clientY - wbDrag.oy) / wbScale); wbRender(); } return; }
  if(wbResizing) { const n = wbNodes.find(x => x.id === wbResizing.id); if(n) { n.w = Math.max(80, wbSnap(wbResizing.sw + (e.clientX - wbResizing.ox) / wbScale)); n.h = Math.max(40, wbSnap(wbResizing.sh + (e.clientY - wbResizing.oy) / wbScale)); wbRender(); } return; }
}

function wbCanvasUp(e) {
  if(wbDrag) { wbSaveState(); }
  if(wbResizing) { wbSaveState(); }
  if(wbPanning) { wbPersist(); }
  wbDrag = null; wbPanning = false; wbPanStart = null; wbResizing = null;
  document.getElementById('wb-canvas-wrap').style.cursor = wbTool === 'hand' ? 'grab' : wbTool === 'connect' ? 'crosshair' : wbTool === 'node' || wbTool === 'text' || wbTool === 'sticky' ? 'cell' : 'default';
}

function wbResizeStart(e, id) { const n = wbNodes.find(x => x.id === id); if(n) wbResizing = { id, ox: e.clientX, oy: e.clientY, sw: n.w, sh: n.h }; }
function wbNodeEdit(id, field, val) { const n = wbNodes.find(x => x.id === id); if(n) { n[field] = val; wbSaveState(); }}
function wbSearchNodes(q){
  const ql=q.toLowerCase().trim();
  wbNodes.forEach(n=>{n._highlight=false;});
  if(ql){
    const matches=wbNodes.filter(n=>(n.title||'').toLowerCase().includes(ql)||(n.body||'').toLowerCase().includes(ql));
    matches.forEach(n=>{n._highlight=true;});
    if(matches.length===1){const n=matches[0];const wrap=document.getElementById('wb-canvas-wrap');wbPanX=-(n.x-wrap.clientWidth/2+n.w/2)*wbScale;wbPanY=-(n.y-wrap.clientHeight/2+n.h/2)*wbScale;wbUpdateTransform();}
    toast(matches.length+' node'+(matches.length!==1?'s':'')+' found');
  }
  wbRender();
}
function wbPickColor(id){
  const n=wbNodes.find(x=>x.id===id);if(!n)return;
  const colors=['#4ade80','#22d3ee','#3b82f6','#a855f7','#f472b6','#f87171','#fbbf24','#fb923c','#6366f1','#14b8a6','#ef4444','#84cc16'];
  const el=document.createElement('div');
  el.style.cssText='position:fixed;z-index:9999;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:8px;display:grid;grid-template-columns:repeat(4,24px);gap:4px;box-shadow:0 8px 24px rgba(0,0,0,0.5)';
  el.style.left=(event.clientX-40)+'px';el.style.top=(event.clientY+10)+'px';
  colors.forEach(c=>{const b=document.createElement('div');b.style.cssText='width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid '+(n.color===c?'white':'transparent');b.style.background=c;b.onclick=()=>{n.color=c;wbSaveState();wbRender();el.remove();};el.appendChild(b);});
  document.body.appendChild(el);
  const close=e=>{if(!el.contains(e.target)){el.remove();document.removeEventListener('mousedown',close);}};
  setTimeout(()=>document.addEventListener('mousedown',close),10);
}
function wbDeleteNode(id) { wbNodes = wbNodes.filter(n => n.id !== id); wbConns = wbConns.filter(c => c.from !== id && c.to !== id); if(wbSelected === id) wbSelected = null; wbSaveState(); wbRender(); toast('Deleted'); }
function wbConnStartFn(e, id, port) { wbConnStart = { id, port }; wbTool = 'connect'; document.getElementById('wb-canvas-wrap').style.cursor = 'crosshair'; document.addEventListener('mouseup', wbConnEnd, { once: true }); }
function wbConnEnd(e) {
  if(!wbConnStart) return;
  const el = document.elementFromPoint(e.clientX, e.clientY);
  const nodeEl = el?.closest?.('.wb-node');
  if(nodeEl) {
    const toId = parseInt(nodeEl.dataset.id);
    if(toId !== wbConnStart.id && !wbConns.find(c => c.from === wbConnStart.id && c.to === toId)) {
      wbConns.push({ from: wbConnStart.id, to: toId, color: 'rgba(59,130,246,0.5)' });
      wbSaveState(); wbRender();
    }
  }
  wbConnStart = null; wbSetTool('select');
}

function wbClearAll() { if(!wbNodes.length) return; wbNodes = []; wbConns = []; wbSelected = null; wbSaveState(); wbRender(); toast('Cleared'); }
function wbFitView() {
  if(!wbNodes.length) return;
  const wrap = document.getElementById('wb-canvas-wrap');
  const minX = Math.min(...wbNodes.map(n=>n.x)), maxX = Math.max(...wbNodes.map(n=>n.x+n.w));
  const minY = Math.min(...wbNodes.map(n=>n.y)), maxY = Math.max(...wbNodes.map(n=>n.y+n.h));
  const rw = maxX - minX + 100, rh = maxY - minY + 100;
  wbScale = Math.min(wrap.clientWidth / rw, wrap.clientHeight / rh, 1.5);
  wbPanX = (wrap.clientWidth - rw * wbScale) / 2 - minX * wbScale + 50 * wbScale;
  wbPanY = (wrap.clientHeight - rh * wbScale) / 2 - minY * wbScale + 50 * wbScale;
  document.getElementById('wb-zoom-level').textContent = Math.round(wbScale * 100) + '%';
  wbUpdateTransform(); wbUpdateMinimap(); wbPersist();
}

function wbAutoLayout() {
  if(!wbNodes.length) return;
  const cols = Math.ceil(Math.sqrt(wbNodes.length));
  wbNodes.forEach((n, i) => { n.x = (i % cols) * 220 + 60; n.y = Math.floor(i / cols) * 140 + 60; });
  wbSaveState(); wbRender(); wbFitView(); toast('Auto-arranged');
}

function wbClusterByType(){
  if(!wbNodes.length)return;
  const byType={};wbNodes.forEach(n=>{const t=n.type||'note';if(!byType[t])byType[t]=[];byType[t].push(n);});
  const types=Object.keys(byType).sort();
  const cols=Math.ceil(Math.sqrt(types.length));
  const clusterW=300;const clusterH=250;const gap=60;
  types.forEach((type,ti)=>{
    const cx=(ti%cols)*(clusterW+gap)+gap;const cy=Math.floor(ti/cols)*(clusterH+gap)+gap;
    const nodes=byType[type];const innerCols=Math.ceil(Math.sqrt(nodes.length));
    nodes.forEach((n,ni)=>{n.x=cx+(ni%innerCols)*180+20;n.y=cy+Math.floor(ni/innerCols)*100+40;});
  });
  wbSaveState();wbRender();wbFitView();toast('Clustered by type ('+types.length+' groups)');
}
function wbExport(fmt) {
  if(!fmt) return;
  if(fmt === 'text') {
    let md='# Whiteboard Outline\n\n';
    const byType={};wbNodes.forEach(n=>{const t=n.type||'note';if(!byType[t])byType[t]=[];byType[t].push(n);});
    Object.entries(byType).sort().forEach(([type,nodes])=>{md+='## '+type.charAt(0).toUpperCase()+type.slice(1)+' ('+nodes.length+')\n\n';nodes.forEach(n=>{md+='- **'+n.title+'**'+(n.body?' - '+n.body:'')+'\n';});md+='\n';});
    const connText=wbConns.map(c=>{const f=wbNodes.find(n=>n.id===c.from),t=wbNodes.find(n=>n.id===c.to);return f&&t?'- '+f.title+' -> '+t.title:null;}).filter(Boolean);
    if(connText.length){md+='## Connections\n\n'+connText.join('\n')+'\n';}
    navigator.clipboard.writeText(md).then(()=>toast('Outline copied ('+wbNodes.length+' nodes)'));return;
  }
  if(fmt === 'json') { const blob = new Blob([JSON.stringify({nodes:wbNodes,conns:wbConns},null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.json'; a.click(); toast('JSON exported'); return; }
  if(fmt === 'png' || fmt === 'svg') {
    const canvas = document.createElement('canvas');
    const minX = wbNodes.length ? Math.min(...wbNodes.map(n=>n.x)) - 40 : 0;
    const minY = wbNodes.length ? Math.min(...wbNodes.map(n=>n.y)) - 40 : 0;
    const maxX = wbNodes.length ? Math.max(...wbNodes.map(n=>n.x+n.w)) + 40 : 800;
    const maxY = wbNodes.length ? Math.max(...wbNodes.map(n=>n.y+n.h)) + 40 : 600;
    const w = maxX - minX, h = maxY - minY;
    if(fmt === 'svg') {
      let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><rect width="${w}" height="${h}" fill="#0a0a0f"/>`;
      wbConns.forEach(c => { const from = wbNodes.find(n=>n.id===c.from), to = wbNodes.find(n=>n.id===c.to); if(from&&to) svg += `<line x1="${from.x+from.w/2-minX}" y1="${from.y+from.h/2-minY}" x2="${to.x+to.w/2-minX}" y2="${to.y+to.h/2-minY}" stroke="#3b82f6" stroke-width="2"/>`; });
      wbNodes.forEach(n => { svg += `<rect x="${n.x-minX}" y="${n.y-minY}" width="${n.w}" height="${n.h}" rx="6" fill="${n.type==='sticky'?n.color:'#12121a'}" stroke="#3b82f6" stroke-width="1"/><text x="${n.x-minX+10}" y="${n.y-minY+20}" fill="${n.type==='sticky'?'#1a1a24':'#fff'}" font-size="12" font-family="system-ui">${esc(n.title)}</text>`; });
      svg += '</svg>';
      const blob = new Blob([svg],{type:'image/svg+xml'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.svg'; a.click(); toast('SVG exported');
    } else {
      canvas.width = w * 2; canvas.height = h * 2;
      const ctx = canvas.getContext('2d');
      ctx.scale(2, 2); ctx.fillStyle = '#0a0a0f'; ctx.fillRect(0, 0, w, h);
      wbConns.forEach(c => { const from = wbNodes.find(n=>n.id===c.from), to = wbNodes.find(n=>n.id===c.to); if(from&&to) { ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(from.x+from.w/2-minX, from.y+from.h/2-minY); ctx.lineTo(to.x+to.w/2-minX, to.y+to.h/2-minY); ctx.stroke(); }});
      wbNodes.forEach(n => { ctx.fillStyle = n.type==='sticky'?n.color:'#12121a'; ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 1.5; const rx = 6; const nx = n.x-minX, ny = n.y-minY; ctx.beginPath(); ctx.roundRect(nx, ny, n.w, n.h, rx); ctx.fill(); ctx.stroke(); ctx.fillStyle = n.type==='sticky'?'#1a1a24':'#fff'; ctx.font = '600 12px system-ui'; ctx.fillText(n.title, nx+10, ny+22); ctx.fillStyle = n.type==='sticky'?'#333':'rgba(255,255,255,0.6)'; ctx.font = '10px system-ui'; ctx.fillText(n.body, nx+10, ny+40); });
      canvas.toBlob(blob => { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.png'; a.click(); toast('PNG exported'); });
    }
  }
}

function wbImportJSON(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const f=e.target.files[0],r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.nodes&&Array.isArray(d.nodes)){wbNodes=d.nodes;wbConns=d.conns||[];wbNodeId=Math.max(...wbNodes.map(n=>n.id||0),100)+1;wbSaveState();wbRender();wbFitView();toast('Imported '+wbNodes.length+' nodes');}else{toast('Invalid whiteboard JSON');}}catch(e){toast('Parse error: '+e.message);}};r.readAsText(f);};inp.click();
}
function wbNodeCount(){return wbNodes.length+' nodes, '+wbConns.length+' connections';}

// === TEMPLATES ===
const WB_TEMPLATES = [
  { name: 'Blank Canvas', icon: '+', desc: 'Start from scratch', nodes: [] },
  { name: 'Mind Map', icon: 'MM', desc: 'Central idea with branches', nodes: [{t:'Central Idea',b:'Main topic',x:400,y:250,c:'#3b82f6',w:180,h:80},{t:'Branch 1',b:'',x:100,y:100,c:'#8b5cf6'},{t:'Branch 2',b:'',x:700,y:100,c:'#06b6d4'},{t:'Branch 3',b:'',x:100,y:400,c:'#22c55e'},{t:'Branch 4',b:'',x:700,y:400,c:'#f97316'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: 'Eisenhower Matrix', icon: 'EM', desc: 'Urgent vs Important', nodes: [{t:'URGENT + IMPORTANT',b:'Do first',x:60,y:60,c:'#ef4444',w:280,h:200},{t:'NOT URGENT + IMPORTANT',b:'Schedule it',x:380,y:60,c:'#eab308',w:280,h:200},{t:'URGENT + NOT IMPORTANT',b:'Delegate it',x:60,y:300,c:'#f97316',w:280,h:200},{t:'NOT URGENT + NOT IMPORTANT',b:'Eliminate it',x:380,y:300,c:'#22c55e',w:280,h:200}] },
  { name: 'SWOT Analysis', icon: 'SW', desc: 'Strengths, Weaknesses, Opportunities, Threats', nodes: [{t:'STRENGTHS',b:'Internal positive',x:60,y:60,c:'#22c55e',w:280,h:200},{t:'WEAKNESSES',b:'Internal negative',x:380,y:60,c:'#ef4444',w:280,h:200},{t:'OPPORTUNITIES',b:'External positive',x:60,y:300,c:'#3b82f6',w:280,h:200},{t:'THREATS',b:'External negative',x:380,y:300,c:'#f97316',w:280,h:200}] },
  { name: 'Project Roadmap', icon: 'PR', desc: 'Timeline with milestones', nodes: [{t:'Q1 2026',b:'Foundation',x:60,y:160,c:'#3b82f6'},{t:'Q2 2026',b:'Growth',x:260,y:160,c:'#06b6d4'},{t:'Q3 2026',b:'Scale',x:460,y:160,c:'#8b5cf6'},{t:'Q4 2026',b:'Optimize',x:660,y:160,c:'#22c55e'}], conns:[[0,1],[1,2],[2,3]] },
  { name: 'Org Chart', icon: 'OC', desc: 'Organizational hierarchy', nodes: [{t:'CEO / Founder',b:'Gabo',x:300,y:40,c:'#3b82f6',w:180},{t:'Product',b:'App + Platform',x:80,y:180,c:'#8b5cf6'},{t:'Content',b:'Brand + Social',x:300,y:180,c:'#06b6d4'},{t:'Operations',b:'Finance + Legal',x:520,y:180,c:'#22c55e'},{t:'Engineering',b:'Code + Infra',x:80,y:320,c:'#f97316'},{t:'Community',b:'Coaching',x:520,y:320,c:'#ec4899'}], conns:[[0,1],[0,2],[0,3],[1,4],[3,5]] },
  { name: 'User Persona', icon: 'UP', desc: 'Customer avatar profile', nodes: [{t:'PERSONA',b:'Name, Age, Location',x:250,y:40,c:'#8b5cf6',w:200,h:80},{t:'Goals',b:'What they want to achieve',x:60,y:180,c:'#22c55e',w:200,h:100},{t:'Pain Points',b:'Frustrations and blocks',x:300,y:180,c:'#ef4444',w:200,h:100},{t:'Behaviors',b:'How they act',x:540,y:180,c:'#3b82f6',w:200,h:100},{t:'Motivations',b:'Why they buy',x:180,y:340,c:'#eab308',w:200,h:100},{t:'Channels',b:'Where they are',x:420,y:340,c:'#06b6d4',w:200,h:100}], conns:[[0,1],[0,2],[0,3],[1,4],[3,5]] },
  { name: 'Content Calendar', icon: 'CC', desc: 'Weekly content plan', nodes: [{t:'Monday',b:'Caption + Reel',x:60,y:100,c:'#3b82f6'},{t:'Tuesday',b:'Quote card',x:260,y:100,c:'#8b5cf6'},{t:'Wednesday',b:'YouTube',x:460,y:100,c:'#ef4444'},{t:'Thursday',b:'Carousel',x:60,y:240,c:'#22c55e'},{t:'Friday',b:'Story + Engagement',x:260,y:240,c:'#eab308'},{t:'Weekend',b:'Rest or batch',x:460,y:240,c:'#06b6d4'}] },
  { name: 'Product Breakdown', icon: 'PB', desc: 'Feature hierarchy', nodes: [{t:'PRODUCT',b:'Saturno Movement',x:300,y:40,c:'#3b82f6',w:180},{t:'Calisthenics',b:'Program 1',x:60,y:180,c:'#8b5cf6'},{t:'Yoga',b:'Program 2',x:280,y:180,c:'#22c55e'},{t:'Rings',b:'Program 3',x:500,y:180,c:'#f97316'},{t:'App',b:'Platform',x:280,y:320,c:'#06b6d4'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: 'Stakeholder Map', icon: 'SM', desc: 'Key relationships', nodes: [{t:'Gabo (Center)',b:'Founder',x:280,y:200,c:'#3b82f6',w:160,h:80},{t:'Customers',b:'3M+ followers',x:80,y:60,c:'#22c55e'},{t:'Victory Belt',b:'Publisher',x:480,y:60,c:'#8b5cf6'},{t:'Clients',b:'1:1 Coaching',x:80,y:360,c:'#eab308'},{t:'Community',b:'SM Academy',x:480,y:360,c:'#06b6d4'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: '5 Whys', icon: '5W', desc: 'Root cause analysis', nodes: [{t:'Problem',b:'Define the issue',x:300,y:40,c:'#ef4444',w:200},{t:'Why 1?',b:'First cause',x:300,y:140,c:'#f97316'},{t:'Why 2?',b:'Deeper cause',x:300,y:240,c:'#eab308'},{t:'Why 3?',b:'Even deeper',x:300,y:340,c:'#22c55e'},{t:'Why 4?',b:'Getting close',x:300,y:440,c:'#3b82f6'},{t:'Why 5? = Root Cause',b:'The real issue',x:300,y:540,c:'#8b5cf6',w:200}], conns:[[0,1],[1,2],[2,3],[3,4],[4,5]] },
  { name: 'Impact Mapping', icon: 'IM', desc: 'Goal to deliverables', nodes: [{t:'GOAL',b:'Revenue $50K/mo',x:40,y:200,c:'#3b82f6',w:160},{t:'Actor 1',b:'Customers',x:260,y:100,c:'#22c55e'},{t:'Actor 2',b:'Followers',x:260,y:300,c:'#8b5cf6'},{t:'Impact',b:'Subscribe monthly',x:460,y:100,c:'#eab308'},{t:'Impact',b:'Buy book',x:460,y:300,c:'#f97316'},{t:'Deliverable',b:'App + Content',x:660,y:200,c:'#06b6d4',w:160}], conns:[[0,1],[0,2],[1,3],[2,4],[3,5],[4,5]] },
  { name: 'RACI Matrix', icon: 'RA', desc: 'Responsibility assignment', nodes: [{t:'RESPONSIBLE',b:'Does the work',x:60,y:60,c:'#3b82f6',w:200,h:120},{t:'ACCOUNTABLE',b:'Owns the outcome',x:300,y:60,c:'#ef4444',w:200,h:120},{t:'CONSULTED',b:'Provides input',x:60,y:220,c:'#eab308',w:200,h:120},{t:'INFORMED',b:'Kept in the loop',x:300,y:220,c:'#22c55e',w:200,h:120}] },
  { name: 'Action Plan', icon: 'AP', desc: 'Steps with owners', nodes: [{t:'Objective',b:'What we achieve',x:280,y:40,c:'#3b82f6',w:200},{t:'Step 1',b:'Owner: | Due:',x:60,y:160,c:'#22c55e'},{t:'Step 2',b:'Owner: | Due:',x:280,y:160,c:'#8b5cf6'},{t:'Step 3',b:'Owner: | Due:',x:500,y:160,c:'#06b6d4'},{t:'Result',b:'Expected outcome',x:280,y:300,c:'#eab308',w:200}], conns:[[0,1],[0,2],[0,3],[1,4],[2,4],[3,4]] },
  { name: 'Gap Analysis', icon: 'GA', desc: 'Current vs Target state', nodes: [{t:'CURRENT STATE',b:'Where we are now',x:60,y:140,c:'#f97316',w:220,h:140},{t:'TARGET STATE',b:'Where we want to be',x:480,y:140,c:'#22c55e',w:220,h:140},{t:'GAP',b:'What needs to change',x:270,y:340,c:'#ef4444',w:220,h:100},{t:'ACTIONS',b:'How to close the gap',x:270,y:60,c:'#3b82f6',w:220,h:60}], conns:[[0,2],[1,2],[2,3]] },
  { name: 'Communication Plan', icon: 'CP', desc: 'Channels and frequency', nodes: [{t:'Instagram',b:'Daily: Captions + Reels',x:60,y:60,c:'#ec4899'},{t:'YouTube',b:'Weekly: Long-form',x:280,y:60,c:'#ef4444'},{t:'Email',b:'Bi-weekly: Newsletter',x:500,y:60,c:'#3b82f6'},{t:'Website',b:'Always: Blog + SEO',x:60,y:220,c:'#22c55e'},{t:'Community',b:'Daily: DMs + Comments',x:280,y:220,c:'#8b5cf6'},{t:'Podcast',b:'Monthly: Guest spots',x:500,y:220,c:'#eab308'}] },
  { name: 'Service Blueprint', icon: 'SB', desc: 'User journey map', nodes: [{t:'Discover',b:'Find on social',x:60,y:60,c:'#3b82f6'},{t:'Explore',b:'Visit website',x:240,y:60,c:'#06b6d4'},{t:'Sign Up',b:'Free trial / purchase',x:420,y:60,c:'#22c55e'},{t:'Onboard',b:'First workout',x:600,y:60,c:'#8b5cf6'},{t:'Engage',b:'Daily use',x:420,y:200,c:'#eab308'},{t:'Advocate',b:'Refer friends',x:600,y:200,c:'#ec4899'}], conns:[[0,1],[1,2],[2,3],[3,4],[4,5]] },
  { name: 'Priority Matrix', icon: 'PM', desc: 'Effort vs Impact', nodes: [{t:'HIGH IMPACT + LOW EFFORT',b:'Quick Wins - DO FIRST',x:60,y:60,c:'#22c55e',w:260,h:180},{t:'HIGH IMPACT + HIGH EFFORT',b:'Major Projects - PLAN',x:360,y:60,c:'#3b82f6',w:260,h:180},{t:'LOW IMPACT + LOW EFFORT',b:'Fill-ins - IF TIME',x:60,y:280,c:'#eab308',w:260,h:180},{t:'LOW IMPACT + HIGH EFFORT',b:'Thankless Tasks - SKIP',x:360,y:280,c:'#ef4444',w:260,h:180}] },
  { name: 'Flowchart', icon: 'FC', desc: 'Process flow with decisions', nodes: [{t:'START',b:'Begin process',x:280,y:40,c:'#22c55e',w:160,h:60},{t:'Step 1',b:'Action',x:280,y:140,c:'#3b82f6'},{t:'Decision?',b:'Yes or No',x:280,y:260,c:'#eab308',w:160,h:80},{t:'Path A',b:'If yes',x:80,y:380,c:'#8b5cf6'},{t:'Path B',b:'If no',x:480,y:380,c:'#f97316'},{t:'END',b:'Done',x:280,y:500,c:'#ef4444',w:160,h:60}], conns:[[0,1],[1,2],[2,3],[2,4],[3,5],[4,5]] },
  { name: 'HBS Solar System', icon: 'HB', desc: 'Handstand progression planets', nodes: [{t:'SUN: Foundation',b:'Wrist prep, shoulder mobility',x:300,y:200,c:'#eab308',w:180,h:80},{t:'MERCURY: Wall Work',b:'Chest-to-wall, back-to-wall',x:80,y:60,c:'#94a3b8'},{t:'VENUS: Kick-Up',b:'Tuck, straddle, pike entries',x:540,y:60,c:'#f97316'},{t:'EARTH: Balance',b:'Freestanding skill',x:80,y:360,c:'#3b82f6'},{t:'MARS: Shapes',b:'Tuck, straddle, pike, OA prep',x:540,y:360,c:'#ef4444'},{t:'JUPITER: Press',b:'Press to handstand',x:300,y:60,c:'#f97316'},{t:'SATURN: One-Arm',b:'Mastery territory',x:300,y:360,c:'#8b5cf6'}], conns:[[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]] },
  { name: 'Revenue Roadmap', icon: 'RR', desc: 'Revenue unlock path', nodes: [{t:'BOOK: $20K',b:'Victory Belt submission',x:60,y:160,c:'#22c55e',w:180},{t:'BF25 DELIVERY',b:'Trust + Retention',x:280,y:60,c:'#eab308'},{t:'DAILY CONTENT',b:'1 post/day visibility',x:280,y:260,c:'#3b82f6'},{t:'SM APP',b:'$37/mo subscriptions',x:500,y:160,c:'#8b5cf6',w:180},{t:'TARGET: $50-100K/mo',b:'Enterprise scale',x:720,y:160,c:'#ef4444',w:200}], conns:[[0,1],[0,2],[0,3],[1,3],[2,3],[3,4]] },
];

function openTplModal() {
  const g = document.getElementById('wb-tpl-grid');
  g.innerHTML = WB_TEMPLATES.map((t, i) => `<div class="wb-tpl-card" onclick="applyTemplate(${i})"><div class="wb-tpl-icon">${t.icon}</div><div class="wb-tpl-name">${t.name}</div><div class="wb-tpl-desc">${t.desc}</div></div>`).join('');
  document.getElementById('wb-tpl-modal').classList.add('open');
}
function closeTplModal() { document.getElementById('wb-tpl-modal').classList.remove('open'); }
function applyTemplate(idx) {
  const t = WB_TEMPLATES[idx];
  closeTplModal();
  if(t.nodes.length === 0) { wbNodes = []; wbConns = []; }
  else {
    wbNodes = t.nodes.map((n, i) => ({ id: wbNodeId + i, x: n.x || 100, y: n.y || 100, w: n.w || 160, h: n.h || 80, title: n.t || '', body: n.b || '', color: n.c || COLORS[i % COLORS.length], type: n.type || 'node' }));
    wbConns = (t.conns || []).map(c => ({ from: wbNodeId + c[0], to: wbNodeId + c[1], color: 'rgba(59,130,246,0.5)' }));
    wbNodeId += t.nodes.length + 1;
  }
  wbPanX = 0; wbPanY = 0; wbScale = 1;
  wbSaveState(); wbRender();
  setTimeout(() => wbFitView(), 50);
  toast('Template: ' + t.name);
}

// Keyboard shortcuts for whiteboard
document.addEventListener('keydown', e => {
  if(currentSection !== 'whiteboard') return;
  if(e.target.contentEditable === 'true' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  switch(e.key.toLowerCase()) {
    case 'v': wbSetTool('select'); break;
    case 'h': wbSetTool('hand'); break;
    case 'n': wbSetTool('node'); break;
    case 'c': wbSetTool('connect'); break;
    case 't': wbSetTool('text'); break;
    case 's': wbSetTool('sticky'); break;
    case 'g': wbToggleGrid(); break;
    case 'delete': case 'backspace': if(wbSelected) { wbDeleteNode(wbSelected); } break;
    case 'z': if(e.metaKey || e.ctrlKey) { e.preventDefault(); if(e.shiftKey) wbRedo(); else wbUndo(); } break;
    case '=': case '+': wbZoom(0.1); break;
    case '-': wbZoom(-0.1); break;
    case '0': wbScale = 1; wbPanX = 0; wbPanY = 0; document.getElementById('wb-zoom-level').textContent = '100%'; wbUpdateTransform(); wbUpdateMinimap(); break;
  }
});

// === SEED LINKS ===
function seedLinks() {
  if(!S.links.length) {
    S.links = [
      {id:2001,title:'Saturno Vault (Vercel)',url:'https://saturno-bonus-omega.vercel.app',category:'deployment',desc:'Primary deployment - password: saturno2025',created:new Date().toISOString()},
      {id:2002,title:'Saturno Vault Gate',url:'https://saturno-bonus-omega.vercel.app/gate.html',category:'deployment',desc:'Customer password gate for bonus vault',created:new Date().toISOString()},
      {id:2003,title:'GitHub: titan-forge',url:'https://github.com/gabosaturno11/titan-forge',category:'repo',desc:'Main vault repo (Vercel deploys from here)',created:new Date().toISOString()},
      {id:2004,title:'GitHub: victory-belt-cc',url:'https://github.com/gabosaturno11/victory-belt-cc',category:'repo',desc:'Victory Belt Command Center',created:new Date().toISOString()},
      {id:2005,title:'GitHub Pages: Titan Forge',url:'https://gabosaturno11.github.io/titan-forge/',category:'deployment',desc:'GH Pages (BROKEN - logo 404, stale gh-pages branch)',created:new Date().toISOString()},
      {id:2006,title:'Saturno Movement',url:'https://saturnomovement.com',category:'brand',desc:'Main brand site - Calisthenics/Yoga/Rings programs',created:new Date().toISOString()},
      {id:2007,title:'Google Calendar',url:'https://calendar.google.com',category:'tool',desc:'Calendar',created:new Date().toISOString()},
      {id:2008,title:'GitHub: saturno-hub',url:'https://github.com/gabosaturno11/saturno-hub',category:'repo',desc:'Saturno Hub starter',created:new Date().toISOString()},
      {id:2009,title:'Interactive TOC Editor',url:'https://gabosaturno11.github.io/interactive-toc-editor/',category:'deployment',desc:'Book TOC editor',created:new Date().toISOString()},
      {id:2010,title:'Saturno Solar System',url:'https://gabosaturno11.github.io/saturno-solar-system/',category:'deployment',desc:'Interactive solar system',created:new Date().toISOString()},
      {id:2011,title:'De Aqui a Saturno',url:'https://de-aqui-a-saturno.vercel.app',category:'deployment',desc:'Valentine\'s Day experience for Karina — Vimeo videos, piano crossfade, crystal cosmic scroll',created:new Date().toISOString()},
      {id:2012,title:'GitHub: de-aqui-a-saturno',url:'https://github.com/gabosaturno11/de-aqui-a-saturno',category:'repo',desc:'Private repo — Valentine\'s experience source',created:new Date().toISOString()},
      {id:2013,title:'ASTRA Command Center',url:'https://astra-command-center-sigma.vercel.app',category:'deployment',desc:'Endel-inspired 7-section command center',created:new Date().toISOString()},
      {id:2014,title:'GitHub: astra-command-center',url:'https://github.com/gabosaturno11/astra-command-center',category:'repo',desc:'ASTRA source repo',created:new Date().toISOString()},
      {id:2015,title:'Vimeo Developer',url:'https://developer.vimeo.com/apps',category:'tool',desc:'Vimeo API — app: ASTRA LLMs, account: admin@saturnomovement.com',created:new Date().toISOString()},
      {id:2016,title:'Saturno Bonus (Vercel)',url:'https://saturno-bonus-omega.vercel.app',category:'deployment',desc:'Customer bonus page — decoupled from titan-forge',created:new Date().toISOString()},
      {id:2017,title:'GitHub: saturno-bonus',url:'https://github.com/gabosaturno11/saturno-bonus',category:'repo',desc:'Private repo — clean bonus-only repo with bonuses/ folder',created:new Date().toISOString()},
      {id:2018,title:'SATURNO COMMAND',url:'https://saturno-bonus-omega.vercel.app/command',category:'deployment',desc:'Admin dashboard — tool toggles, config API',created:new Date().toISOString()},
      {id:2019,title:'Cloudflare Dashboard',url:'https://dash.cloudflare.com/',category:'tool',desc:'DNS management — admin@saturnomovement.com, 2FA enabled',created:new Date().toISOString()},
      {id:2020,title:'Stripe Dashboard',url:'https://dashboard.stripe.com/',category:'tool',desc:'Payment management — 2FA + authenticator',created:new Date().toISOString()},
      {id:2021,title:'GitHub: sm-app-copy-v1',url:'https://github.com/gabosaturno11/sm-app-copy-v1',category:'repo',desc:'Clone of Saturno Movement app codebase (from Softzee)',created:new Date().toISOString()},
    ];
  }
}

// === FOLDER SYSTEM ===
function getFolders() { return S.folders || []; }
function addFolder(name, parentId) {
  if(!S.folders) S.folders = [];
  const f = { id: 'folder_' + Date.now(), name: name || 'New Folder', parentId: parentId || null, created: new Date().toISOString() };
  S.folders.push(f);
  save();
  return f;
}
function deleteFolder(id) {
  S.folders = (S.folders||[]).filter(f => f.id !== id);
  // Unassign items from deleted folder
  S.content.forEach(c => { if(c.folderId === id) c.folderId = null; });
  S.tasks.forEach(t => { if(t.folderId === id) t.folderId = null; });
  S.docs.forEach(d => { if(d.folderId === id) d.folderId = null; });
  S.specs.forEach(s => { if(s.folderId === id) s.folderId = null; });
  S.links.forEach(l => { if(l.folderId === id) l.folderId = null; });
  save();
}
function renameFolder(id, name) {
  const f = (S.folders||[]).find(x => x.id === id);
  if(f) { f.name = name; save(); }
}
function moveToFolder(itemType, itemId, folderId) {
  const collections = { content: S.content, tasks: S.tasks, docs: S.docs, specs: S.specs, links: S.links };
  const col = collections[itemType];
  if(!col) return;
  const item = col.find(x => x.id === itemId || x.id == itemId);
  if(item) { item.folderId = folderId; save(); toast('Moved to folder'); }
}

// === FOLDER TREE UI ===
let activeFolderId = null;
function renderFolderTree() {
  const el = document.getElementById('sidebar-folder-tree');
  if(!el) return;
  const folders = getFolders();
  if(!folders.length) {
    el.innerHTML = '<div style="font-size:10px;color:var(--text-muted);padding:4px 8px">No folders yet</div>';
    return;
  }
  const rootFolders = folders.filter(f => !f.parentId);
  el.innerHTML = renderFolderLevel(rootFolders, folders, 0);
}
function renderFolderLevel(items, all, depth) {
  return items.map(f => {
    const children = all.filter(c => c.parentId === f.id);
    const count = countFolderItems(f.id);
    const isActive = activeFolderId === f.id;
    const indent = depth * 12;
    let html = `<div class="folder-item ${isActive ? 'active' : ''}" style="padding-left:${8 + indent}px" onclick="selectFolder('${f.id}')" oncontextmenu="event.preventDefault();folderContextMenu(event,'${f.id}')" ondragover="event.preventDefault();this.style.background='var(--accent-glow)'" ondragleave="this.style.background=''" ondrop="event.preventDefault();this.style.background='';folderDrop(event,'${f.id}')">`;
    html += `<span class="folder-item-icon">${children.length ? (isActive ? 'v' : '>') : '-'}</span>`;
    html += `<span class="folder-item-name">${esc(f.name)}</span>`;
    if(count > 0) html += `<span class="folder-item-count">${count}</span>`;
    html += '</div>';
    if(children.length && isActive) {
      html += renderFolderLevel(children, all, depth + 1);
    }
    return html;
  }).join('');
}
function countFolderItems(folderId) {
  let count = 0;
  S.content.forEach(c => { if(c.folderId === folderId) count++; });
  S.tasks.forEach(t => { if(t.folderId === folderId) count++; });
  S.docs.forEach(d => { if(d.folderId === folderId) count++; });
  S.specs.forEach(s => { if(s.folderId === folderId) count++; });
  S.links.forEach(l => { if(l.folderId === folderId) count++; });
  return count;
}
function selectFolder(id) {
  activeFolderId = activeFolderId === id ? null : id;
  renderFolderTree();
}
function addFolderFromSidebar() {
  const name = prompt('Folder name:');
  if(!name || !name.trim()) return;
  addFolder(name.trim());
  renderFolderTree();
  toast('Folder created');
}
function folderDrop(event, folderId) {
  const data = event.dataTransfer.getData('text/plain');
  if(!data) return;
  try {
    const { type, id } = JSON.parse(data);
    if(type && id) { moveToFolder(type, id, folderId); renderFolderTree(); }
  } catch(e) {}
}
function folderContextMenu(event, id) {
  const action = prompt('Folder action: (r)ename, (d)elete, (s)ub-folder');
  if(!action) return;
  const a = action.toLowerCase().trim();
  if(a === 'r' || a === 'rename') {
    const f = (S.folders||[]).find(x => x.id === id);
    const name = prompt('New name:', f ? f.name : '');
    if(name && name.trim()) { renameFolder(id, name.trim()); renderFolderTree(); toast('Renamed'); }
  } else if(a === 'd' || a === 'delete') {
    deleteFolder(id); activeFolderId = null; renderFolderTree(); toast('Folder deleted');
  } else if(a === 's' || a === 'sub-folder') {
    const name = prompt('Sub-folder name:');
    if(name && name.trim()) { addFolder(name.trim(), id); renderFolderTree(); toast('Sub-folder created'); }
  }
}

// === MINI KNOWLEDGE GRAPH ===
let graphNodes = [], graphEdges = [], graphAnimId = null;
function buildGraph() {
  graphNodes = []; graphEdges = [];
  const colors = { project: '#4ade80', doc: '#22d3ee', spec: '#a78bfa', task: '#fbbf24', kb: '#fb923c' };
  // Add project nodes
  (S.projects||[]).forEach(p => {
    graphNodes.push({ id: 'p_'+p.id, label: p.name, type: 'project', color: colors.project, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Add doc nodes
  S.docs.forEach(d => {
    graphNodes.push({ id: 'd_'+d.id, label: d.title||'Untitled', type: 'doc', color: colors.doc, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Add spec nodes
  S.specs.forEach(s => {
    graphNodes.push({ id: 's_'+s.id, label: s.title||'Untitled', type: 'spec', color: colors.spec, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Build edges from wiki-links
  S.docs.forEach(d => {
    if(!d.body) return;
    const links = d.body.match(/\[\[([^\]]+)\]\]/g)||[];
    links.forEach(m => {
      const name = m.slice(2,-2).trim();
      const target = findLinkedItem(name);
      if(target) {
        const srcId = 'd_'+d.id;
        let tgtId = '';
        if(target.type==='project') tgtId='p_'+target.id;
        else if(target.type==='doc') tgtId='d_'+target.id;
        else if(target.type==='spec') tgtId='s_'+target.id;
        if(tgtId && graphNodes.find(n=>n.id===tgtId)) graphEdges.push({from:srcId,to:tgtId});
      }
    });
  });
  S.specs.forEach(s => {
    (s.sections||[]).forEach(sec => {
      if(!sec.body) return;
      const links = sec.body.match(/\[\[([^\]]+)\]\]/g)||[];
      links.forEach(m => {
        const name = m.slice(2,-2).trim();
        const target = findLinkedItem(name);
        if(target) {
          const srcId = 's_'+s.id;
          let tgtId = '';
          if(target.type==='project') tgtId='p_'+target.id;
          else if(target.type==='doc') tgtId='d_'+target.id;
          else if(target.type==='spec') tgtId='s_'+target.id;
          if(tgtId && graphNodes.find(n=>n.id===tgtId)) graphEdges.push({from:srcId,to:tgtId});
        }
      });
    });
  });
  // Connect KB items to their projects
  (S.knowledgeBase||[]).forEach(k => {
    if(k.projectId) {
      const projNode = graphNodes.find(n=>n.id==='p_'+k.projectId);
      if(projNode) {
        graphNodes.push({ id: 'k_'+k.id, label: k.name, type: 'kb', color: colors.kb, x: projNode.x+Math.random()*40-20, y: projNode.y+Math.random()*40-20, vx:0, vy:0 });
        graphEdges.push({from:'p_'+k.projectId,to:'k_'+k.id});
      }
    }
  });
  // Limit to max 30 nodes for performance
  if(graphNodes.length > 30) graphNodes = graphNodes.slice(0, 30);
}
function renderGraph() {
  const canvas = document.getElementById('ctx-graph-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  buildGraph();
  if(!graphNodes.length) {
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Add items + [[links]] to see connections', w/2, h/2);
    return;
  }
  let steps = 80;
  function simulate() {
    const k = 0.01, repulsion = 800, damping = 0.85;
    graphNodes.forEach(n => { n.vx = 0; n.vy = 0; });
    // Repulsion
    for(let i=0;i<graphNodes.length;i++) {
      for(let j=i+1;j<graphNodes.length;j++) {
        let dx=graphNodes[j].x-graphNodes[i].x, dy=graphNodes[j].y-graphNodes[i].y;
        let dist=Math.sqrt(dx*dx+dy*dy)+1;
        let f=repulsion/(dist*dist);
        graphNodes[i].vx -= dx/dist*f; graphNodes[i].vy -= dy/dist*f;
        graphNodes[j].vx += dx/dist*f; graphNodes[j].vy += dy/dist*f;
      }
    }
    // Attraction along edges
    graphEdges.forEach(e => {
      const a=graphNodes.find(n=>n.id===e.from), b=graphNodes.find(n=>n.id===e.to);
      if(!a||!b) return;
      let dx=b.x-a.x, dy=b.y-a.y, dist=Math.sqrt(dx*dx+dy*dy)+1;
      let f=dist*k;
      a.vx += dx*f; a.vy += dy*f;
      b.vx -= dx*f; b.vy -= dy*f;
    });
    // Center gravity
    graphNodes.forEach(n => {
      n.vx += (w/2-n.x)*0.002;
      n.vy += (h/2-n.y)*0.002;
      n.vx *= damping; n.vy *= damping;
      n.x += n.vx; n.y += n.vy;
      n.x = Math.max(10, Math.min(w-10, n.x));
      n.y = Math.max(10, Math.min(h-10, n.y));
    });
  }
  for(let i=0;i<steps;i++) simulate();
  // Draw
  ctx.clearRect(0,0,w,h);
  // Edges
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  graphEdges.forEach(e => {
    const a=graphNodes.find(n=>n.id===e.from), b=graphNodes.find(n=>n.id===e.to);
    if(!a||!b) return;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  });
  // Nodes
  graphNodes.forEach(n => {
    const r = n.type==='project' ? 5 : 3;
    ctx.beginPath(); ctx.arc(n.x,n.y,r,0,Math.PI*2);
    ctx.fillStyle = n.color; ctx.globalAlpha = 0.7; ctx.fill(); ctx.globalAlpha = 1;
    // Label
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.font = '8px system-ui';
    ctx.textAlign = 'center';
    const label = n.label.length > 12 ? n.label.slice(0,11) + '..' : n.label;
    ctx.fillText(label, n.x, n.y - r - 3);
  });
}

// === CROSS-LINKING [[wiki-links]] ===
function parseWikiLinks(html) {
  if(!html) return html;
  return html.replace(/\[\[([^\]]+)\]\]/g, (match, linkText) => {
    const target = findLinkedItem(linkText.trim());
    if(target) {
      return `<span class="wiki-link" onclick="navigateToItem('${target.type}','${target.id}')" title="${esc(target.desc)}" style="color:var(--accent);cursor:pointer;border-bottom:1px dashed var(--accent);padding-bottom:1px">${esc(linkText)}</span>`;
    }
    return `<span class="wiki-link-broken" style="color:var(--red);cursor:help;border-bottom:1px dashed var(--red)" title="Not found: ${esc(linkText)}">${esc(linkText)}</span>`;
  }).replace(/(https?:\/\/[^\s<>"]+)/g,'<a href="$1" target="_blank" rel="noopener" style="color:var(--accent-cyan);text-decoration:none;border-bottom:1px dashed var(--accent-cyan)" onclick="event.stopPropagation()">$1</a>');
}
function findLinkedItem(name) {
  const nl = name.toLowerCase();
  // Search projects
  const proj = (S.projects||[]).find(p => p.name.toLowerCase() === nl);
  if(proj) return { type: 'project', id: proj.id, desc: 'Project: ' + proj.name };
  // Search docs
  const doc = S.docs.find(d => d.title && d.title.toLowerCase() === nl);
  if(doc) return { type: 'doc', id: doc.id, desc: 'Document: ' + doc.title };
  // Search specs
  const spec = S.specs.find(s => s.title && s.title.toLowerCase() === nl);
  if(spec) return { type: 'spec', id: spec.id, desc: 'Living Doc: ' + spec.title };
  // Search KB items
  const kb = (S.knowledgeBase||[]).find(k => k.name && k.name.toLowerCase() === nl);
  if(kb) return { type: 'kb', id: kb.id, desc: 'KB: ' + kb.name };
  // Search tasks
  const task = S.tasks.find(t => t.title && t.title.toLowerCase() === nl);
  if(task) return { type: 'task', id: task.id, desc: 'Task: ' + task.title };
  return null;
}
function navigateToItem(type, id) {
  if(type === 'project') { openProject(id); }
  else if(type === 'doc') { switchDoc(parseInt(id) || id); switchSection('writer', null); }
  else if(type === 'spec') { switchSpec(parseInt(id) || id); switchSection('specs', null); }
  else if(type === 'kb') { openKBViewer(id); }
  else if(type === 'task') { switchSection('tasks', null); toast('Task: ' + (S.tasks.find(t => t.id == id)?.title || '')); }
}
function getBacklinks(itemType, itemName) {
  const nl = '[[' + itemName + ']]';
  const results = [];
  S.docs.forEach(d => { if(d.body && d.body.includes(nl)) results.push({ type: 'doc', title: d.title || 'Untitled', id: d.id }); });
  S.specs.forEach(s => {
    (s.sections || []).forEach(sec => {
      if(sec.body && sec.body.includes(nl)) results.push({ type: 'spec', title: s.title + ' > ' + sec.title, id: s.id });
    });
  });
  (S.projects||[]).forEach(p => {
    if(p.instructions && p.instructions.includes(nl)) results.push({ type: 'project', title: p.name, id: p.id });
  });
  return results;
}

// === COMMAND PALETTE ===
let cmdIdx = 0;
function openCommandPalette() {
  document.getElementById('cmd-overlay').classList.add('open');
  const inp = document.getElementById('cmd-input');
  inp.value = '';
  cmdIdx = 0;
  cmdSearch();
  setTimeout(() => inp.focus(), 50);
}
function closeCommandPalette() {
  document.getElementById('cmd-overlay').classList.remove('open');
}
function cmdGetItems(q) {
  const items = [];
  const ql = (q || '').toLowerCase();
  // Help prefix — list all available Cmd+K prefixes
  if(ql && (ql==='help'||ql==='help:'||ql==='?'||ql==='prefixes')){
    const prefixes=[
      ['task: ...','Quick-create task inline'],['note: ...','Quick-save content inline'],
      ['find: keyword','Cross-section search with counts'],['focus:','Show P0/P1 + overdue tasks'],
      ['week:','Upcoming 7 days task breakdown'],['daily:','Today activity summary'],
      ['streak:','Completion streak + 7-day activity'],['timeline:','Chronological task overview'],
      ['matrix:','Priority x status breakdown'],['template:','Create task from templates'],
      ['compare:p1:p2','Compare two projects side-by-side'],['merge: keyword','Find + merge duplicate tasks'],
      ['rename:old:new','Rename projects/tags globally'],['orphan:','Find disconnected items'],
      ['health:','System diagnostics + issues'],['backup:','Data size + export actions'],
      ['clean:','Cleanup empty tasks, dup links, etc'],['dup: keyword','Find + duplicate tasks'],
      ['tag-tasks:','Browse tasks by tag'],['project-stats:','Per-project analytics'],
      ['export:','All export options'],['standup','Daily standup summary'],
      ['search: keyword','Deep search across ALL sections'],['find: keyword','Alias for search:'],
      ['history:','Recent activity across all sections'],
      ['digest','Daily briefing + overdue + progress'],['goals:','Track daily + weekly goals'],
      ['streak','Activity streak + weekly heatmap'],['heatmap','90-day activity heatmap popup'],
      ['deps','Task dependency chain visualization'],['accent','Change accent color (8 presets)'],
      ['pomodoro','Focus session stats + start timer'],['collections','Auto-detect content groups'],
      ['scratch','Persistent floating scratchpad'],['review','Weekly review + copy markdown'],
      ['workspace','Full workspace stats overview'],
      ['chart','SVG charts: status pie, priority bars, themes, weekly'],
      ['plan','7-day task plan with quick-add'],['bookmarks','Import browser bookmarks HTML'],
      ['burndown','14-day task burndown chart (created vs completed)'],
      ['deadlinks','Check all links for broken URLs'],
      ['notifications','Enable desktop notifications for overdue tasks'],
      ['timeline','Activity timeline across all sections'],
      ['backup','Schedule auto-backup (JSON download)'],
      ['restore','Import JSON backup to restore data'],
      ['export docs','Export all writer docs as single markdown'],
      ['roadmap','Project roadmap timeline view'],
      ['journal','Open/create today\'s journal entry'],
      ['writing','Writing stats and daily word streak'],
      ['cleanup','Find orphans, dupes, and empty items'],
      ['report','Monthly productivity report'],
      ['stickies','Floating sticky notes on workspace'],
      ['gantt','Task Gantt chart (horizontal timeline)'],
      ['related','Find related/similar content'],
      ['reading','Link reading list (read-later queue)'],
      ['habits','Daily habit tracker with streak grid'],
      ['table','Task table/spreadsheet view'],
      ['project health','Per-project health dashboard'],
      ['random','Surface a random content item for review'],
      ['clips','Clipboard history manager'],
      ['project template','Create project from template with tasks'],
      ['compare','Side-by-side content comparison'],
      ['time block','Add time blocks to calendar'],
      ['transform','Text transform tools (uppercase, lowercase, title case)'],
      ['archive url','View link on Wayback Machine'],
      ['dashboard','Show home dashboard with widgets'],
      ['settings','App preferences and configuration'],
      ['impact','Task impact-effort matrix (2x2)'],
      ['export content','Export all content as markdown'],
      ['focus stats','Focus/Pomodoro session history and stats'],
      ['eisenhower','Urgent vs Important task matrix (4 quadrants)'],
      ['content calendar','Calendar view of content creation dates'],
      ['snippets','Save and reuse text snippets'],
      ['heatmap full','365-day GitHub-style activity heatmap'],
      ['link dashboard','Link stats: domains, categories, counts'],
      ['dependencies','Task dependency chains and blocked items'],
      ['weekly review','Comprehensive 7-day review with markdown export'],
      ['pomo history','Pomodoro session history by task and date'],
      ['tag cloud','Visual tag cloud sized by frequency'],
      ['priority grid','Quick priority reassignment for active tasks'],
      ['content timeline','Chronological timeline of all content items'],
      ['velocity','12-week task velocity line chart'],
      ['quick note','Toggle floating quick-note capture button'],
      ['bookmarklets','Generate bookmarklets for capturing to ASTRA'],
      ['workspace search','Deep search across all sections with results'],
      ['batch edit','Edit multiple tasks at once (priority, status, project)'],
      ['content stats','Content analytics: types, themes, tags, word counts'],
      ['swimlane','Kanban by project (project x status grid)'],
      ['daily planner','Today\'s schedule with time slots and tasks'],
      ['export workspace','Download full ASTRA workspace as JSON'],
      ['quick actions','Floating action bar with most-used functions'],
      ['due heatmap','Calendar heatmap of task due dates (load per day)'],
      ['writing goals','Set and track daily/weekly word count goals'],
      ['project compare','Side-by-side comparison of two projects'],
      ['task aging','Find stale/aging tasks that need attention'],
      ['import links md','Import links from pasted markdown text'],
      ['ambient','Ambient sounds for focus sessions'],
      ['word frequency','Most common words across content and docs'],
      ['priority board','Kanban board grouped by priority level'],
      ['wip limits','Configure WIP limits per board column'],
      ['duplicates','Find duplicate content with similarity scoring'],
      ['export csv','Export all tasks as CSV spreadsheet'],
      ['inbox','View unsorted/uncategorized items across all sections'],
      ['session','Show current ASTRA session time'],
      ['undo','Undo last destructive action (delete task/content/link)'],
      ['favorites','Quick access to starred and pinned items'],
      ['due groups','Tasks grouped: Overdue/Today/Tomorrow/Week/Later'],
      ['convert','Convert content to task or task to content'],
      ['deep focus','Full-screen dimming overlay for distraction-free work'],
      ['estimation','Compare estimated vs actual time on tasks'],
      ['data tools','Manage/clear data by section, factory reset'],
      ['theme','Switch between dark theme variants'],
      ['status email','Generate weekly status email (copies to clipboard)'],
      ['morning','Morning briefing panel with daily overview'],
      ['shortcuts','Visual keyboard shortcut cheatsheet'],
      ['streak','Daily usage streak tracker'],
      ['content templates','Pre-built templates for notes, meetings, journals'],
      ['link checker','Check if saved links are still reachable'],
      ['reading progress','Track read/unread status of content items'],
      ['project timeline','Visual timeline of project milestones'],
      ['math','Quick calculator - type math: expression'],
      ['focus score','Daily productivity score based on activity'],
      ['archive','Browse and restore archived tasks'],
      ['word cloud','Visual word cloud from all content'],
      ['habits','Daily habit tracker with streaks'],
      ['knowledge graph','Wiki-link stats and most referenced items'],
      ['random','Resurface random content for review'],
      ['clipboard','View clipboard history within ASTRA'],
      ['world clock','Time zones: Local, NY, London, Tokyo, Sydney, Dubai'],
      ['diff','Compare two content items side by side'],
      ['backup','Download or restore workspace backup'],
      ['burnup','Cumulative task burnup chart (12 weeks)'],
      ['content metrics','Readability, vocabulary, sentence analysis'],
      ['markdown','Preview content as rendered markdown'],
      ['completion heatmap','GitHub-style heatmap of task completions'],
      ['saved searches','Save and recall frequent Cmd+K queries'],
      ['stale','Find content items older than 30 days'],
      ['timer:','Start countdown timer (e.g. timer: 10 for 10 min)'],
      ['project health','Health scores for all projects'],
      ['matrix','4-quadrant task priority matrix'],
      ['bookmarks','Quick-access content bookmarks'],
      ['system status','ASTRA system stats, storage, session info'],
      ['auto tag','Suggest tags for untagged content'],
      ['sprint','Sprint view: tasks grouped by week'],
      ['color legend','What all colors mean across ASTRA'],
      ['daily digest','Generate comprehensive daily summary'],
      ['content archive','Archive and restore old content'],
      ['changelog','View workspace change log for this session'],
      ['focus config','Configure focus mode: duration, breaks, blocked sections'],
      ['action items','Extract TODO/ACTION items from content as tasks'],
      ['weekly planner','Week-at-a-glance task planner'],
      ['switch project','Quick switch between projects'],
      ['task chains','View task dependency chains'],
      ['themes','Content theme breakdown with bar chart'],
      ['multi project','Dashboard across all projects'],
      ['export themes','Export content grouped by theme to clipboard'],
      ['global search','Dedicated search panel across all sections'],
      ['notifications','Overdue, WIP, streak, and storage alerts'],
      ['stats history','Daily stats tracked over time (90 days)'],
      ['board filters','Filter kanban by priority, project, due date'],
      ['scratchpad','Quick persistent notepad'],
      ['print export','Downloadable printable HTML export'],
      ['slides','Convert content to presentation slides'],
      ['workload','14-day task workload forecast'],
      ['gratitude','Daily gratitude journal with streak'],
      ['task templates','8 task templates: bug fix, feature, research, etc.'],
      ['lifetime focus','Lifetime Pomodoro/focus statistics'],
      ['creation calendar','Month grid showing when content was created'],
      ['suggestions','Smart next-action suggestions based on current state'],
      ['link categories','Visual breakdown of link categories'],
      ['priority distribution','Bar chart of task priority levels'],
      ['mood','Daily mood tracker with trend chart'],
      ['repo timeline','Overview of all repos with status'],
      ['micro journal','Quick daily one-liner journal'],
      ['completion rate','Weekly task completion rate chart'],
      ['export book','Export all content as markdown book'],
      ['overview','Full workspace overview dashboard'],
      ['sentiment','Content sentiment analysis (positive/negative)'],
      ['project completion','Project completion % timeline bars'],
      ['content calendar','Month calendar of content creation dates'],
      ['velocity','Task velocity: completed vs created per week (8 weeks)'],
      ['tag cloud','Visual tag cloud from all content, tasks, and links'],
      ['due calendar','Month calendar of task due dates with overdue highlights'],
      ['productivity','Weekly productivity insights with trends and tips'],
      ['category breakdown','Stacked bar of content categories with legend'],
      ['recent activity','Unified activity feed across all sections'],
      ['quick note','Floating quick note saver (saves to content)'],
      ['writer stats','Writer statistics: docs, words, pages, versions'],
      ['link domains','Link domain breakdown with frequency bars'],
      ['time report','Detailed time tracking report by project and task'],
      ['content timeline','Vertical timeline of content creation history'],
      ['goals','Set and track weekly/monthly goals with progress bars'],
      ['quick task','Floating quick task creator with priority and due date'],
      ['data explorer','Browse raw workspace state data in tree view'],
      ['project comparison','Side-by-side project comparison table'],
      ['weekly review','Comprehensive weekly review generator (copy to clipboard)'],
      ['achievements','Gamified milestones: tasks, words, content, streaks'],
      ['focus history','History of all Pomodoro/focus sessions with 14-day chart'],
      ['quick link','Floating quick link saver with category'],
      ['storage','Visual localStorage breakdown with usage % bar'],
      ['task aging','Tasks ranked by age: fresh, stale, ancient'],
      ['word frequency','Top 30 words across all content (stop words excluded)'],
      ['daily planner','Today time blocks: morning, afternoon, evening'],
      ['content length','Content items by word count: tiny to epic'],
      ['project notes','Quick persistent notes per project'],
      ['duplicates','Find duplicate content and tasks by title similarity'],
      ['universal search','Search everything with live results panel'],
      ['eisenhower','2x2 Urgent/Important matrix for task prioritization'],
      ['writer progress','Word count targets per doc with progress bars'],
      ['batch ops','Bulk operations: tag all, rename category, archive done'],
      ['context','Switch workspace context: all, work, personal, creative'],
      ['daily checklist','Recurring daily checklist that resets each morning'],
      ['knowledge map','Map of [[wiki-link]] connections between content'],
      ['export hub','All-in-one export: JSON, CSV, Markdown, HTML'],
      ['dependencies','Visual task dependency graph (blocking/blocked)'],
      ['inbox zero','Triage panel for uncategorized/incomplete items'],
      ['reading list','Read/unread tracking for saved links'],
      ['project status','Status board for all projects (on-track, at-risk, blocked)'],
      ['dashboard','ASTRA dashboard with stats, overdue, quick actions'],
      ['captures','Summary of quick captures by type'],
      ['notes explorer','Tree-view content browser organized by category'],
      ['deadlines','Countdown tracker for upcoming task deadlines'],
      ['content graph','30-day line chart of content creation and word count'],
      ['advanced search','Search with filters: type, date range'],
      ['quote','Random motivational quote (15 curated quotes)'],
      ['accent color','Change ASTRA accent color (12 options)'],
      ['session log','Log what you worked on with timestamps'],
      ['recent edits','Most recently edited items across all sections'],
      ['doc outline','Document headings/outlines from writer docs'],
      ['backlog','Backlog groomer: prioritize and schedule unassigned tasks'],
    ];
    items.unshift({title:'Cmd+K Prefixes ('+prefixes.length+')',desc:'Type any prefix to activate',icon:'?',type:'info'});
    prefixes.forEach(([name,desc])=>{items.push({title:name,desc,icon:'>',type:'info'});});
    return items;
  }
  // Recent items (show when no query)
  if(!ql && recentItems.length) {
    recentItems.forEach(r => {
      items.push({title:r.title, desc:'Recent - '+r.type, icon:'*', type:'recent', action:()=>navigateToItem(r.type, r.id)});
    });
  }
  // Sections
  const sections = [
    {title:'Content',desc:'Content vault',icon:'C',action:()=>switchSection('content',document.querySelector('.sidebar-item'))},
    {title:'Tasks',desc:'Task manager',icon:'T',action:()=>switchSection('tasks',null)},
    {title:'Calendar',desc:'Calendar view',icon:'D',action:()=>switchSection('calendar',null)},
    {title:'Writing Hub',desc:'Document editor',icon:'W',action:()=>switchSection('writer',null)},
    {title:'Living Docs',desc:'Structured documents',icon:'S',action:()=>switchSection('specs',null)},
    {title:'Links',desc:'Link directory',icon:'L',action:()=>switchSection('links',null)},
    {title:'Whiteboard',desc:'Visual canvas',icon:'B',action:()=>switchSection('whiteboard',null)},
    {title:'Pipeline',desc:'Audio/text processing pipeline',icon:'P',action:()=>switchSection('pipeline',null)},
    {title:'Repos',desc:'Connected repositories',icon:'R',action:()=>switchSection('repos',null)},
  ];
  sections.forEach(s => {
    if(!ql || s.title.toLowerCase().includes(ql) || s.desc.toLowerCase().includes(ql))
      items.push({...s, type:'section'});
  });
  // Projects
  (S.projects||[]).forEach(p => {
    if(!ql || p.name.toLowerCase().includes(ql))
      items.push({title:p.name, desc:'Project - '+p.status, icon:p.icon?getIconSVG(p.icon,14):'P', type:'project', action:()=>openProject(p.id)});
  });
  // Tasks
  S.tasks.forEach(t => {
    if(t.title && (!ql || t.title.toLowerCase().includes(ql) || (t.description||'').toLowerCase().includes(ql)))
      items.push({title:t.title, desc:t.status+' - '+(t.project||'No project')+(t.description?' - '+t.description.substring(0,40):''), icon:'T', type:'task', action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
  });
  // Docs
  S.docs.forEach(d => {
    if(d.title && (!ql || d.title.toLowerCase().includes(ql)))
      items.push({title:d.title, desc:'Document', icon:'W', type:'doc', action:()=>{switchDoc(d.id);switchSection('writer',null);}});
  });
  // Living Docs
  S.specs.forEach(s => {
    if(s.title && (!ql || s.title.toLowerCase().includes(ql))){
      const specW=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);
      items.push({title:s.title, desc:'Living Doc - '+(s.sections?s.sections.length:0)+' sections, '+specW+'w', icon:'S', type:'spec', action:()=>{switchSpec(s.id);switchSection('specs',null);}});
    }
  });
  // KB Items
  (S.knowledgeBase||[]).forEach(k => {
    if(k.name && (!ql || k.name.toLowerCase().includes(ql)))
      items.push({title:k.name, desc:'KB - '+k.type, icon:'K', type:'kb', action:()=>{const proj = (S.projects||[]).find(p=>p.id===k.projectId); if(proj){openProject(proj.id);setProjTab('kb');} openKBViewer(k.id);}});
  });
  // Content (search body text)
  if(ql) {
    S.content.filter(c=>c.body.toLowerCase().includes(ql)).slice(0,5).forEach(c => {
      items.push({title:c.body.substring(0,60)+(c.body.length>60?'...':''), desc:'Content - '+c.type+(c.theme?' / '+c.theme:''), icon:'C', type:'content', action:()=>{switchSection('content',null);document.getElementById('content-search').value=ql;renderContent();}});
    });
  }
  // Links
  S.links.forEach(l => {
    if(l.title && (!ql || l.title.toLowerCase().includes(ql) || l.url.toLowerCase().includes(ql)))
      items.push({title:l.title, desc:l.url, icon:'L', type:'link', action:()=>window.open(l.url,'_blank')});
  });
  // Actions
  if(!ql || 'new task'.includes(ql)) items.push({title:'New Task', desc:'Create a new task', icon:'+', type:'action', action:addTask});
  if(!ql || 'new document'.includes(ql)) items.push({title:'New Document', desc:'Create a new document', icon:'+', type:'action', action:newDoc});
  if(!ql || 'new project'.includes(ql)) items.push({title:'New Project', desc:'Create a new project', icon:'+', type:'action', action:openNewProjectModal});
  if(!ql || 'export'.includes(ql)) items.push({title:'Export All', desc:'Export all data as JSON', icon:'E', type:'action', action:exportAll});
  if(!ql || 'stats storage data'.includes(ql)) items.push({title:'Data Stats', desc:'Show storage breakdown by section', icon:'#', type:'action', action:()=>{closeCommandPalette();dataStats();}});
  if(!ql || 'focus timer'.includes(ql)) items.push({title:'Focus Timer', desc:'Open focus timer in context panel', icon:'FT', type:'action', action:()=>{if(!document.querySelector('.app').classList.contains('context-open'))toggleContextPanel();}});
  if(!ql || 'quick capture'.includes(ql)) items.push({title:'Quick Capture', desc:'Add task/content instantly (Cmd+Shift+N)', icon:'+', type:'action', action:()=>{closeCommandPalette();qcOpen();}});
  if(!ql || 'today'.includes(ql)) items.push({title:'Today View', desc:'See tasks due today + overdue', icon:'*', type:'action', action:()=>{closeCommandPalette();showTodayView();}});
  if(!ql || 'standup daily'.includes(ql)) items.push({title:'Daily Standup', desc:'Copy standup summary to clipboard', icon:'S', type:'action', action:()=>{closeCommandPalette();generateStandup();}});
  if(!ql || 'export content'.includes(ql)) items.push({title:'Export Content', desc:'Copy all content as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportContent();}});
  if(!ql || 'export content html download'.includes(ql)) items.push({title:'Export Content as HTML', desc:'Download all content as styled HTML file', icon:'E', type:'action', action:()=>{closeCommandPalette();exportContentHTML();}});
  if(!ql || 'export tasks'.includes(ql)) items.push({title:'Export Tasks', desc:'Copy filtered tasks as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportTasks();}});
  if(!ql || 'import data json restore'.includes(ql)) items.push({title:'Import Data (JSON)', desc:'Restore from exported JSON backup', icon:'I', type:'action', action:()=>{closeCommandPalette();const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(!d.tasks&&!d.content){toast('Invalid backup file');return;}if(!confirm('Replace all data with this backup? ('+Object.keys(d).length+' sections)'))return;Object.assign(S,d);save();location.reload();}catch(err){toast('Error: '+err.message);}};r.readAsText(f);};i.click();}});
  if(!ql || 'export docs documents writer'.includes(ql)) items.push({title:'Export All Docs', desc:'Copy all writer documents as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportAllDocs();}});
  if(!ql || 'export docs html download'.includes(ql)) items.push({title:'Export All Docs as HTML', desc:'Download all documents as styled HTML file', icon:'E', type:'action', action:()=>{closeCommandPalette();exportAllDocsHTML();}});
  if(!ql || 'export links bookmarks'.includes(ql)) items.push({title:'Export Links', desc:'Copy all links as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportLinks();}});
  if(!ql || 'export week calendar summary'.includes(ql)) items.push({title:'Export Week', desc:'Copy this weeks tasks as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportWeek();}});
  if(!ql || 'projects all list'.includes(ql)){const ps=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();if(ps.length)ps.forEach(p=>{const active=S.tasks.filter(t=>t.project===p&&t.status!=='done').length;const done=S.tasks.filter(t=>t.project===p&&t.status==='done').length;items.push({title:p,desc:active+' active, '+done+' done',icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p;const tpf=document.getElementById('task-project-filter');if(tpf)tpf.value=p;renderTasks();toast('Filtered: '+p);}});});}
  if(!ql || 'weekly report summary productivity'.includes(ql)) items.push({title:'Weekly Report', desc:'Copy weekly productivity report as markdown', icon:'W', type:'action', action:()=>{closeCommandPalette();weeklyReport();}});
  if(!ql || 'export month calendar'.includes(ql)) items.push({title:'Export Month', desc:'Copy current months tasks as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportMonth();}});
  if(!ql || 'archive'.includes(ql)) items.push({title:'Archive Completed', desc:'Move done tasks to archive', icon:'A', type:'action', action:()=>{closeCommandPalette();archiveCompletedTasks();}});
  if(!ql || 'overdue late past due'.includes(ql)){const ot=new Date().toISOString().split('T')[0];const od=S.tasks.filter(t=>t.due&&t.due<ot&&t.status!=='done');if(od.length)items.push({title:'Overdue Tasks ('+od.length+')',desc:od.slice(0,3).map(t=>t.title).join(', '),icon:'!',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);setTaskFilter('active');document.getElementById('task-sort').value='due';renderTasks();toast(od.length+' overdue tasks');}});}
  if(!ql || 'archive archived completed old'.includes(ql)){const ac=(S.archivedTasks||[]).length;if(ac)items.push({title:'View Archived Tasks ('+ac+')',desc:'Browse and restore archived tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);showArchivedTasks();}});}
  if(!ql || 'shortcuts help'.includes(ql)) items.push({title:'Keyboard Shortcuts', desc:'Show all shortcuts (Cmd+/)', icon:'?', type:'action', action:()=>{closeCommandPalette();document.getElementById('shortcuts-modal').classList.add('open');}});
  if(!ql || 'help prefix commands'.includes(ql)) items.push({title:'Cmd+K Prefixes (29)', desc:'task: note: link: doc: spec: tag: project: goto: calc: all: focus: due: status: p: recent: count: overdue: today: week: starred: random: pin: progress: blocked: export: wc: archive: time: in:', icon:'?', type:'info'});
  if(!ql || 'clear reset filters'.includes(ql)) items.push({title:'Clear All Filters', desc:'Reset search, filters, and sort to defaults', icon:'X', type:'action', action:()=>{closeCommandPalette();taskFilter='all';taskProjectFilter=null;contentType='all';contentTheme='all';contentTagFilter=null;contentShowAll=false;const ts=document.getElementById('task-search');if(ts)ts.value='';const cs=document.getElementById('content-search');if(cs)cs.value='';const tsort=document.getElementById('task-sort');if(tsort)tsort.value='manual';renderTasks();renderContent();renderLinks();toast('All filters cleared');}});
  if(!ql || 'zen writer'.includes(ql)) items.push({title:'Zen Writer', desc:'Distraction-free writing mode', icon:'Z', type:'action', action:()=>{closeCommandPalette();zenOpen();}});
  if(!ql || 'focus mode'.includes(ql)) items.push({title:'Toggle Focus Mode', desc:'Hide sidebar for focused work', icon:'F', type:'action', action:()=>{closeCommandPalette();const app=document.querySelector('.app');setMode(app.classList.contains('mode-focus')?'default':'focus');}});
  if(!ql || 'ics calendar export'.includes(ql)) items.push({title:'Export Calendar', desc:'Export tasks as .ics for Google Calendar', icon:'C', type:'action', action:()=>{closeCommandPalette();exportICS();}});
  if(!ql || 'random inspiration content'.includes(ql)) items.push({title:'Random Content', desc:'Pick a random content item for inspiration', icon:'?', type:'action', action:()=>{closeCommandPalette();switchSection('content',null);setTimeout(randomContent,100);}});
  if(!ql || 'export summary markdown report'.includes(ql)) items.push({title:'Export Summary', desc:'Copy hub summary as Markdown', icon:'S', type:'action', action:()=>{closeCommandPalette();exportSummary();}});
  if(!ql || 'repo health check ping'.includes(ql)) items.push({title:'Repo Health Check', desc:'Ping all live repo URLs', icon:'R', type:'action', action:()=>{closeCommandPalette();repoHealthCheck();}});
  if(!ql || 'time report hours tracked'.includes(ql)) items.push({title:'Time Report', desc:'Show time tracked per task', icon:'T', type:'action', action:()=>{closeCommandPalette();timeReport();}});
  if(!ql || 'zen writer write focus'.includes(ql)) items.push({title:'Zen Writer', desc:'Full-screen distraction-free writing (Cmd+Shift+W)', icon:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>', type:'action', action:()=>{closeCommandPalette();zenOpen();}});
  if(!ql || 'daily dashboard digest briefing morning'.includes(ql)) items.push({title:'Daily Dashboard', desc:'Full daily briefing copied to clipboard', icon:'*', type:'action', action:()=>{closeCommandPalette();dailyDashboard();}});
  if(!ql || 'import ics calendar'.includes(ql)) items.push({title:'Import ICS', desc:'Import .ics calendar file as tasks', icon:'C', type:'action', action:()=>{closeCommandPalette();importICS();}});
  if(!ql || 'export all specs living docs'.includes(ql)) items.push({title:'Export All Specs', desc:'Combine all Living Docs into one markdown', icon:'S', type:'action', action:()=>{closeCommandPalette();exportAllSpecs();}});
  if(!ql || 'export specs html download'.includes(ql)) items.push({title:'Export Specs as HTML', desc:'Download all Living Docs as styled HTML', icon:'S', type:'action', action:()=>{closeCommandPalette();exportAllSpecsHTML();}});
  if(!ql || 'export tasks html download'.includes(ql)) items.push({title:'Export Tasks as HTML', desc:'Download all tasks as styled HTML by project', icon:'T', type:'action', action:()=>{closeCommandPalette();exportAllTasksHTML();}});
  if(!ql || 'export links html download'.includes(ql)) items.push({title:'Export Links as HTML', desc:'Download all links as styled HTML by category', icon:'L', type:'action', action:()=>{closeCommandPalette();exportAllLinksHTML();}});
  if(!ql || 'export content markdown md download'.includes(ql)) items.push({title:'Export Content as MD', desc:'Download all content grouped by type as Markdown', icon:'C', type:'action', action:()=>{closeCommandPalette();exportAllContentMD();}});
  if(!ql || 'export docs writer markdown md download'.includes(ql)) items.push({title:'Export Docs as MD', desc:'Download all writer documents as Markdown', icon:'W', type:'action', action:()=>{closeCommandPalette();exportAllDocsMD();}});
  if(!ql || 'export tasks ics calendar file'.includes(ql)) items.push({title:'Export Tasks as ICS', desc:'Download active tasks with due dates as calendar file', icon:'C', type:'action', action:()=>{closeCommandPalette();exportTasksICS();}});
  // Quick create task from Cmd+K with @date and !priority
  if(ql && ql.startsWith('task:')) {
    let taskRaw=q.substring(5).trim();
    let taskDue=new Date().toISOString().split('T')[0];
    let taskPri='p1';
    const dateMatch=taskRaw.match(/@(\S+)/);
    if(dateMatch){taskDue=parseNaturalDate(dateMatch[1])||taskDue;taskRaw=taskRaw.replace(/@\S+/,'').trim();}
    const priMatch=taskRaw.match(/!(p[0-3])/i);
    if(priMatch){taskPri=priMatch[1].toLowerCase();taskRaw=taskRaw.replace(/!p[0-3]/i,'').trim();}
    const taskTitle=taskRaw;
    if(taskTitle){items.unshift({title:'Create task: '+taskTitle,desc:'Due: '+taskDue+' | '+taskPri.toUpperCase()+(dateMatch?' (parsed @'+dateMatch[1]+')':''),icon:'+',type:'action',action:()=>{closeCommandPalette();S.tasks.unshift({id:Date.now(),title:taskTitle,description:'',subtasks:[],status:'todo',priority:taskPri,project:taskProjectFilter||'',due:taskDue,created:new Date().toISOString()});save();if(currentSection==='tasks')renderTasks();toast('Task created: '+taskTitle);}});}
  }
  // Quick add content from Cmd+K
  if(ql && ql.startsWith('note:')) {
    const noteBody=q.substring(5).trim();
    if(noteBody){items.unshift({title:'Save note: '+noteBody.substring(0,40),desc:'Quick-save as content item',icon:'+',type:'action',action:()=>{closeCommandPalette();S.content.unshift({id:Date.now(),type:'caption',theme:'quick-note',body:noteBody,tags:['quick'],created:new Date().toISOString()});save();if(currentSection==='content')renderContent();toast('Note saved');}});}
  }
  // Quick filter by project from Cmd+K
  if(ql && ql.startsWith('project:')) {
    const pq=q.substring(8).trim().toLowerCase();
    const matchingProjects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].filter(p=>p.toLowerCase().includes(pq));
    matchingProjects.forEach(p=>{
      const cnt=S.tasks.filter(t=>t.project===p&&t.status!=='done').length;
      items.unshift({title:'Project: '+p,desc:cnt+' active tasks',icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p;renderTasks();toast('Filtered: '+p);}});
    });
  }
  // Quick add link from Cmd+K
  if(ql && ql.startsWith('link:')) {
    const linkUrl=q.substring(5).trim();
    if(linkUrl){
      const isUrl=linkUrl.startsWith('http')||linkUrl.includes('.');
      items.unshift({title:'Add link: '+linkUrl.substring(0,40),desc:isUrl?'Quick-save link to directory':'Not a valid URL — add anyway?',icon:'L',type:'action',action:()=>{closeCommandPalette();const url=linkUrl.startsWith('http')?linkUrl:'https://'+linkUrl;const title=url.replace(/https?:\/\/(www\.)?/,'').split('/')[0];S.links.unshift({id:Date.now(),title,url,category:'unsorted',desc:'',pinned:false,created:new Date().toISOString()});save();if(currentSection==='links')renderLinks();toast('Link saved: '+title);}});
    }
  }
  // Global full-text search
  if(ql && ql.startsWith('all:')) {
    const aq=q.substring(4).trim().toLowerCase();
    if(aq){
      S.tasks.filter(t=>(t.title+' '+(t.description||'')).toLowerCase().includes(aq)).slice(0,3).forEach(t=>{items.push({title:t.title,desc:'Task - '+t.status,icon:'T',type:'task',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
      S.content.filter(c=>c.body.toLowerCase().includes(aq)).slice(0,3).forEach(c=>{items.push({title:c.body.substring(0,50),desc:'Content - '+c.type,icon:'C',type:'content',action:()=>{closeCommandPalette();switchSection('content',null);document.getElementById('content-search').value=aq;renderContent();}});});
      S.docs.filter(d=>{const tmp=document.createElement('div');tmp.innerHTML=d.body||'';return(d.title||'').toLowerCase().includes(aq)||(tmp.innerText||'').toLowerCase().includes(aq);}).slice(0,3).forEach(d=>{items.push({title:d.title||'Untitled',desc:'Document',icon:'W',type:'doc',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});
      S.links.filter(l=>(l.title+' '+l.url+' '+(l.desc||'')).toLowerCase().includes(aq)).slice(0,3).forEach(l=>{items.push({title:l.title,desc:l.url,icon:'L',type:'link',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});
    }
  }
  // Quick tag search from Cmd+K
  if(ql && ql.startsWith('tag:')) {
    const tq=q.substring(4).trim().toLowerCase();
    if(tq){
      const allContentTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))].filter(t=>t.toLowerCase().includes(tq));
      allContentTags.slice(0,5).forEach(tag=>{
        const cnt=S.content.filter(c=>(c.tags||[]).includes(tag)).length;
        items.unshift({title:'Tag: '+tag,desc:cnt+' content items',icon:'#',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);contentTagFilter=tag;renderContent();toast('Filtered: '+tag);}});
      });
      const allDocTags=[...new Set(S.docs.flatMap(d=>d.tags||[]).filter(Boolean))].filter(t=>t.toLowerCase().includes(tq));
      allDocTags.slice(0,5).forEach(tag=>{
        const cnt=S.docs.filter(d=>(d.tags||[]).includes(tag)).length;
        items.unshift({title:'Doc tag: '+tag,desc:cnt+' documents',icon:'W',type:'action',action:()=>{closeCommandPalette();switchSection('writer',null);toast(cnt+' docs tagged: '+tag);}});
      });
    } else {
      const contentTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))];
      const docTags=[...new Set(S.docs.flatMap(d=>d.tags||[]).filter(Boolean))];
      items.unshift({title:'All tags',desc:contentTags.length+' content tags, '+docTags.length+' doc tags',icon:'#',type:'info'});
    }
  }
  // Focus on specific task from Cmd+K
  if(ql && ql.startsWith('focus:')) {
    const fq=q.substring(6).trim().toLowerCase();
    if(fq){
      S.tasks.filter(t=>t.status!=='done'&&t.title&&t.title.toLowerCase().includes(fq)).slice(0,5).forEach(t=>{
        items.unshift({title:'Focus: '+t.title,desc:'Start 25min Pomodoro + time tracking',icon:'F',type:'action',action:()=>{closeCommandPalette();ftStartForTask(t.id);toast('Focus started: '+t.title);}});
      });
    }
  }
  // Today prefix
  if(ql && (ql.startsWith('today:') || ql==='today')){
    const today=new Date().toISOString().split('T')[0];
    const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
    const tq=q.substring(q.indexOf(':')+1).trim().toLowerCase();
    todayTasks.filter(t=>!tq||t.title.toLowerCase().includes(tq)).forEach(t=>{
      items.unshift({title:t.title||'Untitled',desc:'Due today | '+(t.priority||'p2')+' | '+(t.project||'no project'),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    if(!todayTasks.length)items.unshift({title:'No tasks due today',desc:'Use task: to create one',icon:'T',type:'info'});
  }
  // Pin prefix - all pinned items
  if(ql && (ql.startsWith('pin:') || ql==='pin' || ql==='pinned')){
    S.content.filter(c=>c.pinned).forEach(c=>{items.unshift({title:c.body.substring(0,60),desc:'Pinned content | '+c.type+(c.theme?' | '+c.theme:''),icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});});
    S.links.filter(l=>l.pinned).forEach(l=>{items.unshift({title:l.title,desc:'Pinned link | '+l.url.substring(0,50),icon:'P',type:'action',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});
    if(!items.length)items.unshift({title:'No pinned items',desc:'Pin content or links with the Pin button',icon:'P',type:'info'});
  }
  // Scope prefix - search within specific section only
  if(ql && ql.startsWith('in:')){
    const parts=q.substring(3).trim();const colonIdx=parts.indexOf(' ');
    const scope=colonIdx>0?parts.substring(0,colonIdx).toLowerCase():parts.toLowerCase();
    const term=colonIdx>0?parts.substring(colonIdx+1).trim().toLowerCase():'';
    if(term){
      if(scope==='tasks'||scope==='task'||scope==='t'){S.tasks.filter(t=>(t.title||'').toLowerCase().includes(term)||(t.description||'').toLowerCase().includes(term)).slice(0,8).forEach(t=>{items.unshift({title:t.title||'Untitled',desc:(t.priority||'p2')+' | '+(t.project||'')+(t.due?' | '+t.due:''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}
      if(scope==='docs'||scope==='doc'||scope==='d'||scope==='writer'){S.docs.filter(d=>(d.title||'').toLowerCase().includes(term)||(d.body||'').toLowerCase().includes(term)).slice(0,8).forEach(d=>{items.unshift({title:d.title||'Untitled',desc:countW(d.body)+'w',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});}
      if(scope==='content'||scope==='c'){S.content.filter(c=>c.body.toLowerCase().includes(term)).slice(0,8).forEach(c=>{items.unshift({title:c.body.substring(0,60),desc:c.type+(c.theme?' | '+c.theme:''),icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});});}
      if(scope==='specs'||scope==='spec'||scope==='s'){S.specs.filter(s=>(s.title||'').toLowerCase().includes(term)||(s.sections||[]).some(sec=>(sec.body||'').toLowerCase().includes(term))).slice(0,8).forEach(s=>{items.unshift({title:s.title||'Untitled',desc:(s.sections||[]).length+' sections',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(s.id);switchSection('specs',null);}});});}
      if(scope==='links'||scope==='link'||scope==='l'){S.links.filter(l=>(l.title+' '+l.url+' '+(l.desc||'')).toLowerCase().includes(term)).slice(0,8).forEach(l=>{items.unshift({title:l.title,desc:l.url.substring(0,50),icon:'L',type:'action',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});}
    } else {
      items.unshift({title:'Scoped search',desc:'Usage: in:tasks keyword, in:docs keyword, in:content keyword, in:specs keyword, in:links keyword',icon:'?',type:'info'});
    }
  }
  // Time tracking prefix - summary of time tracked
  if(ql && (ql.startsWith('time:') || ql==='time' || ql==='timer')){
    const tracked=S.tasks.filter(t=>t.timeSpent>0);const running=S.tasks.filter(t=>t.timeStarted);
    const totalMins=tracked.reduce((a,t)=>a+(t.timeSpent||0),0);
    items.unshift({title:'Total tracked: '+formatTimeSpent(totalMins),desc:tracked.length+' tasks tracked'+(running.length?' | '+running.length+' running':''),icon:'T',type:'info'});
    const byProject={};tracked.forEach(t=>{const p=t.project||'No Project';byProject[p]=(byProject[p]||0)+(t.timeSpent||0);});
    Object.entries(byProject).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([p,m])=>{items.unshift({title:p+': '+formatTimeSpent(m),desc:Math.round(m/totalMins*100)+'% of tracked time',icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);filterTaskProject(p);document.getElementById('task-sort').value='time';renderTasks();}});});
    if(running.length){running.forEach(t=>{items.unshift({title:'Running: '+t.title,desc:'Started '+timeAgo(t.timeStarted),icon:'>',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}
  }
  // Archive prefix - show archived tasks
  if(ql && (ql.startsWith('archive:') || ql==='archive' || ql==='archived')){
    const archived=S.archivedTasks||[];
    if(archived.length){
      const aq=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
      const filtered=aq?archived.filter(t=>(t.title||'').toLowerCase().includes(aq)):archived;
      filtered.slice(0,10).forEach(t=>{items.unshift({title:t.title||'Untitled',desc:'Archived | '+(t.project||'')+(t.completedAt?' | Done '+timeAgo(t.completedAt):''),icon:'A',type:'action',action:()=>{closeCommandPalette();if(confirm('Restore "'+t.title+'" from archive?')){S.archivedTasks=S.archivedTasks.filter(x=>x.id!==t.id);t.status='todo';S.tasks.push(t);save();renderTasks();toast('Restored: '+t.title);}}});});
      items.push({title:archived.length+' archived tasks',desc:'Search with archive:keyword or click to restore',icon:'A',type:'info'});
    } else {
      items.unshift({title:'No archived tasks',desc:'Archive done tasks from the Tasks section',icon:'A',type:'info'});
    }
  }
  // Word count prefix - breakdown of words across all sections
  if(ql && (ql.startsWith('wc:') || ql==='wc' || ql==='wordcount' || ql==='words')){
    const docW=S.docs.reduce((a,d)=>a+countW(d.body),0);
    const contentW=S.content.reduce((a,c)=>a+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
    const specW=S.specs.reduce((a,s)=>a+(s.sections||[]).reduce((b,sec)=>b+countW(sec.body),0),0);
    const totalW=docW+contentW+specW;
    items.unshift({title:'Total: '+totalW.toLocaleString()+' words',desc:'Docs: '+docW.toLocaleString()+' | Content: '+contentW.toLocaleString()+' | Specs: '+specW.toLocaleString(),icon:'W',type:'info'});
    items.unshift({title:'Writer: '+docW.toLocaleString()+'w ('+S.docs.length+' docs)',desc:'Avg '+Math.round(docW/Math.max(1,S.docs.length))+' words/doc',icon:'W',type:'action',action:()=>{closeCommandPalette();switchSection('writer',null);}});
    items.unshift({title:'Content: '+contentW.toLocaleString()+'w ('+S.content.length+' items)',desc:'Avg '+Math.round(contentW/Math.max(1,S.content.length))+' words/item',icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});
    items.unshift({title:'Living Docs: '+specW.toLocaleString()+'w ('+S.specs.length+' specs)',desc:'Avg '+Math.round(specW/Math.max(1,S.specs.length))+' words/spec',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSection('specs',null);}});
  }
  // Export prefix - list all export actions
  if(ql && (ql.startsWith('export:') || ql==='export' || ql==='exports')){
    items.unshift({title:'Export Tasks as HTML',desc:S.tasks.length+' tasks grouped by project',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllTasksHTML();}});
    items.unshift({title:'Export Specs as HTML',desc:S.specs.length+' living docs with sections',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllSpecsHTML();}});
    items.unshift({title:'Export Content as HTML',desc:S.content.length+' items grouped by theme',icon:'E',type:'action',action:()=>{closeCommandPalette();exportContentHTML();}});
    items.unshift({title:'Export All Docs as HTML',desc:S.docs.length+' documents',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllDocsHTML();}});
    items.unshift({title:'Export Tasks as Markdown',desc:'Copy filtered tasks to clipboard',icon:'E',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);exportTasks();}});
    items.unshift({title:'Export Links as Markdown',desc:'Copy categorized links to clipboard',icon:'E',type:'action',action:()=>{closeCommandPalette();exportLinksMarkdown();}});
    items.unshift({title:'Export Links as HTML',desc:S.links.length+' links grouped by category',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllLinksHTML();}});
    items.unshift({title:'Export Content as MD',desc:S.content.length+' items grouped by type',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllContentMD();}});
    items.unshift({title:'Export Docs as MD',desc:S.docs.length+' writer documents as Markdown',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllDocsMD();}});
    items.unshift({title:'Export Tasks as ICS',desc:'Active tasks as calendar file',icon:'E',type:'action',action:()=>{closeCommandPalette();exportTasksICS();}});
    items.unshift({title:'Export Whiteboard as Text',desc:'Copy node outline to clipboard',icon:'E',type:'action',action:()=>{closeCommandPalette();wbExport('text');}});
    items.unshift({title:'Export All Data (JSON)',desc:'Full backup of all sections',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAll();}});
  }
  // Progress prefix - project completion percentages
  if(ql && (ql.startsWith('progress:') || ql==='progress' || ql==='pct')){
    const projs=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    projs.forEach(p=>{const all=S.tasks.filter(t=>t.project===p);const done=all.filter(t=>t.status==='done').length;const pct=all.length?Math.round(done/all.length*100):0;items.unshift({title:p+' — '+pct+'%',desc:done+'/'+all.length+' done | '+(all.length-done)+' remaining',icon:'%',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);filterTaskProject(p);}});});
    const allT=S.tasks.length;const allD=S.tasks.filter(t=>t.status==='done').length;const allPct=allT?Math.round(allD/allT*100):0;
    items.push({title:'Overall — '+allPct+'%',desc:allD+'/'+allT+' tasks done',icon:'%',type:'info'});
  }
  // Blocked prefix - show blocked tasks
  if(ql && (ql.startsWith('blocked:') || ql==='blocked')){
    const blocked=S.tasks.filter(t=>t.status==='blocked');
    blocked.forEach(t=>{items.unshift({title:t.title||'Untitled',desc:(t.blockedBy?'Blocked by: '+t.blockedBy+' | ':'')+(t.project||'')+(t.due?' | due '+relativeDate(t.due):''),icon:'B',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    if(!blocked.length)items.unshift({title:'No blocked tasks',desc:'All tasks are unblocked',icon:'B',type:'info'});
  }
  // Random prefix - random content/doc for review
  if(ql && (ql.startsWith('random:') || ql==='random' || ql==='rand')){
    const rType=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
    if(!rType||rType==='content'||rType==='c'){const c=S.content[Math.floor(Math.random()*S.content.length)];if(c)items.unshift({title:c.body.substring(0,60)+'...',desc:'Random content | '+c.type+(c.theme?' | '+c.theme:''),icon:'?',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);navigator.clipboard.writeText(c.body);toast('Random content copied');}});}
    if(!rType||rType==='doc'||rType==='d'){const d=S.docs[Math.floor(Math.random()*S.docs.length)];if(d)items.unshift({title:d.title||'Untitled',desc:'Random doc | '+countW(d.body)+'w',icon:'?',type:'action',action:()=>{closeCommandPalette();switchSection('writer',null);switchDoc(d.id);}});}
    if(!rType||rType==='task'||rType==='t'){const t=S.tasks.filter(x=>x.status!=='done')[Math.floor(Math.random()*S.tasks.filter(x=>x.status!=='done').length)];if(t)items.unshift({title:t.title||'Untitled',desc:'Random task | '+(t.priority||'p2')+' | '+(t.project||''),icon:'?',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});}
  }
  // Starred prefix - all starred items
  if(ql && (ql.startsWith('starred:') || ql==='starred' || ql==='star')){
    const sq=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
    S.docs.filter(d=>d.starred).forEach(d=>{if(!sq||(d.title||'').toLowerCase().includes(sq))items.unshift({title:d.title||'Untitled',desc:'Starred doc | '+countW(d.body)+'w',icon:'*',type:'action',action:()=>{closeCommandPalette();switchSection('writer',null);switchDoc(d.id);}});});
    S.content.filter(c=>c.starred).forEach(c=>{if(!sq||c.body.toLowerCase().includes(sq))items.unshift({title:c.body.substring(0,60),desc:'Starred content | '+c.type,icon:'*',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});});
    if(!items.length)items.unshift({title:'No starred items',desc:'Star docs or content with the * button',icon:'*',type:'info'});
  }
  // Week prefix - tasks due this week
  if(ql && (ql.startsWith('week:') || ql==='week')){
    const today=new Date();const weekEnd=new Date(today);weekEnd.setDate(today.getDate()+(7-today.getDay()));
    const todayStr=today.toISOString().split('T')[0];const weekEndStr=weekEnd.toISOString().split('T')[0];
    const weekTasks=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due>=todayStr&&t.due<=weekEndStr);
    weekTasks.sort((a,b)=>a.due.localeCompare(b.due));
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    weekTasks.forEach(t=>{const d=new Date(t.due+'T12:00:00');items.unshift({title:t.title||'Untitled',desc:dayNames[d.getDay()]+' '+t.due+' | '+(t.priority||'p2')+' | '+(t.project||''),icon:'W',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    if(!weekTasks.length)items.unshift({title:'No tasks due this week',desc:'Clear schedule ahead',icon:'W',type:'info'});
  }
  // Overdue tasks prefix
  if(ql && ql.startsWith('overdue:') || (ql && ql==='overdue')){
    const today=new Date().toISOString().split('T')[0];
    const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
    overdue.sort((a,b)=>a.due.localeCompare(b.due));
    overdue.slice(0,10).forEach(t=>{
      const daysLate=Math.ceil((new Date()-new Date(t.due+'T12:00:00'))/86400000);
      items.unshift({title:t.title||'Untitled',desc:t.due+' ('+daysLate+'d late) | '+(t.priority||'p2')+' | '+(t.project||'no project'),icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    if(!overdue.length)items.unshift({title:'No overdue tasks',desc:'All caught up',icon:'v',type:'info'});
  }
  // Priority filter from Cmd+K
  if(ql && ql.startsWith('priority:') || ql && ql.startsWith('p:')) {
    const pq=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
    const pMap={'0':'p0','1':'p1','2':'p2','3':'p3','p0':'p0','p1':'p1','p2':'p2','p3':'p3','critical':'p0','high':'p1','medium':'p2','low':'p3'};
    const p=pMap[pq];
    if(p){
      const cnt=S.tasks.filter(t=>t.priority===p&&t.status!=='done').length;
      items.unshift({title:'Priority: '+p.toUpperCase()+' ('+cnt+' active)',desc:'Show '+p+' tasks',icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);setTaskFilter('active');document.getElementById('task-sort').value='priority';renderTasks();toast('Sorted by priority');}});
    }
  }
  // Status filter from Cmd+K
  if(ql && ql.startsWith('status:')) {
    const sq=q.substring(7).trim().toLowerCase();
    const statuses={todo:'todo',wip:'progress','in progress':'progress',progress:'progress',done:'done',blocked:'blocked',active:'active'};
    const st=statuses[sq];
    if(st){
      const cnt=st==='active'?S.tasks.filter(t=>t.status!=='done').length:S.tasks.filter(t=>t.status===st).length;
      items.unshift({title:'Filter: '+sq+' ('+cnt+')',desc:'Show '+sq+' tasks',icon:'F',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);setTaskFilter(st);renderTasks();}});
    }
  }
  // Due date filter from Cmd+K
  if(ql && ql.startsWith('due:')) {
    const dq=q.substring(4).trim();
    const parsed=parseNaturalDate(dq);
    if(parsed&&/^\d{4}-\d{2}-\d{2}$/.test(parsed)){
      const matching=S.tasks.filter(t=>t.due===parsed&&t.status!=='done');
      items.unshift({title:'Tasks due '+relativeDate(parsed)+' ('+matching.length+')',desc:matching.slice(0,3).map(t=>t.title).join(', ')||'No tasks',icon:'D',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);setTaskFilter('active');document.getElementById('task-sort').value='due';renderTasks();toast(matching.length+' tasks due '+parsed);}});
    }
  }
  // Quick spec search from Cmd+K
  if(ql && ql.startsWith('spec:')) {
    const sq=q.substring(5).trim().toLowerCase();
    if(sq){
      S.specs.filter(s=>s.title&&s.title.toLowerCase().includes(sq)).forEach(s=>{
        const w=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);
        items.unshift({title:s.title,desc:w+'w / '+(s.sections||[]).length+' sections',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(s.id);switchSection('specs',null);}});
      });
    }
  }
  // Quick doc search from Cmd+K
  if(ql && ql.startsWith('doc:')) {
    const dq=q.substring(4).trim().toLowerCase();
    if(dq){
      S.docs.filter(d=>d.title&&d.title.toLowerCase().includes(dq)).forEach(d=>{
        const w=countW(d.body);
        items.unshift({title:d.title,desc:w+'w'+(d.tags&&d.tags.length?' / '+d.tags.join(', '):''),icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});
      });
    }
  }
  // Quick goto from Cmd+K
  if(ql && ql.startsWith('goto:')) {
    const gq=q.substring(5).trim().toLowerCase();
    if(gq){
      S.tasks.filter(t=>t.title&&t.title.toLowerCase().includes(gq)).slice(0,3).forEach(t=>{items.unshift({title:'Go: '+t.title,desc:'Open task detail',icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
      S.docs.filter(d=>d.title&&d.title.toLowerCase().includes(gq)).slice(0,3).forEach(d=>{items.unshift({title:'Go: '+d.title,desc:'Open in writer',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});
      S.specs.filter(s=>s.title&&s.title.toLowerCase().includes(gq)).slice(0,3).forEach(s=>{items.unshift({title:'Go: '+s.title,desc:'Open living doc',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(s.id);switchSection('specs',null);}});});
    }
  }
  // Quick calc from Cmd+K
  if(ql && ql.startsWith('calc:')) {
    const expr=q.substring(5).trim();
    if(expr){
      try{const result=Function('"use strict";return ('+expr+')')();items.unshift({title:'= '+result,desc:'Copy result to clipboard',icon:'#',type:'action',action:()=>{closeCommandPalette();navigator.clipboard.writeText(String(result)).then(()=>toast('Copied: '+result));}});}catch(e){items.unshift({title:'Error: '+e.message,desc:'Invalid expression',icon:'!',type:'info'});}
    }
  }
  // Open specific docs in Zen Writer
  if(ql && ('zen '.includes(ql.substring(0,4)) || ql.startsWith('zen '))) {
    S.docs.forEach(function(d) {
      if(d.title) items.push({title:'Zen: ' + d.title, desc:'Open in Zen Writer', icon:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>', type:'action', action:function(){ closeCommandPalette(); zenOpen(d.id); }});
    });
  }
  // Duplicate task from Cmd+K
  if(ql && ql.startsWith('dup:')){
    const dq=q.substring(4).trim().toLowerCase();
    if(dq){S.tasks.filter(t=>t.title.toLowerCase().includes(dq)).slice(0,5).forEach(t=>{items.unshift({title:'Dup: '+t.title,desc:t.project?(t.project+' | '+t.priority):(t.priority||'p2'),icon:'+',type:'action',action:()=>{closeCommandPalette();const n={...JSON.parse(JSON.stringify(t)),id:Date.now(),created:new Date().toISOString(),status:'todo'};delete n.completedAt;delete n.timeSpent;delete n.timeStarted;delete n.log;S.tasks.unshift(n);save();if(currentSection==='tasks')renderTasks();toast('Duplicated: '+t.title);}});});}
  }
  // Sort by tag prefix
  if(ql && (ql.startsWith('tag-tasks:') || ql==='tag-tasks')){
    const tq=q.substring(10).trim().toLowerCase();
    const allTaskTags=[...new Set(S.tasks.flatMap(t=>t.tags||[]).filter(Boolean))].sort();
    const filtered=tq?allTaskTags.filter(t=>t.includes(tq)):allTaskTags;
    filtered.slice(0,8).forEach(tag=>{const cnt=S.tasks.filter(t=>(t.tags||[]).includes(tag)).length;items.unshift({title:'Tag: '+tag,desc:cnt+' tasks',icon:'T',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);document.getElementById('task-search').value='#'+tag;renderTasks();toast('Filtered by tag: '+tag);}});});
    if(!filtered.length)items.unshift({title:'No task tags found',desc:tq?'No tags matching "'+tq+'"':'No tasks have tags yet',icon:'!',type:'info'});
  }
  // Backup prefix — quick backup info
  if(ql && (ql.startsWith('backup:') || ql==='backup')){
    const size=JSON.stringify(S).length;const kb=Math.round(size/1024);
    items.unshift({title:'Backup size: '+kb+'KB',desc:'Tasks: '+S.tasks.length+' | Content: '+S.content.length+' | Docs: '+S.docs.length+' | Specs: '+S.specs.length+' | Links: '+S.links.length,icon:'B',type:'info'});
    items.push({title:'Export as JSON',desc:'Full backup of all data',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAll();}});
    items.push({title:'Export Tasks as HTML',desc:'Styled task export',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllTasksHTML();}});
    items.push({title:'Export Docs as MD',desc:'All writer documents',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllDocsMD();}});
    items.push({title:'Cloud Save',desc:'Save to Vercel Blob',icon:'C',type:'action',action:()=>{closeCommandPalette();cloudSave();}});
  }
  // Find prefix — powerful cross-section search with counts
  if(ql && ql.startsWith('find:')){
    const fq=q.substring(5).trim().toLowerCase();
    if(fq&&fq.length>=2){
      const taskHits=S.tasks.filter(t=>(t.title+' '+(t.description||'')+' '+(t.tags||[]).join(' ')).toLowerCase().includes(fq));
      const contentHits=S.content.filter(c=>(c.body+' '+c.theme+' '+(c.tags||[]).join(' ')).toLowerCase().includes(fq));
      const docHits=S.docs.filter(d=>{const tmp=document.createElement('div');tmp.innerHTML=d.body||'';return((d.title||'')+' '+(tmp.innerText||'')).toLowerCase().includes(fq);});
      const specHits=S.specs.filter(s=>(s.title||'').toLowerCase().includes(fq)||(s.sections||[]).some(sec=>((sec.title||'')+' '+(sec.body||'')).toLowerCase().includes(fq)));
      const linkHits=S.links.filter(l=>(l.title+' '+l.url+' '+(l.desc||'')).toLowerCase().includes(fq));
      items.unshift({title:'Found: '+taskHits.length+' tasks, '+contentHits.length+' content, '+docHits.length+' docs',desc:specHits.length+' specs, '+linkHits.length+' links | "'+fq+'"',icon:'?',type:'info'});
      taskHits.slice(0,3).forEach(t=>{items.push({title:t.title,desc:'Task - '+t.status+' / '+t.priority,icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
      docHits.slice(0,2).forEach(d=>{items.push({title:d.title||'Untitled',desc:'Document - '+countW(d.body)+'w',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});
      contentHits.slice(0,2).forEach(c=>{items.push({title:c.body.substring(0,50),desc:'Content - '+c.type,icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);document.getElementById('content-search').value=fq;renderContent();}});});
      linkHits.slice(0,2).forEach(l=>{items.push({title:l.title,desc:l.url,icon:'L',type:'action',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});
    }
  }
  // Streak prefix — consecutive days with completed tasks
  if(ql && (ql.startsWith('streak:') || ql==='streak' || ql==='streaks')){
    const dates=new Set();S.tasks.forEach(t=>{if(t.completedAt)dates.add(t.completedAt.split('T')[0]);});
    let streak=0;const d=new Date();d.setHours(0,0,0,0);
    while(dates.has(d.toISOString().split('T')[0])||d.toISOString().split('T')[0]===new Date().toISOString().split('T')[0]){if(dates.has(d.toISOString().split('T')[0]))streak++;d.setDate(d.getDate()-1);}
    const totalDays=dates.size;const longestStreak=(()=>{const sorted=[...dates].sort();let max=1,cur=1;for(let i=1;i<sorted.length;i++){const prev=new Date(sorted[i-1]+'T12:00:00'),curr=new Date(sorted[i]+'T12:00:00');if(Math.round((curr-prev)/86400000)===1){cur++;if(cur>max)max=cur;}else cur=1;}return sorted.length?max:0;})();
    items.unshift({title:'Current streak: '+streak+' day'+(streak!==1?'s':''),desc:'Best: '+longestStreak+' days | Total active days: '+totalDays,icon:'*',type:'info'});
    const last7=[];for(let i=0;i<7;i++){const dd=new Date();dd.setDate(dd.getDate()-i);const ds=dd.toISOString().split('T')[0];const cnt=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length;if(cnt)last7.push({date:ds,count:cnt});}
    last7.forEach(d=>{items.push({title:d.date+': '+d.count+' completed',desc:'',icon:'T',type:'info'});});
  }
  // Matrix prefix — priority x status breakdown
  if(ql && (ql.startsWith('matrix:') || ql==='matrix')){
    const active=S.tasks.filter(t=>t.status!=='done');
    const statuses=['todo','progress','blocked'];
    const priorities=['p0','p1','p2','p3'];
    const pLabels={p0:'P0 Critical',p1:'P1 High',p2:'P2 Medium',p3:'P3 Low'};
    const sLabels={todo:'To Do',progress:'In Progress',blocked:'Blocked'};
    items.unshift({title:'Priority Matrix: '+active.length+' active tasks',desc:'Tasks grouped by priority x status',icon:'M',type:'info'});
    priorities.forEach(p=>{const pTasks=active.filter(t=>(t.priority||'p2')===p);if(pTasks.length){const statusCounts=statuses.map(s=>pTasks.filter(t=>t.status===s).length);items.push({title:pLabels[p]+': '+pTasks.length+' tasks',desc:'Todo: '+statusCounts[0]+' | In Progress: '+statusCounts[1]+' | Blocked: '+statusCounts[2],icon:p==='p0'?'!':p==='p1'?'*':'T',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);document.getElementById('task-sort').value='priority';renderTasks();}});}});
  }
  // Inbox prefix — unprocessed items needing attention
  if(ql && (ql.startsWith('inbox:') || ql==='inbox' || ql==='triage')){
    const unprocessed=S.tasks.filter(t=>t.status==='todo'&&(!t.tags||!t.tags.length)&&(!t.project)&&(t.priority==='p2'||!t.priority));
    const noDesc=S.tasks.filter(t=>t.status!=='done'&&(!t.description||!t.description.trim()));
    const noDue=S.tasks.filter(t=>t.status!=='done'&&!t.due);
    items.unshift({title:'Inbox: '+unprocessed.length+' unprocessed tasks',desc:'No tags, no project, default priority — need triage',icon:'!',type:'info'});
    if(noDue.length>5)items.push({title:noDue.length+' tasks without due dates',desc:'Add dates for better planning',icon:'T',type:'info'});
    if(noDesc.length>5)items.push({title:noDesc.length+' tasks without descriptions',desc:'Add context for clarity',icon:'T',type:'info'});
    unprocessed.slice(0,8).forEach(t=>{items.push({title:t.title,desc:'Created '+timeAgo(t.created)+' — needs project, tags, priority',icon:'+',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Compare prefix — compare two projects
  if(ql && ql.startsWith('compare:')){
    const cq=q.substring(8).trim().toLowerCase();
    const allProjs=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    if(!cq){items.unshift({title:'Usage: compare:project1:project2',desc:'Available: '+allProjs.join(', '),icon:'C',type:'info'});}
    else{const parts=cq.split(':').map(p=>p.trim()).filter(Boolean);
    if(parts.length>=2){const p1=parts[0],p2=parts[1];
    const t1=S.tasks.filter(t=>t.project&&t.project.toLowerCase().includes(p1));const t2=S.tasks.filter(t=>t.project&&t.project.toLowerCase().includes(p2));
    const done1=t1.filter(t=>t.status==='done').length,done2=t2.filter(t=>t.status==='done').length;
    const active1=t1.filter(t=>t.status!=='done').length,active2=t2.filter(t=>t.status!=='done').length;
    const time1=t1.reduce((a,t)=>a+(t.timeSpent||0),0),time2=t2.reduce((a,t)=>a+(t.timeSpent||0),0);
    items.unshift({title:p1+' vs '+p2,desc:'Tasks: '+t1.length+' vs '+t2.length+' | Done: '+done1+' vs '+done2+' | Active: '+active1+' vs '+active2,icon:'C',type:'info'});
    items.push({title:p1+': '+t1.length+' tasks ('+done1+' done, '+active1+' active)',desc:'Time: '+(time1?formatTimeSpent(time1):'none')+' | Completion: '+Math.round(t1.length?done1/t1.length*100:0)+'%',icon:'1',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p1;renderTasks();}});
    items.push({title:p2+': '+t2.length+' tasks ('+done2+' done, '+active2+' active)',desc:'Time: '+(time2?formatTimeSpent(time2):'none')+' | Completion: '+Math.round(t2.length?done2/t2.length*100:0)+'%',icon:'2',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p2;renderTasks();}});
    }else{const matching=allProjs.filter(p=>p.toLowerCase().includes(parts[0]));
    items.unshift({title:'Type: compare:'+parts[0]+':second-project',desc:'Matches: '+matching.join(', '),icon:'C',type:'info'});}}
  }
  // Template prefix — quick task creation from templates
  if(ql && (ql.startsWith('template:') || ql==='template' || ql==='templates')){
    const templates=[
      {title:'Daily standup review',priority:'p1',tags:['daily','routine']},
      {title:'Weekly planning session',priority:'p1',tags:['weekly','planning'],recurrence:'weekly'},
      {title:'Code review',priority:'p2',tags:['dev','review']},
      {title:'Bug fix',priority:'p0',tags:['dev','bug']},
      {title:'Content creation',priority:'p2',tags:['content','creative']},
      {title:'Research',priority:'p2',tags:['research']},
      {title:'Meeting prep',priority:'p1',tags:['meeting']},
      {title:'Deploy & verify',priority:'p1',tags:['dev','deploy']},
    ];
    items.unshift({title:'Task Templates ('+templates.length+')',desc:'Click to create from template',icon:'T',type:'info'});
    templates.forEach(tpl=>{
      items.push({title:tpl.title,desc:'Priority: '+tpl.priority+' | Tags: '+(tpl.tags||[]).join(', '),icon:'+',type:'action',action:()=>{
        closeCommandPalette();
        const t={id:Date.now(),title:tpl.title,description:'',subtasks:[],status:'todo',priority:tpl.priority,project:taskProjectFilter||'',due:'',tags:[...(tpl.tags||[])],created:new Date().toISOString()};
        if(tpl.recurrence)t.recurrence=tpl.recurrence;
        S.tasks.unshift(t);save();renderTasks();openTaskDetail(t.id);toast('Created from template');
      }});
    });
  }
  // Orphan prefix — find disconnected items
  if(ql && (ql.startsWith('orphan:') || ql==='orphan' || ql==='orphans')){
    const projNames=new Set((S.projects||[]).map(p=>p.name));
    const projIds=new Set((S.projects||[]).map(p=>p.id));
    const noProj=S.tasks.filter(t=>t.status!=='done'&&!t.project).length;
    const badProj=S.tasks.filter(t=>t.project&&!projNames.has(t.project)).length;
    const orphanSpecs=S.specs.filter(s=>s.projectId&&!projIds.has(s.projectId));
    const emptyDocs=S.docs.filter(d=>(!d.body||d.body.trim().length<10)&&(!d.title||d.title==='Untitled'));
    const oldTodo=S.tasks.filter(t=>t.status==='todo'&&t.created&&(Date.now()-new Date(t.created).getTime())>30*86400000);
    items.unshift({title:'Orphans: '+noProj+' tasks no project, '+orphanSpecs.length+' specs orphaned',desc:badProj+' tasks with unknown project | '+emptyDocs.length+' empty docs | '+oldTodo.length+' stale todos',icon:'?',type:'info'});
    if(noProj)items.push({title:noProj+' active tasks without a project',desc:'Click to filter unassigned',icon:'T',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);document.getElementById('task-search').value='';taskProjectFilter=null;renderTasks();}});
    orphanSpecs.forEach(s=>{items.push({title:'Orphan spec: '+(s.title||'Untitled'),desc:'Project ID '+s.projectId+' no longer exists',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(String(s.id));switchSection('specs',null);}});});
    oldTodo.slice(0,5).forEach(t=>{items.push({title:'Stale: '+t.title+' ('+timeAgo(t.created)+')',desc:'Todo for 30+ days',icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Health prefix — system health check
  if(ql && (ql.startsWith('health:') || ql==='health' || ql==='diagnostics')){
    const size=JSON.stringify(S).length;const kb=Math.round(size/1024);
    const maxKB=5000;const pct=Math.round(kb/maxKB*100);
    const emptyTasks=S.tasks.filter(t=>!t.title||!t.title.trim()).length;
    const dupLinks=S.links.filter((l,i)=>S.links.findIndex(x=>x.url===l.url)<i).length;
    const orphanSpecs=S.specs.filter(s=>s.projectId&&!(S.projects||[]).find(p=>p.id===s.projectId)).length;
    const oldBlocked=S.tasks.filter(t=>t.status==='blocked'&&t.created&&(Date.now()-new Date(t.created).getTime())>14*86400000).length;
    const noTagTasks=S.tasks.filter(t=>t.status!=='done'&&(!t.tags||!t.tags.length)).length;
    const noDueTasks=S.tasks.filter(t=>t.status!=='done'&&!t.due).length;
    const issues=[];
    if(pct>80)issues.push('Storage '+pct+'% full ('+kb+'KB/'+maxKB+'KB)');
    if(emptyTasks)issues.push(emptyTasks+' empty tasks');
    if(dupLinks)issues.push(dupLinks+' duplicate links');
    if(orphanSpecs)issues.push(orphanSpecs+' orphan specs');
    if(oldBlocked)issues.push(oldBlocked+' tasks blocked 14+ days');
    items.unshift({title:'Health: '+(issues.length?issues.length+' issues':'All good!'),desc:'Storage: '+kb+'KB ('+pct+'%) | '+S.tasks.length+' tasks | '+S.content.length+' content | '+S.docs.length+' docs',icon:issues.length?'!':'*',type:'info'});
    if(noDueTasks>5)items.push({title:noDueTasks+' active tasks without due dates',desc:'Consider adding dates for better planning',icon:'T',type:'info'});
    if(noTagTasks>10)items.push({title:noTagTasks+' active tasks without tags',desc:'Tags help with filtering and organization',icon:'T',type:'info'});
    issues.forEach(issue=>{items.push({title:issue,desc:'Click to run cleanup',icon:'!',type:'action',action:()=>{closeCommandPalette();openCommandPalette();document.getElementById('cmd-input').value='clean:';document.getElementById('cmd-input').dispatchEvent(new Event('input'));}});});
  }
  // Merge prefix — find similar tasks to merge
  if(ql && ql.startsWith('merge:')){
    const mq=q.substring(6).trim().toLowerCase();
    if(!mq||mq.length<2){items.unshift({title:'Usage: merge:keyword',desc:'Find similar tasks to merge (keeps first, deletes rest)',icon:'M',type:'info'});}
    else{const hits=S.tasks.filter(t=>t.title.toLowerCase().includes(mq));
    if(hits.length<2){items.unshift({title:'Need 2+ matching tasks to merge (found '+hits.length+')',desc:'Try a broader keyword',icon:'M',type:'info'});}
    else{items.unshift({title:'Found '+hits.length+' tasks matching "'+mq+'"',desc:'Click to merge into first match',icon:'M',type:'info'});
    items.push({title:'Merge all '+hits.length+' into: '+hits[0].title,desc:'Keeps first, combines descriptions/subtasks, deletes rest',icon:'M',type:'action',action:()=>{
      closeCommandPalette();const keep=hits[0];const rest=hits.slice(1);
      rest.forEach(t=>{if(t.description)keep.description=(keep.description||'')+'\n---\n'+t.description;if(t.subtasks&&t.subtasks.length){if(!keep.subtasks)keep.subtasks=[];keep.subtasks=keep.subtasks.concat(t.subtasks);}if(t.tags&&t.tags.length){if(!keep.tags)keep.tags=[];t.tags.forEach(tag=>{if(!keep.tags.includes(tag))keep.tags.push(tag);});}});
      S.tasks=S.tasks.filter(t=>!rest.includes(t));save();renderTasks();toast('Merged '+rest.length+' tasks into "'+keep.title+'"');
    }});
    hits.forEach(t=>{items.push({title:t.title,desc:t.status+' | '+t.priority+' | '+(t.project||''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}}
  }
  // Timeline prefix — chronological task overview
  if(ql && (ql.startsWith('timeline:') || ql==='timeline' || ql==='gantt')){
    const active=S.tasks.filter(t=>t.status!=='done'&&t.due).sort((a,b)=>a.due.localeCompare(b.due));
    const today=new Date().toISOString().split('T')[0];
    if(!active.length){items.unshift({title:'No tasks with due dates',desc:'Add due dates to see timeline',icon:'T',type:'info'});}
    else{
      items.unshift({title:'Timeline: '+active.length+' scheduled tasks',desc:'Sorted by due date',icon:'T',type:'info'});
      let lastMonth='';
      active.slice(0,15).forEach(t=>{
        const m=t.due.substring(0,7);const mLabel=new Date(t.due+'T12:00:00').toLocaleDateString('en-US',{month:'long',year:'numeric'});
        const isOverdue=t.due<today;const isToday=t.due===today;
        const prefix=isOverdue?'OVERDUE':isToday?'TODAY':t.due;
        items.push({title:prefix+': '+t.title,desc:t.priority+' | '+(t.project||'no project')+' | '+t.status,icon:isOverdue?'!':isToday?'*':'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
      });
    }
  }
  // Rename prefix — rename projects/tags globally
  if(ql && ql.startsWith('rename:')){
    const rq=q.substring(7).trim();
    if(!rq){items.unshift({title:'Usage: rename:old:new',desc:'Renames project names or tags across all sections',icon:'R',type:'info'});}
    else{const parts=rq.split(':');if(parts.length>=2){const old=parts[0].trim(),nw=parts[1].trim();
    if(old&&nw){
      const projCount=S.tasks.filter(t=>t.project===old).length;
      const tagCountT=S.tasks.filter(t=>(t.tags||[]).includes(old)).length;
      const tagCountC=S.content.filter(c=>(c.tags||[]).includes(old)).length;
      if(projCount)items.push({title:'Rename project "'+old+'" to "'+nw+'" ('+projCount+' tasks)',desc:'Updates all task project fields',icon:'R',type:'action',action:()=>{closeCommandPalette();S.tasks.forEach(t=>{if(t.project===old)t.project=nw;});save();renderTasks();toast('Renamed project in '+projCount+' tasks');}});
      if(tagCountT)items.push({title:'Rename task tag "'+old+'" to "'+nw+'" ('+tagCountT+' tasks)',desc:'Updates tag across all tasks',icon:'R',type:'action',action:()=>{closeCommandPalette();S.tasks.forEach(t=>{if(t.tags){const i=t.tags.indexOf(old);if(i>=0)t.tags[i]=nw;}});save();renderTasks();toast('Renamed tag in '+tagCountT+' tasks');}});
      if(tagCountC)items.push({title:'Rename content tag "'+old+'" to "'+nw+'" ('+tagCountC+' items)',desc:'Updates tag across all content',icon:'R',type:'action',action:()=>{closeCommandPalette();S.content.forEach(c=>{if(c.tags){const i=c.tags.indexOf(old);if(i>=0)c.tags[i]=nw;}});save();renderContent();toast('Renamed tag in '+tagCountC+' content items');}});
      if(!projCount&&!tagCountT&&!tagCountC)items.unshift({title:'No matches for "'+old+'"',desc:'Nothing to rename',icon:'R',type:'info'});
    }}else{items.unshift({title:'Usage: rename:old:new',desc:'Example: rename:myproject:new-name',icon:'R',type:'info'});}}
  }
  // Week prefix — upcoming week tasks breakdown
  if(ql && (ql.startsWith('week:') || ql==='week' || ql==='weekly')){
    const active=S.tasks.filter(t=>t.status!=='done'&&t.due);
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const days=[];for(let i=0;i<7;i++){const d=new Date();d.setDate(d.getDate()+i);days.push(d.toISOString().split('T')[0]);}
    const noDue=S.tasks.filter(t=>t.status!=='done'&&!t.due).length;
    items.unshift({title:'Week ahead: '+active.filter(t=>days.includes(t.due)).length+' tasks scheduled',desc:noDue+' tasks have no due date',icon:'W',type:'info'});
    days.forEach(d=>{const dayTasks=active.filter(t=>t.due===d);const dt=new Date(d+'T12:00:00');const label=dayNames[dt.getDay()]+' '+dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});if(dayTasks.length){dayTasks.forEach((t,i)=>{items.push({title:(i===0?label+': ':'')+t.title,desc:t.priority+' | '+(t.project||'')+(t.estimate?' | '+t.estimate:''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}else{items.push({title:label+': (free)',desc:'No tasks scheduled',icon:'-',type:'info'});}});
  }
  // Focus prefix — urgent/critical tasks at a glance
  if(ql && (ql.startsWith('focus:') || ql==='focus' || ql==='urgent')){
    const today=new Date().toISOString().split('T')[0];
    const active=S.tasks.filter(t=>t.status!=='done');
    const p0=active.filter(t=>t.priority==='p0');
    const p1=active.filter(t=>t.priority==='p1');
    const overdue=active.filter(t=>t.due&&t.due<today);
    const dueToday=active.filter(t=>t.due===today);
    const blocked=active.filter(t=>t.status==='blocked');
    items.unshift({title:'Focus: '+p0.length+' P0, '+p1.length+' P1, '+overdue.length+' overdue',desc:dueToday.length+' due today | '+blocked.length+' blocked | '+active.length+' total active',icon:'!',type:'info'});
    overdue.forEach(t=>{items.push({title:'OVERDUE: '+t.title,desc:(t.due||'')+' | '+t.priority+' | '+(t.project||''),icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    p0.filter(t=>!overdue.includes(t)).forEach(t=>{items.push({title:'P0: '+t.title,desc:t.status+' | '+(t.due||'no date')+' | '+(t.project||''),icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    p1.filter(t=>!overdue.includes(t)).slice(0,5).forEach(t=>{items.push({title:'P1: '+t.title,desc:t.status+' | '+(t.due||'no date')+' | '+(t.project||''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Daily activity log prefix
  if(ql && (ql.startsWith('daily:') || ql==='daily' || ql==='activity')){
    const todayStr=new Date().toISOString().split('T')[0];
    const doneToday=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(todayStr));
    const createdToday=S.tasks.filter(t=>t.created&&t.created.startsWith(todayStr));
    const contentToday=S.content.filter(c=>c.created&&c.created.startsWith(todayStr));
    const docsToday=S.docs.filter(d=>d.updated&&d.updated.startsWith(todayStr));
    const linksToday=S.links.filter(l=>l.created&&l.created.startsWith(todayStr));
    items.unshift({title:'Today: '+doneToday.length+' completed, '+createdToday.length+' created',desc:'Content: '+contentToday.length+' | Docs edited: '+docsToday.length+' | Links: '+linksToday.length,icon:'*',type:'info'});
    doneToday.slice(0,5).forEach(t=>{items.push({title:'Done: '+t.title,desc:(t.project||'No project')+' | '+t.priority,icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    createdToday.filter(t=>t.status!=='done').slice(0,3).forEach(t=>{items.push({title:'New: '+t.title,desc:t.status+' | '+t.priority,icon:'+',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Clean prefix — data cleanup actions
  if(ql && (ql.startsWith('clean:') || ql==='clean' || ql==='cleanup')){
    const emptyTasks=S.tasks.filter(t=>!t.title||!t.title.trim()).length;
    if(emptyTasks)items.unshift({title:'Remove '+emptyTasks+' empty tasks',desc:'Tasks with no title',icon:'x',type:'action',action:()=>{closeCommandPalette();S.tasks=S.tasks.filter(t=>t.title&&t.title.trim());save();renderTasks();toast('Removed '+emptyTasks+' empty tasks');}});
    const dupLinks=S.links.filter((l,i)=>S.links.findIndex(x=>x.url===l.url)<i).length;
    if(dupLinks)items.unshift({title:'Remove '+dupLinks+' duplicate links',desc:'Links with identical URLs',icon:'x',type:'action',action:()=>{closeCommandPalette();const seen=new Set();S.links=S.links.filter(l=>{if(seen.has(l.url))return false;seen.add(l.url);return true;});save();renderLinks();toast('Removed '+dupLinks+' duplicate links');}});
    const emptyDocs=S.docs.filter(d=>(!d.body||d.body.trim().length<5)&&(!d.title||d.title==='Untitled')).length;
    if(emptyDocs)items.unshift({title:'Remove '+emptyDocs+' empty documents',desc:'Untitled docs with no content',icon:'x',type:'action',action:()=>{closeCommandPalette();S.docs=S.docs.filter(d=>!(!d.body||d.body.trim().length<5)||!(d.title==='Untitled'||!d.title));save();renderDocList();toast('Removed '+emptyDocs+' empty docs');}});
    const oldDoneTasks=S.tasks.filter(t=>t.status==='done'&&t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())>30*86400000).length;
    if(oldDoneTasks)items.unshift({title:'Archive '+oldDoneTasks+' old completed tasks',desc:'Done tasks completed over 30 days ago',icon:'A',type:'action',action:()=>{closeCommandPalette();const old=S.tasks.filter(t=>t.status==='done'&&t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())>30*86400000);if(!S.archivedTasks)S.archivedTasks=[];S.archivedTasks=old.concat(S.archivedTasks);S.tasks=S.tasks.filter(t=>!old.includes(t));save();renderTasks();toast('Archived '+old.length+' old tasks');}});
    if(!emptyTasks&&!dupLinks&&!emptyDocs&&!oldDoneTasks)items.unshift({title:'All clean!',desc:'No cleanup actions needed',icon:'*',type:'info'});
  }
  // Project stats prefix
  if(ql && (ql.startsWith('project-stats:') || ql==='project-stats' || ql==='projects')){
    const psq=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
    const projs=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    const filtered=psq?projs.filter(p=>p.toLowerCase().includes(psq)):projs;
    filtered.slice(0,8).forEach(p=>{
      const tasks=S.tasks.filter(t=>t.project===p);const active=tasks.filter(t=>t.status!=='done').length;const done=tasks.filter(t=>t.status==='done').length;
      const docs=S.docs.filter(d=>(d.tags||[]).includes(p.toLowerCase())).length;const specs=S.specs.filter(s=>{const proj=(S.projects||[]).find(x=>x.id===s.projectId);return proj&&proj.name===p;}).length;
      const tm=tasks.reduce((a,t)=>a+(t.timeSpent||0),0);const pct=tasks.length?Math.round(done/tasks.length*100):0;
      items.unshift({title:p+' ('+pct+'%)',desc:active+' active, '+done+' done | '+specs+' specs'+(tm?' | '+formatTimeSpent(tm)+' tracked':''),icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p;renderTasks();}});
    });
    if(!filtered.length)items.unshift({title:'No projects found',desc:'Tasks have no project assignments',icon:'!',type:'info'});
  }
  // Dependency chain prefix
  if(ql && (ql.startsWith('deps:') || ql==='deps' || ql==='dependencies')){
    const blocked=S.tasks.filter(t=>t.blockedBy&&t.status!=='done');
    const blocking=S.tasks.filter(t=>{const tl=t.title.toLowerCase();return S.tasks.some(x=>x.blockedBy&&x.blockedBy.toLowerCase().includes(tl)&&x.status!=='done');});
    if(blocked.length){blocked.forEach(t=>{items.unshift({title:'BLOCKED: '+t.title,desc:'Blocked by: '+t.blockedBy,icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}
    if(blocking.length){blocking.forEach(t=>{const deps=S.tasks.filter(x=>x.blockedBy&&x.blockedBy.toLowerCase().includes(t.title.toLowerCase())&&x.status!=='done');items.unshift({title:'BLOCKING ('+deps.length+'): '+t.title,desc:'Blocks: '+deps.map(d=>d.title).join(', ').substring(0,80),icon:'B',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}
    if(!blocked.length&&!blocking.length)items.unshift({title:'No dependencies found',desc:'No tasks are blocked or blocking others',icon:'*',type:'info'});
  }
  // Chart prefix
  if(ql && (ql.startsWith('chart:') || ql==='chart' || ql==='charts')){
    const cq=ql.startsWith('chart:')?q.substring(6).trim().toLowerCase():'status';
    const svgW=300;const svgH=160;const cx=80;const cy=80;const rad=60;
    let data=[];
    if(cq==='priority'||cq==='p'){
      data=[{label:'P0 Critical',value:S.tasks.filter(t=>t.priority==='p0'&&t.status!=='done').length,color:'#ef4444'},{label:'P1 High',value:S.tasks.filter(t=>t.priority==='p1'&&t.status!=='done').length,color:'#f97316'},{label:'P2 Medium',value:S.tasks.filter(t=>(t.priority==='p2'||!t.priority)&&t.status!=='done').length,color:'#eab308'},{label:'P3 Low',value:S.tasks.filter(t=>t.priority==='p3'&&t.status!=='done').length,color:'#6b7280'}];
    }else if(cq==='project'){
      const projs=[...new Set(S.tasks.map(t=>t.project||'No Project'))].sort();
      const pColors=['#4ade80','#22d3ee','#a855f7','#f472b6','#fbbf24','#f87171','#60a5fa','#34d399'];
      data=projs.slice(0,8).map((p,i)=>({label:p,value:S.tasks.filter(t=>(t.project||'No Project')===p&&t.status!=='done').length,color:pColors[i%pColors.length]}));
    }else{
      data=[{label:'To Do',value:S.tasks.filter(t=>t.status==='todo').length,color:'#22d3ee'},{label:'In Progress',value:S.tasks.filter(t=>t.status==='progress').length,color:'#4ade80'},{label:'Done',value:S.tasks.filter(t=>t.status==='done').length,color:'#6b7280'},{label:'Blocked',value:S.tasks.filter(t=>t.status==='blocked').length,color:'#f97316'}];
    }
    const total=data.reduce((a,d)=>a+d.value,0);
    if(total){let angle=-Math.PI/2;
      let svgParts=data.filter(d=>d.value).map(d=>{const pct=d.value/total;const sa=angle;const ea=angle+pct*Math.PI*2;const la=ea-sa>Math.PI?1:0;const x1=cx+rad*Math.cos(sa);const y1=cy+rad*Math.sin(sa);const x2=cx+rad*Math.cos(ea-0.001);const y2=cy+rad*Math.sin(ea-0.001);angle=ea;return`<path d="M${cx},${cy}L${x1},${y1}A${rad},${rad} 0 ${la} 1 ${x2},${y2}Z" fill="${d.color}" opacity="0.8"/>`;}).join('');
      const legend=data.filter(d=>d.value).map((d,i)=>`<g transform="translate(170,${20+i*18})"><rect width="8" height="8" rx="2" fill="${d.color}"/><text x="12" y="8" fill="var(--text-muted)" font-size="9" font-family="var(--mono)">${d.label}: ${d.value}</text></g>`).join('');
      items.unshift({title:'Task Chart (by '+(cq==='priority'||cq==='p'?'Priority':cq==='project'?'Project':'Status')+')',desc:'<svg xmlns="http://www.w3.org/2000/svg" width="'+svgW+'" height="'+svgH+'">'+svgParts+legend+'</svg>',icon:'C',type:'info'});
    }
    items.unshift({title:'chart:status',desc:'Pie chart by status',icon:'C',type:'info'});
    items.unshift({title:'chart:priority',desc:'Pie chart by priority',icon:'C',type:'info'});
    items.unshift({title:'chart:project',desc:'Pie chart by project',icon:'C',type:'info'});
  }
  // Config prefix
  if(ql && (ql.startsWith('config:') || ql==='config' || ql==='settings' || ql==='prefs')){
    if(!S.config)S.config={};
    items.unshift({title:'Word Goal: '+(S.wordGoal?.daily||500)+'/day',desc:'Type config:wordgoal:N to change',icon:'C',type:'action',action:()=>{const v=prompt('Daily word goal:',S.wordGoal?.daily||500);if(v&&parseInt(v)){if(!S.wordGoal)S.wordGoal={daily:500,log:{}};S.wordGoal.daily=parseInt(v);save();toast('Word goal: '+v);closeCommandPalette();}}});
    items.unshift({title:'Auto-save: '+(S.config.autoSaveMs||800)+'ms',desc:'Debounce interval for auto-save',icon:'C',type:'action',action:()=>{const v=prompt('Auto-save debounce (ms):',S.config.autoSaveMs||800);if(v&&parseInt(v)){S.config.autoSaveMs=parseInt(v);save();toast('Auto-save: '+v+'ms');closeCommandPalette();}}});
    items.unshift({title:'Board WIP limit: '+(S.config.wipLimit||5),desc:'Maximum tasks in "In Progress" before warning',icon:'C',type:'action',action:()=>{const v=prompt('WIP limit for In Progress:',S.config.wipLimit||5);if(v&&parseInt(v)){S.config.wipLimit=parseInt(v);save();toast('WIP limit: '+v);closeCommandPalette();}}});
    items.unshift({title:'Quick-add syntax: title #tag @project !priority ~date',desc:'Available modifiers in task quick-add input',icon:'?',type:'info'});
    items.unshift({title:'Data size: '+Math.round(JSON.stringify(S).length/1024)+'KB',desc:'Tasks: '+S.tasks.length+' | Content: '+S.content.length+' | Docs: '+S.docs.length,icon:'B',type:'info'});
  }
  // Word goal prefix
  if(ql && (ql.startsWith('wordgoal:') || ql==='wordgoal' || ql==='wgoal')){
    if(!S.wordGoal)S.wordGoal={daily:500,log:{}};
    const today=new Date().toISOString().split('T')[0];
    const gq=ql.startsWith('wordgoal:')?q.substring(9).trim():'';
    if(gq&&parseInt(gq)){S.wordGoal.daily=parseInt(gq);save();items.unshift({title:'Daily word goal set to '+S.wordGoal.daily,desc:'Track your writing across docs and content',icon:'*',type:'info'});}
    else{
      const todayWords=(()=>{let wc=0;S.docs.forEach(d=>{if(d.updated&&d.updated.startsWith(today))wc+=countW(d.body);});S.content.forEach(c=>{if(c.created&&c.created.startsWith(today))wc+=(c.body||'').trim().split(/\s+/).filter(x=>x.length).length;});return wc;})();
      const pct=S.wordGoal.daily?Math.round(todayWords/S.wordGoal.daily*100):0;
      items.unshift({title:'Today: '+todayWords+'/'+S.wordGoal.daily+' words ('+pct+'%)',desc:pct>=100?'Goal reached!':''+Math.max(0,S.wordGoal.daily-todayWords)+' words to go',icon:pct>=100?'*':'W',type:'info'});
      const last7=[];for(let i=0;i<7;i++){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];let wc=0;S.docs.forEach(doc=>{if(doc.updated&&doc.updated.startsWith(ds))wc+=countW(doc.body);});S.content.forEach(c=>{if(c.created&&c.created.startsWith(ds))wc+=(c.body||'').trim().split(/\s+/).filter(x=>x.length).length;});last7.push({day:ds,words:wc});}
      const weekTotal=last7.reduce((a,d)=>a+d.words,0);const avgDaily=Math.round(weekTotal/7);
      items.unshift({title:'This week: '+weekTotal+' words (avg '+avgDaily+'/day)',desc:'Type wordgoal:N to set daily goal (current: '+S.wordGoal.daily+')',icon:'W',type:'info'});
    }
  }
  // Review prefix
  if(ql && (ql.startsWith('review:') || ql==='review' || ql==='stale')){
    const today=new Date();const todayStr=today.toISOString().split('T')[0];
    const staleDays=14;const staleDate=new Date(today.getTime()-staleDays*86400000).toISOString();
    const staleTasks=S.tasks.filter(t=>t.status==='progress'&&t.created&&t.created<staleDate);
    const untitledDocs=S.docs.filter(d=>!d.title||d.title==='Untitled');
    const emptySpecs=S.specs.filter(s=>(s.sections||[]).every(sec=>!sec.body||sec.body.trim().length<10));
    const readLater=S.content.filter(c=>c.readLater);
    const noDescTasks=S.tasks.filter(t=>!t.description&&t.status!=='done').slice(0,5);
    if(staleTasks.length)staleTasks.slice(0,5).forEach(t=>{items.unshift({title:'Stale ('+timeAgo(t.created)+'): '+t.title,desc:'In progress for '+Math.round((today-new Date(t.created))/86400000)+'+ days',icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    if(untitledDocs.length)items.unshift({title:untitledDocs.length+' untitled documents',desc:'Documents without proper titles need naming',icon:'W',type:'info'});
    if(emptySpecs.length)items.unshift({title:emptySpecs.length+' specs with empty sections',desc:'Living docs needing content',icon:'S',type:'info'});
    if(readLater.length)items.unshift({title:readLater.length+' items in Read Later',desc:'Content marked for later review',icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);contentReadLaterFilter=true;const btn=document.getElementById('content-rl-btn');if(btn)btn.style.color='var(--accent-cyan)';renderContent();}});
    if(noDescTasks.length)items.unshift({title:noDescTasks.length+'+ tasks without description',desc:'Active tasks missing context/details',icon:'T',type:'info'});
    if(!staleTasks.length&&!untitledDocs.length&&!emptySpecs.length&&!readLater.length)items.unshift({title:'Nothing to review',desc:'All items are in good shape',icon:'*',type:'info'});
  }
  // Goal tracker prefix
  if(ql && (ql.startsWith('goal:') || ql==='goal' || ql==='goals')){
    if(!S.goals)S.goals=[];
    const gq=ql.startsWith('goal:')?q.substring(5).trim():'';
    if(gq && gq.startsWith('+')){
      const parts=gq.substring(1).trim().split('/');
      const name=parts[0]?.trim();const target=parseInt(parts[1])||100;const unit=parts[2]?.trim()||'';
      if(name){items.unshift({title:'Create goal: '+name+' (0/'+target+(unit?' '+unit:'')+')',desc:'Add new trackable goal',icon:'+',type:'action',action:()=>{S.goals.push({id:Date.now(),name,target,current:0,unit,created:new Date().toISOString()});save();toast('Goal created: '+name);closeCommandPalette();}});}
    }else{
      S.goals.forEach(g=>{
        const pct=g.target?Math.round((g.current/g.target)*100):0;
        const barW=80;const fillW=Math.min(Math.round((pct/100)*barW),barW);
        items.unshift({title:g.name+' ('+g.current+'/'+g.target+(g.unit?' '+g.unit:'')+') '+pct+'%',desc:'Click to increment | goal:+1 / goal:-1 to adjust',icon:'G',type:'action',action:()=>{
          const adj=prompt('Adjust "'+g.name+'" ('+g.current+'/'+g.target+')\nEnter new value or +/-N:','+'+(g.target>10?1:Math.ceil(g.target/10)));
          if(!adj)return;
          if(adj.startsWith('+'))g.current=Math.min(g.current+parseInt(adj.substring(1))||1,g.target);
          else if(adj.startsWith('-'))g.current=Math.max(g.current-(parseInt(adj.substring(1))||1),0);
          else g.current=Math.max(0,Math.min(parseInt(adj)||0,g.target));
          if(g.current>=g.target)toast('Goal completed: '+g.name+'!');
          save();closeCommandPalette();
        }});
      });
      if(!S.goals.length)items.unshift({title:'No goals yet',desc:'Type goal:+name/target/unit (e.g. goal:+Book chapters/12/chapters)',icon:'!',type:'info'});
    }
  }
  // Habit tracker prefix
  if(ql && (ql.startsWith('habit:') || ql==='habit' || ql==='habits')){
    if(!S.habits)S.habits=[];
    const today=new Date().toISOString().split('T')[0];
    const hq=ql.startsWith('habit:')?q.substring(6).trim():'';
    if(hq && hq.startsWith('+')){
      const name=hq.substring(1).trim();
      if(name){items.unshift({title:'Create habit: '+name,desc:'Add new daily habit',icon:'+',type:'action',action:()=>{S.habits.push({id:Date.now(),name,log:[]});save();toast('Habit created: '+name);closeCommandPalette();}});}
    }else{
      S.habits.forEach(h=>{
        const checkedToday=(h.log||[]).includes(today);
        const streak=(()=>{let s=0;const d=new Date();for(let i=0;i<30;i++){const ds=d.toISOString().split('T')[0];if((h.log||[]).includes(ds))s++;else if(i>0)break;d.setDate(d.getDate()-1);}return s;})();
        const last7=(()=>{const d=new Date();let c=0;for(let i=0;i<7;i++){const ds=d.toISOString().split('T')[0];if((h.log||[]).includes(ds))c++;d.setDate(d.getDate()-1);}return c;})();
        items.unshift({title:(checkedToday?'[x] ':'[ ] ')+h.name,desc:streak+' day streak | '+last7+'/7 this week'+(hq&&hq.startsWith('-')?' | click to delete':''),icon:'H',type:'action',action:()=>{
          if(hq&&hq.startsWith('-')){S.habits=S.habits.filter(x=>x.id!==h.id);save();toast('Deleted: '+h.name);}
          else{if(checkedToday){h.log=h.log.filter(d=>d!==today);}else{if(!h.log)h.log=[];h.log.push(today);}save();toast(checkedToday?'Unchecked: '+h.name:'Checked: '+h.name);}
          closeCommandPalette();
        }});
      });
      if(!S.habits.length)items.unshift({title:'No habits yet',desc:'Type habit:+name to create one (e.g. habit:+exercise)',icon:'!',type:'info'});
    }
  }
  // Activity log prefix
  if(ql && (ql.startsWith('log:') || ql==='log' || ql==='activity')){
    const events=[];
    S.tasks.forEach(t=>{if(t.created)events.push({time:t.created,text:'Task: '+t.title,type:'task',icon:'T'});if(t.log)t.log.forEach(e=>{if(e.at)events.push({time:e.at,text:t.title+' -> '+e.to,type:'task',icon:'T'});});});
    S.content.forEach(c=>{if(c.created)events.push({time:c.created,text:'Content: '+(c.title||c.body.substring(0,40)),type:'content',icon:'C'});});
    S.docs.forEach(d=>{if(d.updated)events.push({time:d.updated,text:'Doc: '+(d.title||'Untitled'),type:'doc',icon:'W'});else if(d.created)events.push({time:d.created,text:'Doc: '+(d.title||'Untitled'),type:'doc',icon:'W'});});
    S.links.forEach(l=>{if(l.created)events.push({time:l.created,text:'Link: '+(l.title||l.url),type:'link',icon:'L'});});
    events.sort((a,b)=>b.time.localeCompare(a.time));
    const lq=ql.startsWith('log:')?q.substring(4).trim().toLowerCase():'';
    const filtered=lq?events.filter(e=>e.text.toLowerCase().includes(lq)):events;
    filtered.slice(0,15).forEach(e=>{items.unshift({title:e.text,desc:timeAgo(e.time)+' | '+e.type,icon:e.icon,type:'info'});});
    if(!filtered.length)items.unshift({title:'No activity found',desc:'System activity log is empty',icon:'!',type:'info'});
  }
  // Focus timer prefix
  if(ql && (ql.startsWith('focus:') || ql==='focus' || ql==='pomodoro')){
    const fq=ql.startsWith('focus:')?q.substring(6).trim():'';
    const mins=parseInt(fq)||25;
    if(focusTimerInterval){
      const rem=Math.max(0,focusTimerEnd-Date.now());const m=Math.floor(rem/60000);const s=Math.floor((rem%60000)/1000);
      items.unshift({title:'Focus timer running: '+m+':'+String(s).padStart(2,'0'),desc:'Click to stop',icon:'F',type:'action',action:()=>{closeCommandPalette();stopFocusTimer();toast('Focus timer stopped');}});
    }else{
      const active=S.tasks.filter(t=>t.status==='progress');
      active.slice(0,5).forEach(t=>{
        items.unshift({title:'Focus on: '+t.title+' ('+mins+'min)',desc:'Start focus timer and track time to this task',icon:'F',type:'action',action:()=>{closeCommandPalette();startFocusTimer(t.id,mins);}});
      });
      items.unshift({title:'Focus timer: '+mins+' minutes (no task)',desc:'Type focus:N for custom minutes (default 25)',icon:'F',type:'action',action:()=>{closeCommandPalette();startFocusTimer(null,mins);}});
    }
  }
  // Writer stats prefix
  if(ql && (ql==='writerstats' || ql==='ws' || ql.startsWith('writerstats:'))){
    const totalWords=S.docs.reduce((a,d)=>a+countW(d.body),0);
    const totalDocs=S.docs.length;
    const avgWords=totalDocs?Math.round(totalWords/totalDocs):0;
    const longestDoc=S.docs.reduce((best,d)=>countW(d.body)>countW(best.body)?d:best,S.docs[0]||{body:''});
    const versionsTotal=S.docs.reduce((a,d)=>a+(d.versions||[]).length,0);
    const today=new Date().toISOString().split('T')[0];
    const todayEdited=S.docs.filter(d=>d.updated&&d.updated.startsWith(today)).length;
    const last7Docs=(()=>{const d=new Date();let c=0;for(let i=0;i<7;i++){const ds=d.toISOString().split('T')[0];c+=S.docs.filter(doc=>doc.updated&&doc.updated.startsWith(ds)).length;d.setDate(d.getDate()-1);}return c;})();
    const readTime=Math.max(1,Math.ceil(totalWords/238));
    items.unshift({title:'Today: '+todayEdited+' docs edited | This week: '+last7Docs+' updates',desc:'Versions saved: '+versionsTotal,icon:'W',type:'info'});
    items.unshift({title:'Average: '+avgWords+' words/doc | Read time: ~'+readTime+'min',desc:'Longest: '+(longestDoc.title||'Untitled')+' ('+countW(longestDoc.body)+'w)',icon:'W',type:'info'});
    items.unshift({title:'Writer Stats: '+totalDocs+' docs / '+totalWords.toLocaleString()+' words',desc:'Comprehensive writing statistics',icon:'W',type:'info'});
  }
  // Whiteboard search prefix
  if(ql && ql.startsWith('wb:')){
    const wbq=q.substring(3).trim().toLowerCase();
    if(wbq && S.wbNodes){
      const matches=S.wbNodes.filter(n=>(n.t||'').toLowerCase().includes(wbq)||(n.b||'').toLowerCase().includes(wbq));
      matches.slice(0,10).forEach(n=>{
        items.unshift({title:'WB: '+(n.t||'Node'),desc:(n.b||'').substring(0,80),icon:'W',type:'action',action:()=>{closeCommandPalette();switchSection('whiteboard',null);setTimeout(()=>{const el=document.querySelector('[data-wb-id="'+n.id+'"]');if(el){el.style.outline='3px solid var(--accent)';el.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>{el.style.outline='';},3000);}},300);}});
      });
      if(!matches.length)items.unshift({title:'No whiteboard nodes match "'+wbq+'"',desc:'Try a different search term',icon:'!',type:'info'});
    }else{items.unshift({title:'Type wb:searchterm to find whiteboard nodes',desc:'Searches node titles and body text',icon:'W',type:'info'});}
  }
  // Count prefix
  if(ql && ql.startsWith('count:')){
    const active=S.tasks.filter(t=>t.status!=='done').length;const done=S.tasks.filter(t=>t.status==='done').length;
    items.unshift({title:'Tasks: '+active+' active, '+done+' done ('+S.tasks.length+' total)',desc:'Content: '+S.content.length+' | Docs: '+S.docs.length+' | Specs: '+S.specs.length+' | Links: '+S.links.length+' | Repos: '+(S.repos||[]).length,icon:'#',type:'info'});
  }
  // Recent items from Cmd+K
  if(ql && ql.startsWith('recent:') || (!ql && recentItems.length)){
    const rq=ql&&ql.startsWith('recent:')?q.substring(7).trim().toLowerCase():'';
    const ri=rq?recentItems.filter(r=>r.title.toLowerCase().includes(rq)):recentItems;
    ri.slice(0,8).forEach(r=>{
      const sMap={task:'T',doc:'W',spec:'S',project:'P'};
      items.unshift({title:r.title,desc:'Recent '+r.type+' ('+timeAgo(r.time)+')',icon:sMap[r.type]||'*',type:'action',action:()=>{closeCommandPalette();if(r.type==='task')openTaskDetail(r.id);else if(r.type==='doc'){switchDoc(r.id);switchSection('writer',null);}else if(r.type==='spec'){switchSpec(r.id);switchSection('specs',null);}else if(r.type==='project')openProject(r.id);}});
    });
  }
  // Backup prefix
  if(ql && (ql==='backup' || ql.startsWith('backup:') || ql==='backups')){
    const dataSize=JSON.stringify(S).length;const kb=Math.round(dataSize/1024);
    const lastBackup=S._lastBackup||null;
    items.unshift({title:'Download Full Backup ('+kb+'KB)',desc:'JSON file with all data',icon:'B',type:'action',action:()=>{closeCommandPalette();const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='astra-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();S._lastBackup=new Date().toISOString();save();toast('Backup downloaded');}});
    items.unshift({title:'Restore from Backup',desc:'Upload a JSON backup file',icon:'B',type:'action',action:()=>{closeCommandPalette();const input=document.createElement('input');input.type='file';input.accept='.json';input.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const data=JSON.parse(ev.target.result);if(!data.tasks&&!data.content){toast('Invalid backup file');return;}if(!confirm('Restore backup? This replaces ALL current data.'))return;Object.assign(S,data);save();location.reload();}catch(err){toast('Invalid JSON file');}};r.readAsText(f);};input.click();}});
    items.unshift({title:'Data: '+S.tasks.length+'T / '+S.content.length+'C / '+S.docs.length+'D / '+S.links.length+'L',desc:(lastBackup?'Last backup: '+timeAgo(lastBackup):'No backup yet')+' | Size: '+kb+'KB',icon:'i',type:'info'});
  }
  // Sentiment prefix
  if(ql && (ql==='sentiment' || ql.startsWith('sentiment:') || ql==='mood' || ql==='tone')){
    const posWords=new Set(['great','good','amazing','excellent','love','happy','success','win','perfect','best','awesome','beautiful','wonderful','fantastic','brilliant','incredible']);
    const negWords=new Set(['bad','terrible','awful','hate','fail','wrong','broken','worst','ugly','problem','error','bug','issue','stuck','frustrated','angry']);
    let posCount=0,negCount=0,total=0;
    S.content.forEach(c=>{const words=(c.body||'').toLowerCase().split(/\s+/);words.forEach(w=>{const clean=w.replace(/[^a-z]/g,'');if(posWords.has(clean))posCount++;if(negWords.has(clean))negCount++;total++;});});
    const sentiment=posCount>negCount*1.5?'Positive':negCount>posCount*1.5?'Negative':'Neutral';
    const color=sentiment==='Positive'?'var(--accent)':sentiment==='Negative'?'var(--red)':'var(--yellow)';
    items.unshift({title:'Content Mood: '+sentiment,desc:posCount+' positive words, '+negCount+' negative words ('+S.content.length+' items, '+total+' total words)',icon:'M',type:'info'});
    const topPos=[];const topNeg=[];S.content.forEach(c=>{let p=0,n=0;(c.body||'').toLowerCase().split(/\s+/).forEach(w=>{const cl=w.replace(/[^a-z]/g,'');if(posWords.has(cl))p++;if(negWords.has(cl))n++;});if(p>n&&p>2)topPos.push({c,score:p});if(n>p&&n>2)topNeg.push({c,score:n});});
    topPos.sort((a,b)=>b.score-a.score).slice(0,3).forEach(x=>{items.unshift({title:'Positive: '+(x.c.body||'').substring(0,50)+'...',desc:x.score+' positive words',icon:'+',type:'info'});});
    topNeg.sort((a,b)=>b.score-a.score).slice(0,3).forEach(x=>{items.unshift({title:'Negative: '+(x.c.body||'').substring(0,50)+'...',desc:x.score+' negative words',icon:'-',type:'info'});});
  }
  // Timeline prefix
  if(ql && (ql==='timeline' || ql.startsWith('timeline:') || ql==='tl')){
    const days=parseInt(ql.startsWith('timeline:')?q.substring(9):'')||14;
    let tlHtml='';const now=new Date();
    for(let i=0;i<days;i++){
      const d=new Date(now);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];
      const created=S.tasks.filter(t=>t.created&&t.created.startsWith(ds)).length;
      const completed=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length;
      const content=S.content.filter(c=>c.created&&c.created.startsWith(ds)).length;
      const total=created+completed+content;
      if(total){const bar='|'.repeat(Math.min(total*2,20));const label=i===0?'Today':i===1?'Yesterday':ds.substring(5);tlHtml+=label.padEnd(8)+' '+bar+' +'+created+'t/'+completed+'d/'+content+'c\n';}
    }
    if(tlHtml)items.unshift({title:'Activity Timeline ('+days+' days)',desc:tlHtml.split('\n').slice(0,8).join(' / '),icon:'T',type:'info'});
    else items.unshift({title:'No activity in last '+days+' days',desc:'Type timeline:N for custom range',icon:'!',type:'info'});
  }
  // Cleanup prefix
  if(ql && (ql==='cleanup' || ql.startsWith('cleanup:') || ql==='clean')){
    const emptyTasks=S.tasks.filter(t=>!t.title||!t.title.trim());
    const dupTasks=(()=>{const seen=new Set();return S.tasks.filter(t=>{const key=t.title+'-'+t.project+'-'+t.due;if(seen.has(key))return true;seen.add(key);return false;});})();
    const oldDone=S.tasks.filter(t=>t.status==='done'&&t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())>30*86400000);
    const emptyContent=S.content.filter(c=>!c.body||c.body.trim().length<5);
    if(emptyTasks.length)items.unshift({title:'Remove '+emptyTasks.length+' empty tasks',desc:'Tasks with no title',icon:'!',type:'action',action:()=>{closeCommandPalette();S.tasks=S.tasks.filter(t=>t.title&&t.title.trim());save();renderTasks();toast('Removed '+emptyTasks.length+' empty tasks');}});
    if(dupTasks.length)items.unshift({title:'Found '+dupTasks.length+' potential duplicate tasks',desc:'Same title + project + due date',icon:'!',type:'info'});
    if(oldDone.length)items.unshift({title:'Archive '+oldDone.length+' old completed tasks (30+ days)',desc:'Move to archive to keep board clean',icon:'A',type:'action',action:()=>{closeCommandPalette();if(!S.archivedTasks)S.archivedTasks=[];S.archivedTasks=oldDone.concat(S.archivedTasks);S.tasks=S.tasks.filter(t=>!(t.status==='done'&&t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())>30*86400000));save();renderTasks();toast('Archived '+oldDone.length+' old tasks');}});
    if(emptyContent.length)items.unshift({title:'Remove '+emptyContent.length+' empty content items',desc:'Content with fewer than 5 characters',icon:'!',type:'action',action:()=>{closeCommandPalette();S.content=S.content.filter(c=>c.body&&c.body.trim().length>=5);save();renderContent();toast('Removed '+emptyContent.length+' empty items');}});
    if(!emptyTasks.length&&!dupTasks.length&&!oldDone.length&&!emptyContent.length)items.unshift({title:'Everything looks clean!',desc:'No empty tasks, no duplicates, no stale items',icon:'*',type:'info'});
  }
  // Random prefix
  if(ql && (ql==='random' || ql==='random:' || ql.startsWith('random:') || ql==='inspire' || ql==='surprise')){
    const rq=ql.startsWith('random:')?q.substring(7).trim().toLowerCase():'';
    const pool=[];
    if(!rq||rq==='task')S.tasks.filter(t=>t.status!=='done').forEach(t=>pool.push({title:t.title,desc:'Task | '+t.priority+' | '+(t.project||'No project'),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}}));
    if(!rq||rq==='content')S.content.forEach(c=>pool.push({title:(c.body||'').substring(0,60),desc:'Content | '+(c.theme||c.type||''),icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}}));
    if(!rq||rq==='doc')S.docs.forEach(d=>pool.push({title:d.title||'Untitled',desc:'Doc | '+countW(d.body)+'w',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}}));
    if(pool.length){for(let i=0;i<Math.min(5,pool.length);i++){const idx=Math.floor(Math.random()*pool.length);items.unshift(pool.splice(idx,1)[0]);}
    }else{items.unshift({title:'Nothing to randomize yet',desc:'Add tasks, content, or docs first',icon:'!',type:'info'});}
  }
  // What's next prefix
  if(ql && (ql==='next' || ql==='whatsnext' || ql==="what's next")){
    const today=new Date().toISOString().split('T')[0];
    const candidates=S.tasks.filter(t=>t.status!=='done'&&t.status!=='blocked').sort((a,b)=>{const pMap={p0:0,p1:1,p2:2,p3:3};const pDiff=(pMap[a.priority]||2)-(pMap[b.priority]||2);if(pDiff!==0)return pDiff;if(a.due&&b.due)return a.due.localeCompare(b.due);if(a.due)return -1;if(b.due)return 1;return 0;});
    candidates.slice(0,5).forEach((t,i)=>{
      items.unshift({title:(i===0?'Next up: ':'')+(t.title||'Untitled'),desc:t.priority.toUpperCase()+' | '+(t.due?'Due: '+relativeDate(t.due):'No date')+' | '+(t.project||'No project'),icon:i===0?'>':'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    if(!candidates.length)items.unshift({title:'Nothing pending',desc:'All tasks are done or blocked',icon:'*',type:'info'});
  }
  // Export hub prefix
  if(ql && (ql.startsWith('export:') || ql==='export' || ql==='exports')){
    items.unshift({title:'Export Tasks (Markdown)',desc:'Copy filtered tasks as grouped markdown',icon:'T',type:'action',action:()=>{closeCommandPalette();exportTasks();}});
    items.unshift({title:'Export Tasks (CSV)',desc:'Download tasks as spreadsheet CSV',icon:'T',type:'action',action:()=>{closeCommandPalette();exportTasksCSV();}});
    items.unshift({title:'Export Content (Markdown)',desc:'Copy all content as markdown',icon:'C',type:'action',action:()=>{closeCommandPalette();exportFilteredContentMD();}});
    items.unshift({title:'Export Content (HTML)',desc:'Download content as styled HTML file',icon:'C',type:'action',action:()=>{closeCommandPalette();exportContentHTML();}});
    items.unshift({title:'Export Links (Markdown)',desc:'Copy all links categorized as markdown',icon:'L',type:'action',action:()=>{closeCommandPalette();exportLinks();}});
    items.unshift({title:'Export Calendar Week',desc:'Copy this week summary as markdown',icon:'D',type:'action',action:()=>{closeCommandPalette();exportWeek();}});
    if(typeof exportCurrentSpecMD==='function')items.unshift({title:'Export Current Spec (Markdown)',desc:'Copy active living doc as markdown',icon:'S',type:'action',action:()=>{closeCommandPalette();exportCurrentSpecMD();}});
    items.unshift({title:'Export All Data (JSON)',desc:'Download full state backup as JSON file',icon:'*',type:'action',action:()=>{closeCommandPalette();const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='astra-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();toast('Full backup exported');}});
  }
  // Task templates prefix
  if(ql && (ql.startsWith('tpl:') || ql==='tpl' || ql==='templates')){
    const templates=[
      {title:'Daily standup review',priority:'p1',recurrence:'weekday'},
      {title:'Weekly planning session',priority:'p1',recurrence:'weekly'},
      {title:'Code review',priority:'p2',recurrence:''},
      {title:'Bug fix',priority:'p0',recurrence:''},
      {title:'Write documentation',priority:'p2',recurrence:''},
      {title:'Brainstorm session',priority:'p3',recurrence:''},
      {title:'Deploy to production',priority:'p0',recurrence:''},
      {title:'User testing',priority:'p1',recurrence:''},
    ];
    templates.forEach(tpl=>{
      items.unshift({title:'+ '+tpl.title,desc:tpl.priority.toUpperCase()+(tpl.recurrence?' ('+tpl.recurrence+')':''),icon:'+',type:'action',action:()=>{closeCommandPalette();S.tasks.unshift({id:Date.now(),title:tpl.title,description:'',subtasks:[],status:'todo',priority:tpl.priority,project:taskProjectFilter||'',due:new Date().toISOString().split('T')[0],recurrence:tpl.recurrence||'',created:new Date().toISOString()});save();if(currentSection==='tasks')renderTasks();toast('Created: '+tpl.title);}});
    });
  }
  // Deep search prefix — search across ALL sections
  if(ql && (ql.startsWith('search:') || ql.startsWith('find:') || ql.startsWith('s:'))){
    const sq=(ql.startsWith('search:')?q.substring(7):ql.startsWith('find:')?q.substring(5):q.substring(2)).trim().toLowerCase();
    if(sq.length>=2){
      S.tasks.forEach(t=>{if((t.title+' '+t.description+' '+(t.tags||[]).join(' ')+' '+t.project).toLowerCase().includes(sq)){items.unshift({title:esc(t.title||'Untitled'),desc:'Task | '+t.status+' | '+(t.priority||'p2').toUpperCase()+(t.project?' | '+t.project:''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});}});
      S.content.forEach(c=>{if((c.body+' '+(c.theme||'')+' '+(c.tags||[]).join(' ')).toLowerCase().includes(sq)){items.unshift({title:esc((c.body||'').substring(0,60)),desc:'Content | '+(c.theme||c.type||'uncategorized'),icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});}});
      S.docs.forEach(d=>{if((d.title+' '+d.body).toLowerCase().includes(sq)){items.unshift({title:esc(d.title||'Untitled'),desc:'Doc | '+countW(d.body)+' words',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});}});
      S.links.forEach(l=>{if((l.title+' '+l.url+' '+l.desc+' '+(l.tags||[]).join(' ')).toLowerCase().includes(sq)){items.unshift({title:esc(l.title||l.url),desc:'Link | '+(l.category||'uncategorized')+' | '+l.url.substring(0,40),icon:'L',type:'action',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});}});
      (S.specs||[]).forEach(sp=>{const match=(sp.title||'').toLowerCase().includes(sq)||(sp.sections||[]).some(s=>(s.title+' '+s.body).toLowerCase().includes(sq));if(match){items.unshift({title:esc(sp.title||'Untitled Spec'),desc:'Spec | '+(sp.sections||[]).length+' sections',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(sp.id);switchSection('specs',null);}});}});
      (S.repos||[]).forEach(r=>{if((r.name+' '+(r.desc||'')+' '+(r.techStack||[]).join(' ')+' '+(r.notes||'')).toLowerCase().includes(sq)){items.unshift({title:esc(r.name),desc:'Repo | '+(r.status||'')+(r.live?' | '+r.live.substring(0,30):''),icon:'R',type:'action',action:()=>{closeCommandPalette();switchSection('repos',null);}});}});
      if(!items.length)items.unshift({title:'No results for "'+esc(sq)+'"',desc:'Searched tasks, content, docs, links, specs, repos',icon:'!',type:'info'});
    }else{items.unshift({title:'Type 2+ characters after search:',desc:'Searches tasks, content, docs, links, specs, repos',icon:'?',type:'info'});}
  }
  // History prefix — creation timeline across all sections
  if(ql && (ql==='history' || ql.startsWith('history:') || ql==='log' || ql==='activity')){
    const days=parseInt(ql.startsWith('history:')?q.substring(8):'')||7;
    const allItems=[];
    S.tasks.forEach(t=>{if(t.created)allItems.push({title:esc(t.title||'Untitled'),type:'Task',time:t.created,icon:'T',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    S.content.forEach(c=>{if(c.created)allItems.push({title:esc((c.body||'').substring(0,50)),type:'Content',time:c.created,icon:'C',action:()=>{closeCommandPalette();switchSection('content',null);}});});
    S.docs.forEach(d=>{if(d.created||d.updated)allItems.push({title:esc(d.title||'Untitled'),type:'Doc',time:d.updated||d.created,icon:'W',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});
    S.links.forEach(l=>{if(l.created)allItems.push({title:esc(l.title||l.url),type:'Link',time:l.created,icon:'L',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});
    const cutoff=new Date();cutoff.setDate(cutoff.getDate()-days);
    const recent=allItems.filter(i=>new Date(i.time)>=cutoff).sort((a,b)=>new Date(b.time)-new Date(a.time));
    if(recent.length){
      items.unshift({title:'Activity (last '+days+' days): '+recent.length+' items',desc:'Type history:N for custom range',icon:'H',type:'info'});
      recent.slice(0,15).forEach(r=>{items.unshift({title:r.title,desc:r.type+' | '+timeAgo(r.time),icon:r.icon,type:'action',action:r.action});});
    }else{items.unshift({title:'No activity in last '+days+' days',desc:'Type history:N for custom range',icon:'!',type:'info'});}
  }
  // Digest prefix — daily briefing
  if(ql && (ql==='digest' || ql.startsWith('digest:') || ql==='brief' || ql==='morning')){
    const today=new Date().toISOString().split('T')[0];const now=new Date();
    const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
    const dueToday=S.tasks.filter(t=>t.status!=='done'&&t.due===today);
    const inProgress=S.tasks.filter(t=>t.status==='progress');
    const upcoming=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due>today&&t.due<=new Date(now.getTime()+7*86400000).toISOString().split('T')[0]).sort((a,b)=>a.due.localeCompare(b.due));
    const todayCreated=S.tasks.filter(t=>t.created&&t.created.startsWith(today)).length;
    const todayDone=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(today)).length;
    const docsToday=S.docs.filter(d=>d.updated&&d.updated.startsWith(today));
    const totalWords=docsToday.reduce((s,d)=>s+countW(d.body),0);
    items.unshift({title:'Daily Digest — '+new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'}),desc:dueToday.length+' due today | '+overdue.length+' overdue | '+inProgress.length+' in progress',icon:'D',type:'info'});
    if(overdue.length)items.unshift({title:'OVERDUE: '+overdue.length+' tasks need attention',desc:overdue.slice(0,3).map(t=>t.title).join(', '),icon:'!',type:'action',action:()=>{closeCommandPalette();setTaskFilter('overdue');switchSection('tasks',null);}});
    if(dueToday.length)dueToday.slice(0,3).forEach(t=>{items.unshift({title:'Due today: '+esc(t.title),desc:(t.priority||'p2').toUpperCase()+' | '+(t.project||'No project'),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    if(inProgress.length)items.unshift({title:inProgress.length+' tasks in progress',desc:inProgress.slice(0,3).map(t=>t.title).join(', '),icon:'>',type:'info'});
    items.unshift({title:'Today: +'+todayCreated+' created, '+todayDone+' completed',desc:totalWords?'Wrote '+totalWords+' words across '+docsToday.length+' docs':'No writing today yet',icon:'*',type:'info'});
    if(upcoming.length)items.unshift({title:'Upcoming (7d): '+upcoming.length+' tasks',desc:upcoming.slice(0,3).map(t=>t.title+' ('+t.due.substring(5)+')').join(', '),icon:'U',type:'info'});
  }
  // Goals prefix — daily/weekly goals tracking
  if(ql && (ql==='goals' || ql.startsWith('goals:') || ql==='goal')){
    if(!S.goals)S.goals=[];
    const today=new Date().toISOString().split('T')[0];
    const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay()+1);const ws=weekStart.toISOString().split('T')[0];
    const todayGoals=S.goals.filter(g=>g.date===today);
    const weekGoals=S.goals.filter(g=>g.date>=ws&&g.type==='weekly');
    const doneToday=todayGoals.filter(g=>g.done).length;
    items.unshift({title:'Goals: '+doneToday+'/'+todayGoals.length+' today',desc:weekGoals.length+' weekly goals set',icon:'G',type:'info'});
    items.unshift({title:'+ Add daily goal',desc:'Creates a goal for today',icon:'+',type:'action',action:()=>{closeCommandPalette();const text=prompt('Daily goal:');if(!text||!text.trim())return;if(!S.goals)S.goals=[];S.goals.push({id:Date.now(),text:text.trim(),type:'daily',date:today,done:false,created:new Date().toISOString()});save();toast('Goal added for today');}});
    items.unshift({title:'+ Add weekly goal',desc:'Creates a goal for this week',icon:'+',type:'action',action:()=>{closeCommandPalette();const text=prompt('Weekly goal:');if(!text||!text.trim())return;if(!S.goals)S.goals=[];S.goals.push({id:Date.now(),text:text.trim(),type:'weekly',date:ws,done:false,created:new Date().toISOString()});save();toast('Weekly goal added');}});
    todayGoals.forEach(g=>{items.unshift({title:(g.done?'[x] ':'[ ] ')+esc(g.text),desc:'Daily goal'+(g.done?' (completed)':''),icon:g.done?'*':'G',type:'action',action:()=>{g.done=!g.done;save();toast(g.done?'Goal completed':'Goal unchecked');cmdSearch();}});});
    weekGoals.forEach(g=>{items.unshift({title:(g.done?'[x] ':'[ ] ')+esc(g.text),desc:'Weekly goal'+(g.done?' (completed)':''),icon:g.done?'*':'G',type:'action',action:()=>{g.done=!g.done;save();toast(g.done?'Goal completed':'Goal unchecked');cmdSearch();}});});
  }
  // Streak prefix — activity streak counting
  if(ql && (ql==='streak' || ql.startsWith('streak:') || ql==='streaks')){
    const today=new Date();let streak=0;let longest=0;let current=0;
    for(let i=0;i<365;i++){
      const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];
      const hasActivity=S.tasks.some(t=>(t.created&&t.created.startsWith(ds))||(t.completedAt&&t.completedAt.startsWith(ds)))||S.content.some(c=>c.created&&c.created.startsWith(ds))||S.docs.some(doc=>(doc.updated||doc.created||'').startsWith(ds));
      if(hasActivity){current++;if(i<=streak+1)streak=current;longest=Math.max(longest,current);}else{if(i===0)streak=0;current=0;}
    }
    const weekDays=[];for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];const count=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length+S.content.filter(c=>c.created&&c.created.startsWith(ds)).length;weekDays.push({day:['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()],count});}
    const heatStr=weekDays.map(d=>d.day+':'+('|'.repeat(Math.min(d.count,10))||'-')).join(' ');
    items.unshift({title:'Current streak: '+streak+' days',desc:'Longest ever: '+longest+' days',icon:'F',type:'info'});
    items.unshift({title:'This week activity',desc:heatStr,icon:'H',type:'info'});
    items.unshift({title:'Heatmap (open)',desc:'Opens a 90-day activity heatmap popup',icon:'M',type:'action',action:()=>{closeCommandPalette();showActivityHeatmap();}});
  }
  // Heatmap prefix
  if(ql && (ql==='heatmap')){items.unshift({title:'Open Activity Heatmap',desc:'90-day contribution-style heatmap',icon:'H',type:'action',action:()=>{closeCommandPalette();showActivityHeatmap();}});}
  // Deps prefix — task dependency visualization
  if(ql && (ql==='deps' || ql.startsWith('deps:') || ql==='dependencies' || ql==='blocked')){
    const blocked=S.tasks.filter(t=>t.status==='blocked'||t.blockedBy);
    const blocking=S.tasks.filter(t=>t.status!=='done'&&blocked.some(b=>b.blockedBy&&b.blockedBy.toLowerCase().includes(t.title.toLowerCase())));
    items.unshift({title:'Dependency Overview: '+blocked.length+' blocked, '+blocking.length+' blocking',desc:'Resolve blockers to unblock downstream tasks',icon:'D',type:'info'});
    blocking.forEach(t=>{
      const blockedTasks=blocked.filter(b=>b.blockedBy&&b.blockedBy.toLowerCase().includes(t.title.toLowerCase()));
      items.unshift({title:'BLOCKING: '+esc(t.title),desc:'Blocks '+blockedTasks.length+' task'+(blockedTasks.length!==1?'s':'')+': '+blockedTasks.map(b=>b.title).join(', ').substring(0,60),icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    blocked.forEach(t=>{
      items.unshift({title:'BLOCKED: '+esc(t.title),desc:'Blocked by: '+(t.blockedBy||'unknown'),icon:'B',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    if(!blocked.length&&!blocking.length)items.unshift({title:'No blocked tasks',desc:'All tasks are free to work on',icon:'*',type:'info'});
  }
  // Accent color prefix
  if(ql && (ql==='accent' || ql.startsWith('accent:') || ql==='color' || ql==='theme')){
    const accents=[{name:'Mint Green',color:'#4ade80'},{name:'Cyan',color:'#22d3ee'},{name:'Purple',color:'#a855f7'},{name:'Blue',color:'#3b82f6'},{name:'Orange',color:'#f59e0b'},{name:'Pink',color:'#ec4899'},{name:'Red',color:'#ef4444'},{name:'Yellow',color:'#eab308'}];
    accents.forEach(a=>{
      items.unshift({title:a.name,desc:'Set accent color to '+a.color,icon:'<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:'+a.color+'"></span>',type:'action',action:()=>{document.documentElement.style.setProperty('--accent',a.color);S._accentColor=a.color;save();toast('Accent: '+a.name);closeCommandPalette();}});
    });
  }
  // Pomodoro stats prefix
  if(ql && (ql==='pomodoro' || ql.startsWith('pomodoro:') || ql==='pomo' || ql==='focus stats')){
    if(!S.focusSessions)S.focusSessions=[];
    const today=new Date().toISOString().split('T')[0];
    const todaySessions=S.focusSessions.filter(s=>s.date===today);
    const todayMins=todaySessions.reduce((a,s)=>a+s.minutes,0);
    const weekStart=new Date();weekStart.setDate(weekStart.getDate()-7);const ws=weekStart.toISOString().split('T')[0];
    const weekSessions=S.focusSessions.filter(s=>s.date>=ws);
    const weekMins=weekSessions.reduce((a,s)=>a+s.minutes,0);
    items.unshift({title:'Today: '+todaySessions.length+' sessions ('+todayMins+'min)',desc:'This week: '+weekSessions.length+' sessions ('+weekMins+'min)',icon:'P',type:'info'});
    items.unshift({title:'Start 25-min focus session',desc:'Classic pomodoro',icon:'+',type:'action',action:()=>{closeCommandPalette();startFocusTimer(null,25);}});
    items.unshift({title:'Start 50-min deep work',desc:'Extended focus block',icon:'+',type:'action',action:()=>{closeCommandPalette();startFocusTimer(null,50);}});
    items.unshift({title:'Start 10-min sprint',desc:'Quick burst session',icon:'+',type:'action',action:()=>{closeCommandPalette();startFocusTimer(null,10);}});
    todaySessions.slice(0,5).forEach(s=>{items.unshift({title:s.minutes+'min '+(s.task?'on: '+esc(s.task):'(no task)'),desc:s.date+' at '+(s.startedAt||'?'),icon:'*',type:'info'});});
  }
  // Collections prefix — auto-detect content groupings
  if(ql && (ql==='collections' || ql.startsWith('collections:') || ql==='groups')){
    const keywords={};
    S.content.forEach(c=>{
      const words=(c.body||'').toLowerCase().split(/\s+/).filter(w=>w.length>4);
      const counts={};words.forEach(w=>{const clean=w.replace(/[^a-z]/g,'');if(clean.length>4)counts[clean]=(counts[clean]||0)+1;});
      Object.entries(counts).filter(([,n])=>n>=2).forEach(([w])=>{if(!keywords[w])keywords[w]=[];keywords[w].push(c.id);});
    });
    const collections=Object.entries(keywords).filter(([,ids])=>ids.length>=3).sort((a,b)=>b[1].length-a[1].length).slice(0,10);
    if(collections.length){
      items.unshift({title:'Auto-detected '+collections.length+' content collections',desc:'Based on recurring keywords across items',icon:'C',type:'info'});
      collections.forEach(([kw,ids])=>{
        items.unshift({title:kw+' ('+ids.length+' items)',desc:'Recurring keyword across content items',icon:'#',type:'action',action:()=>{closeCommandPalette();document.getElementById('content-search').value=kw;renderContent();toast('Filtered: '+kw);}});
      });
    }else{items.unshift({title:'No collections detected yet',desc:'Add more content with recurring themes',icon:'!',type:'info'});}
  }
  // Scratchpad prefix
  if(ql && (ql==='scratch' || ql==='scratchpad' || ql==='pad')){
    items.unshift({title:'Open Scratchpad',desc:'Persistent floating notepad (saves across sessions)',icon:'S',type:'action',action:()=>{closeCommandPalette();toggleScratchpad();}});
    const len=(S._scratchpad||'').length;
    if(len)items.unshift({title:'Scratchpad has '+len+' chars',desc:'Content persists in localStorage',icon:'i',type:'info'});
  }
  // Review prefix — weekly review
  if(ql && (ql==='review' || ql.startsWith('review:') || ql==='weekly review')){
    const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-7);const ws=weekStart.toISOString().split('T')[0];
    const completed=S.tasks.filter(t=>t.completedAt&&t.completedAt>=ws).sort((a,b)=>b.completedAt.localeCompare(a.completedAt));
    const created=S.tasks.filter(t=>t.created&&t.created>=ws&&t.status!=='done');
    const contentAdded=S.content.filter(c=>c.created&&c.created>=ws);
    const docsEdited=S.docs.filter(d=>d.updated&&d.updated>=ws);
    const wordsWritten=docsEdited.reduce((a,d)=>a+countW(d.body),0);
    const focusMins=(S.focusSessions||[]).filter(s=>s.date>=ws).reduce((a,s)=>a+s.minutes,0);
    items.unshift({title:'Weekly Review (7 days)',desc:completed.length+' done | '+created.length+' new | '+contentAdded.length+' content | '+wordsWritten+' words | '+focusMins+'min focus',icon:'R',type:'info'});
    items.unshift({title:'Copy Review as Markdown',desc:'Copy weekly summary to clipboard',icon:'C',type:'action',action:()=>{closeCommandPalette();const md=['# Weekly Review','',`**Period:** ${ws} to ${now.toISOString().split('T')[0]}`,'',`## Completed (${completed.length})`,...completed.map(t=>'- [x] '+t.title+(t.project?' ('+t.project+')':'')),``,`## Still Active (${created.length})`,...created.map(t=>'- [ ] '+t.title+' ['+t.status+']'),``,`## Stats`,'- '+contentAdded.length+' content items added','- '+docsEdited.length+' docs edited ('+wordsWritten+' words)','- '+focusMins+' minutes focused'].join('\n');navigator.clipboard.writeText(md);toast('Weekly review copied');}});
    completed.slice(0,8).forEach(t=>{items.unshift({title:'[x] '+esc(t.title),desc:(t.project||'No project')+' | Completed '+timeAgo(t.completedAt),icon:'*',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Workspace stats prefix
  if(ql && (ql==='workspace' || ql.startsWith('workspace:') || ql==='ws' || ql==='stats overview')){
    const dataSize=JSON.stringify(S).length;const kb=Math.round(dataSize/1024);
    const totalTasks=S.tasks.length;const totalContent=S.content.length;const totalDocs=S.docs.length;
    const totalLinks=S.links.length;const totalSpecs=(S.specs||[]).length;const totalRepos=(S.repos||[]).length;
    const totalWords=S.docs.reduce((a,d)=>a+countW(d.body),0)+S.content.reduce((a,c)=>a+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0);
    const totalProjects=(S.projects||[]).length;
    const totalGoals=(S.goals||[]).length;const totalFocus=(S.focusSessions||[]).length;
    const totalFocusMins=(S.focusSessions||[]).reduce((a,s)=>a+s.minutes,0);
    const nodes=(S.whiteboard&&S.whiteboard.nodes||[]).length;
    const kbItems=(S.knowledgeBase||[]).length;
    items.unshift({title:'Workspace: '+kb+'KB ('+Math.round(kb/1024*100)/100+'MB)',desc:'localStorage usage',icon:'W',type:'info'});
    items.unshift({title:'Items: T:'+totalTasks+' C:'+totalContent+' D:'+totalDocs+' L:'+totalLinks+' S:'+totalSpecs+' R:'+totalRepos,desc:'P:'+totalProjects+' KB:'+kbItems+' WB:'+nodes+' Goals:'+totalGoals+' Focus:'+totalFocus,icon:'#',type:'info'});
    items.unshift({title:'Words: '+totalWords.toLocaleString()+' total',desc:S.docs.length+' docs + '+S.content.length+' content items',icon:'W',type:'info'});
    items.unshift({title:'Focus: '+totalFocusMins+' minutes ('+Math.round(totalFocusMins/60)+'h) across '+totalFocus+' sessions',desc:'Across all time',icon:'F',type:'info'});
    const lastSave=S._lastSaveTime||null;
    items.unshift({title:'Last saved: '+(lastSave?timeAgo(lastSave):'unknown'),desc:'Accent: '+(S._accentColor||'#4ade80 (default)'),icon:'i',type:'info'});
  }
  // Chart prefix — visual distributions
  if(ql && (ql==='chart' || ql.startsWith('chart:') || ql==='charts' || ql==='graph')){
    items.unshift({title:'Task Status Distribution',desc:'SVG pie chart of task statuses',icon:'P',type:'action',action:()=>{closeCommandPalette();showChart('status');}});
    items.unshift({title:'Task Priority Distribution',desc:'SVG bar chart of priorities',icon:'B',type:'action',action:()=>{closeCommandPalette();showChart('priority');}});
    items.unshift({title:'Content by Theme',desc:'SVG chart of content themes',icon:'T',type:'action',action:()=>{closeCommandPalette();showChart('theme');}});
    items.unshift({title:'Weekly Activity',desc:'SVG chart of 7-day activity',icon:'W',type:'action',action:()=>{closeCommandPalette();showChart('weekly');}});
  }
  // Plan prefix — weekly plan view
  if(ql && (ql==='plan' || ql.startsWith('plan:') || ql==='weekly plan' || ql==='week plan')){
    const today=new Date();
    for(let i=0;i<7;i++){
      const d=new Date(today);d.setDate(d.getDate()+i);const ds=d.toISOString().split('T')[0];
      const dayLabel=i===0?'Today':i===1?'Tomorrow':['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]+' '+d.getDate();
      const dayTasks=S.tasks.filter(t=>t.due===ds&&t.status!=='done');
      if(dayTasks.length){
        dayTasks.forEach(t=>{items.unshift({title:dayLabel+': '+esc(t.title),desc:(t.priority||'p2').toUpperCase()+' | '+(t.project||'No project'),icon:i===0?'>':'D',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
      }else{
        items.unshift({title:dayLabel+': (no tasks)',desc:'Click to add a task for '+ds,icon:'.',type:'action',action:()=>{closeCommandPalette();S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p2',project:'',due:ds,created:new Date().toISOString()});save();switchSection('tasks',null);renderTasks();setTimeout(()=>{const i=document.querySelector('.task-title-input');if(i)i.focus();},100);}});
      }
    }
  }
  // Import bookmarks prefix
  if(ql && (ql==='import bookmarks' || ql==='bookmarks' || ql==='import links')){
    items.unshift({title:'Import Browser Bookmarks',desc:'Upload HTML bookmarks file (Chrome/Firefox export)',icon:'L',type:'action',action:()=>{closeCommandPalette();importBookmarks();}});
    items.unshift({title:'Batch Import URLs',desc:'Paste multiple URLs (one per line)',icon:'L',type:'action',action:()=>{closeCommandPalette();batchImportLinks();}});
  }
  // Burndown chart prefix
  if(ql && (ql==='burndown' || ql==='burn' || ql==='burndown chart')){
    items.unshift({title:'Task Burndown Chart (14 days)',desc:'SVG chart: tasks created vs completed per day',icon:'B',type:'action',action:()=>{closeCommandPalette();showBurndownChart();}});
    items.unshift({title:'Burndown Chart (30 days)',desc:'Extended 30-day view',icon:'B',type:'action',action:()=>{closeCommandPalette();showBurndownChart(30);}});
  }
  // Dead links checker prefix
  if(ql && (ql==='deadlinks' || ql==='dead links' || ql==='check links' || ql==='broken links' || ql==='link check')){
    items.unshift({title:'Check All Links for Broken URLs',desc:'Tests each link via HEAD request (may take a moment)',icon:'L',type:'action',action:()=>{closeCommandPalette();checkDeadLinks();}});
  }
  // Notifications prefix
  if(ql && (ql==='notifications' || ql==='notify' || ql==='alerts' || ql==='desktop alerts')){
    items.unshift({title:'Enable Desktop Notifications',desc:'Get alerts for overdue tasks and focus timer',icon:'N',type:'action',action:()=>{closeCommandPalette();enableDesktopNotifications();}});
  }
  // Timeline prefix
  if(ql && (ql==='timeline' || ql==='activity' || ql==='activity feed' || ql==='recent')){
    items.unshift({title:'Activity Timeline',desc:'Chronological feed of recent activity across all sections',icon:'T',type:'action',action:()=>{closeCommandPalette();showActivityTimeline();}});
  }
  // Backup prefix
  if(ql && (ql==='backup' || ql==='auto backup' || ql==='autobackup' || ql==='schedule backup')){
    items.unshift({title:'Download Full Backup Now',desc:'Export all data as JSON file',icon:'B',type:'action',action:()=>{closeCommandPalette();downloadBackup();}});
    items.unshift({title:'Toggle Auto-Backup (every 4h)',desc:S._autoBackup?'Currently ON - click to disable':'Currently OFF - click to enable',icon:'B',type:'action',action:()=>{closeCommandPalette();toggleAutoBackup();}});
  }
  // Restore/import prefix
  if(ql && (ql==='restore' || ql==='import' || ql==='import data' || ql==='restore backup')){
    items.unshift({title:'Import JSON Backup',desc:'Upload a previously exported backup file to restore data',icon:'B',type:'action',action:()=>{closeCommandPalette();importBackup();}});
  }
  // Export docs prefix
  if(ql && (ql==='export docs' || ql==='export all docs' || ql==='export writer' || ql==='docs export')){
    items.unshift({title:'Export All Writer Docs (Markdown)',desc:'Download all '+S.docs.length+' documents as a single .md file',icon:'D',type:'action',action:()=>{closeCommandPalette();exportAllDocs();}});
    items.unshift({title:'Export All Writer Docs (Individual)',desc:'Download each doc as separate .md file (zip)',icon:'D',type:'action',action:()=>{closeCommandPalette();exportAllDocsIndividual();}});
  }
  // Roadmap prefix
  if(ql && (ql==='roadmap' || ql==='project roadmap' || ql==='project timeline')){
    const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    items.unshift({title:'Full Project Roadmap',desc:'Timeline view of all projects with task milestones',icon:'R',type:'action',action:()=>{closeCommandPalette();showProjectRoadmap();}});
    projects.slice(0,3).forEach(p=>{items.unshift({title:'Roadmap: '+p,desc:'Timeline for '+p+' tasks',icon:'R',type:'action',action:()=>{closeCommandPalette();showProjectRoadmap(p);}});});
  }
  // Journal prefix
  if(ql && (ql==='journal' || ql==='daily journal' || ql==='diary' || ql==='today journal')){
    const today=new Date().toISOString().split('T')[0];
    const existing=S.docs.find(d=>d.title&&d.title.startsWith('Journal '+today));
    items.unshift({title:existing?'Open Journal: '+today:'Create Journal: '+today,desc:existing?'Open existing journal entry':'Create new journal entry for today',icon:'J',type:'action',action:()=>{closeCommandPalette();openDailyJournal();}});
    items.unshift({title:'Journal Archive',desc:'View all journal entries',icon:'J',type:'action',action:()=>{closeCommandPalette();showJournalArchive();}});
  }
  // Writing stats prefix
  if(ql && (ql==='writing' || ql==='writing stats' || ql==='word streak' || ql==='writing streak')){
    items.unshift({title:'Writing Stats Dashboard',desc:'Word counts, streaks, daily output',icon:'W',type:'action',action:()=>{closeCommandPalette();showWritingStats();}});
  }
  // Cleanup prefix
  if(ql && (ql==='cleanup' || ql==='clean' || ql==='prune' || ql==='data cleanup')){
    items.unshift({title:'Data Cleanup Report',desc:'Find empty items, duplicates, orphaned data',icon:'X',type:'action',action:()=>{closeCommandPalette();showDataCleanup();}});
  }
  // Report prefix
  if(ql && (ql==='report' || ql==='monthly report' || ql==='productivity report' || ql==='month report')){
    items.unshift({title:'Monthly Productivity Report',desc:'Comprehensive report with stats, charts, and insights',icon:'R',type:'action',action:()=>{closeCommandPalette();showProductivityReport();}});
  }
  // Stickies prefix
  if(ql && (ql==='stickies' || ql==='sticky' || ql==='sticky notes' || ql==='sticky note')){
    items.unshift({title:'Add Sticky Note',desc:'Create a floating sticky note on workspace',icon:'S',type:'action',action:()=>{closeCommandPalette();addStickyNote();}});
    items.unshift({title:'Clear All Sticky Notes',desc:'Remove all sticky notes',icon:'S',type:'action',action:()=>{closeCommandPalette();clearStickyNotes();}});
  }
  // Gantt chart prefix
  if(ql && (ql==='gantt' || ql==='gantt chart' || ql==='task gantt' || ql==='task timeline')){
    items.unshift({title:'Task Gantt Chart',desc:'Horizontal timeline of tasks with due dates',icon:'G',type:'action',action:()=>{closeCommandPalette();showGanttChart();}});
  }
  // Related content prefix
  if(ql && ql.startsWith('related')){
    const searchTerm=q.substring(7).trim();
    if(searchTerm.length>=2){
      const matches=findRelatedContent(searchTerm);
      matches.slice(0,5).forEach(m=>{items.unshift({title:m.body.substring(0,60),desc:'Score: '+m.score+' | '+m.type+' | '+(m.theme||''),icon:'C',type:'action',action:()=>{closeCommandPalette();openContentModal(m.id);}});});
    }else{
      items.unshift({title:'Find Related Content',desc:'Type "related:<keyword>" to find similar content',icon:'C',type:'info'});
    }
  }
  // Reading list prefix
  if(ql && (ql==='reading' || ql==='reading list' || ql==='read later' || ql==='readlist')){
    const readLater=S.links.filter(l=>l.readLater);
    items.unshift({title:'Reading List ('+readLater.length+' links)',desc:'Show all links marked for reading later',icon:'L',type:'action',action:()=>{closeCommandPalette();showReadingList();}});
  }
  // Habits prefix
  if(ql && (ql==='habits' || ql==='habit' || ql==='habit tracker' || ql==='daily habits')){
    items.unshift({title:'Habit Tracker',desc:'Daily habit check-off grid with streaks',icon:'H',type:'action',action:()=>{closeCommandPalette();showHabitTracker();}});
    items.unshift({title:'Add New Habit',desc:'Create a new daily habit to track',icon:'H',type:'action',action:()=>{closeCommandPalette();addHabit();}});
  }
  // Table view prefix
  if(ql && (ql==='table' || ql==='task table' || ql==='spreadsheet' || ql==='grid view')){
    items.unshift({title:'Task Table View',desc:'Compact spreadsheet-like view of all tasks',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTable();}});
  }
  // Project health prefix
  if(ql && (ql==='project health' || ql==='project status' || ql==='project report' || ql==='health')){
    items.unshift({title:'Project Health Dashboard',desc:'Per-project task metrics, completion rates, velocity',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectHealth();}});
  }
  // Random content prefix
  if(ql && (ql==='random' || ql==='surprise' || ql==='random content' || ql==='resurface')){
    items.unshift({title:'Random Content',desc:'Surface a random content item for review/rediscovery',icon:'?',type:'action',action:()=>{closeCommandPalette();showRandomContent();}});
    items.unshift({title:'Random Task',desc:'Pick a random active task to work on',icon:'?',type:'action',action:()=>{closeCommandPalette();showRandomTask();}});
  }
  // Clips prefix
  if(ql && (ql==='clips' || ql==='clipboard' || ql==='clip history' || ql==='clipboard history')){
    items.unshift({title:'Clipboard History',desc:(S._clips||[]).length+' saved clips',icon:'C',type:'action',action:()=>{closeCommandPalette();showClipHistory();}});
    items.unshift({title:'Save Current Clipboard',desc:'Save what\'s on your clipboard to history',icon:'C',type:'action',action:()=>{closeCommandPalette();saveToClips();}});
  }
  // Project template prefix
  if(ql && (ql==='project template' || ql==='new project' || ql==='create project' || ql==='project preset')){
    const templates=[
      {name:'Software Project',tasks:['Set up repository','Define requirements','Design architecture','Implement MVP','Write tests','Deploy to staging','Review and QA','Deploy to production']},
      {name:'Content Campaign',tasks:['Research topic','Create outline','Write first draft','Review/edit','Design visuals','Schedule publishing','Promote on social','Analyze results']},
      {name:'Event Planning',tasks:['Define objectives','Set budget','Book venue','Create guest list','Design invitations','Coordinate vendors','Run-of-show doc','Post-event follow-up']},
      {name:'Product Launch',tasks:['Market research','Define features','Build prototype','User testing','Refine based on feedback','Marketing materials','Launch day prep','Post-launch review']},
    ];
    templates.forEach(t=>{items.unshift({title:'Template: '+t.name,desc:t.tasks.length+' tasks: '+t.tasks.slice(0,3).join(', ')+'...',icon:'P',type:'action',action:()=>{closeCommandPalette();createProjectFromTemplate(t);}});});
  }
  // Compare prefix
  if(ql && (ql==='compare' || ql==='diff' || ql==='side by side' || ql==='content compare')){
    items.unshift({title:'Compare Content Items',desc:'Pick two content items to compare side-by-side',icon:'C',type:'action',action:()=>{closeCommandPalette();startContentCompare();}});
  }
  // Time block prefix
  if(ql && (ql==='time block' || ql==='timeblock' || ql==='block time' || ql==='time blocks')){
    items.unshift({title:'Add Time Block',desc:'Block out time on calendar for focused work',icon:'T',type:'action',action:()=>{closeCommandPalette();addTimeBlock();}});
    items.unshift({title:'View Time Blocks',desc:'Show all scheduled time blocks',icon:'T',type:'action',action:()=>{closeCommandPalette();showTimeBlocks();}});
  }
  // Transform prefix
  if(ql && (ql==='transform' || ql==='text transform' || ql==='uppercase' || ql==='lowercase' || ql==='title case' || ql==='slug')){
    items.unshift({title:'UPPERCASE',desc:'Transform clipboard text to UPPERCASE',icon:'A',type:'action',action:()=>{closeCommandPalette();textTransform('upper');}});
    items.unshift({title:'lowercase',desc:'Transform clipboard text to lowercase',icon:'a',type:'action',action:()=>{closeCommandPalette();textTransform('lower');}});
    items.unshift({title:'Title Case',desc:'Transform clipboard text to Title Case',icon:'T',type:'action',action:()=>{closeCommandPalette();textTransform('title');}});
    items.unshift({title:'slug-case',desc:'Transform to URL-friendly slug',icon:'-',type:'action',action:()=>{closeCommandPalette();textTransform('slug');}});
  }
  // Archive URL prefix
  if(ql && (ql==='archive url' || ql==='wayback' || ql==='web archive' || ql==='archive')){
    items.unshift({title:'View Link on Wayback Machine',desc:'Enter a URL to view its archived version',icon:'W',type:'action',action:()=>{closeCommandPalette();archiveUrl();}});
    S.links.slice(0,3).forEach(l=>{items.unshift({title:'Archive: '+l.title.substring(0,40),desc:l.url,icon:'W',type:'action',action:()=>{closeCommandPalette();window.open('https://web.archive.org/web/'+l.url,'_blank');toast('Opened Wayback Machine');}});});
  }
  // Dashboard prefix
  if(ql && (ql==='dashboard' || ql==='home' || ql==='overview' || ql==='widgets')){
    items.unshift({title:'Home Dashboard',desc:'Overview with today\'s tasks, stats, recent activity',icon:'D',type:'action',action:()=>{closeCommandPalette();showHomeDashboard();}});
  }
  // Settings prefix
  if(ql && (ql==='settings' || ql==='preferences' || ql==='config' || ql==='options')){
    items.unshift({title:'App Settings',desc:'Configure preferences, defaults, and appearance',icon:'S',type:'action',action:()=>{closeCommandPalette();showSettings();}});
  }
  // Impact-effort matrix prefix
  if(ql && (ql==='impact' || ql==='impact effort' || ql==='effort matrix' || ql==='impact matrix')){
    items.unshift({title:'Impact-Effort Matrix',desc:'2x2 matrix: quick wins, big bets, time sinks, fill-ins',icon:'M',type:'action',action:()=>{closeCommandPalette();showImpactMatrix();}});
  }
  // Export content prefix
  if(ql && (ql==='export content' || ql==='export all content' || ql==='content export' || ql==='download content')){
    items.unshift({title:'Export All Content as Markdown',desc:'Download '+S.content.length+' items as a single .md file',icon:'C',type:'action',action:()=>{closeCommandPalette();exportAllContent();}});
    items.unshift({title:'Export All Content as JSON',desc:'Download raw content data',icon:'C',type:'action',action:()=>{closeCommandPalette();exportContentJSON();}});
  }
  // Focus stats prefix
  if(ql && (ql==='focus stats' || ql==='focus history' || ql==='pomodoro stats' || ql==='focus sessions')){
    items.unshift({title:'Focus Session Stats',desc:'Total time, streaks, weekly breakdown, session history',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusStats();}});
  }
  // Eisenhower matrix prefix
  if(ql && (ql==='eisenhower' || ql==='eisenhower matrix' || ql==='urgent important' || ql==='4 quadrants')){
    items.unshift({title:'Eisenhower Matrix',desc:'Urgent vs Important: Do First, Schedule, Delegate, Eliminate',icon:'E',type:'action',action:()=>{closeCommandPalette();showEisenhowerMatrix();}});
  }
  // Content calendar prefix
  if(ql && (ql==='content calendar' || ql==='creation calendar' || ql==='content dates' || ql==='writing calendar')){
    items.unshift({title:'Content Calendar',desc:'Calendar view showing when content was created',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentCalendar();}});
  }
  // Snippet manager prefix
  if(ql && (ql==='snippets' || ql==='snippet' || ql==='snippet manager' || ql==='text snippets')){
    items.unshift({title:'Snippet Manager',desc:'Save and reuse text snippets quickly',icon:'S',type:'action',action:()=>{closeCommandPalette();showSnippetManager();}});
  }
  // Heatmap full prefix
  if(ql && (ql==='heatmap full' || ql==='activity heatmap' || ql==='github heatmap' || ql==='365 heatmap')){
    items.unshift({title:'Activity Heatmap (365 Days)',desc:'GitHub-style grid of daily activity across all sections',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskHeatmap();}});
  }
  // Link dashboard prefix
  if(ql && (ql==='link dashboard' || ql==='link stats' || ql==='links overview' || ql==='link report')){
    items.unshift({title:'Link Dashboard',desc:'Stats: top domains, categories, read-later, pinned',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkDashboard();}});
  }
  // Dependencies prefix
  if(ql && (ql==='dependencies' || ql==='dependency graph' || ql==='blocked' || ql==='dep graph')){
    items.unshift({title:'Task Dependency Graph',desc:'Visualize blocked-by chains across tasks',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDependencyGraph();}});
  }
  // Weekly review prefix
  if(ql && (ql==='weekly review' || ql==='week review' || ql==='review week' || ql==='7 day review')){
    items.unshift({title:'Weekly Review',desc:'Comprehensive 7-day review: completed, in-progress, overdue, content',icon:'W',type:'action',action:()=>{closeCommandPalette();showWeeklyReview();}});
  }
  // Pomodoro history prefix
  if(ql && (ql==='pomo history' || ql==='pomodoro history' || ql==='focus history' || ql==='pomo stats')){
    items.unshift({title:'Pomodoro History',desc:'Session history by task, best day, avg per day',icon:'P',type:'action',action:()=>{closeCommandPalette();showPomodoroHistory();}});
  }
  // Tag cloud prefix
  if(ql && (ql==='tag cloud' || ql==='tags' || ql==='tag visualization' || ql==='word cloud')){
    items.unshift({title:'Tag Cloud',desc:'Visual cloud of all tags sized by frequency',icon:'T',type:'action',action:()=>{closeCommandPalette();showTagCloud();}});
  }
  // Priority grid prefix
  if(ql && (ql==='priority grid' || ql==='priority reassign' || ql==='reprioritize' || ql==='triage')){
    items.unshift({title:'Priority Grid',desc:'Quick-reassign priorities for all active tasks',icon:'P',type:'action',action:()=>{closeCommandPalette();showPriorityGrid();}});
  }
  // Content timeline prefix
  if(ql && (ql==='content timeline' || ql==='content history' || ql==='content feed' || ql==='creation history')){
    items.unshift({title:'Content Timeline',desc:'Chronological feed of all content items by date',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentTimeline();}});
  }
  // Velocity chart prefix
  if(ql && (ql==='velocity' || ql==='velocity chart' || ql==='task velocity' || ql==='completion rate')){
    items.unshift({title:'Task Velocity Chart',desc:'12-week line chart: created vs completed tasks',icon:'V',type:'action',action:()=>{closeCommandPalette();showVelocityChart();}});
  }
  // Quick note prefix
  if(ql && (ql==='quick note' || ql==='quick capture' || ql==='fab' || ql==='floating note')){
    items.unshift({title:'Toggle Quick Note Button',desc:'Floating action button for instant note capture',icon:'+',type:'action',action:()=>{closeCommandPalette();toggleQuickNote();}});
  }
  // Bookmarklets prefix
  if(ql && (ql==='bookmarklets' || ql==='bookmarklet' || ql==='browser capture' || ql==='capture bookmarks')){
    items.unshift({title:'Bookmarklet Generator',desc:'Create browser bookmarklets to save links/text/tasks',icon:'B',type:'action',action:()=>{closeCommandPalette();showBookmarkletGenerator();}});
  }
  // Workspace search prefix
  if(ql && (ql==='workspace search' || ql==='deep search' || ql==='search all' || ql==='global search')){
    items.unshift({title:'Workspace Search',desc:'Deep search across tasks, content, docs, and links',icon:'S',type:'action',action:()=>{closeCommandPalette();showWorkspaceSearch();}});
  }
  // Batch edit prefix
  if(ql && (ql==='batch edit' || ql==='batch tasks' || ql==='bulk edit' || ql==='mass edit')){
    items.unshift({title:'Batch Task Editor',desc:'Select and edit multiple tasks at once',icon:'B',type:'action',action:()=>{closeCommandPalette();showBatchTaskEditor();}});
  }
  // Content stats prefix
  if(ql && (ql==='content stats' || ql==='content analytics' || ql==='content dashboard' || ql==='content report')){
    items.unshift({title:'Content Stats Dashboard',desc:'Types, themes, tags, word counts, trends',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentStats();}});
  }
  // Swimlane prefix
  if(ql && (ql==='swimlane' || ql==='swimlanes' || ql==='project kanban' || ql==='project board')){
    items.unshift({title:'Swimlane View',desc:'Tasks grouped by project x status (kanban by project)',icon:'S',type:'action',action:()=>{closeCommandPalette();showSwimlaneView();}});
  }
  // Daily planner prefix
  if(ql && (ql==='daily planner' || ql==='day planner' || ql==='today plan' || ql==='schedule')){
    items.unshift({title:'Daily Planner',desc:'Today\'s time slots, tasks, overdue, and time blocks',icon:'D',type:'action',action:()=>{closeCommandPalette();showDailyPlanner();}});
  }
  // Export workspace prefix
  if(ql && (ql==='export workspace' || ql==='export all' || ql==='full export' || ql==='download workspace')){
    items.unshift({title:'Export Full Workspace',desc:'Download everything as single JSON (tasks, content, docs, links, etc.)',icon:'E',type:'action',action:()=>{closeCommandPalette();exportFullWorkspace();}});
  }
  // Quick actions prefix
  if(ql && (ql==='quick actions' || ql==='action bar' || ql==='toolbar' || ql==='quick bar')){
    items.unshift({title:'Toggle Quick Actions Bar',desc:'Floating bar with Task, Note, Journal, Dashboard, Habits',icon:'Q',type:'action',action:()=>{closeCommandPalette();toggleQuickActions();}});
  }
  // Due heatmap prefix
  if(ql && (ql==='due heatmap' || ql==='due calendar' || ql==='task load' || ql==='deadline heatmap')){
    items.unshift({title:'Due Date Heatmap',desc:'Calendar showing task load per day with color intensity',icon:'H',type:'action',action:()=>{closeCommandPalette();showDueDateHeatmap();}});
  }
  // Writing goals prefix
  if(ql && (ql==='writing goals' || ql==='word goals' || ql==='writing target' || ql==='word count goal')){
    items.unshift({title:'Writing Goals',desc:'Set and track daily/weekly word count targets',icon:'W',type:'action',action:()=>{closeCommandPalette();showWritingGoals();}});
  }
  // Project compare prefix
  if(ql && (ql==='project compare' || ql==='compare projects' || ql==='project vs' || ql==='project comparison')){
    items.unshift({title:'Project Comparison',desc:'Side-by-side stats for two projects',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectComparison();}});
  }
  // Task aging prefix
  if(ql && (ql==='task aging' || ql==='stale tasks' || ql==='old tasks' || ql==='aging report')){
    items.unshift({title:'Task Aging Report',desc:'Find stale (30d+), aging (14-30d), and fresh (<14d) tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();showTaskAging();}});
  }
  // Import links from markdown prefix
  if(ql && (ql==='import links md' || ql==='import links' || ql==='paste links' || ql==='markdown links')){
    items.unshift({title:'Import Links from Markdown',desc:'Paste markdown text to extract and import URLs',icon:'L',type:'action',action:()=>{closeCommandPalette();importLinksFromMarkdown();}});
  }
  // Ambient sounds prefix
  if(ql && (ql==='ambient' || ql==='ambient sounds' || ql==='focus sounds' || ql==='background noise')){
    items.unshift({title:'Ambient Sounds',desc:'Rain, forest, ocean, white noise for focus sessions',icon:'A',type:'action',action:()=>{closeCommandPalette();showAmbientSounds();}});
  }
  // Word frequency prefix
  if(ql && (ql==='word frequency' || ql==='word count' || ql==='top words' || ql==='word analysis')){
    items.unshift({title:'Word Frequency Analysis',desc:'Most common words across all content and docs',icon:'W',type:'action',action:()=>{closeCommandPalette();showWordFrequency();}});
  }
  // Priority board prefix
  if(ql && (ql==='priority board' || ql==='priority kanban' || ql==='priority columns' || ql==='pri board')){
    items.unshift({title:'Priority Board',desc:'Kanban board with columns by priority (P0/P1/P2/P3)',icon:'P',type:'action',action:()=>{closeCommandPalette();showPriorityBoard();}});
  }
  // WIP limits prefix
  if(ql && (ql==='wip limits' || ql==='wip config' || ql==='wip' || ql==='work in progress limits')){
    items.unshift({title:'WIP Limits Config',desc:'Set work-in-progress limits per board column',icon:'W',type:'action',action:()=>{closeCommandPalette();showWipConfig();}});
  }
  // Duplicates prefix
  if(ql && (ql==='duplicates' || ql==='find duplicates' || ql==='content duplicates' || ql==='dedup')){
    items.unshift({title:'Duplicate Content Finder',desc:'Find similar/duplicate items with 70%+ word overlap',icon:'D',type:'action',action:()=>{closeCommandPalette();showDuplicateContent();}});
  }
  // Export CSV prefix
  if(ql && (ql==='export csv' || ql==='csv export' || ql==='tasks csv' || ql==='spreadsheet export')){
    items.unshift({title:'Export Tasks as CSV',desc:'Download all tasks as comma-separated spreadsheet',icon:'E',type:'action',action:()=>{closeCommandPalette();exportTasksCSV();}});
  }
  // Inbox prefix
  if(ql && (ql==='inbox' || ql==='unsorted' || ql==='uncategorized' || ql==='no project')){
    items.unshift({title:'Inbox (Unsorted Items)',desc:'View tasks, content, links without a project/theme',icon:'I',type:'action',action:()=>{closeCommandPalette();showInbox();}});
  }
  // Session timer prefix
  if(ql && (ql==='session' || ql==='session timer' || ql==='uptime' || ql==='session time')){
    const elapsed=Date.now()-_sessionStart;const mins=Math.floor(elapsed/60000);
    items.unshift({title:'Session Time: '+Math.floor(mins/60)+'h '+mins%60+'m',desc:'Time since ASTRA was opened this session',icon:'T',type:'action',action:()=>{closeCommandPalette();showSessionTimer();}});
  }
  // Undo prefix
  if(ql && (ql==='undo' || ql==='undo last' || ql==='revert' || ql==='undo delete')){
    const last=_undoStack.length?_undoStack[_undoStack.length-1]:null;
    items.unshift({title:'Undo Last Action',desc:last?'Undo: '+last.type+' ('+new Date(last.ts).toLocaleTimeString()+')':'No actions to undo',icon:'U',type:'action',action:()=>{closeCommandPalette();globalUndo();}});
  }
  // Favorites prefix
  if(ql && (ql==='favorites' || ql==='starred' || ql==='pinned' || ql==='bookmarks')){
    const total=S.content.filter(c=>c.starred).length+S.content.filter(c=>c.pinned).length+(S.links||[]).filter(l=>l.pinned).length;
    items.unshift({title:'Favorites ('+total+' items)',desc:'Starred and pinned content and links',icon:'*',type:'action',action:()=>{closeCommandPalette();showFavorites();}});
  }
  // Due groups prefix
  if(ql && (ql==='due groups' || ql==='due grouped' || ql==='tasks by date' || ql==='task groups')){
    items.unshift({title:'Tasks by Due Date',desc:'Grouped: Overdue, Today, Tomorrow, This Week, Later, No Date',icon:'D',type:'action',action:()=>{closeCommandPalette();showTasksByDueGroup();}});
  }
  // Convert prefix
  if(ql && (ql==='convert' || ql==='content to task' || ql==='task to content' || ql==='transform item')){
    items.unshift({title:'Convert Content to Task',desc:'Pick a content item to convert to a task',icon:'C',type:'info'});
    items.unshift({title:'Convert Task to Content',desc:'Pick a task to convert to a content item',icon:'T',type:'info'});
  }
  // Deep focus prefix
  if(ql && (ql==='deep focus' || ql==='focus overlay' || ql==='distraction free' || ql==='dim')){
    items.unshift({title:'Toggle Deep Focus',desc:'Dim everything except current panel for distraction-free work',icon:'F',type:'action',action:()=>{closeCommandPalette();toggleDeepFocus();}});
  }
  // Estimation report prefix
  if(ql && (ql==='estimation' || ql==='estimate report' || ql==='time accuracy' || ql==='est vs actual')){
    items.unshift({title:'Estimation Report',desc:'Compare estimated vs actual time across tasks',icon:'E',type:'action',action:()=>{closeCommandPalette();showEstimationReport();}});
  }
  // Data tools prefix
  if(ql && (ql==='data tools' || ql==='data management' || ql==='clear data' || ql==='factory reset')){
    items.unshift({title:'Data Management',desc:'Clear individual sections, factory reset, storage info',icon:'X',type:'action',action:()=>{closeCommandPalette();showDataTools();}});
  }
  // Theme switcher prefix
  if(ql && (ql==='theme' || ql==='theme switcher' || ql==='dark theme' || ql==='color scheme')){
    items.unshift({title:'Theme Switcher',desc:'6 dark theme variants: Cosmic, Ocean, Forest, Sunset, Purple, Ember',icon:'T',type:'action',action:()=>{closeCommandPalette();showThemeSwitcher();}});
  }
  // Status email prefix
  if(ql && (ql==='status email' || ql==='status update' || ql==='weekly email' || ql==='email update')){
    items.unshift({title:'Generate Status Email',desc:'Copy weekly status update email to clipboard',icon:'E',type:'action',action:()=>{closeCommandPalette();generateStatusEmail();}});
  }
  // Morning briefing prefix
  if(ql && (ql==='morning' || ql==='morning briefing' || ql==='good morning' || ql==='daily brief')){
    items.unshift({title:'Morning Briefing',desc:'Daily overview: overdue, today tasks, in-progress, stats',icon:'M',type:'action',action:()=>{closeCommandPalette();showMorningBriefing();}});
  }
  // Shortcut cheatsheet prefix
  if(ql && (ql==='shortcuts' || ql==='shortcut cheatsheet' || ql==='keyboard' || ql==='keys' || ql==='hotkeys')){
    items.unshift({title:'Shortcut Cheatsheet',desc:'Visual keyboard shortcut reference',icon:'K',type:'action',action:()=>{closeCommandPalette();showShortcutCheatsheet();}});
  }
  // Streak tracker prefix
  if(ql && (ql==='streak' || ql==='streak tracker' || ql==='daily streak' || ql==='usage streak')){
    items.unshift({title:'Streak Tracker',desc:'Track daily usage streaks and active days',icon:'S',type:'action',action:()=>{closeCommandPalette();showStreakTracker();}});
  }
  // Content templates prefix
  if(ql && (ql==='content templates' || ql==='templates' || ql==='template' || ql==='new template')){
    items.unshift({title:'Content Templates',desc:'Meeting notes, project brief, journal, research, decision log',icon:'T',type:'action',action:()=>{closeCommandPalette();showContentTemplates();}});
  }
  // Link checker prefix
  if(ql && (ql==='link checker' || ql==='check links' || ql==='broken links' || ql==='link health')){
    items.unshift({title:'Link Health Checker',desc:'Check if saved links are still reachable',icon:'L',type:'action',action:()=>{closeCommandPalette();showBulkLinkChecker();}});
  }
  // Reading progress prefix
  if(ql && (ql==='reading' || ql==='reading progress' || ql==='read status' || ql==='unread')){
    items.unshift({title:'Reading Progress',desc:'Track read/unread/reading status of content items',icon:'R',type:'action',action:()=>{closeCommandPalette();showReadingProgress();}});
  }
  // Project timeline prefix
  if(ql && (ql==='project timeline' || ql==='timeline' || ql==='gantt' || ql==='milestones')){
    items.unshift({title:'Project Timeline',desc:'Visual timeline of project milestones and task dates',icon:'T',type:'action',action:()=>{closeCommandPalette();showProjectTimeline();}});
  }
  // Quick math
  if(ql && ql.startsWith('math:')){
    const expr=ql.substring(5).trim();const result=quickMath(expr);
    if(result!==null){
      items.unshift({title:'= '+result,desc:'Math: '+expr,icon:'#',type:'action',action:()=>{navigator.clipboard.writeText(String(result));showToast('Copied: '+result);closeCommandPalette();}});
    }
  }
  // Focus score prefix
  if(ql && (ql==='focus score' || ql==='daily score' || ql==='productivity score' || ql==='score')){
    items.unshift({title:'Daily Focus Score',desc:'Productivity grade based on tasks, content, focus time, words',icon:'S',type:'action',action:()=>{closeCommandPalette();showFocusScore();}});
  }
  // Archive browser prefix
  if(ql && (ql==='archive' || ql==='archive browser' || ql==='archived' || ql==='restore task')){
    items.unshift({title:'Archive Browser',desc:'Browse and restore archived tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();showArchiveBrowser();}});
  }
  // Content word cloud prefix
  if(ql && (ql==='word cloud' || ql==='wordcloud' || ql==='content cloud' || ql==='content words')){
    items.unshift({title:'Content Word Cloud',desc:'Visual word cloud from all content and docs',icon:'W',type:'action',action:()=>{closeCommandPalette();showContentWordCloud();}});
  }
  // Habit tracker prefix
  if(ql && (ql==='habits' || ql==='habit tracker' || ql==='daily habits' || ql==='habit')){
    items.unshift({title:'Habit Tracker',desc:'Track daily habits with streaks and history',icon:'H',type:'action',action:()=>{closeCommandPalette();showHabitTracker();}});
  }
  // Knowledge graph stats prefix
  if(ql && (ql==='knowledge graph' || ql==='wiki links' || ql==='backlinks' || ql==='graph stats')){
    items.unshift({title:'Knowledge Graph Stats',desc:'Wiki-link analysis and most referenced items',icon:'G',type:'action',action:()=>{closeCommandPalette();showKnowledgeGraphStats();}});
  }
  // Random content prefix
  if(ql && (ql==='random' || ql==='random content' || ql==='surprise' || ql==='resurface')){
    items.unshift({title:'Random Content',desc:'Resurface a random content item for review',icon:'?',type:'action',action:()=>{closeCommandPalette();showRandomContent();}});
  }
  // Clipboard history prefix
  if(ql && (ql==='clipboard' || ql==='clipboard history' || ql==='copy history' || ql==='paste history')){
    items.unshift({title:'Clipboard History',desc:'View recently copied text within ASTRA',icon:'C',type:'action',action:()=>{closeCommandPalette();showClipboardHistory();}});
  }
  // World clock prefix
  if(ql && (ql==='world clock' || ql==='time zones' || ql==='clock' || ql==='timezone')){
    items.unshift({title:'World Clock',desc:'Live clocks for 6 time zones',icon:'C',type:'action',action:()=>{closeCommandPalette();showTimeZoneClock();}});
  }
  // Content diff prefix
  if(ql && (ql==='diff' || ql==='content diff' || ql==='compare' || ql==='compare content')){
    items.unshift({title:'Content Diff Viewer',desc:'Compare two content items side by side',icon:'D',type:'action',action:()=>{closeCommandPalette();showContentDiff();}});
  }
  // Backup prefix
  if(ql && (ql==='backup' || ql==='workspace backup' || ql==='download backup' || ql==='restore backup')){
    items.unshift({title:'Workspace Backup',desc:'Download or restore full workspace backup',icon:'B',type:'action',action:()=>{closeCommandPalette();showWorkspaceBackupPanel();}});
  }
  // Burnup chart prefix
  if(ql && (ql==='burnup' || ql==='burnup chart' || ql==='task burnup' || ql==='cumulative')){
    items.unshift({title:'Task Burnup Chart',desc:'Cumulative created vs completed over 12 weeks',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBurnup();}});
  }
  // Content metrics prefix
  if(ql && (ql==='content metrics' || ql==='readability' || ql==='flesch' || ql==='vocabulary')){
    items.unshift({title:'Content Metrics',desc:'Readability score, vocab richness, sentence analysis',icon:'M',type:'action',action:()=>{closeCommandPalette();showContentMetrics();}});
  }
  // Markdown preview prefix
  if(ql && (ql==='markdown' || ql==='markdown preview' || ql==='md preview' || ql==='preview')){
    items.unshift({title:'Markdown Preview',desc:'Preview latest content as rendered markdown',icon:'M',type:'action',action:()=>{closeCommandPalette();showMarkdownPreview();}});
  }
  // Task completion heatmap prefix
  if(ql && (ql==='completion heatmap' || ql==='task heatmap' || ql==='done heatmap' || ql==='completion heat')){
    items.unshift({title:'Task Completion Heatmap',desc:'6-month heatmap of task completions',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskCompletionHeatmap();}});
  }
  // Saved searches prefix
  if(ql && (ql==='saved searches' || ql==='saved search' || ql==='search history' || ql==='my searches')){
    items.unshift({title:'Saved Searches',desc:'Save and recall frequent Cmd+K queries',icon:'S',type:'action',action:()=>{closeCommandPalette();showSavedSearches();}});
  }
  // Stale content prefix
  if(ql && (ql==='stale' || ql==='stale content' || ql==='old content' || ql==='outdated')){
    items.unshift({title:'Stale Content Finder',desc:'Content items older than 30 days',icon:'S',type:'action',action:()=>{closeCommandPalette();showStaleContent();}});
  }
  // Quick timer prefix
  if(ql && ql.startsWith('timer:')){
    const mins=parseInt(ql.substring(6).trim());
    if(mins>0&&mins<=120){
      items.unshift({title:'Start '+mins+' min Timer',desc:'Countdown timer in bottom-right corner',icon:'T',type:'action',action:()=>{closeCommandPalette();startQuickTimer(mins);}});
    }
  }
  // Project health prefix
  if(ql && (ql==='project health' || ql==='health dashboard' || ql==='project scores' || ql==='health')){
    items.unshift({title:'Project Health Dashboard',desc:'Health scores based on tasks, content, docs, overdue',icon:'H',type:'action',action:()=>{closeCommandPalette();showProjectHealthDashboard();}});
  }
  // Task matrix prefix
  if(ql && (ql==='matrix' || ql==='task matrix' || ql==='priority matrix' || ql==='quadrant')){
    items.unshift({title:'Task Priority Matrix',desc:'4-quadrant urgent/important matrix',icon:'M',type:'action',action:()=>{closeCommandPalette();showTaskMatrix();}});
  }
  // Content bookmarks prefix
  if(ql && (ql==='bookmarks' || ql==='content bookmarks' || ql==='my bookmarks' || ql==='saved content')){
    items.unshift({title:'Content Bookmarks',desc:'Quick-access bookmarked content items',icon:'B',type:'action',action:()=>{closeCommandPalette();showContentBookmarks();}});
  }
  // System status prefix
  if(ql && (ql==='system status' || ql==='system' || ql==='astra status' || ql==='status')){
    items.unshift({title:'ASTRA System Status',desc:'Tasks, content, storage, session time, theme',icon:'S',type:'action',action:()=>{closeCommandPalette();showSystemStatus();}});
  }
  // Auto tag prefix
  if(ql && (ql==='auto tag' || ql==='tag suggestions' || ql==='suggest tags' || ql==='auto tags')){
    items.unshift({title:'Auto-Tag Suggestions',desc:'Suggest tags for untagged content items',icon:'T',type:'action',action:()=>{closeCommandPalette();showAutoTagSuggestions();}});
  }
  // Sprint view prefix
  if(ql && (ql==='sprint' || ql==='sprint view' || ql==='sprints' || ql==='weekly sprint')){
    items.unshift({title:'Sprint View',desc:'Tasks grouped into weekly sprints',icon:'S',type:'action',action:()=>{closeCommandPalette();showSprintView();}});
  }
  // Color legend prefix
  if(ql && (ql==='color legend' || ql==='colors' || ql==='legend' || ql==='color guide')){
    items.unshift({title:'Color Legend',desc:'What all colors mean across ASTRA',icon:'C',type:'action',action:()=>{closeCommandPalette();showColorLegend();}});
  }
  // Daily digest prefix
  if(ql && (ql==='daily digest' || ql==='digest' || ql==='daily email' || ql==='daily summary')){
    items.unshift({title:'Daily Digest',desc:'Generate and copy comprehensive daily summary',icon:'D',type:'action',action:()=>{closeCommandPalette();generateDailyDigest();}});
  }
  // Content archive prefix
  if(ql && (ql==='content archive' || ql==='archive content' || ql==='archived content' || ql==='old content archive')){
    items.unshift({title:'Content Archive',desc:'Archive old content and restore archived items',icon:'A',type:'action',action:()=>{closeCommandPalette();showContentArchive();}});
  }
  // Changelog prefix
  if(ql && (ql==='changelog' || ql==='change log' || ql==='changes' || ql==='activity log')){
    items.unshift({title:'Workspace Changelog',desc:'View session change log',icon:'L',type:'action',action:()=>{closeCommandPalette();showChangelog();}});
  }
  // Focus config prefix
  if(ql && (ql==='focus config' || ql==='focus settings' || ql==='focus mode config' || ql==='pomodoro config')){
    items.unshift({title:'Focus Mode Config',desc:'Set duration, breaks, blocked sections',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusModeConfig();}});
  }
  // Action items prefix
  if(ql && (ql==='action items' || ql==='extract actions' || ql==='extract todos' || ql==='note to task')){
    items.unshift({title:'Extract Action Items',desc:'Find TODO/ACTION items in content and create tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();extractActionItems();}});
  }
  // Weekly planner prefix
  if(ql && (ql==='weekly planner' || ql==='week planner' || ql==='plan week' || ql==='week view planner')){
    items.unshift({title:'Weekly Planner',desc:'Week-at-a-glance with tasks in day slots',icon:'W',type:'action',action:()=>{closeCommandPalette();showWeeklyPlanner();}});
  }
  // Project switcher prefix
  if(ql && (ql==='switch project' || ql==='project switcher' || ql==='projects' || ql==='switch')){
    items.unshift({title:'Project Switcher',desc:'Quick switch between projects',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectSwitcher();}});
  }
  // Task chains prefix
  if(ql && (ql==='task chains' || ql==='dependency chains' || ql==='chains' || ql==='blocked chains')){
    items.unshift({title:'Task Dependency Chains',desc:'Visualize blocked-by task chains',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskChainsView();}});
  }
  // Theme breakdown prefix
  if(ql && (ql==='themes' || ql==='theme breakdown' || ql==='content themes' || ql==='theme chart')){
    items.unshift({title:'Content Theme Breakdown',desc:'Bar chart of content themes with counts',icon:'T',type:'action',action:()=>{closeCommandPalette();showThemeBreakdown();}});
  }
  // Multi-project dashboard prefix
  if(ql && (ql==='multi project' || ql==='all projects' || ql==='project dashboard' || ql==='multi')){
    items.unshift({title:'Multi-Project Dashboard',desc:'Summary stats across all projects',icon:'M',type:'action',action:()=>{closeCommandPalette();showMultiProjectDashboard();}});
  }
  // Export themes prefix
  if(ql && (ql==='export themes' || ql==='export by theme' || ql==='theme export' || ql==='content export themes')){
    items.unshift({title:'Export Content by Theme',desc:'Copy all content grouped by theme as markdown',icon:'E',type:'action',action:()=>{closeCommandPalette();exportContentByTheme();}});
  }
  // Global search prefix
  if(ql && (ql==='global search' || ql==='search all' || ql==='deep search' || ql==='find everything')){
    items.unshift({title:'Global Search',desc:'Dedicated search panel across all data',icon:'S',type:'action',action:()=>{closeCommandPalette();showGlobalSearch();}});
  }
  // Notification center prefix
  if(ql && (ql==='notifications' || ql==='alerts' || ql==='notification center' || ql==='warnings')){
    items.unshift({title:'Notification Center',desc:'Overdue, WIP warnings, streak, storage alerts',icon:'N',type:'action',action:()=>{closeCommandPalette();showNotificationCenter();}});
  }
  // Stats history prefix
  if(ql && (ql==='stats history' || ql==='daily stats' || ql==='growth' || ql==='workspace growth')){
    items.unshift({title:'Stats History',desc:'Daily stats tracked over 90 days with bar chart',icon:'S',type:'action',action:()=>{closeCommandPalette();showStatsHistory();}});
  }
  // Board filters prefix
  if(ql && (ql==='board filters' || ql==='kanban filters' || ql==='filter board' || ql==='board filter')){
    items.unshift({title:'Board Filters',desc:'Filter kanban by priority, project, due date',icon:'F',type:'action',action:()=>{closeCommandPalette();showKanbanFilters();}});
  }
  // Scratchpad prefix
  if(ql && (ql==='scratchpad' || ql==='scratch' || ql==='notepad' || ql==='pad')){
    items.unshift({title:'Scratchpad',desc:'Quick persistent notepad for scratch work',icon:'S',type:'action',action:()=>{closeCommandPalette();showScratchpad();}});
  }
  // Printable export prefix
  if(ql && (ql==='print export' || ql==='print' || ql==='printable' || ql==='html export')){
    items.unshift({title:'Printable Export',desc:'Download formatted HTML with tasks and content',icon:'P',type:'action',action:()=>{closeCommandPalette();printableExport();}});
  }
  // Slides export prefix
  if(ql && (ql==='slides' || ql==='presentation' || ql==='content slides' || ql==='slideshow')){
    items.unshift({title:'Content to Slides',desc:'Export content as dark-themed HTML slides',icon:'S',type:'action',action:()=>{closeCommandPalette();contentToSlides();}});
  }
  // Workload prefix
  if(ql && (ql==='workload' || ql==='task workload' || ql==='workload forecast' || ql==='load')){
    items.unshift({title:'Workload Forecast',desc:'14-day task workload with overload warnings',icon:'W',type:'action',action:()=>{closeCommandPalette();showWorkloadIndicator();}});
  }
  // Gratitude prefix
  if(ql && (ql==='gratitude' || ql==='gratitude journal' || ql==='grateful' || ql==='journal')){
    items.unshift({title:'Gratitude Journal',desc:'Daily gratitude entries with streak tracking',icon:'G',type:'action',action:()=>{closeCommandPalette();showGratitudeJournal();}});
  }
  // Task templates prefix
  if(ql && (ql==='task templates' || ql==='templates task' || ql==='template library' || ql==='new from template')){
    items.unshift({title:'Task Template Library',desc:'8 templates: bug fix, feature, research, review, etc.',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTemplateLibrary();}});
  }
  // Lifetime focus stats prefix
  if(ql && (ql==='lifetime focus' || ql==='focus lifetime' || ql==='pomo stats' || ql==='total focus')){
    items.unshift({title:'Lifetime Focus Stats',desc:'Total hours, sessions, avg/day, best day',icon:'F',type:'action',action:()=>{closeCommandPalette();showLifetimePomodoroStats();}});
  }
  // Creation calendar prefix
  if(ql && (ql==='creation calendar' || ql==='content creation' || ql==='created when' || ql==='creation cal')){
    items.unshift({title:'Creation Calendar',desc:'Month grid showing content creation dates',icon:'C',type:'action',action:()=>{closeCommandPalette();showCreationCalendar();}});
  }
  // Smart suggestions prefix
  if(ql && (ql==='suggestions' || ql==='smart suggestions' || ql==='next actions' || ql==='what to do')){
    items.unshift({title:'Smart Suggestions',desc:'AI-like suggestions based on current workspace state',icon:'S',type:'action',action:()=>{closeCommandPalette();showSmartSuggestions();}});
  }
  // Link categories prefix
  if(ql && (ql==='link categories' || ql==='link chart' || ql==='link breakdown' || ql==='link stats')){
    items.unshift({title:'Link Category Chart',desc:'Visual breakdown of link categories',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkCategoryChart();}});
  }
  // Priority distribution prefix
  if(ql && (ql==='priority distribution' || ql==='priority chart' || ql==='priority stats' || ql==='task priority')){
    items.unshift({title:'Priority Distribution',desc:'Bar chart showing P0/P1/P2/P3 distribution',icon:'P',type:'action',action:()=>{closeCommandPalette();showPriorityDistribution();}});
  }
  // Mood tracker prefix
  if(ql && (ql==='mood' || ql==='mood tracker' || ql==='how am i feeling' || ql==='feeling')){
    items.unshift({title:'Mood Tracker',desc:'Log daily mood with trend visualization',icon:'M',type:'action',action:()=>{closeCommandPalette();showMoodTracker();}});
  }
  // Repo timeline prefix
  if(ql && (ql==='repo timeline' || ql==='repo overview' || ql==='repos overview' || ql==='all repos')){
    items.unshift({title:'Repo Overview',desc:'All repos with status, URLs, and last commit',icon:'R',type:'action',action:()=>{closeCommandPalette();showRepoTimeline();}});
  }
  // Micro journal prefix
  if(ql && (ql==='micro journal' || ql==='micro' || ql==='one liner' || ql==='quick journal')){
    items.unshift({title:'Micro Journal',desc:'Quick daily one-liner journal entries',icon:'J',type:'action',action:()=>{closeCommandPalette();showMicroJournal();}});
  }
  // Completion rate prefix
  if(ql && (ql==='completion rate' || ql==='completion' || ql==='done rate' || ql==='task rate')){
    items.unshift({title:'Weekly Completion Rate',desc:'Completion rate per week with progress bars',icon:'C',type:'action',action:()=>{closeCommandPalette();showCompletionRate();}});
  }
  // Export book prefix
  if(ql && (ql==='export book' || ql==='content book' || ql==='markdown book' || ql==='book export')){
    items.unshift({title:'Export Content as Book',desc:'Download all content as structured markdown book',icon:'B',type:'action',action:()=>{closeCommandPalette();exportContentAsBook();}});
  }
  // Workspace overview prefix
  if(ql && (ql==='overview' || ql==='workspace overview' || ql==='dashboard overview' || ql==='everything')){
    items.unshift({title:'Workspace Overview',desc:'Full dashboard: tasks, content, links, docs, projects, storage',icon:'O',type:'action',action:()=>{closeCommandPalette();showWorkspaceOverview();}});
  }
  // Sentiment prefix
  if(ql && (ql==='sentiment' || ql==='content sentiment' || ql==='mood analysis' || ql==='positive negative')){
    items.unshift({title:'Content Sentiment',desc:'Keyword-based positive/neutral/negative analysis',icon:'S',type:'action',action:()=>{closeCommandPalette();showContentSentiment();}});
  }
  // Project completion prefix
  if(ql && (ql==='project completion' || ql==='completion timeline' || ql==='project progress' || ql==='project bars')){
    items.unshift({title:'Project Completion Timeline',desc:'Bar chart of completion % per project',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectCompletionTimeline();}});
  }
  // Content calendar prefix
  if(ql && (ql==='content calendar' || ql==='creation dates' || ql==='content month' || ql==='when created')){
    items.unshift({title:'Content Calendar',desc:'Month calendar showing content creation dates',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentCalendar();}});
  }
  // Velocity prefix
  if(ql && (ql==='velocity' || ql==='task velocity' || ql==='throughput' || ql==='tasks per week')){
    items.unshift({title:'Task Velocity',desc:'Completed vs created per week (8-week chart)',icon:'V',type:'action',action:()=>{closeCommandPalette();showTaskVelocity();}});
  }
  // Tag cloud prefix
  if(ql && (ql==='tag cloud' || ql==='tags visual' || ql==='all tags' || ql==='tag frequency')){
    items.unshift({title:'Tag Cloud',desc:'Visual tag cloud sized by frequency',icon:'#',type:'action',action:()=>{closeCommandPalette();showTagCloud();}});
  }
  // Due calendar prefix
  if(ql && (ql==='due calendar' || ql==='due dates' || ql==='deadline calendar' || ql==='due month')){
    items.unshift({title:'Due Date Calendar',desc:'Month calendar of task due dates',icon:'D',type:'action',action:()=>{closeCommandPalette();showDueCalendar();}});
  }
  // Productivity prefix
  if(ql && (ql==='productivity' || ql==='productivity insights' || ql==='weekly insights' || ql==='performance')){
    items.unshift({title:'Productivity Insights',desc:'Weekly trends, comparisons, and actionable tips',icon:'P',type:'action',action:()=>{closeCommandPalette();showProductivityInsights();}});
  }
  // Category breakdown prefix
  if(ql && (ql==='category breakdown' || ql==='categories' || ql==='content breakdown' || ql==='pie chart')){
    items.unshift({title:'Category Breakdown',desc:'Stacked bar chart of content categories',icon:'C',type:'action',action:()=>{closeCommandPalette();showCategoryBreakdown();}});
  }
  // Recent activity prefix
  if(ql && (ql==='recent activity' || ql==='activity feed' || ql==='activity log' || ql==='recent')){
    items.unshift({title:'Recent Activity',desc:'Unified activity feed across all sections',icon:'A',type:'action',action:()=>{closeCommandPalette();showRecentActivity();}});
  }
  // Quick note prefix
  if(ql && (ql==='quick note' || ql==='note' || ql==='jot' || ql==='capture note')){
    items.unshift({title:'Quick Note',desc:'Floating quick note (saves to content)',icon:'N',type:'action',action:()=>{closeCommandPalette();showQuickNote();}});
  }
  // Writer stats prefix
  if(ql && (ql==='writer stats' || ql==='writing stats' || ql==='doc stats' || ql==='writer analytics')){
    items.unshift({title:'Writer Statistics',desc:'Docs, words, pages, versions, rankings',icon:'W',type:'action',action:()=>{closeCommandPalette();showWriterStats();}});
  }
  // Link domains prefix
  if(ql && (ql==='link domains' || ql==='domains' || ql==='domain breakdown' || ql==='most linked')){
    items.unshift({title:'Link Domain Breakdown',desc:'Most linked domains with frequency bars',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkDomainBreakdown();}});
  }
  // Time report prefix
  if(ql && (ql==='time report' || ql==='time tracking' || ql==='time breakdown' || ql==='hours tracked')){
    items.unshift({title:'Time Tracking Report',desc:'Detailed time report by project and task',icon:'T',type:'action',action:()=>{closeCommandPalette();showTimeTrackingReport();}});
  }
  // Content timeline prefix
  if(ql && (ql==='content timeline' || ql==='creation history' || ql==='content history' || ql==='timeline')){
    items.unshift({title:'Content Timeline',desc:'Vertical timeline of content creation dates',icon:'T',type:'action',action:()=>{closeCommandPalette();showContentTimeline();}});
  }
  // Goals prefix
  if(ql && (ql==='goals' || ql==='goal tracker' || ql==='weekly goals' || ql==='monthly goals')){
    items.unshift({title:'Goal Tracker',desc:'Set and track weekly/monthly goals',icon:'G',type:'action',action:()=>{closeCommandPalette();showGoalTracker();}});
  }
  // Quick task prefix
  if(ql && (ql==='quick task' || ql==='fast task' || ql==='new task quick' || ql==='task quick')){
    items.unshift({title:'Quick Task',desc:'Floating quick task creator',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTask();}});
  }
  // Data explorer prefix
  if(ql && (ql==='data explorer' || ql==='raw data' || ql==='state data' || ql==='browse data')){
    items.unshift({title:'Data Explorer',desc:'Browse raw workspace state data',icon:'D',type:'action',action:()=>{closeCommandPalette();showDataExplorer();}});
  }
  // Project comparison prefix
  if(ql && (ql==='project comparison' || ql==='compare projects' || ql==='project compare' || ql==='side by side')){
    items.unshift({title:'Project Comparison',desc:'Side-by-side project metrics table',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectComparison();}});
  }
  // Weekly review prefix
  if(ql && (ql==='weekly review' || ql==='week review' || ql==='review' || ql==='week summary')){
    items.unshift({title:'Weekly Review',desc:'Comprehensive weekly review with copy button',icon:'R',type:'action',action:()=>{closeCommandPalette();showWeeklyReview();}});
  }
  // Achievements prefix
  if(ql && (ql==='achievements' || ql==='badges' || ql==='milestones' || ql==='gamification')){
    items.unshift({title:'Achievements',desc:'Unlockable milestones based on usage',icon:'*',type:'action',action:()=>{closeCommandPalette();showAchievements();}});
  }
  // Focus history prefix
  if(ql && (ql==='focus history' || ql==='pomodoro history' || ql==='focus sessions' || ql==='session history')){
    items.unshift({title:'Focus History',desc:'All focus/Pomodoro sessions with 14-day chart',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusHistory();}});
  }
  // Quick link prefix
  if(ql && (ql==='quick link' || ql==='save link' || ql==='fast link' || ql==='add link quick')){
    items.unshift({title:'Quick Link',desc:'Floating quick link saver',icon:'L',type:'action',action:()=>{closeCommandPalette();showQuickLink();}});
  }
  // Storage prefix
  if(ql && (ql==='storage' || ql==='storage manager' || ql==='disk usage' || ql==='localstorage')){
    items.unshift({title:'Storage Manager',desc:'Visual localStorage breakdown',icon:'S',type:'action',action:()=>{closeCommandPalette();showStorageManager();}});
  }
  // Task aging prefix
  if(ql && (ql==='task aging' || ql==='stale tasks' || ql==='old tasks' || ql==='aging report')){
    items.unshift({title:'Task Aging Report',desc:'Tasks ranked by age with stale detection',icon:'!',type:'action',action:()=>{closeCommandPalette();showTaskAging();}});
  }
  // Word frequency prefix
  if(ql && (ql==='word frequency' || ql==='top words' || ql==='word count' || ql==='frequent words')){
    items.unshift({title:'Word Frequency',desc:'Top 30 words across all content',icon:'W',type:'action',action:()=>{closeCommandPalette();showContentWordFrequency();}});
  }
  // Daily planner prefix
  if(ql && (ql==='daily planner' || ql==='today plan' || ql==='day plan' || ql==='planner')){
    items.unshift({title:'Daily Planner',desc:'Today time blocks with tasks and overdue',icon:'P',type:'action',action:()=>{closeCommandPalette();showDailyPlanner();}});
  }
  // Content length prefix
  if(ql && (ql==='content length' || ql==='length chart' || ql==='content size' || ql==='word length')){
    items.unshift({title:'Content Length Distribution',desc:'Items by word count: tiny to epic',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentLengthChart();}});
  }
  // Project notes prefix
  if(ql && (ql==='project notes' || ql==='proj notes' || ql==='notes per project' || ql==='project memo')){
    items.unshift({title:'Project Notes',desc:'Quick persistent notes per project',icon:'N',type:'action',action:()=>{closeCommandPalette();showProjectNotes();}});
  }
  // Duplicates prefix
  if(ql && (ql==='duplicates' || ql==='duplicate detector' || ql==='find dupes' || ql==='dedup')){
    items.unshift({title:'Duplicate Detector',desc:'Find duplicate content and tasks by similarity',icon:'D',type:'action',action:()=>{closeCommandPalette();showDuplicateDetector();}});
  }
  // Universal search prefix
  if(ql && (ql==='universal search' || ql==='search all' || ql==='find everything' || ql==='deep search')){
    items.unshift({title:'Universal Search',desc:'Search everything with live results',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickSearchPanel();}});
  }
  // Eisenhower prefix
  if(ql && (ql==='eisenhower' || ql==='eisenhower matrix' || ql==='urgent important' || ql==='priority matrix')){
    items.unshift({title:'Eisenhower Matrix',desc:'2x2 Urgent/Important task matrix',icon:'E',type:'action',action:()=>{closeCommandPalette();showEisenhowerMatrix();}});
  }
  // Writer progress prefix
  if(ql && (ql==='writer progress' || ql==='word targets' || ql==='writing goals' || ql==='doc progress')){
    items.unshift({title:'Writer Progress',desc:'Word count targets per doc',icon:'W',type:'action',action:()=>{closeCommandPalette();showWriterProgress();}});
  }
  // Batch ops prefix
  if(ql && (ql==='batch ops' || ql==='batch operations' || ql==='bulk operations' || ql==='mass edit')){
    items.unshift({title:'Batch Operations',desc:'Bulk tag, rename, archive operations',icon:'B',type:'action',action:()=>{closeCommandPalette();showBatchOperations();}});
  }
  // Context switcher prefix
  if(ql && (ql==='context' || ql==='workspace context' || ql==='switch context' || ql==='mode')){
    items.unshift({title:'Context Switcher',desc:'Switch workspace context: work, personal, creative',icon:'C',type:'action',action:()=>{closeCommandPalette();showContextSwitcher();}});
  }
  // Daily checklist prefix
  if(ql && (ql==='daily checklist' || ql==='checklist' || ql==='daily routine' || ql==='morning checklist')){
    items.unshift({title:'Daily Checklist',desc:'Recurring checklist that resets each morning',icon:'V',type:'action',action:()=>{closeCommandPalette();showDailyChecklist();}});
  }
  // Knowledge map prefix
  if(ql && (ql==='knowledge map' || ql==='wiki map' || ql==='link map' || ql==='backlinks map')){
    items.unshift({title:'Knowledge Map',desc:'Map of [[wiki-link]] connections',icon:'K',type:'action',action:()=>{closeCommandPalette();showKnowledgeMap();}});
  }
  // Export hub prefix
  if(ql && (ql==='export hub' || ql==='export all' || ql==='download data' || ql==='export formats')){
    items.unshift({title:'Export Hub',desc:'JSON, CSV, Markdown, HTML exports',icon:'E',type:'action',action:()=>{closeCommandPalette();showContentExportHub();}});
  }
  // Dependencies prefix
  if(ql && (ql==='dependencies' || ql==='task dependencies' || ql==='dependency graph' || ql==='blocked tasks')){
    items.unshift({title:'Task Dependencies',desc:'Visual graph of blocking/blocked tasks',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDependencyGraph();}});
  }
  // Inbox zero prefix
  if(ql && (ql==='inbox zero' || ql==='inbox' || ql==='triage' || ql==='unprocessed')){
    items.unshift({title:'Inbox Zero Triage',desc:'Find uncategorized/incomplete items',icon:'I',type:'action',action:()=>{closeCommandPalette();showInboxZero();}});
  }
  // Reading list prefix
  if(ql && (ql==='reading list' || ql==='read list' || ql==='to read' || ql==='unread links')){
    items.unshift({title:'Reading List',desc:'Track read/unread links',icon:'R',type:'action',action:()=>{closeCommandPalette();showReadingList();}});
  }
  // Project status prefix
  if(ql && (ql==='project status' || ql==='status board' || ql==='project health' || ql==='status update')){
    items.unshift({title:'Project Status Board',desc:'Status for all projects (on-track/at-risk/blocked)',icon:'S',type:'action',action:()=>{closeCommandPalette();showProjectStatusBoard();}});
  }
  // Dashboard prefix
  if(ql && (ql==='dashboard' || ql==='astra dashboard' || ql==='home' || ql==='main dashboard')){
    items.unshift({title:'ASTRA Dashboard',desc:'Stats, overdue, and quick actions',icon:'H',type:'action',action:()=>{closeCommandPalette();showCustomDashboard();}});
  }
  // Captures prefix
  if(ql && (ql==='captures' || ql==='capture summary' || ql==='quick captures' || ql==='nexus captures')){
    items.unshift({title:'Capture Summary',desc:'Quick captures by type with recent list',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCaptureSummary();}});
  }
  // Notes explorer prefix
  if(ql && (ql==='notes explorer' || ql==='browse notes' || ql==='content tree' || ql==='folder view')){
    items.unshift({title:'Notes Explorer',desc:'Tree-view content organized by category',icon:'N',type:'action',action:()=>{closeCommandPalette();showNotesExplorer();}});
  }
  // Deadlines prefix
  if(ql && (ql==='deadlines' || ql==='deadline tracker' || ql==='countdowns' || ql==='due soon')){
    items.unshift({title:'Deadline Tracker',desc:'Countdown to upcoming task deadlines',icon:'!',type:'action',action:()=>{closeCommandPalette();showDeadlineTracker();}});
  }
  // Content graph prefix
  if(ql && (ql==='content graph' || ql==='creation graph' || ql==='content trends' || ql==='30 day chart')){
    items.unshift({title:'Content Creation Graph',desc:'30-day creation trends with word counts',icon:'G',type:'action',action:()=>{closeCommandPalette();showContentGraph();}});
  }
  // Advanced search prefix
  if(ql && (ql==='advanced search' || ql==='filtered search' || ql==='search filters' || ql==='power search')){
    items.unshift({title:'Advanced Search',desc:'Search with type and date filters',icon:'S',type:'action',action:()=>{closeCommandPalette();showWorkspaceSearch();}});
  }
  // Quote prefix
  if(ql && (ql==='quote' || ql==='motivation' || ql==='inspire' || ql==='motivational')){
    items.unshift({title:'Motivational Quote',desc:'Random curated motivational quote',icon:'Q',type:'action',action:()=>{closeCommandPalette();showMotivationalQuote();}});
  }
  // Accent color prefix
  if(ql && (ql==='accent color' || ql==='theme color' || ql==='color picker' || ql==='accent')){
    items.unshift({title:'Accent Color Picker',desc:'Change ASTRA accent color (12 options)',icon:'C',type:'action',action:()=>{closeCommandPalette();showColorThemePicker();}});
  }
  // Session log prefix
  if(ql && (ql==='session log' || ql==='work log' || ql==='log session' || ql==='what i did')){
    items.unshift({title:'Session Log',desc:'Log what you worked on with timestamps',icon:'L',type:'action',action:()=>{closeCommandPalette();showSessionLog();}});
  }
  // Recent edits prefix
  if(ql && (ql==='recent edits' || ql==='last edited' || ql==='recently modified' || ql==='latest edits')){
    items.unshift({title:'Recent Edits',desc:'Most recently edited items everywhere',icon:'R',type:'action',action:()=>{closeCommandPalette();showRecentEdits();}});
  }
  // Doc outline prefix
  if(ql && (ql==='doc outline' || ql==='document outline' || ql==='headings' || ql==='doc structure')){
    items.unshift({title:'Document Outlines',desc:'Heading structure of writer docs',icon:'O',type:'action',action:()=>{closeCommandPalette();showDocOutline();}});
  }
  // Backlog prefix
  if(ql && (ql==='backlog' || ql==='backlog groomer' || ql==='unscheduled' || ql==='groom backlog')){
    items.unshift({title:'Backlog Groomer',desc:'Prioritize and schedule unassigned tasks',icon:'B',type:'action',action:()=>{closeCommandPalette();showBacklogGroomer();}});
  }
  return items.slice(0, 20);
}
function importBookmarks(){
  const input=document.createElement('input');input.type='file';input.accept='.html,.htm';
  input.onchange=e=>{const f=e.target.files[0];if(!f)return;const reader=new FileReader();
    reader.onload=ev=>{
      const html=ev.target.result;const parser=new DOMParser();const doc=parser.parseFromString(html,'text/html');
      const links=doc.querySelectorAll('a[href]');let count=0;
      links.forEach(a=>{
        const url=a.href;const title=a.textContent.trim()||url;
        if(!url.startsWith('http'))return;
        if(S.links.some(l=>l.url===url))return;
        let category='imported';
        const parent=a.closest('dl');if(parent){const h3=parent.previousElementSibling;if(h3&&h3.tagName==='H3')category=h3.textContent.trim().toLowerCase().substring(0,30);}
        S.links.push({id:Date.now()+count,title:title.substring(0,120),url,category,desc:'',tags:['imported'],created:new Date().toISOString()});
        count++;
      });
      save();renderLinks();toast('Imported '+count+' bookmarks ('+links.length+' total, dupes skipped)');
    };reader.readAsText(f);
  };input.click();
}
function showActivityTimeline(){
  let panel=document.getElementById('timeline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  const events=[];
  S.tasks.forEach(t=>{if(t.created)events.push({date:t.created,type:'task',action:'created',title:t.title,icon:'T',color:'var(--accent-cyan)'});if(t.completedAt)events.push({date:t.completedAt,type:'task',action:'completed',title:t.title,icon:'T',color:'var(--green)'});});
  S.content.forEach(c=>{if(c.created)events.push({date:c.created,type:'content',action:'added',title:(c.body||'').substring(0,60),icon:'C',color:'var(--yellow)'});});
  S.docs.forEach(d=>{if(d.created)events.push({date:d.created,type:'doc',action:'created',title:d.title,icon:'D',color:'var(--accent)'});if(d.updated&&d.updated!==d.created)events.push({date:d.updated,type:'doc',action:'updated',title:d.title,icon:'D',color:'var(--accent)'});});
  S.links.forEach(l=>{if(l.created)events.push({date:l.created,type:'link',action:'saved',title:l.title||l.url,icon:'L',color:'#a78bfa'});});
  (S.focusSessions||[]).forEach(f=>{events.push({date:f.date+'T12:00:00',type:'focus',action:f.minutes+'min session',title:f.task||'Focus',icon:'F',color:'var(--orange)'});});
  events.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const recent=events.slice(0,50);
  let lastDay='';
  const html=recent.map(e=>{
    const ds=(e.date||'').split('T')[0];
    let dayHeader='';
    if(ds!==lastDay){dayHeader=`<div style="padding:8px 0 4px;font-size:10px;font-weight:600;color:var(--accent);font-family:var(--mono);border-bottom:1px solid var(--border);margin-top:8px">${ds}</div>`;lastDay=ds;}
    const time=e.date.includes('T')?new Date(e.date).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}):'';
    return dayHeader+`<div style="display:flex;gap:8px;padding:4px 0;align-items:flex-start"><span style="min-width:14px;height:14px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:${e.color};background:${e.color}15;border-radius:3px;font-family:var(--mono)">${e.icon}</span><div style="flex:1;font-size:10px"><span style="color:var(--text-muted)">${e.action}</span> <span style="color:var(--text-primary)">${esc((e.title||'').substring(0,70))}</span></div><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);white-space:nowrap">${time}</span></div>`;
  }).join('');
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Activity Timeline (${recent.length} events)</span><button onclick="document.getElementById('timeline-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${html||'<div style="padding:20px;text-align:center;color:var(--text-muted)">No activity yet</div>'}`;
  document.body.appendChild(panel);
}
function downloadBackup(){
  const data=JSON.stringify(S,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='saturno-hub-backup-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();URL.revokeObjectURL(url);
  S._lastBackup=new Date().toISOString();save();
  toast('Backup downloaded');
}
function toggleAutoBackup(){
  S._autoBackup=!S._autoBackup;save();
  if(S._autoBackup){scheduleAutoBackup();toast('Auto-backup enabled (every 4 hours)');}
  else{if(window._autoBackupTimer)clearInterval(window._autoBackupTimer);toast('Auto-backup disabled');}
}
function scheduleAutoBackup(){
  if(window._autoBackupTimer)clearInterval(window._autoBackupTimer);
  if(!S._autoBackup)return;
  window._autoBackupTimer=setInterval(function(){
    const lastB=S._lastBackup?new Date(S._lastBackup).getTime():0;
    if(Date.now()-lastB>=4*60*60*1000){downloadBackup();}
  },30*60*1000);
}
function importBackup(){
  const input=document.createElement('input');input.type='file';input.accept='.json';
  input.onchange=e=>{const f=e.target.files[0];if(!f)return;
    const reader=new FileReader();reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.tasks&&!data.content&&!data.docs){toast('Invalid backup file');return;}
        if(!confirm('This will MERGE backup data with current data. Continue?\\n\\nBackup contains: '+(data.tasks||[]).length+' tasks, '+(data.content||[]).length+' content, '+(data.docs||[]).length+' docs, '+(data.links||[]).length+' links'))return;
        const existingIds=new Set(S.tasks.map(t=>t.id));
        (data.tasks||[]).forEach(t=>{if(!existingIds.has(t.id))S.tasks.push(t);});
        const existingContentIds=new Set(S.content.map(c=>c.id));
        (data.content||[]).forEach(c=>{if(!existingContentIds.has(c.id))S.content.push(c);});
        const existingDocIds=new Set(S.docs.map(d=>d.id));
        (data.docs||[]).forEach(d=>{if(!existingDocIds.has(d.id))S.docs.push(d);});
        const existingLinkIds=new Set(S.links.map(l=>l.id));
        (data.links||[]).forEach(l=>{if(!existingLinkIds.has(l.id))S.links.push(l);});
        if(data.focusSessions&&!S.focusSessions)S.focusSessions=data.focusSessions;
        if(data.goals&&!S.goals)S.goals=data.goals;
        save();renderAll();toast('Backup merged successfully');
      }catch(err){toast('Error parsing backup: '+err.message);}
    };reader.readAsText(f);
  };input.click();
}
function renderAll(){renderContent();renderTasks();renderCalendar();renderWriter();renderSpecs();renderLinks();}
function exportAllDocs(){
  if(!S.docs.length){toast('No writer documents');return;}
  let md='# Writer Documents Export\\n# '+new Date().toISOString().split('T')[0]+'\\n\\n';
  S.docs.forEach(d=>{md+='---\\n\\n## '+esc(d.title||'Untitled')+'\\n\\n';md+=(d.body||'').replace(/<[^>]+>/g,' ').replace(/\\s+/g,' ').trim()+'\\n\\n';});
  const blob=new Blob([md],{type:'text/markdown'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='all-docs-'+new Date().toISOString().split('T')[0]+'.md';
  a.click();toast('Exported '+S.docs.length+' documents');
}
function exportAllDocsIndividual(){
  if(!S.docs.length){toast('No writer documents');return;}
  S.docs.forEach((d,i)=>{
    const text=(d.body||'').replace(/<[^>]+>/g,' ').replace(/\\s+/g,' ').trim();
    const md='# '+(d.title||'Untitled')+'\\n\\n'+text;
    const blob=new Blob([md],{type:'text/markdown'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=(d.title||'doc-'+i).replace(/[^a-z0-9]/gi,'-').toLowerCase()+'.md';
    setTimeout(()=>{a.click();},i*200);
  });
  toast('Downloading '+S.docs.length+' files...');
}
function openDailyJournal(){
  const today=new Date().toISOString().split('T')[0];
  const label=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  let doc=S.docs.find(d=>d.title&&d.title.startsWith('Journal '+today));
  if(!doc){
    doc={id:Date.now(),title:'Journal '+today,body:'<h2>'+label+'</h2><p></p><h3>Priorities</h3><p></p><h3>Notes</h3><p></p><h3>Reflections</h3><p></p>',created:new Date().toISOString(),updated:new Date().toISOString(),tags:['journal']};
    S.docs.unshift(doc);save();
  }
  switchSection('writer',null);
  setTimeout(()=>{const sel=document.getElementById('writer-doc-select');if(sel){sel.value=doc.id;loadDoc(doc.id);}},100);
  toast('Journal: '+today);
}
function showJournalArchive(){
  const entries=S.docs.filter(d=>d.title&&d.title.startsWith('Journal ')).sort((a,b)=>(b.title||'').localeCompare(a.title||''));
  let panel=document.getElementById('journal-archive-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='journal-archive-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:60vh;overflow-y:auto';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Journal Archive (${entries.length})</span><button onclick="document.getElementById('journal-archive-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`+
    (entries.length?entries.map(d=>{const wc=(d.body||'').replace(/<[^>]+>/g,' ').trim().split(/\s+/).filter(x=>x.length).length;return`<div onclick="document.getElementById('journal-archive-panel').remove();switchSection('writer',null);setTimeout(()=>{const sel=document.getElementById('writer-doc-select');if(sel){sel.value=${d.id};loadDoc(${d.id});}},100)" style="padding:6px 8px;cursor:pointer;border-left:3px solid var(--accent);margin-bottom:4px;border-radius:0 4px 4px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><div style="font-size:11px;color:var(--text-primary)">${esc(d.title)}</div><div style="font-size:9px;color:var(--text-muted)">${wc} words</div></div>`;}).join(''):'<div style="padding:20px;text-align:center;color:var(--text-muted)">No journal entries yet. Type "journal" in Cmd+K to start.</div>');
  document.body.appendChild(panel);
}
function showWritingStats(){
  let panel=document.getElementById('writing-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writing-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const totalWords=S.docs.reduce((sum,d)=>{const text=(d.body||'').replace(/<[^>]+>/g,' ');return sum+text.trim().split(/\s+/).filter(x=>x.length).length;},0);
  const totalContent=S.content.reduce((sum,c)=>sum+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
  const docsByDate={};
  S.docs.forEach(d=>{const ds=(d.updated||d.created||'').split('T')[0];if(ds){if(!docsByDate[ds])docsByDate[ds]=0;docsByDate[ds]++;}});
  // writing streak
  let streak=0;let checkDate=new Date();
  for(let i=0;i<365;i++){const ds=checkDate.toISOString().split('T')[0];if(docsByDate[ds]||S.content.some(c=>c.created&&c.created.startsWith(ds))){streak++;}else if(i>0)break;checkDate.setDate(checkDate.getDate()-1);}
  // daily word chart (last 7 days)
  const dailyWords=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];const wc=S.docs.filter(doc=>(doc.updated||doc.created||'').startsWith(ds)).reduce((sum,doc)=>{const text=(doc.body||'').replace(/<[^>]+>/g,' ');return sum+text.trim().split(/\s+/).filter(x=>x.length).length;},0)+S.content.filter(c=>c.created&&c.created.startsWith(ds)).reduce((sum,c)=>sum+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);dailyWords.push({date:ds,words:wc});}
  const maxW=Math.max(1,...dailyWords.map(d=>d.words));
  const bars=dailyWords.map(d=>`<div style="display:flex;flex-direction:column;align-items:center;gap:2px;flex:1"><div style="width:100%;height:60px;display:flex;align-items:flex-end"><div style="width:100%;height:${Math.max(2,d.words/maxW*60)}px;background:var(--accent);border-radius:2px 2px 0 0"></div></div><span style="font-size:7px;color:var(--text-muted)">${d.date.substring(8)}</span><span style="font-size:7px;color:var(--accent-cyan)">${d.words>0?d.words:''}</span></div>`).join('');
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Writing Stats</span><button onclick="document.getElementById('writing-stats-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px"><div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:18px;font-weight:700;color:var(--accent)">${totalWords.toLocaleString()}</div><div style="font-size:9px;color:var(--text-muted)">Doc Words</div></div><div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:18px;font-weight:700;color:var(--accent-cyan)">${totalContent.toLocaleString()}</div><div style="font-size:9px;color:var(--text-muted)">Content Words</div></div><div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:18px;font-weight:700;color:var(--green)">${streak}</div><div style="font-size:9px;color:var(--text-muted)">Day Streak</div></div></div><div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Last 7 Days</div><div style="display:flex;gap:4px">${bars}</div></div><div style="font-size:10px;color:var(--text-muted)">${S.docs.length} documents | ${S.content.length} content items | ${(totalWords+totalContent).toLocaleString()} total words</div>`;
  document.body.appendChild(panel);
}
function showDataCleanup(){
  let panel=document.getElementById('cleanup-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='cleanup-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  const issues=[];
  // Empty tasks
  const emptyTasks=S.tasks.filter(t=>!t.title||!t.title.trim());
  if(emptyTasks.length)issues.push({type:'warning',msg:emptyTasks.length+' tasks with empty titles',action:'Remove empty tasks',fn:()=>{S.tasks=S.tasks.filter(t=>t.title&&t.title.trim());save();renderTasks();showDataCleanup();toast('Removed '+emptyTasks.length+' empty tasks');}});
  // Empty content
  const emptyContent=S.content.filter(c=>!c.body||!c.body.trim());
  if(emptyContent.length)issues.push({type:'warning',msg:emptyContent.length+' content items with empty body',action:'Remove empty content',fn:()=>{S.content=S.content.filter(c=>c.body&&c.body.trim());save();renderContent();showDataCleanup();toast('Removed '+emptyContent.length+' empty content');}});
  // Duplicate content
  const seenBodies=new Set();const dupeContent=[];
  S.content.forEach(c=>{const key=(c.body||'').trim().substring(0,100);if(seenBodies.has(key))dupeContent.push(c);else seenBodies.add(key);});
  if(dupeContent.length)issues.push({type:'info',msg:dupeContent.length+' potential duplicate content items',action:'Remove duplicates (keep first)',fn:()=>{const seen=new Set();S.content=S.content.filter(c=>{const key=(c.body||'').trim().substring(0,100);if(seen.has(key))return false;seen.add(key);return true;});save();renderContent();showDataCleanup();toast('Removed '+dupeContent.length+' duplicates');}});
  // Duplicate links
  const seenUrls=new Set();const dupeLinks=[];
  S.links.forEach(l=>{if(seenUrls.has(l.url))dupeLinks.push(l);else seenUrls.add(l.url);});
  if(dupeLinks.length)issues.push({type:'info',msg:dupeLinks.length+' duplicate links (same URL)',action:'Remove duplicate links',fn:()=>{const seen=new Set();S.links=S.links.filter(l=>{if(seen.has(l.url))return false;seen.add(l.url);return true;});save();renderLinks();showDataCleanup();toast('Removed '+dupeLinks.length+' duplicate links');}});
  // Tasks without project
  const noProject=S.tasks.filter(t=>!t.project&&t.status!=='done');
  if(noProject.length>5)issues.push({type:'info',msg:noProject.length+' active tasks without a project'});
  // Old done tasks
  const oldDone=S.tasks.filter(t=>{if(t.status!=='done'||!t.completedAt)return false;return(Date.now()-new Date(t.completedAt).getTime())>30*86400000;});
  if(oldDone.length>10)issues.push({type:'info',msg:oldDone.length+' completed tasks older than 30 days',action:'Archive old completed tasks',fn:()=>{archiveCompletedTasks();}});
  // localStorage size
  const storageSize=JSON.stringify(S).length;
  issues.push({type:storageSize>4000000?'warning':'info',msg:'Storage: '+(storageSize/1024).toFixed(0)+'KB / 5MB ('+Math.round(storageSize/5000000*100)+'% used)'});
  const clr={warning:'var(--orange)',info:'var(--text-muted)',error:'var(--red)'};
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Data Cleanup</span><button onclick="document.getElementById('cleanup-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`+(issues.length?issues.map(i=>`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:4px;margin-bottom:4px;border-left:3px solid ${clr[i.type]}"><div style="flex:1;font-size:10px;color:var(--text-primary)">${esc(i.msg)}</div>${i.action?`<button onclick="document.getElementById('cleanup-panel').remove();(${i.fn.toString()})()" class="btn btn-sm btn-ghost" style="font-size:8px;white-space:nowrap">${i.action}</button>`:''}</div>`).join('')+'<div style="margin-top:12px;text-align:center;font-size:9px;color:var(--text-muted)">'+issues.length+' issues found</div>':'<div style="padding:20px;text-align:center;color:var(--accent)">No issues found. Data is clean.</div>');
  document.body.appendChild(panel);
}
function showProductivityReport(){
  let panel=document.getElementById('report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const monthStart=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const mTasks=S.tasks.filter(t=>t.created&&t.created>=monthStart);
  const mDone=S.tasks.filter(t=>t.completedAt&&t.completedAt>=monthStart);
  const mContent=S.content.filter(c=>c.created&&c.created>=monthStart);
  const mDocs=S.docs.filter(d=>(d.updated||d.created||'')>=monthStart);
  const mLinks=S.links.filter(l=>l.created&&l.created>=monthStart);
  const mFocus=(S.focusSessions||[]).filter(f=>f.date&&f.date>=monthStart);
  const focusMins=mFocus.reduce((a,f)=>a+(f.minutes||0),0);
  const totalWords=mDocs.reduce((s,d)=>(d.body||'').replace(/<[^>]+>/g,' ').trim().split(/\s+/).filter(x=>x.length).length+s,0);
  const contentWords=mContent.reduce((s,c)=>(c.body||'').trim().split(/\s+/).filter(x=>x.length).length+s,0);
  // project breakdown
  const byProject={};mDone.forEach(t=>{const p=t.project||'No Project';byProject[p]=(byProject[p]||0)+1;});
  const projectRows=Object.entries(byProject).sort((a,b)=>b[1]-a[1]).map(([p,c])=>`<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:10px"><span style="color:var(--text-primary)">${esc(p)}</span><span style="color:var(--accent);font-family:var(--mono)">${c} done</span></div>`).join('');
  // priority breakdown
  const byPriority={p0:0,p1:0,p2:0,p3:0};mDone.forEach(t=>byPriority[t.priority||'p2']++);
  const completionRate=mTasks.length?Math.round(mDone.length/mTasks.length*100):0;
  let md=`# Productivity Report: ${monthName}\n\n## Summary\n- Tasks created: ${mTasks.length}\n- Tasks completed: ${mDone.length} (${completionRate}% completion rate)\n- Content added: ${mContent.length} items (${contentWords.toLocaleString()} words)\n- Documents edited: ${mDocs.length} (${totalWords.toLocaleString()} words)\n- Links saved: ${mLinks.length}\n- Focus sessions: ${mFocus.length} (${formatTimeSpent(focusMins)})\n\n## By Project\n${Object.entries(byProject).map(([p,c])=>'- '+p+': '+c+' completed').join('\n')}\n\n## By Priority\n- P0: ${byPriority.p0} | P1: ${byPriority.p1} | P2: ${byPriority.p2} | P3: ${byPriority.p3}`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Productivity Report: ${monthName}</span><div style="display:flex;gap:6px"><button onclick="navigator.clipboard.writeText(\`${md.replace(/`/g,'\\`')}\`);toast('Copied as Markdown')" class="btn btn-sm btn-ghost" style="font-size:9px">Copy MD</button><button onclick="document.getElementById('report-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px"><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--accent)">${mDone.length}</div><div style="font-size:9px;color:var(--text-muted)">Completed</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--accent-cyan)">${(totalWords+contentWords).toLocaleString()}</div><div style="font-size:9px;color:var(--text-muted)">Words</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--green)">${formatTimeSpent(focusMins)}</div><div style="font-size:9px;color:var(--text-muted)">Focus Time</div></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px"><div><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">By Project</div>${projectRows||'<div style="font-size:9px;color:var(--text-muted)">No completions</div>'}</div><div><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">By Priority</div><div style="font-size:10px;display:flex;flex-direction:column;gap:2px"><span style="color:var(--red)">P0 Critical: ${byPriority.p0}</span><span style="color:var(--orange)">P1 High: ${byPriority.p1}</span><span style="color:var(--accent-cyan)">P2 Medium: ${byPriority.p2}</span><span style="color:var(--text-muted)">P3 Low: ${byPriority.p3}</span></div></div></div><div style="margin-bottom:12px;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:10px;font-weight:600;margin-bottom:4px;color:var(--text-primary)">Completion Rate</div><div style="width:100%;height:8px;background:var(--border);border-radius:4px"><div style="width:${completionRate}%;height:100%;background:${completionRate>=70?'var(--green)':completionRate>=40?'var(--yellow)':'var(--red)'};border-radius:4px;transition:width 0.3s"></div></div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">${completionRate}% (${mDone.length}/${mTasks.length})</div></div><div style="font-size:9px;color:var(--text-muted)">${mContent.length} content items | ${mLinks.length} links | ${mFocus.length} focus sessions</div>`;
  document.body.appendChild(panel);
}
function addStickyNote(){
  const colors=['#fef08a','#bbf7d0','#bfdbfe','#fecaca','#e9d5ff','#fed7aa'];
  const color=colors[Math.floor(Math.random()*colors.length)];
  if(!S._stickies)S._stickies=[];
  const id=Date.now();
  const x=100+Math.random()*200;const y=100+Math.random()*200;
  S._stickies.push({id,text:'',color,x,y});save();
  renderStickyNotes();
}
function renderStickyNotes(){
  document.querySelectorAll('.sticky-note-float').forEach(el=>el.remove());
  (S._stickies||[]).forEach(s=>{
    const el=document.createElement('div');el.className='sticky-note-float';el.dataset.id=s.id;
    el.style.cssText=`position:fixed;left:${s.x}px;top:${s.y}px;width:160px;min-height:100px;background:${s.color};border-radius:4px;padding:8px;z-index:900;box-shadow:0 4px 16px rgba(0,0,0,0.3);cursor:move;display:flex;flex-direction:column;font-family:var(--font)`;
    el.innerHTML=`<div style="display:flex;justify-content:flex-end;gap:4px;margin-bottom:4px"><button onclick="removeStickyNote(${s.id})" style="background:none;border:none;color:#666;cursor:pointer;font-size:12px;padding:0;line-height:1">&times;</button></div><textarea oninput="updateStickyNote(${s.id},this.value)" style="flex:1;background:transparent;border:none;color:#333;font-size:10px;resize:none;outline:none;font-family:inherit;line-height:1.4">${esc(s.text||'')}</textarea>`;
    let isDragging=false,offsetX,offsetY;
    el.addEventListener('mousedown',e=>{if(e.target.tagName==='TEXTAREA'||e.target.tagName==='BUTTON')return;isDragging=true;offsetX=e.clientX-el.offsetLeft;offsetY=e.clientY-el.offsetTop;e.preventDefault();});
    document.addEventListener('mousemove',e=>{if(!isDragging)return;el.style.left=(e.clientX-offsetX)+'px';el.style.top=(e.clientY-offsetY)+'px';});
    document.addEventListener('mouseup',()=>{if(isDragging){isDragging=false;const st=S._stickies.find(x=>x.id===s.id);if(st){st.x=parseInt(el.style.left);st.y=parseInt(el.style.top);save();}}});
    document.body.appendChild(el);
  });
}
function updateStickyNote(id,text){const s=(S._stickies||[]).find(x=>x.id===id);if(s){s.text=text;save();}}
function removeStickyNote(id){S._stickies=(S._stickies||[]).filter(x=>x.id!==id);save();const el=document.querySelector(`.sticky-note-float[data-id="${id}"]`);if(el)el.remove();}
function clearStickyNotes(){if(!S._stickies||!S._stickies.length){toast('No sticky notes');return;}S._stickies=[];save();document.querySelectorAll('.sticky-note-float').forEach(el=>el.remove());toast('Cleared');}
function showGanttChart(){
  let panel=document.getElementById('gantt-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='gantt-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=S.tasks.filter(t=>t.due&&t.status!=='done').sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  if(!tasks.length){panel.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-muted)">No active tasks with due dates</div><button onclick="this.parentElement.remove()" class="btn btn-sm btn-ghost" style="display:block;margin:0 auto">Close</button>';document.body.appendChild(panel);return;}
  const today=new Date();const todayStr=today.toISOString().split('T')[0];
  const minDate=new Date(Math.min(today.getTime(),...tasks.map(t=>new Date(t.due+'T12:00:00').getTime())));
  const maxDate=new Date(Math.max(today.getTime()+14*86400000,...tasks.map(t=>new Date(t.due+'T12:00:00').getTime()+86400000)));
  const totalDays=Math.max(7,Math.ceil((maxDate-minDate)/86400000));
  const w=Math.max(500,totalDays*20);const rowH=24;const h=tasks.length*rowH+40;const pad=120;
  let svg=`<svg width="${w+pad}" height="${h}" viewBox="0 0 ${w+pad} ${h}" style="font-family:var(--mono)">`;
  // grid
  for(let i=0;i<=totalDays;i+=7){const x=pad+i*(w/totalDays);const d=new Date(minDate);d.setDate(d.getDate()+i);svg+=`<line x1="${x}" y1="20" x2="${x}" y2="${h}" stroke="#222" stroke-width="0.5"/><text x="${x}" y="14" fill="#666" font-size="8">${d.toISOString().split('T')[0].substring(5)}</text>`;}
  // today line
  const todayX=pad+((today-minDate)/86400000)*(w/totalDays);svg+=`<line x1="${todayX}" y1="20" x2="${todayX}" y2="${h}" stroke="var(--accent)" stroke-width="1" stroke-dasharray="3,3"/>`;
  // bars
  tasks.forEach((t,i)=>{
    const dueDate=new Date(t.due+'T12:00:00');
    const created=t.created?new Date(t.created):new Date(dueDate.getTime()-7*86400000);
    const startX=pad+Math.max(0,(created-minDate)/86400000)*(w/totalDays);
    const endX=pad+((dueDate-minDate)/86400000)*(w/totalDays);
    const barW=Math.max(8,endX-startX);
    const y=22+i*rowH;
    const pClr=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
    const isOverdue=t.due<todayStr;
    svg+=`<text x="${pad-4}" y="${y+12}" fill="${isOverdue?'#ef4444':'#888'}" font-size="8" text-anchor="end">${esc((t.title||'').substring(0,16))}</text>`;
    svg+=`<rect x="${startX}" y="${y}" width="${barW}" height="${rowH-4}" fill="${pClr}" rx="3" opacity="${isOverdue?'0.6':'0.8'}"><title>${esc(t.title)}: ${t.due} (${t.priority||'p2'})</title></rect>`;
    svg+=`<text x="${startX+4}" y="${y+12}" fill="#fff" font-size="7" opacity="0.9">${t.due.substring(5)}</text>`;
  });
  svg+=`</svg>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Gantt Chart (${tasks.length} tasks)</span><button onclick="document.getElementById('gantt-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="overflow-x:auto">${svg}</div>`;
  document.body.appendChild(panel);
}
function findRelatedContent(keyword){
  const kw=keyword.toLowerCase();
  return S.content.map(c=>{const body=(c.body||'').toLowerCase();const tags=(c.tags||[]).join(' ').toLowerCase();const theme=(c.theme||'').toLowerCase();let score=0;if(body.includes(kw))score+=3;if(tags.includes(kw))score+=5;if(theme.includes(kw))score+=4;const words=kw.split(/\s+/);words.forEach(w=>{if(w.length>3&&body.includes(w))score++;});return{...c,score};}).filter(c=>c.score>0).sort((a,b)=>b.score-a.score).slice(0,10);
}
function showReadingList(){
  let panel=document.getElementById('reading-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='reading-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  const readLater=S.links.filter(l=>l.readLater);
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Reading List (${readLater.length})</span><button onclick="document.getElementById('reading-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`+(readLater.length?readLater.map(l=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;border-bottom:1px solid var(--border)"><div style="flex:1"><a href="${escA(l.url)}" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none" onclick="event.stopPropagation()">${esc(l.title||l.url)}</a><div style="font-size:9px;color:var(--text-muted)">${esc(l.category||'')}${l.created?' | '+timeAgo(l.created):''}</div></div><button onclick="markLinkRead(${l.id});document.getElementById('reading-panel').remove();showReadingList()" class="btn btn-sm btn-ghost" style="font-size:8px">Done</button></div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--text-muted)">No links in reading list. Pin links or mark as read-later.</div>');
  document.body.appendChild(panel);
}
function markLinkRead(id){const l=S.links.find(x=>x.id===id);if(l){l.readLater=false;save();toast('Marked as read');}}
function showHabitTracker(){
  if(!S._habits)S._habits=[];
  let panel=document.getElementById('habit-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='habit-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:75vh;overflow-y:auto';
  const today=new Date();const days=[];
  for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);days.push(d.toISOString().split('T')[0]);}
  const dayLabels=days.map(d=>{const dt=new Date(d+'T12:00:00');return dt.toLocaleDateString('en-US',{weekday:'short'}).substring(0,2);});
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Habit Tracker</span><div style="display:flex;gap:6px"><button onclick="addHabit()" class="btn btn-sm btn-ghost" style="font-size:9px">+ Habit</button><button onclick="document.getElementById('habit-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  // Header row
  h+=`<div style="display:grid;grid-template-columns:1fr repeat(7,32px) 40px;gap:2px;align-items:center;margin-bottom:4px"><div style="font-size:9px;color:var(--text-muted)">Habit</div>${dayLabels.map(d=>`<div style="font-size:8px;color:var(--text-muted);text-align:center">${d}</div>`).join('')}<div style="font-size:8px;color:var(--text-muted);text-align:center">Streak</div></div>`;
  S._habits.forEach((habit,hi)=>{
    if(!habit.checks)habit.checks={};
    let streak=0;const checkDate=new Date(today);
    for(let i=0;i<365;i++){const ds=checkDate.toISOString().split('T')[0];if(habit.checks[ds])streak++;else if(i>0)break;checkDate.setDate(checkDate.getDate()-1);}
    h+=`<div style="display:grid;grid-template-columns:1fr repeat(7,32px) 40px;gap:2px;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)"><div style="font-size:10px;color:var(--text-primary);display:flex;align-items:center;gap:4px"><span>${esc(habit.name)}</span><span onclick="removeHabit(${hi})" style="cursor:pointer;font-size:8px;color:var(--red);opacity:0.4" title="Remove">x</span></div>${days.map(d=>{const checked=habit.checks[d];return`<div onclick="toggleHabitDay(${hi},'${d}')" style="width:28px;height:28px;border-radius:4px;background:${checked?'var(--accent)':'var(--bg-surface)'};border:1px solid ${checked?'var(--accent)':'var(--border)'};cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s">${checked?'<span style="color:#fff;font-size:10px;font-weight:700">v</span>':''}</div>`;}).join('')}<div style="text-align:center;font-size:11px;font-weight:600;color:${streak>=7?'var(--accent)':streak>=3?'var(--accent-cyan)':'var(--text-muted)'}">${streak}d</div></div>`;
  });
  if(!S._habits.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No habits yet. Click "+ Habit" to add one.</div>';
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function addHabit(){if(!S._habits)S._habits=[];const name=prompt('Habit name:');if(!name||!name.trim())return;S._habits.push({name:name.trim(),checks:{}});save();showHabitTracker();}
function removeHabit(idx){if(!confirm('Remove this habit?'))return;S._habits.splice(idx,1);save();showHabitTracker();}
function toggleHabitDay(idx,day){if(!S._habits||!S._habits[idx])return;if(!S._habits[idx].checks)S._habits[idx].checks={};if(S._habits[idx].checks[day])delete S._habits[idx].checks[day];else S._habits[idx].checks[day]=true;save();showHabitTracker();}
function showTaskTable(){
  let panel=document.getElementById('task-table-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-table-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:80vh;overflow:auto';
  const tasks=S.tasks.filter(t=>t.status!=='done').sort((a,b)=>{const pMap={p0:0,p1:1,p2:2,p3:3};return(pMap[a.priority]||2)-(pMap[b.priority]||2);});
  const pClr={p0:'var(--red)',p1:'var(--orange)',p2:'var(--accent-cyan)',p3:'var(--text-muted)'};
  const sClr={todo:'#3b82f6',progress:'#f59e0b',blocked:'#ef4444'};
  const today=new Date().toISOString().split('T')[0];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Table (${tasks.length} active)</span><button onclick="document.getElementById('task-table-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<table style="width:100%;border-collapse:collapse;font-size:10px"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:4px 6px;color:var(--text-muted);font-weight:600">Title</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:50px">Pri</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:60px">Status</th><th style="text-align:left;padding:4px;color:var(--text-muted);font-weight:600;width:80px">Project</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:70px">Due</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:50px">Est</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:50px">Time</th></tr></thead><tbody>`;
  tasks.forEach(t=>{
    const isOverdue=t.due&&t.due<today;
    h+=`<tr onclick="document.getElementById('task-table-panel').remove();openTaskDetail(${t.id})" style="border-bottom:1px solid var(--border);cursor:pointer" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><td style="padding:4px 6px;color:var(--text-primary);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'Untitled')}</td><td style="padding:4px;text-align:center;color:${pClr[t.priority]||pClr.p2};font-weight:600">${(t.priority||'p2').toUpperCase()}</td><td style="padding:4px;text-align:center;color:${sClr[t.status]||'#888'}">${t.status}</td><td style="padding:4px;font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.project||'')}</td><td style="padding:4px;text-align:center;font-family:var(--mono);font-size:9px;color:${isOverdue?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'}">${t.due?t.due.substring(5):''}</td><td style="padding:4px;text-align:center;font-size:9px;color:var(--accent-cyan)">${t.estimate||''}</td><td style="padding:4px;text-align:center;font-size:9px;color:var(--text-muted)">${t.timeSpent?formatTimeSpent(t.timeSpent):''}</td></tr>`;
  });
  h+=`</tbody></table>`;
  if(!tasks.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted)">No active tasks</div>';
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function showProjectHealth(){
  let panel=document.getElementById('proj-health-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-health-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:75vh;overflow-y:auto';
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  const today=new Date().toISOString().split('T')[0];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Project Health Dashboard</span><button onclick="document.getElementById('proj-health-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  projects.forEach(p=>{
    const tasks=S.tasks.filter(t=>t.project===p);
    const active=tasks.filter(t=>t.status!=='done');
    const done=tasks.filter(t=>t.status==='done');
    const overdue=active.filter(t=>t.due&&t.due<today);
    const blocked=active.filter(t=>t.status==='blocked');
    const pct=tasks.length?Math.round(done.length/tasks.length*100):0;
    const velocity7d=done.filter(t=>t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())<7*86400000).length;
    const healthScore=Math.min(100,Math.max(0,pct-overdue.length*10-blocked.length*5+velocity7d*5));
    const healthColor=healthScore>=70?'var(--green)':healthScore>=40?'var(--yellow)':'var(--red)';
    const healthLabel=healthScore>=70?'Healthy':healthScore>=40?'At Risk':'Critical';
    h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:8px;border-left:4px solid ${healthColor}"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:12px;font-weight:600;color:var(--text-primary)">${esc(p)}</span><span style="font-size:9px;padding:2px 6px;border-radius:10px;background:${healthColor}20;color:${healthColor}">${healthLabel} (${healthScore})</span></div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:6px"><div style="text-align:center"><div style="font-size:14px;font-weight:600;color:var(--accent)">${done.length}</div><div style="font-size:8px;color:var(--text-muted)">Done</div></div><div style="text-align:center"><div style="font-size:14px;font-weight:600;color:var(--accent-cyan)">${active.length}</div><div style="font-size:8px;color:var(--text-muted)">Active</div></div><div style="text-align:center"><div style="font-size:14px;font-weight:600;color:var(--red)">${overdue.length}</div><div style="font-size:8px;color:var(--text-muted)">Overdue</div></div><div style="text-align:center"><div style="font-size:14px;font-weight:600;color:var(--yellow)">${velocity7d}</div><div style="font-size:8px;color:var(--text-muted)">7d Vel.</div></div></div><div style="width:100%;height:6px;background:var(--border);border-radius:3px"><div style="width:${pct}%;height:100%;background:${healthColor};border-radius:3px"></div></div><div style="font-size:8px;color:var(--text-muted);margin-top:2px">${pct}% complete (${done.length}/${tasks.length})</div></div>`;
  });
  if(!projects.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted)">No projects with tasks</div>';
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function showRandomContent(){
  if(!S.content.length){toast('No content to show');return;}
  const c=S.content[Math.floor(Math.random()*S.content.length)];
  openContentModal(c.id);toast('Random item: '+(c.body||'').substring(0,40));
}
function showRandomTask(){
  const active=S.tasks.filter(t=>t.status!=='done');
  if(!active.length){toast('No active tasks');return;}
  const t=active[Math.floor(Math.random()*active.length)];
  openTaskDetail(t.id);toast('Random: '+t.title);
}
function saveToClips(){
  navigator.clipboard.readText().then(text=>{
    if(!text||!text.trim()){toast('Clipboard is empty');return;}
    if(!S._clips)S._clips=[];
    S._clips.unshift({text:text.trim(),saved:new Date().toISOString()});
    if(S._clips.length>50)S._clips.length=50;
    save();toast('Saved to clips');
  }).catch(()=>toast('Could not read clipboard (permission needed)'));
}
function showClipHistory(){
  if(!S._clips||!S._clips.length){toast('No clips saved. Use "clips" to save clipboard.');return;}
  let panel=document.getElementById('clips-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='clips-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Clipboard History (${S._clips.length})</span><div style="display:flex;gap:6px"><button onclick="S._clips=[];save();document.getElementById('clips-panel').remove();toast('Cleared')" class="btn btn-sm btn-ghost" style="font-size:8px">Clear All</button><button onclick="document.getElementById('clips-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`+
    S._clips.map((c,i)=>`<div style="padding:6px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:flex-start"><div style="flex:1;font-size:10px;color:var(--text-primary);word-break:break-word;white-space:pre-wrap;max-height:60px;overflow:hidden">${esc(c.text.substring(0,200))}</div><div style="display:flex;flex-direction:column;gap:2px;flex-shrink:0"><button onclick="navigator.clipboard.writeText(S._clips[${i}].text);toast('Copied')" class="btn btn-sm btn-ghost" style="font-size:8px;padding:1px 4px">Copy</button><span style="font-size:7px;color:var(--text-muted)">${timeAgo(c.saved)}</span></div></div>`).join('');
  document.body.appendChild(panel);
}
function createProjectFromTemplate(tmpl){
  const name=prompt('Project name:',tmpl.name);if(!name||!name.trim())return;
  const pName=name.trim();
  const now=new Date();
  tmpl.tasks.forEach((title,i)=>{
    const due=new Date(now);due.setDate(due.getDate()+i*2+1);
    S.tasks.unshift({id:Date.now()+i,title,description:'',subtasks:[],status:'todo',priority:i<2?'p1':'p2',project:pName,due:due.toISOString().split('T')[0],created:now.toISOString()});
  });
  save();renderTasks();toast('Created '+tmpl.tasks.length+' tasks for "'+pName+'"');
}
function startContentCompare(){
  const id1=prompt('Enter first content ID (from URL or card):');
  if(!id1)return;
  const id2=prompt('Enter second content ID to compare:');
  if(!id2)return;
  const c1=S.content.find(c=>c.id===parseInt(id1));
  const c2=S.content.find(c=>c.id===parseInt(id2));
  if(!c1||!c2){toast('Content not found. Use valid IDs.');return;}
  let panel=document.getElementById('compare-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:80vh;overflow-y:auto';
  const wc1=(c1.body||'').trim().split(/\s+/).filter(x=>x.length).length;
  const wc2=(c2.body||'').trim().split(/\s+/).filter(x=>x.length).length;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Content Compare</span><button onclick="document.getElementById('compare-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div style="background:var(--bg-surface);border-radius:var(--radius);padding:12px;overflow-y:auto;max-height:50vh"><div style="font-size:9px;color:var(--accent);margin-bottom:4px">Item A (${wc1} words) | ${c1.type||''} | ${timeAgo(c1.created||'')}</div><div style="font-size:10px;color:var(--text-primary);white-space:pre-wrap;line-height:1.5">${esc(c1.body||'')}</div></div><div style="background:var(--bg-surface);border-radius:var(--radius);padding:12px;overflow-y:auto;max-height:50vh"><div style="font-size:9px;color:var(--accent-cyan);margin-bottom:4px">Item B (${wc2} words) | ${c2.type||''} | ${timeAgo(c2.created||'')}</div><div style="font-size:10px;color:var(--text-primary);white-space:pre-wrap;line-height:1.5">${esc(c2.body||'')}</div></div></div><div style="margin-top:8px;font-size:9px;color:var(--text-muted)">Word count diff: ${Math.abs(wc1-wc2)} words | ${wc1>wc2?'A is longer':'B is longer'}</div>`;
  document.body.appendChild(panel);
}
function addTimeBlock(){
  const title=prompt('Time block label (e.g. "Deep work", "Meeting"):');if(!title||!title.trim())return;
  const date=prompt('Date (YYYY-MM-DD):',new Date().toISOString().split('T')[0]);if(!date)return;
  const start=prompt('Start time (e.g. "09:00"):','09:00');if(!start)return;
  const end=prompt('End time (e.g. "11:00"):','11:00');if(!end)return;
  if(!S._timeBlocks)S._timeBlocks=[];
  S._timeBlocks.push({id:Date.now(),title:title.trim(),date,start,end,color:'var(--accent)'});
  save();toast('Time block added: '+title.trim()+' on '+date);
}
function showTimeBlocks(){
  if(!S._timeBlocks||!S._timeBlocks.length){toast('No time blocks. Use "time block" to add one.');return;}
  let panel=document.getElementById('timeblock-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='timeblock-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:70vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const blocks=(S._timeBlocks||[]).sort((a,b)=>(a.date+a.start).localeCompare(b.date+b.start));
  const upcoming=blocks.filter(b=>b.date>=today);
  const past=blocks.filter(b=>b.date<today);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Time Blocks (${blocks.length})</span><div style="display:flex;gap:6px"><button onclick="addTimeBlock();document.getElementById('timeblock-panel').remove()" class="btn btn-sm btn-ghost" style="font-size:9px">+ Add</button><button onclick="document.getElementById('timeblock-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  if(upcoming.length){h+='<div style="font-size:9px;font-weight:600;color:var(--accent);margin-bottom:4px;text-transform:uppercase">Upcoming</div>';}
  upcoming.forEach(b=>{
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;border-left:3px solid var(--accent);margin-bottom:4px;border-radius:0 4px 4px 0"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(b.title)}</div><div style="font-size:9px;color:var(--text-muted)">${b.date} | ${b.start} - ${b.end}</div></div><button onclick="S._timeBlocks=S._timeBlocks.filter(x=>x.id!==${b.id});save();document.getElementById('timeblock-panel').remove();showTimeBlocks()" class="btn btn-sm btn-ghost" style="font-size:8px;color:var(--red)">x</button></div>`;
  });
  if(past.length){h+=`<div style="font-size:9px;font-weight:600;color:var(--text-muted);margin-top:8px;margin-bottom:4px;text-transform:uppercase">Past (${past.length})</div>`;
  past.slice(0,5).forEach(b=>{h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 8px;border-left:3px solid var(--border);margin-bottom:2px;opacity:0.5"><div style="flex:1;font-size:10px;color:var(--text-muted)">${esc(b.title)} - ${b.date} ${b.start}-${b.end}</div></div>`;});}
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function textTransform(type){
  navigator.clipboard.readText().then(text=>{
    if(!text){toast('Clipboard empty');return;}
    let result;
    if(type==='upper')result=text.toUpperCase();
    else if(type==='lower')result=text.toLowerCase();
    else if(type==='title')result=text.replace(/\w\S*/g,t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase());
    else if(type==='slug')result=text.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
    else result=text;
    navigator.clipboard.writeText(result);
    toast('Transformed and copied to clipboard: '+result.substring(0,40)+(result.length>40?'...':''));
  }).catch(()=>toast('Could not read clipboard'));
}
function archiveUrl(){
  const url=prompt('Enter URL to view on Wayback Machine:');
  if(!url||!url.trim())return;
  window.open('https://web.archive.org/web/'+url.trim(),'_blank');
  toast('Opened Wayback Machine');
}
function showHomeDashboard(){
  let panel=document.getElementById('dashboard-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='dashboard-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  const inProgress=S.tasks.filter(t=>t.status==='progress');
  const doneToday=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(today));
  const recentContent=S.content.filter(c=>c.created&&c.created.startsWith(today));
  const recentDocs=S.docs.filter(d=>(d.updated||d.created||'').startsWith(today));
  const focusToday=(S.focusSessions||[]).filter(f=>f.date===today);
  const focusMins=focusToday.reduce((a,f)=>a+(f.minutes||0),0);
  const streak=(()=>{let s=0;const cd=new Date();for(let i=0;i<365;i++){const ds=cd.toISOString().split('T')[0];if(S.tasks.some(t=>(t.completedAt&&t.completedAt.startsWith(ds))||(t.created&&t.created.startsWith(ds)))||S.content.some(c=>c.created&&c.created.startsWith(ds)))s++;else if(i>0)break;cd.setDate(cd.getDate()-1);}return s;})();
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:15px;font-weight:700;color:var(--text-primary)">Good ${new Date().getHours()<12?'morning':new Date().getHours()<18?'afternoon':'evening'}.</span><button onclick="document.getElementById('dashboard-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  // Stats row
  h+=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px"><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:${overdue.length?'var(--red)':'var(--accent)'}">${todayTasks.length}</div><div style="font-size:8px;color:var(--text-muted)">Due Today</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--green)">${doneToday.length}</div><div style="font-size:8px;color:var(--text-muted)">Done Today</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--accent-cyan)">${focusMins?formatTimeSpent(focusMins):'0m'}</div><div style="font-size:8px;color:var(--text-muted)">Focus</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--yellow)">${streak}</div><div style="font-size:8px;color:var(--text-muted)">Day Streak</div></div></div>`;
  // Overdue
  if(overdue.length){h+=`<div style="font-size:10px;font-weight:600;color:var(--red);margin-bottom:4px;text-transform:uppercase">Overdue (${overdue.length})</div>`;overdue.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('dashboard-panel').remove();openTaskDetail(${t.id})" style="font-size:10px;padding:3px 8px;cursor:pointer;border-left:2px solid var(--red);margin-bottom:2px;color:var(--text-primary)">${esc(t.title)} <span style="color:var(--text-muted);font-size:8px">${relativeDate(t.due)}</span></div>`;});}
  // Today
  if(todayTasks.length){h+=`<div style="font-size:10px;font-weight:600;color:var(--accent);margin-top:8px;margin-bottom:4px;text-transform:uppercase">Today (${todayTasks.length})</div>`;todayTasks.forEach(t=>{h+=`<div onclick="document.getElementById('dashboard-panel').remove();openTaskDetail(${t.id})" style="font-size:10px;padding:3px 8px;cursor:pointer;border-left:2px solid var(--accent);margin-bottom:2px;color:var(--text-primary)">${esc(t.title)} <span style="color:var(--text-muted);font-size:8px">${t.priority||'p2'}</span></div>`;});}
  // In progress
  if(inProgress.length){h+=`<div style="font-size:10px;font-weight:600;color:var(--yellow);margin-top:8px;margin-bottom:4px;text-transform:uppercase">In Progress (${inProgress.length})</div>`;inProgress.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('dashboard-panel').remove();openTaskDetail(${t.id})" style="font-size:10px;padding:3px 8px;cursor:pointer;border-left:2px solid var(--yellow);margin-bottom:2px;color:var(--text-primary)">${esc(t.title)}</div>`;});}
  // Quick actions
  h+=`<div style="display:flex;gap:6px;margin-top:16px;flex-wrap:wrap"><button onclick="document.getElementById('dashboard-panel').remove();openDailyJournal()" class="btn btn-sm btn-ghost" style="font-size:9px">Journal</button><button onclick="document.getElementById('dashboard-panel').remove();showHabitTracker()" class="btn btn-sm btn-ghost" style="font-size:9px">Habits</button><button onclick="document.getElementById('dashboard-panel').remove();showActivityTimeline()" class="btn btn-sm btn-ghost" style="font-size:9px">Timeline</button><button onclick="document.getElementById('dashboard-panel').remove();showBurndownChart()" class="btn btn-sm btn-ghost" style="font-size:9px">Burndown</button></div>`;
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function showSettings(){
  let panel=document.getElementById('settings-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='settings-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:75vh;overflow-y:auto';
  if(!S._settings)S._settings={};
  const s=S._settings;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Settings</span><button onclick="document.getElementById('settings-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>
  <div style="display:flex;flex-direction:column;gap:12px">
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Compact Content View</span><button onclick="contentCompact=!contentCompact;this.textContent=contentCompact?'ON':'OFF';this.style.color=contentCompact?'var(--accent)':'var(--text-muted)';renderContent()" class="btn btn-sm btn-ghost" style="font-size:9px;color:${typeof contentCompact!=='undefined'&&contentCompact?'var(--accent)':'var(--text-muted)'}">${typeof contentCompact!=='undefined'&&contentCompact?'ON':'OFF'}</button></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Auto-Backup</span><button onclick="toggleAutoBackup();this.textContent=S._autoBackup?'ON':'OFF';this.style.color=S._autoBackup?'var(--accent)':'var(--text-muted)'" class="btn btn-sm btn-ghost" style="font-size:9px;color:${S._autoBackup?'var(--accent)':'var(--text-muted)'}">${S._autoBackup?'ON':'OFF'}</button></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Desktop Notifications</span><button onclick="enableDesktopNotifications()" class="btn btn-sm btn-ghost" style="font-size:9px;color:${S._notificationsEnabled?'var(--accent)':'var(--text-muted)'}">${S._notificationsEnabled?'ON':'OFF'}</button></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Accent Color</span><div style="display:flex;gap:3px">${['#4ade80','#06b6d4','#8b5cf6','#3b82f6','#f59e0b','#ec4899','#ef4444','#eab308'].map(c=>`<div onclick="document.documentElement.style.setProperty('--accent','${c}');S._accentColor='${c}';save()" style="width:16px;height:16px;border-radius:50%;background:${c};cursor:pointer;border:2px solid ${S._accentColor===c?'white':'transparent'}"></div>`).join('')}</div></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Default Task View</span><select onchange="S._settings.defaultTaskView=this.value;save()" style="font-size:9px;padding:2px 6px;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-primary);border-radius:4px"><option value="list" ${(s.defaultTaskView||'list')==='list'?'selected':''}>List</option><option value="board" ${s.defaultTaskView==='board'?'selected':''}>Board</option><option value="eisenhower" ${s.defaultTaskView==='eisenhower'?'selected':''}>Eisenhower</option></select></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Default Calendar View</span><select onchange="S._settings.defaultCalView=this.value;save()" style="font-size:9px;padding:2px 6px;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-primary);border-radius:4px"><option value="month" ${(s.defaultCalView||'month')==='month'?'selected':''}>Month</option><option value="week" ${s.defaultCalView==='week'?'selected':''}>Week</option><option value="agenda" ${s.defaultCalView==='agenda'?'selected':''}>Agenda</option></select></div>
  <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px"><div style="font-size:9px;color:var(--text-muted)">Storage: ${(JSON.stringify(S).length/1024).toFixed(0)}KB / 5MB</div><div style="font-size:9px;color:var(--text-muted)">${S.tasks.length} tasks | ${S.content.length} content | ${S.docs.length} docs | ${S.links.length} links</div></div>
  </div>`;
  document.body.appendChild(panel);
}
function showImpactMatrix(){
  let panel=document.getElementById('impact-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='impact-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  // Classify: high impact = p0/p1, low impact = p2/p3
  // high effort = has estimate >1h or no estimate but has many subtasks, low effort = short estimate or few subtasks
  const classify=t=>{
    const highImpact=t.priority==='p0'||t.priority==='p1';
    const est=t.estimate||'';const stCount=(t.subtasks||[]).length;
    const highEffort=est.includes('h')&&parseInt(est)>=2||stCount>=4||(!est&&!stCount);
    return{impact:highImpact?'high':'low',effort:highEffort?'high':'low'};
  };
  const quads={hh:[],hl:[],lh:[],ll:[]};
  active.forEach(t=>{const c=classify(t);const key=(c.impact==='high'?'h':'l')+(c.effort==='high'?'h':'l');quads[key].push(t);});
  const quadInfo=[
    {key:'hl',name:'Quick Wins',desc:'High Impact, Low Effort',color:'var(--green)',emoji:''},
    {key:'hh',name:'Big Bets',desc:'High Impact, High Effort',color:'var(--accent-cyan)',emoji:''},
    {key:'ll',name:'Fill-Ins',desc:'Low Impact, Low Effort',color:'var(--text-muted)',emoji:''},
    {key:'lh',name:'Time Sinks',desc:'Low Impact, High Effort',color:'var(--orange)',emoji:''},
  ];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Impact-Effort Matrix</span><button onclick="document.getElementById('impact-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">`;
  quadInfo.forEach(qi=>{
    h+=`<div style="background:var(--bg-surface);border-radius:var(--radius);padding:10px;border-top:3px solid ${qi.color}"><div style="font-size:10px;font-weight:600;color:${qi.color};margin-bottom:2px">${qi.name} (${quads[qi.key].length})</div><div style="font-size:8px;color:var(--text-muted);margin-bottom:6px">${qi.desc}</div>`;
    quads[qi.key].slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('impact-panel').remove();openTaskDetail(${t.id})" style="font-size:9px;padding:3px 6px;cursor:pointer;border-left:2px solid ${qi.color};margin-bottom:2px;color:var(--text-primary)">${esc(t.title||'').substring(0,40)}</div>`;});
    if(quads[qi.key].length>5)h+=`<div style="font-size:8px;color:var(--text-muted);padding:2px 6px">+${quads[qi.key].length-5} more</div>`;
    h+=`</div>`;
  });
  h+=`</div><div style="margin-top:10px;font-size:8px;color:var(--text-muted)">Classification: Priority P0/P1 = High Impact. Estimate >= 2h or 4+ subtasks = High Effort.</div>`;
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function exportAllContent(){
  if(!S.content.length){toast('No content');return;}
  let md='# Content Export\\n# '+new Date().toISOString().split('T')[0]+'\\n# '+S.content.length+' items\\n\\n';
  const byTheme={};S.content.forEach(c=>{const t=c.theme||'Unthemed';if(!byTheme[t])byTheme[t]=[];byTheme[t].push(c);});
  Object.keys(byTheme).sort().forEach(theme=>{
    md+='---\\n\\n## '+theme+' ('+byTheme[theme].length+')\\n\\n';
    byTheme[theme].forEach(c=>{md+='### '+(c.type||'note')+' | '+(c.created?new Date(c.created).toLocaleDateString():'')+'\\n\\n'+c.body+'\\n\\n';});
  });
  const blob=new Blob([md],{type:'text/markdown'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='content-export-'+new Date().toISOString().split('T')[0]+'.md';
  a.click();toast('Exported '+S.content.length+' items');
}
function exportContentJSON(){
  const data=JSON.stringify(S.content,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='content-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();toast('Exported '+S.content.length+' items as JSON');
}
function showFocusStats(){
  let panel=document.getElementById('focus-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='focus-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const sessions=(S.focusSessions||[]).slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  const totalMin=sessions.reduce((s,x)=>s+(x.duration||0),0);
  const totalSessions=sessions.length;
  const today=new Date().toISOString().split('T')[0];
  const todaySessions=sessions.filter(s=>s.date===today);
  const todayMin=todaySessions.reduce((s,x)=>s+(x.duration||0),0);
  const thisWeek=new Date();thisWeek.setDate(thisWeek.getDate()-7);const weekStr=thisWeek.toISOString().split('T')[0];
  const weekSessions=sessions.filter(s=>s.date>=weekStr);
  const weekMin=weekSessions.reduce((s,x)=>s+(x.duration||0),0);
  const avgPerSession=totalSessions?Math.round(totalMin/totalSessions):0;
  let streak=0;const d=new Date();
  for(let i=0;i<365;i++){const ds=d.toISOString().split('T')[0];if(sessions.some(s=>s.date===ds)){streak++;}else if(i>0){break;}d.setDate(d.getDate()-1);}
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:20px;font-weight:700;color:var(--accent)">${Math.round(totalMin/60)}h ${totalMin%60}m</div><div style="font-size:9px;color:var(--text-muted)">Total Focus Time</div></div>`;
  h+=`<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:20px;font-weight:700;color:var(--accent)">${totalSessions}</div><div style="font-size:9px;color:var(--text-muted)">Total Sessions</div></div>`;
  h+=`<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:20px;font-weight:700;color:var(--accent)">${avgPerSession}m</div><div style="font-size:9px;color:var(--text-muted)">Avg per Session</div></div>`;
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:600;color:#f59e0b">${todayMin}m</div><div style="font-size:8px;color:var(--text-muted)">Today</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:600;color:#3b82f6">${weekMin}m</div><div style="font-size:8px;color:var(--text-muted)">This Week</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:600;color:#8b5cf6">${streak}d</div><div style="font-size:8px;color:var(--text-muted)">Streak</div></div>`;
  h+='</div>';
  const days=[];for(let i=6;i>=0;i--){const dd=new Date();dd.setDate(dd.getDate()-i);days.push(dd.toISOString().split('T')[0]);}
  const dayMins=days.map(d=>sessions.filter(s=>s.date===d).reduce((s,x)=>s+(x.duration||0),0));
  const maxMin=Math.max(...dayMins,1);
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Last 7 Days</div>';
  h+='<div style="display:flex;align-items:flex-end;gap:4px;height:80px;margin-bottom:16px">';
  days.forEach((d,i)=>{const pct=dayMins[i]/maxMin*100;h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px"><div style="width:100%;height:${Math.max(pct,3)}%;background:var(--accent);border-radius:3px 3px 0 0;min-height:2px"></div><span style="font-size:7px;color:var(--text-muted)">${d.substring(8)}</span></div>`;});
  h+='</div>';
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Recent Sessions</div>';
  sessions.slice(0,15).forEach(s=>{
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 6px;font-size:10px;border-left:2px solid var(--accent);margin:2px 0"><span style="color:var(--text-muted);font-family:var(--mono);min-width:65px">${s.date||'?'}</span><span style="color:var(--accent);min-width:30px">${s.duration||0}m</span><span style="color:var(--text-primary);flex:1">${esc(s.taskName||s.task||'Untitled')}</span></div>`;
  });
  if(!sessions.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No focus sessions yet. Start one from task detail!</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Focus Session Stats</span><button onclick="document.getElementById('focus-stats-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showEisenhowerMatrix(){
  let panel=document.getElementById('eisenhower-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='eisenhower-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  const today=new Date().toISOString().split('T')[0];
  const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+3);const soonStr=tomorrow.toISOString().split('T')[0];
  function isUrgent(t){return t.due&&t.due<=soonStr;}
  function isImportant(t){return t.priority==='p0'||t.priority==='p1';}
  const q1=active.filter(t=>isUrgent(t)&&isImportant(t));
  const q2=active.filter(t=>!isUrgent(t)&&isImportant(t));
  const q3=active.filter(t=>isUrgent(t)&&!isImportant(t));
  const q4=active.filter(t=>!isUrgent(t)&&!isImportant(t));
  function renderQ(tasks,label,color,advice){
    let h=`<div style="padding:4px 8px;font-size:10px;font-weight:600;color:${color};margin-bottom:4px">${label} (${tasks.length})</div>`;
    h+=`<div style="font-size:8px;color:var(--text-muted);padding:0 8px 6px;font-style:italic">${advice}</div>`;
    tasks.slice(0,8).forEach(t=>{
      const overdue=t.due&&t.due<today;
      h+=`<div onclick="document.getElementById('eisenhower-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;display:flex;align-items:center;gap:6px;border-left:2px solid ${color}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="flex:1">${esc(t.title||'Untitled')}</span>${t.due?`<span style="font-size:8px;font-family:var(--mono);color:${overdue?'var(--red)':'var(--text-muted)'}">${t.due.substring(5)}</span>`:''}<span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'}">${t.priority||'p2'}</span></div>`;
    });
    if(tasks.length>8)h+=`<div style="padding:3px 8px;font-size:8px;color:var(--text-muted)">+${tasks.length-8} more</div>`;
    if(!tasks.length)h+=`<div style="padding:8px;font-size:9px;color:var(--text-muted);text-align:center">None</div>`;
    return h;
  }
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Eisenhower Matrix</span><button onclick="document.getElementById('eisenhower-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="font-size:9px;color:var(--text-muted);margin-bottom:8px">Urgent = due within 3 days | Important = P0 or P1</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div style="background:var(--bg-surface);border-radius:8px;padding:8px;border:1px solid rgba(239,68,68,0.3)">${renderQ(q1,'DO FIRST','#ef4444','Urgent + Important: Do immediately')}</div><div style="background:var(--bg-surface);border-radius:8px;padding:8px;border:1px solid rgba(59,130,246,0.3)">${renderQ(q2,'SCHEDULE','#3b82f6','Important but not urgent: Plan ahead')}</div><div style="background:var(--bg-surface);border-radius:8px;padding:8px;border:1px solid rgba(245,158,11,0.3)">${renderQ(q3,'DELEGATE','#f59e0b','Urgent but not important: Batch or delegate')}</div><div style="background:var(--bg-surface);border-radius:8px;padding:8px;border:1px solid rgba(107,114,128,0.3)">${renderQ(q4,'ELIMINATE','#6b7280','Not urgent or important: Drop or defer')}</div></div>`;
  document.body.appendChild(panel);
}
function showContentCalendar(){
  let panel=document.getElementById('content-cal-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-cal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const byDate={};
  S.content.forEach(c=>{
    if(!c.createdAt)return;
    const d=c.createdAt.split('T')[0];
    if(!byDate[d])byDate[d]=[];
    byDate[d].push(c);
  });
  (S.docs||[]).forEach(d=>{
    const dt=(d.updatedAt||d.createdAt||'').split('T')[0];
    if(dt&&!byDate[dt])byDate[dt]=[];
    if(dt)byDate[dt].push({body:d.title||'Doc',type:'doc',theme:'writer'});
  });
  const todayStr=now.toISOString().split('T')[0];
  let h='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;margin-bottom:4px">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div style="text-align:center;font-size:9px;color:var(--text-muted);padding:4px 0;font-weight:600">${d}</div>`;});
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px">';
  for(let i=0;i<firstDay;i++){h+='<div style="padding:4px;min-height:60px;background:var(--bg-surface);border-radius:4px;opacity:0.3"></div>';}
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const items=byDate[ds]||[];
    const isToday=ds===todayStr;
    h+=`<div style="padding:3px;min-height:60px;background:var(--bg-surface);border-radius:4px;${isToday?'border:1px solid var(--accent);':''}"><div style="font-size:9px;font-weight:600;color:${isToday?'var(--accent)':'var(--text-muted)'};">${d}</div>`;
    items.slice(0,3).forEach(c=>{
      const typeColor=c.theme==='writer'?'var(--accent)':c.type==='idea'?'#f59e0b':c.type==='quote'?'#8b5cf6':c.type==='code'?'#06b6d4':'#3b82f6';
      h+=`<div style="font-size:7px;color:${typeColor};padding:1px 3px;background:${typeColor}15;border-radius:2px;margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc((c.body||'').substring(0,20))}</div>`;
    });
    if(items.length>3)h+=`<div style="font-size:7px;color:var(--text-muted);padding:1px 3px">+${items.length-3}</div>`;
    h+='</div>';
  }
  h+='</div>';
  const totalThisMonth=Object.keys(byDate).filter(d=>d.startsWith(`${year}-${String(month+1).padStart(2,'0')}`)).reduce((s,d)=>s+byDate[d].length,0);
  const activeDays=Object.keys(byDate).filter(d=>d.startsWith(`${year}-${String(month+1).padStart(2,'0')}`)).length;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Content Calendar - ${monthName}</span><button onclick="document.getElementById('content-cal-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;gap:12px;margin-bottom:12px;font-size:10px"><span style="color:var(--text-muted)">${totalThisMonth} items this month</span><span style="color:var(--text-muted)">${activeDays} active days</span></div>${h}`;
  document.body.appendChild(panel);
}
function showSnippetManager(){
  if(!S._snippets)S._snippets=[];
  let panel=document.getElementById('snippet-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='snippet-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="margin-bottom:12px"><input id="snip-name" placeholder="Snippet name..." style="width:48%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;margin-right:2%"><button onclick="addSnippet()" style="padding:6px 12px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:11px;font-weight:600;cursor:pointer">Add</button></div>';
  h+='<textarea id="snip-text" placeholder="Snippet text..." style="width:100%;height:60px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;font-family:var(--mono);resize:vertical;margin-bottom:12px;box-sizing:border-box"></textarea>';
  if(S._snippets.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Saved Snippets ('+S._snippets.length+')</div>';
    S._snippets.forEach((s,i)=>{
      h+=`<div style="padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px;border-left:2px solid var(--accent)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:10px;font-weight:600;color:var(--text-primary)">${esc(s.name)}</span><div style="display:flex;gap:4px"><button onclick="navigator.clipboard.writeText(S._snippets[${i}].text);toast('Copied!')" style="padding:2px 6px;background:var(--accent);border:none;border-radius:3px;color:#000;font-size:8px;cursor:pointer">Copy</button><button onclick="S._snippets.splice(${i},1);save();showSnippetManager()" style="padding:2px 6px;background:var(--red);border:none;border-radius:3px;color:#fff;font-size:8px;cursor:pointer">Del</button></div></div><div style="font-size:9px;color:var(--text-muted);font-family:var(--mono);white-space:pre-wrap;max-height:60px;overflow-y:auto">${esc(s.text.substring(0,200))}</div></div>`;
    });
  }else{
    h+='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:10px">No snippets yet. Add your first reusable text snippet above.</div>';
  }
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Snippet Manager</span><button onclick="document.getElementById('snippet-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function addSnippet(){
  const nameEl=document.getElementById('snip-name');const textEl=document.getElementById('snip-text');
  if(!nameEl||!textEl)return;
  const name=nameEl.value.trim();const text=textEl.value.trim();
  if(!name||!text){toast('Name and text required');return;}
  if(!S._snippets)S._snippets=[];
  S._snippets.unshift({name,text,createdAt:new Date().toISOString()});
  save();showSnippetManager();toast('Snippet saved');
}
function showTaskHeatmap(){
  let panel=document.getElementById('heatmap-full-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='heatmap-full-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:80vh;overflow-y:auto';
  const today=new Date();const days=[];
  for(let i=364;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);days.push(d.toISOString().split('T')[0]);}
  const activity={};
  S.tasks.forEach(t=>{
    if(t.createdAt){const d=t.createdAt.split('T')[0];activity[d]=(activity[d]||0)+1;}
    if(t.completedAt){const d=t.completedAt.split('T')[0];activity[d]=(activity[d]||0)+2;}
    if(t.status==='done'&&t.due){activity[t.due]=(activity[t.due]||0)+1;}
  });
  S.content.forEach(c=>{if(c.createdAt){const d=c.createdAt.split('T')[0];activity[d]=(activity[d]||0)+1;}});
  (S.focusSessions||[]).forEach(f=>{if(f.date){activity[f.date]=(activity[f.date]||0)+1;}});
  const maxAct=Math.max(...Object.values(activity),1);
  function getColor(count){
    if(!count)return'var(--bg-surface)';
    const intensity=count/maxAct;
    if(intensity>0.75)return'#22c55e';
    if(intensity>0.5)return'#16a34a';
    if(intensity>0.25)return'#15803d';
    return'#166534';
  }
  const weeks=Math.ceil(days.length/7);
  let h='<div style="display:flex;gap:1px;overflow-x:auto">';
  const startDow=new Date(days[0]).getDay();
  let dayIdx=0;
  for(let w=0;w<53;w++){
    h+='<div style="display:flex;flex-direction:column;gap:1px">';
    for(let d=0;d<7;d++){
      if(w===0&&d<startDow){h+='<div style="width:10px;height:10px"></div>';continue;}
      if(dayIdx>=days.length){h+='<div style="width:10px;height:10px"></div>';continue;}
      const ds=days[dayIdx];const count=activity[ds]||0;
      h+=`<div title="${ds}: ${count} activities" style="width:10px;height:10px;border-radius:2px;background:${getColor(count)}" onmouseenter="this.style.outline='1px solid var(--text-primary)'" onmouseleave="this.style.outline='none'"></div>`;
      dayIdx++;
    }
    h+='</div>';
  }
  h+='</div>';
  const monthLabels=[];let prevMonth='';
  days.forEach((d,i)=>{const m=d.substring(0,7);if(m!==prevMonth){monthLabels.push({idx:Math.floor(i/7),label:new Date(d).toLocaleDateString('en-US',{month:'short'})});prevMonth=m;}});
  let monthBar='<div style="display:flex;gap:1px;margin-bottom:4px;padding-left:0">';
  let lastIdx=-1;
  monthLabels.forEach(m=>{const gap=(m.idx-lastIdx-1)*11;if(gap>0)monthBar+=`<span style="width:${gap}px"></span>`;monthBar+=`<span style="font-size:8px;color:var(--text-muted)">${m.label}</span>`;lastIdx=m.idx;});
  monthBar+='</div>';
  const totalAct=Object.values(activity).reduce((s,v)=>s+v,0);
  const activeDays=Object.keys(activity).length;
  let streak=0;const dd=new Date();
  for(let i=0;i<365;i++){const ds=dd.toISOString().split('T')[0];if(activity[ds]){streak++;}else if(i>0){break;}dd.setDate(dd.getDate()-1);}
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Activity Heatmap (365 Days)</span><button onclick="document.getElementById('heatmap-full-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;gap:16px;margin-bottom:12px;font-size:10px"><span style="color:var(--text-muted)">${totalAct} total activities</span><span style="color:var(--text-muted)">${activeDays} active days</span><span style="color:var(--accent)">${streak}d streak</span></div>${monthBar}<div style="overflow-x:auto;padding:4px 0">${h}</div><div style="display:flex;align-items:center;gap:4px;margin-top:8px;font-size:8px;color:var(--text-muted)">Less <div style="width:10px;height:10px;border-radius:2px;background:var(--bg-surface)"></div><div style="width:10px;height:10px;border-radius:2px;background:#166534"></div><div style="width:10px;height:10px;border-radius:2px;background:#15803d"></div><div style="width:10px;height:10px;border-radius:2px;background:#16a34a"></div><div style="width:10px;height:10px;border-radius:2px;background:#22c55e"></div> More</div>`;
  document.body.appendChild(panel);
}
function showLinkDashboard(){
  let panel=document.getElementById('link-dash-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='link-dash-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const links=S.links||[];
  const total=links.length;
  const pinned=links.filter(l=>l.pinned).length;
  const readLater=links.filter(l=>l.readLater).length;
  const read=links.filter(l=>l.isRead).length;
  const cats={};links.forEach(l=>{const c=l.category||'Uncategorized';cats[c]=(cats[c]||0)+1;});
  const domains={};links.forEach(l=>{try{const u=new URL(l.url);domains[u.hostname]=(domains[u.hostname]||0)+1;}catch(e){}});
  const topDomains=Object.entries(domains).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const thisWeek=new Date();thisWeek.setDate(thisWeek.getDate()-7);const weekStr=thisWeek.toISOString().split('T')[0];
  const recentLinks=links.filter(l=>l.createdAt&&l.createdAt.split('T')[0]>=weekStr).length;
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:var(--accent)">${total}</div><div style="font-size:8px;color:var(--text-muted)">Total Links</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#f59e0b">${readLater}</div><div style="font-size:8px;color:var(--text-muted)">Read Later</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#22c55e">${recentLinks}</div><div style="font-size:8px;color:var(--text-muted)">This Week</div></div>`;
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">By Category</div>';
  Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([c,n])=>{
    const pct=Math.round(n/total*100);
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:9px"><span style="color:var(--text-primary);flex:1">${esc(c)}</span><span style="color:var(--accent)">${n}</span><div style="width:40px;height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px"></div></div></div>`;
  });
  h+='</div>';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Top Domains</div>';
  topDomains.forEach(([d,n])=>{
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:9px"><span style="color:var(--text-primary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(d)}</span><span style="color:var(--accent)">${n}</span></div>`;
  });
  h+='</div></div>';
  h+=`<div style="display:flex;gap:8px;font-size:9px;color:var(--text-muted)"><span>Pinned: ${pinned}</span><span>Read: ${read}</span></div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Link Dashboard</span><button onclick="document.getElementById('link-dash-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showTaskDependencyGraph(){
  let panel=document.getElementById('dep-graph-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='dep-graph-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  const blocked=active.filter(t=>t.blockedBy);
  const blockers=active.filter(t=>t.blocking&&t.blocking.length);
  const chains=[];
  blocked.forEach(t=>{
    const chain=[t];
    let current=t;let depth=0;
    while(current.blockedBy&&depth<10){
      const blocker=S.tasks.find(x=>x.id===current.blockedBy||x.title===current.blockedBy);
      if(blocker){chain.unshift(blocker);current=blocker;depth++;}else break;
    }
    if(chain.length>1)chains.push(chain);
  });
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:var(--accent)">${active.length}</div><div style="font-size:8px;color:var(--text-muted)">Active Tasks</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#ef4444">${blocked.length}</div><div style="font-size:8px;color:var(--text-muted)">Blocked</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#f59e0b">${chains.length}</div><div style="font-size:8px;color:var(--text-muted)">Dep Chains</div></div>`;
  h+='</div>';
  if(chains.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Dependency Chains</div>';
    chains.forEach((chain,ci)=>{
      h+=`<div style="margin-bottom:10px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
      chain.forEach((t,i)=>{
        const isLast=i===chain.length-1;
        const statusColor=t.status==='in-progress'?'#3b82f6':t.status==='done'?'#22c55e':'var(--text-muted)';
        h+=`<div onclick="document.getElementById('dep-graph-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:3px 6px;cursor:pointer;border-left:2px solid ${statusColor}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="font-size:9px;color:${statusColor}">${t.status==='done'?'DONE':t.status==='in-progress'?'WIP':'TODO'}</span><span style="font-size:10px;color:var(--text-primary);flex:1">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'}">${t.priority||'p2'}</span></div>`;
        if(!isLast)h+=`<div style="padding-left:12px;font-size:8px;color:var(--text-muted)">blocks &#8595;</div>`;
      });
      h+='</div>';
    });
  }
  if(blocked.length&&!chains.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Blocked Tasks</div>';
    blocked.forEach(t=>{
      h+=`<div onclick="document.getElementById('dep-graph-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:4px 6px;cursor:pointer;border-left:2px solid #ef4444;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="font-size:10px;color:var(--text-primary);flex:1">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted)">blocked by: ${esc(String(t.blockedBy))}</span></div>`;
    });
  }
  if(!blocked.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No task dependencies found. Add blocked-by in task detail to create chains.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Dependency Graph</span><button onclick="document.getElementById('dep-graph-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showWeeklyReview(){
  let panel=document.getElementById('weekly-review-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='weekly-review-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
  const weekStr=weekAgo.toISOString().split('T')[0];const todayStr=now.toISOString().split('T')[0];
  const completed=S.tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.split('T')[0]>=weekStr);
  const created=S.tasks.filter(t=>t.createdAt&&t.createdAt.split('T')[0]>=weekStr);
  const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<todayStr);
  const inProgress=S.tasks.filter(t=>t.status==='in-progress');
  const contentCreated=S.content.filter(c=>c.createdAt&&c.createdAt.split('T')[0]>=weekStr);
  const docsEdited=(S.docs||[]).filter(d=>(d.updatedAt||'').split('T')[0]>=weekStr);
  const focusMin=(S.focusSessions||[]).filter(f=>f.date>=weekStr).reduce((s,x)=>s+(x.duration||0),0);
  const linksAdded=(S.links||[]).filter(l=>l.createdAt&&l.createdAt.split('T')[0]>=weekStr).length;
  const totalWords=contentCreated.reduce((s,c)=>s+((c.body||'').split(/\s+/).length),0);
  let md='# Weekly Review - '+todayStr+'\\n\\n';
  md+='## Stats\\n';
  md+=`- Completed: ${completed.length} tasks\\n`;
  md+=`- Created: ${created.length} tasks\\n`;
  md+=`- Overdue: ${overdue.length} tasks\\n`;
  md+=`- In Progress: ${inProgress.length} tasks\\n`;
  md+=`- Content Created: ${contentCreated.length} (${totalWords} words)\\n`;
  md+=`- Docs Edited: ${docsEdited.length}\\n`;
  md+=`- Focus Time: ${focusMin}min\\n`;
  md+=`- Links Added: ${linksAdded}\\n\\n`;
  md+='## Completed\\n';
  completed.forEach(t=>{md+=`- [x] ${t.title}${t.project?' ('+t.project+')':''}\\n`;});
  md+='\\n## In Progress\\n';
  inProgress.forEach(t=>{md+=`- [ ] ${t.title}${t.project?' ('+t.project+')':''}\\n`;});
  md+='\\n## Overdue\\n';
  overdue.forEach(t=>{md+=`- [ ] ${t.title} (due ${t.due})\\n`;});
  let h='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#22c55e">${completed.length}</div><div style="font-size:8px;color:var(--text-muted)">Completed</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#3b82f6">${created.length}</div><div style="font-size:8px;color:var(--text-muted)">Created</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${focusMin}m</div><div style="font-size:8px;color:var(--text-muted)">Focus</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#ef4444">${overdue.length}</div><div style="font-size:8px;color:var(--text-muted)">Overdue</div></div>`;
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">Completed This Week</div>';
  completed.slice(0,10).forEach(t=>{h+=`<div style="font-size:9px;color:var(--text-primary);padding:2px 0;border-left:2px solid #22c55e;padding-left:6px;margin:2px 0">${esc(t.title||'Untitled')}</div>`;});
  if(!completed.length)h+='<div style="font-size:9px;color:var(--text-muted)">No tasks completed</div>';
  h+='</div>';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">Still In Progress</div>';
  inProgress.slice(0,10).forEach(t=>{h+=`<div style="font-size:9px;color:var(--text-primary);padding:2px 0;border-left:2px solid #3b82f6;padding-left:6px;margin:2px 0">${esc(t.title||'Untitled')}</div>`;});
  if(!inProgress.length)h+='<div style="font-size:9px;color:var(--text-muted)">Nothing in progress</div>';
  h+='</div></div>';
  h+=`<div style="display:flex;gap:8px;font-size:9px;margin-bottom:8px"><span style="color:var(--text-muted)">Content: ${contentCreated.length} items (${totalWords} words)</span><span style="color:var(--text-muted)">Docs: ${docsEdited.length}</span><span style="color:var(--text-muted)">Links: ${linksAdded}</span></div>`;
  h+=`<button onclick="navigator.clipboard.writeText(\`${md.replace(/`/g,"'")}\`);toast('Review copied as markdown')" style="padding:6px 12px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer">Copy as Markdown</button>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Weekly Review</span><button onclick="document.getElementById('weekly-review-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showPomodoroHistory(){
  let panel=document.getElementById('pomo-hist-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='pomo-hist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const sessions=(S.focusSessions||[]).slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  const totalMin=sessions.reduce((s,x)=>s+(x.duration||0),0);
  const totalSessions=sessions.length;
  const byTask={};sessions.forEach(s=>{const n=s.taskName||s.task||'Untitled';if(!byTask[n])byTask[n]=0;byTask[n]+=(s.duration||0);});
  const topTasks=Object.entries(byTask).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const byDate={};sessions.forEach(s=>{if(!s.date)return;if(!byDate[s.date])byDate[s.date]=0;byDate[s.date]+=(s.duration||0);});
  const bestDay=Object.entries(byDate).sort((a,b)=>b[1]-a[1])[0];
  const avgPerDay=Object.keys(byDate).length?Math.round(totalMin/Object.keys(byDate).length):0;
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${totalSessions}</div><div style="font-size:8px;color:var(--text-muted)">Sessions</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${avgPerDay}m</div><div style="font-size:8px;color:var(--text-muted)">Avg/Day</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#22c55e">${bestDay?bestDay[1]+'m':'-'}</div><div style="font-size:8px;color:var(--text-muted)">Best Day${bestDay?' ('+bestDay[0].substring(5)+')':''}</div></div>`;
  h+='</div>';
  if(topTasks.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Most Focused Tasks</div>';
    topTasks.forEach(([name,mins])=>{
      const pct=Math.round(mins/totalMin*100);
      h+=`<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:9px"><span style="color:var(--text-primary);flex:1">${esc(name)}</span><span style="color:var(--accent)">${mins}m</span><div style="width:60px;height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px"></div></div></div>`;
    });
  }
  if(!sessions.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No Pomodoro sessions yet</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Pomodoro History</span><button onclick="document.getElementById('pomo-hist-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showTagCloud(){
  let panel=document.getElementById('tag-cloud-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='tag-cloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const tagCounts={};
  S.content.forEach(c=>{(c.tags||[]).forEach(t=>{tagCounts[t]=(tagCounts[t]||0)+1;});});
  S.tasks.forEach(t=>{(t.tags||[]).forEach(tg=>{tagCounts[tg]=(tagCounts[tg]||0)+1;});});
  const sorted=Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]);
  const maxCount=sorted.length?sorted[0][1]:1;
  const colors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316','#14b8a6','#a855f7'];
  let h='<div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:center;padding:12px">';
  sorted.forEach(([tag,count],i)=>{
    const scale=0.7+(count/maxCount)*1.3;
    const size=Math.round(9*scale);
    const color=colors[i%colors.length];
    h+=`<span onclick="document.getElementById('tag-cloud-panel').remove();switchSection('content');setTimeout(()=>{const si=document.getElementById('content-search');if(si){si.value='#'+\`${tag.replace(/'/g,"")}\`;si.dispatchEvent(new Event('input'));}},100)" style="font-size:${size}px;color:${color};cursor:pointer;padding:2px 6px;background:${color}15;border-radius:4px;transition:transform 0.2s" onmouseenter="this.style.transform='scale(1.15)'" onmouseleave="this.style.transform='scale(1)'" title="${count} items">${esc(tag)}<sup style="font-size:7px;color:var(--text-muted)">${count}</sup></span>`;
  });
  h+='</div>';
  if(!sorted.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No tags found. Add tags to content and tasks to see a cloud.</div>';
  const themes={};S.content.forEach(c=>{if(c.theme)themes[c.theme]=(themes[c.theme]||0)+1;});
  const themesSorted=Object.entries(themes).sort((a,b)=>b[1]-a[1]).slice(0,10);
  if(themesSorted.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin:12px 0 6px">Content Themes</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:4px">';
    themesSorted.forEach(([theme,count],i)=>{h+=`<span style="font-size:9px;color:${colors[i%colors.length]};padding:2px 8px;background:${colors[i%colors.length]}15;border-radius:10px">${esc(theme)} (${count})</span>`;});
    h+='</div>';
  }
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Tag Cloud (${sorted.length} tags)</span><button onclick="document.getElementById('tag-cloud-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showPriorityGrid(){
  let panel=document.getElementById('priority-grid-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='priority-grid-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  const priorities=['p0','p1','p2','p3'];
  const pLabels={p0:'Critical',p1:'High',p2:'Medium',p3:'Low'};
  const pColors={p0:'#ef4444',p1:'#f97316',p2:'#3b82f6',p3:'#6b7280'};
  let h='';
  priorities.forEach(pri=>{
    const tasks=active.filter(t=>(t.priority||'p2')===pri);
    h+=`<div style="margin-bottom:12px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="width:8px;height:8px;border-radius:2px;background:${pColors[pri]}"></span><span style="font-size:11px;font-weight:600;color:${pColors[pri]}">${pLabels[pri]} (${tasks.length})</span></div>`;
    if(tasks.length){
      tasks.forEach(t=>{
        h+=`<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;margin:2px 0;border-left:2px solid ${pColors[pri]};font-size:10px" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="flex:1;color:var(--text-primary);cursor:pointer" onclick="document.getElementById('priority-grid-panel').remove();openTaskDetail(${t.id})">${esc(t.title||'Untitled')}</span>`;
        priorities.forEach(np=>{
          if(np===pri)return;
          h+=`<button onclick="var tk=S.tasks.find(x=>x.id===${t.id});if(tk){tk.priority='${np}';save();showPriorityGrid();}" style="padding:1px 4px;background:${pColors[np]}30;border:1px solid ${pColors[np]}50;border-radius:3px;color:${pColors[np]};font-size:7px;cursor:pointer" title="Move to ${pLabels[np]}">${np.toUpperCase()}</button>`;
        });
        h+='</div>';
      });
    }else{
      h+='<div style="font-size:9px;color:var(--text-muted);padding:4px 8px">No tasks</div>';
    }
    h+='</div>';
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Priority Grid (Quick Reassign)</span><button onclick="document.getElementById('priority-grid-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="font-size:9px;color:var(--text-muted);margin-bottom:8px">Click priority buttons to quickly reassign task priority</div>${h}`;
  document.body.appendChild(panel);
}
function showContentTimeline(){
  let panel=document.getElementById('content-tl-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-tl-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const items=S.content.slice().sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
  const byDay={};
  items.forEach(c=>{
    const d=(c.createdAt||'').split('T')[0]||'Unknown';
    if(!byDay[d])byDay[d]=[];
    byDay[d].push(c);
  });
  const typeColors={idea:'#f59e0b',quote:'#8b5cf6',code:'#06b6d4',insight:'#3b82f6',todo:'#ef4444',book:'#ec4899',research:'#22c55e',thought:'#14b8a6'};
  let h='';
  Object.keys(byDay).sort().reverse().slice(0,30).forEach(day=>{
    const d=new Date(day);
    const label=day==='Unknown'?'No Date':d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    h+=`<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--text-secondary);padding-bottom:4px;border-bottom:1px solid var(--border)">${label} (${byDay[day].length} items)</div>`;
    byDay[day].forEach(c=>{
      const color=typeColors[c.type]||'var(--text-muted)';
      const time=(c.createdAt||'').split('T')[1]||'';
      const timeStr=time?time.substring(0,5):'';
      const words=(c.body||'').split(/\s+/).length;
      h+=`<div onclick="document.getElementById('content-tl-panel').remove();openContentModal(${c.id})" style="display:flex;align-items:flex-start;gap:8px;padding:4px 6px;cursor:pointer;border-left:2px solid ${color};margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><div style="min-width:32px;font-size:8px;color:var(--text-muted);font-family:var(--mono)">${timeStr}</div><div style="flex:1"><div style="font-size:10px;color:var(--text-primary)">${esc((c.body||'').substring(0,80))}</div><div style="display:flex;gap:6px;font-size:8px;color:var(--text-muted);margin-top:2px"><span style="color:${color}">${c.type||'note'}</span>${c.theme?`<span>${esc(c.theme)}</span>`:''}<span>${words}w</span></div></div></div>`;
    });
    h+='</div>';
  });
  if(!items.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No content items yet</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Content Timeline (${items.length} items)</span><button onclick="document.getElementById('content-tl-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showVelocityChart(){
  let panel=document.getElementById('velocity-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='velocity-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:75vh;overflow-y:auto';
  const weeks=[];const now=new Date();
  for(let w=11;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-w*7-now.getDay());
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);
    const startStr=weekStart.toISOString().split('T')[0];
    const endStr=weekEnd.toISOString().split('T')[0];
    const completed=S.tasks.filter(t=>t.completedAt&&t.completedAt.split('T')[0]>=startStr&&t.completedAt.split('T')[0]<=endStr).length;
    const created=S.tasks.filter(t=>t.createdAt&&t.createdAt.split('T')[0]>=startStr&&t.createdAt.split('T')[0]<=endStr).length;
    weeks.push({label:weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'}),completed,created});
  }
  const maxVal=Math.max(...weeks.map(w=>Math.max(w.completed,w.created)),1);
  const W=480;const H=180;const pad=30;const gw=W-pad*2;const gh=H-pad*2;
  let svg=`<svg viewBox="0 0 ${W} ${H}" style="width:100%;height:auto">`;
  for(let i=0;i<=4;i++){
    const y=pad+gh-gh*(i/4);const val=Math.round(maxVal*(i/4));
    svg+=`<line x1="${pad}" y1="${y}" x2="${W-pad}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;
    svg+=`<text x="${pad-4}" y="${y+3}" font-size="8" fill="var(--text-muted)" text-anchor="end">${val}</text>`;
  }
  let completedPath='';let createdPath='';
  weeks.forEach((w,i)=>{
    const x=pad+i*(gw/(weeks.length-1));
    const yC=pad+gh-gh*(w.completed/maxVal);
    const yR=pad+gh-gh*(w.created/maxVal);
    completedPath+=(i===0?'M':'L')+x+','+yC;
    createdPath+=(i===0?'M':'L')+x+','+yR;
    if(i%2===0)svg+=`<text x="${x}" y="${H-5}" font-size="7" fill="var(--text-muted)" text-anchor="middle">${w.label}</text>`;
  });
  svg+=`<path d="${createdPath}" fill="none" stroke="#3b82f6" stroke-width="2" opacity="0.7"/>`;
  svg+=`<path d="${completedPath}" fill="none" stroke="#22c55e" stroke-width="2"/>`;
  weeks.forEach((w,i)=>{
    const x=pad+i*(gw/(weeks.length-1));
    const yC=pad+gh-gh*(w.completed/maxVal);
    const yR=pad+gh-gh*(w.created/maxVal);
    svg+=`<circle cx="${x}" cy="${yC}" r="3" fill="#22c55e"/>`;
    svg+=`<circle cx="${x}" cy="${yR}" r="3" fill="#3b82f6"/>`;
  });
  svg+='</svg>';
  const totalCompleted=weeks.reduce((s,w)=>s+w.completed,0);
  const totalCreated=weeks.reduce((s,w)=>s+w.created,0);
  const avgVelocity=Math.round(totalCompleted/weeks.length*10)/10;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Velocity (12 Weeks)</span><button onclick="document.getElementById('velocity-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;gap:12px;margin-bottom:8px;font-size:10px"><span style="color:#22c55e">Completed: ${totalCompleted}</span><span style="color:#3b82f6">Created: ${totalCreated}</span><span style="color:var(--accent)">Avg: ${avgVelocity}/wk</span></div><div style="display:flex;gap:8px;margin-bottom:8px;font-size:8px"><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:3px;background:#22c55e;border-radius:1px"></span>Completed</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:3px;background:#3b82f6;border-radius:1px"></span>Created</span></div>${svg}`;
  document.body.appendChild(panel);
}
function toggleQuickNote(){
  let btn=document.getElementById('quick-note-fab');
  if(btn){btn.remove();return;}
  btn=document.createElement('div');btn.id='quick-note-fab';
  btn.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1400;display:flex;flex-direction:column;align-items:flex-end;gap:8px';
  btn.innerHTML=`<div id="quick-note-area" style="display:none;width:280px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:10px;box-shadow:0 8px 32px rgba(0,0,0,0.5)"><textarea id="quick-note-text" placeholder="Quick note..." style="width:100%;height:60px;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;resize:vertical;box-sizing:border-box;margin-bottom:6px"></textarea><div style="display:flex;gap:4px"><select id="quick-note-type" style="flex:1;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:10px"><option value="idea">Idea</option><option value="thought">Thought</option><option value="quote">Quote</option><option value="todo">Todo</option><option value="insight">Insight</option></select><button onclick="saveQuickNote()" style="padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer">Save</button></div></div><button onclick="const a=document.getElementById('quick-note-area');a.style.display=a.style.display==='none'?'block':'none';if(a.style.display==='block')document.getElementById('quick-note-text').focus()" style="width:40px;height:40px;border-radius:50%;background:var(--accent);border:none;color:#000;font-size:18px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-weight:700">+</button>`;
  document.body.appendChild(btn);
}
function saveQuickNote(){
  const text=document.getElementById('quick-note-text');
  const type=document.getElementById('quick-note-type');
  if(!text||!text.value.trim()){toast('Enter some text');return;}
  const id=Date.now();
  S.content.unshift({id,body:text.value.trim(),type:type.value,theme:'quick-capture',tags:['quick-note'],createdAt:new Date().toISOString(),pinned:false});
  save();text.value='';toast('Quick note saved!');
  const area=document.getElementById('quick-note-area');if(area)area.style.display='none';
}
function showBookmarkletGenerator(){
  let panel=document.getElementById('bookmarklet-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='bookmarklet-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const bookmarklets=[
    {name:'Save Page as Link',desc:'Save current page URL + title to ASTRA links',code:"javascript:void(function(){var t=document.title,u=window.location.href;var d=JSON.parse(localStorage.getItem('astra-state')||'{}');if(!d.links)d.links=[];d.links.unshift({id:Date.now(),title:t,url:u,category:'saved',createdAt:new Date().toISOString()});localStorage.setItem('astra-state',JSON.stringify(d));alert('Saved: '+t)}())"},
    {name:'Capture Selection',desc:'Save highlighted text to ASTRA content',code:"javascript:void(function(){var s=window.getSelection().toString();if(!s){alert('Select some text first');return}var d=JSON.parse(localStorage.getItem('astra-state')||'{}');if(!d.content)d.content=[];d.content.unshift({id:Date.now(),body:s,type:'quote',theme:'web-capture',tags:['bookmarklet'],source:window.location.href,createdAt:new Date().toISOString()});localStorage.setItem('astra-state',JSON.stringify(d));alert('Captured '+s.length+' chars')}())"},
    {name:'Quick Task',desc:'Create a task from current page',code:"javascript:void(function(){var t=prompt('Task title:',document.title);if(!t)return;var d=JSON.parse(localStorage.getItem('astra-state')||'{}');if(!d.tasks)d.tasks=[];d.tasks.unshift({id:Date.now(),title:t,status:'todo',priority:'p2',createdAt:new Date().toISOString()});localStorage.setItem('astra-state',JSON.stringify(d));alert('Task created: '+t)}())"},
  ];
  let h='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Drag these links to your bookmarks bar, or right-click and "Add to Bookmarks"</div>';
  bookmarklets.forEach(b=>{
    h+=`<div style="padding:10px;background:var(--bg-surface);border-radius:6px;margin-bottom:8px;border-left:2px solid var(--accent)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><a href="${b.code}" style="font-size:11px;font-weight:600;color:var(--accent);text-decoration:none;cursor:move" onclick="event.preventDefault();toast('Drag to bookmarks bar!')">${esc(b.name)}</a><button onclick="navigator.clipboard.writeText(\`${b.code.replace(/`/g,"'")}\`);toast('Bookmarklet code copied!')" style="padding:2px 8px;background:var(--accent);border:none;border-radius:3px;color:#000;font-size:8px;cursor:pointer">Copy</button></div><div style="font-size:9px;color:var(--text-muted)">${b.desc}</div></div>`;
  });
  h+='<div style="font-size:9px;color:var(--text-muted);margin-top:8px;font-style:italic">Note: Bookmarklets work on the same domain. For cross-domain, use the Nexus Capture extension.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Bookmarklet Generator</span><button onclick="document.getElementById('bookmarklet-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showWorkspaceSearch(initialQuery){
  let panel=document.getElementById('ws-search-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ws-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:85vh;overflow-y:auto';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Workspace Search</span><button onclick="document.getElementById('ws-search-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><input id="ws-search-input" placeholder="Search everything..." value="${initialQuery||''}" style="width:100%;padding:8px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;margin-bottom:10px;box-sizing:border-box" autofocus><div id="ws-search-results" style="font-size:10px"></div>`;
  document.body.appendChild(panel);
  const input=document.getElementById('ws-search-input');
  input.addEventListener('input',()=>runWorkspaceSearch(input.value));
  if(initialQuery)runWorkspaceSearch(initialQuery);
  input.focus();
}
function runWorkspaceSearch(q){
  const results=document.getElementById('ws-search-results');if(!results)return;
  if(!q||q.length<2){results.innerHTML='<div style="color:var(--text-muted);padding:12px;text-align:center">Type at least 2 characters...</div>';return;}
  const ql=q.toLowerCase();const matches=[];
  S.tasks.forEach(t=>{
    const score=((t.title||'').toLowerCase().includes(ql)?3:0)+((t.description||'').toLowerCase().includes(ql)?2:0)+((t.project||'').toLowerCase().includes(ql)?1:0);
    if(score>0)matches.push({section:'Tasks',title:t.title||'Untitled',preview:(t.description||'').substring(0,80),score,action:`openTaskDetail(${t.id})`,color:'#06b6d4',status:t.status,pri:t.priority});
  });
  S.content.forEach(c=>{
    const score=((c.body||'').toLowerCase().includes(ql)?3:0)+((c.tags||[]).join(' ').toLowerCase().includes(ql)?2:0)+((c.theme||'').toLowerCase().includes(ql)?1:0);
    if(score>0)matches.push({section:'Content',title:(c.body||'').substring(0,60),preview:c.type+' | '+(c.theme||''),score,action:`openContentModal(${c.id})`,color:'#f59e0b'});
  });
  (S.docs||[]).forEach(d=>{
    const score=((d.title||'').toLowerCase().includes(ql)?3:0)+((d.body||'').toLowerCase().includes(ql)?2:0);
    if(score>0)matches.push({section:'Writer',title:d.title||'Untitled',preview:(d.body||'').substring(0,80),score,action:`switchSection('writer');setTimeout(()=>{const i=S.docs.findIndex(x=>x.id===${d.id});if(i>=0){writerDocIdx=i;renderWriterDoc();}},100)`,color:'var(--accent)'});
  });
  (S.links||[]).forEach(l=>{
    const score=((l.title||'').toLowerCase().includes(ql)?3:0)+((l.url||'').toLowerCase().includes(ql)?2:0)+((l.category||'').toLowerCase().includes(ql)?1:0);
    if(score>0)matches.push({section:'Links',title:l.title||l.url,preview:l.url,score,action:`window.open('${(l.url||'').replace(/'/g,"\\'")}','_blank')`,color:'#8b5cf6'});
  });
  matches.sort((a,b)=>b.score-a.score);
  let h=`<div style="color:var(--text-muted);padding:4px 0;margin-bottom:6px">${matches.length} results for "${esc(q)}"</div>`;
  const sections={};matches.slice(0,30).forEach(m=>{if(!sections[m.section])sections[m.section]=[];sections[m.section].push(m);});
  Object.entries(sections).forEach(([sec,items])=>{
    h+=`<div style="font-size:10px;font-weight:600;color:var(--text-secondary);padding:6px 0 4px;border-bottom:1px solid var(--border)">${sec} (${items.length})</div>`;
    items.forEach(m=>{
      h+=`<div onclick="document.getElementById('ws-search-panel').remove();${m.action}" style="padding:5px 8px;cursor:pointer;display:flex;align-items:center;gap:8px;border-left:2px solid ${m.color}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><div style="flex:1"><div style="font-size:10px;color:var(--text-primary)">${esc(m.title)}</div>${m.preview?`<div style="font-size:8px;color:var(--text-muted)">${esc(m.preview)}</div>`:''}</div>${m.status?`<span style="font-size:7px;color:var(--text-muted)">${m.status}</span>`:''}</div>`;
    });
  });
  if(!matches.length)h='<div style="color:var(--text-muted);padding:20px;text-align:center">No results found</div>';
  results.innerHTML=h;
}
function showBatchTaskEditor(){
  let panel=document.getElementById('batch-edit-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='batch-edit-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  let h='<div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap"><label style="font-size:10px;color:var(--text-secondary);display:flex;align-items:center;gap:4px"><input type="checkbox" id="batch-select-all" onchange="document.querySelectorAll(\'.batch-task-cb\').forEach(cb=>cb.checked=this.checked)"> Select All</label><select id="batch-action" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:10px"><option value="">Action...</option><option value="priority">Set Priority</option><option value="status">Set Status</option><option value="project">Set Project</option><option value="due">Set Due Date</option></select><select id="batch-value" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:10px"><option value="">Value...</option><option value="p0">P0 Critical</option><option value="p1">P1 High</option><option value="p2">P2 Medium</option><option value="p3">P3 Low</option><option value="todo">Status: Todo</option><option value="in-progress">Status: In Progress</option><option value="done">Status: Done</option></select><button onclick="applyBatchEdit()" style="padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer">Apply</button></div>';
  active.forEach(t=>{
    const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':t.priority==='p2'?'#3b82f6':'#6b7280';
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:4px 6px;font-size:10px;border-left:2px solid ${priColor}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><input type="checkbox" class="batch-task-cb" value="${t.id}"><span style="flex:1;color:var(--text-primary)">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${priColor}">${(t.priority||'p2').toUpperCase()}</span><span style="font-size:8px;color:var(--text-muted)">${t.status}</span></div>`;
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Batch Task Editor (${active.length} active)</span><button onclick="document.getElementById('batch-edit-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function applyBatchEdit(){
  const action=document.getElementById('batch-action');
  const value=document.getElementById('batch-value');
  if(!action||!value||!action.value||!value.value){toast('Select action and value');return;}
  const checked=document.querySelectorAll('.batch-task-cb:checked');
  if(!checked.length){toast('Select tasks first');return;}
  let count=0;
  checked.forEach(cb=>{
    const t=S.tasks.find(x=>x.id===parseInt(cb.value));
    if(!t)return;
    if(action.value==='priority')t.priority=value.value;
    else if(action.value==='status'){t.status=value.value;if(value.value==='done')t.completedAt=new Date().toISOString();}
    else if(action.value==='project')t.project=value.value;
    count++;
  });
  save();toast('Updated '+count+' tasks');showBatchTaskEditor();
}
function showContentStats(){
  let panel=document.getElementById('content-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const items=S.content||[];
  const totalWords=items.reduce((s,c)=>s+((c.body||'').split(/\s+/).length),0);
  const totalChars=items.reduce((s,c)=>s+(c.body||'').length,0);
  const types={};items.forEach(c=>{const t=c.type||'note';types[t]=(types[t]||0)+1;});
  const themes={};items.forEach(c=>{if(c.theme)themes[c.theme]=(themes[c.theme]||0)+1;});
  const tags={};items.forEach(c=>{(c.tags||[]).forEach(t=>{tags[t]=(tags[t]||0)+1;});});
  const pinned=items.filter(c=>c.pinned).length;
  const starred=items.filter(c=>c.starred).length;
  const avgWords=items.length?Math.round(totalWords/items.length):0;
  const thisWeek=new Date();thisWeek.setDate(thisWeek.getDate()-7);const weekStr=thisWeek.toISOString().split('T')[0];
  const recentCount=items.filter(c=>c.createdAt&&c.createdAt.split('T')[0]>=weekStr).length;
  const topTypes=Object.entries(types).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const topThemes=Object.entries(themes).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const topTags=Object.entries(tags).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const typeColors={idea:'#f59e0b',quote:'#8b5cf6',code:'#06b6d4',insight:'#3b82f6',todo:'#ef4444',book:'#ec4899',research:'#22c55e',thought:'#14b8a6',note:'#6b7280'};
  let h='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${items.length}</div><div style="font-size:7px;color:var(--text-muted)">Items</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#3b82f6">${(totalWords/1000).toFixed(1)}k</div><div style="font-size:7px;color:var(--text-muted)">Words</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${avgWords}</div><div style="font-size:7px;color:var(--text-muted)">Avg Words</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#22c55e">${recentCount}</div><div style="font-size:7px;color:var(--text-muted)">This Week</div></div>`;
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">By Type</div>';
  topTypes.forEach(([t,n])=>{
    const pct=Math.round(n/items.length*100);const color=typeColors[t]||'var(--text-muted)';
    h+=`<div style="display:flex;align-items:center;gap:4px;padding:2px 0;font-size:9px"><span style="width:6px;height:6px;border-radius:50%;background:${color}"></span><span style="flex:1;color:var(--text-primary)">${esc(t)}</span><span style="color:var(--text-muted)">${n} (${pct}%)</span></div>`;
  });
  h+='</div>';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">By Theme</div>';
  topThemes.forEach(([t,n])=>{h+=`<div style="font-size:9px;color:var(--text-primary);padding:2px 0">${esc(t)} <span style="color:var(--text-muted)">(${n})</span></div>`;});
  if(!topThemes.length)h+='<div style="font-size:9px;color:var(--text-muted)">No themes</div>';
  h+='</div></div>';
  if(topTags.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">Top Tags</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
    topTags.forEach(([t,n])=>{h+=`<span style="font-size:8px;color:var(--accent);padding:2px 6px;background:var(--accent)15;border-radius:8px">${esc(t)} (${n})</span>`;});
    h+='</div>';
  }
  h+=`<div style="font-size:9px;color:var(--text-muted)">Pinned: ${pinned} | Starred: ${starred} | ${(totalChars/1024).toFixed(1)}KB total</div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Content Stats Dashboard</span><button onclick="document.getElementById('content-stats-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showSwimlaneView(){
  let panel=document.getElementById('swimlane-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='swimlane-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow-y:auto';
  const projects=[...new Set(S.tasks.map(t=>t.project||'No Project'))].sort();
  const statuses=['todo','in-progress','done'];
  const statusLabels={todo:'Todo','in-progress':'In Progress',done:'Done'};
  const statusColors={todo:'var(--text-muted)','in-progress':'#3b82f6',done:'#22c55e'};
  let h='<div style="overflow-x:auto">';
  h+='<table style="width:100%;border-collapse:collapse;font-size:10px">';
  h+='<thead><tr><th style="text-align:left;padding:6px;color:var(--text-muted);font-size:9px;border-bottom:1px solid var(--border);min-width:100px">Project</th>';
  statuses.forEach(s=>{h+=`<th style="text-align:center;padding:6px;color:${statusColors[s]};font-size:9px;border-bottom:1px solid var(--border);min-width:150px">${statusLabels[s]}</th>`;});
  h+='</tr></thead><tbody>';
  projects.forEach(proj=>{
    const projTasks=S.tasks.filter(t=>(t.project||'No Project')===proj);
    h+=`<tr><td style="padding:8px;vertical-align:top;border-bottom:1px solid var(--border)"><div style="font-weight:600;color:var(--text-primary)">${esc(proj)}</div><div style="font-size:8px;color:var(--text-muted)">${projTasks.length} tasks</div></td>`;
    statuses.forEach(s=>{
      const tasks=projTasks.filter(t=>t.status===s);
      h+='<td style="padding:4px;vertical-align:top;border-bottom:1px solid var(--border)">';
      tasks.slice(0,8).forEach(t=>{
        const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-muted)';
        h+=`<div onclick="document.getElementById('swimlane-panel').remove();openTaskDetail(${t.id})" style="padding:3px 6px;margin:2px 0;background:var(--bg-surface);border-radius:4px;cursor:pointer;border-left:2px solid ${priColor}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='var(--bg-surface)'"><div style="font-size:9px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div></div>`;
      });
      if(tasks.length>8)h+=`<div style="font-size:8px;color:var(--text-muted);padding:2px 6px">+${tasks.length-8} more</div>`;
      if(!tasks.length)h+='<div style="font-size:8px;color:var(--text-muted);padding:4px;text-align:center">-</div>';
      h+='</td>';
    });
    h+='</tr>';
  });
  h+='</tbody></table></div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Swimlane View (${projects.length} projects)</span><button onclick="document.getElementById('swimlane-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showDailyPlanner(){
  let panel=document.getElementById('daily-plan-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='daily-plan-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:85vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const todayLabel=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
  const timeBlocks=(S._timeBlocks||[]).filter(b=>b.date===today);
  const hours=['06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00'];
  const nowHour=new Date().getHours();
  let h=`<div style="font-size:11px;color:var(--text-secondary);margin-bottom:12px">${todayLabel}</div>`;
  if(overdue.length){
    h+=`<div style="font-size:10px;font-weight:600;color:#ef4444;margin-bottom:4px">Overdue (${overdue.length})</div>`;
    overdue.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('daily-plan-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid #ef4444;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title)} <span style="color:#ef4444;font-size:8px">(${t.due})</span></div>`;});
    h+='<div style="height:8px"></div>';
  }
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Daily Schedule</div>';
  hours.forEach(hour=>{
    const hourNum=parseInt(hour);
    const isCurrent=hourNum===nowHour;
    const block=timeBlocks.find(b=>b.start&&parseInt(b.start)===hourNum);
    h+=`<div style="display:flex;align-items:stretch;gap:8px;min-height:28px;${isCurrent?'background:var(--accent)08;border-left:2px solid var(--accent);':''};padding:2px 0"><span style="min-width:40px;font-size:9px;color:${isCurrent?'var(--accent)':'var(--text-muted)'};font-family:var(--mono);padding-top:4px">${hour}</span><div style="flex:1;border-bottom:1px solid var(--border);padding:2px 4px;font-size:9px">`;
    if(block)h+=`<span style="padding:1px 6px;background:var(--accent)20;border-radius:3px;color:var(--accent)">${esc(block.title)}</span>`;
    h+='</div></div>';
  });
  h+='<div style="margin-top:12px;font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">Today\'s Tasks ('+todayTasks.length+')</div>';
  todayTasks.forEach(t=>{
    const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'#3b82f6';
    h+=`<div onclick="document.getElementById('daily-plan-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid ${priColor};margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title||'Untitled')} <span style="font-size:8px;color:${priColor}">${(t.priority||'p2').toUpperCase()}</span></div>`;
  });
  if(!todayTasks.length)h+='<div style="font-size:9px;color:var(--text-muted);padding:4px 8px">No tasks due today</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Daily Planner</span><button onclick="document.getElementById('daily-plan-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function exportFullWorkspace(){
  const data={
    tasks:S.tasks,content:S.content,docs:S.docs,links:S.links,
    projects:S.projects,specs:S.specs,repos:S.repos,
    focusSessions:S.focusSessions,goals:S.goals,
    habits:S._habits,snippets:S._snippets,stickies:S._stickies,
    timeBlocks:S._timeBlocks,clips:S._clips,
    exportedAt:new Date().toISOString(),version:'astra-full-export-v1'
  };
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='astra-workspace-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();
  const sizeKB=(json.length/1024).toFixed(1);
  toast('Exported full workspace ('+sizeKB+'KB)');
}
function toggleQuickActions(){
  let bar=document.getElementById('quick-actions-bar');
  if(bar){bar.remove();return;}
  bar=document.createElement('div');bar.id='quick-actions-bar';
  bar.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:1400;display:flex;gap:6px;padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5)';
  const actions=[
    {label:'Task',icon:'+',fn:'addTask()'},
    {label:'Note',icon:'N',fn:'toggleQuickNote()'},
    {label:'Journal',icon:'J',fn:'openDailyJournal()'},
    {label:'Dashboard',icon:'D',fn:'showHomeDashboard()'},
    {label:'Habits',icon:'H',fn:'showHabitTracker()'},
    {label:'Timer',icon:'F',fn:'document.getElementById(\"focus-start\")?document.getElementById(\"focus-start\").click():toast(\"Open context panel first\")'},
    {label:'Cmd+K',icon:'K',fn:'openCommandPalette()'},
    {label:'Close',icon:'X',fn:'document.getElementById(\"quick-actions-bar\").remove()'},
  ];
  actions.forEach(a=>{
    bar.innerHTML+=`<button onclick="${a.fn}" style="padding:6px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:9px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;min-width:40px" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'"><span style="font-size:14px;font-weight:600;color:var(--accent)">${a.icon}</span><span>${a.label}</span></button>`;
  });
  document.body.appendChild(bar);
}
function showDueDateHeatmap(){
  let panel=document.getElementById('due-heat-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='due-heat-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const todayStr=now.toISOString().split('T')[0];
  const byDate={};
  S.tasks.filter(t=>t.due&&t.status!=='done').forEach(t=>{
    if(!byDate[t.due])byDate[t.due]=[];
    byDate[t.due].push(t);
  });
  let h='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;margin-bottom:4px">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div style="text-align:center;font-size:9px;color:var(--text-muted);padding:4px 0;font-weight:600">${d}</div>`;});
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px">';
  for(let i=0;i<firstDay;i++){h+='<div style="min-height:50px"></div>';}
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const tasks=byDate[ds]||[];
    const count=tasks.length;
    const isToday=ds===todayStr;
    const isPast=ds<todayStr;
    let bg='var(--bg-surface)';
    if(count>=4)bg='#ef444440';
    else if(count>=3)bg='#f9731640';
    else if(count>=2)bg='#f59e0b30';
    else if(count>=1)bg='#22c55e20';
    h+=`<div style="min-height:50px;padding:3px;border-radius:4px;background:${bg};${isToday?'border:1px solid var(--accent);':''}cursor:pointer" onclick="if(${count}>0){const t=S.tasks.filter(x=>x.due==='${ds}'&&x.status!=='done');if(t.length)openTaskDetail(t[0].id)}" title="${count} tasks due"><div style="font-size:9px;font-weight:600;color:${isToday?'var(--accent)':isPast?'var(--text-muted)':'var(--text-primary)'}">${d}</div>`;
    if(count){h+=`<div style="font-size:8px;font-weight:600;color:${count>=3?'#ef4444':count>=2?'#f59e0b':'var(--accent)'}">${count} task${count>1?'s':''}</div>`;}
    tasks.slice(0,2).forEach(t=>{
      const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-muted)';
      h+=`<div style="font-size:7px;color:${priColor};overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'').substring(0,15)}</div>`;
    });
    h+='</div>';
  }
  h+='</div>';
  const heaviestDay=Object.entries(byDate).sort((a,b)=>b[1].length-a[1].length)[0];
  const totalDue=Object.values(byDate).reduce((s,v)=>s+v.length,0);
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Due Date Heatmap - ${monthName}</span><button onclick="document.getElementById('due-heat-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;gap:12px;margin-bottom:8px;font-size:10px"><span style="color:var(--text-muted)">${totalDue} tasks due this month</span>${heaviestDay?`<span style="color:#ef4444">Peak: ${heaviestDay[0].substring(5)} (${heaviestDay[1].length})</span>`:''}</div><div style="display:flex;gap:4px;margin-bottom:8px;font-size:8px;color:var(--text-muted)"><span style="display:flex;align-items:center;gap:2px"><span style="width:10px;height:10px;border-radius:2px;background:#22c55e20"></span>1</span><span style="display:flex;align-items:center;gap:2px"><span style="width:10px;height:10px;border-radius:2px;background:#f59e0b30"></span>2</span><span style="display:flex;align-items:center;gap:2px"><span style="width:10px;height:10px;border-radius:2px;background:#f9731640"></span>3</span><span style="display:flex;align-items:center;gap:2px"><span style="width:10px;height:10px;border-radius:2px;background:#ef444440"></span>4+</span></div>${h}`;
  document.body.appendChild(panel);
}
function showWritingGoals(){
  let panel=document.getElementById('writing-goals-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writing-goals-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:75vh;overflow-y:auto';
  if(!S._writingGoals)S._writingGoals={daily:500,weekly:3000};
  const today=new Date().toISOString().split('T')[0];
  const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);const weekStr=weekAgo.toISOString().split('T')[0];
  let todayWords=0;let weekWords=0;
  S.content.forEach(c=>{
    if(!c.createdAt)return;
    const d=c.createdAt.split('T')[0];
    const w=(c.body||'').split(/\s+/).length;
    if(d===today)todayWords+=w;
    if(d>=weekStr)weekWords+=w;
  });
  (S.docs||[]).forEach(d=>{
    const dt=(d.updatedAt||d.createdAt||'').split('T')[0];
    const w=(d.body||'').split(/\s+/).length;
    if(dt===today)todayWords+=w;
    if(dt>=weekStr)weekWords+=w;
  });
  const dailyPct=Math.min(100,Math.round(todayWords/S._writingGoals.daily*100));
  const weeklyPct=Math.min(100,Math.round(weekWords/S._writingGoals.weekly*100));
  let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Daily Goal</div><div style="font-size:20px;font-weight:700;color:${dailyPct>=100?'#22c55e':'var(--accent)'}">${todayWords}</div><div style="font-size:9px;color:var(--text-muted)">/ ${S._writingGoals.daily} words</div><div style="width:100%;height:6px;background:var(--bg-elevated);border-radius:3px;margin-top:6px;overflow:hidden"><div style="width:${dailyPct}%;height:100%;background:${dailyPct>=100?'#22c55e':dailyPct>=50?'var(--accent)':'#f59e0b'};border-radius:3px;transition:width 0.3s"></div></div><div style="font-size:8px;color:var(--text-muted);margin-top:2px">${dailyPct}%</div></div>`;
  h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Weekly Goal</div><div style="font-size:20px;font-weight:700;color:${weeklyPct>=100?'#22c55e':'#3b82f6'}">${weekWords}</div><div style="font-size:9px;color:var(--text-muted)">/ ${S._writingGoals.weekly} words</div><div style="width:100%;height:6px;background:var(--bg-elevated);border-radius:3px;margin-top:6px;overflow:hidden"><div style="width:${weeklyPct}%;height:100%;background:${weeklyPct>=100?'#22c55e':weeklyPct>=50?'#3b82f6':'#f59e0b'};border-radius:3px;transition:width 0.3s"></div></div><div style="font-size:8px;color:var(--text-muted);margin-top:2px">${weeklyPct}%</div></div>`;
  h+='</div>';
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Set Goals</div>';
  h+=`<div style="display:flex;gap:8px;margin-bottom:12px"><div style="flex:1"><label style="font-size:9px;color:var(--text-muted)">Daily Words</label><input id="wg-daily" type="number" value="${S._writingGoals.daily}" style="width:100%;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;box-sizing:border-box"></div><div style="flex:1"><label style="font-size:9px;color:var(--text-muted)">Weekly Words</label><input id="wg-weekly" type="number" value="${S._writingGoals.weekly}" style="width:100%;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;box-sizing:border-box"></div><button onclick="S._writingGoals={daily:parseInt(document.getElementById('wg-daily').value)||500,weekly:parseInt(document.getElementById('wg-weekly').value)||3000};save();toast('Goals updated');showWritingGoals()" style="padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer;align-self:flex-end">Save</button></div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Writing Goals</span><button onclick="document.getElementById('writing-goals-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showProjectComparison(){
  let panel=document.getElementById('proj-compare-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  if(projects.length<2){panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Project Comparison</span><button onclick="document.getElementById('proj-compare-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">Need at least 2 projects to compare</div>`;document.body.appendChild(panel);return;}
  function getStats(proj){
    const tasks=S.tasks.filter(t=>t.project===proj);
    const done=tasks.filter(t=>t.status==='done').length;
    const active=tasks.filter(t=>t.status!=='done').length;
    const today=new Date().toISOString().split('T')[0];
    const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today).length;
    const content=S.content.filter(c=>c.theme===proj||c.project===proj).length;
    const docs=(S.docs||[]).filter(d=>d.project===proj).length;
    const links=(S.links||[]).filter(l=>l.project===proj).length;
    const totalWords=tasks.reduce((s,t)=>s+((t.description||'').split(/\s+/).length),0);
    const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);const weekStr=weekAgo.toISOString().split('T')[0];
    const velocity=tasks.filter(t=>t.completedAt&&t.completedAt.split('T')[0]>=weekStr).length;
    return{total:tasks.length,done,active,overdue,content,docs,links,velocity,pct:tasks.length?Math.round(done/tasks.length*100):0};
  }
  let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  projects.slice(0,2).forEach((proj,i)=>{
    const s=getStats(proj);
    const healthScore=Math.min(100,Math.max(0,s.pct-(s.overdue*10)+(s.velocity*5)));
    const healthColor=healthScore>=70?'#22c55e':healthScore>=40?'#f59e0b':'#ef4444';
    h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:12px;font-weight:600;color:var(--text-primary);margin-bottom:8px;border-bottom:2px solid ${i===0?'#3b82f6':'#8b5cf6'};padding-bottom:4px">${esc(proj)}</div>`;
    h+=`<div style="font-size:9px;display:grid;gap:4px">`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Tasks</span><span style="color:var(--text-primary)">${s.total}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Done</span><span style="color:#22c55e">${s.done} (${s.pct}%)</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Active</span><span style="color:#3b82f6">${s.active}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Overdue</span><span style="color:#ef4444">${s.overdue}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">7d Velocity</span><span style="color:var(--accent)">${s.velocity}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Content</span><span>${s.content}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Docs</span><span>${s.docs}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Links</span><span>${s.links}</span></div>`;
    h+=`<div style="margin-top:4px;display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Health</span><span style="color:${healthColor};font-weight:600">${healthScore}</span></div>`;
    h+=`</div></div>`;
  });
  h+='</div>';
  if(projects.length>2){h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:8px">Showing first 2 of ${projects.length} projects</div>`;}
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Project Comparison</span><button onclick="document.getElementById('proj-compare-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showTaskAging(){
  let panel=document.getElementById('task-aging-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-aging-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  const active=S.tasks.filter(t=>t.status!=='done').map(t=>{
    const created=t.createdAt?new Date(t.createdAt):now;
    const ageDays=Math.floor((now-created)/(1000*60*60*24));
    return{...t,ageDays};
  }).sort((a,b)=>b.ageDays-a.ageDays);
  const stale=active.filter(t=>t.ageDays>30);
  const aging=active.filter(t=>t.ageDays>14&&t.ageDays<=30);
  const fresh=active.filter(t=>t.ageDays<=14);
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#ef4444">${stale.length}</div><div style="font-size:8px;color:var(--text-muted)">Stale (30+ days)</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#f59e0b">${aging.length}</div><div style="font-size:8px;color:var(--text-muted)">Aging (14-30)</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#22c55e">${fresh.length}</div><div style="font-size:8px;color:var(--text-muted)">Fresh (<14)</div></div>`;
  h+='</div>';
  function renderGroup(tasks,label,color){
    if(!tasks.length)return'';
    let r=`<div style="font-size:10px;font-weight:600;color:${color};margin-bottom:4px">${label}</div>`;
    tasks.slice(0,12).forEach(t=>{
      r+=`<div onclick="document.getElementById('task-aging-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:3px 6px;cursor:pointer;border-left:2px solid ${color};margin:2px 0;font-size:10px" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="min-width:30px;font-size:8px;color:${color};font-weight:600">${t.ageDays}d</span><span style="flex:1;color:var(--text-primary)">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted)">${t.status}</span></div>`;
    });
    if(tasks.length>12)r+=`<div style="font-size:8px;color:var(--text-muted);padding:2px 6px">+${tasks.length-12} more</div>`;
    return r+'<div style="height:8px"></div>';
  }
  h+=renderGroup(stale,'Stale Tasks (30+ days old)','#ef4444');
  h+=renderGroup(aging,'Aging Tasks (14-30 days)','#f59e0b');
  h+=renderGroup(fresh,'Fresh Tasks (<14 days)','#22c55e');
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Aging Report</span><button onclick="document.getElementById('task-aging-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function importLinksFromMarkdown(){
  const text=prompt('Paste markdown with URLs (e.g. [title](url) or raw URLs):');
  if(!text)return;
  const linkRegex=/\[([^\]]+)\]\(([^)]+)\)/g;
  const urlRegex=/https?:\/\/[^\s<>"']+/g;
  const found=[];let m;
  while((m=linkRegex.exec(text))!==null){found.push({title:m[1],url:m[2]});}
  const rawUrls=text.match(urlRegex)||[];
  rawUrls.forEach(u=>{if(!found.some(f=>f.url===u))found.push({title:u.replace(/https?:\/\//,'').substring(0,40),url:u});});
  if(!found.length){toast('No URLs found in text');return;}
  const existing=new Set((S.links||[]).map(l=>l.url));
  let added=0;
  found.forEach(f=>{
    if(existing.has(f.url))return;
    S.links.unshift({id:Date.now()+added,title:f.title,url:f.url,category:'imported',createdAt:new Date().toISOString()});
    added++;
  });
  save();renderLinks();
  toast('Imported '+added+' links ('+(found.length-added)+' duplicates skipped)');
}
function showAmbientSounds(){
  let panel=document.getElementById('ambient-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ambient-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const sounds=[
    {name:'Rain',emoji:'R',desc:'Gentle rain for deep focus'},
    {name:'Coffee Shop',emoji:'C',desc:'Ambient cafe background'},
    {name:'Forest',emoji:'F',desc:'Birds and gentle wind'},
    {name:'Ocean',emoji:'O',desc:'Calm ocean waves'},
    {name:'White Noise',emoji:'W',desc:'Steady white noise'},
    {name:'Silent',emoji:'S',desc:'No ambient sound'},
  ];
  let h='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Select ambient sound for focus sessions. Uses Web Audio API tone generator.</div>';
  const current=S._ambientSound||'Silent';
  sounds.forEach(s=>{
    const isActive=current===s.name;
    h+=`<div onclick="setAmbientSound('${s.name}')" style="display:flex;align-items:center;gap:10px;padding:8px 10px;cursor:pointer;border-radius:6px;margin:2px 0;border:1px solid ${isActive?'var(--accent)':'transparent'};background:${isActive?'var(--accent)10':'transparent'}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='${isActive?'var(--accent)10':'transparent'}'"><span style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--bg-surface);border-radius:6px;font-size:14px;font-weight:600;color:var(--accent)">${s.emoji}</span><div style="flex:1"><div style="font-size:11px;font-weight:600;color:var(--text-primary)">${s.name}</div><div style="font-size:9px;color:var(--text-muted)">${s.desc}</div></div>${isActive?'<span style="font-size:10px;color:var(--accent);font-weight:600">Active</span>':''}</div>`;
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Ambient Sounds</span><button onclick="document.getElementById('ambient-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function setAmbientSound(name){
  S._ambientSound=name;save();
  if(window._ambientOsc){try{window._ambientOsc.stop();}catch(e){}window._ambientOsc=null;}
  if(name==='Silent'){toast('Ambient sound off');showAmbientSounds();return;}
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    gain.gain.value=0.02;
    const freqs={Rain:200,['Coffee Shop']:300,Forest:150,Ocean:100,['White Noise']:0};
    if(name==='White Noise'){
      const bufferSize=2*ctx.sampleRate;const buffer=ctx.createBuffer(1,bufferSize,ctx.sampleRate);
      const data=buffer.getChannelData(0);for(let i=0;i<bufferSize;i++)data[i]=Math.random()*2-1;
      const src=ctx.createBufferSource();src.buffer=buffer;src.loop=true;src.connect(gain);gain.connect(ctx.destination);src.start();
      window._ambientOsc=src;
    }else{
      osc.type='sine';osc.frequency.value=freqs[name]||200;
      osc.connect(gain);gain.connect(ctx.destination);osc.start();
      window._ambientOsc=osc;
    }
    toast('Playing: '+name);
  }catch(e){toast('Audio not available');}
  showAmbientSounds();
}
function showWordFrequency(){
  let panel=document.getElementById('word-freq-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='word-freq-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:75vh;overflow-y:auto';
  const stopWords=new Set(['the','a','an','and','or','but','in','on','at','to','for','of','with','by','from','is','it','as','was','are','be','has','had','have','this','that','these','those','not','no','so','if','then','than','can','will','would','could','should','do','does','did','just','more','some','any','all','each','every','both','few','many','most','other','such','only','very','also','into','over','after','before','between','under','about','up','out','its','he','she','they','we','you','my','your','his','her','our','their','i','me','us','them','what','which','who','when','where','how','why']);
  const wordCounts={};
  S.content.forEach(c=>{
    (c.body||'').toLowerCase().split(/\s+/).forEach(w=>{
      const clean=w.replace(/[^a-z0-9]/g,'');
      if(clean.length>2&&!stopWords.has(clean))wordCounts[clean]=(wordCounts[clean]||0)+1;
    });
  });
  (S.docs||[]).forEach(d=>{
    (d.body||'').toLowerCase().split(/\s+/).forEach(w=>{
      const clean=w.replace(/[^a-z0-9]/g,'');
      if(clean.length>2&&!stopWords.has(clean))wordCounts[clean]=(wordCounts[clean]||0)+1;
    });
  });
  const sorted=Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]).slice(0,50);
  const maxCount=sorted.length?sorted[0][1]:1;
  let h='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">';
  sorted.slice(0,30).forEach(([word,count])=>{
    const size=Math.round(8+count/maxCount*14);
    const opacity=0.5+count/maxCount*0.5;
    h+=`<span style="font-size:${size}px;color:var(--accent);opacity:${opacity};padding:2px 4px" title="${count} occurrences">${esc(word)}</span>`;
  });
  h+='</div>';
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Top 50 Words</div>';
  sorted.forEach(([word,count],i)=>{
    const pct=Math.round(count/maxCount*100);
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:9px"><span style="min-width:16px;color:var(--text-muted)">${i+1}.</span><span style="flex:1;color:var(--text-primary)">${esc(word)}</span><span style="color:var(--accent)">${count}</span><div style="width:60px;height:3px;background:var(--bg-surface);border-radius:1px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:1px"></div></div></div>`;
  });
  if(!sorted.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No content to analyze</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Word Frequency Analysis</span><button onclick="document.getElementById('word-freq-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showPriorityBoard(){
  let panel=document.getElementById('pri-board-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='pri-board-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  const priorities=[{key:'p0',label:'Critical',color:'#ef4444'},{key:'p1',label:'High',color:'#f97316'},{key:'p2',label:'Medium',color:'#3b82f6'},{key:'p3',label:'Low',color:'#6b7280'}];
  let h='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
  priorities.forEach(pri=>{
    const tasks=active.filter(t=>(t.priority||'p2')===pri.key);
    h+=`<div style="background:var(--bg-surface);border-radius:8px;padding:8px;border-top:3px solid ${pri.color}"><div style="font-size:10px;font-weight:600;color:${pri.color};margin-bottom:6px;text-align:center">${pri.label} (${tasks.length})</div>`;
    tasks.slice(0,12).forEach(t=>{
      const today=new Date().toISOString().split('T')[0];
      const overdue=t.due&&t.due<today;
      h+=`<div onclick="document.getElementById('pri-board-panel').remove();openTaskDetail(${t.id})" style="padding:4px 6px;margin:3px 0;background:var(--bg-elevated);border-radius:4px;cursor:pointer;border-left:2px solid ${t.status==='in-progress'?'#3b82f6':'var(--border)'}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='var(--bg-elevated)'"><div style="font-size:9px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="display:flex;gap:4px;font-size:7px;color:var(--text-muted);margin-top:2px">${t.status==='in-progress'?'<span style="color:#3b82f6">WIP</span>':''}${t.due?`<span style="color:${overdue?'#ef4444':'var(--text-muted)'}">${t.due.substring(5)}</span>`:''}</div></div>`;
    });
    if(tasks.length>12)h+=`<div style="font-size:8px;color:var(--text-muted);text-align:center;padding:4px">+${tasks.length-12} more</div>`;
    if(!tasks.length)h+='<div style="font-size:8px;color:var(--text-muted);text-align:center;padding:8px">No tasks</div>';
    h+='</div>';
  });
  h+='</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Priority Board (${active.length} active)</span><button onclick="document.getElementById('pri-board-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showWipConfig(){
  let panel=document.getElementById('wip-config-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='wip-config-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  if(!S._wipLimits)S._wipLimits={todo:0,'in-progress':5,done:0};
  const statuses=['todo','in-progress','done'];
  const statusLabels={todo:'To Do','in-progress':'In Progress',done:'Done'};
  const counts={};statuses.forEach(s=>{counts[s]=S.tasks.filter(t=>t.status===s).length;});
  let h='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Set WIP limits per column. 0 = unlimited. Board column turns red when over limit.</div>';
  statuses.forEach(s=>{
    const limit=S._wipLimits[s]||0;
    const count=counts[s];
    const over=limit>0&&count>limit;
    h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><span style="flex:1;font-size:11px;font-weight:600;color:var(--text-primary)">${statusLabels[s]}</span><span style="font-size:10px;color:${over?'#ef4444':'var(--text-muted)'}">${count} tasks</span><input type="number" min="0" value="${limit}" onchange="S._wipLimits['${s}']=parseInt(this.value)||0;save();showWipConfig()" style="width:50px;padding:4px 6px;background:var(--bg-surface);border:1px solid ${over?'#ef4444':'var(--border)'};border-radius:4px;color:var(--text-primary);font-size:11px;text-align:center">${over?'<span style="font-size:8px;color:#ef4444;font-weight:600">OVER</span>':''}</div>`;
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">WIP Limits</span><button onclick="document.getElementById('wip-config-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showDuplicateContent(){
  let panel=document.getElementById('dup-content-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='dup-content-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const items=S.content||[];
  const dupes=[];
  const checked=new Set();
  items.forEach((a,i)=>{
    if(checked.has(a.id)||!a.body)return;
    const aWords=a.body.toLowerCase().split(/\s+/).slice(0,20).join(' ');
    const matches=[];
    items.forEach((b,j)=>{
      if(j<=i||checked.has(b.id)||!b.body)return;
      const bWords=b.body.toLowerCase().split(/\s+/).slice(0,20).join(' ');
      if(aWords===bWords){matches.push(b);checked.add(b.id);}
      else{
        const aSet=new Set(aWords.split(' '));const bSet=new Set(bWords.split(' '));
        let overlap=0;aSet.forEach(w=>{if(bSet.has(w))overlap++;});
        const similarity=overlap/Math.max(aSet.size,bSet.size);
        if(similarity>0.7){matches.push({...b,similarity:Math.round(similarity*100)});checked.add(b.id);}
      }
    });
    if(matches.length){dupes.push({original:a,matches});}
  });
  let h=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">${dupes.length} duplicate groups found across ${items.length} content items</div>`;
  dupes.slice(0,15).forEach(group=>{
    h+=`<div style="padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:6px;border-left:2px solid #f59e0b"><div style="font-size:10px;color:var(--text-primary);margin-bottom:4px">${esc((group.original.body||'').substring(0,80))}</div><div style="font-size:8px;color:var(--text-muted);margin-bottom:4px">Original (ID: ${group.original.id})</div>`;
    group.matches.forEach(m=>{
      h+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 6px;margin:2px 0"><span style="flex:1;font-size:9px;color:var(--text-muted)">${esc((m.body||'').substring(0,60))} ${m.similarity?'('+m.similarity+'% match)':''}</span><button onclick="S.content=S.content.filter(c=>c.id!==${m.id});save();showDuplicateContent()" style="padding:2px 6px;background:#ef4444;border:none;border-radius:3px;color:#fff;font-size:7px;cursor:pointer">Remove</button></div>`;
    });
    h+='</div>';
  });
  if(!dupes.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No duplicates found!</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Duplicate Content Finder</span><button onclick="document.getElementById('dup-content-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function exportTasksCSV(){
  const rows=[['ID','Title','Status','Priority','Project','Due','Estimate','Created','Description']];
  S.tasks.forEach(t=>{
    rows.push([t.id,'"'+(t.title||'').replace(/"/g,'""')+'"',t.status||'todo',t.priority||'p2','"'+(t.project||'')+'"',t.due||'',t.estimate||'',t.createdAt||'','"'+(t.description||'').replace(/"/g,'""').substring(0,200)+'"']);
  });
  const csv=rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='astra-tasks-'+new Date().toISOString().split('T')[0]+'.csv';
  a.click();
  toast('Exported '+S.tasks.length+' tasks as CSV');
}
function showInbox(){
  let panel=document.getElementById('inbox-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='inbox-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const unsortedTasks=S.tasks.filter(t=>!t.project&&t.status!=='done');
  const unsortedContent=S.content.filter(c=>!c.theme&&!c.project);
  const unsortedLinks=(S.links||[]).filter(l=>!l.category||l.category==='Uncategorized');
  const unsortedDocs=(S.docs||[]).filter(d=>!d.project);
  const total=unsortedTasks.length+unsortedContent.length+unsortedLinks.length+unsortedDocs.length;
  let h='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#06b6d4">${unsortedTasks.length}</div><div style="font-size:7px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${unsortedContent.length}</div><div style="font-size:7px;color:var(--text-muted)">Content</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#8b5cf6">${unsortedLinks.length}</div><div style="font-size:7px;color:var(--text-muted)">Links</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${unsortedDocs.length}</div><div style="font-size:7px;color:var(--text-muted)">Docs</div></div>`;
  h+='</div>';
  if(unsortedTasks.length){
    h+='<div style="font-size:10px;font-weight:600;color:#06b6d4;margin-bottom:4px">Unsorted Tasks</div>';
    unsortedTasks.slice(0,10).forEach(t=>{
      h+=`<div onclick="document.getElementById('inbox-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #06b6d4;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title||'Untitled')}</div>`;
    });
    h+='<div style="height:8px"></div>';
  }
  if(unsortedContent.length){
    h+='<div style="font-size:10px;font-weight:600;color:#f59e0b;margin-bottom:4px">Unsorted Content</div>';
    unsortedContent.slice(0,10).forEach(c=>{
      h+=`<div onclick="document.getElementById('inbox-panel').remove();openContentModal(${c.id})" style="padding:3px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #f59e0b;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc((c.body||'').substring(0,60))}</div>`;
    });
    h+='<div style="height:8px"></div>';
  }
  if(unsortedLinks.length){
    h+='<div style="font-size:10px;font-weight:600;color:#8b5cf6;margin-bottom:4px">Uncategorized Links</div>';
    unsortedLinks.slice(0,10).forEach(l=>{
      h+=`<div onclick="window.open('${(l.url||'').replace(/'/g,"\\'")}','_blank')" style="padding:3px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #8b5cf6;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(l.title||l.url||'Untitled')}</div>`;
    });
  }
  if(!total)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">Inbox empty! Everything is categorized.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Inbox (${total} unsorted)</span><button onclick="document.getElementById('inbox-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
var _sessionStart=Date.now();
function showSessionTimer(){
  const elapsed=Date.now()-_sessionStart;
  const mins=Math.floor(elapsed/60000);
  const hrs=Math.floor(mins/60);
  const m=mins%60;
  toast('Session time: '+(hrs?hrs+'h ':'')+(m)+'m');
}
var _undoStack=[];
function pushUndo(type,data){_undoStack.push({type,data,ts:Date.now()});if(_undoStack.length>50)_undoStack.shift();}
function globalUndo(){
  if(!_undoStack.length){toast('Nothing to undo');return;}
  const action=_undoStack.pop();
  if(action.type==='deleteTask'){S.tasks.push(action.data);save();renderTasks();toast('Task restored: '+action.data.title);}
  else if(action.type==='deleteContent'){S.content.push(action.data);save();renderContent();toast('Content restored');}
  else if(action.type==='deleteLink'){S.links.push(action.data);save();renderLinks();toast('Link restored: '+action.data.title);}
  else if(action.type==='statusChange'){const t=S.tasks.find(x=>x.id===action.data.id);if(t){t.status=action.data.oldStatus;save();renderTasks();toast('Status reverted');}}
  else{toast('Undo: '+action.type);}
}
function showFavorites(){
  let panel=document.getElementById('favorites-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='favorites-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const starredContent=S.content.filter(c=>c.starred);
  const pinnedContent=S.content.filter(c=>c.pinned&&!c.starred);
  const pinnedLinks=(S.links||[]).filter(l=>l.pinned);
  const total=starredContent.length+pinnedContent.length+pinnedLinks.length;
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${starredContent.length}</div><div style="font-size:7px;color:var(--text-muted)">Starred</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${pinnedContent.length}</div><div style="font-size:7px;color:var(--text-muted)">Pinned Content</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#8b5cf6">${pinnedLinks.length}</div><div style="font-size:7px;color:var(--text-muted)">Pinned Links</div></div>`;
  h+='</div>';
  if(starredContent.length){
    h+='<div style="font-size:10px;font-weight:600;color:#f59e0b;margin-bottom:4px">Starred Content</div>';
    starredContent.forEach(c=>{
      h+=`<div onclick="document.getElementById('favorites-panel').remove();openContentModal(${c.id})" style="padding:4px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #f59e0b;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc((c.body||'').substring(0,70))}<span style="font-size:8px;color:var(--text-muted)"> ${c.type||''}</span></div>`;
    });
    h+='<div style="height:8px"></div>';
  }
  if(pinnedContent.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--accent);margin-bottom:4px">Pinned Content</div>';
    pinnedContent.slice(0,10).forEach(c=>{
      h+=`<div onclick="document.getElementById('favorites-panel').remove();openContentModal(${c.id})" style="padding:4px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid var(--accent);margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc((c.body||'').substring(0,70))}</div>`;
    });
    h+='<div style="height:8px"></div>';
  }
  if(pinnedLinks.length){
    h+='<div style="font-size:10px;font-weight:600;color:#8b5cf6;margin-bottom:4px">Pinned Links</div>';
    pinnedLinks.forEach(l=>{
      h+=`<div onclick="window.open('${(l.url||'').replace(/'/g,"\\'")}','_blank')" style="padding:4px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #8b5cf6;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(l.title||l.url)}</div>`;
    });
  }
  if(!total)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No favorites yet. Star or pin items to see them here.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Favorites (${total} items)</span><button onclick="document.getElementById('favorites-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showTasksByDueGroup(){
  let panel=document.getElementById('due-group-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='due-group-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);const tmrStr=tomorrow.toISOString().split('T')[0];
  const weekEnd=new Date();weekEnd.setDate(weekEnd.getDate()+7);const weekStr=weekEnd.toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const overdue=active.filter(t=>t.due&&t.due<today);
  const todayTasks=active.filter(t=>t.due===today);
  const tomorrowTasks=active.filter(t=>t.due===tmrStr);
  const thisWeek=active.filter(t=>t.due&&t.due>tmrStr&&t.due<=weekStr);
  const later=active.filter(t=>t.due&&t.due>weekStr);
  const noDate=active.filter(t=>!t.due);
  function renderGroup(tasks,label,color){
    if(!tasks.length)return'';
    let h=`<div style="font-size:10px;font-weight:600;color:${color};margin-bottom:4px;padding-top:8px">${label} (${tasks.length})</div>`;
    tasks.forEach(t=>{
      const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-muted)';
      h+=`<div onclick="document.getElementById('due-group-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:3px 8px;cursor:pointer;border-left:2px solid ${color};margin:2px 0;font-size:10px" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="flex:1;color:var(--text-primary)">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${priColor}">${(t.priority||'p2').toUpperCase()}</span>${t.due?`<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${t.due.substring(5)}</span>`:''}</div>`;
    });
    return h;
  }
  let h=renderGroup(overdue,'Overdue','#ef4444');
  h+=renderGroup(todayTasks,'Today','var(--accent)');
  h+=renderGroup(tomorrowTasks,'Tomorrow','#3b82f6');
  h+=renderGroup(thisWeek,'This Week','#8b5cf6');
  h+=renderGroup(later,'Later','#6b7280');
  h+=renderGroup(noDate,'No Due Date','var(--text-muted)');
  if(!active.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No active tasks</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Tasks by Due Date (${active.length})</span><button onclick="document.getElementById('due-group-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function quickConvertContentToTask(contentId){
  const c=S.content.find(x=>x.id===contentId);if(!c)return;
  const id=Date.now();
  S.tasks.unshift({id,title:(c.body||'').substring(0,80),description:c.body||'',status:'todo',priority:'p2',createdAt:new Date().toISOString(),project:c.theme||''});
  save();renderTasks();toast('Content converted to task');
}
function quickConvertTaskToContent(taskId){
  const t=S.tasks.find(x=>x.id===taskId);if(!t)return;
  const id=Date.now();
  S.content.unshift({id,body:(t.title||'')+(t.description?'\n\n'+t.description:''),type:'thought',theme:t.project||'',tags:['from-task'],createdAt:new Date().toISOString()});
  save();renderContent();toast('Task converted to content');
}
function toggleDeepFocus(){
  let overlay=document.getElementById('deep-focus-overlay');
  if(overlay){overlay.remove();document.body.style.overflow='';toast('Deep focus off');return;}
  overlay=document.createElement('div');overlay.id='deep-focus-overlay';
  overlay.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;background:rgba(0,0,0,0.85);pointer-events:none';
  overlay.innerHTML=`<div style="position:absolute;top:10px;right:10px;pointer-events:auto;padding:4px 10px;background:var(--accent);border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer" onclick="document.getElementById('deep-focus-overlay').remove();document.body.style.overflow='';toast('Deep focus off')">Exit Focus</div>`;
  document.body.appendChild(overlay);
  const primary=document.getElementById('primary-panel');
  if(primary)primary.style.position='relative';
  toast('Deep focus ON - overlay dimming enabled');
}
function showEstimationReport(){
  let panel=document.getElementById('est-report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='est-report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const withEst=S.tasks.filter(t=>t.estimate&&t.timeSpent);
  const withEstOnly=S.tasks.filter(t=>t.estimate);
  function parseMinutes(est){
    if(!est)return 0;
    const h=est.match(/(\d+)h/);const m=est.match(/(\d+)m/);
    return(h?parseInt(h[1])*60:0)+(m?parseInt(m[1]):0)||(parseInt(est)||0);
  }
  let totalEstMin=0;let totalActMin=0;
  withEst.forEach(t=>{totalEstMin+=parseMinutes(t.estimate);totalActMin+=(t.timeSpent||0);});
  const accuracy=totalEstMin?Math.round(totalActMin/totalEstMin*100):0;
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${withEstOnly.length}</div><div style="font-size:8px;color:var(--text-muted)">With Estimates</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#3b82f6">${withEst.length}</div><div style="font-size:8px;color:var(--text-muted)">With Both</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:${accuracy>120?'#ef4444':accuracy>=80?'#22c55e':'#f59e0b'}">${accuracy}%</div><div style="font-size:8px;color:var(--text-muted)">Accuracy</div></div>`;
  h+='</div>';
  if(withEst.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Tasks with Both Estimate + Actual</div>';
    withEst.forEach(t=>{
      const estMin=parseMinutes(t.estimate);
      const ratio=estMin?Math.round((t.timeSpent||0)/estMin*100):0;
      const color=ratio>150?'#ef4444':ratio>=80?'#22c55e':'#f59e0b';
      h+=`<div onclick="document.getElementById('est-report-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:4px 8px;cursor:pointer;border-left:2px solid ${color};margin:2px 0;font-size:10px" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="flex:1;color:var(--text-primary)">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted)">Est: ${t.estimate}</span><span style="font-size:8px;color:var(--text-muted)">Act: ${t.timeSpent}m</span><span style="font-size:8px;font-weight:600;color:${color}">${ratio}%</span></div>`;
    });
  }
  if(!withEst.length&&!withEstOnly.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No tasks with estimates yet. Add estimates in task detail.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Estimation Report</span><button onclick="document.getElementById('est-report-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showDataTools(){
  let panel=document.getElementById('data-tools-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='data-tools-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const sections=[
    {key:'tasks',label:'Tasks',count:S.tasks.length},
    {key:'content',label:'Content',count:S.content.length},
    {key:'docs',label:'Writer Docs',count:(S.docs||[]).length},
    {key:'links',label:'Links',count:(S.links||[]).length},
    {key:'focusSessions',label:'Focus Sessions',count:(S.focusSessions||[]).length},
    {key:'_habits',label:'Habits',count:(S._habits||[]).length},
    {key:'_snippets',label:'Snippets',count:(S._snippets||[]).length},
    {key:'_stickies',label:'Sticky Notes',count:(S._stickies||[]).length},
    {key:'_timeBlocks',label:'Time Blocks',count:(S._timeBlocks||[]).length},
    {key:'_clips',label:'Clipboard History',count:(S._clips||[]).length},
  ];
  const totalSize=(JSON.stringify(S).length/1024).toFixed(1);
  let h=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Total storage: ${totalSize}KB. Clear individual sections below.</div>`;
  sections.forEach(s=>{
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)"><span style="flex:1;font-size:10px;color:var(--text-primary)">${s.label}</span><span style="font-size:10px;color:var(--accent)">${s.count}</span><button onclick="if(confirm('Clear all ${s.label.toLowerCase()}? This cannot be undone.')){S.${s.key}=[];save();showDataTools();toast('${s.label} cleared')}" style="padding:2px 8px;background:#ef4444;border:none;border-radius:3px;color:#fff;font-size:8px;cursor:pointer">Clear</button></div>`;
  });
  h+=`<div style="margin-top:12px"><button onclick="if(confirm('Reset ALL data? This will clear everything!')){localStorage.removeItem('astra-state');location.reload()}" style="padding:6px 12px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;font-weight:600;cursor:pointer;width:100%">Factory Reset</button></div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Data Management</span><button onclick="document.getElementById('data-tools-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showThemeSwitcher(){
  let panel=document.getElementById('theme-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='theme-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const themes=[
    {name:'Cosmic (Default)',bg:'#050508',surface:'#0a0a0f',elevated:'#0f0f17',accent:'#4ade80',border:'#1a1a2e'},
    {name:'Ocean Depths',bg:'#030a12',surface:'#061420',elevated:'#0a1e2e',accent:'#06b6d4',border:'#0e2940'},
    {name:'Forest Night',bg:'#050a05',surface:'#0a140a',elevated:'#0f1e0f',accent:'#22c55e',border:'#1a2e1a'},
    {name:'Sunset',bg:'#0a0505',surface:'#140a08',elevated:'#1e0f0c',accent:'#f97316',border:'#2e1a14'},
    {name:'Royal Purple',bg:'#080510',surface:'#0e0a18',elevated:'#140f22',accent:'#a855f7',border:'#221a36'},
    {name:'Ember',bg:'#0a0404',surface:'#140808',elevated:'#1e0c0c',accent:'#ef4444',border:'#2e1414'},
  ];
  const current=S._theme||'Cosmic (Default)';
  let h='';
  themes.forEach(t=>{
    const isActive=current===t.name;
    h+=`<div onclick="applyTheme('${t.name}','${t.bg}','${t.surface}','${t.elevated}','${t.accent}','${t.border}')" style="display:flex;align-items:center;gap:10px;padding:10px;cursor:pointer;border-radius:6px;margin:2px 0;border:1px solid ${isActive?t.accent:'transparent'}" onmouseenter="this.style.background='${t.surface}'" onmouseleave="this.style.background='transparent'"><div style="display:flex;gap:2px"><span style="width:12px;height:12px;border-radius:3px;background:${t.bg}"></span><span style="width:12px;height:12px;border-radius:3px;background:${t.surface}"></span><span style="width:12px;height:12px;border-radius:3px;background:${t.accent}"></span></div><div style="flex:1"><div style="font-size:11px;font-weight:600;color:var(--text-primary)">${t.name}</div></div>${isActive?'<span style="font-size:10px;color:var(--accent);font-weight:600">Active</span>':''}</div>`;
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Theme Switcher</span><button onclick="document.getElementById('theme-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function applyTheme(name,bg,surface,elevated,accent,border){
  document.documentElement.style.setProperty('--bg-base',bg);
  document.documentElement.style.setProperty('--bg-surface',surface);
  document.documentElement.style.setProperty('--bg-elevated',elevated);
  document.documentElement.style.setProperty('--accent',accent);
  document.documentElement.style.setProperty('--border',border);
  S._theme=name;save();toast('Theme: '+name);showThemeSwitcher();
}
function generateStatusEmail(){
  const today=new Date().toISOString().split('T')[0];
  const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);const weekStr=weekAgo.toISOString().split('T')[0];
  const completed=S.tasks.filter(t=>t.completedAt&&t.completedAt.split('T')[0]>=weekStr);
  const inProgress=S.tasks.filter(t=>t.status==='in-progress');
  const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
  const upNext=S.tasks.filter(t=>t.status==='todo'&&t.due&&t.due>=today&&t.due<=new Date(Date.now()+7*86400000).toISOString().split('T')[0]).sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  let email='Subject: Status Update - '+today+'\n\n';
  email+='Hi,\n\nHere is my weekly status update.\n\n';
  email+='COMPLETED ('+completed.length+'):\n';
  completed.forEach(t=>{email+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});
  email+='\nIN PROGRESS ('+inProgress.length+'):\n';
  inProgress.forEach(t=>{email+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});
  if(overdue.length){email+='\nBLOCKERS/OVERDUE ('+overdue.length+'):\n';overdue.forEach(t=>{email+='- '+t.title+' (due '+t.due+')\n';});}
  email+='\nUP NEXT:\n';
  upNext.slice(0,5).forEach(t=>{email+='- '+t.title+' (due '+t.due+')\n';});
  email+='\nBest regards';
  navigator.clipboard.writeText(email);
  toast('Status email copied to clipboard');
}
function showMorningBriefing(){
  let panel=document.getElementById('morning-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='morning-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:85vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const todayLabel=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  const hour=new Date().getHours();
  const greeting=hour<12?'Good morning':hour<17?'Good afternoon':'Good evening';
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
  const inProgress=S.tasks.filter(t=>t.status==='in-progress');
  const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);const yStr=yesterday.toISOString().split('T')[0];
  const doneYesterday=S.tasks.filter(t=>t.completedAt&&t.completedAt.split('T')[0]===yStr);
  const focusToday=(S.focusSessions||[]).filter(f=>f.date===today);
  const focusMin=focusToday.reduce((s,x)=>s+(x.duration||0),0);
  const todayContent=S.content.filter(c=>c.createdAt&&c.createdAt.split('T')[0]===today);
  const todayWords=todayContent.reduce((s,c)=>s+((c.body||'').split(/\s+/).length),0);
  let h=`<div style="font-size:12px;color:var(--accent);margin-bottom:4px;font-weight:600">${greeting}!</div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:16px">${todayLabel}</div>`;
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:14px;font-weight:700;color:var(--accent)">${todayTasks.length}</div><div style="font-size:7px;color:var(--text-muted)">Due Today</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:14px;font-weight:700;color:#ef4444">${overdue.length}</div><div style="font-size:7px;color:var(--text-muted)">Overdue</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:14px;font-weight:700;color:#3b82f6">${inProgress.length}</div><div style="font-size:7px;color:var(--text-muted)">In Progress</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:14px;font-weight:700;color:#22c55e">${doneYesterday.length}</div><div style="font-size:7px;color:var(--text-muted)">Done Y-day</div></div>`;
  h+='</div>';
  if(overdue.length){
    h+='<div style="font-size:10px;font-weight:600;color:#ef4444;margin-bottom:4px">Overdue Tasks</div>';
    overdue.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('morning-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid #ef4444;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title)} <span style="color:#ef4444">${t.due}</span></div>`;});
    h+='<div style="height:8px"></div>';
  }
  if(todayTasks.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--accent);margin-bottom:4px">Today\'s Tasks</div>';
    todayTasks.forEach(t=>{const pc=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-muted)';h+=`<div onclick="document.getElementById('morning-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid ${pc};margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title)} <span style="color:${pc};font-size:8px">${(t.priority||'p2').toUpperCase()}</span></div>`;});
    h+='<div style="height:8px"></div>';
  }
  if(inProgress.length){
    h+='<div style="font-size:10px;font-weight:600;color:#3b82f6;margin-bottom:4px">In Progress</div>';
    inProgress.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('morning-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid #3b82f6;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title)}</div>`;});
  }
  h+=`<div style="margin-top:8px;display:flex;gap:8px;font-size:9px;color:var(--text-muted)"><span>Focus today: ${focusMin}m</span><span>Words today: ${todayWords}</span><span>Content: ${todayContent.length} items</span></div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Morning Briefing</span><button onclick="document.getElementById('morning-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showShortcutCheatsheet(){
  let panel=document.getElementById('shortcut-cheat-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='shortcut-cheat-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const groups=[
    {name:'Navigation',shortcuts:[
      ['Cmd+K','Command Palette'],['Cmd+1-9','Switch to section 1-9'],
      ['Cmd+B / Cmd+E','Toggle sidebar'],['Cmd+\\\\','Toggle context panel'],
    ]},
    {name:'Tasks',shortcuts:[
      ['Cmd+Shift+T','New task from anywhere'],['Cmd+Shift+N','New task'],
      ['Cmd+Shift+D','Today view'],
    ]},
    {name:'Writer',shortcuts:[
      ['Cmd+Shift+W','Open Zen Writer'],['Cmd+S','Save all'],
      ['Cmd+Shift+F','Toggle focus mode'],
    ]},
    {name:'Quick Actions',shortcuts:[
      ['Cmd+Shift+E','Export current section'],
      ['Type "task: title"','Quick-create task in Cmd+K'],
      ['Type "note: text"','Quick-save note in Cmd+K'],
    ]},
  ];
  let h='';
  groups.forEach(g=>{
    h+=`<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--accent);margin-bottom:4px">${g.name}</div>`;
    g.shortcuts.forEach(([key,desc])=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:3px 0;font-size:10px"><kbd style="padding:2px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;font-family:var(--mono);font-size:9px;color:var(--accent);min-width:100px;text-align:center">${key}</kbd><span style="color:var(--text-primary)">${desc}</span></div>`;
    });
    h+='</div>';
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Keyboard Shortcuts</span><button onclick="document.getElementById('shortcut-cheat-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showStreakTracker(){
  const now=new Date();const today=now.toISOString().split('T')[0];
  if(!S._streakData)S._streakData={lastActive:'',currentStreak:0,longestStreak:0,history:[]};
  const sd=S._streakData;
  if(sd.lastActive!==today){
    const yesterday=new Date(now);yesterday.setDate(yesterday.getDate()-1);
    const yStr=yesterday.toISOString().split('T')[0];
    if(sd.lastActive===yStr){sd.currentStreak++;} else if(sd.lastActive&&sd.lastActive!==today){sd.currentStreak=1;} else if(!sd.lastActive){sd.currentStreak=1;}
    sd.lastActive=today;if(sd.currentStreak>sd.longestStreak)sd.longestStreak=sd.currentStreak;
    if(!sd.history.includes(today))sd.history.push(today);
    if(sd.history.length>365)sd.history=sd.history.slice(-365);
    save();
  }
  const tasks=S.tasks||[];const content=S.content||[];
  const todayTasks=tasks.filter(t=>t.created&&t.created.startsWith(today)).length;
  const todayContent=content.filter(c=>c.created&&c.created.startsWith(today)).length;
  const totalDays=sd.history.length;
  const panel=document.createElement('div');panel.id='streak-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Streak Tracker</span><button onclick="document.getElementById('streak-tracker-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:var(--accent)">${sd.currentStreak}</div><div style="font-size:10px;color:var(--text-muted)">Current Streak</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:#f59e0b">${sd.longestStreak}</div><div style="font-size:10px;color:var(--text-muted)">Longest Streak</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:#8b5cf6">${totalDays}</div><div style="font-size:10px;color:var(--text-muted)">Total Active Days</div></div>`;
  h+=`</div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Today's Activity</div>`;
  h+=`<div style="display:flex;gap:16px"><span style="font-size:12px;color:var(--text-secondary)">Tasks created: <span style="color:var(--accent)">${todayTasks}</span></span>`;
  h+=`<span style="font-size:12px;color:var(--text-secondary)">Content added: <span style="color:var(--accent)">${todayContent}</span></span></div></div>`;
  const last30=[];for(let i=29;i>=0;i--){const d=new Date(now);d.setDate(d.getDate()-i);last30.push(d.toISOString().split('T')[0]);}
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Last 30 Days</div>`;
  h+=`<div style="display:flex;flex-wrap:wrap;gap:3px">`;
  last30.forEach(day=>{
    const active=sd.history.includes(day);
    h+=`<div title="${day}" style="width:14px;height:14px;border-radius:2px;background:${active?'var(--accent)':'var(--bg-base)'};opacity:${active?1:0.3}"></div>`;
  });
  h+=`</div></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentTemplates(){
  const templates=[
    {name:'Meeting Notes',body:'## Meeting: [Topic]\\n\\n**Date:** '+new Date().toLocaleDateString()+'\\n**Attendees:** \\n\\n### Agenda\\n1. \\n\\n### Discussion\\n\\n### Action Items\\n- [ ] \\n\\n### Next Steps\\n',theme:'meeting'},
    {name:'Project Brief',body:'## Project: [Name]\\n\\n**Objective:** \\n**Timeline:** \\n**Owner:** \\n\\n### Background\\n\\n### Requirements\\n1. \\n\\n### Success Criteria\\n- \\n\\n### Risks\\n- ',theme:'project'},
    {name:'Weekly Review',body:'## Week of '+new Date().toLocaleDateString()+'\\n\\n### Completed\\n- \\n\\n### In Progress\\n- \\n\\n### Blockers\\n- \\n\\n### Next Week Goals\\n1. \\n\\n### Reflection\\n',theme:'review'},
    {name:'Research Note',body:'## Research: [Topic]\\n\\n**Source:** \\n**Date:** '+new Date().toLocaleDateString()+'\\n\\n### Key Findings\\n1. \\n\\n### Quotes\\n> \\n\\n### My Analysis\\n\\n### Follow-up Questions\\n- ',theme:'research'},
    {name:'Decision Log',body:'## Decision: [Title]\\n\\n**Date:** '+new Date().toLocaleDateString()+'\\n**Status:** Decided / Pending\\n\\n### Context\\n\\n### Options Considered\\n1. **Option A:** \\n2. **Option B:** \\n\\n### Decision\\n\\n### Rationale\\n\\n### Impact\\n',theme:'decision'},
    {name:'Daily Journal',body:'## '+new Date().toLocaleDateString()+'\\n\\n### Gratitude\\n- \\n\\n### Top 3 Priorities\\n1. \\n2. \\n3. \\n\\n### Notes\\n\\n### End of Day Review\\n- What went well: \\n- What to improve: ',theme:'journal'},
  ];
  const panel=document.createElement('div');panel.id='content-templates-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Templates</span><button onclick="document.getElementById('content-templates-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:8px">`;
  templates.forEach((t,i)=>{
    h+=`<div onclick="applyContentTemplate(${i})" style="background:var(--bg-surface);padding:12px;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">`;
    h+=`<div style="font-size:12px;font-weight:600;color:var(--text-primary)">${t.name}</div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:4px">${t.body.replace(/\\n/g,' ').substring(0,80)}...</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  window._contentTemplates=templates;
}
function applyContentTemplate(idx){
  const templates=window._contentTemplates;if(!templates||!templates[idx])return;
  const t=templates[idx];
  const id='c_'+Date.now();
  const item={id,body:t.body.replace(/\\n/g,'\n'),theme:t.theme,tags:[t.theme,'template'],created:new Date().toISOString(),pinned:false,starred:false};
  if(!S.content)S.content=[];S.content.unshift(item);save();
  const p=document.getElementById('content-templates-panel');if(p)p.remove();
  switchSection('content');renderContent();
  showToast('Created from template: '+t.name);
}
function showBulkLinkChecker(){
  const links=S.links||[];
  if(!links.length){showToast('No links to check');return;}
  const panel=document.createElement('div');panel.id='link-checker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Link Health Checker</span><button onclick="document.getElementById('link-checker-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Checking ${links.length} links... (CORS may affect results)</div>`;
  h+=`<div id="link-check-results" style="display:grid;gap:6px">`;
  links.forEach(l=>{
    h+=`<div id="lc-${l.id}" style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<div style="width:10px;height:10px;border-radius:50%;background:#888;flex-shrink:0" id="lc-dot-${l.id}"></div>`;
    h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(l.title||l.url)}</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(l.url)}</div></div>`;
    h+=`<span style="font-size:9px;color:var(--text-muted)" id="lc-status-${l.id}">checking...</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  let ok=0,fail=0,unknown=0;
  links.forEach((l,i)=>{
    setTimeout(()=>{
      fetch(l.url,{method:'HEAD',mode:'no-cors',signal:AbortSignal.timeout(5000)}).then(()=>{
        const dot=document.getElementById('lc-dot-'+l.id);const st=document.getElementById('lc-status-'+l.id);
        if(dot)dot.style.background='#4ade80';if(st){st.textContent='reachable';st.style.color='#4ade80';}
        ok++;
      }).catch(()=>{
        const dot=document.getElementById('lc-dot-'+l.id);const st=document.getElementById('lc-status-'+l.id);
        if(dot)dot.style.background='#888';if(st){st.textContent='unknown';st.style.color='#888';}
        unknown++;
      });
    },i*200);
  });
}
function showReadingProgress(){
  const content=S.content||[];
  const statuses={unread:0,reading:0,done:0};
  content.forEach(c=>{const s=c._readStatus||'unread';statuses[s]=(statuses[s]||0)+1;});
  const total=content.length||1;
  const panel=document.createElement('div');panel.id='reading-progress-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Reading Progress</span><button onclick="document.getElementById('reading-progress-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#f59e0b">${statuses.unread}</div><div style="font-size:10px;color:var(--text-muted)">Unread</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#3b82f6">${statuses.reading}</div><div style="font-size:10px;color:var(--text-muted)">Reading</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--accent)">${statuses.done}</div><div style="font-size:10px;color:var(--text-muted)">Done</div></div>`;
  h+=`</div>`;
  const pctDone=Math.round((statuses.done/total)*100);
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:12px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">${pctDone}% completed</div>`;
  h+=`<div style="height:8px;background:var(--bg-base);border-radius:4px;overflow:hidden"><div style="height:100%;width:${pctDone}%;background:var(--accent);border-radius:4px;transition:width 0.3s"></div></div></div>`;
  const unread=content.filter(c=>!c._readStatus||c._readStatus==='unread').slice(0,10);
  if(unread.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Unread Items (${statuses.unread})</div>`;
    h+=`<div style="display:grid;gap:4px">`;
    unread.forEach(c=>{
      const preview=(c.body||'').substring(0,60);
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview||'(empty)')}</div></div>`;
      h+=`<button onclick="setReadStatus('${c.id}','reading')" style="font-size:9px;padding:2px 6px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:#3b82f6;cursor:pointer">Reading</button>`;
      h+=`<button onclick="setReadStatus('${c.id}','done')" style="font-size:9px;padding:2px 6px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer">Done</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function setReadStatus(id,status){
  const c=(S.content||[]).find(x=>x.id===id);if(!c)return;
  c._readStatus=status;save();
  const p=document.getElementById('reading-progress-panel');if(p)p.remove();
  showReadingProgress();
}
function showProjectTimeline(){
  const projects=S.projects||[];const tasks=S.tasks||[];
  const panel=document.createElement('div');panel.id='project-timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Project Timeline</span><button onclick="document.getElementById('project-timeline-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316'];
  projects.forEach((p,pi)=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    if(!pTasks.length)return;
    const dates=pTasks.filter(t=>t.due).map(t=>new Date(t.due).getTime()).filter(d=>!isNaN(d));
    const created=pTasks.filter(t=>t.created).map(t=>new Date(t.created).getTime()).filter(d=>!isNaN(d));
    const allDates=[...dates,...created].filter(d=>d>0);
    if(!allDates.length)return;
    const minD=Math.min(...allDates);const maxD=Math.max(...allDates);
    const rangeD=maxD-minD||86400000;
    const color=colors[pi%colors.length];
    const done=pTasks.filter(t=>t.status==='done').length;
    const pct=Math.round((done/pTasks.length)*100);
    h+=`<div style="margin-bottom:16px;background:var(--bg-surface);padding:12px;border-radius:8px;border-left:3px solid ${color}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">`;
    h+=`<span style="font-size:12px;font-weight:600;color:${color}">${esc(p.name)}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${done}/${pTasks.length} done (${pct}%)</span></div>`;
    h+=`<div style="position:relative;height:20px;background:var(--bg-base);border-radius:4px;overflow:hidden;margin-bottom:6px">`;
    pTasks.forEach(t=>{
      const d=t.due?new Date(t.due).getTime():(t.created?new Date(t.created).getTime():0);
      if(!d)return;
      const pos=Math.round(((d-minD)/rangeD)*100);
      const isDone=t.status==='done';
      h+=`<div title="${esc(t.title)}" style="position:absolute;left:${pos}%;top:3px;width:14px;height:14px;border-radius:50%;background:${isDone?color:'transparent'};border:2px solid ${color};transform:translateX(-50%);cursor:pointer;opacity:${isDone?1:0.6}"></div>`;
    });
    h+=`</div>`;
    h+=`<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted)"><span>${new Date(minD).toLocaleDateString()}</span><span>${new Date(maxD).toLocaleDateString()}</span></div>`;
    h+=`</div>`;
  });
  if(!h.includes('border-left'))h+=`<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:20px">No projects with dated tasks found</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function quickMath(expr){
  try{
    const sanitized=expr.replace(/[^0-9+\-*/.()% ]/g,'');
    if(!sanitized.trim())return null;
    const result=new Function('return '+sanitized)();
    if(typeof result==='number'&&isFinite(result))return result;
    return null;
  }catch(e){return null;}
}
function showFocusScore(){
  const now=new Date();const today=now.toISOString().split('T')[0];
  const tasks=S.tasks||[];const content=S.content||[];
  const todayDone=tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(today)).length;
  const todayCreated=content.filter(c=>c.created&&c.created.startsWith(today)).length;
  const focusSessions=(S._focusSessions||[]).filter(f=>f.date&&f.date.startsWith(today));
  const focusMins=focusSessions.reduce((a,f)=>a+(f.duration||0),0);
  const todayWords=content.filter(c=>c.created&&c.created.startsWith(today)).reduce((a,c)=>a+((c.body||'').split(/\s+/).filter(w=>w).length),0);
  let score=0;
  score+=Math.min(todayDone*15,45);
  score+=Math.min(todayCreated*10,30);
  score+=Math.min(Math.floor(focusMins/5),25);
  score+=Math.min(Math.floor(todayWords/100)*5,20);
  score=Math.min(score,100);
  const grade=score>=90?'A+':score>=80?'A':score>=70?'B':score>=60?'C':score>=40?'D':'F';
  const gradeColor=score>=80?'#4ade80':score>=60?'#f59e0b':'#ef4444';
  const panel=document.createElement('div');panel.id='focus-score-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:24px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Daily Focus Score</span><button onclick="document.getElementById('focus-score-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="text-align:center;margin-bottom:20px"><div style="font-size:64px;font-weight:800;color:${gradeColor}">${score}</div><div style="font-size:20px;font-weight:700;color:${gradeColor};margin-top:-8px">Grade: ${grade}</div></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${todayDone}</div><div style="font-size:9px;color:var(--text-muted)">Tasks Done (+15ea, max 45)</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#3b82f6">${todayCreated}</div><div style="font-size:9px;color:var(--text-muted)">Content Created (+10ea, max 30)</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">${focusMins}m</div><div style="font-size:9px;color:var(--text-muted)">Focus Time (+5/5min, max 25)</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#8b5cf6">${todayWords}</div><div style="font-size:9px;color:var(--text-muted)">Words Written (+5/100w, max 20)</div></div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showArchiveBrowser(){
  const archived=S._archivedTasks||[];
  const panel=document.createElement('div');panel.id='archive-browser-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Archive Browser (${archived.length} tasks)</span><button onclick="document.getElementById('archive-browser-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!archived.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No archived tasks. Use "Archive Done" in the task toolbar to archive completed tasks.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    archived.slice(0,50).forEach(t=>{
      const date=t.created?new Date(t.created).toLocaleDateString():'';
      const pColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;border-left:3px solid ${pColor}">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.title)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${t.priority||'p3'} | ${date}</div></div>`;
      h+=`<button onclick="restoreArchivedTask('${t.id}')" style="font-size:9px;padding:3px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer">Restore</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function restoreArchivedTask(id){
  const archived=S._archivedTasks||[];const idx=archived.findIndex(t=>t.id===id);
  if(idx===-1)return;
  const task=archived.splice(idx,1)[0];task.status='todo';
  if(!S.tasks)S.tasks=[];S.tasks.unshift(task);save();
  const p=document.getElementById('archive-browser-panel');if(p)p.remove();
  showArchiveBrowser();showToast('Task restored: '+task.title);
}
function showContentWordCloud(){
  const content=S.content||[];const docs=(S.writerDocs||[]);
  let allText='';
  content.forEach(c=>{allText+=' '+(c.body||'');});
  docs.forEach(d=>{allText+=' '+(d.body||'');});
  const stops=new Set(['the','a','an','and','or','but','in','on','at','to','for','of','is','it','that','this','was','are','be','has','had','have','with','as','by','from','not','will','can','would','could','should','all','their','there','been','its','my','your','our','they','them','we','he','she','you','i','do','did','so','if','no','up','out','one','about','what','which','when','how','who','more','than','just','also','into','over','such','after','then','any','only','these','some','other','new','like','very','may','most','even']);
  const words=allText.toLowerCase().replace(/[^a-z\s]/g,' ').split(/\s+/).filter(w=>w.length>2&&!stops.has(w));
  const freq={};words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,60);
  if(!sorted.length){showToast('No content to analyze');return;}
  const maxFreq=sorted[0][1];
  const cloudColors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316','#a855f7','#22d3ee'];
  const panel=document.createElement('div');panel.id='content-wordcloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Word Cloud (${sorted.length} words)</span><button onclick="document.getElementById('content-wordcloud-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;padding:16px;background:var(--bg-surface);border-radius:8px;margin-bottom:12px">`;
  sorted.forEach(([word,count],i)=>{
    const size=Math.max(10,Math.round((count/maxFreq)*32));
    const color=cloudColors[i%cloudColors.length];
    h+=`<span title="${count} occurrences" style="font-size:${size}px;color:${color};padding:2px 4px;cursor:default;line-height:1.3">${word}</span>`;
  });
  h+=`</div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center">${words.length} total words analyzed from ${content.length} content items + ${docs.length} docs</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showHabitTracker(){
  if(!S._habits)S._habits=[];
  const habits=S._habits;
  const today=new Date().toISOString().split('T')[0];
  const panel=document.createElement('div');panel.id='habit-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Habit Tracker</span><div><button onclick="addHabit()" style="font-size:10px;padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600;margin-right:8px">+ Habit</button><button onclick="document.getElementById('habit-tracker-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  if(!habits.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No habits yet. Click "+ Habit" to start tracking.</div>`;
  } else {
    h+=`<div style="display:grid;gap:8px">`;
    habits.forEach((hab,i)=>{
      const checkedToday=hab.history&&hab.history.includes(today);
      let streak=0;
      if(hab.history&&hab.history.length){
        const sorted=[...hab.history].sort().reverse();
        const d=new Date();
        for(let j=0;j<sorted.length;j++){
          const expected=new Date(d);expected.setDate(expected.getDate()-j);
          const eStr=expected.toISOString().split('T')[0];
          if(sorted[j]===eStr)streak++;else break;
        }
      }
      h+=`<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${checkedToday?'var(--accent)':'var(--border)'}">`;
      h+=`<button onclick="toggleHabitDay(${i})" style="width:24px;height:24px;border-radius:4px;border:2px solid ${checkedToday?'var(--accent)':'var(--border)'};background:${checkedToday?'var(--accent)':'transparent'};cursor:pointer;display:flex;align-items:center;justify-content:center;color:#000;font-size:14px;font-weight:700">${checkedToday?'v':''}</button>`;
      h+=`<div style="flex:1"><div style="font-size:12px;font-weight:600;color:var(--text-primary)">${esc(hab.name)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${streak} day streak | ${(hab.history||[]).length} total</div></div>`;
      h+=`<button onclick="deleteHabit(${i})" style="font-size:14px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  const last7=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);last7.push(d.toISOString().split('T')[0]);}
  if(habits.length){
    h+=`<div style="margin-top:12px;background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Last 7 Days</div>`;
    h+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center">`;
    last7.forEach(d=>{
      const dayName=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(d).getDay()];
      const completed=habits.filter(hab=>(hab.history||[]).includes(d)).length;
      const pct=Math.round((completed/habits.length)*100);
      const color=pct>=80?'var(--accent)':pct>=50?'#f59e0b':pct>0?'#ef4444':'var(--bg-base)';
      h+=`<div><div style="font-size:8px;color:var(--text-muted)">${dayName}</div><div style="width:20px;height:20px;border-radius:4px;background:${color};margin:2px auto;opacity:${pct>0?1:0.3}"></div><div style="font-size:8px;color:var(--text-muted)">${completed}/${habits.length}</div></div>`;
    });
    h+=`</div></div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function addHabit(){
  const name=prompt('Habit name:');if(!name||!name.trim())return;
  if(!S._habits)S._habits=[];
  S._habits.push({name:name.trim(),history:[],created:new Date().toISOString()});
  save();const p=document.getElementById('habit-tracker-panel');if(p)p.remove();showHabitTracker();
}
function toggleHabitDay(idx){
  const hab=S._habits[idx];if(!hab)return;
  if(!hab.history)hab.history=[];
  const today=new Date().toISOString().split('T')[0];
  const i=hab.history.indexOf(today);
  if(i>=0)hab.history.splice(i,1);else hab.history.push(today);
  save();const p=document.getElementById('habit-tracker-panel');if(p)p.remove();showHabitTracker();
}
function deleteHabit(idx){
  if(!confirm('Delete this habit?'))return;
  S._habits.splice(idx,1);save();
  const p=document.getElementById('habit-tracker-panel');if(p)p.remove();showHabitTracker();
}
function showKnowledgeGraphStats(){
  const specs=[];(S.projects||[]).forEach(p=>{(p.specs||[]).forEach(s=>{specs.push(s);});});
  let totalLinks=0;const linkMap={};
  specs.forEach(s=>{
    (s.sections||[]).forEach(sec=>{
      const matches=(sec.body||'').match(/\[\[([^\]]+)\]\]/g)||[];
      totalLinks+=matches.length;
      matches.forEach(m=>{const name=m.replace(/[\[\]]/g,'');linkMap[name]=(linkMap[name]||0)+1;});
    });
  });
  const content=S.content||[];
  content.forEach(c=>{
    const matches=(c.body||'').match(/\[\[([^\]]+)\]\]/g)||[];
    totalLinks+=matches.length;
    matches.forEach(m=>{const name=m.replace(/[\[\]]/g,'');linkMap[name]=(linkMap[name]||0)+1;});
  });
  const topLinks=Object.entries(linkMap).sort((a,b)=>b[1]-a[1]).slice(0,15);
  const panel=document.createElement('div');panel.id='kg-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Knowledge Graph Stats</span><button onclick="document.getElementById('kg-stats-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--accent)">${totalLinks}</div><div style="font-size:10px;color:var(--text-muted)">Wiki-Links</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#3b82f6">${Object.keys(linkMap).length}</div><div style="font-size:10px;color:var(--text-muted)">Unique Targets</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#8b5cf6">${specs.length}</div><div style="font-size:10px;color:var(--text-muted)">Living Docs</div></div>`;
  h+=`</div>`;
  if(topLinks.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Most Referenced</div>`;
    h+=`<div style="display:grid;gap:4px">`;
    const max=topLinks[0][1];
    topLinks.forEach(([name,count])=>{
      const pct=Math.round((count/max)*100);
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary)">${esc(name)}</div>`;
      h+=`<div style="height:3px;background:var(--bg-base);border-radius:2px;margin-top:3px"><div style="height:100%;width:${pct}%;background:var(--accent);border-radius:2px"></div></div></div>`;
      h+=`<span style="font-size:10px;color:var(--text-muted);flex-shrink:0">${count}</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showRandomContent(){
  const content=S.content||[];
  if(!content.length){showToast('No content to pick from');return;}
  const item=content[Math.floor(Math.random()*content.length)];
  const words=(item.body||'').split(/\s+/).filter(w=>w).length;
  const date=item.created?new Date(item.created).toLocaleDateString():'Unknown';
  const panel=document.createElement('div');panel.id='random-content-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Random Content</span><div><button onclick="document.getElementById('random-content-panel').remove();showRandomContent()" style="font-size:10px;padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600;margin-right:8px">Shuffle</button><button onclick="document.getElementById('random-content-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  h+=`<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">`;
  if(item.theme)h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-surface);border-radius:10px;color:var(--accent)">${esc(item.theme)}</span>`;
  h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-surface);border-radius:10px;color:var(--text-muted)">${date}</span>`;
  h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-surface);border-radius:10px;color:var(--text-muted)">${words} words</span>`;
  (item.tags||[]).forEach(t=>{h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-surface);border-radius:10px;color:#8b5cf6">${esc(t)}</span>`;});
  h+=`</div>`;
  h+=`<div style="background:var(--bg-surface);padding:16px;border-radius:8px;font-size:12px;color:var(--text-secondary);line-height:1.7;white-space:pre-wrap;max-height:400px;overflow-y:auto">${esc(item.body||'(empty)')}</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
var _clipboardHistory=[];
function trackClipboard(text,source){
  if(!text||!text.trim())return;
  _clipboardHistory.unshift({text:text.substring(0,500),source:source||'copy',ts:Date.now()});
  if(_clipboardHistory.length>50)_clipboardHistory.length=50;
}
function showClipboardHistory(){
  const panel=document.createElement('div');panel.id='clipboard-history-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Clipboard History (${_clipboardHistory.length})</span><button onclick="document.getElementById('clipboard-history-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!_clipboardHistory.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No clipboard history yet. Copy text within ASTRA to track it here.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    _clipboardHistory.forEach((item,i)=>{
      const ago=Math.round((Date.now()-item.ts)/60000);
      const timeStr=ago<1?'Just now':ago<60?ago+'m ago':Math.round(ago/60)+'h ago';
      h+=`<div style="padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s" onclick="navigator.clipboard.writeText(_clipboardHistory[${i}].text);showToast('Copied')" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">`;
      h+=`<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:9px;color:var(--accent)">${item.source}</span><span style="font-size:9px;color:var(--text-muted)">${timeStr}</span></div>`;
      h+=`<div style="font-size:11px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(item.text)}</div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTimeZoneClock(){
  const zones=[
    {name:'Local',tz:Intl.DateTimeFormat().resolvedOptions().timeZone},
    {name:'New York',tz:'America/New_York'},
    {name:'London',tz:'Europe/London'},
    {name:'Tokyo',tz:'Asia/Tokyo'},
    {name:'Sydney',tz:'Australia/Sydney'},
    {name:'Dubai',tz:'Asia/Dubai'},
  ];
  const panel=document.createElement('div');panel.id='timezone-clock-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw';
  function updateClocks(){
    const now=new Date();
    let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">World Clock</span><button onclick="clearInterval(window._tzInterval);document.getElementById('timezone-clock-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
    h+=`<div style="display:grid;gap:8px">`;
    zones.forEach(z=>{
      const time=now.toLocaleTimeString('en-US',{timeZone:z.tz,hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const date=now.toLocaleDateString('en-US',{timeZone:z.tz,weekday:'short',month:'short',day:'numeric'});
      const hour=parseInt(now.toLocaleTimeString('en-US',{timeZone:z.tz,hour:'numeric',hour12:false}));
      const isNight=hour<6||hour>=21;
      h+=`<div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg-surface);border-radius:8px">`;
      h+=`<div style="width:8px;height:8px;border-radius:50%;background:${isNight?'#6366f1':'#f59e0b'};flex-shrink:0"></div>`;
      h+=`<div style="flex:1"><div style="font-size:11px;font-weight:600;color:var(--text-primary)">${z.name}</div><div style="font-size:9px;color:var(--text-muted)">${date}</div></div>`;
      h+=`<div style="font-size:16px;font-weight:700;color:var(--accent);font-family:monospace">${time}</div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
    panel.innerHTML=h;
  }
  updateClocks();
  window._tzInterval=setInterval(updateClocks,1000);
  document.body.appendChild(panel);
}
function showContentDiff(){
  const content=S.content||[];
  if(content.length<2){showToast('Need at least 2 content items to compare');return;}
  const panel=document.createElement('div');panel.id='content-diff-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Diff Viewer</span><button onclick="document.getElementById('content-diff-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">`;
  h+=`<div><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">Left</label><select id="diff-left" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px">`;
  content.slice(0,30).forEach((c,i)=>{
    const preview=(c.body||'').substring(0,40).replace(/\n/g,' ');
    h+=`<option value="${i}">${esc(preview||'(empty)')}</option>`;
  });
  h+=`</select></div>`;
  h+=`<div><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">Right</label><select id="diff-right" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px">`;
  content.slice(0,30).forEach((c,i)=>{
    const preview=(c.body||'').substring(0,40).replace(/\n/g,' ');
    h+=`<option value="${i}" ${i===1?'selected':''}>${esc(preview||'(empty)')}</option>`;
  });
  h+=`</select></div></div>`;
  h+=`<button onclick="runContentDiff()" style="width:100%;padding:8px;background:var(--accent);border:none;border-radius:4px;color:#000;font-weight:600;cursor:pointer;font-size:11px;margin-bottom:12px">Compare</button>`;
  h+=`<div id="diff-result" style="font-size:11px;color:var(--text-secondary)"></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function runContentDiff(){
  const content=S.content||[];
  const leftIdx=parseInt(document.getElementById('diff-left').value);
  const rightIdx=parseInt(document.getElementById('diff-right').value);
  const left=(content[leftIdx]&&content[leftIdx].body)||'';
  const right=(content[rightIdx]&&content[rightIdx].body)||'';
  const leftLines=left.split('\n');const rightLines=right.split('\n');
  let html='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  html+='<div style="background:var(--bg-surface);padding:10px;border-radius:6px;max-height:300px;overflow-y:auto">';
  leftLines.forEach(line=>{
    const inRight=rightLines.includes(line);
    html+=`<div style="font-size:10px;padding:2px 4px;color:${inRight?'var(--text-secondary)':'#ef4444'};background:${inRight?'transparent':'rgba(239,68,68,0.1)'};border-radius:2px;font-family:monospace;white-space:pre-wrap">${esc(line)||'&nbsp;'}</div>`;
  });
  html+='</div>';
  html+='<div style="background:var(--bg-surface);padding:10px;border-radius:6px;max-height:300px;overflow-y:auto">';
  rightLines.forEach(line=>{
    const inLeft=leftLines.includes(line);
    html+=`<div style="font-size:10px;padding:2px 4px;color:${inLeft?'var(--text-secondary)':'#4ade80'};background:${inLeft?'transparent':'rgba(74,222,128,0.1)'};border-radius:2px;font-family:monospace;white-space:pre-wrap">${esc(line)||'&nbsp;'}</div>`;
  });
  html+='</div></div>';
  const leftWords=new Set(left.toLowerCase().split(/\s+/));const rightWords=new Set(right.toLowerCase().split(/\s+/));
  const shared=[...leftWords].filter(w=>rightWords.has(w)).length;
  const total=new Set([...leftWords,...rightWords]).size||1;
  const similarity=Math.round((shared/total)*100);
  html+=`<div style="margin-top:8px;font-size:10px;color:var(--text-muted);text-align:center">Similarity: ${similarity}% | Red = only in left | Green = only in right</div>`;
  document.getElementById('diff-result').innerHTML=html;
}
function downloadWorkspaceBackup(){
  const data=JSON.parse(JSON.stringify(S));
  data._backupDate=new Date().toISOString();
  data._version='astra-backup-v1';
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='astra-backup-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();URL.revokeObjectURL(url);
  showToast('Workspace backup downloaded');
}
function uploadWorkspaceBackup(){
  const input=document.createElement('input');input.type='file';input.accept='.json';
  input.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data._version||data._version!=='astra-backup-v1'){
          if(!confirm('This does not look like an ASTRA backup. Import anyway?'))return;
        }
        if(!confirm('This will REPLACE all current data. Are you sure?'))return;
        delete data._backupDate;delete data._version;
        Object.assign(S,data);save();location.reload();
      }catch(err){showToast('Invalid JSON file');}
    };
    reader.readAsText(f);
  };
  input.click();
}
function showWorkspaceBackupPanel(){
  const panel=document.createElement('div');panel.id='backup-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const size=new Blob([JSON.stringify(S)]).size;
  const sizeKB=Math.round(size/1024);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Workspace Backup</span><button onclick="document.getElementById('backup-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:16px">Current workspace: ${sizeKB} KB</div>`;
  h+=`<div style="display:grid;gap:10px">`;
  h+=`<button onclick="document.getElementById('backup-panel').remove();downloadWorkspaceBackup()" style="padding:12px;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:600;cursor:pointer;font-size:12px">Download Backup (.json)</button>`;
  h+=`<button onclick="document.getElementById('backup-panel').remove();uploadWorkspaceBackup()" style="padding:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-weight:600;cursor:pointer;font-size:12px">Restore from Backup</button>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskBurnup(){
  const tasks=S.tasks||[];
  const weeks=12;const now=new Date();
  const weekData=[];
  for(let w=weeks-1;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-w*7);
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+7);
    const wStr=weekStart.toISOString().split('T')[0];
    const created=tasks.filter(t=>t.created&&t.created>=wStr&&t.created<weekEnd.toISOString().split('T')[0]).length;
    const completed=tasks.filter(t=>t.status==='done'&&t.created&&t.created<=weekEnd.toISOString().split('T')[0]).length;
    weekData.push({label:weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'}),created,completed});
  }
  let cumCreated=0,cumCompleted=0;
  weekData.forEach(w=>{cumCreated+=w.created;w.cumCreated=cumCreated;cumCompleted+=w.completed;w.cumCompleted=cumCompleted;});
  const maxVal=Math.max(cumCreated,cumCompleted,1);
  const panel=document.createElement('div');panel.id='burnup-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Burnup Chart (12 weeks)</span><button onclick="document.getElementById('burnup-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const svgW=600,svgH=200,pad=40;
  h+=`<svg viewBox="0 0 ${svgW} ${svgH+30}" style="width:100%;background:var(--bg-surface);border-radius:8px;padding:8px">`;
  for(let i=0;i<=4;i++){
    const y=pad+(svgH-pad*2)*(1-i/4);
    const val=Math.round(maxVal*i/4);
    h+=`<line x1="${pad}" y1="${y}" x2="${svgW-10}" y2="${y}" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>`;
    h+=`<text x="${pad-5}" y="${y+4}" text-anchor="end" fill="rgba(255,255,255,0.3)" font-size="9">${val}</text>`;
  }
  let createdPath='',completedPath='';
  weekData.forEach((w,i)=>{
    const x=pad+i*((svgW-pad-10)/(weeks-1));
    const yC=pad+(svgH-pad*2)*(1-w.cumCreated/maxVal);
    const yD=pad+(svgH-pad*2)*(1-w.cumCompleted/maxVal);
    createdPath+=(i===0?'M':'L')+x+','+yC;
    completedPath+=(i===0?'M':'L')+x+','+yD;
    if(i%2===0)h+=`<text x="${x}" y="${svgH+15}" text-anchor="middle" fill="rgba(255,255,255,0.3)" font-size="8">${w.label}</text>`;
  });
  h+=`<path d="${createdPath}" fill="none" stroke="#3b82f6" stroke-width="2"/>`;
  h+=`<path d="${completedPath}" fill="none" stroke="#4ade80" stroke-width="2"/>`;
  weekData.forEach((w,i)=>{
    const x=pad+i*((svgW-pad-10)/(weeks-1));
    const yC=pad+(svgH-pad*2)*(1-w.cumCreated/maxVal);
    const yD=pad+(svgH-pad*2)*(1-w.cumCompleted/maxVal);
    h+=`<circle cx="${x}" cy="${yC}" r="3" fill="#3b82f6"/>`;
    h+=`<circle cx="${x}" cy="${yD}" r="3" fill="#4ade80"/>`;
  });
  h+=`</svg>`;
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:10px">`;
  h+=`<span style="color:#3b82f6">Created (${cumCreated})</span>`;
  h+=`<span style="color:#4ade80">Completed (${cumCompleted})</span>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentMetrics(){
  const content=S.content||[];const docs=S.writerDocs||[];
  let allText='';
  content.forEach(c=>{allText+=' '+(c.body||'');});
  docs.forEach(d=>{allText+=' '+(d.body||'');});
  const words=allText.split(/\s+/).filter(w=>w);
  const sentences=allText.split(/[.!?]+/).filter(s=>s.trim());
  const uniqueWords=new Set(words.map(w=>w.toLowerCase()));
  const avgSentLen=sentences.length?Math.round(words.length/sentences.length):0;
  const syllableCount=w=>{w=w.toLowerCase();if(w.length<=3)return 1;w=w.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/,'');w=w.replace(/^y/,'');const m=w.match(/[aeiouy]{1,2}/g);return m?m.length:1;};
  const totalSyllables=words.reduce((a,w)=>a+syllableCount(w),0);
  const fleschKincaid=sentences.length?Math.round(206.835-1.015*(words.length/sentences.length)-84.6*(totalSyllables/words.length)):0;
  const readability=fleschKincaid>=60?'Easy':fleschKincaid>=30?'Moderate':'Difficult';
  const readColor=fleschKincaid>=60?'#4ade80':fleschKincaid>=30?'#f59e0b':'#ef4444';
  const vocabRichness=words.length?Math.round((uniqueWords.size/words.length)*100):0;
  const panel=document.createElement('div');panel.id='content-metrics-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Metrics</span><button onclick="document.getElementById('content-metrics-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--accent)">${words.length.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted)">Total Words</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#3b82f6">${uniqueWords.size.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted)">Unique Words</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:${readColor}">${fleschKincaid}</div><div style="font-size:10px;color:var(--text-muted)">Flesch-Kincaid (${readability})</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#8b5cf6">${avgSentLen}</div><div style="font-size:10px;color:var(--text-muted)">Avg Sentence Length</div></div>`;
  h+=`</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#f59e0b">${vocabRichness}%</div><div style="font-size:9px;color:var(--text-muted)">Vocab Richness</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#ec4899">${sentences.length}</div><div style="font-size:9px;color:var(--text-muted)">Sentences</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#06b6d4">${content.length+docs.length}</div><div style="font-size:9px;color:var(--text-muted)">Total Items</div></div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMarkdownPreview(text){
  if(!text){
    const content=S.content||[];
    if(!content.length){showToast('No content to preview');return;}
    text=content[0].body||'';
  }
  let html=esc(text);
  html=html.replace(/^### (.+)$/gm,'<h3 style="color:var(--text-primary);margin:12px 0 6px">$1</h3>');
  html=html.replace(/^## (.+)$/gm,'<h2 style="color:var(--text-primary);margin:16px 0 8px;font-size:16px">$1</h2>');
  html=html.replace(/^# (.+)$/gm,'<h1 style="color:var(--text-primary);margin:20px 0 10px;font-size:20px">$1</h1>');
  html=html.replace(/\*\*(.+?)\*\*/g,'<strong style="color:var(--text-primary)">$1</strong>');
  html=html.replace(/\*(.+?)\*/g,'<em>$1</em>');
  html=html.replace(/`(.+?)`/g,'<code style="background:var(--bg-base);padding:1px 4px;border-radius:3px;font-size:11px">$1</code>');
  html=html.replace(/^- (.+)$/gm,'<li style="margin:2px 0;margin-left:16px">$1</li>');
  html=html.replace(/^\d+\. (.+)$/gm,'<li style="margin:2px 0;margin-left:16px;list-style-type:decimal">$1</li>');
  html=html.replace(/^&gt; (.+)$/gm,'<blockquote style="border-left:3px solid var(--accent);padding-left:12px;margin:8px 0;color:var(--text-muted);font-style:italic">$1</blockquote>');
  html=html.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid var(--border);margin:12px 0">');
  html=html.replace(/\n/g,'<br>');
  const panel=document.createElement('div');panel.id='md-preview-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h2=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Markdown Preview</span><button onclick="document.getElementById('md-preview-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h2+=`<div style="background:var(--bg-surface);padding:16px;border-radius:8px;font-size:12px;color:var(--text-secondary);line-height:1.8">${html}</div>`;
  panel.innerHTML=h2;document.body.appendChild(panel);
}
function showTaskCompletionHeatmap(){
  const tasks=S.tasks||[];
  const now=new Date();
  const dayMap={};
  tasks.forEach(t=>{
    if(t.status==='done'&&t.created){
      const day=t.created.split('T')[0];dayMap[day]=(dayMap[day]||0)+1;
    }
  });
  const panel=document.createElement('div');panel.id='task-completion-heatmap';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Completion Heatmap (6 months)</span><button onclick="document.getElementById('task-completion-heatmap').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const weeks=26;
  h+=`<div style="display:flex;gap:2px;flex-wrap:nowrap;overflow-x:auto;padding:4px">`;
  for(let w=weeks-1;w>=0;w--){
    h+=`<div style="display:flex;flex-direction:column;gap:2px">`;
    for(let d=0;d<7;d++){
      const date=new Date(now);date.setDate(date.getDate()-(w*7+6-d));
      const dateStr=date.toISOString().split('T')[0];
      const count=dayMap[dateStr]||0;
      const color=count===0?'rgba(255,255,255,0.05)':count===1?'#1a4731':count===2?'#166534':count>=3?'#4ade80':'#86efac';
      h+=`<div title="${dateStr}: ${count} completed" style="width:10px;height:10px;border-radius:2px;background:${color}"></div>`;
    }
    h+=`</div>`;
  }
  h+=`</div>`;
  const totalDone=Object.values(dayMap).reduce((a,b)=>a+b,0);
  const activeDays=Object.keys(dayMap).length;
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:12px;font-size:10px;color:var(--text-muted)">`;
  h+=`<span>Total completed: <span style="color:var(--accent)">${totalDone}</span></span>`;
  h+=`<span>Active days: <span style="color:var(--accent)">${activeDays}</span></span>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showSavedSearches(){
  if(!S._savedSearches)S._savedSearches=[];
  const searches=S._savedSearches;
  const panel=document.createElement('div');panel.id='saved-searches-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Saved Searches (${searches.length})</span><div><button onclick="addSavedSearch()" style="font-size:10px;padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600;margin-right:8px">+ Save</button><button onclick="document.getElementById('saved-searches-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  if(!searches.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No saved searches. Click "+ Save" to add a search query.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    searches.forEach((s,i)=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'" onclick="document.getElementById('saved-searches-panel').remove();openCommandPalette();setTimeout(()=>{const inp=document.getElementById('cmd-input');if(inp){inp.value='${esc(s.query)}';inp.dispatchEvent(new Event('input'));}},100)">`;
      h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary)">${esc(s.query)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${s.created?new Date(s.created).toLocaleDateString():''}</div></div>`;
      h+=`<button onclick="event.stopPropagation();deleteSavedSearch(${i})" style="font-size:14px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function addSavedSearch(){
  const query=prompt('Search query to save:');if(!query||!query.trim())return;
  if(!S._savedSearches)S._savedSearches=[];
  S._savedSearches.push({query:query.trim(),created:new Date().toISOString()});
  save();const p=document.getElementById('saved-searches-panel');if(p)p.remove();showSavedSearches();
}
function deleteSavedSearch(idx){
  S._savedSearches.splice(idx,1);save();
  const p=document.getElementById('saved-searches-panel');if(p)p.remove();showSavedSearches();
}
function showStaleContent(){
  const content=S.content||[];const now=Date.now();const threshold=30*86400000;
  const stale=content.filter(c=>{
    const created=c.created?new Date(c.created).getTime():0;
    return created>0&&(now-created)>threshold;
  }).sort((a,b)=>new Date(a.created)-new Date(b.created));
  const panel=document.createElement('div');panel.id='stale-content-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Stale Content (${stale.length} items, 30+ days old)</span><button onclick="document.getElementById('stale-content-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!stale.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No stale content found. All content is less than 30 days old.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    stale.slice(0,30).forEach(c=>{
      const age=Math.round((now-new Date(c.created).getTime())/86400000);
      const preview=(c.body||'').substring(0,60);
      const ageColor=age>90?'#ef4444':age>60?'#f59e0b':'#f97316';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;border-left:3px solid ${ageColor}">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview||'(empty)')}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${c.theme||'no theme'} | ${(c.tags||[]).join(', ')||'no tags'}</div></div>`;
      h+=`<span style="font-size:10px;font-weight:600;color:${ageColor};flex-shrink:0">${age}d</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
var _quickTimerInterval=null;
function startQuickTimer(mins){
  if(_quickTimerInterval)clearInterval(_quickTimerInterval);
  const endTime=Date.now()+mins*60000;
  let existing=document.getElementById('quick-timer-bar');
  if(!existing){
    existing=document.createElement('div');existing.id='quick-timer-bar';
    existing.style.cssText='position:fixed;bottom:60px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--accent);border-radius:8px;padding:8px 14px;box-shadow:0 4px 16px rgba(0,0,0,0.5);display:flex;align-items:center;gap:10px';
    document.body.appendChild(existing);
  }
  function update(){
    const remaining=Math.max(0,endTime-Date.now());
    const m=Math.floor(remaining/60000);const s=Math.floor((remaining%60000)/1000);
    existing.innerHTML=`<span style="font-size:16px;font-weight:700;color:var(--accent);font-family:monospace">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span><button onclick="clearInterval(_quickTimerInterval);document.getElementById('quick-timer-bar').remove()" style="font-size:12px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
    if(remaining<=0){
      clearInterval(_quickTimerInterval);
      existing.style.borderColor='#ef4444';
      existing.innerHTML=`<span style="font-size:14px;font-weight:700;color:#ef4444">Time's up!</span><button onclick="document.getElementById('quick-timer-bar').remove()" style="font-size:12px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
      try{new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ==').play();}catch(e){}
    }
  }
  update();_quickTimerInterval=setInterval(update,1000);
  showToast('Timer started: '+mins+' minutes');
}
function showProjectHealthDashboard(){
  const projects=S.projects||[];const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const panel=document.createElement('div');panel.id='project-health-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Project Health Dashboard</span><button onclick="document.getElementById('project-health-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:10px">`;
  projects.forEach(p=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    const pContent=content.filter(c=>(c.tags||[]).some(tag=>tag.toLowerCase()===p.name.toLowerCase()));
    const pLinks=links.filter(l=>l.project===p.name||l.category===p.name);
    const done=pTasks.filter(t=>t.status==='done').length;
    const overdue=pTasks.filter(t=>t.due&&new Date(t.due)<new Date()&&t.status!=='done').length;
    const total=pTasks.length||1;
    const completionRate=Math.round((done/total)*100);
    const specs=(p.specs||[]).length;
    let healthScore=50;
    healthScore+=Math.min(completionRate/2,25);
    healthScore-=overdue*5;
    healthScore+=Math.min(pContent.length*2,10);
    healthScore+=Math.min(specs*3,15);
    healthScore=Math.max(0,Math.min(100,healthScore));
    const healthColor=healthScore>=75?'#4ade80':healthScore>=50?'#f59e0b':'#ef4444';
    const healthLabel=healthScore>=75?'Healthy':healthScore>=50?'At Risk':'Critical';
    h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;border-left:3px solid ${healthColor}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">`;
    h+=`<span style="font-size:12px;font-weight:600;color:var(--text-primary)">${esc(p.name)}</span>`;
    h+=`<span style="font-size:11px;font-weight:700;color:${healthColor}">${healthScore}% ${healthLabel}</span></div>`;
    h+=`<div style="height:6px;background:var(--bg-base);border-radius:3px;margin-bottom:8px"><div style="height:100%;width:${healthScore}%;background:${healthColor};border-radius:3px;transition:width 0.3s"></div></div>`;
    h+=`<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:10px;color:var(--text-muted)">`;
    h+=`<span>Tasks: ${done}/${pTasks.length}</span>`;
    if(overdue)h+=`<span style="color:#ef4444">Overdue: ${overdue}</span>`;
    h+=`<span>Content: ${pContent.length}</span>`;
    h+=`<span>Docs: ${specs}</span>`;
    h+=`<span>Links: ${pLinks.length}</span>`;
    h+=`</div></div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskMatrix(){
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();const threeDays=3*86400000;
  const quadrants={
    doFirst:[],schedule:[],delegate:[],eliminate:[]
  };
  tasks.forEach(t=>{
    const urgent=t.due&&(new Date(t.due).getTime()-now.getTime())<threeDays;
    const important=t.priority==='p0'||t.priority==='p1';
    if(urgent&&important)quadrants.doFirst.push(t);
    else if(!urgent&&important)quadrants.schedule.push(t);
    else if(urgent&&!important)quadrants.delegate.push(t);
    else quadrants.eliminate.push(t);
  });
  const panel=document.createElement('div');panel.id='task-matrix-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Priority Matrix</span><button onclick="document.getElementById('task-matrix-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const quads=[
    {key:'doFirst',name:'Do First',color:'#ef4444',desc:'Urgent + Important'},
    {key:'schedule',name:'Schedule',color:'#3b82f6',desc:'Important, Not Urgent'},
    {key:'delegate',name:'Delegate',color:'#f59e0b',desc:'Urgent, Not Important'},
    {key:'eliminate',name:'Eliminate',color:'#6b7280',desc:'Not Urgent, Not Important'},
  ];
  h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">`;
  quads.forEach(q=>{
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;border-top:3px solid ${q.color};min-height:100px">`;
    h+=`<div style="font-size:11px;font-weight:700;color:${q.color};margin-bottom:2px">${q.name} (${quadrants[q.key].length})</div>`;
    h+=`<div style="font-size:8px;color:var(--text-muted);margin-bottom:8px">${q.desc}</div>`;
    quadrants[q.key].slice(0,5).forEach(t=>{
      h+=`<div style="font-size:10px;color:var(--text-secondary);padding:3px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.title)}</div>`;
    });
    if(quadrants[q.key].length>5)h+=`<div style="font-size:9px;color:var(--text-muted)">+${quadrants[q.key].length-5} more</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentBookmarks(){
  if(!S._contentBookmarks)S._contentBookmarks=[];
  const bookmarks=S._contentBookmarks;
  const content=S.content||[];
  const panel=document.createElement('div');panel.id='content-bookmarks-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Bookmarks (${bookmarks.length})</span><button onclick="document.getElementById('content-bookmarks-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!bookmarks.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No bookmarks yet. Star or pin content items to bookmark them.</div>`;
    const recent=content.slice(0,10);
    if(recent.length){
      h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin:12px 0 8px">Quick Bookmark:</div>`;
      h+=`<div style="display:grid;gap:4px">`;
      recent.forEach(c=>{
        const preview=(c.body||'').substring(0,50);
        h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:4px">`;
        h+=`<div style="flex:1;font-size:10px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview)}</div>`;
        h+=`<button onclick="addContentBookmark('${c.id}')" style="font-size:9px;padding:2px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer">Bookmark</button>`;
        h+=`</div>`;
      });
      h+=`</div>`;
    }
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    bookmarks.forEach((bId,i)=>{
      const item=content.find(c=>c.id===bId);
      if(!item)return;
      const preview=(item.body||'').substring(0,60);
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview||'(empty)')}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${item.theme||''} | ${(item.tags||[]).slice(0,3).join(', ')}</div></div>`;
      h+=`<button onclick="removeContentBookmark(${i})" style="font-size:14px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function addContentBookmark(id){
  if(!S._contentBookmarks)S._contentBookmarks=[];
  if(!S._contentBookmarks.includes(id)){S._contentBookmarks.push(id);save();}
  const p=document.getElementById('content-bookmarks-panel');if(p)p.remove();showContentBookmarks();
}
function removeContentBookmark(idx){
  S._contentBookmarks.splice(idx,1);save();
  const p=document.getElementById('content-bookmarks-panel');if(p)p.remove();showContentBookmarks();
}
function showSystemStatus(){
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];const docs=S.writerDocs||[];const projects=S.projects||[];
  const storageSize=new Blob([JSON.stringify(S)]).size;
  const sizeKB=Math.round(storageSize/1024);
  const sizeMB=(storageSize/1048576).toFixed(2);
  const sections=['tasks','calendar','writer','livingDocs','content','links','whiteboard','repos','pipeline'];
  const panel=document.createElement('div');panel.id='system-status-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const elapsed=Date.now()-(_sessionStart||Date.now());const sessionMins=Math.floor(elapsed/60000);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">ASTRA System Status</span><button onclick="document.getElementById('system-status-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${tasks.length}</div><div style="font-size:9px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#3b82f6">${content.length}</div><div style="font-size:9px;color:var(--text-muted)">Content Items</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">${links.length}</div><div style="font-size:9px;color:var(--text-muted)">Links</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#8b5cf6">${docs.length}</div><div style="font-size:9px;color:var(--text-muted)">Writer Docs</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#ec4899">${projects.length}</div><div style="font-size:9px;color:var(--text-muted)">Projects</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#06b6d4">${sessionMins}m</div><div style="font-size:9px;color:var(--text-muted)">Session Time</div></div>`;
  h+=`</div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:12px">`;
  h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Storage</div>`;
  h+=`<div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:var(--text-muted)">localStorage</span><span style="color:var(--accent)">${sizeKB} KB (${sizeMB} MB)</span></div>`;
  const maxStorage=5120;const pct=Math.min(Math.round((sizeKB/maxStorage)*100),100);
  h+=`<div style="height:6px;background:var(--bg-base);border-radius:3px;margin-top:6px"><div style="height:100%;width:${pct}%;background:${pct>80?'#ef4444':pct>50?'#f59e0b':'var(--accent)'};border-radius:3px"></div></div>`;
  h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:4px">${pct}% of ~5MB localStorage limit</div>`;
  h+=`</div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px">`;
  h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Theme: ${S._theme||'Cosmic (default)'}</div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted)">Version: ASTRA Command Center v2.0</div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showAutoTagSuggestions(){
  const content=S.content||[];
  const existingTags={};
  content.forEach(c=>{(c.tags||[]).forEach(t=>{existingTags[t]=(existingTags[t]||0)+1;});});
  const topTags=Object.entries(existingTags).sort((a,b)=>b[1]-a[1]).slice(0,20);
  const untagged=content.filter(c=>!(c.tags&&c.tags.length));
  const panel=document.createElement('div');panel.id='auto-tag-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Auto-Tag Suggestions</span><button onclick="document.getElementById('auto-tag-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${Object.keys(existingTags).length}</div><div style="font-size:9px;color:var(--text-muted)">Unique Tags</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">${untagged.length}</div><div style="font-size:9px;color:var(--text-muted)">Untagged Items</div></div>`;
  h+=`</div>`;
  if(topTags.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Popular Tags</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">`;
    topTags.forEach(([tag,count])=>{
      h+=`<span style="font-size:10px;padding:3px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;color:var(--accent)">${esc(tag)} (${count})</span>`;
    });
    h+=`</div>`;
  }
  if(untagged.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Untagged Items (click to suggest)</div>`;
    h+=`<div style="display:grid;gap:4px">`;
    untagged.slice(0,10).forEach(c=>{
      const words=(c.body||'').toLowerCase().split(/\s+/).filter(w=>w.length>3);
      const suggestions=[];
      topTags.forEach(([tag])=>{if(words.some(w=>w.includes(tag.toLowerCase())))suggestions.push(tag);});
      if(c.theme&&!suggestions.includes(c.theme))suggestions.push(c.theme);
      const preview=(c.body||'').substring(0,50);
      h+=`<div style="padding:6px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="font-size:10px;color:var(--text-secondary);margin-bottom:4px">${esc(preview)}</div>`;
      if(suggestions.length){
        h+=`<div style="display:flex;gap:4px;flex-wrap:wrap">`;
        suggestions.slice(0,3).forEach(s=>{
          h+=`<button onclick="applyAutoTag('${c.id}','${esc(s)}')" style="font-size:9px;padding:1px 6px;background:var(--bg-base);border:1px solid var(--accent);border-radius:8px;color:var(--accent);cursor:pointer">+${esc(s)}</button>`;
        });
        h+=`</div>`;
      } else {
        h+=`<div style="font-size:9px;color:var(--text-muted)">No suggestions available</div>`;
      }
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function applyAutoTag(id,tag){
  const c=(S.content||[]).find(x=>x.id===id);if(!c)return;
  if(!c.tags)c.tags=[];
  if(!c.tags.includes(tag)){c.tags.push(tag);save();showToast('Tagged: '+tag);}
  const p=document.getElementById('auto-tag-panel');if(p)p.remove();showAutoTagSuggestions();
}
function showSprintView(){
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();
  const sprints=[];
  for(let i=0;i<4;i++){
    const start=new Date(now);start.setDate(start.getDate()+i*7);
    const end=new Date(start);end.setDate(end.getDate()+7);
    const startStr=start.toISOString().split('T')[0];
    const endStr=end.toISOString().split('T')[0];
    const sprintTasks=tasks.filter(t=>{
      if(!t.due)return i===3;
      return t.due>=startStr&&t.due<endStr;
    });
    sprints.push({
      name:i===0?'This Week':i===1?'Next Week':i===2?'Week '+3:'Backlog',
      start:startStr,end:endStr,tasks:sprintTasks
    });
  }
  const panel=document.createElement('div');panel.id='sprint-view-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Sprint View</span><button onclick="document.getElementById('sprint-view-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const colors=['#4ade80','#3b82f6','#f59e0b','#6b7280'];
  sprints.forEach((sp,si)=>{
    h+=`<div style="margin-bottom:12px;background:var(--bg-surface);padding:12px;border-radius:8px;border-left:3px solid ${colors[si]}">`;
    h+=`<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-size:12px;font-weight:600;color:${colors[si]}">${sp.name}</span><span style="font-size:10px;color:var(--text-muted)">${sp.tasks.length} tasks</span></div>`;
    if(!sp.tasks.length){
      h+=`<div style="font-size:10px;color:var(--text-muted);padding:4px 0">No tasks scheduled</div>`;
    } else {
      sp.tasks.slice(0,8).forEach(t=>{
        const pColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
        h+=`<div style="display:flex;align-items:center;gap:6px;padding:3px 0">`;
        h+=`<div style="width:6px;height:6px;border-radius:50%;background:${pColor};flex-shrink:0"></div>`;
        h+=`<span style="font-size:10px;color:var(--text-secondary);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.title)}</span>`;
        if(t.due)h+=`<span style="font-size:9px;color:var(--text-muted);flex-shrink:0">${t.due.substring(5)}</span>`;
        h+=`</div>`;
      });
      if(sp.tasks.length>8)h+=`<div style="font-size:9px;color:var(--text-muted);padding-top:4px">+${sp.tasks.length-8} more</div>`;
    }
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showColorLegend(){
  const legends=[
    {category:'Priority',items:[
      {color:'#ef4444',label:'P0 - Critical'},
      {color:'#f59e0b',label:'P1 - High'},
      {color:'#3b82f6',label:'P2 - Medium'},
      {color:'#6b7280',label:'P3 - Low'},
    ]},
    {category:'Task Status',items:[
      {color:'#f59e0b',label:'Todo'},
      {color:'#3b82f6',label:'In Progress'},
      {color:'#4ade80',label:'Done'},
    ]},
    {category:'Calendar',items:[
      {color:'var(--accent)',label:'Today'},
      {color:'#ef4444',label:'Overdue task'},
      {color:'#3b82f6',label:'Future task'},
    ]},
    {category:'Links',items:[
      {color:'#4ade80',label:'Pinned link'},
      {color:'#f59e0b',label:'Read later'},
      {color:'var(--text-muted)',label:'Regular link'},
    ]},
    {category:'Content',items:[
      {color:'#f59e0b',label:'Starred item'},
      {color:'#4ade80',label:'Pinned item'},
      {color:'#8b5cf6',label:'Tag pill'},
    ]},
    {category:'Health',items:[
      {color:'#4ade80',label:'Healthy (75%+)'},
      {color:'#f59e0b',label:'At Risk (50-74%)'},
      {color:'#ef4444',label:'Critical (<50%)'},
    ]},
  ];
  const panel=document.createElement('div');panel.id='color-legend-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Color Legend</span><button onclick="document.getElementById('color-legend-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">`;
  legends.forEach(leg=>{
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px">`;
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">${leg.category}</div>`;
    leg.items.forEach(item=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:2px 0"><div style="width:12px;height:12px;border-radius:3px;background:${item.color};flex-shrink:0"></div><span style="font-size:10px;color:var(--text-secondary)">${item.label}</span></div>`;
    });
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function generateDailyDigest(){
  const now=new Date();const today=now.toISOString().split('T')[0];
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const todayTasks=tasks.filter(t=>t.created&&t.created.startsWith(today));
  const completedToday=tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(today));
  const overdue=tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  const todayContent=content.filter(c=>c.created&&c.created.startsWith(today));
  const todayLinks=links.filter(l=>l.created&&l.created.startsWith(today));
  let digest=`ASTRA Daily Digest - ${now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}\n${'='.repeat(60)}\n\n`;
  digest+=`OVERVIEW\n--------\n`;
  digest+=`Tasks created: ${todayTasks.length}\n`;
  digest+=`Tasks completed: ${completedToday.length}\n`;
  digest+=`Content added: ${todayContent.length}\n`;
  digest+=`Links saved: ${todayLinks.length}\n`;
  digest+=`Overdue tasks: ${overdue.length}\n\n`;
  if(completedToday.length){
    digest+=`COMPLETED TODAY\n---------------\n`;
    completedToday.forEach(t=>{digest+=`[DONE] ${t.title}\n`;});
    digest+=`\n`;
  }
  if(overdue.length){
    digest+=`OVERDUE\n-------\n`;
    overdue.slice(0,10).forEach(t=>{digest+=`[!] ${t.title} (due ${t.due})\n`;});
    digest+=`\n`;
  }
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  if(inProgress.length){
    digest+=`IN PROGRESS\n-----------\n`;
    inProgress.forEach(t=>{digest+=`[-] ${t.title}\n`;});
    digest+=`\n`;
  }
  if(todayContent.length){
    digest+=`NEW CONTENT\n-----------\n`;
    todayContent.forEach(c=>{digest+=`- ${(c.body||'').substring(0,60)}\n`;});
    digest+=`\n`;
  }
  digest+=`\nGenerated by ASTRA Command Center\n`;
  navigator.clipboard.writeText(digest);showToast('Daily digest copied to clipboard');
}
function showContentArchive(){
  if(!S._contentArchive)S._contentArchive=[];
  const archived=S._contentArchive;
  const panel=document.createElement('div');panel.id='content-archive-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Archive (${archived.length})</span><div><button onclick="archiveOldContent()" style="font-size:10px;padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600;margin-right:8px">Archive 30d+</button><button onclick="document.getElementById('content-archive-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  if(!archived.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No archived content. Click "Archive 30d+" to archive old items.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    archived.slice(0,30).forEach((c,i)=>{
      const preview=(c.body||'').substring(0,60);
      const date=c.created?new Date(c.created).toLocaleDateString():'';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview||'(empty)')}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${c.theme||''} | ${date}</div></div>`;
      h+=`<button onclick="restoreArchivedContent(${i})" style="font-size:9px;padding:3px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer">Restore</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function archiveOldContent(){
  const now=Date.now();const threshold=30*86400000;
  if(!S._contentArchive)S._contentArchive=[];
  const toArchive=(S.content||[]).filter(c=>{
    const created=c.created?new Date(c.created).getTime():0;
    return created>0&&(now-created)>threshold;
  });
  if(!toArchive.length){showToast('No content older than 30 days');return;}
  if(!confirm('Archive '+toArchive.length+' items older than 30 days?'))return;
  toArchive.forEach(c=>{
    S._contentArchive.push(c);
    S.content=S.content.filter(x=>x.id!==c.id);
  });
  save();const p=document.getElementById('content-archive-panel');if(p)p.remove();showContentArchive();
  showToast('Archived '+toArchive.length+' items');
}
function restoreArchivedContent(idx){
  if(!S._contentArchive)return;
  const item=S._contentArchive.splice(idx,1)[0];
  if(!S.content)S.content=[];S.content.unshift(item);save();
  const p=document.getElementById('content-archive-panel');if(p)p.remove();showContentArchive();
  showToast('Content restored');
}
var _changelog=[];
function logChange(action,section,detail){
  _changelog.unshift({action,section,detail:detail||'',ts:Date.now()});
  if(_changelog.length>100)_changelog.length=100;
}
function showChangelog(){
  const panel=document.createElement('div');panel.id='changelog-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Workspace Changelog (${_changelog.length})</span><button onclick="document.getElementById('changelog-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!_changelog.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No changes logged this session.</div>`;
  } else {
    h+=`<div style="display:grid;gap:4px">`;
    _changelog.slice(0,50).forEach(entry=>{
      const ago=Math.round((Date.now()-entry.ts)/60000);
      const timeStr=ago<1?'Just now':ago<60?ago+'m ago':Math.round(ago/60)+'h ago';
      const actionColor=entry.action==='create'?'#4ade80':entry.action==='delete'?'#ef4444':entry.action==='update'?'#3b82f6':'#f59e0b';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:4px;border-left:2px solid ${actionColor}">`;
      h+=`<span style="font-size:9px;font-weight:600;color:${actionColor};width:40px;flex-shrink:0">${entry.action}</span>`;
      h+=`<span style="font-size:10px;color:var(--text-secondary);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(entry.section)}: ${esc(entry.detail)}</span>`;
      h+=`<span style="font-size:9px;color:var(--text-muted);flex-shrink:0">${timeStr}</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showFocusModeConfig(){
  if(!S._focusConfig)S._focusConfig={blockedSections:[],duration:25,breakDuration:5};
  const fc=S._focusConfig;
  const allSections=['tasks','calendar','writer','livingDocs','content','links','whiteboard','repos','pipeline'];
  const panel=document.createElement('div');panel.id='focus-config-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Focus Mode Config</span><button onclick="document.getElementById('focus-config-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Focus Duration (minutes)</div>`;
  h+=`<div style="display:flex;gap:8px">`;
  [15,25,45,60].forEach(m=>{
    const selected=fc.duration===m;
    h+=`<button onclick="S._focusConfig.duration=${m};save();document.getElementById('focus-config-panel').remove();showFocusModeConfig()" style="padding:6px 14px;border-radius:6px;border:1px solid ${selected?'var(--accent)':'var(--border)'};background:${selected?'var(--accent)':'var(--bg-surface)'};color:${selected?'#000':'var(--text-secondary)'};cursor:pointer;font-size:11px;font-weight:${selected?'700':'400'}">${m}m</button>`;
  });
  h+=`</div></div>`;
  h+=`<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Break Duration (minutes)</div>`;
  h+=`<div style="display:flex;gap:8px">`;
  [3,5,10,15].forEach(m=>{
    const selected=fc.breakDuration===m;
    h+=`<button onclick="S._focusConfig.breakDuration=${m};save();document.getElementById('focus-config-panel').remove();showFocusModeConfig()" style="padding:6px 14px;border-radius:6px;border:1px solid ${selected?'var(--accent)':'var(--border)'};background:${selected?'var(--accent)':'var(--bg-surface)'};color:${selected?'#000':'var(--text-secondary)'};cursor:pointer;font-size:11px;font-weight:${selected?'700':'400'}">${m}m</button>`;
  });
  h+=`</div></div>`;
  h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Block sections during focus (click to toggle)</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">`;
  allSections.forEach(sec=>{
    const blocked=(fc.blockedSections||[]).includes(sec);
    h+=`<button onclick="toggleFocusBlock('${sec}')" style="padding:6px;border-radius:6px;border:1px solid ${blocked?'#ef4444':'var(--border)'};background:${blocked?'rgba(239,68,68,0.1)':'var(--bg-surface)'};color:${blocked?'#ef4444':'var(--text-secondary)'};cursor:pointer;font-size:10px">${blocked?'X ':''}${sec}</button>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function toggleFocusBlock(sec){
  if(!S._focusConfig)S._focusConfig={blockedSections:[],duration:25,breakDuration:5};
  if(!S._focusConfig.blockedSections)S._focusConfig.blockedSections=[];
  const idx=S._focusConfig.blockedSections.indexOf(sec);
  if(idx>=0)S._focusConfig.blockedSections.splice(idx,1);
  else S._focusConfig.blockedSections.push(sec);
  save();const p=document.getElementById('focus-config-panel');if(p)p.remove();showFocusModeConfig();
}
function extractActionItems(){
  const content=S.content||[];
  const actionPatterns=[/^[-*]\s*\[[ x]\]\s*(.+)$/gm,/^TODO:\s*(.+)$/gim,/^ACTION:\s*(.+)$/gim,/^[-*]\s*(.+)$/gm];
  const found=[];
  content.forEach(c=>{
    const text=c.body||'';
    const lines=text.split('\n');
    lines.forEach(line=>{
      const trimmed=line.trim();
      if(trimmed.match(/^[-*]\s*\[[ ]\]\s*.+/)){
        const title=trimmed.replace(/^[-*]\s*\[[ ]\]\s*/,'');
        found.push({title,source:c.id,preview:(c.body||'').substring(0,40)});
      } else if(trimmed.match(/^(TODO|ACTION):\s*.+/i)){
        const title=trimmed.replace(/^(TODO|ACTION):\s*/i,'');
        found.push({title,source:c.id,preview:(c.body||'').substring(0,40)});
      }
    });
  });
  const panel=document.createElement('div');panel.id='action-items-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Action Items Found (${found.length})</span><button onclick="document.getElementById('action-items-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Scans content for TODO:, ACTION:, and unchecked [ ] items</div>`;
  if(!found.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No action items found in content. Use "- [ ] task", "TODO: task", or "ACTION: task" format.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    found.slice(0,20).forEach((item,i)=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary)">${esc(item.title)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">From: ${esc(item.preview)}...</div></div>`;
      h+=`<button onclick="createTaskFromAction('${esc(item.title.replace(/'/g,"\\'"))}')" style="font-size:9px;padding:3px 8px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600">Create Task</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
    if(found.length>1){
      h+=`<button onclick="createAllActionTasks()" style="width:100%;margin-top:12px;padding:10px;background:var(--bg-surface);border:1px solid var(--accent);border-radius:6px;color:var(--accent);cursor:pointer;font-size:11px;font-weight:600">Create All ${found.length} Tasks</button>`;
    }
  }
  panel.innerHTML=h;document.body.appendChild(panel);
  window._extractedActions=found;
}
function createTaskFromAction(title){
  if(!S.tasks)S.tasks=[];
  S.tasks.unshift({id:'t_'+Date.now(),title,status:'todo',priority:'p2',project:'',due:'',created:new Date().toISOString(),description:'Extracted from content',subtasks:[]});
  save();showToast('Task created: '+title.substring(0,40));
}
function createAllActionTasks(){
  const actions=window._extractedActions||[];
  if(!actions.length)return;
  if(!confirm('Create '+actions.length+' tasks?'))return;
  actions.forEach((item,i)=>{
    setTimeout(()=>{
      if(!S.tasks)S.tasks=[];
      S.tasks.unshift({id:'t_'+(Date.now()+i),title:item.title,status:'todo',priority:'p2',project:'',due:'',created:new Date().toISOString(),description:'Extracted from content',subtasks:[]});
    },i*10);
  });
  setTimeout(()=>{save();showToast('Created '+actions.length+' tasks');const p=document.getElementById('action-items-panel');if(p)p.remove();},actions.length*10+100);
}
function showWeeklyPlanner(){
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();const dayOfWeek=now.getDay();
  const monday=new Date(now);monday.setDate(monday.getDate()-(dayOfWeek===0?6:dayOfWeek-1));
  const days=[];
  for(let i=0;i<7;i++){
    const d=new Date(monday);d.setDate(d.getDate()+i);
    const dateStr=d.toISOString().split('T')[0];
    const dayTasks=tasks.filter(t=>t.due===dateStr);
    days.push({date:d,dateStr,name:d.toLocaleDateString('en-US',{weekday:'short'}),dayNum:d.getDate(),tasks:dayTasks,isToday:dateStr===now.toISOString().split('T')[0]});
  }
  const unscheduled=tasks.filter(t=>!t.due).slice(0,10);
  const panel=document.createElement('div');panel.id='weekly-planner-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:750px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Weekly Planner</span><button onclick="document.getElementById('weekly-planner-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:12px">`;
  days.forEach(day=>{
    h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;min-height:120px;border:${day.isToday?'1px solid var(--accent)':'1px solid transparent'}">`;
    h+=`<div style="font-size:10px;font-weight:600;color:${day.isToday?'var(--accent)':'var(--text-primary)'};margin-bottom:6px">${day.name} ${day.dayNum}</div>`;
    if(!day.tasks.length){
      h+=`<div style="font-size:9px;color:var(--text-muted);opacity:0.5">No tasks</div>`;
    } else {
      day.tasks.slice(0,4).forEach(t=>{
        const pColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
        h+=`<div style="font-size:9px;color:var(--text-secondary);padding:2px 4px;margin-bottom:2px;background:var(--bg-base);border-radius:3px;border-left:2px solid ${pColor};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.title)}</div>`;
      });
      if(day.tasks.length>4)h+=`<div style="font-size:8px;color:var(--text-muted)">+${day.tasks.length-4} more</div>`;
    }
    h+=`</div>`;
  });
  h+=`</div>`;
  if(unscheduled.length){
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Unscheduled (${unscheduled.length})</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:4px">`;
    unscheduled.forEach(t=>{
      h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:10px;color:var(--text-secondary)">${esc(t.title.substring(0,30))}</span>`;
    });
    h+=`</div></div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectSwitcher(){
  const projects=S.projects||[];
  const panel=document.createElement('div');panel.id='project-switcher-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=S.tasks||[];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Switch Project</span><button onclick="document.getElementById('project-switcher-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:6px">`;
  projects.forEach(p=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    const done=pTasks.filter(t=>t.status==='done').length;
    const active=pTasks.filter(t=>t.status!=='done').length;
    const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
    const color=colors[projects.indexOf(p)%colors.length];
    h+=`<div onclick="document.getElementById('project-switcher-panel').remove();switchSection('tasks');setTimeout(()=>{const sel=document.querySelector('.task-project-filter');if(sel){sel.value='${esc(p.name)}';sel.dispatchEvent(new Event('change'));}},100)" style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-surface);border-radius:8px;cursor:pointer;border:1px solid transparent;border-left:3px solid ${color};transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent';this.style.borderLeftColor='${color}'">`;
    h+=`<div style="flex:1"><div style="font-size:12px;font-weight:600;color:var(--text-primary)">${esc(p.name)}</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted)">${active} active | ${done} done</div></div>`;
    h+=`<span style="font-size:10px;color:${color};font-weight:600">${pTasks.length}</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskChainsView(){
  const tasks=S.tasks||[];
  const blockedTasks=tasks.filter(t=>t.blockedBy&&t.blockedBy.length);
  const chains=[];
  blockedTasks.forEach(t=>{
    const chain=[t];
    let current=t;
    while(current.blockedBy&&current.blockedBy.length){
      const blocker=tasks.find(x=>x.id===current.blockedBy[0]);
      if(!blocker||chain.includes(blocker))break;
      chain.unshift(blocker);current=blocker;
    }
    if(chain.length>1)chains.push(chain);
  });
  const panel=document.createElement('div');panel.id='task-chains-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Dependency Chains (${chains.length})</span><button onclick="document.getElementById('task-chains-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${blockedTasks.length}</div><div style="font-size:9px;color:var(--text-muted)">Blocked Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">${chains.length}</div><div style="font-size:9px;color:var(--text-muted)">Chains</div></div>`;
  h+=`</div>`;
  if(!chains.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No dependency chains found. Use the "B" (blocked-by) field in task details to create dependencies.</div>`;
  } else {
    chains.forEach((chain,ci)=>{
      h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;margin-bottom:8px"><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Chain ${ci+1} (${chain.length} tasks)</div>`;
      h+=`<div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px">`;
      chain.forEach((t,ti)=>{
        const sColor=t.status==='done'?'#4ade80':t.status==='in-progress'?'#3b82f6':'#f59e0b';
        h+=`<span style="font-size:10px;padding:3px 8px;background:var(--bg-base);border:1px solid ${sColor};border-radius:4px;color:${sColor}">${esc(t.title.substring(0,25))}</span>`;
        if(ti<chain.length-1)h+=`<span style="color:var(--text-muted);font-size:12px">&rarr;</span>`;
      });
      h+=`</div></div>`;
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showThemeBreakdown(){
  const content=S.content||[];
  const themeMap={};
  content.forEach(c=>{const t=c.theme||'untagged';themeMap[t]=(themeMap[t]||0)+1;});
  const sorted=Object.entries(themeMap).sort((a,b)=>b[1]-a[1]);
  const total=content.length||1;
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316','#a855f7','#22d3ee','#84cc16','#e879f9'];
  const panel=document.createElement('div');panel.id='theme-breakdown-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Themes (${sorted.length})</span><button onclick="document.getElementById('theme-breakdown-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;gap:4px;height:24px;border-radius:6px;overflow:hidden;margin-bottom:16px">`;
  sorted.forEach(([theme,count],i)=>{
    const pct=Math.max(2,(count/total)*100);
    h+=`<div title="${theme}: ${count}" style="width:${pct}%;background:${colors[i%colors.length]};min-width:4px"></div>`;
  });
  h+=`</div>`;
  h+=`<div style="display:grid;gap:6px">`;
  sorted.forEach(([theme,count],i)=>{
    const pct=Math.round((count/total)*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<div style="width:12px;height:12px;border-radius:3px;background:${colors[i%colors.length]};flex-shrink:0"></div>`;
    h+=`<div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(theme)}</div></div>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${count} (${pct}%)</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMultiProjectDashboard(){
  const projects=S.projects||[];const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const panel=document.createElement('div');panel.id='multi-project-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  const totalTasks=tasks.length;const totalDone=tasks.filter(t=>t.status==='done').length;
  const totalOverdue=tasks.filter(t=>t.due&&new Date(t.due)<new Date()&&t.status!=='done').length;
  const totalContent=content.length;const totalLinks=links.length;
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Multi-Project Dashboard</span><button onclick="document.getElementById('multi-project-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:var(--accent)">${totalTasks}</div><div style="font-size:8px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#4ade80">${totalDone}</div><div style="font-size:8px;color:var(--text-muted)">Done</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#ef4444">${totalOverdue}</div><div style="font-size:8px;color:var(--text-muted)">Overdue</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#3b82f6">${totalContent}</div><div style="font-size:8px;color:var(--text-muted)">Content</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#f59e0b">${totalLinks}</div><div style="font-size:8px;color:var(--text-muted)">Links</div></div>`;
  h+=`</div>`;
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
  h+=`<div style="display:grid;gap:8px">`;
  projects.forEach((p,pi)=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    const done=pTasks.filter(t=>t.status==='done').length;
    const overdue=pTasks.filter(t=>t.due&&new Date(t.due)<new Date()&&t.status!=='done').length;
    const pct=pTasks.length?Math.round((done/pTasks.length)*100):0;
    const color=colors[pi%colors.length];
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;border-left:3px solid ${color}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
    h+=`<span style="font-size:12px;font-weight:600;color:${color}">${esc(p.name)}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${done}/${pTasks.length} (${pct}%)</span></div>`;
    h+=`<div style="height:5px;background:var(--bg-base);border-radius:3px"><div style="height:100%;width:${pct}%;background:${color};border-radius:3px"></div></div>`;
    if(overdue)h+=`<div style="font-size:9px;color:#ef4444;margin-top:4px">${overdue} overdue</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function exportContentByTheme(){
  const content=S.content||[];
  const themeMap={};
  content.forEach(c=>{const t=c.theme||'untagged';if(!themeMap[t])themeMap[t]=[];themeMap[t].push(c);});
  let md='# Content Export by Theme\n\n';
  md+='Generated: '+new Date().toLocaleString()+'\n\n';
  Object.entries(themeMap).sort((a,b)=>b[1].length-a[1].length).forEach(([theme,items])=>{
    md+=`## ${theme} (${items.length} items)\n\n`;
    items.forEach(c=>{
      const date=c.created?new Date(c.created).toLocaleDateString():'';
      const body=(c.body||'').substring(0,200);
      md+=`### ${date}\n${body}\n\n---\n\n`;
    });
  });
  navigator.clipboard.writeText(md);showToast('Content by theme copied to clipboard ('+content.length+' items)');
}
function showGlobalSearch(initialQuery){
  const panel=document.createElement('div');panel.id='global-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Global Search</span><button onclick="document.getElementById('global-search-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<input id="global-search-input" type="text" value="${initialQuery||''}" placeholder="Search everything..." style="width:100%;padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;margin-bottom:12px;box-sizing:border-box" oninput="runGlobalSearch(this.value)">`;
  h+=`<div id="global-search-results" style="display:grid;gap:4px"></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('global-search-input').focus();
  if(initialQuery)runGlobalSearch(initialQuery);
}
function runGlobalSearch(query){
  const q=query.toLowerCase().trim();const results=document.getElementById('global-search-results');
  if(!results)return;
  if(!q){results.innerHTML='<div style="font-size:11px;color:var(--text-muted);text-align:center;padding:16px">Type to search across all sections</div>';return;}
  const found=[];
  (S.tasks||[]).forEach(t=>{
    if((t.title||'').toLowerCase().includes(q)||(t.description||'').toLowerCase().includes(q)){
      found.push({type:'Task',title:t.title,detail:t.status+' | '+(t.priority||''),color:'#4ade80'});
    }
  });
  (S.content||[]).forEach(c=>{
    if((c.body||'').toLowerCase().includes(q)){
      found.push({type:'Content',title:(c.body||'').substring(0,60),detail:c.theme||'',color:'#3b82f6'});
    }
  });
  (S.links||[]).forEach(l=>{
    if((l.title||'').toLowerCase().includes(q)||(l.url||'').toLowerCase().includes(q)){
      found.push({type:'Link',title:l.title||l.url,detail:l.category||'',color:'#f59e0b'});
    }
  });
  (S.writerDocs||[]).forEach(d=>{
    if((d.title||'').toLowerCase().includes(q)||(d.body||'').toLowerCase().includes(q)){
      found.push({type:'Doc',title:d.title||'Untitled',detail:(d.body||'').split(/\s+/).length+' words',color:'#8b5cf6'});
    }
  });
  let html='';
  if(!found.length){
    html='<div style="font-size:11px;color:var(--text-muted);text-align:center;padding:16px">No results for "'+esc(query)+'"</div>';
  } else {
    html=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">${found.length} results</div>`;
    found.slice(0,20).forEach(r=>{
      html+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:4px;border-left:2px solid ${r.color}">`;
      html+=`<span style="font-size:8px;font-weight:600;color:${r.color};width:40px;flex-shrink:0">${r.type}</span>`;
      html+=`<div style="flex:1;min-width:0"><div style="font-size:10px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(r.title)}</div>`;
      html+=`<div style="font-size:8px;color:var(--text-muted)">${esc(r.detail)}</div></div>`;
      html+=`</div>`;
    });
  }
  results.innerHTML=html;
}
function showNotificationCenter(){
  const notifications=[];const tasks=S.tasks||[];const now=new Date();const today=now.toISOString().split('T')[0];
  const overdue=tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  overdue.forEach(t=>{notifications.push({type:'overdue',icon:'!',color:'#ef4444',title:'Overdue: '+t.title,detail:'Due '+t.due});});
  const dueToday=tasks.filter(t=>t.due===today&&t.status!=='done');
  dueToday.forEach(t=>{notifications.push({type:'today',icon:'T',color:'#f59e0b',title:'Due today: '+t.title,detail:t.priority||''});});
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  if(inProgress.length>5)notifications.push({type:'wip',icon:'W',color:'#3b82f6',title:'WIP Warning',detail:inProgress.length+' tasks in progress (recommend <5)'});
  const sd=S._streakData||{};
  if(sd.currentStreak>=7)notifications.push({type:'streak',icon:'S',color:'#4ade80',title:'Streak: '+sd.currentStreak+' days!',detail:'Keep it going!'});
  const storageSize=new Blob([JSON.stringify(S)]).size;
  if(storageSize>4*1024*1024)notifications.push({type:'storage',icon:'D',color:'#f97316',title:'Storage Warning',detail:Math.round(storageSize/1024)+'KB used (approaching 5MB limit)'});
  const panel=document.createElement('div');panel.id='notification-center-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Notifications (${notifications.length})</span><button onclick="document.getElementById('notification-center-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!notifications.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">All clear! No notifications.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    notifications.forEach(n=>{
      h+=`<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${n.color}">`;
      h+=`<div style="width:28px;height:28px;border-radius:50%;background:${n.color}20;display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:12px;font-weight:700;color:${n.color}">${n.icon}</span></div>`;
      h+=`<div style="flex:1"><div style="font-size:11px;font-weight:600;color:var(--text-primary)">${esc(n.title)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${esc(n.detail)}</div></div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function trackDailyStats(){
  if(!S._dailyStats)S._dailyStats=[];
  const today=new Date().toISOString().split('T')[0];
  const existing=S._dailyStats.find(d=>d.date===today);
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const stats={
    date:today,
    tasks:tasks.length,
    done:tasks.filter(t=>t.status==='done').length,
    content:content.length,
    links:links.length,
    words:content.reduce((a,c)=>a+((c.body||'').split(/\s+/).filter(w=>w).length),0),
    storage:Math.round(new Blob([JSON.stringify(S)]).size/1024)
  };
  if(existing){Object.assign(existing,stats);}
  else{S._dailyStats.push(stats);if(S._dailyStats.length>90)S._dailyStats=S._dailyStats.slice(-90);}
  save();
}
function showStatsHistory(){
  trackDailyStats();
  const stats=S._dailyStats||[];
  const panel=document.createElement('div');panel.id='stats-history-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Stats History (${stats.length} days)</span><button onclick="document.getElementById('stats-history-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(stats.length<2){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">Not enough history yet. Check back tomorrow!</div>`;
  } else {
    const recent=stats.slice(-14);
    const maxTasks=Math.max(...recent.map(s=>s.tasks),1);
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Task Growth (last ${recent.length} days)</div>`;
    h+=`<div style="display:flex;align-items:end;gap:4px;height:100px;margin-bottom:16px;padding:4px;background:var(--bg-surface);border-radius:8px">`;
    recent.forEach(s=>{
      const height=Math.round((s.tasks/maxTasks)*80);
      const doneHeight=Math.round((s.done/maxTasks)*80);
      h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end" title="${s.date}: ${s.tasks} tasks, ${s.done} done">`;
      h+=`<div style="width:100%;height:${height}px;background:var(--accent);border-radius:2px 2px 0 0;position:relative">`;
      h+=`<div style="position:absolute;bottom:0;width:100%;height:${doneHeight}px;background:#1a4731;border-radius:0 0 2px 2px"></div>`;
      h+=`</div></div>`;
    });
    h+=`</div>`;
    h+=`<div style="display:grid;gap:4px">`;
    stats.slice(-7).reverse().forEach(s=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:4px;font-size:10px">`;
      h+=`<span style="color:var(--text-muted);width:65px;flex-shrink:0">${s.date.substring(5)}</span>`;
      h+=`<span style="color:var(--accent)">Tasks: ${s.tasks}</span>`;
      h+=`<span style="color:#4ade80">Done: ${s.done}</span>`;
      h+=`<span style="color:#3b82f6">Content: ${s.content}</span>`;
      h+=`<span style="color:#f59e0b">Links: ${s.links}</span>`;
      h+=`<span style="color:var(--text-muted)">${s.storage}KB</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showKanbanFilters(){
  const projects=S.projects||[];
  const panel=document.createElement('div');panel.id='kanban-filters-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  if(!S._kanbanFilters)S._kanbanFilters={priority:'all',project:'all',dueSoon:false};
  const kf=S._kanbanFilters;
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Board Filters</span><button onclick="document.getElementById('kanban-filters-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Priority</div>`;
  h+=`<div style="display:flex;gap:6px;flex-wrap:wrap">`;
  ['all','p0','p1','p2','p3'].forEach(p=>{
    const selected=kf.priority===p;
    const color=p==='p0'?'#ef4444':p==='p1'?'#f59e0b':p==='p2'?'#3b82f6':p==='p3'?'#6b7280':'var(--accent)';
    h+=`<button onclick="S._kanbanFilters.priority='${p}';save();document.getElementById('kanban-filters-panel').remove();showKanbanFilters()" style="padding:4px 12px;border-radius:4px;border:1px solid ${selected?color:'var(--border)'};background:${selected?color+'20':'var(--bg-surface)'};color:${selected?color:'var(--text-muted)'};cursor:pointer;font-size:10px;font-weight:${selected?'600':'400'}">${p==='all'?'All':p.toUpperCase()}</button>`;
  });
  h+=`</div></div>`;
  h+=`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Project</div>`;
  h+=`<select onchange="S._kanbanFilters.project=this.value;save()" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px">`;
  h+=`<option value="all" ${kf.project==='all'?'selected':''}>All Projects</option>`;
  projects.forEach(p=>{h+=`<option value="${esc(p.name)}" ${kf.project===p.name?'selected':''}>${esc(p.name)}</option>`;});
  h+=`</select></div>`;
  h+=`<div style="margin-bottom:16px"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ${kf.dueSoon?'checked':''} onchange="S._kanbanFilters.dueSoon=this.checked;save()"><span style="font-size:11px;color:var(--text-secondary)">Show only due within 7 days</span></label></div>`;
  h+=`<button onclick="S._kanbanFilters={priority:'all',project:'all',dueSoon:false};save();document.getElementById('kanban-filters-panel').remove();renderTasks()" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);cursor:pointer;font-size:11px">Reset Filters</button>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showScratchpad(){
  if(!S._scratchpad)S._scratchpad='';
  const panel=document.createElement('div');panel.id='scratchpad-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Scratchpad</span><div><button onclick="navigator.clipboard.writeText(document.getElementById('scratchpad-textarea').value);showToast('Copied')" style="font-size:10px;padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);cursor:pointer;margin-right:8px">Copy</button><button onclick="document.getElementById('scratchpad-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  h+=`<textarea id="scratchpad-textarea" style="width:100%;height:300px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;padding:12px;resize:vertical;font-family:monospace;line-height:1.6;box-sizing:border-box" oninput="S._scratchpad=this.value;save()" placeholder="Quick notes, scratch work, temporary ideas...">${esc(S._scratchpad)}</textarea>`;
  h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:6px;text-align:right">${S._scratchpad.split(/\s+/).filter(w=>w).length} words | Auto-saved</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('scratchpad-textarea').focus();
}
function printableExport(){
  const tasks=S.tasks||[];const content=S.content||[];
  let html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>ASTRA Export</title>';
  html+='<style>body{font-family:system-ui;max-width:800px;margin:0 auto;padding:20px;color:#222}h1{border-bottom:2px solid #333}h2{color:#444;margin-top:24px}table{width:100%;border-collapse:collapse;margin:12px 0}th,td{border:1px solid #ddd;padding:6px 10px;text-align:left;font-size:12px}th{background:#f5f5f5;font-weight:600}.done{text-decoration:line-through;color:#999}.p0{color:#dc2626}.p1{color:#d97706}.p2{color:#2563eb}.overdue{color:#dc2626;font-weight:600}@media print{body{font-size:11px}}</style>';
  html+='</head><body>';
  html+=`<h1>ASTRA Command Center Export</h1><p>Generated: ${new Date().toLocaleString()}</p>`;
  html+='<h2>Tasks ('+tasks.length+')</h2><table><tr><th>Title</th><th>Status</th><th>Priority</th><th>Due</th></tr>';
  tasks.slice(0,50).forEach(t=>{
    const isDone=t.status==='done';
    const isOverdue=t.due&&new Date(t.due)<new Date()&&!isDone;
    html+=`<tr class="${isDone?'done':''}"><td>${esc(t.title)}</td><td>${t.status}</td><td class="${t.priority||''}">${(t.priority||'p3').toUpperCase()}</td><td class="${isOverdue?'overdue':''}">${t.due||'-'}</td></tr>`;
  });
  html+='</table>';
  html+='<h2>Content ('+content.length+')</h2>';
  content.slice(0,20).forEach(c=>{
    html+=`<div style="border-left:3px solid #4ade80;padding:8px 12px;margin:8px 0;background:#f9f9f9"><p style="font-size:11px;color:#666">${c.theme||''} | ${c.created?new Date(c.created).toLocaleDateString():''}</p><p>${esc((c.body||'').substring(0,300))}</p></div>`;
  });
  html+='</body></html>';
  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='astra-export-'+new Date().toISOString().split('T')[0]+'.html';
  a.click();URL.revokeObjectURL(url);
  showToast('Printable HTML exported');
}
function contentToSlides(){
  const content=S.content||[];
  if(!content.length){showToast('No content to convert');return;}
  let html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>ASTRA Slides</title>';
  html+='<style>*{margin:0;padding:0;box-sizing:border-box}body{background:#0a0a0a;color:#e5e5e5;font-family:system-ui}';
  html+='.slide{width:100vw;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:60px;text-align:center;page-break-after:always}';
  html+='.slide h2{font-size:36px;margin-bottom:20px;color:#4ade80}.slide p{font-size:18px;line-height:1.8;max-width:700px;color:#a3a3a3}';
  html+='.slide-num{position:fixed;bottom:20px;right:20px;font-size:12px;color:#555}';
  html+='.title-slide{background:linear-gradient(135deg,#050508,#0a1628)}.title-slide h1{font-size:48px;color:#4ade80;margin-bottom:16px}.title-slide p{font-size:20px}';
  html+='@media print{.slide{page-break-after:always}}</style></head><body>';
  html+=`<div class="slide title-slide"><h1>ASTRA Content</h1><p>${new Date().toLocaleDateString()} | ${content.length} items</p></div>`;
  content.slice(0,20).forEach((c,i)=>{
    const body=(c.body||'').substring(0,500);
    const theme=c.theme||'';
    html+=`<div class="slide"><h2>${esc(theme||'Note '+(i+1))}</h2><p>${esc(body)}</p></div>`;
  });
  html+='</body></html>';
  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='astra-slides-'+new Date().toISOString().split('T')[0]+'.html';
  a.click();URL.revokeObjectURL(url);
  showToast('Slides exported ('+Math.min(content.length,20)+' slides)');
}
function showWorkloadIndicator(){
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();const today=now.toISOString().split('T')[0];
  const days=[];
  for(let i=0;i<14;i++){
    const d=new Date(now);d.setDate(d.getDate()+i);
    const dateStr=d.toISOString().split('T')[0];
    const dayTasks=tasks.filter(t=>t.due===dateStr);
    days.push({date:d,dateStr,name:d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),count:dayTasks.length,isToday:dateStr===today});
  }
  const maxLoad=Math.max(...days.map(d=>d.count),1);
  const panel=document.createElement('div');panel.id='workload-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Workload Forecast (14 days)</span><button onclick="document.getElementById('workload-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;align-items:end;gap:6px;height:120px;padding:4px;background:var(--bg-surface);border-radius:8px;margin-bottom:12px">`;
  days.forEach(day=>{
    const height=day.count?Math.max(20,Math.round((day.count/maxLoad)*100)):4;
    const color=day.count>=4?'#ef4444':day.count>=2?'#f59e0b':day.count>=1?'#4ade80':'rgba(255,255,255,0.05)';
    h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end" title="${day.name}: ${day.count} tasks">`;
    h+=`<div style="font-size:8px;color:var(--text-muted);margin-bottom:2px">${day.count||''}</div>`;
    h+=`<div style="width:100%;height:${height}px;background:${color};border-radius:3px 3px 0 0;border:${day.isToday?'2px solid var(--accent)':'none'}"></div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  h+=`<div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:center">`;
  days.forEach(day=>{
    h+=`<span style="font-size:7px;color:${day.isToday?'var(--accent)':'var(--text-muted)'};width:${100/14}%;text-align:center">${day.name.split(',')[0].split(' ')[0]}</span>`;
  });
  h+=`</div>`;
  const overloaded=days.filter(d=>d.count>=4);
  if(overloaded.length){
    h+=`<div style="margin-top:12px;padding:8px;background:rgba(239,68,68,0.1);border:1px solid #ef4444;border-radius:6px;font-size:10px;color:#ef4444">Warning: ${overloaded.length} day(s) with 4+ tasks. Consider redistributing.</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMiniDatePicker(taskId){
  const task=(S.tasks||[]).find(t=>t.id===taskId);
  if(!task)return;
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const panel=document.createElement('div');panel.id='mini-datepicker';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1600;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:12px;font-weight:600;color:var(--text-primary)">${monthName}</span><button onclick="document.getElementById('mini-datepicker').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">&times;</button></div>`;
  h+=`<div style="font-size:10px;color:var(--text-primary);margin-bottom:4px">Set due date for: ${esc(task.title.substring(0,30))}</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:8px">`;
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d=>{h+=`<div style="text-align:center;font-size:9px;color:var(--text-muted);padding:2px">${d}</div>`;});
  for(let i=0;i<firstDay;i++)h+=`<div></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=d===now.getDate();
    const isSelected=task.due===dateStr;
    h+=`<button onclick="setTaskDueDate('${taskId}','${dateStr}')" style="padding:6px;text-align:center;font-size:10px;border-radius:4px;border:${isSelected?'1px solid var(--accent)':isToday?'1px solid var(--text-muted)':'1px solid transparent'};background:${isSelected?'var(--accent)':'var(--bg-surface)'};color:${isSelected?'#000':'var(--text-primary)'};cursor:pointer">${d}</button>`;
  }
  h+=`</div>`;
  h+=`<div style="display:flex;gap:6px;margin-top:10px">`;
  h+=`<button onclick="setTaskDueDate('${taskId}','')" style="flex:1;padding:6px;font-size:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-muted);cursor:pointer">Clear</button>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function setTaskDueDate(taskId,dateStr){
  const task=(S.tasks||[]).find(t=>t.id===taskId);if(!task)return;
  task.due=dateStr;save();
  document.getElementById('mini-datepicker').remove();
  showToast(dateStr?'Due date set: '+dateStr:'Due date cleared');
}
function showGratitudeJournal(){
  if(!S._gratitude)S._gratitude=[];
  const today=new Date().toISOString().split('T')[0];
  const panel=document.createElement('div');panel.id='gratitude-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Gratitude Journal</span><button onclick="document.getElementById('gratitude-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const todayEntry=S._gratitude.find(g=>g.date===today);
  h+=`<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:6px">${new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}</div>`;
  h+=`<textarea id="gratitude-input" style="width:100%;height:80px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;padding:10px;resize:none;box-sizing:border-box" placeholder="What are you grateful for today?">${todayEntry?esc(todayEntry.text):''}</textarea>`;
  h+=`<button onclick="saveGratitude()" style="margin-top:6px;padding:6px 16px;background:var(--accent);border:none;border-radius:4px;color:#000;font-weight:600;cursor:pointer;font-size:11px">Save</button></div>`;
  const recent=S._gratitude.filter(g=>g.date!==today).slice(0,10);
  if(recent.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Recent Entries (${S._gratitude.length} total)</div>`;
    h+=`<div style="display:grid;gap:6px">`;
    recent.forEach(g=>{
      h+=`<div style="padding:8px;background:var(--bg-surface);border-radius:6px;border-left:2px solid var(--accent)">`;
      h+=`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">${new Date(g.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</div>`;
      h+=`<div style="font-size:11px;color:var(--text-secondary);line-height:1.5">${esc(g.text)}</div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">Streak: ${calcGratitudeStreak()} days</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function saveGratitude(){
  const input=document.getElementById('gratitude-input');if(!input)return;
  const text=input.value.trim();if(!text)return;
  const today=new Date().toISOString().split('T')[0];
  if(!S._gratitude)S._gratitude=[];
  const existing=S._gratitude.findIndex(g=>g.date===today);
  if(existing>=0){S._gratitude[existing].text=text;}
  else{S._gratitude.unshift({date:today,text});}
  if(S._gratitude.length>365)S._gratitude=S._gratitude.slice(0,365);
  save();showToast('Gratitude saved');
}
function calcGratitudeStreak(){
  const entries=S._gratitude||[];if(!entries.length)return 0;
  const dates=entries.map(g=>g.date).sort().reverse();
  let streak=0;const now=new Date();
  for(let i=0;i<dates.length;i++){
    const expected=new Date(now);expected.setDate(expected.getDate()-i);
    if(dates[i]===expected.toISOString().split('T')[0])streak++;else break;
  }
  return streak;
}
function showTaskTemplateLibrary(){
  const templates=[
    {name:'Bug Fix',title:'Fix: ',priority:'p1',desc:'Steps to reproduce:\\n1. \\n\\nExpected:\\n\\nActual:\\n'},
    {name:'Feature Request',title:'Feature: ',priority:'p2',desc:'As a user, I want to...\\n\\nAcceptance criteria:\\n- [ ] \\n'},
    {name:'Research',title:'Research: ',priority:'p2',desc:'Questions to answer:\\n1. \\n\\nSources:\\n- \\n\\nFindings:\\n'},
    {name:'Meeting Follow-up',title:'Follow-up: ',priority:'p1',desc:'Meeting: \\nDate: '+new Date().toLocaleDateString()+'\\n\\nAction items:\\n- [ ] \\n'},
    {name:'Content Creation',title:'Create: ',priority:'p2',desc:'Topic: \\nAudience: \\nFormat: \\n\\nOutline:\\n1. \\n'},
    {name:'Code Review',title:'Review: ',priority:'p1',desc:'PR/Branch: \\n\\nChecklist:\\n- [ ] Tests pass\\n- [ ] No security issues\\n- [ ] Code is readable\\n'},
    {name:'Weekly Goal',title:'Week Goal: ',priority:'p1',desc:'Target: \\nDeadline: Friday\\n\\nMilestones:\\n- [ ] Mon: \\n- [ ] Wed: \\n- [ ] Fri: \\n'},
    {name:'Learning',title:'Learn: ',priority:'p3',desc:'Resource: \\nTime: \\n\\nNotes:\\n\\nKey takeaways:\\n1. \\n'},
  ];
  const panel=document.createElement('div');panel.id='task-template-lib-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Templates (${templates.length})</span><button onclick="document.getElementById('task-template-lib-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">`;
  templates.forEach((t,i)=>{
    const pColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
    h+=`<div onclick="createFromTaskTemplate(${i})" style="padding:12px;background:var(--bg-surface);border-radius:8px;cursor:pointer;border:1px solid transparent;border-left:3px solid ${pColor};transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent';this.style.borderLeftColor='${pColor}'">`;
    h+=`<div style="font-size:12px;font-weight:600;color:var(--text-primary)">${t.name}</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:4px">${t.desc.replace(/\\n/g,' ').substring(0,50)}...</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  window._taskTemplates=templates;
}
function createFromTaskTemplate(idx){
  const templates=window._taskTemplates;if(!templates||!templates[idx])return;
  const t=templates[idx];
  const title=prompt('Task title:',t.title);if(!title)return;
  if(!S.tasks)S.tasks=[];
  S.tasks.unshift({id:'t_'+Date.now(),title,status:'todo',priority:t.priority,project:'',due:'',created:new Date().toISOString(),description:t.desc.replace(/\\n/g,'\n'),subtasks:[]});
  save();const p=document.getElementById('task-template-lib-panel');if(p)p.remove();
  switchSection('tasks');renderTasks();showToast('Task created from template: '+t.name);
}
function showLifetimePomodoroStats(){
  const sessions=S._focusSessions||[];
  const totalMins=sessions.reduce((a,s)=>a+(s.duration||0),0);
  const totalSessions=sessions.length;
  const avgPerSession=totalSessions?Math.round(totalMins/totalSessions):0;
  const dayMap={};
  sessions.forEach(s=>{if(s.date){const d=s.date.split('T')[0];dayMap[d]=(dayMap[d]||0)+(s.duration||0);}});
  const activeDays=Object.keys(dayMap).length;
  const bestDay=Object.entries(dayMap).sort((a,b)=>b[1]-a[1])[0];
  const avgPerDay=activeDays?Math.round(totalMins/activeDays):0;
  const panel=document.createElement('div');panel.id='lifetime-pomo-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Lifetime Focus Stats</span><button onclick="document.getElementById('lifetime-pomo-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:var(--accent)">${Math.round(totalMins/60)}h</div><div style="font-size:9px;color:var(--text-muted)">Total Focus Time</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:#3b82f6">${totalSessions}</div><div style="font-size:9px;color:var(--text-muted)">Sessions</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:#f59e0b">${activeDays}</div><div style="font-size:9px;color:var(--text-muted)">Active Days</div></div>`;
  h+=`</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:16px;font-weight:600;color:#8b5cf6">${avgPerSession}m</div><div style="font-size:8px;color:var(--text-muted)">Avg/Session</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:16px;font-weight:600;color:#ec4899">${avgPerDay}m</div><div style="font-size:8px;color:var(--text-muted)">Avg/Day</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:16px;font-weight:600;color:#06b6d4">${bestDay?bestDay[1]+'m':'-'}</div><div style="font-size:8px;color:var(--text-muted)">Best Day</div></div>`;
  h+=`</div>`;
  if(bestDay)h+=`<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:8px">Best day: ${bestDay[0]}</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showCreationCalendar(){
  const content=S.content||[];const now=new Date();
  const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const dayMap={};
  content.forEach(c=>{
    if(c.created){
      const d=c.created.split('T')[0];
      const parts=d.split('-');if(parseInt(parts[0])===year&&parseInt(parts[1])-1===month){
        const day=parseInt(parts[2]);dayMap[day]=(dayMap[day]||0)+1;
      }
    }
  });
  const panel=document.createElement('div');panel.id='creation-calendar-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Creation Calendar</span><button onclick="document.getElementById('creation-calendar-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="text-align:center;font-size:12px;font-weight:600;color:var(--accent);margin-bottom:12px">${monthName}</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px">`;
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d=>{h+=`<div style="text-align:center;font-size:9px;color:var(--text-muted);padding:4px">${d}</div>`;});
  for(let i=0;i<firstDay;i++)h+=`<div></div>`;
  const maxCount=Math.max(...Object.values(dayMap),1);
  for(let d=1;d<=daysInMonth;d++){
    const count=dayMap[d]||0;
    const isToday=d===now.getDate();
    const intensity=count?Math.max(0.2,(count/maxCount)):0;
    h+=`<div title="Day ${d}: ${count} items" style="text-align:center;padding:8px 4px;border-radius:4px;font-size:10px;color:${isToday?'var(--accent)':'var(--text-primary)'};background:${count?'rgba(74,222,128,'+intensity+')':'var(--bg-surface)'};border:${isToday?'1px solid var(--accent)':'1px solid transparent'};font-weight:${isToday?'700':'400'}">${d}${count?'<div style="font-size:7px;color:var(--text-muted)">'+count+'</div>':''}</div>`;
  }
  h+=`</div>`;
  const totalThisMonth=Object.values(dayMap).reduce((a,b)=>a+b,0);
  h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:12px">${totalThisMonth} items created this month</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showSmartSuggestions(){
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const now=new Date();const today=now.toISOString().split('T')[0];
  const suggestions=[];
  const overdue=tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  if(overdue.length)suggestions.push({icon:'!',color:'#ef4444',text:`You have ${overdue.length} overdue tasks. Review and reschedule them.`,action:'Cmd+K > due groups'});
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  if(inProgress.length>5)suggestions.push({icon:'W',color:'#f59e0b',text:`${inProgress.length} tasks in progress. Consider completing some before starting new ones.`,action:'Focus on finishing'});
  if(inProgress.length===0&&tasks.filter(t=>t.status==='todo').length>0)suggestions.push({icon:'G',color:'#4ade80',text:'No tasks in progress. Start working on your highest priority todo.',action:'Move a task to in-progress'});
  const untagged=content.filter(c=>!(c.tags&&c.tags.length));
  if(untagged.length>5)suggestions.push({icon:'T',color:'#8b5cf6',text:`${untagged.length} content items lack tags. Tag them for better organization.`,action:'Cmd+K > auto tag'});
  const unreadLinks=links.filter(l=>l.category==='read-later');
  if(unreadLinks.length>10)suggestions.push({icon:'R',color:'#3b82f6',text:`${unreadLinks.length} links in "read later". Set aside time to review them.`,action:'Switch to Links section'});
  const sd=S._streakData||{};
  if(sd.lastActive!==today)suggestions.push({icon:'S',color:'#f59e0b',text:'You haven\'t logged activity today. Open any feature to start your streak!',action:'Track your streak'});
  if(!suggestions.length)suggestions.push({icon:'v',color:'#4ade80',text:'Everything looks great! Keep up the good work.',action:'No action needed'});
  const panel=document.createElement('div');panel.id='smart-suggestions-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Smart Suggestions (${suggestions.length})</span><button onclick="document.getElementById('smart-suggestions-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:8px">`;
  suggestions.forEach(s=>{
    h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${s.color}">`;
    h+=`<div style="display:flex;align-items:start;gap:10px"><div style="width:24px;height:24px;border-radius:50%;background:${s.color}20;display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:11px;font-weight:700;color:${s.color}">${s.icon}</span></div>`;
    h+=`<div><div style="font-size:11px;color:var(--text-primary);line-height:1.5">${esc(s.text)}</div>`;
    h+=`<div style="font-size:9px;color:var(--accent);margin-top:4px">${esc(s.action)}</div></div></div></div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showLinkCategoryChart(){
  const links=S.links||[];
  const catMap={};links.forEach(l=>{const c=l.category||'uncategorized';catMap[c]=(catMap[c]||0)+1;});
  const sorted=Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const total=links.length||1;
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316'];
  const panel=document.createElement('div');panel.id='link-category-chart';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Link Categories (${sorted.length})</span><button onclick="document.getElementById('link-category-chart').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;gap:3px;height:20px;border-radius:6px;overflow:hidden;margin-bottom:16px">`;
  sorted.forEach(([cat,count],i)=>{
    const pct=Math.max(3,(count/total)*100);
    h+=`<div title="${cat}: ${count}" style="width:${pct}%;background:${colors[i%colors.length]};min-width:4px"></div>`;
  });
  h+=`</div>`;
  h+=`<div style="display:grid;gap:6px">`;
  sorted.forEach(([cat,count],i)=>{
    const pct=Math.round((count/total)*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<div style="width:10px;height:10px;border-radius:3px;background:${colors[i%colors.length]};flex-shrink:0"></div>`;
    h+=`<span style="flex:1;font-size:11px;color:var(--text-primary)">${esc(cat)}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${count} (${pct}%)</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showPriorityDistribution(){
  const tasks=S.tasks||[];
  const pMap={p0:0,p1:0,p2:0,p3:0};
  tasks.forEach(t=>{const p=t.priority||'p3';pMap[p]=(pMap[p]||0)+1;});
  const total=tasks.length||1;
  const items=[
    {key:'p0',name:'P0 Critical',color:'#ef4444',count:pMap.p0},
    {key:'p1',name:'P1 High',color:'#f59e0b',count:pMap.p1},
    {key:'p2',name:'P2 Medium',color:'#3b82f6',count:pMap.p2},
    {key:'p3',name:'P3 Low',color:'#6b7280',count:pMap.p3},
  ];
  const panel=document.createElement('div');panel.id='priority-dist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Priority Distribution</span><button onclick="document.getElementById('priority-dist-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;gap:3px;height:24px;border-radius:6px;overflow:hidden;margin-bottom:16px">`;
  items.forEach(item=>{
    const pct=Math.max(2,(item.count/total)*100);
    h+=`<div style="width:${pct}%;background:${item.color};min-width:4px"></div>`;
  });
  h+=`</div>`;
  h+=`<div style="display:grid;gap:8px">`;
  items.forEach(item=>{
    const pct=Math.round((item.count/total)*100);
    h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<div style="width:14px;height:14px;border-radius:4px;background:${item.color};flex-shrink:0"></div>`;
    h+=`<span style="flex:1;font-size:12px;color:var(--text-primary)">${item.name}</span>`;
    h+=`<span style="font-size:14px;font-weight:700;color:${item.color}">${item.count}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${pct}%</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMoodTracker(){
  if(!S._moods)S._moods=[];
  const today=new Date().toISOString().split('T')[0];
  const moods=[
    {emoji:'Great',value:5,color:'#4ade80'},
    {emoji:'Good',value:4,color:'#22d3ee'},
    {emoji:'Okay',value:3,color:'#f59e0b'},
    {emoji:'Low',value:2,color:'#f97316'},
    {emoji:'Bad',value:1,color:'#ef4444'},
  ];
  const todayMood=S._moods.find(m=>m.date===today);
  const panel=document.createElement('div');panel.id='mood-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Mood Tracker</span><button onclick="document.getElementById('mood-tracker-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="font-size:11px;color:var(--accent);margin-bottom:12px">How are you feeling today?</div>`;
  h+=`<div style="display:flex;gap:8px;justify-content:center;margin-bottom:20px">`;
  moods.forEach(m=>{
    const selected=todayMood&&todayMood.value===m.value;
    h+=`<button onclick="logMood(${m.value})" style="padding:10px 14px;border-radius:8px;border:2px solid ${selected?m.color:'var(--border)'};background:${selected?m.color+'20':'var(--bg-surface)'};color:${m.color};cursor:pointer;font-size:11px;font-weight:${selected?'700':'400'};min-width:55px">${m.emoji}</button>`;
  });
  h+=`</div>`;
  const recent=S._moods.slice(0,14);
  if(recent.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Last 14 Days</div>`;
    h+=`<div style="display:flex;align-items:end;gap:4px;height:60px;margin-bottom:8px">`;
    recent.reverse().forEach(m=>{
      const mood=moods.find(x=>x.value===m.value)||moods[2];
      const height=m.value*12;
      h+=`<div title="${m.date}: ${mood.emoji}" style="flex:1;height:${height}px;background:${mood.color};border-radius:3px 3px 0 0;min-width:4px"></div>`;
    });
    h+=`</div>`;
    const avg=S._moods.reduce((a,m)=>a+m.value,0)/S._moods.length;
    const avgMood=moods.find(m=>m.value===Math.round(avg))||moods[2];
    h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center">Average: <span style="color:${avgMood.color}">${avgMood.emoji}</span> (${avg.toFixed(1)}/5) | ${S._moods.length} entries</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function logMood(value){
  if(!S._moods)S._moods=[];
  const today=new Date().toISOString().split('T')[0];
  const existing=S._moods.findIndex(m=>m.date===today);
  if(existing>=0){S._moods[existing].value=value;}
  else{S._moods.unshift({date:today,value});}
  if(S._moods.length>365)S._moods=S._moods.slice(0,365);
  save();const p=document.getElementById('mood-tracker-panel');if(p)p.remove();showMoodTracker();showToast('Mood logged');
}
function showRepoTimeline(){
  const repos=S.repos||[];
  if(!repos.length){showToast('No repos configured');return;}
  const panel=document.createElement('div');panel.id='repo-timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6'];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Repo Overview (${repos.length})</span><button onclick="document.getElementById('repo-timeline-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:8px">`;
  repos.forEach((r,i)=>{
    const color=colors[i%colors.length];
    const statusColor=r.status==='active'?'#4ade80':r.status==='complete'?'#3b82f6':'#6b7280';
    h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${color}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
    h+=`<span style="font-size:12px;font-weight:600;color:${color}">${esc(r.name)}</span>`;
    h+=`<span style="font-size:9px;padding:2px 8px;border-radius:10px;background:${statusColor}20;color:${statusColor}">${r.status||'unknown'}</span></div>`;
    if(r.live)h+=`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">${esc(r.live)}</div>`;
    if(r.url)h+=`<div style="font-size:9px;color:var(--text-muted)">${esc(r.url)}</div>`;
    if(r.lastCommit)h+=`<div style="font-size:9px;color:var(--accent);margin-top:4px">Last commit: ${esc(r.lastCommit)}</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:12px">${repos.filter(r=>r.status==='active').length} active | ${repos.filter(r=>r.status==='complete').length} complete</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMicroJournal(){
  if(!S._microJournal)S._microJournal=[];
  const today=new Date().toISOString().split('T')[0];
  const panel=document.createElement('div');panel.id='micro-journal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Micro Journal</span><button onclick="document.getElementById('micro-journal-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;gap:6px;margin-bottom:16px"><input id="micro-journal-input" type="text" placeholder="One-liner for today..." style="flex:1;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px" onkeydown="if(event.key==='Enter')saveMicroJournal()">`;
  h+=`<button onclick="saveMicroJournal()" style="padding:8px 14px;background:var(--accent);border:none;border-radius:6px;color:#000;font-weight:600;cursor:pointer;font-size:11px">Save</button></div>`;
  const entries=S._microJournal.slice(0,30);
  if(entries.length){
    h+=`<div style="display:grid;gap:4px">`;
    entries.forEach(e=>{
      const dayName=new Date(e.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:4px;border-left:2px solid var(--accent)">`;
      h+=`<span style="font-size:9px;color:var(--text-muted);width:55px;flex-shrink:0">${dayName}</span>`;
      h+=`<span style="font-size:11px;color:var(--text-secondary)">${esc(e.text)}</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  h+=`<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:8px">${S._microJournal.length} total entries</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('micro-journal-input').focus();
}
function saveMicroJournal(){
  const input=document.getElementById('micro-journal-input');if(!input)return;
  const text=input.value.trim();if(!text)return;
  if(!S._microJournal)S._microJournal=[];
  S._microJournal.unshift({date:new Date().toISOString().split('T')[0],text,ts:Date.now()});
  if(S._microJournal.length>365)S._microJournal=S._microJournal.slice(0,365);
  save();const p=document.getElementById('micro-journal-panel');if(p)p.remove();showMicroJournal();showToast('Journal entry saved');
}
function showCompletionRate(){
  const tasks=S.tasks||[];const now=new Date();
  const weeks=[];
  for(let w=7;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-w*7);
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+7);
    const wStart=weekStart.toISOString().split('T')[0];
    const wEnd=weekEnd.toISOString().split('T')[0];
    const created=tasks.filter(t=>t.created&&t.created>=wStart&&t.created<wEnd).length;
    const completed=tasks.filter(t=>t.status==='done'&&t.created&&t.created>=wStart&&t.created<wEnd).length;
    const rate=created?Math.round((completed/created)*100):0;
    weeks.push({label:weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'}),created,completed,rate});
  }
  const panel=document.createElement('div');panel.id='completion-rate-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Weekly Completion Rate</span><button onclick="document.getElementById('completion-rate-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:6px">`;
  weeks.forEach(w=>{
    const rateColor=w.rate>=75?'#4ade80':w.rate>=50?'#f59e0b':'#ef4444';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<span style="font-size:10px;color:var(--text-muted);width:55px;flex-shrink:0">${w.label}</span>`;
    h+=`<div style="flex:1;height:8px;background:var(--bg-base);border-radius:4px"><div style="height:100%;width:${w.rate}%;background:${rateColor};border-radius:4px"></div></div>`;
    h+=`<span style="font-size:11px;font-weight:600;color:${rateColor};width:40px;text-align:right">${w.rate}%</span>`;
    h+=`<span style="font-size:9px;color:var(--text-muted);width:50px;text-align:right">${w.completed}/${w.created}</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function exportContentAsBook(){
  const content=S.content||[];const docs=S.writerDocs||[];
  let md='# ASTRA Content Collection\n\n';
  md+='*Exported: '+new Date().toLocaleString()+'*\n\n---\n\n';
  md+='## Table of Contents\n\n';
  const themes=new Set();content.forEach(c=>{if(c.theme)themes.add(c.theme);});
  let chapNum=1;
  themes.forEach(t=>{md+=`${chapNum}. ${t}\n`;chapNum++;});
  if(docs.length)md+=`${chapNum}. Writer Documents\n`;
  md+='\n---\n\n';
  chapNum=1;
  themes.forEach(theme=>{
    md+=`## Chapter ${chapNum}: ${theme}\n\n`;
    const items=content.filter(c=>c.theme===theme);
    items.forEach(c=>{
      const date=c.created?new Date(c.created).toLocaleDateString():'';
      md+=`### ${date}\n\n${c.body||''}\n\n---\n\n`;
    });
    chapNum++;
  });
  const unthemed=content.filter(c=>!c.theme);
  if(unthemed.length){
    md+=`## Miscellaneous\n\n`;
    unthemed.forEach(c=>{md+=`${c.body||''}\n\n---\n\n`;});
  }
  if(docs.length){
    md+=`## Writer Documents\n\n`;
    docs.forEach(d=>{md+=`### ${d.title||'Untitled'}\n\n${d.body||''}\n\n---\n\n`;});
  }
  const blob=new Blob([md],{type:'text/markdown'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='astra-content-book-'+new Date().toISOString().split('T')[0]+'.md';
  a.click();URL.revokeObjectURL(url);
  showToast('Content book exported ('+content.length+' items, '+docs.length+' docs)');
}
function showWorkspaceOverview(){
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];const docs=S.writerDocs||[];const projects=S.projects||[];const repos=S.repos||[];
  const now=new Date();const today=now.toISOString().split('T')[0];
  const storageKB=Math.round(new Blob([JSON.stringify(S)]).size/1024);
  const done=tasks.filter(t=>t.status==='done').length;
  const overdue=tasks.filter(t=>t.due&&t.due<today&&t.status!=='done').length;
  const inProg=tasks.filter(t=>t.status==='in-progress').length;
  const totalWords=content.reduce((a,c)=>a+((c.body||'').split(/\s+/).filter(w=>w).length),0)+docs.reduce((a,d)=>a+((d.body||'').split(/\s+/).filter(w=>w).length),0);
  const panel=document.createElement('div');panel.id='workspace-overview-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Workspace Overview</span><button onclick="document.getElementById('workspace-overview-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:var(--accent)">${tasks.length}</div><div style="font-size:8px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#3b82f6">${content.length}</div><div style="font-size:8px;color:var(--text-muted)">Content</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#f59e0b">${links.length}</div><div style="font-size:8px;color:var(--text-muted)">Links</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#8b5cf6">${docs.length}</div><div style="font-size:8px;color:var(--text-muted)">Docs</div></div>`;
  h+=`</div>`;
  h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Tasks</div>`;
  h+=`<div style="font-size:10px;color:var(--text-secondary)">Done: <span style="color:#4ade80">${done}</span> | In Progress: <span style="color:#3b82f6">${inProg}</span> | Overdue: <span style="color:#ef4444">${overdue}</span></div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Writing</div>`;
  h+=`<div style="font-size:10px;color:var(--text-secondary)">Total words: <span style="color:var(--accent)">${totalWords.toLocaleString()}</span></div></div>`;
  h+=`</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:14px;font-weight:600;color:#ec4899">${projects.length}</div><div style="font-size:8px;color:var(--text-muted)">Projects</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:14px;font-weight:600;color:#06b6d4">${repos.length}</div><div style="font-size:8px;color:var(--text-muted)">Repos</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:14px;font-weight:600;color:#f97316">${storageKB}KB</div><div style="font-size:8px;color:var(--text-muted)">Storage</div></div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentSentiment(){
  const content=S.content||[];
  const positive=['great','good','excellent','amazing','wonderful','happy','love','awesome','fantastic','beautiful','perfect','success','win','best','excited','grateful','brilliant','incredible','outstanding'];
  const negative=['bad','terrible','awful','horrible','sad','angry','frustrated','hate','worst','fail','problem','issue','bug','broken','stuck','difficult','painful','disappointing','annoying'];
  let posCount=0,negCount=0,neutralCount=0;
  const results=[];
  content.forEach(c=>{
    const words=(c.body||'').toLowerCase().split(/\s+/);
    let pos=0,neg=0;
    words.forEach(w=>{
      if(positive.some(p=>w.includes(p)))pos++;
      if(negative.some(n=>w.includes(n)))neg++;
    });
    const sentiment=pos>neg?'positive':neg>pos?'negative':'neutral';
    if(sentiment==='positive')posCount++;
    else if(sentiment==='negative')negCount++;
    else neutralCount++;
    results.push({body:(c.body||'').substring(0,50),sentiment,pos,neg});
  });
  const panel=document.createElement('div');panel.id='sentiment-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Sentiment</span><button onclick="document.getElementById('sentiment-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${posCount}</div><div style="font-size:9px;color:var(--text-muted)">Positive</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#6b7280">${neutralCount}</div><div style="font-size:9px;color:var(--text-muted)">Neutral</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#ef4444">${negCount}</div><div style="font-size:9px;color:var(--text-muted)">Negative</div></div>`;
  h+=`</div>`;
  const total=content.length||1;
  h+=`<div style="display:flex;gap:2px;height:16px;border-radius:4px;overflow:hidden;margin-bottom:12px">`;
  h+=`<div style="width:${(posCount/total)*100}%;background:#4ade80"></div>`;
  h+=`<div style="width:${(neutralCount/total)*100}%;background:#6b7280"></div>`;
  h+=`<div style="width:${(negCount/total)*100}%;background:#ef4444"></div>`;
  h+=`</div>`;
  h+=`<div style="font-size:9px;color:var(--text-muted);text-align:center">Keyword-based analysis of ${content.length} items (approximate)</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectCompletionTimeline(){
  let panel=document.getElementById('proj-timeline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=(S.projects||[]);
  const tasks=(S.tasks||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Project Completion Timeline</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!projects.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No projects found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const w=620,barH=32,gap=8,top=30;
  const svgH=top+projects.length*(barH+gap)+20;
  h+=`<svg width="100%" viewBox="0 0 ${w} ${svgH}" style="display:block">`;
  h+=`<text x="${w/2}" y="18" text-anchor="middle" fill="var(--text-muted)" font-size="11">Completion %</text>`;
  const labels=['0%','25%','50%','75%','100%'];
  labels.forEach((l,i)=>{const x=80+i*(w-100)/4;h+=`<text x="${x}" y="${top-4}" fill="var(--text-muted)" font-size="9" text-anchor="middle">${l}</text>`;h+=`<line x1="${x}" y1="${top}" x2="${x}" y2="${svgH-10}" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="3,3"/>`;});
  projects.forEach((p,i)=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    const done=pTasks.filter(t=>t.status==='done').length;
    const pct=pTasks.length?Math.round(done/pTasks.length*100):0;
    const y=top+i*(barH+gap);
    const maxW=w-100;
    const barW=maxW*pct/100;
    const color=pct>=75?'#4ade80':pct>=50?'#facc15':pct>=25?'#fb923c':'#f87171';
    h+=`<text x="75" y="${y+barH/2+4}" text-anchor="end" fill="var(--text-secondary)" font-size="10">${(p.name||'Untitled').substring(0,12)}</text>`;
    h+=`<rect x="80" y="${y}" width="${maxW}" height="${barH}" rx="4" fill="var(--bg-surface)"/>`;
    if(barW>0)h+=`<rect x="80" y="${y}" width="${barW}" height="${barH}" rx="4" fill="${color}" opacity="0.8"/>`;
    h+=`<text x="${80+maxW/2}" y="${y+barH/2+4}" text-anchor="middle" fill="var(--text-primary)" font-size="11" font-weight="600">${pct}% (${done}/${pTasks.length})</text>`;
  });
  h+=`</svg>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentCalendar(){
  let panel=document.getElementById('content-cal-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-cal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleString('default',{month:'long',year:'numeric'});
  const dayMap={};
  content.forEach(c=>{
    if(!c.createdAt)return;
    const d=new Date(c.createdAt);
    if(d.getFullYear()===year&&d.getMonth()===month){
      const day=d.getDate();
      if(!dayMap[day])dayMap[day]=[];
      dayMap[day].push(c);
    }
  });
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Calendar - '+monthName+'</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:8px">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div style="text-align:center;font-size:10px;color:var(--text-muted);padding:4px">${d}</div>`;});
  h+='</div><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px">';
  for(let i=0;i<firstDay;i++)h+='<div></div>';
  for(let d=1;d<=daysInMonth;d++){
    const isToday=d===now.getDate();
    const items=dayMap[d]||[];
    const bg=items.length>0?'rgba(74,222,128,0.15)':'var(--bg-surface)';
    const border=isToday?'border:1px solid var(--accent)':'border:1px solid transparent';
    h+=`<div style="min-height:50px;${border};background:${bg};border-radius:4px;padding:3px;position:relative">`;
    h+=`<div style="font-size:10px;color:${isToday?'var(--accent)':'var(--text-muted)'};font-weight:${isToday?'700':'400'}">${d}</div>`;
    if(items.length>0)h+=`<div style="font-size:9px;color:var(--accent);margin-top:2px">${items.length} item${items.length>1?'s':''}</div>`;
    items.slice(0,2).forEach(c=>{h+=`<div style="font-size:8px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.title||'').substring(0,15)}</div>`;});
    h+='</div>';
  }
  h+='</div>';
  const totalItems=content.filter(c=>{if(!c.createdAt)return false;const d=new Date(c.createdAt);return d.getFullYear()===year&&d.getMonth()===month;}).length;
  const activeDays=Object.keys(dayMap).length;
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">${totalItems} items created across ${activeDays} days this month</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskVelocity(){
  let panel=document.getElementById('velocity-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='velocity-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const weeks=8;
  const now=new Date();
  const weekData=[];
  for(let w=weeks-1;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-w*7-weekStart.getDay());weekStart.setHours(0,0,0,0);
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+7);
    const done=tasks.filter(t=>{
      if(t.status!=='done'||!t.completedAt)return false;
      const d=new Date(t.completedAt);return d>=weekStart&&d<weekEnd;
    }).length;
    const created=tasks.filter(t=>{
      if(!t.createdAt)return false;
      const d=new Date(t.createdAt);return d>=weekStart&&d<weekEnd;
    }).length;
    const label=weekStart.toLocaleDateString('en',{month:'short',day:'numeric'});
    weekData.push({label,done,created});
  }
  const maxVal=Math.max(...weekData.map(w=>Math.max(w.done,w.created)),1);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Task Velocity (8 Weeks)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:4px;margin-bottom:8px"><span style="font-size:10px;color:#4ade80">■ Completed</span><span style="font-size:10px;color:#60a5fa">■ Created</span></div>';
  const svgW=600,svgH=200,padL=40,padB=30,padT=10;
  const chartW=svgW-padL-10,chartH=svgH-padT-padB;
  const barW=chartW/weeks/2-4;
  h+=`<svg width="100%" viewBox="0 0 ${svgW} ${svgH}" style="display:block">`;
  for(let i=0;i<=4;i++){
    const y=padT+chartH-i*(chartH/4);
    const val=Math.round(maxVal*i/4);
    h+=`<line x1="${padL}" y1="${y}" x2="${svgW-10}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;
    h+=`<text x="${padL-5}" y="${y+3}" text-anchor="end" fill="var(--text-muted)" font-size="9">${val}</text>`;
  }
  weekData.forEach((w,i)=>{
    const x=padL+i*(chartW/weeks)+chartW/weeks/2;
    const doneH=maxVal?w.done/maxVal*chartH:0;
    const createdH=maxVal?w.created/maxVal*chartH:0;
    h+=`<rect x="${x-barW-1}" y="${padT+chartH-doneH}" width="${barW}" height="${doneH}" rx="2" fill="#4ade80" opacity="0.8"/>`;
    h+=`<rect x="${x+1}" y="${padT+chartH-createdH}" width="${barW}" height="${createdH}" rx="2" fill="#60a5fa" opacity="0.8"/>`;
    if(w.done>0)h+=`<text x="${x-barW/2-1}" y="${padT+chartH-doneH-3}" text-anchor="middle" fill="#4ade80" font-size="9">${w.done}</text>`;
    if(w.created>0)h+=`<text x="${x+barW/2+1}" y="${padT+chartH-createdH-3}" text-anchor="middle" fill="#60a5fa" font-size="9">${w.created}</text>`;
    h+=`<text x="${x}" y="${svgH-5}" text-anchor="middle" fill="var(--text-muted)" font-size="8">${w.label}</text>`;
  });
  h+=`</svg>`;
  const avgDone=weekData.reduce((s,w)=>s+w.done,0)/weeks;
  const avgCreated=weekData.reduce((s,w)=>s+w.created,0)/weeks;
  h+=`<div style="display:flex;gap:20px;justify-content:center;margin-top:12px">`;
  h+=`<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:#4ade80">${avgDone.toFixed(1)}</div><div style="font-size:10px;color:var(--text-muted)">Avg completed/week</div></div>`;
  h+=`<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:#60a5fa">${avgCreated.toFixed(1)}</div><div style="font-size:10px;color:var(--text-muted)">Avg created/week</div></div>`;
  h+=`<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:${avgDone>=avgCreated?'#4ade80':'#f87171'}">${avgDone>=avgCreated?'+':'-'}${Math.abs(avgDone-avgCreated).toFixed(1)}</div><div style="font-size:10px;color:var(--text-muted)">Net velocity</div></div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTagCloud(){
  let panel=document.getElementById('tag-cloud-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='tag-cloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tagCount={};
  (S.content||[]).forEach(c=>{(c.tags||[]).forEach(t=>{tagCount[t]=(tagCount[t]||0)+1;});});
  (S.tasks||[]).forEach(t=>{(t.tags||[]).forEach(tg=>{tagCount[tg]=(tagCount[tg]||0)+1;});});
  (S.links||[]).forEach(l=>{(l.tags||[]).forEach(t=>{tagCount[t]=(tagCount[t]||0)+1;});});
  const tags=Object.entries(tagCount).sort((a,b)=>b[1]-a[1]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Tag Cloud ('+tags.length+' tags)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!tags.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No tags found across content, tasks, or links</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const maxCount=tags[0][1];
  const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#f87171','#a78bfa','#34d399','#f472b6','#38bdf8','#fbbf24'];
  h+='<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:20px">';
  tags.forEach(([tag,count],i)=>{
    const size=12+Math.round((count/maxCount)*24);
    const color=colors[i%colors.length];
    const opacity=0.5+count/maxCount*0.5;
    h+=`<span style="font-size:${size}px;color:${color};opacity:${opacity};cursor:default;padding:2px 6px;transition:opacity 0.2s" title="${count} items">${esc(tag)}</span>`;
  });
  h+='</div>';
  h+='<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Top 10 tags:</div>';
  tags.slice(0,10).forEach(([tag,count])=>{
    const pct=Math.round(count/maxCount*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><div style="width:80px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(tag)}</div><div style="flex:1;height:12px;background:var(--bg-surface);border-radius:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:6px"></div></div><div style="font-size:10px;color:var(--text-muted);width:30px">${count}</div></div>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDueCalendar(){
  let panel=document.getElementById('due-cal-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='due-cal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&t.due);
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleString('default',{month:'long',year:'numeric'});
  const dayMap={};
  tasks.forEach(t=>{
    const d=new Date(t.due);
    if(d.getFullYear()===year&&d.getMonth()===month){
      const day=d.getDate();
      if(!dayMap[day])dayMap[day]=[];
      dayMap[day].push(t);
    }
  });
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Due Date Calendar - '+monthName+'</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:8px">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div style="text-align:center;font-size:10px;color:var(--text-muted);padding:4px">${d}</div>`;});
  h+='</div><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px">';
  for(let i=0;i<firstDay;i++)h+='<div></div>';
  const today=now.getDate();
  for(let d=1;d<=daysInMonth;d++){
    const isToday=d===today;
    const items=dayMap[d]||[];
    const isOverdue=d<today&&items.length>0;
    const bg=isOverdue?'rgba(248,113,113,0.15)':items.length>0?'rgba(74,222,128,0.15)':'var(--bg-surface)';
    const border=isToday?'border:1px solid var(--accent)':'border:1px solid transparent';
    h+=`<div style="min-height:50px;${border};background:${bg};border-radius:4px;padding:3px">`;
    h+=`<div style="font-size:10px;color:${isToday?'var(--accent)':isOverdue?'#f87171':'var(--text-muted)'};font-weight:${isToday?'700':'400'}">${d}</div>`;
    if(items.length>0)h+=`<div style="font-size:9px;color:${isOverdue?'#f87171':'var(--accent)'}">${items.length} task${items.length>1?'s':''}</div>`;
    items.slice(0,2).forEach(t=>{
      const pColor=t.priority==='p0'?'#f87171':t.priority==='p1'?'#fb923c':t.priority==='p2'?'#60a5fa':'#6b7280';
      h+=`<div style="font-size:8px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap"><span style="color:${pColor}">●</span> ${esc(t.title||'').substring(0,14)}</div>`;
    });
    h+='</div>';
  }
  h+='</div>';
  const overdue=tasks.filter(t=>{const d=new Date(t.due);return d<now;}).length;
  const upcoming=tasks.filter(t=>{const d=new Date(t.due);const week=new Date(now);week.setDate(week.getDate()+7);return d>=now&&d<=week;}).length;
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:12px;font-size:10px;color:var(--text-muted)"><span style="color:#f87171">${overdue} overdue</span><span style="color:#facc15">${upcoming} due this week</span><span>${tasks.length} total open with dates</span></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProductivityInsights(){
  let panel=document.getElementById('productivity-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='productivity-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const content=(S.content||[]);const links=(S.links||[]);
  const now=new Date();
  const weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
  const twoWeeksAgo=new Date(now);twoWeeksAgo.setDate(twoWeeksAgo.getDate()-14);
  const thisWeekDone=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=weekAgo).length;
  const lastWeekDone=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=twoWeeksAgo&&new Date(t.completedAt)<weekAgo).length;
  const thisWeekContent=content.filter(c=>c.createdAt&&new Date(c.createdAt)>=weekAgo).length;
  const lastWeekContent=content.filter(c=>c.createdAt&&new Date(c.createdAt)>=twoWeeksAgo&&new Date(c.createdAt)<weekAgo).length;
  const thisWeekLinks=links.filter(l=>l.createdAt&&new Date(l.createdAt)>=weekAgo).length;
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now).length;
  const wip=tasks.filter(t=>t.status==='in-progress').length;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Productivity Insights</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const taskTrend=thisWeekDone>lastWeekDone?'up':thisWeekDone<lastWeekDone?'down':'flat';
  const contentTrend=thisWeekContent>lastWeekContent?'up':thisWeekContent<lastWeekContent?'down':'flat';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${thisWeekDone}</div><div style="font-size:10px;color:var(--text-muted)">Tasks done this week</div><div style="font-size:10px;color:${taskTrend==='up'?'#4ade80':taskTrend==='down'?'#f87171':'var(--text-muted)'}">${taskTrend==='up'?'^ Up':'v Down'} from ${lastWeekDone} last week</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#60a5fa">${thisWeekContent}</div><div style="font-size:10px;color:var(--text-muted)">Content created this week</div><div style="font-size:10px;color:${contentTrend==='up'?'#4ade80':contentTrend==='down'?'#f87171':'var(--text-muted)'}">${contentTrend==='up'?'^ Up':'v Down'} from ${lastWeekContent} last week</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#facc15">${thisWeekLinks}</div><div style="font-size:10px;color:var(--text-muted)">Links saved this week</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:${overdue>0?'#f87171':'#4ade80'}">${overdue}</div><div style="font-size:10px;color:var(--text-muted)">Overdue tasks</div></div>`;
  h+='</div>';
  h+='<div style="border-top:1px solid var(--border);padding-top:12px"><div style="font-size:12px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Insights</div>';
  const insights=[];
  if(overdue>3)insights.push({icon:'!',color:'#f87171',text:`You have ${overdue} overdue tasks. Consider triaging: close outdated ones or reschedule.`});
  if(wip>5)insights.push({icon:'!',color:'#fb923c',text:`${wip} tasks in-progress simultaneously. Focus on finishing before starting new.`});
  if(thisWeekDone>lastWeekDone*1.5&&lastWeekDone>0)insights.push({icon:'+',color:'#4ade80',text:`Great momentum! Task completion up ${Math.round((thisWeekDone/lastWeekDone-1)*100)}% vs last week.`});
  if(thisWeekDone===0)insights.push({icon:'?',color:'#facc15',text:'No tasks completed this week yet. Try breaking large tasks into smaller ones.'});
  if(thisWeekContent>0&&thisWeekDone>0)insights.push({icon:'+',color:'#4ade80',text:'Balanced week: creating content AND completing tasks. Keep it up.'});
  if(tasks.filter(t=>t.status==='todo').length>20)insights.push({icon:'!',color:'#fb923c',text:`${tasks.filter(t=>t.status==='todo').length} tasks in backlog. Consider archiving or prioritizing.`});
  if(!insights.length)insights.push({icon:'+',color:'var(--text-muted)',text:'Looking good. Keep building consistently.'});
  insights.forEach(ins=>{
    h+=`<div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:8px;padding:8px;background:var(--bg-surface);border-radius:6px"><span style="color:${ins.color};font-weight:700;font-size:14px;min-width:16px">${ins.icon}</span><span style="font-size:11px;color:var(--text-secondary)">${ins.text}</span></div>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showCategoryBreakdown(){
  let panel=document.getElementById('cat-breakdown-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='cat-breakdown-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const catCount={};
  content.forEach(c=>{const cat=c.theme||c.category||'Uncategorized';catCount[cat]=(catCount[cat]||0)+1;});
  const cats=Object.entries(catCount).sort((a,b)=>b[1]-a[1]);
  const total=content.length||1;
  const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#f87171','#a78bfa','#34d399','#f472b6','#38bdf8','#fbbf24','#818cf8','#2dd4bf'];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Category Breakdown</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!cats.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No content found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  // Horizontal stacked bar
  h+='<div style="display:flex;height:32px;border-radius:8px;overflow:hidden;margin-bottom:16px">';
  cats.forEach(([cat,count],i)=>{
    const pct=count/total*100;
    if(pct<2)return;
    h+=`<div style="width:${pct}%;background:${colors[i%colors.length]};display:flex;align-items:center;justify-content:center" title="${cat}: ${count} (${pct.toFixed(1)}%)">`;
    if(pct>8)h+=`<span style="font-size:9px;color:#000;font-weight:600">${pct.toFixed(0)}%</span>`;
    h+='</div>';
  });
  h+='</div>';
  // Legend list
  cats.forEach(([cat,count],i)=>{
    const pct=(count/total*100).toFixed(1);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">`;
    h+=`<div style="width:12px;height:12px;border-radius:3px;background:${colors[i%colors.length]};flex-shrink:0"></div>`;
    h+=`<div style="flex:1;font-size:11px;color:var(--text-secondary)">${esc(cat)}</div>`;
    h+=`<div style="font-size:11px;color:var(--text-muted)">${count} (${pct}%)</div>`;
    h+=`</div>`;
  });
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">${content.length} total items across ${cats.length} categories</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showRecentActivity(){
  let panel=document.getElementById('activity-feed-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='activity-feed-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const activities=[];
  (S.tasks||[]).forEach(t=>{
    if(t.createdAt)activities.push({type:'task',action:'created',title:t.title||'Untitled',date:t.createdAt,color:'#60a5fa'});
    if(t.completedAt)activities.push({type:'task',action:'completed',title:t.title||'Untitled',date:t.completedAt,color:'#4ade80'});
  });
  (S.content||[]).forEach(c=>{
    if(c.createdAt)activities.push({type:'content',action:'added',title:c.title||'Untitled',date:c.createdAt,color:'#a78bfa'});
    if(c.updatedAt&&c.updatedAt!==c.createdAt)activities.push({type:'content',action:'updated',title:c.title||'Untitled',date:c.updatedAt,color:'#818cf8'});
  });
  (S.links||[]).forEach(l=>{
    if(l.createdAt)activities.push({type:'link',action:'saved',title:l.title||l.url||'Untitled',date:l.createdAt,color:'#38bdf8'});
  });
  (S.writerDocs||[]).forEach(d=>{
    if(d.updatedAt)activities.push({type:'doc',action:'edited',title:d.title||'Untitled',date:d.updatedAt,color:'#fbbf24'});
  });
  activities.sort((a,b)=>new Date(b.date)-new Date(a.date));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Recent Activity</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!activities.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No activity recorded yet</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const shown=activities.slice(0,50);
  let lastDate='';
  shown.forEach(a=>{
    const d=new Date(a.date);
    const dateStr=d.toLocaleDateString('en',{month:'short',day:'numeric'});
    if(dateStr!==lastDate){
      h+=`<div style="font-size:10px;color:var(--text-muted);margin:12px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--border)">${dateStr}</div>`;
      lastDate=dateStr;
    }
    const time=d.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit'});
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 0">`;
    h+=`<div style="width:6px;height:6px;border-radius:50%;background:${a.color};flex-shrink:0"></div>`;
    h+=`<div style="font-size:11px;color:var(--text-secondary);flex:1"><span style="color:${a.color}">${a.type}</span> ${a.action}: <span style="color:var(--text-primary)">${esc(a.title).substring(0,40)}</span></div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted)">${time}</div>`;
    h+=`</div>`;
  });
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">Showing ${shown.length} of ${activities.length} activities</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickNote(){
  let panel=document.getElementById('quick-note-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-note-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-weight:700;font-size:13px;color:var(--text-primary)">Quick Note</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<textarea id="quick-note-text" style="width:100%;height:100px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;resize:vertical;font-family:inherit" placeholder="Type a quick note..."></textarea>';
  h+='<div style="display:flex;gap:8px;margin-top:8px">';
  h+='<input id="quick-note-tags" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:11px" placeholder="Tags (comma-separated)">';
  h+=`<button onclick="(function(){const text=document.getElementById('quick-note-text').value.trim();if(!text)return;if(!S.content)S.content=[];const title=text.substring(0,50);const tags=document.getElementById('quick-note-tags').value.split(',').map(t=>t.trim()).filter(Boolean);S.content.unshift({id:'c_'+Date.now(),title:title,body:text,tags:tags,theme:'Quick Note',createdAt:new Date().toISOString(),pinned:false});save();document.getElementById('quick-note-panel').remove();if(typeof renderContent==='function')renderContent();})()" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer">Save</button>`;
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const ta=document.getElementById('quick-note-text');if(ta)ta.focus();},100);
}
function showWriterStats(){
  let panel=document.getElementById('writer-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writer-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const docs=(S.writerDocs||[]);
  const totalWords=docs.reduce((s,d)=>{const w=(d.content||'').trim().split(/\s+/).filter(Boolean).length;return s+w;},0);
  const totalChars=docs.reduce((s,d)=>s+(d.content||'').length,0);
  const avgWords=docs.length?Math.round(totalWords/docs.length):0;
  const longest=docs.reduce((max,d)=>{const w=(d.content||'').trim().split(/\s+/).filter(Boolean).length;return w>max.words?{title:d.title,words:w}:max;},{title:'',words:0});
  const versions=docs.reduce((s,d)=>s+(d.versions||[]).length,0);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Writer Statistics</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${docs.length}</div><div style="font-size:10px;color:var(--text-muted)">Documents</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#60a5fa">${totalWords.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted)">Total Words</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#facc15">${avgWords}</div><div style="font-size:10px;color:var(--text-muted)">Avg Words/Doc</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#a78bfa">${totalChars.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted)">Total Characters</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#f472b6">${versions}</div><div style="font-size:10px;color:var(--text-muted)">Saved Versions</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#38bdf8">${Math.ceil(totalWords/250)}</div><div style="font-size:10px;color:var(--text-muted)">Est. Pages</div></div>`;
  h+='</div>';
  if(longest.words>0){
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:6px;margin-bottom:12px;font-size:11px;color:var(--text-secondary)">Longest doc: <span style="color:var(--text-primary);font-weight:600">${esc(longest.title||'Untitled')}</span> (${longest.words.toLocaleString()} words)</div>`;
  }
  if(docs.length){
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Documents by word count:</div>';
    const sorted=[...docs].map(d=>({title:d.title||'Untitled',words:(d.content||'').trim().split(/\s+/).filter(Boolean).length})).sort((a,b)=>b.words-a.words).slice(0,10);
    const maxW=sorted[0]?.words||1;
    sorted.forEach(d=>{
      const pct=Math.round(d.words/maxW*100);
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px"><div style="width:100px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(d.title)}</div><div style="flex:1;height:10px;background:var(--bg-surface);border-radius:5px;overflow:hidden"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:5px"></div></div><div style="font-size:9px;color:var(--text-muted);width:40px">${d.words}</div></div>`;
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showLinkDomainBreakdown(){
  let panel=document.getElementById('link-domain-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='link-domain-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const links=(S.links||[]);
  const domainCount={};
  links.forEach(l=>{
    try{const u=new URL(l.url||'');domainCount[u.hostname]=(domainCount[u.hostname]||0)+1;}catch(e){}
  });
  const domains=Object.entries(domainCount).sort((a,b)=>b[1]-a[1]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Link Domain Breakdown</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!domains.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No links with valid URLs found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${links.length} links across ${domains.length} domains</div>`;
  const maxC=domains[0][1];
  const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#f87171','#a78bfa','#34d399','#f472b6','#38bdf8','#fbbf24'];
  domains.slice(0,20).forEach(([domain,count],i)=>{
    const pct=Math.round(count/maxC*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">`;
    h+=`<div style="width:130px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(domain)}</div>`;
    h+=`<div style="flex:1;height:14px;background:var(--bg-surface);border-radius:7px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[i%colors.length]};border-radius:7px"></div></div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted);width:30px">${count}</div>`;
    h+=`</div>`;
  });
  if(domains.length>20)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px">...and ${domains.length-20} more domains</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTimeTrackingReport(){
  let panel=document.getElementById('time-report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='time-report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const tracked=tasks.filter(t=>t.timeTracked&&t.timeTracked>0);
  const totalSec=tracked.reduce((s,t)=>s+t.timeTracked,0);
  const projectTime={};
  tracked.forEach(t=>{
    const proj=t.project||t.projectId||'No Project';
    projectTime[proj]=(projectTime[proj]||0)+t.timeTracked;
  });
  const projects=Object.entries(projectTime).sort((a,b)=>b[1]-a[1]);
  function fmtTime(sec){if(sec<60)return sec+'s';if(sec<3600)return Math.floor(sec/60)+'m '+sec%60+'s';return Math.floor(sec/3600)+'h '+Math.floor(sec%3600/60)+'m';}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Time Tracking Report</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#4ade80">${fmtTime(totalSec)}</div><div style="font-size:10px;color:var(--text-muted)">Total Tracked</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#60a5fa">${tracked.length}</div><div style="font-size:10px;color:var(--text-muted)">Tasks Tracked</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#facc15">${tracked.length?fmtTime(Math.round(totalSec/tracked.length)):'0'}</div><div style="font-size:10px;color:var(--text-muted)">Avg per Task</div></div>`;
  h+='</div>';
  if(projects.length){
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Time by Project:</div>';
    const maxT=projects[0][1];
    const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#a78bfa'];
    projects.forEach(([proj,sec],i)=>{
      const pct=Math.round(sec/maxT*100);
      const projName=(S.projects||[]).find(p=>p.id===proj)?.name||proj;
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px"><div style="width:100px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(projName)}</div><div style="flex:1;height:14px;background:var(--bg-surface);border-radius:7px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[i%colors.length]};border-radius:7px"></div></div><div style="font-size:10px;color:var(--text-muted);width:50px">${fmtTime(sec)}</div></div>`;
    });
  }
  if(tracked.length){
    h+='<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px;font-size:11px;color:var(--text-muted);margin-bottom:6px">Top 10 by Time:</div>';
    const top10=[...tracked].sort((a,b)=>b.timeTracked-a.timeTracked).slice(0,10);
    top10.forEach(t=>{
      h+=`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:11px"><span style="color:var(--text-secondary)">${esc(t.title||'Untitled').substring(0,35)}</span><span style="color:#4ade80;font-weight:600">${fmtTime(t.timeTracked)}</span></div>`;
    });
  }
  if(!tracked.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No time tracking data. Use the timer on tasks to start tracking.</div>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentTimeline(){
  let panel=document.getElementById('content-tl-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-tl-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=[...(S.content||[])].filter(c=>c.createdAt).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Timeline</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!content.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No dated content found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  let lastDate='';
  content.slice(0,50).forEach(c=>{
    const d=new Date(c.createdAt);
    const dateStr=d.toLocaleDateString('en',{month:'short',day:'numeric',year:'numeric'});
    if(dateStr!==lastDate){
      h+=`<div style="font-size:10px;color:var(--accent);font-weight:600;margin:16px 0 8px;padding-left:20px;position:relative"><div style="position:absolute;left:6px;top:4px;width:6px;height:6px;border-radius:50%;background:var(--accent)"></div>${dateStr}</div>`;
      lastDate=dateStr;
    }
    const time=d.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit'});
    const words=(c.body||'').trim().split(/\s+/).filter(Boolean).length;
    const theme=c.theme||c.category||'';
    h+=`<div style="margin-left:8px;padding:8px 8px 8px 20px;border-left:2px solid var(--border);position:relative">`;
    h+=`<div style="position:absolute;left:-5px;top:12px;width:8px;height:8px;border-radius:50%;background:var(--bg-elevated);border:2px solid var(--border)"></div>`;
    h+=`<div style="font-size:12px;color:var(--text-primary);font-weight:500">${esc(c.title||'Untitled')}</div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:2px">${time}`;
    if(words>0)h+=` | ${words} words`;
    if(theme)h+=` | ${esc(theme)}`;
    h+=`</div>`;
    if(c.body){
      const preview=c.body.substring(0,100).replace(/\n/g,' ');
      h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:4px;line-height:1.4;opacity:0.7">${esc(preview)}${c.body.length>100?'...':''}</div>`;
    }
    h+=`</div>`;
  });
  if(content.length>50)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:12px">Showing 50 of ${content.length} items</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showGoalTracker(){
  let panel=document.getElementById('goal-tracker-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='goal-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._goals)S._goals=[];
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Goal Tracker</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="display:flex;gap:8px;margin-bottom:16px">';
    h+='<input id="goal-title-input" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px" placeholder="Goal title...">';
    h+='<select id="goal-type-select" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:11px"><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select>';
    h+='<input id="goal-target-input" type="number" min="1" value="5" style="width:60px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px">';
    h+=`<button onclick="(function(){const t=document.getElementById('goal-title-input').value.trim();if(!t)return;const type=document.getElementById('goal-type-select').value;const target=parseInt(document.getElementById('goal-target-input').value)||5;S._goals.push({id:'g_'+Date.now(),title:t,type:type,target:target,current:0,createdAt:new Date().toISOString()});save();showGoalTracker();})()" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px 12px;font-size:11px;font-weight:600;cursor:pointer">Add</button>`;
    h+='</div>';
    if(!S._goals.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No goals set. Add a goal above.</div>';}
    S._goals.forEach(g=>{
      const pct=g.target?Math.min(100,Math.round(g.current/g.target*100)):0;
      const color=pct>=100?'#4ade80':pct>=60?'#facc15':'#60a5fa';
      h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:8px">`;
      h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
      h+=`<div><span style="font-size:12px;color:var(--text-primary);font-weight:500">${esc(g.title)}</span><span style="font-size:9px;color:var(--text-muted);margin-left:8px">${g.type}</span></div>`;
      h+=`<div style="display:flex;gap:4px">`;
      h+=`<button onclick="(function(){const g=S._goals.find(x=>x.id==='${g.id}');if(g&&g.current<g.target){g.current++;save();showGoalTracker();}})()" style="background:var(--accent);color:#000;border:none;border-radius:4px;padding:2px 8px;font-size:10px;cursor:pointer;font-weight:600">+1</button>`;
      h+=`<button onclick="(function(){S._goals=S._goals.filter(x=>x.id!=='${g.id}');save();showGoalTracker();})()" style="background:none;border:1px solid var(--border);color:var(--text-muted);border-radius:4px;padding:2px 6px;font-size:10px;cursor:pointer">X</button>`;
      h+=`</div></div>`;
      h+=`<div style="height:10px;background:var(--bg-elevated);border-radius:5px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${color};border-radius:5px;transition:width 0.3s"></div></div>`;
      h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:4px">${g.current} / ${g.target} (${pct}%)${pct>=100?' - COMPLETED':''}</div>`;
      h+=`</div>`;
    });
    panel.innerHTML=h;
  }
  render();
  document.body.appendChild(panel);
}
function showQuickTask(){
  let panel=document.getElementById('quick-task-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-task-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-weight:700;font-size:13px;color:var(--text-primary)">Quick Task</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<input id="quick-task-title" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;margin-bottom:8px" placeholder="Task title...">';
  h+='<div style="display:flex;gap:8px;margin-bottom:8px">';
  h+='<select id="quick-task-priority" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px"><option value="p2">P2 Normal</option><option value="p0">P0 Critical</option><option value="p1">P1 High</option><option value="p3">P3 Low</option></select>';
  h+='<input id="quick-task-due" type="date" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px">';
  h+='</div>';
  h+=`<button onclick="(function(){const title=document.getElementById('quick-task-title').value.trim();if(!title)return;if(!S.tasks)S.tasks=[];const priority=document.getElementById('quick-task-priority').value;const due=document.getElementById('quick-task-due').value;S.tasks.push({id:'t_'+Date.now(),title:title,description:'',status:'todo',priority:priority,due:due||'',project:'',projectId:'',subtasks:[],tags:[],createdAt:new Date().toISOString(),timeTracked:0});save();document.getElementById('quick-task-panel').remove();if(typeof renderTasks==='function')renderTasks();})()" style="width:100%;background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px;font-size:12px;font-weight:600;cursor:pointer">Create Task</button>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const inp=document.getElementById('quick-task-title');if(inp)inp.focus();},100);
}
function showDataExplorer(){
  let panel=document.getElementById('data-explorer-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='data-explorer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const keys=['tasks','content','links','projects','writerDocs','specs','repos','_goals','_habits','_moods','_microJournal','_gratitude','_savedSearches','_bookmarks','_changelog'];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Data Explorer</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Browse workspace state data. Click a section to expand.</div>';
  keys.forEach(key=>{
    const val=S[key];
    if(!val)return;
    const isArr=Array.isArray(val);
    const count=isArr?val.length:Object.keys(val).length;
    const sizeStr=JSON.stringify(val).length;
    const sizeKB=(sizeStr/1024).toFixed(1);
    h+=`<div style="margin-bottom:4px">`;
    h+=`<div onclick="const el=document.getElementById('de-${key}');el.style.display=el.style.display==='none'?'block':'none'" style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer">`;
    h+=`<span style="font-size:12px;color:var(--text-primary);font-weight:500">${key}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${count} items | ${sizeKB} KB</span>`;
    h+=`</div>`;
    h+=`<div id="de-${key}" style="display:none;padding:8px;margin-left:12px;border-left:2px solid var(--border)">`;
    if(isArr){
      val.slice(0,5).forEach((item,i)=>{
        const preview=JSON.stringify(item).substring(0,200);
        h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;font-family:monospace;word-break:break-all">[${i}] ${esc(preview)}${preview.length>=200?'...':''}</div>`;
      });
      if(val.length>5)h+=`<div style="font-size:10px;color:var(--text-muted);font-style:italic">...and ${val.length-5} more items</div>`;
    } else {
      const preview=JSON.stringify(val).substring(0,400);
      h+=`<div style="font-size:10px;color:var(--text-muted);font-family:monospace;word-break:break-all">${esc(preview)}${preview.length>=400?'...':''}</div>`;
    }
    h+=`</div></div>`;
  });
  const totalSize=(JSON.stringify(S).length/1024).toFixed(1);
  h+=`<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);text-align:center;font-size:10px;color:var(--text-muted)">Total state: ${totalSize} KB</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectComparison(){
  let panel=document.getElementById('proj-compare-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:750px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=(S.projects||[]);
  const tasks=(S.tasks||[]);
  const content=(S.content||[]);
  const specs=(S.specs||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Project Comparison</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(projects.length<2){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">Need at least 2 projects to compare</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">';
  h+='<tr><th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);color:var(--text-muted)">Metric</th>';
  projects.forEach(p=>{h+=`<th style="text-align:center;padding:8px;border-bottom:1px solid var(--border);color:var(--accent)">${esc((p.name||'Untitled').substring(0,15))}</th>`;});
  h+='</tr>';
  const metrics=[
    {name:'Total Tasks',fn:p=>tasks.filter(t=>t.projectId===p.id||t.project===p.name).length},
    {name:'Done',fn:p=>tasks.filter(t=>(t.projectId===p.id||t.project===p.name)&&t.status==='done').length},
    {name:'In Progress',fn:p=>tasks.filter(t=>(t.projectId===p.id||t.project===p.name)&&t.status==='in-progress').length},
    {name:'Overdue',fn:p=>tasks.filter(t=>(t.projectId===p.id||t.project===p.name)&&t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length},
    {name:'Content Items',fn:p=>content.filter(c=>c.project===p.name||c.projectId===p.id).length},
    {name:'Specs',fn:p=>specs.filter(s=>s.projectId===p.id).length},
    {name:'Completion %',fn:p=>{const pt=tasks.filter(t=>t.projectId===p.id||t.project===p.name);const d=pt.filter(t=>t.status==='done').length;return pt.length?(Math.round(d/pt.length*100)+'%'):'N/A';}},
  ];
  metrics.forEach(m=>{
    h+=`<tr><td style="padding:6px 8px;border-bottom:1px solid var(--border);color:var(--text-secondary)">${m.name}</td>`;
    const vals=projects.map(p=>m.fn(p));
    const max=Math.max(...vals.map(v=>typeof v==='number'?v:0));
    projects.forEach((p,i)=>{
      const v=vals[i];
      const isMax=typeof v==='number'&&v===max&&max>0;
      h+=`<td style="text-align:center;padding:6px 8px;border-bottom:1px solid var(--border);color:${isMax?'#4ade80':'var(--text-primary)'};font-weight:${isMax?'700':'400'}">${v}</td>`;
    });
    h+='</tr>';
  });
  h+='</table></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWeeklyReview(){
  let panel=document.getElementById('weekly-review-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='weekly-review-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  const weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
  const tasks=(S.tasks||[]);const content=(S.content||[]);const links=(S.links||[]);const docs=(S.writerDocs||[]);
  const doneThisWeek=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=weekAgo);
  const createdThisWeek=tasks.filter(t=>t.createdAt&&new Date(t.createdAt)>=weekAgo);
  const contentThisWeek=content.filter(c=>c.createdAt&&new Date(c.createdAt)>=weekAgo);
  const linksThisWeek=links.filter(l=>l.createdAt&&new Date(l.createdAt)>=weekAgo);
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now);
  const docsEdited=docs.filter(d=>d.updatedAt&&new Date(d.updatedAt)>=weekAgo);
  let review=`WEEKLY REVIEW - ${weekAgo.toLocaleDateString()} to ${now.toLocaleDateString()}\n`;
  review+=`${'='.repeat(50)}\n\n`;
  review+=`TASKS\n`;
  review+=`- Completed: ${doneThisWeek.length}\n`;
  review+=`- Created: ${createdThisWeek.length}\n`;
  review+=`- Overdue: ${overdue.length}\n`;
  if(doneThisWeek.length){review+=`\nCompleted tasks:\n`;doneThisWeek.forEach(t=>{review+=`  [x] ${t.title}\n`;});}
  review+=`\nCONTENT\n`;
  review+=`- Items created: ${contentThisWeek.length}\n`;
  review+=`- Links saved: ${linksThisWeek.length}\n`;
  review+=`- Docs edited: ${docsEdited.length}\n`;
  const wordsWritten=contentThisWeek.reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0);
  review+=`- Words written: ${wordsWritten}\n`;
  review+=`\nNEXT WEEK\n`;
  const upcoming=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)>=now&&new Date(t.due)<=new Date(now.getTime()+7*86400000));
  review+=`- Due next week: ${upcoming.length}\n`;
  if(upcoming.length){upcoming.forEach(t=>{review+=`  [ ] ${t.title} (due ${t.due})\n`;});}
  if(overdue.length){review+=`\nOVERDUE (needs attention):\n`;overdue.slice(0,10).forEach(t=>{review+=`  [!] ${t.title} (due ${t.due})\n`;});}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Weekly Review</div><div style="display:flex;gap:8px"><button onclick="navigator.clipboard.writeText(document.getElementById(\'weekly-review-text\').textContent)" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 12px;font-size:11px;font-weight:600;cursor:pointer">Copy</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div></div>';
  h+=`<pre id="weekly-review-text" style="font-size:11px;color:var(--text-secondary);white-space:pre-wrap;line-height:1.6;background:var(--bg-surface);padding:16px;border-radius:8px;max-height:60vh;overflow-y:auto">${esc(review)}</pre>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showAchievements(){
  let panel=document.getElementById('achievements-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='achievements-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const content=(S.content||[]);const links=(S.links||[]);const docs=(S.writerDocs||[]);
  const doneTasks=tasks.filter(t=>t.status==='done').length;
  const totalWords=content.reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0)+docs.reduce((s,d)=>s+(d.content||'').trim().split(/\s+/).filter(Boolean).length,0);
  const achievements=[
    {id:'first_task',title:'First Steps',desc:'Complete your first task',check:doneTasks>=1,icon:'*'},
    {id:'task_10',title:'Getting Organized',desc:'Complete 10 tasks',check:doneTasks>=10,icon:'*'},
    {id:'task_50',title:'Task Machine',desc:'Complete 50 tasks',check:doneTasks>=50,icon:'*'},
    {id:'task_100',title:'Centurion',desc:'Complete 100 tasks',check:doneTasks>=100,icon:'*'},
    {id:'content_5',title:'Content Creator',desc:'Create 5 content items',check:content.length>=5,icon:'+'},
    {id:'content_25',title:'Prolific Writer',desc:'Create 25 content items',check:content.length>=25,icon:'+'},
    {id:'words_1k',title:'Wordsmith',desc:'Write 1,000 words total',check:totalWords>=1000,icon:'W'},
    {id:'words_10k',title:'Author',desc:'Write 10,000 words total',check:totalWords>=10000,icon:'W'},
    {id:'words_50k',title:'NaNoWriMo',desc:'Write 50,000 words total',check:totalWords>=50000,icon:'W'},
    {id:'links_10',title:'Researcher',desc:'Save 10 links',check:links.length>=10,icon:'L'},
    {id:'links_50',title:'Link Hoarder',desc:'Save 50 links',check:links.length>=50,icon:'L'},
    {id:'docs_3',title:'Documenter',desc:'Create 3 writer docs',check:docs.length>=3,icon:'D'},
    {id:'docs_10',title:'Novelist',desc:'Create 10 writer docs',check:docs.length>=10,icon:'D'},
    {id:'projects_3',title:'Multi-Tasker',desc:'Have 3 projects',check:(S.projects||[]).length>=3,icon:'P'},
    {id:'streak_7',title:'Week Warrior',desc:'7-day usage streak',check:(S._streak||0)>=7,icon:'F'},
    {id:'streak_30',title:'Monthly Champion',desc:'30-day usage streak',check:(S._streak||0)>=30,icon:'F'},
  ];
  const unlocked=achievements.filter(a=>a.check).length;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Achievements</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="text-align:center;margin-bottom:16px"><span style="font-size:28px;font-weight:700;color:#4ade80">${unlocked}</span><span style="font-size:14px;color:var(--text-muted)"> / ${achievements.length} unlocked</span></div>`;
  h+=`<div style="height:8px;background:var(--bg-surface);border-radius:4px;margin-bottom:16px;overflow:hidden"><div style="height:100%;width:${Math.round(unlocked/achievements.length*100)}%;background:#4ade80;border-radius:4px"></div></div>`;
  achievements.forEach(a=>{
    h+=`<div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg-surface);border-radius:8px;margin-bottom:6px;opacity:${a.check?'1':'0.4'}">`;
    h+=`<div style="width:36px;height:36px;border-radius:50%;background:${a.check?'#4ade80':'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:${a.check?'#000':'var(--text-muted)'}">${a.check?a.icon:'?'}</div>`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary);font-weight:600">${a.title}</div><div style="font-size:10px;color:var(--text-muted)">${a.desc}</div></div>`;
    if(a.check)h+=`<div style="font-size:10px;color:#4ade80;font-weight:600">UNLOCKED</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showFocusHistory(){
  let panel=document.getElementById('focus-hist-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='focus-hist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const sessions=(S._focusSessions||[]);
  const totalMin=sessions.reduce((s,f)=>s+(f.duration||0),0);
  const totalSessions=sessions.length;
  const avgMin=totalSessions?Math.round(totalMin/totalSessions):0;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Focus Session History</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${totalSessions}</div><div style="font-size:10px;color:var(--text-muted)">Total Sessions</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#60a5fa">${totalMin}m</div><div style="font-size:10px;color:var(--text-muted)">Total Focus Time</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#facc15">${avgMin}m</div><div style="font-size:10px;color:var(--text-muted)">Avg Session</div></div>`;
  h+='</div>';
  if(!sessions.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No focus sessions recorded yet. Start a Pomodoro timer to begin tracking.</div>';
  } else {
    const last14=[];
    const now=new Date();
    for(let i=13;i>=0;i--){
      const d=new Date(now);d.setDate(d.getDate()-i);
      const dateStr=d.toISOString().split('T')[0];
      const dayMins=sessions.filter(s=>s.date&&s.date.startsWith(dateStr)).reduce((sum,s)=>sum+(s.duration||0),0);
      last14.push({label:d.toLocaleDateString('en',{month:'short',day:'numeric'}),mins:dayMins});
    }
    const maxMins=Math.max(...last14.map(d=>d.mins),1);
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Last 14 days:</div>';
    h+='<div style="display:flex;align-items:flex-end;gap:4px;height:100px;margin-bottom:8px">';
    last14.forEach(d=>{
      const h2=d.mins?Math.max(4,d.mins/maxMins*90):2;
      const color=d.mins>0?'#4ade80':'var(--border)';
      h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px"><div style="font-size:8px;color:var(--text-muted)">${d.mins||''}</div><div style="width:100%;height:${h2}px;background:${color};border-radius:3px"></div><div style="font-size:7px;color:var(--text-muted)">${d.label.split(' ')[1]}</div></div>`;
    });
    h+='</div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-top:12px;margin-bottom:6px">Recent sessions:</div>';
    sessions.slice(-10).reverse().forEach(s=>{
      const d=s.date?new Date(s.date).toLocaleDateString('en',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'Unknown';
      h+=`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:11px;border-bottom:1px solid var(--border)"><span style="color:var(--text-secondary)">${d}</span><span style="color:#4ade80;font-weight:600">${s.duration||0}m</span></div>`;
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickLink(){
  let panel=document.getElementById('quick-link-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-link-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-weight:700;font-size:13px;color:var(--text-primary)">Quick Link</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<input id="quick-link-url" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;margin-bottom:8px" placeholder="URL...">';
  h+='<input id="quick-link-title" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;margin-bottom:8px" placeholder="Title (optional)">';
  h+='<div style="display:flex;gap:8px">';
  h+='<select id="quick-link-cat" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px"><option value="">Category</option><option value="reference">Reference</option><option value="tool">Tool</option><option value="inspiration">Inspiration</option><option value="learning">Learning</option><option value="resource">Resource</option></select>';
  h+=`<button onclick="(function(){const url=document.getElementById('quick-link-url').value.trim();if(!url)return;if(!S.links)S.links=[];const title=document.getElementById('quick-link-title').value.trim()||url;const cat=document.getElementById('quick-link-cat').value;S.links.unshift({id:'l_'+Date.now(),url:url,title:title,category:cat,tags:[],createdAt:new Date().toISOString(),pinned:false});save();document.getElementById('quick-link-panel').remove();if(typeof renderLinks==='function')renderLinks();})()" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer">Save</button>`;
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const inp=document.getElementById('quick-link-url');if(inp)inp.focus();},100);
}
function showStorageManager(){
  let panel=document.getElementById('storage-mgr-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='storage-mgr-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const sections=[
    {key:'tasks',label:'Tasks'},
    {key:'content',label:'Content'},
    {key:'links',label:'Links'},
    {key:'projects',label:'Projects'},
    {key:'writerDocs',label:'Writer Docs'},
    {key:'specs',label:'Living Docs'},
    {key:'repos',label:'Repos'},
    {key:'_goals',label:'Goals'},
    {key:'_habits',label:'Habits'},
    {key:'_moods',label:'Moods'},
    {key:'_microJournal',label:'Micro Journal'},
    {key:'_gratitude',label:'Gratitude'},
    {key:'_focusSessions',label:'Focus Sessions'},
    {key:'_savedSearches',label:'Saved Searches'},
    {key:'_changelog',label:'Changelog'},
    {key:'_dailyStats',label:'Daily Stats'},
  ];
  const sizes=sections.map(s=>{
    const val=S[s.key];
    const size=val?JSON.stringify(val).length:0;
    return {...s,size,count:Array.isArray(val)?val.length:0};
  }).sort((a,b)=>b.size-a.size);
  const totalSize=JSON.stringify(S).length;
  const totalKB=(totalSize/1024).toFixed(1);
  const maxLS=5*1024*1024;
  const usagePct=Math.round(totalSize/maxLS*100);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Storage Manager</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const barColor=usagePct>80?'#f87171':usagePct>50?'#facc15':'#4ade80';
  h+=`<div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-bottom:4px"><span>${totalKB} KB used</span><span>${(maxLS/1024).toFixed(0)} KB limit (5MB)</span></div>`;
  h+=`<div style="height:16px;background:var(--bg-surface);border-radius:8px;overflow:hidden"><div style="height:100%;width:${usagePct}%;background:${barColor};border-radius:8px;transition:width 0.3s"></div></div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:4px">${usagePct}% used</div></div>`;
  const maxSize=sizes[0]?.size||1;
  sizes.forEach(s=>{
    if(s.size===0)return;
    const pct=Math.round(s.size/maxSize*100);
    const sizeKB=(s.size/1024).toFixed(1);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px">`;
    h+=`<div style="width:90px;font-size:10px;color:var(--text-secondary);text-align:right">${s.label}</div>`;
    h+=`<div style="flex:1;height:12px;background:var(--bg-surface);border-radius:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${barColor};border-radius:6px"></div></div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);width:70px">${sizeKB}KB (${s.count})</div>`;
    h+=`</div>`;
  });
  h+=`<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted)">Tip: Archive old tasks and content to free up space. Use cloud sync to backup before cleanup.</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskAging(){
  let panel=document.getElementById('task-aging-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-aging-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&t.createdAt);
  const now=new Date();
  const aged=tasks.map(t=>{
    const created=new Date(t.createdAt);
    const days=Math.floor((now-created)/(1000*60*60*24));
    return {...t,ageDays:days};
  }).sort((a,b)=>b.ageDays-a.ageDays);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Task Aging Report</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const brackets=[
    {label:'Fresh (0-3 days)',min:0,max:3,color:'#4ade80'},
    {label:'Normal (4-7 days)',min:4,max:7,color:'#60a5fa'},
    {label:'Aging (8-14 days)',min:8,max:14,color:'#facc15'},
    {label:'Stale (15-30 days)',min:15,max:30,color:'#fb923c'},
    {label:'Ancient (30+ days)',min:31,max:9999,color:'#f87171'},
  ];
  h+='<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">';
  brackets.forEach(b=>{
    const count=aged.filter(t=>t.ageDays>=b.min&&t.ageDays<=b.max).length;
    h+=`<div style="background:var(--bg-surface);padding:8px 12px;border-radius:6px;text-align:center;border-left:3px solid ${b.color}"><div style="font-size:16px;font-weight:700;color:${b.color}">${count}</div><div style="font-size:9px;color:var(--text-muted)">${b.label}</div></div>`;
  });
  h+='</div>';
  if(!aged.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No open tasks found</div>';}
  aged.slice(0,20).forEach(t=>{
    const color=t.ageDays>30?'#f87171':t.ageDays>14?'#fb923c':t.ageDays>7?'#facc15':t.ageDays>3?'#60a5fa':'#4ade80';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">`;
    h+=`<div style="min-width:45px;font-size:11px;font-weight:700;color:${color}">${t.ageDays}d</div>`;
    h+=`<div style="flex:1;font-size:11px;color:var(--text-secondary)">${esc(t.title||'Untitled').substring(0,40)}</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted)">${t.status}</div>`;
    h+=`</div>`;
  });
  if(aged.length>20)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px">Showing 20 of ${aged.length} open tasks</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentWordFrequency(){
  let panel=document.getElementById('word-freq-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='word-freq-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const stopWords=new Set(['the','be','to','of','and','a','in','that','have','i','it','for','not','on','with','he','as','you','do','at','this','but','his','by','from','they','we','her','she','or','an','will','my','one','all','would','there','their','what','so','up','out','if','about','who','get','which','go','me','when','make','can','like','time','no','just','him','know','take','people','into','year','your','good','some','could','them','see','other','than','then','now','look','only','come','its','over','think','also','back','after','use','two','how','our','work','first','well','way','even','new','want','because','any','these','give','day','most','us']);
  const wordCount={};
  content.forEach(c=>{
    const text=((c.body||'')+' '+(c.title||'')).toLowerCase().replace(/[^a-z\s]/g,'');
    text.split(/\s+/).forEach(w=>{
      if(w.length>2&&!stopWords.has(w))wordCount[w]=(wordCount[w]||0)+1;
    });
  });
  const words=Object.entries(wordCount).sort((a,b)=>b[1]-a[1]).slice(0,30);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Word Frequency (Top 30)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!words.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No content with enough text to analyze</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const maxC=words[0][1];
  const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#a78bfa','#34d399'];
  words.forEach(([word,count],i)=>{
    const pct=Math.round(count/maxC*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px">`;
    h+=`<div style="width:80px;font-size:11px;color:var(--text-secondary);text-align:right;font-family:monospace">${word}</div>`;
    h+=`<div style="flex:1;height:12px;background:var(--bg-surface);border-radius:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[i%colors.length]};border-radius:6px"></div></div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);width:30px">${count}</div>`;
    h+=`</div>`;
  });
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">${Object.keys(wordCount).length} unique words across ${content.length} items (common words excluded)</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDailyPlanner(){
  let panel=document.getElementById('daily-planner-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='daily-planner-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  const todayStr=now.toISOString().split('T')[0];
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const todayTasks=tasks.filter(t=>t.due&&t.due.startsWith(todayStr));
  const overdue=tasks.filter(t=>t.due&&t.due<todayStr);
  const noDue=tasks.filter(t=>!t.due).slice(0,5);
  const dateDisplay=now.toLocaleDateString('en',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Daily Planner</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:12px;color:var(--accent);margin-bottom:16px">${dateDisplay}</div>`;
  const blocks=[
    {name:'Morning (6am-12pm)',icon:'M',tasks:todayTasks.filter((_,i)=>i<Math.ceil(todayTasks.length/3)),color:'#facc15'},
    {name:'Afternoon (12pm-6pm)',icon:'A',tasks:todayTasks.filter((_,i)=>i>=Math.ceil(todayTasks.length/3)&&i<Math.ceil(todayTasks.length*2/3)),color:'#fb923c'},
    {name:'Evening (6pm-12am)',icon:'E',tasks:todayTasks.filter((_,i)=>i>=Math.ceil(todayTasks.length*2/3)),color:'#a78bfa'},
  ];
  blocks.forEach(b=>{
    h+=`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:${b.color};margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)">${b.name}</div>`;
    if(b.tasks.length===0)h+=`<div style="font-size:10px;color:var(--text-muted);padding:8px;font-style:italic">No tasks scheduled</div>`;
    b.tasks.forEach(t=>{
      const pColor=t.priority==='p0'?'#f87171':t.priority==='p1'?'#fb923c':t.priority==='p2'?'#60a5fa':'#6b7280';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px"><span style="color:${pColor};font-size:8px">●</span><span style="font-size:11px;color:var(--text-primary)">${esc(t.title||'').substring(0,40)}</span><span style="font-size:9px;color:var(--text-muted);margin-left:auto">${t.priority||''}</span></div>`;
    });
    h+=`</div>`;
  });
  if(overdue.length){
    h+=`<div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border)"><div style="font-size:11px;font-weight:600;color:#f87171;margin-bottom:6px">Overdue (${overdue.length})</div>`;
    overdue.slice(0,5).forEach(t=>{
      h+=`<div style="font-size:11px;color:var(--text-secondary);padding:4px 0">[!] ${esc(t.title||'').substring(0,35)} (due ${t.due})</div>`;
    });
    if(overdue.length>5)h+=`<div style="font-size:10px;color:var(--text-muted)">...and ${overdue.length-5} more</div>`;
    h+=`</div>`;
  }
  if(noDue.length){
    h+=`<div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border)"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px">Unscheduled (top 5)</div>`;
    noDue.forEach(t=>{h+=`<div style="font-size:11px;color:var(--text-muted);padding:4px 0">[ ] ${esc(t.title||'').substring(0,40)}</div>`;});
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentLengthChart(){
  let panel=document.getElementById('content-length-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-length-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const buckets=[
    {label:'Tiny (<50 words)',min:0,max:49,color:'#60a5fa',items:[]},
    {label:'Short (50-200)',min:50,max:200,color:'#4ade80',items:[]},
    {label:'Medium (200-500)',min:200,max:500,color:'#facc15',items:[]},
    {label:'Long (500-1000)',min:500,max:1000,color:'#fb923c',items:[]},
    {label:'Epic (1000+)',min:1000,max:999999,color:'#f87171',items:[]},
  ];
  content.forEach(c=>{
    const words=(c.body||'').trim().split(/\s+/).filter(Boolean).length;
    const bucket=buckets.find(b=>words>=b.min&&words<=b.max);
    if(bucket)bucket.items.push(c);
  });
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Length Distribution</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!content.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No content found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const maxCount=Math.max(...buckets.map(b=>b.items.length),1);
  buckets.forEach(b=>{
    const pct=Math.round(b.items.length/maxCount*100);
    h+=`<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px"><span style="color:var(--text-secondary)">${b.label}</span><span style="color:${b.color};font-weight:600">${b.items.length}</span></div>`;
    h+=`<div style="height:20px;background:var(--bg-surface);border-radius:10px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${b.color};border-radius:10px;opacity:0.8"></div></div></div>`;
  });
  const totalWords=content.reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0);
  const avgWords=content.length?Math.round(totalWords/content.length):0;
  h+=`<div style="margin-top:16px;display:flex;gap:16px;justify-content:center;font-size:10px;color:var(--text-muted)"><span>Total: ${content.length} items</span><span>Avg: ${avgWords} words</span><span>Total: ${totalWords.toLocaleString()} words</span></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectNotes(){
  let panel=document.getElementById('proj-notes-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-notes-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._projectNotes)S._projectNotes={};
  const projects=(S.projects||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Project Notes</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!projects.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No projects found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  projects.forEach(p=>{
    const noteKey=p.id;
    const note=S._projectNotes[noteKey]||'';
    h+=`<div style="margin-bottom:12px"><div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:4px">${esc(p.name||'Untitled')}</div>`;
    h+=`<textarea data-proj-note="${noteKey}" style="width:100%;height:60px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:11px;resize:vertical;font-family:inherit" placeholder="Notes for ${esc(p.name||'')}...">${esc(note)}</textarea></div>`;
  });
  h+=`<button onclick="(function(){document.querySelectorAll('[data-proj-note]').forEach(ta=>{const key=ta.getAttribute('data-proj-note');S._projectNotes[key]=ta.value;});save();document.getElementById('proj-notes-panel').querySelector('button:last-child').textContent='Saved!';setTimeout(()=>{const btn=document.getElementById('proj-notes-panel');if(btn)btn.querySelector('button:last-child').textContent='Save All Notes';},1500);})()" style="width:100%;background:var(--accent);color:#000;border:none;border-radius:6px;padding:10px;font-size:12px;font-weight:600;cursor:pointer">Save All Notes</button>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDuplicateDetector(){
  let panel=document.getElementById('dupe-detect-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='dupe-detect-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  function similar(a,b){const al=a.toLowerCase();const bl=b.toLowerCase();if(al===bl)return 1;const longer=al.length>bl.length?al:bl;const shorter=al.length>bl.length?bl:al;if(longer.length===0)return 1;let matches=0;for(let i=0;i<shorter.length;i++){if(longer.includes(shorter[i]))matches++;}return matches/longer.length;}
  const content=(S.content||[]);
  const tasks=(S.tasks||[]);
  const dupes=[];
  for(let i=0;i<content.length;i++){
    for(let j=i+1;j<content.length;j++){
      const score=similar(content[i].title||'',content[j].title||'');
      if(score>0.8&&(content[i].title||'').length>3){
        dupes.push({type:'content',a:content[i],b:content[j],score});
      }
    }
  }
  for(let i=0;i<tasks.length;i++){
    for(let j=i+1;j<tasks.length;j++){
      const score=similar(tasks[i].title||'',tasks[j].title||'');
      if(score>0.8&&(tasks[i].title||'').length>3){
        dupes.push({type:'task',a:tasks[i],b:tasks[j],score});
      }
    }
  }
  dupes.sort((a,b)=>b.score-a.score);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Duplicate Detector</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Scanned ${content.length} content items and ${tasks.length} tasks. Found ${dupes.length} potential duplicates.</div>`;
  if(!dupes.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No duplicates found. Your data is clean!</div>';}
  dupes.slice(0,20).forEach(d=>{
    const pct=Math.round(d.score*100);
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;margin-bottom:8px;border-left:3px solid ${pct>95?'#f87171':'#facc15'}">`;
    h+=`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">${d.type.toUpperCase()} | ${pct}% similar</div>`;
    h+=`<div style="font-size:11px;color:var(--text-primary);margin-bottom:2px">A: ${esc((d.a.title||'').substring(0,50))}</div>`;
    h+=`<div style="font-size:11px;color:var(--text-secondary)">B: ${esc((d.b.title||'').substring(0,50))}</div>`;
    h+=`</div>`;
  });
  if(dupes.length>20)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px">Showing 20 of ${dupes.length} potential duplicates</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickSearchPanel(){
  let panel=document.getElementById('quick-search-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Universal Search</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<input id="univ-search-input" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:13px;margin-bottom:12px" placeholder="Search everything..." oninput="universalSearch(this.value)">';
  h+='<div id="univ-search-results" style="max-height:50vh;overflow-y:auto"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const inp=document.getElementById('univ-search-input');if(inp)inp.focus();},100);
}
function universalSearch(q){
  const results=document.getElementById('univ-search-results');if(!results)return;
  if(!q||q.length<2){results.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">Type at least 2 characters to search</div>';return;}
  const ql=q.toLowerCase();
  const items=[];
  (S.tasks||[]).forEach(t=>{if((t.title||'').toLowerCase().includes(ql)||(t.description||'').toLowerCase().includes(ql))items.push({type:'Task',title:t.title,sub:t.status+' | '+(t.priority||''),color:'#60a5fa'});});
  (S.content||[]).forEach(c=>{if((c.title||'').toLowerCase().includes(ql)||(c.body||'').toLowerCase().includes(ql))items.push({type:'Content',title:c.title,sub:(c.theme||'')+(c.body?(' | '+c.body.substring(0,60)):''),color:'#a78bfa'});});
  (S.links||[]).forEach(l=>{if((l.title||'').toLowerCase().includes(ql)||(l.url||'').toLowerCase().includes(ql))items.push({type:'Link',title:l.title||l.url,sub:l.category||l.url||'',color:'#38bdf8'});});
  (S.writerDocs||[]).forEach(d=>{if((d.title||'').toLowerCase().includes(ql)||(d.content||'').toLowerCase().includes(ql))items.push({type:'Doc',title:d.title,sub:(d.content||'').substring(0,60),color:'#fbbf24'});});
  (S.projects||[]).forEach(p=>{if((p.name||'').toLowerCase().includes(ql)||(p.description||'').toLowerCase().includes(ql))items.push({type:'Project',title:p.name,sub:p.description||'',color:'#4ade80'});});
  let h='';
  if(!items.length)h='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">No results found</div>';
  items.slice(0,30).forEach(item=>{
    h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid var(--border)">`;
    h+=`<div style="background:${item.color};color:#000;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;min-width:50px;text-align:center">${item.type}</div>`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary)">${esc((item.title||'').substring(0,50))}</div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted)">${esc((item.sub||'').substring(0,60))}</div></div>`;
    h+=`</div>`;
  });
  if(items.length>30)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:8px">${items.length} results (showing 30)</div>`;
  results.innerHTML=h;
}
function showEisenhowerMatrix(){
  let panel=document.getElementById('eisenhower-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='eisenhower-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();
  const weekFromNow=new Date(now.getTime()+7*86400000);
  const urgent=t=>t.due&&new Date(t.due)<=weekFromNow;
  const important=t=>t.priority==='p0'||t.priority==='p1';
  const q1=tasks.filter(t=>urgent(t)&&important(t));
  const q2=tasks.filter(t=>!urgent(t)&&important(t));
  const q3=tasks.filter(t=>urgent(t)&&!important(t));
  const q4=tasks.filter(t=>!urgent(t)&&!important(t));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Eisenhower Matrix</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-bottom:8px">Urgent = due within 7 days | Important = P0 or P1</div>';
  const quads=[
    {title:'DO FIRST',sub:'Urgent + Important',tasks:q1,color:'#f87171',bg:'rgba(248,113,113,0.1)'},
    {title:'SCHEDULE',sub:'Not Urgent + Important',tasks:q2,color:'#60a5fa',bg:'rgba(96,165,250,0.1)'},
    {title:'DELEGATE',sub:'Urgent + Not Important',tasks:q3,color:'#facc15',bg:'rgba(250,204,21,0.1)'},
    {title:'ELIMINATE',sub:'Not Urgent + Not Important',tasks:q4,color:'#6b7280',bg:'rgba(107,114,128,0.1)'},
  ];
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  quads.forEach(q=>{
    h+=`<div style="background:${q.bg};border:1px solid ${q.color}30;border-radius:8px;padding:12px;min-height:120px">`;
    h+=`<div style="font-size:11px;font-weight:700;color:${q.color};margin-bottom:2px">${q.title} (${q.tasks.length})</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);margin-bottom:8px">${q.sub}</div>`;
    q.tasks.slice(0,6).forEach(t=>{
      h+=`<div style="font-size:10px;color:var(--text-secondary);padding:3px 0;border-bottom:1px solid ${q.color}15">${esc(t.title||'').substring(0,30)}${t.due?' ('+t.due+')':''}</div>`;
    });
    if(q.tasks.length>6)h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:4px">+${q.tasks.length-6} more</div>`;
    if(!q.tasks.length)h+=`<div style="font-size:10px;color:var(--text-muted);font-style:italic">Empty</div>`;
    h+=`</div>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWriterProgress(){
  let panel=document.getElementById('writer-prog-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writer-prog-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._writerTargets)S._writerTargets={};
  const docs=(S.writerDocs||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Writer Progress Tracker</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!docs.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No writer docs found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const totalTarget=Object.values(S._writerTargets).reduce((s,v)=>s+v,0);
  const totalWords=docs.reduce((s,d)=>s+(d.content||'').trim().split(/\s+/).filter(Boolean).length,0);
  if(totalTarget>0){
    const pct=Math.min(100,Math.round(totalWords/totalTarget*100));
    h+=`<div style="margin-bottom:16px;text-align:center"><span style="font-size:28px;font-weight:700;color:#4ade80">${totalWords.toLocaleString()}</span><span style="font-size:14px;color:var(--text-muted)"> / ${totalTarget.toLocaleString()} words</span></div>`;
    h+=`<div style="height:12px;background:var(--bg-surface);border-radius:6px;overflow:hidden;margin-bottom:16px"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:6px"></div></div>`;
  }
  docs.forEach(d=>{
    const words=(d.content||'').trim().split(/\s+/).filter(Boolean).length;
    const target=S._writerTargets[d.id]||0;
    const pct=target?Math.min(100,Math.round(words/target*100)):0;
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;margin-bottom:6px">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">`;
    h+=`<span style="font-size:12px;color:var(--text-primary);font-weight:500">${esc(d.title||'Untitled')}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${words} words</span>`;
    h+=`</div>`;
    h+=`<div style="display:flex;align-items:center;gap:8px">`;
    h+=`<div style="flex:1;height:8px;background:var(--bg-elevated);border-radius:4px;overflow:hidden"><div style="height:100%;width:${target?pct:0}%;background:${pct>=100?'#4ade80':'#60a5fa'};border-radius:4px"></div></div>`;
    h+=`<input type="number" value="${target||''}" placeholder="Target" style="width:70px;background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px 6px;font-size:10px" onchange="S._writerTargets['${d.id}']=parseInt(this.value)||0;save();showWriterProgress();">`;
    h+=`</div>`;
    if(target)h+=`<div style="font-size:9px;color:${pct>=100?'#4ade80':'var(--text-muted)'};margin-top:3px">${pct}%${pct>=100?' - TARGET REACHED':''}</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showBatchOperations(){
  let panel=document.getElementById('batch-ops-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='batch-ops-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const tasks=(S.tasks||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Batch Operations</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:16px">Perform bulk operations across your workspace. Use with caution.</div>';
  // Content operations
  h+='<div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:8px">Content Operations</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">';
  h+=`<button onclick="(function(){const tag=prompt('Tag to add to ALL content items:');if(!tag)return;(S.content||[]).forEach(c=>{if(!c.tags)c.tags=[];if(!c.tags.includes(tag))c.tags.push(tag);});save();alert('Tagged '+S.content.length+' items with: '+tag);})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Tag All Content</button>`;
  h+=`<button onclick="(function(){const tag=prompt('Tag to REMOVE from all content:');if(!tag)return;let count=0;(S.content||[]).forEach(c=>{if(c.tags){const idx=c.tags.indexOf(tag);if(idx>-1){c.tags.splice(idx,1);count++;}}});save();alert('Removed tag from '+count+' items');})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Remove Tag</button>`;
  h+=`<button onclick="(function(){const old=prompt('Old theme/category:');if(!old)return;const nw=prompt('New theme/category:');if(!nw)return;let count=0;(S.content||[]).forEach(c=>{if(c.theme===old){c.theme=nw;count++;}if(c.category===old){c.category=nw;count++;}});save();alert('Renamed '+count+' items from '+old+' to '+nw);})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Rename Category</button>`;
  h+='</div>';
  // Task operations
  h+='<div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:8px">Task Operations</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">';
  h+=`<button onclick="(function(){const count=S.tasks?S.tasks.filter(t=>t.status==='done').length:0;if(!count){alert('No done tasks to archive');return;}if(!confirm('Archive '+count+' completed tasks?'))return;S._archivedTasks=(S._archivedTasks||[]).concat(S.tasks.filter(t=>t.status==='done'));S.tasks=S.tasks.filter(t=>t.status!=='done');save();alert('Archived '+count+' tasks');showBatchOperations();})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Archive Done Tasks</button>`;
  h+=`<button onclick="(function(){const proj=prompt('Project name to assign ALL unassigned tasks:');if(!proj)return;let count=0;(S.tasks||[]).forEach(t=>{if(!t.project&&!t.projectId){t.project=proj;count++;}});save();alert('Assigned '+count+' tasks to '+proj);})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Assign Unassigned</button>`;
  h+=`<button onclick="(function(){let count=0;(S.tasks||[]).forEach(t=>{if(t.status!=='done'&&t.due&&new Date(t.due)<new Date()){const nd=new Date();nd.setDate(nd.getDate()+7);t.due=nd.toISOString().split('T')[0];count++;}});save();alert('Rescheduled '+count+' overdue tasks to next week');})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Reschedule Overdue</button>`;
  h+='</div>';
  h+=`<div style="font-size:10px;color:var(--text-muted);padding-top:8px;border-top:1px solid var(--border)">Stats: ${content.length} content items, ${tasks.length} tasks (${tasks.filter(t=>t.status==='done').length} done)</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContextSwitcher(){
  let panel=document.getElementById('ctx-switch-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ctx-switch-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._workContext)S._workContext='all';
  const contexts=[
    {id:'all',name:'All',desc:'Show everything',icon:'*',color:'#4ade80'},
    {id:'work',name:'Work',desc:'Work-related tasks and content only',icon:'W',color:'#60a5fa'},
    {id:'personal',name:'Personal',desc:'Personal items and goals',icon:'P',color:'#a78bfa'},
    {id:'creative',name:'Creative',desc:'Writing, content creation, ideas',icon:'C',color:'#facc15'},
    {id:'urgent',name:'Urgent',desc:'Only P0/P1 tasks and overdue',icon:'!',color:'#f87171'},
  ];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Workspace Context</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Current: <span style="color:var(--accent);font-weight:600">${contexts.find(c=>c.id===S._workContext)?.name||'All'}</span></div>`;
  contexts.forEach(c=>{
    const active=S._workContext===c.id;
    h+=`<div onclick="S._workContext='${c.id}';save();showContextSwitcher();" style="display:flex;align-items:center;gap:12px;padding:12px;background:${active?c.color+'20':'var(--bg-surface)'};border:1px solid ${active?c.color:'transparent'};border-radius:8px;margin-bottom:6px;cursor:pointer">`;
    h+=`<div style="width:36px;height:36px;border-radius:50%;background:${active?c.color:'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:${active?'#000':'var(--text-muted)'}">${c.icon}</div>`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary);font-weight:600">${c.name}</div><div style="font-size:10px;color:var(--text-muted)">${c.desc}</div></div>`;
    if(active)h+=`<div style="font-size:10px;color:${c.color};font-weight:600">ACTIVE</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDailyChecklist(){
  let panel=document.getElementById('daily-check-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='daily-check-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._dailyChecklist)S._dailyChecklist={items:[],lastReset:''};
  const today=new Date().toISOString().split('T')[0];
  if(S._dailyChecklist.lastReset!==today){S._dailyChecklist.items.forEach(i=>i.done=false);S._dailyChecklist.lastReset=today;save();}
  function render(){
    const items=S._dailyChecklist.items;
    const done=items.filter(i=>i.done).length;
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Daily Checklist</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">${today} | ${done}/${items.length} complete</div>`;
    if(items.length){
      const pct=Math.round(done/items.length*100);
      h+=`<div style="height:8px;background:var(--bg-surface);border-radius:4px;margin-bottom:16px;overflow:hidden"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:4px"></div></div>`;
    }
    items.forEach((item,i)=>{
      h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid var(--border)">`;
      h+=`<input type="checkbox" ${item.done?'checked':''} onchange="S._dailyChecklist.items[${i}].done=this.checked;save();showDailyChecklist();" style="cursor:pointer;width:16px;height:16px">`;
      h+=`<span style="flex:1;font-size:12px;color:${item.done?'var(--text-muted)':'var(--text-primary)'};${item.done?'text-decoration:line-through':''}">${esc(item.title)}</span>`;
      h+=`<button onclick="S._dailyChecklist.items.splice(${i},1);save();showDailyChecklist();" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px">x</button>`;
      h+=`</div>`;
    });
    h+='<div style="display:flex;gap:8px;margin-top:12px">';
    h+=`<input id="daily-check-input" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px" placeholder="Add recurring item..." onkeydown="if(event.key==='Enter'){const v=this.value.trim();if(v){S._dailyChecklist.items.push({title:v,done:false});save();showDailyChecklist();}}">`;
    h+=`<button onclick="const inp=document.getElementById('daily-check-input');const v=inp.value.trim();if(v){S._dailyChecklist.items.push({title:v,done:false});save();showDailyChecklist();}" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px 12px;font-size:11px;font-weight:600;cursor:pointer">Add</button>`;
    h+='</div>';
    h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:8px;text-align:center">Items reset daily. Check marks clear each morning.</div>`;
    panel.innerHTML=h;
  }
  render();
  document.body.appendChild(panel);
}
function showKnowledgeMap(){
  let panel=document.getElementById('knowledge-map-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='knowledge-map-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const linkMap={};
  const wikiPattern=/\[\[([^\]]+)\]\]/g;
  content.forEach(c=>{
    const body=(c.body||'')+(c.title||'');
    let match;
    while((match=wikiPattern.exec(body))!==null){
      const target=match[1].toLowerCase();
      if(!linkMap[c.title])linkMap[c.title]=[];
      linkMap[c.title].push(target);
    }
  });
  const entries=Object.entries(linkMap).filter(([_,refs])=>refs.length>0).sort((a,b)=>b[1].length-a[1].length);
  const allTargets={};
  entries.forEach(([src,refs])=>{refs.forEach(r=>{allTargets[r]=(allTargets[r]||0)+1;});});
  const topTargets=Object.entries(allTargets).sort((a,b)=>b[1]-a[1]).slice(0,15);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Knowledge Map</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${entries.length} items with [[wiki-links]] | ${Object.keys(allTargets).length} unique targets</div>`;
  if(topTargets.length){
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Most referenced:</div>';
    const maxRef=topTargets[0]?topTargets[0][1]:1;
    topTargets.forEach(([target,count])=>{
      const pct=Math.round(count/maxRef*100);
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px"><div style="width:100px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(target)}</div><div style="flex:1;height:10px;background:var(--bg-surface);border-radius:5px;overflow:hidden"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:5px"></div></div><div style="font-size:9px;color:var(--text-muted);width:25px">${count}</div></div>`;
    });
  }
  if(entries.length){
    h+='<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);margin-bottom:6px">Items with outgoing links:</div>';
    entries.slice(0,15).forEach(([src,refs])=>{
      h+=`<div style="padding:6px 0;border-bottom:1px solid var(--border)"><div style="font-size:11px;color:var(--text-primary);font-weight:500">${esc(src).substring(0,40)}</div>`;
      h+=`<div style="font-size:9px;color:var(--accent);margin-top:2px">Links to: ${refs.map(r=>esc(r)).join(', ')}</div></div>`;
    });
  }
  if(!entries.length&&!topTargets.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No [[wiki-links]] found in content. Use [[Page Name]] syntax to link items.</div>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentExportHub(){
  let panel=document.getElementById('export-hub-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='export-hub-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Export Hub</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:16px">Export your workspace data in various formats.</div>';
  const exports=[
    {label:'Full Backup (JSON)',desc:'Complete workspace state for backup/restore',action:function(){const data=JSON.stringify(S,null,2);const blob=new Blob([data],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='astra-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(url);}},
    {label:'Tasks (CSV)',desc:'Export tasks as CSV spreadsheet',action:function(){let csv='Title,Status,Priority,Due,Project,Created\\n';(S.tasks||[]).forEach(t=>{csv+='"'+((t.title||'').replace(/"/g,'""'))+'","'+(t.status||'')+'","'+(t.priority||'')+'","'+(t.due||'')+'","'+(t.project||'')+'","'+(t.createdAt||'')+'"\\n';});navigator.clipboard.writeText(csv);alert('Tasks CSV copied to clipboard ('+S.tasks.length+' rows)');}},
    {label:'Content (Markdown)',desc:'Export all content as markdown',action:function(){let md='# ASTRA Content Export\\n\\n';(S.content||[]).forEach(c=>{md+='## '+((c.title||'Untitled'))+'\\n';if(c.theme)md+='*Theme: '+c.theme+'*\\n\\n';md+=(c.body||'')+('\\n\\n---\\n\\n');});navigator.clipboard.writeText(md);alert('Content markdown copied to clipboard');}},
    {label:'Links (Markdown)',desc:'Export all links as categorized markdown',action:function(){let md='# ASTRA Links Export\\n\\n';const cats={};(S.links||[]).forEach(l=>{const cat=l.category||'Uncategorized';if(!cats[cat])cats[cat]=[];cats[cat].push(l);});Object.entries(cats).forEach(([cat,links])=>{md+='## '+cat+'\\n\\n';links.forEach(l=>{md+='- ['+((l.title||l.url)||'')+']('+((l.url)||'')+')\\n';});md+='\\n';});navigator.clipboard.writeText(md);alert('Links markdown copied to clipboard');}},
    {label:'Writer Docs (Markdown)',desc:'Export all writer documents',action:function(){let md='';(S.writerDocs||[]).forEach(d=>{md+='# '+(d.title||'Untitled')+'\\n\\n'+(d.content||'')+'\\n\\n---\\n\\n';});navigator.clipboard.writeText(md);alert('Writer docs copied to clipboard ('+((S.writerDocs||[]).length)+' docs)');}},
    {label:'Everything (HTML)',desc:'Full workspace as printable HTML page',action:function(){if(typeof printableExport==='function')printableExport();else alert('Printable export not available');}},
  ];
  exports.forEach(ex=>{
    h+=`<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-surface);border-radius:8px;margin-bottom:6px;cursor:pointer" onclick="(${ex.action.toString()})()">`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary);font-weight:500">${ex.label}</div><div style="font-size:10px;color:var(--text-muted)">${ex.desc}</div></div>`;
    h+=`<div style="font-size:18px;color:var(--accent)">></div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskDependencyGraph(){
  let panel=document.getElementById('task-dep-graph-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-dep-graph-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const withDeps=tasks.filter(t=>t.blockedBy&&t.blockedBy.length>0);
  const blocking=tasks.filter(t=>{return tasks.some(t2=>t2.blockedBy&&t2.blockedBy.includes(t.id));});
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Task Dependencies</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${withDeps.length} blocked tasks | ${blocking.length} blocking tasks</div>`;
  if(!withDeps.length&&!blocking.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No task dependencies found. Use the "B" button in task detail to set blocked-by relationships.</div>';
  }
  blocking.forEach(t=>{
    const dependents=tasks.filter(t2=>t2.blockedBy&&t2.blockedBy.includes(t.id));
    const statusColor=t.status==='done'?'#4ade80':t.status==='in-progress'?'#facc15':'#60a5fa';
    h+=`<div style="margin-bottom:12px">`;
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${statusColor}">`;
    h+=`<div style="font-size:12px;color:var(--text-primary);font-weight:600;flex:1">${esc(t.title||'').substring(0,35)}</div>`;
    h+=`<div style="font-size:9px;color:${statusColor}">${t.status}</div>`;
    h+=`</div>`;
    dependents.forEach(dep=>{
      const depColor=dep.status==='done'?'#4ade80':dep.status==='in-progress'?'#facc15':'#f87171';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px 6px 28px;border-left:1px dashed var(--border);margin-left:12px">`;
      h+=`<span style="color:var(--text-muted);font-size:10px">blocks ></span>`;
      h+=`<span style="font-size:11px;color:var(--text-secondary)">${esc(dep.title||'').substring(0,30)}</span>`;
      h+=`<span style="font-size:9px;color:${depColor};margin-left:auto">${dep.status}</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showInboxZero(){
  let panel=document.getElementById('inbox-zero-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='inbox-zero-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const unprocessed=[];
  (S.tasks||[]).filter(t=>t.status==='todo'&&!t.priority).forEach(t=>unprocessed.push({type:'task',item:t,issue:'No priority set'}));
  (S.tasks||[]).filter(t=>t.status==='todo'&&!t.due).forEach(t=>unprocessed.push({type:'task',item:t,issue:'No due date'}));
  (S.tasks||[]).filter(t=>t.status==='todo'&&!t.project&&!t.projectId).forEach(t=>unprocessed.push({type:'task',item:t,issue:'No project assigned'}));
  (S.content||[]).filter(c=>!c.tags||c.tags.length===0).forEach(c=>unprocessed.push({type:'content',item:c,issue:'No tags'}));
  (S.content||[]).filter(c=>!c.theme&&!c.category).forEach(c=>unprocessed.push({type:'content',item:c,issue:'No category/theme'}));
  (S.links||[]).filter(l=>!l.category).forEach(l=>unprocessed.push({type:'link',item:l,issue:'No category'}));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Inbox Zero Triage</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${unprocessed.length} items need attention</div>`;
  if(!unprocessed.length){
    h+='<div style="text-align:center;padding:40px"><div style="font-size:24px;color:#4ade80;margin-bottom:8px">Inbox Zero!</div><div style="font-size:11px;color:var(--text-muted)">All items are categorized and processed.</div></div>';
  }
  const grouped={task:[],content:[],link:[]};
  unprocessed.forEach(u=>{if(grouped[u.type])grouped[u.type].push(u);});
  ['task','content','link'].forEach(type=>{
    const items=grouped[type];
    if(!items.length)return;
    const colors={task:'#60a5fa',content:'#a78bfa',link:'#38bdf8'};
    h+=`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:${colors[type]};margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)">${type.charAt(0).toUpperCase()+type.slice(1)}s (${items.length})</div>`;
    items.slice(0,10).forEach(u=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px">`;
      h+=`<span style="color:var(--text-secondary);flex:1">${esc((u.item.title||u.item.url||'').substring(0,35))}</span>`;
      h+=`<span style="font-size:9px;color:#f87171">${u.issue}</span>`;
      h+=`</div>`;
    });
    if(items.length>10)h+=`<div style="font-size:10px;color:var(--text-muted)">+${items.length-10} more</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showReadingList(){
  let panel=document.getElementById('reading-list-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='reading-list-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._readingList)S._readingList={};
  const links=(S.links||[]).filter(l=>l.category==='learning'||l.category==='reference'||l.category==='reading');
  const allLinks=[...(S.links||[])];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Reading List</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const readCount=allLinks.filter(l=>S._readingList[l.id]).length;
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${readCount} read / ${allLinks.length} total links</div>`;
  const unread=allLinks.filter(l=>!S._readingList[l.id]);
  const read=allLinks.filter(l=>S._readingList[l.id]);
  if(unread.length){
    h+='<div style="font-size:11px;color:var(--accent);font-weight:600;margin-bottom:6px">Unread</div>';
    unread.slice(0,20).forEach(l=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid var(--border)">`;
      h+=`<input type="checkbox" onchange="S._readingList['${l.id}']=this.checked;save();showReadingList();" style="cursor:pointer">`;
      h+=`<a href="${esc(l.url||'')}" target="_blank" style="flex:1;font-size:11px;color:var(--text-primary);text-decoration:none">${esc((l.title||l.url||'').substring(0,45))}</a>`;
      h+=`<span style="font-size:9px;color:var(--text-muted)">${l.category||''}</span>`;
      h+=`</div>`;
    });
    if(unread.length>20)h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:4px">+${unread.length-20} more</div>`;
  }
  if(read.length){
    h+=`<div style="font-size:11px;color:var(--text-muted);font-weight:600;margin:12px 0 6px;padding-top:8px;border-top:1px solid var(--border)">Read (${read.length})</div>`;
    read.slice(0,10).forEach(l=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 0;opacity:0.5">`;
      h+=`<input type="checkbox" checked onchange="delete S._readingList['${l.id}'];save();showReadingList();" style="cursor:pointer">`;
      h+=`<span style="font-size:11px;color:var(--text-muted);text-decoration:line-through">${esc((l.title||l.url||'').substring(0,40))}</span>`;
      h+=`</div>`;
    });
  }
  if(!allLinks.length)h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No links saved yet</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectStatusBoard(){
  let panel=document.getElementById('proj-status-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-status-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._projectStatus)S._projectStatus={};
  const projects=(S.projects||[]);
  const statuses=['on-track','at-risk','blocked','completed','paused'];
  const statusColors={'on-track':'#4ade80','at-risk':'#facc15','blocked':'#f87171','completed':'#60a5fa','paused':'#6b7280'};
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Project Status Board</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!projects.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No projects found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  projects.forEach(p=>{
    const status=S._projectStatus[p.id]||'on-track';
    const tasks=(S.tasks||[]).filter(t=>t.projectId===p.id||t.project===p.name);
    const done=tasks.filter(t=>t.status==='done').length;
    const pct=tasks.length?Math.round(done/tasks.length*100):0;
    h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:8px;border-left:3px solid ${statusColors[status]}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
    h+=`<span style="font-size:13px;color:var(--text-primary);font-weight:600">${esc(p.name||'Untitled')}</span>`;
    h+=`<select onchange="S._projectStatus['${p.id}']=this.value;save();showProjectStatusBoard();" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px 6px;font-size:10px">`;
    statuses.forEach(s=>{h+=`<option value="${s}" ${s===status?'selected':''}>${s}</option>`;});
    h+=`</select></div>`;
    h+=`<div style="height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden;margin-bottom:4px"><div style="height:100%;width:${pct}%;background:${statusColors[status]};border-radius:3px"></div></div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted)">${done}/${tasks.length} tasks (${pct}%)</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showCustomDashboard(){
  let panel=document.getElementById('custom-dash-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='custom-dash-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const content=(S.content||[]);const links=(S.links||[]);const docs=(S.writerDocs||[]);
  const now=new Date();const todayStr=now.toISOString().split('T')[0];
  const doneTasks=tasks.filter(t=>t.status==='done').length;
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now).length;
  const todayDue=tasks.filter(t=>t.status!=='done'&&t.due&&t.due.startsWith(todayStr)).length;
  const wip=tasks.filter(t=>t.status==='in-progress').length;
  const totalWords=content.reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0)+docs.reduce((s,d)=>s+(d.content||'').trim().split(/\s+/).filter(Boolean).length,0);
  const storageKB=(JSON.stringify(S).length/1024).toFixed(1);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">ASTRA Dashboard</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  // Stats row
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#4ade80">${tasks.length}</div><div style="font-size:9px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#a78bfa">${content.length}</div><div style="font-size:9px;color:var(--text-muted)">Content</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#38bdf8">${links.length}</div><div style="font-size:9px;color:var(--text-muted)">Links</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#fbbf24">${docs.length}</div><div style="font-size:9px;color:var(--text-muted)">Docs</div></div>`;
  h+='</div>';
  // Quick info
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:10px;color:var(--text-muted)">Today</div><div style="font-size:12px;color:var(--text-primary)">${todayDue} due | ${wip} in progress</div></div>`;
  h+=`<div style="background:${overdue>0?'rgba(248,113,113,0.1)':'var(--bg-surface)'};padding:10px;border-radius:8px"><div style="font-size:10px;color:var(--text-muted)">Overdue</div><div style="font-size:12px;color:${overdue>0?'#f87171':'var(--text-primary)'}">${overdue} tasks need attention</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:10px;color:var(--text-muted)">Total Words</div><div style="font-size:12px;color:var(--text-primary)">${totalWords.toLocaleString()}</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:10px;color:var(--text-muted)">Storage</div><div style="font-size:12px;color:var(--text-primary)">${storageKB} KB</div></div>`;
  h+='</div>';
  // Quick actions
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Quick Actions</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
  const actions=[
    ['New Task','showQuickTask()'],['New Note','showQuickNote()'],['New Link','showQuickLink()'],
    ['Daily Planner','showDailyPlanner()'],['Weekly Review','showWeeklyReview()'],['Focus Timer','startQuickTimer()'],
  ];
  actions.forEach(([label,fn])=>{
    h+=`<button onclick="${fn}" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:10px;cursor:pointer">${label}</button>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickCaptureSummary(){
  let panel=document.getElementById('capture-sum-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='capture-sum-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const captures=(S._captures||[]);
  const typeCounts={};
  captures.forEach(c=>{const t=c.type||'general';typeCounts[t]=(typeCounts[t]||0)+1;});
  const types=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Capture Summary</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${captures.length} total captures</div>`;
  if(!captures.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No captures yet. Use Quick Capture (Cmd+Shift+C) or the Nexus extension to capture items.</div>';
  }
  const colors={idea:'#facc15',quote:'#a78bfa',code:'#4ade80',insight:'#60a5fa',todo:'#f87171',book:'#fb923c',research:'#38bdf8',thought:'#f472b6',general:'#6b7280'};
  if(types.length){
    const maxC=types[0][1];
    types.forEach(([type,count])=>{
      const pct=Math.round(count/maxC*100);
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px"><div style="width:70px;font-size:10px;color:var(--text-secondary);text-align:right">${type}</div><div style="flex:1;height:14px;background:var(--bg-surface);border-radius:7px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[type]||'#6b7280'};border-radius:7px"></div></div><div style="font-size:10px;color:var(--text-muted);width:25px">${count}</div></div>`;
    });
  }
  if(captures.length){
    h+='<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);margin-bottom:6px">Recent captures:</div>';
    captures.slice(0,10).forEach(c=>{
      const d=c.createdAt?new Date(c.createdAt).toLocaleDateString('en',{month:'short',day:'numeric'}):'';
      h+=`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:10px;border-bottom:1px solid var(--border)"><span style="color:var(--text-secondary);flex:1">${esc((c.text||c.title||'').substring(0,50))}</span><span style="color:${colors[c.type]||'#6b7280'}">${c.type||'general'}</span><span style="color:var(--text-muted);margin-left:8px">${d}</span></div>`;
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showNotesExplorer(){
  let panel=document.getElementById('notes-explorer-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='notes-explorer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const categories={};
  content.forEach(c=>{const cat=c.theme||c.category||'Uncategorized';if(!categories[cat])categories[cat]=[];categories[cat].push(c);});
  const cats=Object.entries(categories).sort((a,b)=>a[0].localeCompare(b[0]));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Notes Explorer</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${content.length} items in ${cats.length} categories</div>`;
  if(!cats.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No content found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  cats.forEach(([cat,items])=>{
    h+=`<div style="margin-bottom:4px"><div onclick="const el=document.getElementById('ne-${cat.replace(/[^a-zA-Z0-9]/g,'')}');el.style.display=el.style.display==='none'?'block':'none'" style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer"><span style="font-size:12px;color:var(--accent);font-weight:500">${esc(cat)}</span><span style="font-size:10px;color:var(--text-muted)">${items.length}</span></div>`;
    h+=`<div id="ne-${cat.replace(/[^a-zA-Z0-9]/g,'')}" style="display:none;padding:4px 0 4px 16px;border-left:2px solid var(--border);margin-left:8px">`;
    items.forEach(c=>{
      const words=(c.body||'').trim().split(/\s+/).filter(Boolean).length;
      h+=`<div style="padding:4px 0;font-size:11px;border-bottom:1px solid var(--border)"><span style="color:var(--text-primary)">${esc((c.title||'Untitled').substring(0,35))}</span><span style="color:var(--text-muted);margin-left:8px;font-size:9px">${words}w</span></div>`;
    });
    h+=`</div></div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDeadlineTracker(){
  let panel=document.getElementById('deadline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='deadline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&t.due).sort((a,b)=>new Date(a.due)-new Date(b.due));
  const now=new Date();
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Deadline Tracker</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!tasks.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No tasks with due dates found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  tasks.forEach(t=>{
    const due=new Date(t.due);
    const diffMs=due-now;
    const diffDays=Math.ceil(diffMs/(1000*60*60*24));
    const isOverdue=diffDays<0;
    const isToday=diffDays===0;
    const isUrgent=diffDays>0&&diffDays<=3;
    const color=isOverdue?'#f87171':isToday?'#facc15':isUrgent?'#fb923c':diffDays<=7?'#60a5fa':'#4ade80';
    let countdown='';
    if(isOverdue)countdown=Math.abs(diffDays)+' days overdue';
    else if(isToday)countdown='TODAY';
    else if(diffDays===1)countdown='Tomorrow';
    else countdown=diffDays+' days';
    h+=`<div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg-surface);border-radius:8px;margin-bottom:6px;border-left:3px solid ${color}">`;
    h+=`<div style="min-width:60px;text-align:center"><div style="font-size:16px;font-weight:700;color:${color}">${isOverdue?'-'+Math.abs(diffDays):diffDays}</div><div style="font-size:8px;color:var(--text-muted)">${isOverdue?'overdue':'days left'}</div></div>`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary);font-weight:500">${esc(t.title||'').substring(0,35)}</div><div style="font-size:10px;color:var(--text-muted)">${t.due} | ${t.priority||'no priority'}</div></div>`;
    h+=`<div style="font-size:9px;color:${color};font-weight:600">${countdown}</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentGraph(){
  let panel=document.getElementById('content-graph-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-graph-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const days=30;
  const now=new Date();
  const dayData=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date(now);d.setDate(d.getDate()-i);
    const dateStr=d.toISOString().split('T')[0];
    const count=content.filter(c=>c.createdAt&&c.createdAt.startsWith(dateStr)).length;
    const words=content.filter(c=>c.createdAt&&c.createdAt.startsWith(dateStr)).reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0);
    dayData.push({label:d.toLocaleDateString('en',{month:'short',day:'numeric'}),count,words,date:dateStr});
  }
  const maxCount=Math.max(...dayData.map(d=>d.count),1);
  const maxWords=Math.max(...dayData.map(d=>d.words),1);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Creation (30 Days)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:12px;margin-bottom:8px"><span style="font-size:10px;color:#4ade80">Items created</span><span style="font-size:10px;color:#60a5fa">Words written</span></div>';
  const svgW=600,svgH=160,padL=35,padB=25,padT=10;
  const chartW=svgW-padL-10,chartH=svgH-padT-padB;
  h+=`<svg width="100%" viewBox="0 0 ${svgW} ${svgH}" style="display:block">`;
  for(let i=0;i<=3;i++){const y=padT+chartH-i*(chartH/3);h+=`<line x1="${padL}" y1="${y}" x2="${svgW-10}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;h+=`<text x="${padL-3}" y="${y+3}" text-anchor="end" fill="var(--text-muted)" font-size="8">${Math.round(maxCount*i/3)}</text>`;}
  // Items line
  let itemsPath='';
  dayData.forEach((d,i)=>{
    const x=padL+i*(chartW/(days-1));
    const y=padT+chartH-d.count/maxCount*chartH;
    itemsPath+=(i===0?'M':'L')+x+','+y;
    if(d.count>0)h+=`<circle cx="${x}" cy="${y}" r="2" fill="#4ade80"/>`;
  });
  h+=`<path d="${itemsPath}" fill="none" stroke="#4ade80" stroke-width="1.5" opacity="0.8"/>`;
  // Words line (normalized)
  let wordsPath='';
  dayData.forEach((d,i)=>{
    const x=padL+i*(chartW/(days-1));
    const y=padT+chartH-d.words/maxWords*chartH;
    wordsPath+=(i===0?'M':'L')+x+','+y;
  });
  h+=`<path d="${wordsPath}" fill="none" stroke="#60a5fa" stroke-width="1" stroke-dasharray="4,2" opacity="0.6"/>`;
  // X axis labels (every 5 days)
  dayData.forEach((d,i)=>{if(i%5===0){const x=padL+i*(chartW/(days-1));h+=`<text x="${x}" y="${svgH-3}" text-anchor="middle" fill="var(--text-muted)" font-size="7">${d.label}</text>`;}});
  h+=`</svg>`;
  const totalItems=dayData.reduce((s,d)=>s+d.count,0);
  const totalWords=dayData.reduce((s,d)=>s+d.words,0);
  const activeDays=dayData.filter(d=>d.count>0).length;
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:10px;color:var(--text-muted)"><span>${totalItems} items</span><span>${totalWords.toLocaleString()} words</span><span>${activeDays} active days</span></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWorkspaceSearch(){
  let panel=document.getElementById('ws-search-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ws-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Advanced Search</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<input id="adv-search-q" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:13px;margin-bottom:8px" placeholder="Search query...">';
  h+='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
  h+='<select id="adv-search-type" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px"><option value="all">All Types</option><option value="task">Tasks</option><option value="content">Content</option><option value="link">Links</option><option value="doc">Docs</option></select>';
  h+='<select id="adv-search-date" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px"><option value="all">Any Time</option><option value="today">Today</option><option value="week">This Week</option><option value="month">This Month</option></select>';
  h+=`<button onclick="advancedSearch()" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer">Search</button>`;
  h+='</div>';
  h+='<div id="adv-search-results"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const inp=document.getElementById('adv-search-q');if(inp){inp.focus();inp.addEventListener('keydown',e=>{if(e.key==='Enter')advancedSearch();});}},100);
}
function advancedSearch(){
  const q=(document.getElementById('adv-search-q')?.value||'').toLowerCase();
  const type=document.getElementById('adv-search-type')?.value||'all';
  const dateRange=document.getElementById('adv-search-date')?.value||'all';
  const results=document.getElementById('adv-search-results');if(!results)return;
  if(!q){results.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">Enter a search query</div>';return;}
  const now=new Date();
  const dateFilter=d=>{
    if(dateRange==='all'||!d)return true;
    const date=new Date(d);
    if(dateRange==='today')return date.toDateString()===now.toDateString();
    if(dateRange==='week'){const w=new Date(now);w.setDate(w.getDate()-7);return date>=w;}
    if(dateRange==='month'){const m=new Date(now);m.setMonth(m.getMonth()-1);return date>=m;}
    return true;
  };
  const items=[];
  if(type==='all'||type==='task')(S.tasks||[]).forEach(t=>{if(((t.title||'').toLowerCase().includes(q)||(t.description||'').toLowerCase().includes(q))&&dateFilter(t.createdAt))items.push({type:'Task',title:t.title,sub:t.status+' | '+t.priority,date:t.createdAt,color:'#60a5fa'});});
  if(type==='all'||type==='content')(S.content||[]).forEach(c=>{if(((c.title||'').toLowerCase().includes(q)||(c.body||'').toLowerCase().includes(q))&&dateFilter(c.createdAt))items.push({type:'Content',title:c.title,sub:c.theme||'',date:c.createdAt,color:'#a78bfa'});});
  if(type==='all'||type==='link')(S.links||[]).forEach(l=>{if(((l.title||'').toLowerCase().includes(q)||(l.url||'').toLowerCase().includes(q))&&dateFilter(l.createdAt))items.push({type:'Link',title:l.title||l.url,sub:l.category||'',date:l.createdAt,color:'#38bdf8'});});
  if(type==='all'||type==='doc')(S.writerDocs||[]).forEach(d=>{if(((d.title||'').toLowerCase().includes(q)||(d.content||'').toLowerCase().includes(q))&&dateFilter(d.updatedAt))items.push({type:'Doc',title:d.title,sub:'',date:d.updatedAt,color:'#fbbf24'});});
  let h='';
  if(!items.length)h='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">No results found</div>';
  h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">${items.length} results</div>`;
  items.slice(0,30).forEach(item=>{
    const d=item.date?new Date(item.date).toLocaleDateString('en',{month:'short',day:'numeric'}):'';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid var(--border)"><div style="background:${item.color};color:#000;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;min-width:50px;text-align:center">${item.type}</div><div style="flex:1"><div style="font-size:12px;color:var(--text-primary)">${esc((item.title||'').substring(0,45))}</div><div style="font-size:10px;color:var(--text-muted)">${esc(item.sub||'')}</div></div><div style="font-size:9px;color:var(--text-muted)">${d}</div></div>`;
  });
  results.innerHTML=h;
}
function showMotivationalQuote(){
  const quotes=[
    {text:'The only way to do great work is to love what you do.',author:'Steve Jobs'},
    {text:'Start where you are. Use what you have. Do what you can.',author:'Arthur Ashe'},
    {text:'Success is not final, failure is not fatal: it is the courage to continue that counts.',author:'Winston Churchill'},
    {text:'The best time to plant a tree was 20 years ago. The second best time is now.',author:'Chinese Proverb'},
    {text:'Done is better than perfect.',author:'Sheryl Sandberg'},
    {text:'Ships are safe in harbor, but that is not what ships are built for.',author:'John A. Shedd'},
    {text:'The secret of getting ahead is getting started.',author:'Mark Twain'},
    {text:'What you do today can improve all your tomorrows.',author:'Ralph Marston'},
    {text:'It does not matter how slowly you go as long as you do not stop.',author:'Confucius'},
    {text:'Excellence is not a destination but a continuously moving target.',author:'Unknown'},
    {text:'Build things that last. Ship things that matter.',author:'Gabo'},
    {text:'The code you write today is the tool you use tomorrow.',author:'Unknown'},
    {text:'Complexity is the enemy of execution.',author:'Tony Robbins'},
    {text:'Make it work, make it right, make it fast.',author:'Kent Beck'},
    {text:'Focus is saying no to the hundred other good ideas.',author:'Steve Jobs'},
  ];
  const q=quotes[Math.floor(Math.random()*quotes.length)];
  let panel=document.getElementById('quote-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quote-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:40px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;text-align:center';
  let h='<button onclick="this.parentElement.remove()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button>';
  h+=`<div style="font-size:18px;color:var(--text-primary);line-height:1.6;font-style:italic;margin-bottom:16px">"${q.text}"</div>`;
  h+=`<div style="font-size:12px;color:var(--accent)">- ${q.author}</div>`;
  h+=`<button onclick="showMotivationalQuote()" style="margin-top:20px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 16px;font-size:11px;cursor:pointer">Another Quote</button>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showColorThemePicker(){
  let panel=document.getElementById('theme-picker-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='theme-picker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const accents=[
    {name:'Mint Green',color:'#4ade80'},
    {name:'Cyan',color:'#22d3ee'},
    {name:'Blue',color:'#60a5fa'},
    {name:'Purple',color:'#a78bfa'},
    {name:'Pink',color:'#f472b6'},
    {name:'Orange',color:'#fb923c'},
    {name:'Yellow',color:'#facc15'},
    {name:'Red',color:'#f87171'},
    {name:'Teal',color:'#2dd4bf'},
    {name:'Lime',color:'#a3e635'},
    {name:'Indigo',color:'#818cf8'},
    {name:'Rose',color:'#fb7185'},
  ];
  const current=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#4ade80';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Accent Color</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
  accents.forEach(a=>{
    const active=current===a.color;
    h+=`<div onclick="document.documentElement.style.setProperty('--accent','${a.color}');S._accentColor='${a.color}';save();showColorThemePicker();" style="text-align:center;padding:12px 8px;background:var(--bg-surface);border:2px solid ${active?a.color:'transparent'};border-radius:8px;cursor:pointer">`;
    h+=`<div style="width:32px;height:32px;border-radius:50%;background:${a.color};margin:0 auto 6px"></div>`;
    h+=`<div style="font-size:10px;color:var(--text-secondary)">${a.name}</div>`;
    h+=`</div>`;
  });
  h+='</div>';
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">Current: ${current}</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showSessionLog(){
  let panel=document.getElementById('session-log-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='session-log-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._sessionLog)S._sessionLog=[];
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Session Log</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="display:flex;gap:8px;margin-bottom:12px">';
    h+='<input id="session-log-input" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px" placeholder="What did you work on?" onkeydown="if(event.key===\'Enter\'){const v=this.value.trim();if(v){S._sessionLog.unshift({text:v,time:new Date().toISOString()});save();showSessionLog();}}">';
    h+='<button onclick="const inp=document.getElementById(\'session-log-input\');const v=inp.value.trim();if(v){S._sessionLog.unshift({text:v,time:new Date().toISOString()});save();showSessionLog();}" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px 12px;font-size:11px;font-weight:600;cursor:pointer">Log</button>';
    h+='</div>';
    if(!S._sessionLog.length)h+='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">No session logs yet. Start logging what you work on.</div>';
    let lastDate='';
    S._sessionLog.slice(0,30).forEach((entry,i)=>{
      const d=new Date(entry.time);
      const dateStr=d.toLocaleDateString('en',{month:'short',day:'numeric'});
      if(dateStr!==lastDate){h+=`<div style="font-size:10px;color:var(--accent);margin:12px 0 6px;font-weight:600">${dateStr}</div>`;lastDate=dateStr;}
      const time=d.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit'});
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)"><span style="font-size:9px;color:var(--text-muted);min-width:50px">${time}</span><span style="font-size:11px;color:var(--text-secondary);flex:1">${esc(entry.text)}</span><button onclick="S._sessionLog.splice(${i},1);save();showSessionLog();" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">x</button></div>`;
    });
    if(S._sessionLog.length>30)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px">Showing 30 of ${S._sessionLog.length} entries</div>`;
    h+=`<button onclick="if(confirm('Clear all session logs?')){S._sessionLog=[];save();showSessionLog();}" style="display:block;margin:12px auto 0;background:none;border:1px solid var(--border);color:var(--text-muted);border-radius:6px;padding:6px 16px;font-size:10px;cursor:pointer">Clear All</button>`;
    panel.innerHTML=h;
  }
  render();
  document.body.appendChild(panel);
}
function showRecentEdits(){
  let panel=document.getElementById('recent-edits-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='recent-edits-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const items=[];
  (S.content||[]).forEach(c=>{if(c.updatedAt)items.push({type:'Content',title:c.title,date:c.updatedAt,color:'#a78bfa'});else if(c.createdAt)items.push({type:'Content',title:c.title,date:c.createdAt,color:'#a78bfa'});});
  (S.tasks||[]).forEach(t=>{if(t.completedAt)items.push({type:'Task',title:t.title,date:t.completedAt,color:'#60a5fa'});else if(t.createdAt)items.push({type:'Task',title:t.title,date:t.createdAt,color:'#60a5fa'});});
  (S.writerDocs||[]).forEach(d=>{if(d.updatedAt)items.push({type:'Doc',title:d.title,date:d.updatedAt,color:'#fbbf24'});});
  (S.links||[]).forEach(l=>{if(l.createdAt)items.push({type:'Link',title:l.title||l.url,date:l.createdAt,color:'#38bdf8'});});
  items.sort((a,b)=>new Date(b.date)-new Date(a.date));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Recent Edits</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!items.length)h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No recent edits found</div>';
  items.slice(0,30).forEach(item=>{
    const d=new Date(item.date);
    const ago=Math.floor((Date.now()-d)/(1000*60));
    let agoStr;
    if(ago<60)agoStr=ago+'m ago';else if(ago<1440)agoStr=Math.floor(ago/60)+'h ago';else agoStr=Math.floor(ago/1440)+'d ago';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)"><div style="background:${item.color};color:#000;font-size:8px;font-weight:700;padding:2px 5px;border-radius:3px;min-width:45px;text-align:center">${item.type}</div><div style="flex:1;font-size:11px;color:var(--text-primary)">${esc((item.title||'Untitled').substring(0,40))}</div><div style="font-size:9px;color:var(--text-muted)">${agoStr}</div></div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDocOutline(){
  let panel=document.getElementById('doc-outline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='doc-outline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const docs=(S.writerDocs||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Document Outlines</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!docs.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No writer docs found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  docs.forEach(d=>{
    const headings=[];
    (d.content||'').split('\n').forEach(line=>{
      const m=line.match(/^(#{1,3})\s+(.+)/);
      if(m)headings.push({level:m[1].length,text:m[2]});
    });
    h+=`<div style="margin-bottom:12px"><div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:4px">${esc(d.title||'Untitled')}</div>`;
    if(!headings.length){h+=`<div style="font-size:10px;color:var(--text-muted);padding-left:12px">No headings found (use # syntax)</div>`;}
    headings.forEach(heading=>{
      const indent=(heading.level-1)*16;
      h+=`<div style="font-size:11px;color:var(--text-secondary);padding:2px 0 2px ${indent+12}px">${'#'.repeat(heading.level)} ${esc(heading.text)}</div>`;
    });
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showBacklogGroomer(){
  let panel=document.getElementById('backlog-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='backlog-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const backlog=(S.tasks||[]).filter(t=>t.status==='todo'&&!t.due);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Backlog Groomer (${backlog.length})</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!backlog.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No unscheduled TODO tasks. Your backlog is clean!</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Tasks without due dates. Set priority and schedule them.</div>';
  backlog.forEach(t=>{
    const age=t.createdAt?Math.floor((Date.now()-new Date(t.createdAt))/(1000*60*60*24)):0;
    const ageColor=age>14?'#f87171':age>7?'#facc15':'#4ade80';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px">`;
    h+=`<div style="min-width:30px;text-align:center;font-size:10px;color:${ageColor};font-weight:600">${age}d</div>`;
    h+=`<div style="flex:1;font-size:11px;color:var(--text-primary)">${esc(t.title||'').substring(0,35)}</div>`;
    h+=`<select onchange="const task=(S.tasks||[]).find(x=>x.id==='${t.id}');if(task){task.priority=this.value;save();}" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:2px;font-size:9px"><option value="" ${!t.priority?'selected':''}>-</option><option value="p0" ${t.priority==='p0'?'selected':''}>P0</option><option value="p1" ${t.priority==='p1'?'selected':''}>P1</option><option value="p2" ${t.priority==='p2'?'selected':''}>P2</option><option value="p3" ${t.priority==='p3'?'selected':''}>P3</option></select>`;
    h+=`<input type="date" value="${t.due||''}" onchange="const task=(S.tasks||[]).find(x=>x.id==='${t.id}');if(task){task.due=this.value;save();}" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:2px;font-size:9px;width:100px">`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectRoadmap(filterProject){
  let panel=document.getElementById('roadmap-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='roadmap-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:75vh;overflow-y:auto';
  let tasks=S.tasks.filter(t=>t.due);
  if(filterProject)tasks=tasks.filter(t=>t.project===filterProject);
  tasks.sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  const projects=[...new Set(tasks.map(t=>t.project||'No Project'))];
  const pColors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316'];
  const pColorMap={};projects.forEach((p,i)=>pColorMap[p]=pColors[i%pColors.length]);
  const today=new Date().toISOString().split('T')[0];
  let h='';
  const months={};
  tasks.forEach(t=>{const m=t.due.substring(0,7);if(!months[m])months[m]=[];months[m].push(t);});
  Object.keys(months).sort().forEach(m=>{
    const d=new Date(m+'-01');
    const label=d.toLocaleDateString('en-US',{month:'long',year:'numeric'});
    h+=`<div style="padding:8px 0 4px;font-size:11px;font-weight:600;color:var(--text-primary);border-bottom:1px solid var(--border);margin-top:12px">${label} (${months[m].length} tasks)</div>`;
    months[m].forEach(t=>{
      const clr=pColorMap[t.project||'No Project'];
      const isDone=t.status==='done';const isOverdue=t.due<today&&!isDone;
      h+=`<div onclick="document.getElementById('roadmap-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:8px;padding:5px 8px;cursor:pointer;border-left:3px solid ${clr};margin:2px 0;border-radius:0 4px 4px 0;opacity:${isDone?'0.5':'1'}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="font-size:9px;color:var(--text-muted);font-family:var(--mono);min-width:40px">${t.due.substring(5)}</span><span style="font-size:10px;color:${isOverdue?'var(--red)':isDone?'var(--text-muted)':'var(--text-primary)'};flex:1;text-decoration:${isDone?'line-through':'none'}">${esc(t.title||'Untitled')}</span>${t.project?`<span style="font-size:8px;color:${clr};font-family:var(--mono)">${esc(t.project)}</span>`:''}<span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'}">${t.priority||'p2'}</span></div>`;
    });
  });
  if(!tasks.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No tasks with due dates'+(filterProject?' in '+filterProject:'')+'</div>';
  const legend=projects.map(p=>`<span style="display:inline-flex;align-items:center;gap:3px;font-size:8px;color:var(--text-muted)"><span style="width:8px;height:8px;border-radius:2px;background:${pColorMap[p]}"></span>${esc(p)}</span>`).join(' ');
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Project Roadmap${filterProject?' - '+esc(filterProject):''}</span><button onclick="document.getElementById('roadmap-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="margin-bottom:8px;display:flex;flex-wrap:wrap;gap:6px">${legend}</div>${h}`;
  document.body.appendChild(panel);
}
function addTaskColorLabel(taskId,color){
  const t=S.tasks.find(x=>x.id===taskId);if(!t)return;
  if(!t.labels)t.labels=[];
  if(t.labels.includes(color)){t.labels=t.labels.filter(c=>c!==color);}
  else{t.labels.push(color);if(t.labels.length>4)t.labels.shift();}
  save();renderTasks();
}
function showBurndownChart(days){
  days=days||14;
  let panel=document.getElementById('burndown-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='burndown-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw';
  const w=500,h=260,pad=40,gw=w-pad*2,gh=h-pad*2;
  const today=new Date();const dates=[];
  for(let i=days-1;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);dates.push(d.toISOString().split('T')[0]);}
  const created=dates.map(ds=>S.tasks.filter(t=>t.created&&t.created.startsWith(ds)).length);
  const completed=dates.map(ds=>S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length);
  const maxVal=Math.max(1,...created,...completed);
  const barW=Math.floor(gw/dates.length*0.35);
  let svg=`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="font-family:var(--mono)">`;
  // grid lines
  for(let i=0;i<=4;i++){const y=pad+gh-gh*(i/4);const v=Math.round(maxVal*(i/4));svg+=`<line x1="${pad}" y1="${y}" x2="${pad+gw}" y2="${y}" stroke="#222" stroke-width="0.5"/><text x="${pad-4}" y="${y+3}" fill="#666" font-size="8" text-anchor="end">${v}</text>`;}
  // bars
  dates.forEach((ds,i)=>{
    const x=pad+i*(gw/dates.length)+2;
    const ch=created[i]?(created[i]/maxVal)*gh:0;
    const dh=completed[i]?(completed[i]/maxVal)*gh:0;
    svg+=`<rect x="${x}" y="${pad+gh-ch}" width="${barW}" height="${ch}" fill="#3b82f6" rx="1" opacity="0.85"><title>${ds}: ${created[i]} created</title></rect>`;
    svg+=`<rect x="${x+barW+1}" y="${pad+gh-dh}" width="${barW}" height="${dh}" fill="#4ade80" rx="1" opacity="0.85"><title>${ds}: ${completed[i]} completed</title></rect>`;
    if(i%Math.ceil(days/7)===0||i===dates.length-1){svg+=`<text x="${x+barW}" y="${h-5}" fill="#666" font-size="7" text-anchor="middle">${ds.substring(5)}</text>`;}
  });
  // legend
  svg+=`<rect x="${w-120}" y="8" width="8" height="8" fill="#3b82f6" rx="1"/><text x="${w-108}" y="16" fill="#888" font-size="9">Created</text>`;
  svg+=`<rect x="${w-120}" y="22" width="8" height="8" fill="#4ade80" rx="1"/><text x="${w-108}" y="30" fill="#888" font-size="9">Completed</text>`;
  // totals
  const totalCreated=created.reduce((a,v)=>a+v,0);const totalCompleted=completed.reduce((a,v)=>a+v,0);
  svg+=`<text x="${pad}" y="16" fill="#888" font-size="9">${totalCreated} created, ${totalCompleted} completed (${days}d)</text>`;
  svg+=`</svg>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Burndown (${days} days)</span><button onclick="document.getElementById('burndown-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;justify-content:center;overflow-x:auto">${svg}</div><div style="margin-top:10px;display:flex;gap:8px;justify-content:center"><button onclick="showBurndownChart(7)" class="btn btn-sm btn-ghost" style="font-size:9px">7d</button><button onclick="showBurndownChart(14)" class="btn btn-sm btn-ghost" style="font-size:9px">14d</button><button onclick="showBurndownChart(30)" class="btn btn-sm btn-ghost" style="font-size:9px">30d</button><button onclick="showBurndownChart(90)" class="btn btn-sm btn-ghost" style="font-size:9px">90d</button></div>`;
  document.body.appendChild(panel);
}
function checkDeadLinks(){
  const links=S.links.filter(l=>l.url&&l.url.startsWith('http'));
  if(!links.length){toast('No links to check');return;}
  let panel=document.getElementById('deadlinks-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='deadlinks-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Checking ${links.length} Links...</span><button onclick="document.getElementById('deadlinks-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div id="deadlinks-progress" style="font-size:10px;color:var(--text-muted);margin-bottom:8px">0/${links.length} checked</div><div id="deadlinks-results"></div>`;
  document.body.appendChild(panel);
  let checked=0;const results=[];const batch=5;
  async function checkBatch(start){
    const slice=links.slice(start,start+batch);
    await Promise.allSettled(slice.map(async l=>{
      try{const r=await fetch(l.url,{method:'HEAD',mode:'no-cors',signal:AbortSignal.timeout(5000)});results.push({url:l.url,title:l.title,status:'ok',code:r.status||'opaque'});}
      catch(e){results.push({url:l.url,title:l.title,status:'error',error:e.message||'timeout'});}
      checked++;document.getElementById('deadlinks-progress').textContent=checked+'/'+links.length+' checked';
    }));
    const resEl=document.getElementById('deadlinks-results');
    const broken=results.filter(r=>r.status==='error');
    const ok=results.filter(r=>r.status==='ok');
    resEl.innerHTML=(broken.length?`<div style="margin-bottom:8px;font-size:11px;color:var(--red);font-weight:600">${broken.length} Broken/Unreachable</div>`+broken.map(r=>`<div style="padding:4px 0;border-bottom:1px solid var(--border);font-size:10px"><span style="color:var(--red)">x</span> <span style="color:var(--text-primary)">${esc(r.title)}</span><br><span style="color:var(--text-muted);font-size:9px">${esc(r.url)} - ${esc(r.error)}</span></div>`).join(''):'')+(ok.length?`<div style="margin-top:8px;margin-bottom:4px;font-size:11px;color:var(--green);font-weight:600">${ok.length} OK</div>`:'')+(checked===links.length?`<div style="margin-top:8px;font-size:10px;color:var(--text-muted)">Done. ${broken.length} broken, ${ok.length} ok out of ${links.length} total.</div>`:'');
    if(start+batch<links.length)setTimeout(()=>checkBatch(start+batch),200);
    else{document.getElementById('deadlinks-progress').textContent='Complete: '+checked+'/'+links.length;document.querySelector('#deadlinks-panel > div:first-child > span').textContent='Link Health: '+broken.length+' broken, '+ok.length+' ok';}
  }
  checkBatch(0);
}
function enableDesktopNotifications(){
  if(!('Notification' in window)){toast('Browser does not support notifications');return;}
  if(Notification.permission==='granted'){toast('Notifications already enabled');checkOverdueNotify();return;}
  if(Notification.permission==='denied'){toast('Notifications blocked. Enable in browser settings.');return;}
  Notification.requestPermission().then(perm=>{if(perm==='granted'){toast('Notifications enabled');checkOverdueNotify();S._notificationsEnabled=true;save();}else toast('Notifications denied');});
}
function checkOverdueNotify(){
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  const today=new Date().toISOString().split('T')[0];
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  if(overdue.length){new Notification('SATURNO HUB',{body:overdue.length+' overdue task'+(overdue.length>1?'s':'')+': '+overdue.slice(0,3).map(t=>t.title).join(', '),icon:'planet-logo.png'});}
}
function notifyFocusComplete(taskName){
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  new Notification('Focus Session Complete',{body:taskName?'Finished: '+taskName:'Timer done! Take a break.',icon:'planet-logo.png'});
}
function showChart(type){
  let panel=document.getElementById('chart-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='chart-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw';
  let svg='';const w=400,h=250;
  if(type==='status'){
    const counts={todo:0,progress:0,done:0,blocked:0};S.tasks.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
    const total=Object.values(counts).reduce((a,v)=>a+v,0);if(!total){panel.innerHTML='<div style="text-align:center;color:var(--text-muted);padding:20px">No tasks yet</div><button onclick="this.parentElement.remove()" style="display:block;margin:0 auto;background:none;border:none;color:var(--text-muted);cursor:pointer">Close</button>';document.body.appendChild(panel);return;}
    const colors={todo:'#3b82f6',progress:'#f59e0b',done:'#4ade80',blocked:'#ef4444'};
    let startAngle=-Math.PI/2;const cx=120,cy=120,r=100;
    svg=`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
    Object.entries(counts).filter(([,v])=>v>0).forEach(([status,count])=>{
      const angle=(count/total)*Math.PI*2;const endAngle=startAngle+angle;
      const x1=cx+r*Math.cos(startAngle),y1=cy+r*Math.sin(startAngle);
      const x2=cx+r*Math.cos(endAngle),y2=cy+r*Math.sin(endAngle);
      const large=angle>Math.PI?1:0;
      svg+=`<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z" fill="${colors[status]}" opacity="0.85"><title>${status}: ${count} (${Math.round(count/total*100)}%)</title></path>`;
      startAngle=endAngle;
    });
    let ly=20;Object.entries(counts).filter(([,v])=>v>0).forEach(([s,c])=>{svg+=`<rect x="260" y="${ly}" width="12" height="12" fill="${colors[s]}" rx="2"/><text x="278" y="${ly+10}" fill="#ccc" font-size="11">${s}: ${c} (${Math.round(c/total*100)}%)</text>`;ly+=20;});
    svg+='</svg>';
  }else if(type==='priority'){
    const counts={p0:0,p1:0,p2:0,p3:0};S.tasks.filter(t=>t.status!=='done').forEach(t=>counts[t.priority||'p2']++);
    const max=Math.max(...Object.values(counts),1);const colors={p0:'#ef4444',p1:'#f59e0b',p2:'#3b82f6',p3:'#666'};
    svg=`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
    Object.entries(counts).forEach(([p,c],i)=>{const bw=60,bh=Math.round(c/max*150),x=40+i*90,y=180-bh;
      svg+=`<rect x="${x}" y="${y}" width="${bw}" height="${bh}" fill="${colors[p]}" rx="4" opacity="0.85"/><text x="${x+bw/2}" y="200" fill="#888" font-size="11" text-anchor="middle">${p.toUpperCase()}</text><text x="${x+bw/2}" y="${y-5}" fill="#ccc" font-size="12" text-anchor="middle">${c}</text>`;
    });svg+='</svg>';
  }else if(type==='theme'){
    const themes={};S.content.forEach(c=>{const t=c.theme||'unthemed';themes[t]=(themes[t]||0)+1;});
    const sorted=Object.entries(themes).sort((a,b)=>b[1]-a[1]).slice(0,8);const max=sorted.length?sorted[0][1]:1;
    const cl=['#4ade80','#22d3ee','#a855f7','#f59e0b','#3b82f6','#ec4899','#ef4444','#eab308'];
    svg=`<svg width="${w}" height="${sorted.length*28+10}" viewBox="0 0 ${w} ${sorted.length*28+10}">`;
    sorted.forEach(([t,c],i)=>{const bw=Math.round(c/max*(w-140)),y=5+i*28;
      svg+=`<rect x="0" y="${y}" width="${bw}" height="20" fill="${cl[i%cl.length]}" rx="3" opacity="0.85"/><text x="${bw+6}" y="${y+14}" fill="#ccc" font-size="10">${esc(t)} (${c})</text>`;
    });svg+='</svg>';
  }else if(type==='weekly'){
    const days=[];const today=new Date();
    for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];days.push({label:['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()],created:S.tasks.filter(t=>t.created&&t.created.startsWith(ds)).length,completed:S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length,content:S.content.filter(c=>c.created&&c.created.startsWith(ds)).length});}
    const max=Math.max(...days.map(d=>d.created+d.completed+d.content),1);
    svg=`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
    days.forEach((d,i)=>{const x=30+i*52,bw=14;
      svg+=`<rect x="${x}" y="${180-Math.round(d.created/max*150)}" width="${bw}" height="${Math.round(d.created/max*150)}" fill="#3b82f6" rx="2" opacity="0.85"/><rect x="${x+16}" y="${180-Math.round(d.completed/max*150)}" width="${bw}" height="${Math.round(d.completed/max*150)}" fill="#4ade80" rx="2" opacity="0.85"/><rect x="${x+32}" y="${180-Math.round(d.content/max*150)}" width="${bw}" height="${Math.round(d.content/max*150)}" fill="#a855f7" rx="2" opacity="0.85"/><text x="${x+22}" y="198" fill="#888" font-size="10" text-anchor="middle">${d.label}</text>`;
    });
    svg+=`<rect x="${w-110}" y="10" width="10" height="10" fill="#3b82f6" rx="2"/><text x="${w-95}" y="19" fill="#888" font-size="9">Created</text><rect x="${w-110}" y="25" width="10" height="10" fill="#4ade80" rx="2"/><text x="${w-95}" y="34" fill="#888" font-size="9">Done</text><rect x="${w-110}" y="40" width="10" height="10" fill="#a855f7" rx="2"/><text x="${w-95}" y="49" fill="#888" font-size="9">Content</text></svg>`;
  }
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">${{status:'Task Status',priority:'Task Priority (Active)',theme:'Content Themes',weekly:'Weekly Activity'}[type]}</span><button onclick="document.getElementById('chart-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;justify-content:center">${svg}</div>`;
  document.body.appendChild(panel);
}
function toggleScratchpad(){
  let panel=document.getElementById('scratchpad-panel');
  if(panel){panel.style.display=panel.style.display==='none'?'flex':'none';if(panel.style.display==='flex')panel.querySelector('textarea').focus();return;}
  panel=document.createElement('div');panel.id='scratchpad-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1400;width:400px;max-width:90vw;height:300px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 12px 48px rgba(0,0,0,0.6);resize:both;overflow:hidden';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em">Scratchpad</span><div style="display:flex;gap:6px"><button onclick="navigator.clipboard.writeText(document.getElementById('scratch-text').value);toast('Copied')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px">Copy</button><button onclick="document.getElementById('scratchpad-panel').style.display='none'" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">&times;</button></div></div><textarea id="scratch-text" oninput="S._scratchpad=this.value;save()" placeholder="Type anything... auto-saved." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;padding:8px;resize:none;font-family:var(--mono);line-height:1.6">${esc(S._scratchpad||'')}</textarea>`;
  document.body.appendChild(panel);panel.querySelector('textarea').focus();
}
function showActivityHeatmap(){
  let panel=document.getElementById('heatmap-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='heatmap-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:720px;width:90vw';
  const today=new Date();const cells=[];
  for(let i=89;i>=0;i--){
    const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];
    const count=S.tasks.filter(t=>(t.completedAt&&t.completedAt.startsWith(ds))||(t.created&&t.created.startsWith(ds))).length+S.content.filter(c=>c.created&&c.created.startsWith(ds)).length+S.docs.filter(doc=>(doc.updated||doc.created||'').startsWith(ds)).length;
    const lvl=count===0?0:count<=2?1:count<=5?2:count<=10?3:4;
    const colors=['#161619','#0e4429','#006d32','#26a641','#39d353'];
    cells.push(`<div title="${ds}: ${count} activities" style="width:10px;height:10px;background:${colors[lvl]};border-radius:2px"></div>`);
  }
  const totalAct=cells.reduce((a,c,i)=>{const m=c.match(/: (\d+)/);return a+parseInt(m?m[1]:0);},0);
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">90-Day Activity Heatmap</span><button onclick="document.getElementById('heatmap-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:grid;grid-template-columns:repeat(13,1fr);gap:2px;margin-bottom:12px">${cells.join('')}</div><div style="display:flex;gap:12px;font-size:9px;color:var(--text-muted);align-items:center"><span>Less</span><div style="width:10px;height:10px;background:#161619;border-radius:2px"></div><div style="width:10px;height:10px;background:#0e4429;border-radius:2px"></div><div style="width:10px;height:10px;background:#006d32;border-radius:2px"></div><div style="width:10px;height:10px;background:#26a641;border-radius:2px"></div><div style="width:10px;height:10px;background:#39d353;border-radius:2px"></div><span>More</span></div>`;
  document.body.appendChild(panel);
}
function cmdSearch() {
  const q = document.getElementById('cmd-input').value;
  const items = cmdGetItems(q);
  cmdIdx = 0;
  const el = document.getElementById('cmd-results');
  if(!items.length) { el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:12px">No results</div>'; return; }
  el.innerHTML = (q?`<div style="padding:4px 16px;font-size:8px;color:var(--text-muted);font-family:var(--mono);border-bottom:1px solid var(--border)">${items.length} result${items.length!==1?'s':''}</div>`:'')+items.map((it, i) => {
    const iconHtml = it.icon.startsWith('<') ? it.icon : `<span>${it.icon}</span>`;
    return `<div class="cmd-item ${i===0?'active':''}" data-idx="${i}" onclick="cmdExec(${i})" onmouseenter="cmdHover(${i})">
      <div class="cmd-item-icon">${iconHtml}</div>
      <div class="cmd-item-text"><div class="cmd-item-title">${esc(it.title)}</div><div class="cmd-item-desc">${esc(it.desc||'')}</div></div>
      <span class="cmd-item-badge">${it.type}</span>
    </div>`;
  }).join('');
}
function cmdHover(i) { cmdIdx = i; cmdHighlight(); }
function cmdHighlight() {
  document.querySelectorAll('.cmd-item').forEach((el, i) => el.classList.toggle('active', i === cmdIdx));
  const active = document.querySelector('.cmd-item.active');
  if(active) active.scrollIntoView({block:'nearest'});
}
function cmdKeydown(e) {
  const items = document.querySelectorAll('.cmd-item');
  if(e.key === 'ArrowDown') { e.preventDefault(); cmdIdx = Math.min(cmdIdx + 1, items.length - 1); cmdHighlight(); }
  else if(e.key === 'ArrowUp') { e.preventDefault(); cmdIdx = Math.max(cmdIdx - 1, 0); cmdHighlight(); }
  else if(e.key === 'Enter') { e.preventDefault(); cmdExec(cmdIdx); }
  else if(e.key === 'Escape') { closeCommandPalette(); }
}
function cmdExec(idx) {
  const items = cmdGetItems(document.getElementById('cmd-input').value);
  if(items[idx] && items[idx].action) { closeCommandPalette(); items[idx].action(); }
}

// === MODE SWITCHING ===
let currentMode = 'default';
function setMode(mode) {
  currentMode = mode;
  const app = document.querySelector('.app');
  app.classList.remove('mode-focus', 'mode-extended');
  // Close project panel in focus mode — no sidebar means no way to navigate
  if(mode === 'focus') {
    app.classList.add('mode-focus');
    if(app.classList.contains('project-open')) closeProjectPanel();
    app.classList.remove('context-open');
  }
  if(mode === 'extended') {
    app.classList.add('mode-extended');
    if(app.classList.contains('project-open')) closeProjectPanel();
    if(!app.classList.contains('context-open')) app.classList.add('context-open');
    updateContextStats();
  }
  if(mode === 'default') {
    app.classList.remove('context-open');
  }
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mode-'+mode+'-btn').classList.add('active');
}

// === SIDEBAR TOGGLE ===
function toggleSidebar() {
  const app = document.querySelector('.app');
  app.classList.toggle('sidebar-collapsed');
  localStorage.setItem('sidebar-collapsed', app.classList.contains('sidebar-collapsed') ? '1' : '');
}
function openMobileSidebar(){document.querySelector('.sidebar').classList.add('mobile-open');document.getElementById('mobile-overlay').classList.add('open');}
function closeMobileSidebar(){document.querySelector('.sidebar').classList.remove('mobile-open');document.getElementById('mobile-overlay').classList.remove('open');}

// === CONTEXT PANEL ===
function toggleContextPanel() {
  const app = document.querySelector('.app');
  if(app.classList.contains('project-open')) {
    closeProjectPanel();
  }
  app.classList.toggle('context-open');
  updateContextStats();
}

// === PANEL RESIZING ===
(function initResize() {
  document.addEventListener('DOMContentLoaded', () => {
    const sidebarHandle = document.getElementById('sidebar-resize');
    const contextHandle = document.getElementById('context-resize');
    const root = document.documentElement;
    let resizing = null;
    function onMouseDown(e, type) {
      e.preventDefault();
      resizing = type;
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      const handle = type === 'sidebar' ? sidebarHandle : contextHandle;
      if(handle) handle.classList.add('dragging');
    }
    if(sidebarHandle) sidebarHandle.addEventListener('mousedown', e => onMouseDown(e, 'sidebar'));
    if(contextHandle) contextHandle.addEventListener('mousedown', e => onMouseDown(e, 'context'));
    document.addEventListener('mousemove', e => {
      if(!resizing) return;
      if(resizing === 'sidebar') {
        const w = Math.max(160, Math.min(400, e.clientX));
        root.style.setProperty('--sidebar-width', w + 'px');
      } else if(resizing === 'context') {
        const w = Math.max(200, Math.min(500, window.innerWidth - e.clientX));
        root.style.setProperty('--context-width', w + 'px');
      }
    });
    document.addEventListener('mouseup', () => {
      if(!resizing) return;
      const handle = resizing === 'sidebar' ? sidebarHandle : contextHandle;
      if(handle) handle.classList.remove('dragging');
      resizing = null;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    });
  });
})();

function updateContextStats() {
  const activeTasks = S.tasks.filter(t => t.status !== 'done').length;
  const el = id => { const e = document.getElementById(id); if(e) return e; return {textContent:''}; };
  el('ctx-stat-tasks').textContent = activeTasks;
  el('ctx-stat-docs').textContent = S.docs.length + S.specs.length;
  el('ctx-stat-projects').textContent = (S.projects||[]).length;
  el('ctx-stat-kb').textContent = (S.knowledgeBase||[]).length;
  updateContextRelated();
  renderGraph();
}
function updateContextRelated() {
  const el = document.getElementById('ctx-related-items');
  if(!el) return;
  let html = '';
  if(currentSection === 'writer') {
    const doc = getActiveDoc();
    if(doc && doc.title) {
      const backlinks = getBacklinks('doc', doc.title);
      if(backlinks.length) {
        html += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Backlinks to "' + esc(doc.title) + '":</div>';
        backlinks.forEach(bl => {
          html += '<div class="context-item" onclick="navigateToItem(\'' + bl.type + '\',\'' + bl.id + '\')"><span class="context-item-icon">' + bl.type[0].toUpperCase() + '</span>' + esc(bl.title) + '</div>';
        });
      }
    }
  } else if(currentSection === 'specs') {
    const spec = getActiveSpec();
    if(spec && spec.title) {
      const backlinks = getBacklinks('spec', spec.title);
      if(backlinks.length) {
        html += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Backlinks to "' + esc(spec.title) + '":</div>';
        backlinks.forEach(bl => {
          html += '<div class="context-item" onclick="navigateToItem(\'' + bl.type + '\',\'' + bl.id + '\')"><span class="context-item-icon">' + bl.type[0].toUpperCase() + '</span>' + esc(bl.title) + '</div>';
        });
      }
    }
  } else if(currentSection === 'tasks') {
    // Show overdue tasks
    const today = new Date().toISOString().split('T')[0];
    const overdue = S.tasks.filter(t => t.due && t.due < today && t.status !== 'done');
    if(overdue.length) {
      html += '<div style="font-size:9px;color:var(--red);margin-bottom:6px">Overdue (' + overdue.length + '):</div>';
      overdue.slice(0, 5).forEach(t => {
        html += '<div class="context-item" style="color:var(--red)"><span class="context-item-icon">!</span>' + esc(t.title || 'Untitled') + '</div>';
      });
    }
    // Show today's tasks
    const todayTasks = S.tasks.filter(t => t.due === today && t.status !== 'done');
    if(todayTasks.length) {
      html += '<div style="font-size:9px;color:var(--accent);margin-bottom:6px;margin-top:8px">Today (' + todayTasks.length + '):</div>';
      todayTasks.forEach(t => {
        html += '<div class="context-item"><span class="context-item-icon">*</span>' + esc(t.title || 'Untitled') + '</div>';
      });
    }
  }
  if(!html) html = '<div style="font-size:10px;color:var(--text-muted);padding:4px 0">No related items for current view</div>';
  el.innerHTML = html;
}

// === FOCUS TIMER (Embedded) ===
let ftDuration = 1500, ftTimeLeft = 1500, ftRunning = false, ftPaused = false, ftInterval = null;
let ftCategory = 'Writing', ftColor = '#4ade80';
function ftToggle() {
  if(!ftRunning && !ftPaused) ftStart();
  else if(ftRunning) ftPause();
  else ftResume();
}
let ftTaskId=null;
function ftStartForTask(id){
  const t=S.tasks.find(x=>x.id===id);if(!t)return;
  ftTaskId=id;
  ftSetCat(null,t.title.substring(0,20)||'Task','#4ade80');
  ftReset();
  if(!document.querySelector('.app').classList.contains('context-open'))toggleContextPanel();
  closeTaskDetail();
  ftToggle();
  if(!t.timeStarted){t.timeStarted=new Date().toISOString();if(t.status==='todo'){t.status='progress';if(!t.log)t.log=[];t.log.push({from:'todo',to:'progress',at:t.timeStarted});}save();}
  toast('Focus timer started for: '+t.title.substring(0,30));
}
function ftStart() {
  ftRunning = true; ftPaused = false;
  document.getElementById('ft-btn').textContent = 'Pause';
  document.getElementById('ft-btn').classList.add('running');
  document.getElementById('ft-time-adjust').style.opacity = '0.3';
  ftInterval = setInterval(() => {
    ftTimeLeft--;
    ftUpdateDisplay();
    if(ftTimeLeft <= 0) ftComplete();
  }, 1000);
}
function ftPause() {
  ftRunning = false; ftPaused = true;
  clearInterval(ftInterval);
  document.getElementById('ft-btn').textContent = 'Resume';
  document.getElementById('ft-btn').classList.remove('running');
}
function ftResume() { ftStart(); }
function ftComplete() {
  ftRunning = false; ftPaused = false;
  clearInterval(ftInterval);
  document.getElementById('ft-btn').textContent = 'Done!';
  document.getElementById('ft-btn').classList.remove('running');
  ftPlaySound();
  setTimeout(ftReset, 3000);
}
function ftReset() {
  ftRunning = false; ftPaused = false;
  clearInterval(ftInterval);
  ftTimeLeft = ftDuration;
  document.getElementById('ft-btn').textContent = 'Start';
  document.getElementById('ft-btn').classList.remove('running');
  document.getElementById('ft-time-adjust').style.opacity = '1';
  ftUpdateDisplay();
}
function ftUpdateDisplay() {
  const m = Math.floor(ftTimeLeft / 60), s = ftTimeLeft % 60;
  document.getElementById('ft-time').textContent = m + ':' + String(s).padStart(2, '0');
  const progress = 1 - (ftTimeLeft / ftDuration);
  const circumference = 2 * Math.PI * 70;
  const offset = circumference * (1 - progress);
  const prog = document.getElementById('ft-progress');
  if(prog) { prog.style.strokeDasharray = circumference; prog.style.strokeDashoffset = offset; prog.style.stroke = ftColor; }
}
function ftAdjust(min) {
  if(ftRunning || ftPaused) return;
  ftDuration = Math.max(300, Math.min(7200, ftDuration + min * 60));
  ftTimeLeft = ftDuration;
  document.getElementById('ft-duration-label').textContent = Math.floor(ftDuration / 60) + ' min';
  ftUpdateDisplay();
}
function ftSetCat(el, name, color) {
  ftCategory = name; ftColor = color;
  document.querySelectorAll('.ft-cat').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('ft-label').textContent = name;
  ftUpdateDisplay();
}
function ftPlaySound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator(), gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.frequency.setValueAtTime(600, ctx.currentTime + 0.1);
    osc.frequency.setValueAtTime(800, ctx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.5);
  } catch(e) {}
}

// === CLOUD SYNC (Vercel Blob Backend) ===
const ASTRA_API = window.location.origin;
let ASTRA_ADMIN_PW = localStorage.getItem('astra_admin_pw') || '';
let cloudSyncTimer = null;
let lastCloudSync = 0;
const CLOUD_SYNC_INTERVAL = 30000;

function ensureAdminPW() {
  if (ASTRA_ADMIN_PW) return true;
  var pw = prompt('Enter ASTRA admin password for cloud sync:');
  if (!pw) return false;
  ASTRA_ADMIN_PW = pw;
  localStorage.setItem('astra_admin_pw', pw);
  return true;
}

function setCloudIndicator(state) {
  const el = document.getElementById('cloud-sync-indicator');
  if(!el) return;
  if(state==='syncing') { el.style.opacity='1'; el.style.color='var(--accent-cyan)'; el.title='Syncing...'; }
  else if(state==='synced') { el.style.opacity='0.7'; el.style.color='var(--green)'; el.title='Synced '+(new Date().toLocaleTimeString())+' — click to sync'; }
  else if(state==='error') { el.style.opacity='0.8'; el.style.color='var(--red)'; el.title='Sync failed — click to retry'; }
  else { el.style.opacity='0.4'; el.style.color='var(--text-muted)'; el.title='Not synced — click to sync'; }
}
async function cloudSave(silent) {
  if (!ASTRA_ADMIN_PW && silent) return { ok: false };
  if (!ensureAdminPW()) return { ok: false };
  setCloudIndicator('syncing');
  try {
    const state = JSON.parse(localStorage.getItem(SK) || '{}');
    const res = await fetch(ASTRA_API + '/api/state', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify(state)
    });
    const data = await res.json();
    if (data.ok) {
      lastCloudSync = Date.now();
      setCloudIndicator('synced');
      if (!silent) toast('Synced to cloud (v' + data.version + ')');
    } else if (data.error === 'Unauthorized') {
      localStorage.removeItem('astra_admin_pw');
      ASTRA_ADMIN_PW = '';
      setCloudIndicator('error');
      if (!silent) toast('Wrong password. Try Cmd+S again.');
    } else {
      setCloudIndicator('error');
    }
    return data;
  } catch(e) { setCloudIndicator('error'); if (!silent) toast('Cloud sync error: ' + e.message); return { ok: false }; }
}

function scheduleCloudSync() {
  if (cloudSyncTimer) clearTimeout(cloudSyncTimer);
  cloudSyncTimer = setTimeout(function() { cloudSave(true); }, CLOUD_SYNC_INTERVAL);
}

async function cloudLoad() {
  if (!ensureAdminPW()) return;
  try {
    const res = await fetch(ASTRA_API + '/api/state', {
      headers: { 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW }
    });
    const data = await res.json();
    if (data._source === 'blob' && (data.projects || data.tasks || data.docs || data.content)) {
      delete data._source; delete data._savedAt; delete data._version;
      localStorage.setItem(SK, JSON.stringify(data));
      location.reload();
    } else if (data._source === 'none' || data._source === 'empty') {
      toast('No cloud state yet — saving current state');
      cloudSave(false);
    } else { toast('No cloud state found'); }
  } catch(e) { toast('Cloud load error: ' + e.message); }
}

async function logTranscript(text, source) {
  try {
    await fetch(ASTRA_API + '/api/transcripts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify({ text, source: source || 'astra-voice', tags: ['voice-input'] })
    });
  } catch(e) { /* silent fail for transcript logging */ }
}

async function queryAstra(type, params) {
  try {
    const res = await fetch(ASTRA_API + '/api/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify({ type, ...params })
    });
    return await res.json();
  } catch(e) { return { ok: false, error: e.message }; }
}

// === INIT ===
load();
seedLinks();
seedProjects();
migrateV2();
save();
if(localStorage.getItem('sidebar-collapsed')) document.querySelector('.app').classList.add('sidebar-collapsed');
initVoice();
wbLoadState();
renderContent();renderTasks();renderCalendar();renderWriter();renderSpecs();renderLinks();renderProjectsSidebar();renderFolderTree();updateStorage();
ftUpdateDisplay();updateContextStats();
document.getElementById('sidebar-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
setTimeout(function(){ cloudSave(true); }, 3000);
setTimeout(function(){ if(S._notificationsEnabled) checkOverdueNotify(); }, 5000);
if(S._autoBackup) scheduleAutoBackup();
if(S._stickies&&S._stickies.length) renderStickyNotes();
// Whiteboard drop handler for KB items
document.getElementById('panel-whiteboard')?.addEventListener('drop', handleWbDrop);
document.getElementById('panel-whiteboard')?.addEventListener('dragover', e => { if(e.dataTransfer?.types?.includes('text/plain')) e.preventDefault(); });
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
window.addEventListener('beforeunload',()=>{if(zenIsOpen)zenSnapshot();snapshotWriter();snapshotSpec();wbPersist();save();});
document.addEventListener('keydown',e=>{
  // Command Palette: Cmd+K
  if((e.metaKey||e.ctrlKey) && e.key==='k') { e.preventDefault(); openCommandPalette(); return; }
  // Cmd+Shift+W: toggle Zen Writer
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='w'||e.key==='W')) { e.preventDefault(); if(zenIsOpen) zenClose(); else zenOpen(); return; }
  // Cmd+S: save (Zen Writer version save or workspace save)
  if((e.metaKey||e.ctrlKey) && e.key==='s') { e.preventDefault(); if(zenIsOpen){ zenSaveVersion(); } else { snapshotWriter(); snapshotSpec(); wbPersist(); save(); cloudSave(); } return; }
  // Cmd+Shift+S: toggle Scratchpad
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='s'||e.key==='S')) { e.preventDefault(); toggleScratchpad(); return; }
  // Skip shortcuts when typing in inputs
  const inInput = e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.contentEditable==='true';
  if(e.key==='Escape'){
    if(zenIsOpen) { zenClose(); return; }
    if(document.getElementById('task-detail-modal').classList.contains('open')) { closeTaskDetail(); return; }
    if(document.getElementById('cmd-overlay').classList.contains('open')) { closeCommandPalette(); return; }
    document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));
    if(activeProject) closeProjectPanel();
  }
  if(inInput) return;
  // Priority shortcuts in task detail modal (1-4 for p0-p3)
  if(document.getElementById('task-detail-modal').classList.contains('open')&&!e.metaKey&&!e.ctrlKey){
    const pMap={'1':'p0','2':'p1','3':'p2','4':'p3'};
    if(pMap[e.key]){document.getElementById('td-priority').value=pMap[e.key];toast('Priority: '+pMap[e.key].toUpperCase());return;}
    if(e.key==='s'&&!e.shiftKey){saveTaskDetail();return;}
  }
  // Cmd+number: switch sections
  if((e.metaKey||e.ctrlKey) && e.key>='1' && e.key<='9') {
    e.preventDefault();
    const sections = ['content','tasks','calendar','writer','specs','links','whiteboard','pipeline','repos'];
    const idx = parseInt(e.key)-1;
    if(sections[idx]) {
      const items = document.querySelectorAll('.sidebar-item');
      switchSection(sections[idx], items[idx]||null);
    }
    return;
  }
  // Cmd+Shift+N: quick capture
  if((e.metaKey||e.ctrlKey) && e.shiftKey && e.key==='n') { e.preventDefault(); qcOpen(); return; }
  // Cmd+Shift+T: new task from anywhere
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='t'||e.key==='T')) { e.preventDefault(); switchSection('tasks',document.querySelectorAll('.sidebar-item')[1]||null); setTimeout(()=>addTask(),100); return; }
  // Cmd+B: toggle sidebar
  if((e.metaKey||e.ctrlKey) && e.key==='b' && !e.shiftKey) { e.preventDefault(); toggleSidebar(); return; }
  // Cmd+Shift+D: today view
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='d'||e.key==='D')) { e.preventDefault(); showTodayView(); return; }
  // Cmd+Shift+F: toggle focus mode
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='f'||e.key==='F')) { e.preventDefault(); const app=document.querySelector('.app');const isFocus=app.classList.contains('mode-focus');setMode(isFocus?'default':'focus'); return; }
  // Cmd+Shift+W: open Zen Writer
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='w'||e.key==='W')) { e.preventDefault(); zenOpen(); return; }
  // Cmd+Shift+E: export current section
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='e'||e.key==='E')) { e.preventDefault(); if(currentSection==='tasks')exportTasks();else if(currentSection==='content')exportContent();else if(currentSection==='links')exportLinks();else if(currentSection==='calendar')exportWeek();else if(currentSection==='writer'){writerExport('clipboard');}else toast('No export for this section'); return; }
  // Cmd+D: duplicate current item (writer doc / spec)
  if((e.metaKey||e.ctrlKey) && e.key==='d' && !e.shiftKey && currentSection==='writer') { e.preventDefault(); if(S.activeDoc)dupDoc(S.activeDoc); return; }
  if((e.metaKey||e.ctrlKey) && e.key==='d' && !e.shiftKey && currentSection==='specs') { e.preventDefault(); if(S.activeSpec)dupSpec(S.activeSpec); return; }
  // Cmd+N: new item in current section
  if((e.metaKey||e.ctrlKey) && e.key==='n' && !e.shiftKey) {
    e.preventDefault();
    if(currentSection==='content') openContentModal();
    else if(currentSection==='tasks') addTask();
    else if(currentSection==='writer') newDoc();
    else if(currentSection==='specs') newSpec();
    else if(currentSection==='links') openLinkModal();
    return;
  }
  // Cmd+Z: undo last delete (content)
  if((e.metaKey||e.ctrlKey) && e.key==='z' && !e.shiftKey) { if(lastDeletedContent){e.preventDefault();undoDeleteContent();return;} if(lastDeletedLink){e.preventDefault();undoDeleteLink();return;} }
  // Cmd+E: toggle context panel
  if((e.metaKey||e.ctrlKey) && e.key==='e') { e.preventDefault(); toggleContextPanel(); return; }
  // Cmd+\\: toggle focus mode
  if((e.metaKey||e.ctrlKey) && e.key==='\\') { e.preventDefault(); setMode(currentMode==='focus'?'default':'focus'); return; }
  // Cmd+/: show shortcuts help
  if((e.metaKey||e.ctrlKey) && e.key==='/') { e.preventDefault(); document.getElementById('shortcuts-modal').classList.toggle('open'); return; }
});

// === RESIZE HANDLE FOR PROJECT PANEL ===
(function(){
  const handle = document.getElementById('project-resize-handle');
  const root = document.documentElement;
  let dragging = false;
  let startX, startWidth;
  handle.addEventListener('mousedown', e => {
    dragging = true;
    handle.classList.add('dragging');
    startX = e.clientX;
    startWidth = document.getElementById('panel-project').offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if(!dragging) return;
    const delta = startX - e.clientX;
    const newWidth = Math.max(280, Math.min(800, startWidth + delta));
    root.style.setProperty('--project-width', newWidth + 'px');
  });
  document.addEventListener('mouseup', () => {
    if(!dragging) return;
    dragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  });
})();

// === PIPELINE ===
let plRecorder=null, plChunks=[], plRecording=false, plRecStart=0, plRecTimer=null, plAudioBlob=null, plTranscriptText='', plSynthesisText='', plApiOk=null;
function plCheckApi(){
  if(!ASTRA_ADMIN_PW){document.getElementById('pl-status-dot').style.background='var(--text-muted)';document.getElementById('pl-status-dot').title='No password set';document.getElementById('pl-onboarding').style.display='block';return;}
  fetch(ASTRA_API+'/api/health',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}}).then(r=>r.json()).then(d=>{
    plApiOk=true;document.getElementById('pl-status-dot').style.background='var(--green)';document.getElementById('pl-status-dot').title='API connected';document.getElementById('pl-onboarding').style.display='none';
  }).catch(()=>{
    plApiOk=false;document.getElementById('pl-status-dot').style.background='var(--orange)';document.getElementById('pl-status-dot').title='API unreachable';document.getElementById('pl-onboarding').style.display='block';
  });
}
function plSaveLocal(entry){if(!S.pipelineHistory)S.pipelineHistory=[];S.pipelineHistory.unshift(entry);if(S.pipelineHistory.length>50)S.pipelineHistory.length=50;save();}

function plToggleRecord() {
  const btn=document.getElementById('pl-record-btn');
  const indicator=document.getElementById('pl-recording');
  if(plRecording && plRecorder && plRecorder.state==='recording') {
    plRecorder.stop();
    plRecording=false;
    btn.textContent='Record Mic';
    btn.classList.remove('active');
    indicator.style.display='none';
    clearInterval(plRecTimer);
    toast('Processing audio...');
    return;
  }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
    plChunks=[];
    plRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'});
    plRecorder.ondataavailable=e=>{if(e.data.size>0)plChunks.push(e.data);};
    plRecorder.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      plAudioBlob=new Blob(plChunks,{type:'audio/webm'});
      const preview=document.getElementById('pl-input-preview');
      preview.style.display='block';
      preview.textContent='Audio recorded ('+Math.round(plAudioBlob.size/1024)+'KB). Ready to process.';
      toast('Audio ready — set your prompt and hit Process');
    };
    plRecorder.start();
    plRecording=true;
    btn.textContent='Stop Recording';
    btn.classList.add('active');
    indicator.style.display='flex';
    plRecStart=Date.now();
    plRecTimer=setInterval(()=>{
      document.getElementById('pl-rec-time').textContent='Recording... '+Math.floor((Date.now()-plRecStart)/1000)+'s';
    },1000);
    toast('Recording...');
  }).catch(()=>toast('Mic access denied'));
}

function plUploadFile(input) {
  const file=input.files[0];
  if(!file) return;
  plAudioBlob=file;
  const preview=document.getElementById('pl-input-preview');
  preview.style.display='block';
  preview.textContent='File: '+file.name+' ('+Math.round(file.size/1024)+'KB). Ready to process.';
  toast('Audio loaded — set your prompt and hit Process');
  input.value='';
}

// Pipeline drop zone for text/audio files
(function(){
  const panel=document.getElementById('panel-pipeline');
  if(!panel)return;
  panel.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='copy';panel.style.outline='2px dashed var(--accent)';});
  panel.addEventListener('dragleave',()=>{panel.style.outline='none';});
  panel.addEventListener('drop',e=>{
    e.preventDefault();panel.style.outline='none';
    const file=e.dataTransfer.files[0];if(!file)return;
    if(file.type.startsWith('audio/')){plAudioBlob=file;const p=document.getElementById('pl-input-preview');p.style.display='block';p.textContent='Audio: '+file.name+' ('+Math.round(file.size/1024)+'KB)';toast('Audio loaded');}
    else if(file.type.startsWith('text/')||file.name.endsWith('.txt')||file.name.endsWith('.md')){
      const r=new FileReader();r.onload=()=>{plAudioBlob=null;plTranscriptText=r.result;const p=document.getElementById('pl-input-preview');p.style.display='block';p.textContent=plTranscriptText.length>300?plTranscriptText.substring(0,300)+'...':plTranscriptText;toast('Text loaded from '+file.name);};r.readAsText(file);
    }else{toast('Drop audio or text files');}
  });
})();
function plPasteText() {
  navigator.clipboard.readText().then(text=>{
    if(!text){toast('Clipboard empty');return;}
    plAudioBlob=null;
    plTranscriptText=text;
    const preview=document.getElementById('pl-input-preview');
    preview.style.display='block';
    const wc=text.trim().split(/\s+/).filter(x=>x.length).length;
    preview.innerHTML='<div style="font-size:8px;color:var(--accent);margin-bottom:4px">'+text.length+' chars / '+wc+' words</div>'+(text.length>300?esc(text.substring(0,300))+'...':esc(text));
    toast('Text pasted — set your prompt and hit Process');
  }).catch(()=>toast('Cannot read clipboard'));
}

async function plProcess() {
  const prompt=document.getElementById('pl-prompt').value.trim();
  if(!prompt){toast('Enter a prompt first');return;}
  if(!plAudioBlob && !plTranscriptText){toast('Record, upload, or paste something first');return;}

  const btn=document.getElementById('pl-process-btn');
  btn.textContent='Processing...';
  btn.disabled=true;

  try {
    const source=document.getElementById('pl-source').value;
    let res;
    if(plAudioBlob) {
      const fd=new FormData();
      fd.append('audio',plAudioBlob,plAudioBlob.name||'recording.webm');
      fd.append('prompt',prompt);
      fd.append('source',source);
      res=await fetch(ASTRA_API+'/api/pipeline',{method:'POST',headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW},body:fd});
    } else {
      res=await fetch(ASTRA_API+'/api/pipeline',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+ASTRA_ADMIN_PW},body:JSON.stringify({text:plTranscriptText,prompt:prompt,source:source})});
    }
    const data=await res.json();
    if(data.ok) {
      plTranscriptText=data.transcript||'';
      plSynthesisText=data.synthesis||'';
      const resultDiv=document.getElementById('pl-result');
      resultDiv.style.display='block';
      if(data.inputType==='audio'&&data.transcript) {
        document.getElementById('pl-transcript-box').style.display='block';
        document.getElementById('pl-transcript-text').textContent=data.transcript;
      } else {
        document.getElementById('pl-transcript-box').style.display='none';
      }
      document.getElementById('pl-synthesis-text').textContent=data.synthesis;
      plUpdateResultStats(data.synthesis);
      plSaveLocal({id:data.pipelineId||('p_'+Date.now()),inputType:data.inputType||'text',prompt:prompt,preview:(data.synthesis||'').substring(0,200),source:source,createdAt:new Date().toISOString()});
      toast('Pipeline complete!');
    } else {
      toast('Error: '+(data.error||'unknown'));
    }
  } catch(e) {
    // Fallback: local text processing if API unavailable
    if(plTranscriptText){
      const result=plLocalProcess(plTranscriptText,prompt);
      plSynthesisText=result;
      document.getElementById('pl-result').style.display='block';
      document.getElementById('pl-transcript-box').style.display='none';
      document.getElementById('pl-synthesis-text').textContent=result;
      plUpdateResultStats(result);
      plSaveLocal({id:'p_'+Date.now(),inputType:'text',prompt:prompt,preview:result.substring(0,200),source:document.getElementById('pl-source').value,createdAt:new Date().toISOString()});
      toast('Processed locally (API unavailable)');
    } else {
      toast('Pipeline error: '+e.message);
    }
  } finally {
    btn.textContent='Process Pipeline';
    btn.disabled=false;
  }
}
function plLocalProcess(text,prompt){
  const words=text.trim().split(/\s+/).filter(x=>x.length);
  const sentences=text.split(/[.!?]+/).map(s=>s.trim()).filter(Boolean);
  const pl=prompt.toLowerCase();
  if(pl.includes('summar')){return'Summary (local):\n\n'+sentences.slice(0,Math.min(5,Math.ceil(sentences.length/3))).map(s=>'- '+s+'.').join('\n')+'\n\nStats: '+words.length+' words, '+sentences.length+' sentences.';}
  if(pl.includes('action')||pl.includes('task')||pl.includes('checklist')){const actions=sentences.filter(s=>/\b(need|must|should|will|todo|action|fix|add|create|build|update|check|review|send|schedule)\b/i.test(s));return'Action Items (local):\n\n'+(actions.length?actions.map(a=>'[ ] '+a+'.').join('\n'):'No explicit action items found.\n\nAll sentences:\n'+sentences.map(s=>'[ ] '+s+'.').join('\n'));}
  if(pl.includes('clean')||pl.includes('grammar')){return text.replace(/\s+/g,' ').replace(/\s([,.!?;:])/g,'$1').replace(/([.!?])\s*/g,'$1 ').trim();}
  if(pl.includes('count')||pl.includes('stat')){const chars=text.length;const paras=text.split(/\n\s*\n/).filter(Boolean).length;const uniq=[...new Set(words.map(w=>w.toLowerCase()))].length;return'Text Statistics:\n\nWords: '+words.length+'\nCharacters: '+chars+'\nSentences: '+sentences.length+'\nParagraphs: '+paras+'\nUnique words: '+uniq+'\nAvg words/sentence: '+Math.round(words.length/Math.max(1,sentences.length))+'\nReading time: '+Math.max(1,Math.ceil(words.length/238))+' min';}
  if(pl.includes('keyword')||pl.includes('frequent')||pl.includes('top word')){const freq={};words.forEach(w=>{const lw=w.toLowerCase().replace(/[^a-z0-9]/g,'');if(lw.length>3){freq[lw]=(freq[lw]||0)+1;}});const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,20);return'Top Keywords (local):\n\n'+sorted.map(([w,c])=>w+': '+c+' times').join('\n');}
  if(pl.includes('bullet')||pl.includes('list')){return'Bullet Points (local):\n\n'+sentences.map(s=>'- '+s.charAt(0).toUpperCase()+s.slice(1)+'.').join('\n');}
  if(pl.includes('question')||pl.includes('faq')){const qs=sentences.filter(s=>/\?|who|what|when|where|why|how|which|can|could|should|would|is|are|do|does/i.test(s));return'Questions Found (local):\n\n'+(qs.length?qs.map(q=>'Q: '+q+(q.endsWith('?')?'':'?')).join('\n\n'):'No explicit questions found in the text.');}
  if(pl.includes('headline')||pl.includes('title')){const caps=sentences.slice(0,5).map(s=>{const w=s.split(/\s+/).slice(0,8).join(' ');return w.split(' ').map(x=>x.charAt(0).toUpperCase()+x.slice(1).toLowerCase()).join(' ');});return'Headline Suggestions (local):\n\n'+caps.map((h,i)=>(i+1)+'. '+h).join('\n');}
  return'Processed text (local - API unavailable):\n\nInput: '+words.length+' words, '+sentences.length+' sentences.\n\nKey sentences:\n'+sentences.slice(0,5).map(s=>'- '+s+'.').join('\n')+'\n\nNote: For advanced processing (AI summarization, translation, etc.), configure OPENAI_API_KEY in Vercel environment variables.';
}
function plWordCloud(){
  const text=(document.getElementById('pl-text')?.value||'').trim();
  if(!text){toast('Paste or enter text first');return;}
  const stopWords=new Set(['the','a','an','is','are','was','were','be','been','have','has','had','do','does','did','will','would','shall','should','may','might','must','can','could','and','but','or','nor','for','yet','so','in','on','at','to','of','by','with','from','as','into','through','during','before','after','above','below','up','down','out','off','over','under','again','then','once','here','there','when','where','why','how','all','each','every','both','few','more','most','other','some','such','no','not','only','own','same','than','too','very','just','also','about','its','it','this','that','these','those','i','me','my','we','us','our','you','your','he','him','his','she','her','they','them','their','what','which','who','been','being','because']);
  const words=text.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stopWords.has(w));
  const freq={};words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,40);
  if(!sorted.length){toast('Not enough words');return;}
  const maxF=sorted[0][1];const svgW=500;const svgH=300;
  const colors=['#4ade80','#22d3ee','#a855f7','#f472b6','#fbbf24','#f87171','#34d399','#60a5fa','#c084fc','#fb923c'];
  let cloudSvg='<svg xmlns="http://www.w3.org/2000/svg" width="'+svgW+'" height="'+svgH+'" style="background:#0a0a0e;border-radius:8px">';
  const placed=[];
  sorted.forEach(([w,c],i)=>{
    const size=Math.max(10,Math.round((c/maxF)*36));
    const color=colors[i%colors.length];
    for(let attempt=0;attempt<50;attempt++){
      const x=20+Math.random()*(svgW-40);const y=20+Math.random()*(svgH-40);
      const overlap=placed.some(p=>Math.abs(p.x-x)<(p.w+w.length*size*0.5)/2&&Math.abs(p.y-y)<size);
      if(!overlap){
        cloudSvg+=`<text x="${x}" y="${y}" font-size="${size}" fill="${color}" font-family="system-ui" opacity="${0.6+0.4*(c/maxF)}">${w}</text>`;
        placed.push({x,y,w:w.length*size*0.6});break;
      }
    }
  });
  cloudSvg+='</svg>';
  const resultDiv=document.getElementById('pl-result');resultDiv.style.display='block';
  document.getElementById('pl-synthesis-text').innerHTML=cloudSvg+'<div style="margin-top:8px;font-size:10px;color:var(--text-muted)">Top words: '+sorted.slice(0,10).map(([w,c])=>w+'('+c+')').join(', ')+'</div>';
  toast('Word cloud generated');
}
function plSaveTemplate(){
  const prompt=document.getElementById('pl-prompt').value.trim();
  if(!prompt){toast('Write a prompt first');return;}
  const name=window.prompt('Template name:',prompt.substring(0,30));
  if(!name)return;
  if(!S.pipelineTemplates)S.pipelineTemplates=[];
  S.pipelineTemplates.push({name:name.trim(),prompt,created:new Date().toISOString()});
  save();plRenderCustomTemplates();toast('Template saved: '+name.trim());
}
function plRenderCustomTemplates(){
  const el=document.getElementById('pl-custom-templates');if(!el)return;
  const tpls=S.pipelineTemplates||[];
  if(!tpls.length){el.innerHTML='';return;}
  el.innerHTML=tpls.map((t,i)=>`<button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='${escA(t.prompt)}'" style="font-size:8px;padding:2px 6px;border-color:rgba(74,222,128,0.15)" title="${escA(t.prompt)}">${esc(t.name)}</button><span style="font-size:7px;color:var(--text-muted);cursor:pointer;opacity:0.4" onclick="plDeleteTemplate(${i})" title="Delete template">x</span>`).join('');
}
function plDeleteTemplate(idx){
  if(!S.pipelineTemplates||!S.pipelineTemplates[idx])return;
  S.pipelineTemplates.splice(idx,1);save();plRenderCustomTemplates();toast('Template deleted');
}

function plCopyResult() {
  const text=document.getElementById('pl-synthesis-text').textContent;
  navigator.clipboard.writeText(text).then(()=>toast('Copied!')).catch(()=>toast('Copy failed'));
}

function plSaveCapture() {
  fetch(ASTRA_API+'/api/capture',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+ASTRA_ADMIN_PW},body:JSON.stringify({
    content:plSynthesisText,category:'pipeline',source:'pipeline-ui',sourceTitle:'Pipeline Result',type:'synthesis',tags:['pipeline','processed']
  })}).then(r=>r.json()).then(d=>{
    if(d.ok) toast('Saved to ASTRA!');
    else toast('Save error');
  }).catch(()=>toast('Save failed'));
}
function plSaveToContent(){
  const text=plSynthesisText||document.getElementById('pl-synthesis-text').textContent;
  if(!text){toast('No result to save');return;}
  const prompt=document.getElementById('pl-prompt').value.trim();
  const src=document.getElementById('pl-source').value.replace('pipeline-','');
  S.content.unshift({id:Date.now(),body:text,theme:'pipeline',tags:['pipeline',src].filter(Boolean),created:new Date().toISOString()});
  save();toast('Saved to Content section');
  if(currentSection==='content')renderContent();
}

async function plLoadHistory() {
  const histDiv=document.getElementById('pl-history');
  const listDiv=document.getElementById('pl-history-list');
  histDiv.style.display=histDiv.style.display==='none'?'block':'none';
  if(histDiv.style.display==='none') return;
  listDiv.innerHTML='<div style="font-size:10px;color:var(--text-muted)">Loading...</div>';
  let results=[];
  let source='none';
  try {
    if(ASTRA_ADMIN_PW){
      const res=await fetch(ASTRA_API+'/api/pipeline',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}});
      const data=await res.json();
      if(data.ok && data.results && data.results.length>0){results=data.results;source='cloud';}
    }
  } catch(e){}
  if(!results.length && S.pipelineHistory && S.pipelineHistory.length){results=S.pipelineHistory;source='local';}
  const hq=(document.getElementById('pl-history-search')?.value||'').toLowerCase();
  if(hq)results=results.filter(r=>((r.preview||'')+(r.prompt||'')+(r.source||'')).toLowerCase().includes(hq));
  if(results.length>0){
    const srcColors={'pipeline-manual':'var(--accent)','pipeline-whatsapp':'#25d366','pipeline-voice':'#a855f7','pipeline-capture':'#fbbf24'};
    listDiv.innerHTML=(source==='local'?'<div style="font-size:9px;color:var(--text-muted);margin-bottom:8px;padding:4px 8px;background:var(--bg-elevated);border-radius:3px">Showing local history ('+results.length+' entries)</div>':'')+results.map((r,i)=>{const full=r.preview||'';const short=full.length>150?full.substring(0,150)+'...':full;const sc=srcColors[r.source]||'var(--text-muted)';const srcLabel=(r.source||'').replace('pipeline-','');return '<div style="padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;margin-bottom:8px;cursor:pointer" onclick="this.querySelector(\'.pl-full\').style.display=this.querySelector(\'.pl-full\').style.display===\'none\'?\'block\':\'none\';this.querySelector(\'.pl-short\').style.display=this.querySelector(\'.pl-short\').style.display===\'none\'?\'block\':\'none\'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:4px"><div style="display:flex;gap:4px;align-items:center"><span class="badge badge-blue" style="font-size:9px">'+esc(r.inputType||'text')+'</span><span style="font-size:8px;padding:2px 6px;border-radius:3px;border:1px solid '+sc+';color:'+sc+'">'+esc(srcLabel||'manual')+'</span></div><span style="font-size:9px;color:var(--text-muted)">'+new Date(r.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})+'</span></div>'+(r.prompt?'<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;font-style:italic;border-left:2px solid var(--accent);padding-left:8px">'+esc(r.prompt)+'</div>':'')+'<div class="pl-short" style="font-size:11px;line-height:1.5;color:var(--text-secondary)">'+esc(short)+(full.length>150?' <span style="color:var(--accent);font-size:9px">[click to expand]</span>':'')+'</div><div class="pl-full" style="display:none;font-size:11px;line-height:1.6;color:var(--text);white-space:pre-wrap">'+esc(full)+'</div><div style="display:flex;gap:4px;margin-top:8px" onclick="event.stopPropagation()"><button class="btn btn-sm btn-ghost" onclick="navigator.clipboard.writeText('+JSON.stringify(full).replace(/'/g,"\\'")+');toast(\'Copied\')">Copy</button><button class="btn btn-sm btn-ghost" onclick="S.content.unshift({id:Date.now(),type:\'caption\',theme:\'pipeline\',body:'+JSON.stringify(full).replace(/'/g,"\\'")+',tags:[\'pipeline\'],created:new Date().toISOString()});save();toast(\'Saved to content\')">To Content</button><button class="btn btn-sm btn-ghost btn-danger" onclick="plDeleteEntry('+i+');event.stopPropagation()">Delete</button></div></div>';}).join('');
  } else {
    listDiv.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">P</div><div style="font-size:11px">No pipeline history yet</div><div style="font-size:10px;margin-top:4px">Paste text, write a prompt, and hit Process</div></div>';
  }
}

function plDeleteEntry(idx){
  if(!confirm('Delete this pipeline entry?'))return;
  if(S.pipelineHistory&&S.pipelineHistory[idx]){S.pipelineHistory.splice(idx,1);save();plLoadHistory();plLoadHistory();toast('Deleted');}
}
function plUpdateResultStats(text){
  const el=document.getElementById('pl-result-stats');if(!el||!text)return;
  const words=text.trim().split(/\s+/).filter(x=>x.length).length;
  const chars=text.length;
  const lines=text.split('\n').length;
  const sents=text.split(/[.!?]+/).filter(s=>s.trim().length).length;
  el.textContent=words+' words / '+chars+' chars / '+lines+' lines / '+sents+' sentences';
}
function plClearResult(){
  document.getElementById('pl-result').style.display='none';
  document.getElementById('pl-input-preview').style.display='none';
  plAudioBlob=null;plTranscriptText='';plSynthesisText='';
  document.getElementById('pl-prompt').value='';
}
async function plViewEntry(id) {
  try {
    const res=await fetch(ASTRA_API+'/api/pipeline',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}});
    const data=await res.json();
    const entry=(data.results||[]).find(r=>r.id===id);
    if(entry) {
      document.getElementById('pl-synthesis-text').textContent=entry.preview||'(load full entry)';
      document.getElementById('pl-result').style.display='block';
      toast('Loaded: '+id);
    }
  } catch(e) { toast('Error loading entry'); }
}

// === REPOS ===
function timeAgo(dateStr){
  if(!dateStr)return '';
  const d=new Date(dateStr),now=new Date(),ms=now-d,s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60),dy=Math.floor(h/24);
  if(dy>30)return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if(dy>0)return dy+'d ago';if(h>0)return h+'h ago';if(m>0)return m+'m ago';return 'just now';
}
function reposRefresh() {
  if(!S.repos || !S.repos.length) {
    S.repos = [
      { name:'astra-command-center', github:'https://github.com/gabosaturno11/astra-command-center', live:'https://astra-command-center-sigma.vercel.app', role:'backend-hub', status:'active', desc:'ASTRA V2 command center, project hub, KB, whiteboard, API backend', updatedAt:new Date().toISOString() },
      { name:'saturno-bonus', github:'https://github.com/gabosaturno11/saturno-bonus', live:'https://saturno-bonus-omega.vercel.app', role:'customer-facing', status:'active', desc:'Bonus vault for SM Academy customers. 60 tools, 15 PDFs, music player.', updatedAt:new Date().toISOString() },
      { name:'titan-forge', github:'https://github.com/gabosaturno11/titan-forge', live:'https://titan-forge-ten.vercel.app', role:'internal-tools', status:'active', desc:'Internal tools collection. Bonus page moved out to saturno-bonus.', updatedAt:new Date().toISOString() },
      { name:'de-aqui-a-saturno', github:'https://github.com/gabosaturno11/de-aqui-a-saturno', live:'https://de-aqui-a-saturno-jet.vercel.app', role:'experience', status:'complete', desc:'Valentine crystal cosmic scroll. Gate, 18 chapters, 11 love dimensions.', updatedAt:'2026-02-14T00:00:00Z' },
      { name:'nexus-capture', github:'https://github.com/gabosaturno11/nexus-capture', live:null, role:'extension', status:'active', desc:'Chrome extension for universal highlight capture. Routes to ASTRA API.', updatedAt:new Date().toISOString() },
    ];
    save();
  }
  const grid=document.getElementById('repos-grid');
  if(!grid) return;
  const rq=(document.getElementById('repo-search')?.value||'').toLowerCase();
  let repos=[...(S.repos||[])];
  if(rq)repos=repos.filter(r=>(r.name+' '+r.role+' '+r.desc+' '+r.status).toLowerCase().includes(rq));
  const rsort=(document.getElementById('repo-sort')?.value)||'name';
  if(rsort==='name')repos.sort((a,b)=>a.name.localeCompare(b.name));
  else if(rsort==='status')repos.sort((a,b)=>(a.status||'').localeCompare(b.status||''));
  else if(rsort==='updated')repos.sort((a,b)=>new Date(b.updatedAt||0)-new Date(a.updatedAt||0));
  else if(rsort==='role')repos.sort((a,b)=>(a.role||'').localeCompare(b.role||''));
  const cntEl=document.getElementById('repos-count');if(cntEl)cntEl.textContent=(S.repos||[]).length;
  const roleColors={'backend-hub':'var(--accent)','customer-facing':'#22d3ee','internal-tools':'#a855f7','experience':'#f472b6','extension':'#fbbf24'};
  const roleIcons={'backend-hub':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/></svg>','customer-facing':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>','internal-tools':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>','experience':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>','extension':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>'};
  if(!repos.length){grid.innerHTML=`<div style="text-align:center;padding:30px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">R</div><div style="font-size:12px">${rq?'No matching repos':'No repos connected'}</div><div style="font-size:10px;margin-top:4px">${rq?'Try a different filter':'Click + Add to connect a repository'}</div></div>`;return;}
  const renderRepoCard=r=>{
    const rc=roleColors[r.role]||'var(--text-muted)';
    const sc=r.status==='active'?'var(--green)':r.status==='complete'?'var(--accent-cyan)':'var(--text-muted)';
    const icon=roleIcons[r.role]||'';
    return `<div style="padding:14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);transition:all 0.15s" onmouseenter="this.style.borderColor='rgba(255,255,255,0.08)'" onmouseleave="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span style="color:${rc};flex-shrink:0">${icon}</span>
        <span style="font-size:13px;font-weight:600;color:var(--text);flex:1">${esc(r.name)}</span>
        <span style="width:8px;height:8px;border-radius:50%;background:${sc}" title="${r.status}"></span>
        ${r.live?'<span style="font-size:7px;padding:1px 5px;border-radius:3px;background:rgba(74,222,128,0.1);color:var(--accent);border:1px solid rgba(74,222,128,0.2)">LIVE</span>':'<span style="font-size:7px;padding:1px 5px;border-radius:3px;background:rgba(255,255,255,0.04);color:var(--text-muted)">LOCAL</span>'}
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.06em;color:${rc}">${esc(r.role)}</span>
        ${r.updatedAt?'<span style="font-size:8px;color:var(--text-muted)">'+timeAgo(r.updatedAt)+'</span>':''}
        ${r.lastDeploy?'<span style="font-size:8px;color:var(--accent);font-family:var(--mono)" title="Last deploy">deployed '+r.lastDeploy+'</span>':''}
      </div>
      <div style="font-size:11px;color:var(--text-secondary);margin-bottom:${r.notes||r.lastCommit||r.stack?'4':'10'}px;line-height:1.5">${esc(r.desc)}</div>${r.stack?`<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px">${r.stack.split(',').map(t=>`<span style="font-size:7px;padding:1px 5px;border-radius:8px;border:1px solid rgba(74,222,128,0.2);color:var(--accent);letter-spacing:0.03em">${esc(t.trim())}</span>`).join('')}</div>`:''}${r.lastCommit?`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px;font-family:var(--mono);padding:3px 6px;background:var(--bg-deep);border-radius:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">last: ${esc(r.lastCommit)}</div>`:''}${r.notes?`<div style="font-size:10px;color:var(--accent);margin-bottom:10px;padding:4px 6px;background:rgba(74,222,128,0.04);border-radius:4px;border-left:2px solid var(--accent);line-height:1.4">${esc(r.notes)}</div>`:''}
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <a href="${escA(r.github)}" target="_blank" style="font-size:10px;color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:3px"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg> repo</a>
        ${r.live?`<a href="${escA(r.live)}" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:${r.lastCheck?(r.lastCheckOk?'var(--green)':'var(--red)'):'var(--green)'};display:inline-block"></span> live${r.lastCheck?' ('+timeAgo(r.lastCheck)+')':''}</a>`:'<span style="font-size:10px;color:var(--text-muted)">local only</span>'}
        <span style="flex:1"></span>
        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('git clone ${escA(r.github)}.git');toast('Clone command copied')" style="font-size:9px;padding:2px 6px" title="Copy git clone command">Clone</button>
        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('${escA(r.github)}')" style="font-size:9px;padding:2px 6px" title="Copy GitHub URL">URL</button>
        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();openRepoModal('${escA(r.name)}')" style="font-size:9px;padding:2px 6px">Edit</button>
        <button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();deleteRepo('${escA(r.name)}')" style="font-size:9px;padding:2px 6px">Del</button>
      </div>
    </div>`;};
  let repoHtml='';if(rsort==='role'||rsort==='status'){let lastGrp=null;repos.forEach(r=>{const grp=rsort==='role'?(r.role||'other'):(r.status||'unknown');if(grp!==lastGrp){const cnt=repos.filter(x=>(rsort==='role'?(x.role||'other'):(x.status||'unknown'))===grp).length;const gc=rsort==='role'?(roleColors[grp]||'var(--text-muted)'):(grp==='active'?'var(--green)':grp==='complete'?'var(--accent-cyan)':'var(--text-muted)');repoHtml+=`<div style="grid-column:1/-1;padding:8px 4px 4px;font-size:11px;font-weight:600;color:${gc};border-bottom:1px solid var(--border);margin-bottom:2px;text-transform:uppercase;letter-spacing:0.05em">${esc(grp)} <span style="font-size:9px;color:var(--text-muted);font-weight:400">${cnt}</span></div>`;lastGrp=grp;}repoHtml+=renderRepoCard(r);});}else{repoHtml=repos.map(renderRepoCard).join('');}
  grid.innerHTML=repoHtml;
}

async function repoHealthCheck(){
  const repos=(S.repos||[]).filter(r=>r.live);
  if(!repos.length){toast('No repos with live URLs');return;}
  toast('Checking '+repos.length+' live URLs...');
  let ok=0,fail=0;
  for(const r of repos){
    try{
      const res=await fetch(r.live,{mode:'no-cors',signal:AbortSignal.timeout(5000)});
      r.lastCheck=new Date().toISOString();r.lastCheckOk=true;ok++;
    }catch(e){r.lastCheck=new Date().toISOString();r.lastCheckOk=false;fail++;}
  }
  save();reposRefresh();toast(ok+' up, '+fail+' down');
}

// === REPO MODAL ===
let editingRepoName=null;
function openRepoModal(name){
  editingRepoName=name||null;
  document.getElementById('repo-modal-title').textContent=name?'Edit Repo':'Add Repo';
  if(name){
    const r=(S.repos||[]).find(x=>x.name===name);
    if(r){document.getElementById('rm-name').value=r.name;document.getElementById('rm-github').value=r.github||'';document.getElementById('rm-live').value=r.live||'';document.getElementById('rm-role').value=r.role||'other';document.getElementById('rm-status').value=r.status||'active';document.getElementById('rm-desc').value=r.desc||'';document.getElementById('rm-notes').value=r.notes||'';document.getElementById('rm-lastcommit').value=r.lastCommit||'';document.getElementById('rm-stack').value=r.stack||'';document.getElementById('rm-deploy').value=r.lastDeploy||'';}
  } else {
    document.getElementById('rm-name').value='';document.getElementById('rm-github').value='';document.getElementById('rm-live').value='';document.getElementById('rm-role').value='other';document.getElementById('rm-status').value='active';document.getElementById('rm-desc').value='';document.getElementById('rm-notes').value='';document.getElementById('rm-lastcommit').value='';document.getElementById('rm-stack').value='';document.getElementById('rm-deploy').value='';
  }
  document.getElementById('repo-modal').classList.add('open');
  setTimeout(()=>document.getElementById('rm-name').focus(),100);
}
function closeRepoModal(){document.getElementById('repo-modal').classList.remove('open');editingRepoName=null;}
function saveRepo(){
  const name=document.getElementById('rm-name').value.trim();
  if(!name){toast('Name required');return;}
  const notes=document.getElementById('rm-notes').value.trim();
  const lastCommit=document.getElementById('rm-lastcommit').value.trim();
  const stack=document.getElementById('rm-stack').value.trim();
  const lastDeploy=document.getElementById('rm-deploy').value;
  const data={name,github:document.getElementById('rm-github').value.trim(),live:document.getElementById('rm-live').value.trim()||null,role:document.getElementById('rm-role').value,status:document.getElementById('rm-status').value,desc:document.getElementById('rm-desc').value.trim(),notes:notes||undefined,lastCommit:lastCommit||undefined,stack:stack||undefined,lastDeploy:lastDeploy||undefined,updatedAt:new Date().toISOString()};
  if(!S.repos)S.repos=[];
  if(editingRepoName){
    const idx=S.repos.findIndex(r=>r.name===editingRepoName);
    if(idx>=0)S.repos[idx]=data;
    else S.repos.push(data);
  } else {
    if(S.repos.find(r=>r.name===name)){toast('Repo already exists');return;}
    S.repos.push(data);
  }
  save();closeRepoModal();reposRefresh();toast(editingRepoName?'Updated':'Added');
}
function deleteRepo(name){
  if(!confirm('Delete repo "'+name+'"?'))return;
  S.repos=(S.repos||[]).filter(r=>r.name!==name);
  save();reposRefresh();toast('Deleted');
}
async function reposHealthCheck(){
  const repos=(S.repos||[]).filter(r=>r.live);
  if(!repos.length){toast('No live URLs to check');return;}
  toast('Checking '+repos.length+' live URLs...');
  const results=await Promise.allSettled(repos.map(r=>fetch(r.live,{mode:'no-cors',cache:'no-cache'}).then(()=>({name:r.name,ok:true})).catch(()=>({name:r.name,ok:false}))));
  const summary=results.map(r=>r.value||r.reason);
  const up=summary.filter(s=>s&&s.ok).length;
  toast(up+'/'+repos.length+' repos responding');
  summary.forEach(s=>{if(s){const repo=(S.repos||[]).find(r=>r.name===s.name);if(repo){repo.lastCheck=new Date().toISOString();repo.lastCheckOk=s.ok;}}});
  save();reposRefresh();
}

// === FOCUS TIMER ===
let focusTimerInterval=null;let focusTimerEnd=0;let focusTimerTaskId=null;let focusTimerStartedAt=null;let focusTimerMinutes=0;
function startFocusTimer(taskId,minutes){
  minutes=minutes||25;
  if(focusTimerInterval){clearInterval(focusTimerInterval);const fp=document.getElementById('focus-timer-float');if(fp)fp.remove();}
  focusTimerTaskId=taskId||null;focusTimerEnd=Date.now()+minutes*60*1000;focusTimerStartedAt=new Date().toISOString();focusTimerMinutes=minutes;
  const t=taskId?S.tasks.find(x=>x.id===taskId):null;
  const panel=document.createElement('div');panel.id='focus-timer-float';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;background:var(--bg-surface);border:1px solid var(--accent);border-radius:12px;padding:12px 16px;z-index:9999;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,0.4)';
  panel.innerHTML='<div style="font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">Focus Mode</div>'+(t?'<div style="font-size:10px;color:var(--text);margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px">'+esc(t.title)+'</div>':'')+'<div id="focus-timer-display" style="font-size:24px;color:var(--accent);font-family:var(--mono);text-align:center">'+minutes+':00</div><div style="display:flex;gap:6px;margin-top:8px;justify-content:center"><button onclick="stopFocusTimer()" style="font-size:9px;padding:3px 10px;background:var(--red);color:#fff;border:none;border-radius:4px;cursor:pointer">Stop</button><button onclick="extendFocusTimer(5)" style="font-size:9px;padding:3px 10px;background:var(--bg-elevated);color:var(--text);border:1px solid var(--border);border-radius:4px;cursor:pointer">+5m</button></div>';
  document.body.appendChild(panel);
  focusTimerInterval=setInterval(()=>{
    const rem=Math.max(0,focusTimerEnd-Date.now());
    const m=Math.floor(rem/60000);const s=Math.floor((rem%60000)/1000);
    const disp=document.getElementById('focus-timer-display');
    if(disp)disp.textContent=m+':'+String(s).padStart(2,'0');
    if(rem<=0){stopFocusTimer();toast('Focus session complete!');if(focusTimerTaskId){const tk=S.tasks.find(x=>x.id===focusTimerTaskId);if(tk){tk.timeSpent=(tk.timeSpent||0)+minutes;save();renderTasks();}}}
  },1000);
  toast('Focus timer: '+minutes+'min'+(t?' on '+t.title.substring(0,30):''));
}
function stopFocusTimer(){
  if(focusTimerInterval){clearInterval(focusTimerInterval);focusTimerInterval=null;}
  const fp=document.getElementById('focus-timer-float');if(fp)fp.remove();
  const elapsed=focusTimerStartedAt?Math.max(1,Math.round((Date.now()-new Date(focusTimerStartedAt).getTime())/60000)):0;
  if(focusTimerTaskId){const t=S.tasks.find(x=>x.id===focusTimerTaskId);if(t){t.timeSpent=(t.timeSpent||0)+elapsed;save();renderTasks();}}
  if(elapsed>0&&focusTimerStartedAt){if(!S.focusSessions)S.focusSessions=[];const t=focusTimerTaskId?S.tasks.find(x=>x.id===focusTimerTaskId):null;S.focusSessions.unshift({date:new Date().toISOString().split('T')[0],minutes:elapsed,task:t?t.title:'',startedAt:new Date(focusTimerStartedAt).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}),planned:focusTimerMinutes});if(S.focusSessions.length>200)S.focusSessions.length=200;save();}
  const fTaskName=focusTimerTaskId?(S.tasks.find(x=>x.id===focusTimerTaskId)||{}).title:'';
  notifyFocusComplete(fTaskName);
  focusTimerTaskId=null;focusTimerStartedAt=null;focusTimerMinutes=0;
}
function extendFocusTimer(mins){focusTimerEnd+=mins*60*1000;toast('+'+mins+' minutes added');}

// === FLOATING QUICK NOTE ===
function toggleQuickNote(){
  let panel=document.getElementById('quick-note-panel');
  if(panel){panel.style.display=panel.style.display==='none'?'flex':'none';if(panel.style.display==='flex')panel.querySelector('textarea').focus();return;}
  panel=document.createElement('div');panel.id='quick-note-panel';
  panel.style.cssText='position:fixed;bottom:72px;left:20px;z-index:950;width:280px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 8px 32px rgba(0,0,0,0.6)';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em">Quick Note</span><button onclick="document.getElementById('quick-note-panel').style.display='none'" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:0">&times;</button></div><textarea id="qn-text" placeholder="Type a quick note..." style="background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;padding:8px;resize:vertical;min-height:60px;max-height:200px;font-family:inherit"></textarea><div style="display:flex;gap:4px"><button onclick="saveQuickNote('content')" class="btn btn-sm btn-primary" style="flex:1;font-size:9px">Save as Content</button><button onclick="saveQuickNote('task')" class="btn btn-sm" style="flex:1;font-size:9px">Save as Task</button></div>`;
  document.body.appendChild(panel);panel.querySelector('textarea').focus();
}
function saveQuickNote(type){
  const text=document.getElementById('qn-text')?.value?.trim();if(!text){toast('Type something first');return;}
  if(type==='content'){S.content.unshift({id:Date.now(),body:text,type:'note',theme:'quick-note',tags:['quick-note'],created:new Date().toISOString()});save();if(currentSection==='content')renderContent();toast('Saved as content');}
  else if(type==='task'){S.tasks.unshift({id:Date.now(),title:text,description:'',subtasks:[],status:'todo',priority:'p2',project:taskProjectFilter||'',due:'',created:new Date().toISOString()});save();if(currentSection==='tasks')renderTasks();toast('Saved as task');}
  document.getElementById('qn-text').value='';
}

// === CONTENT WORD CLOUD ===
function contentWordCloud(){
  const allText=S.content.map(c=>c.body||'').join(' ');
  if(allText.trim().length<50){toast('Not enough content for word cloud');return;}
  const stop=new Set(['the','be','to','of','and','a','in','that','have','i','it','for','not','on','with','he','as','you','do','at','this','but','his','by','from','they','we','her','she','or','an','will','my','one','all','would','there','their','what','so','up','out','if','about','who','get','which','go','me','when','make','can','like','time','no','just','him','know','take','people','into','year','your','good','some','could','them','see','other','than','then','now','look','only','come','its','over','think','also','back','after','use','two','how','our','work','first','well','way','even','new','want','because','any','these','give','day','most','us','is','are','was','were','been','being','has','had','does','did','may','might','shall','should','must','need','am','very','much','more','own','each','every','while','still','through','where','too','around','find','here','thing','many','well','also','between','before','after','during','without','again','same','another','such','already','since','something','anything','everything','nothing','always','never','often','really']);
  const words=allText.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stop.has(w));
  const freq={};words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,40);
  if(!sorted.length){toast('No words found');return;}
  const maxF=sorted[0][1];const minF=sorted[sorted.length-1][1];
  const panel=document.createElement('div');panel.id='content-wordcloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;padding:24px;z-index:9999;max-width:520px;max-height:70vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.6)';
  const colors=['#4ade80','#22d3ee','#a855f7','#f472b6','#fbbf24','#60a5fa','#34d399','#fb923c'];
  let cloud='<div style="display:flex;flex-wrap:wrap;gap:6px 10px;align-items:baseline;justify-content:center;padding:12px">';
  sorted.forEach(([w,c],i)=>{
    const size=Math.round(10+((c-minF)/(maxF-minF||1))*22);
    const color=colors[i%colors.length];
    cloud+=`<span style="font-size:${size}px;color:${color};opacity:${0.6+(c/maxF)*0.4};cursor:default" title="${w}: ${c} occurrences">${esc(w)}</span>`;
  });
  cloud+='</div>';
  panel.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="color:var(--accent);font-weight:600">Content Word Cloud</span><button onclick="this.closest(\'#content-wordcloud-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div><div style="font-size:9px;color:var(--text-muted);margin-bottom:12px">'+sorted.length+' unique words from '+S.content.length+' items</div>'+cloud;
  document.body.appendChild(panel);
}

if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{});}
</script>
</body>
</html>
