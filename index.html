<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#050508">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SATURNO HUB">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>SATURNO HUB</title>
<style>
:root {
  --bg-void: #050508;
  --bg-deep: #0a0a0e;
  --bg-surface: #101014;
  --bg-elevated: #161619;
  --bg-hover: #1c1c20;
  --bg-input: #121215;
  --border: rgba(255,255,255,0.04);
  --border-hover: rgba(255,255,255,0.08);
  --border-active: rgba(74,222,160,0.35);
  --accent: #4ade80;
  --accent-glow: rgba(74,222,160,0.06);
  --accent-secondary: #2dd4bf;
  --accent-cyan: #22d3ee;
  --green: #4ade80;
  --yellow: #fbbf24;
  --orange: #fb923c;
  --red: #f87171;
  --text: rgba(255,255,255,0.90);
  --text-secondary: rgba(255,255,255,0.50);
  --text-muted: rgba(255,255,255,0.22);
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  --radius: 8px;
  --radius-lg: 12px;
  --transition-fast: all 0.12s cubic-bezier(0.4,0,0.2,1);
  --transition-smooth: all 0.25s cubic-bezier(0.4,0,0.2,1);
  --sidebar-width: 220px;
  --context-width: 320px;
  --project-width: 420px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg-void);color:var(--text-secondary);height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}

.app{display:grid;grid-template-columns:var(--sidebar-width) 4px 1fr;height:100vh;transition:grid-template-columns 0.25s cubic-bezier(0.4,0,0.2,1)}
.app.project-open{grid-template-columns:var(--sidebar-width) 4px 1fr 5px var(--project-width)}
.app.project-open .project-view{display:flex}
.app.context-open{grid-template-columns:var(--sidebar-width) 4px 1fr 4px var(--context-width)}
.app.context-open .context-panel{display:flex}
.app.context-open .context-resize{display:block}
.app.mode-focus{grid-template-columns:1fr}
.app.mode-focus .sidebar{display:none}
.app.mode-focus .writer-sidebar{display:flex!important}
.app.mode-focus .sidebar-resize{display:none}
.app.mode-extended{grid-template-columns:var(--sidebar-width) 4px 1fr 4px var(--context-width)}
.app.mode-extended .context-panel{display:flex}
.app.mode-extended .context-resize{display:block}
.context-resize{display:none}
.project-resize-handle{width:5px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0;display:none}
.app.project-open .project-resize-handle{display:block}
.project-resize-handle:hover,.project-resize-handle.dragging{background:var(--accent);opacity:0.4}
.project-resize-handle::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:3px;height:32px;border-radius:2px;background:var(--text-muted);opacity:0}

/* RESIZE HANDLES */
.sidebar-resize{width:4px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0}
.sidebar-resize:hover,.sidebar-resize.dragging{background:var(--accent);opacity:0.3}
.context-resize{width:4px;cursor:col-resize;background:transparent;position:relative;z-index:30;flex-shrink:0}
.context-resize:hover,.context-resize.dragging{background:var(--accent);opacity:0.3}

/* SIDEBAR */
.sidebar{background:linear-gradient(180deg, #080810 0%, #060608 100%);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
.logo{font-size:13px;font-weight:700;color:var(--accent);letter-spacing:0.5px;animation:logoBreathe 4s ease-in-out infinite}
@keyframes logoBreathe{0%,100%{opacity:0.85}50%{opacity:1}}
.logo-sub{font-size:9px;color:var(--text-muted);margin-top:2px;letter-spacing:0.3px}
.sidebar-section{padding:12px}
.sidebar-label{font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;padding:0 8px;margin-bottom:6px}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:12px;color:var(--text-secondary)}
.sidebar-item:hover{background:var(--bg-hover);color:var(--text)}
.sidebar-item.active{background:var(--accent-glow);color:var(--accent)}
.sidebar-item-icon{width:16px;text-align:center;font-size:11px;opacity:0.4;font-family:var(--mono);display:flex;align-items:center;justify-content:center}
.sidebar-item-icon svg{opacity:0.7}
.sidebar-item.active .sidebar-item-icon svg{opacity:1}
.sidebar-item-count{margin-left:auto;font-size:10px;color:var(--text-muted);font-family:var(--mono)}
.sidebar-kbd{font-size:8px;color:var(--text-muted);font-family:var(--mono);opacity:0;padding:1px 4px;border:1px solid var(--border);border-radius:3px;margin-left:auto;transition:opacity 0.15s}
.sidebar-item:hover .sidebar-kbd{opacity:0.5}
.sidebar-divider{height:1px;background:var(--border);margin:4px 12px}
.sidebar-header{position:relative}
.sidebar-toggle-btn{padding:3px 5px!important}
.sidebar-collapse-chevron{display:flex;align-items:center;justify-content:center;padding:12px;cursor:pointer;color:var(--text-muted);transition:var(--transition-fast);border-top:1px solid var(--border);margin-top:auto;flex-shrink:0}
.sidebar-collapse-chevron:hover{color:var(--text);background:var(--bg-hover)}
.sidebar-collapse-chevron svg{opacity:0.5;transition:opacity 0.15s}
.sidebar-collapse-chevron:hover svg{opacity:1}
.project-collapse-chevron{display:flex;align-items:center;justify-content:center;padding:10px;cursor:pointer;color:var(--text-muted);transition:var(--transition-fast);border-top:1px solid var(--border);flex-shrink:0}
.project-collapse-chevron:hover{color:var(--text);background:var(--bg-hover)}
.project-collapse-chevron svg{opacity:0.5;transition:opacity 0.15s}
.project-collapse-chevron:hover svg{opacity:1}

/* COLLAPSED SIDEBAR — icon-only strip */
.app.sidebar-collapsed{grid-template-columns:52px 0px 1fr}
.app.sidebar-collapsed.project-open{grid-template-columns:52px 0px 1fr 5px var(--project-width)}
.app.sidebar-collapsed.context-open,.app.sidebar-collapsed.mode-extended{grid-template-columns:52px 0px 1fr 4px var(--context-width)}
.app.sidebar-collapsed .sidebar-resize{display:none}
.app.sidebar-collapsed .sidebar{overflow-x:hidden;overflow-y:auto}
.app.sidebar-collapsed .sidebar-header{padding:14px 0;display:flex;justify-content:center}
.app.sidebar-collapsed .logo{font-size:0;width:24px;height:24px;background:var(--accent);border-radius:50%;display:block}
.app.sidebar-collapsed .logo::after{content:'S';font-size:12px;font-weight:700;color:#09090b;display:flex;align-items:center;justify-content:center;width:100%;height:100%}
.app.sidebar-collapsed .logo-sub{display:none}
.app.sidebar-collapsed .sidebar-label{display:none}
.app.sidebar-collapsed .sidebar-item span:not(.sidebar-item-icon){display:none}
.app.sidebar-collapsed .sidebar-item-count{display:none}
.app.sidebar-collapsed .sidebar-kbd{display:none}
.app.sidebar-collapsed .sidebar-section:not(:first-of-type){display:none}
.app.sidebar-collapsed .sidebar-divider{display:none}
.app.sidebar-collapsed #sidebar-dash{display:none!important}
.app.sidebar-collapsed .sidebar-section{padding:6px 4px}
.app.sidebar-collapsed .sidebar-item{padding:10px 0;justify-content:center;gap:0;border-radius:8px;margin:2px 6px}
.app.sidebar-collapsed .sidebar-item-icon{width:auto;opacity:0.6}
.app.sidebar-collapsed .sidebar-item.active .sidebar-item-icon{opacity:1}
.app.sidebar-collapsed #sidebar-context{display:none}
.app.sidebar-collapsed #sidebar-bottom{display:none!important}
.app.sidebar-collapsed .sidebar-collapse-chevron svg{transform:rotate(180deg)}

/* MAIN */
.main{display:flex;flex-direction:column;overflow:hidden}
.header{height:48px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0;background:var(--bg-void)}
.header-title{font-size:14px;font-weight:600;color:var(--text)}
.header-actions{display:flex;gap:6px;margin-left:auto}
.content-area{flex:1;overflow-y:auto;padding:20px}

/* BUTTONS */
.btn{padding:5px 10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-surface);color:var(--text-secondary);font-family:var(--font);font-size:10px;font-weight:500;cursor:pointer;transition:all 0.15s;display:inline-flex;align-items:center;gap:4px}
.btn:hover{border-color:var(--border-active);color:var(--text)}
.btn-primary{background:var(--accent);color:#09090b;border:none;font-weight:600}
.btn-primary:hover{opacity:0.9;box-shadow:0 2px 12px rgba(74,222,160,0.25)}
.btn-sm{padding:3px 7px;font-size:9px}
.btn-ghost{background:transparent;border:none}
.btn-ghost:hover{background:var(--bg-hover)}
.btn-danger:hover{color:var(--red);border-color:rgba(239,68,68,0.4)}

/* INPUTS */
input,select,textarea{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:var(--font);padding:6px 10px;font-size:11px;transition:all 0.15s;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--border-active);box-shadow:0 0 0 2px var(--accent-glow)}
textarea{resize:vertical;line-height:1.6}

/* BADGES */
.badge{font-family:var(--mono);font-size:8px;letter-spacing:0.5px;text-transform:uppercase;padding:2px 6px;border-radius:3px;line-height:1}
.badge-blue{background:rgba(74,222,160,0.12);color:var(--accent)}
.badge-purple{background:rgba(139,92,246,0.15);color:var(--accent-secondary)}
.badge-green{background:rgba(34,197,94,0.15);color:var(--green)}
.badge-yellow{background:rgba(234,179,8,0.15);color:var(--yellow)}
.badge-orange{background:rgba(249,115,22,0.15);color:var(--orange)}
.badge-red{background:rgba(239,68,68,0.15);color:var(--red)}
.badge-muted{background:rgba(255,255,255,0.06);color:var(--text-muted)}

/* TABS */
.tab-bar{display:flex;gap:2px}
.tab-btn{padding:5px 10px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:10px;font-weight:500;cursor:pointer;border-radius:var(--radius);transition:all 0.15s}
.tab-btn:hover{color:var(--text-secondary);background:var(--bg-surface)}
.tab-btn.active{background:var(--accent-glow);color:var(--accent)}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg-elevated);border-radius:3px}

/* PANELS */
.panel{display:none;height:100%;flex-direction:column;opacity:0;transition:opacity 0.15s ease}
.panel.active{display:flex;opacity:1}

/* CONTENT VAULT */
.content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;padding-top:12px}
.content-card{background:linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;position:relative}
.content-card:hover{border-color:var(--border-hover);box-shadow:0 4px 16px rgba(0,0,0,0.35);transform:translateY(-1px)}
.content-card-body{font-size:12px;color:var(--text-secondary);line-height:1.7;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow:hidden;cursor:pointer;position:relative}
.content-card-body.expanded{max-height:none;overflow:visible}
.content-card-body:not(.expanded)::after{content:'';position:absolute;bottom:0;left:0;right:0;height:30px;background:linear-gradient(transparent,var(--bg-surface))}
.content-card-footer{display:flex;align-items:center;gap:6px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border)}
.content-card-actions{display:flex;gap:4px;margin-left:auto;opacity:0;transition:opacity 0.15s}
.content-card:hover .content-card-actions{opacity:1}

/* TASK MANAGER */
.task-toolbar{display:flex;align-items:center;gap:8px;padding-bottom:12px;border-bottom:1px solid var(--border);margin-bottom:0;flex-wrap:wrap}
.task-toolbar-search{flex:1;max-width:260px;margin-left:auto}
.task-table-header{display:grid;grid-template-columns:36px 1fr 110px 110px 110px 100px 50px;padding:6px 0;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-void);z-index:5}
.task-table-header-cell{font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;padding:0 4px}
.task-row{display:grid;grid-template-columns:36px 1fr 110px 110px 110px 100px 50px;align-items:center;min-height:40px;border-bottom:1px solid var(--border);transition:background 0.1s;border-left:3px solid transparent}
.task-row.priority-p0{border-left-color:#ef4444}
.task-row.priority-p1{border-left-color:#f59e0b}
.task-row.priority-p2{border-left-color:#3b82f6}
.task-row.priority-p3{border-left-color:var(--border)}
.task-row:nth-child(even of .task-row){background:rgba(255,255,255,0.008)}
.task-row:hover{background:var(--bg-hover)}
.task-row.overdue{background:rgba(239,68,68,0.04)}
.task-row.blocked-row{background:rgba(251,191,36,0.04);border-left-color:#fbbf24}
.task-row.in-progress-row{border-left-color:var(--accent);background:rgba(74,222,128,0.02)}
.task-row.dragging-over{border-top:2px solid var(--accent)}
.task-checkbox{width:15px;height:15px;border:2px solid var(--border-hover);border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;margin:0 auto}
.task-checkbox:hover{border-color:var(--accent)}
.task-checkbox.checked{background:var(--green);border-color:var(--green)}
.task-checkbox.checked::after{content:'';width:4px;height:7px;border:solid #fff;border-width:0 1.5px 1.5px 0;transform:rotate(45deg);margin-bottom:1px}
.task-title-input{background:transparent;border:none;color:var(--text);font-size:12px;padding:4px 0;width:100%}
.task-title-input:focus{outline:none}
.task-title-input::placeholder{color:var(--text-muted)}
.task-row.completed .task-title-input{text-decoration:line-through;opacity:0.4}
.task-select{background:transparent;border:1px solid transparent;color:var(--text-secondary);font-size:10px;padding:4px 6px;cursor:pointer}
.task-select:hover{background:var(--bg-input);border-color:var(--border)}
.task-actions{display:flex;gap:2px;opacity:0}
.task-row:hover .task-actions{opacity:1}
.task-action-btn{width:22px;height:22px;border-radius:3px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center}
.task-action-btn:hover{background:var(--bg-input);color:var(--text)}
.task-action-btn.del:hover{color:var(--red)}
.add-task-row{display:flex;align-items:center;gap:8px;padding:10px 0 10px 36px;color:var(--text-muted);cursor:pointer;font-size:12px}
.add-task-row:hover{color:var(--text-secondary)}

/* Board */
.board-view{display:none;gap:12px;overflow-x:auto;flex:1}
.board-view.active{display:flex}
.board-col{min-width:250px;flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);display:flex;flex-direction:column;max-height:100%}
.board-col-header{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}
.board-col-title{font-size:11px;font-weight:600;color:var(--text-secondary)}
.board-col-count{font-size:10px;color:var(--text-muted);font-family:var(--mono);margin-left:auto}
.board-col-tasks{padding:6px;flex:1;overflow-y:auto;transition:background 0.15s}
.board-col-tasks.drag-over{background:rgba(74,222,128,0.05);outline:1px dashed var(--accent);outline-offset:-2px}
.board-card{background:linear-gradient(135deg, var(--bg-elevated) 0%, #1e1e22 100%);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:6px;cursor:grab;transition:all 0.15s}
.board-card:hover{border-color:var(--border-hover);box-shadow:0 4px 12px rgba(0,0,0,0.35);transform:translateY(-1px)}
.board-card-title{font-size:12px;color:var(--text);margin-bottom:4px}
.board-card-desc{font-size:10px;color:var(--text-muted);margin-bottom:6px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.board-card-subtasks{font-size:9px;color:var(--text-muted);margin-bottom:4px;font-family:var(--mono)}
.board-card-subtasks .done{color:var(--accent)}
.board-card-meta{display:flex;gap:4px;flex-wrap:wrap;align-items:center}
.task-detail-modal{position:fixed;inset:0;z-index:1500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.task-detail-modal.open{display:flex}
.task-detail-inner{background:var(--bg-deep);border:1px solid var(--border);border-radius:var(--radius-lg);width:540px;max-width:95vw;max-height:85vh;overflow-y:auto;padding:24px}
.task-detail-inner h3{font-size:16px;font-weight:600;color:var(--text);margin-bottom:16px}
.td-field{margin-bottom:14px}
.td-field label{display:block;font-size:10px;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
.td-field input,.td-field textarea,.td-field select{width:100%;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);padding:8px 10px;font-size:13px;font-family:var(--font)}
.td-field textarea{min-height:80px;resize:vertical;line-height:1.6}
.td-field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.td-subtasks{margin-top:8px}
.td-subtask{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px}
.td-subtask input[type=checkbox]{accent-color:var(--accent)}
.td-subtask input[type=text]{flex:1;background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text);padding:2px 0;font-size:12px;outline:none}
.td-subtask input[type=text]:focus{border-color:var(--accent)}
.td-subtask .del{opacity:0;cursor:pointer;color:var(--red);font-size:10px;transition:opacity 0.1s}
.td-subtask:hover .del{opacity:1}
.td-add-subtask{font-size:11px;color:var(--text-muted);cursor:pointer;padding:4px 0;margin-top:4px}
.td-add-subtask:hover{color:var(--accent)}
.td-footer{display:flex;gap:8px;margin-top:20px;justify-content:space-between}
.td-created{font-size:9px;color:var(--text-muted);margin-top:12px}

/* Calendar */
.calendar-shell{display:flex;flex-direction:column;height:100%}
.calendar-nav{display:flex;align-items:center;gap:12px;padding-bottom:12px;flex-shrink:0}
.calendar-month-label{font-size:15px;font-weight:600;color:var(--text)}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border-radius:var(--radius-lg);overflow:hidden;flex:1}
.calendar-day-header{padding:8px;background:var(--bg-surface);font-family:var(--mono);font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;text-align:center}
.calendar-day{background:var(--bg-void);padding:6px;min-height:80px;cursor:pointer;transition:background 0.1s;overflow-y:auto}
.calendar-day:hover{background:var(--bg-deep)}
.calendar-day.other{opacity:0.25}
.calendar-day.today{background:rgba(74,222,160,0.06)}
.calendar-day.cal-overdue{background:rgba(239,68,68,0.04);border-left:2px solid var(--red)}
.calendar-day.cal-drag-over{background:rgba(74,222,128,0.08);outline:1px dashed var(--accent);outline-offset:-2px}
.week-day.cal-drag-over{background:rgba(74,222,128,0.08);outline:1px dashed var(--accent);outline-offset:-2px}
.calendar-day-num{font-size:11px;font-weight:500;color:var(--text-secondary);margin-bottom:4px}
.calendar-day.today .calendar-day-num{width:22px;height:22px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px}
.calendar-task-pill{font-size:9px;padding:2px 5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text-secondary);cursor:grab;border-left:2px solid var(--border)}
.calendar-task-pill.pill-p0{border-left-color:#ef4444}
.calendar-task-pill.pill-p1{border-left-color:#f59e0b}
.calendar-task-pill.pill-p2{border-left-color:#3b82f6}
.calendar-task-pill:hover{border-color:var(--accent)}
.calendar-task-pill.dragging{opacity:0.4}
.cal-view-toggle{display:flex;gap:2px;background:var(--bg-surface);border-radius:var(--radius);padding:2px}
.cal-view-btn{padding:4px 10px;border:none;background:transparent;color:var(--text-muted);font-size:10px;border-radius:4px;cursor:pointer;font-family:var(--font)}
.cal-view-btn.active{background:var(--bg-elevated);color:var(--text)}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border-radius:var(--radius-lg);overflow:hidden;flex:1}
.week-day{background:var(--bg-void);padding:8px;min-height:120px;display:flex;flex-direction:column;gap:4px;overflow-y:auto}
.week-day.today{background:rgba(74,222,160,0.06)}
.week-day-header{font-size:10px;color:var(--text-muted);font-weight:600;text-align:center;padding:4px;margin-bottom:4px;font-family:var(--mono)}
.week-day-header .day-num{font-size:13px;color:var(--text-secondary);display:block;margin-top:2px}
.week-day.today .week-day-header .day-num{background:var(--accent);color:#fff;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center}
.week-task-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px 8px;cursor:grab;transition:all 0.1s;font-size:10px}
.week-task-card:hover{border-color:var(--accent)}
.week-task-card .wt-title{color:var(--text);font-size:11px;margin-bottom:2px}
.week-task-card .wt-meta{display:flex;gap:4px;align-items:center}
.week-add{font-size:9px;color:var(--text-muted);cursor:pointer;padding:4px 0;text-align:center}
.week-add:hover{color:var(--accent)}

/* Links */
.links-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;padding-top:12px}
.link-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;cursor:pointer;display:flex;flex-direction:column;gap:6px}
.link-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 16px rgba(74,222,160,0.08)}
.link-card-title{font-size:12px;font-weight:600;color:var(--text)}
.link-card-url{font-family:var(--mono);font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.link-card-desc{font-size:10px;color:var(--text-secondary);line-height:1.5}
.link-card-footer{display:flex;gap:4px;align-items:center;margin-top:auto}
.link-card-actions{margin-left:auto;display:flex;gap:2px;opacity:0}
.link-card:hover .link-card-actions{opacity:1}

/* WRITING HUB */
.writer-shell{display:flex;height:100%;overflow:hidden}
.writer-sidebar{width:200px;min-width:160px;max-width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0;overflow:hidden}
.writer-doc-list{flex:1;overflow-y:auto;padding:6px}
.writer-doc-item{padding:8px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:2px}
.writer-doc-item:hover{background:var(--bg-hover)}
.writer-doc-item.active{background:var(--accent-glow)}
.writer-doc-title{font-size:11px;color:var(--text);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.writer-doc-meta{font-size:9px;color:var(--text-muted);margin-top:2px;display:flex;gap:8px}
.writer-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.writer-toolbar{display:flex;align-items:center;gap:2px;padding:6px 8px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:none}.writer-toolbar::-webkit-scrollbar{display:none}
.writer-toolbar-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:12px;display:flex;align-items:center;justify-content:center;transition:all 0.1s;font-weight:600}
.writer-toolbar-btn:hover{background:var(--bg-hover);color:var(--text)}
.writer-toolbar-btn.active{background:var(--accent-glow);color:var(--accent)}
.writer-toolbar-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.writer-toolbar-select{background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);font-size:10px;padding:4px 6px;border-radius:var(--radius);width:auto;cursor:pointer}
.writer-title-input{background:transparent;border:none;color:var(--text);font-size:22px;font-weight:700;padding:20px 28px 8px;width:100%;letter-spacing:-0.3px}
.writer-title-input:focus{outline:none}
.writer-title-input::placeholder{color:var(--text-muted)}
.writer-editor{flex:1;overflow-y:auto;padding:0 28px 40px;font-size:15px;line-height:1.85;color:var(--text-secondary);outline:none;min-height:200px}
.writer-editor:empty::before{content:attr(data-placeholder);color:var(--text-muted)}
.writer-editor h1{font-size:24px;font-weight:700;color:var(--text);margin:24px 0 8px;line-height:1.3}
.writer-editor h2{font-size:18px;font-weight:600;color:var(--text);margin:20px 0 6px}
.writer-editor h3{font-size:15px;font-weight:600;color:var(--text);margin:16px 0 4px}
.writer-editor p{margin-bottom:12px}
.writer-editor blockquote{border-left:3px solid var(--accent);padding-left:16px;margin:12px 0;color:var(--text-muted);font-style:italic}
.writer-editor ul,.writer-editor ol{margin:8px 0;padding-left:24px}
.writer-editor li{margin-bottom:4px}
.writer-editor code{background:var(--bg-surface);padding:1px 4px;border-radius:3px;font-family:var(--mono);font-size:13px;color:var(--accent)}
.writer-editor pre{background:var(--bg-surface);padding:12px;border-radius:var(--radius);font-family:var(--mono);font-size:12px;overflow-x:auto;margin:12px 0;border:1px solid var(--border)}
.writer-editor hr{border:none;border-top:1px solid var(--border);margin:20px 0}
.writer-statusbar{display:flex;align-items:center;gap:16px;padding:4px 12px;border-top:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--text-muted);flex-shrink:0}
.writer-right-panel{width:240px;border-left:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0;overflow-y:auto;padding:12px}
.writer-right-panel.hidden{display:none}

/* ZEN WRITER — Full-screen distraction-free writing overlay */
.zen-writer{position:fixed;inset:0;z-index:2000;background:var(--bg-void);display:none;flex-direction:column;opacity:0;transition:opacity 0.3s cubic-bezier(0.4,0,0.2,1)}
.zen-writer.open{display:flex;opacity:1}
.zen-writer-topbar{display:flex;align-items:center;gap:8px;padding:8px 20px;border-bottom:1px solid var(--border);flex-shrink:0;background:linear-gradient(180deg, rgba(10,10,14,0.95) 0%, rgba(5,5,8,0.95) 100%);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.zen-doc-picker{background:var(--bg-input);border:1px solid var(--border);color:var(--text);font-size:11px;padding:5px 10px;border-radius:var(--radius);cursor:pointer;max-width:220px}
.zen-doc-picker:focus{outline:none;border-color:var(--accent)}
.zen-toolbar{display:flex;align-items:center;gap:1px;flex:1;justify-content:center;flex-wrap:wrap}
.zen-tb{width:30px;height:30px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:6px;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all 0.12s;font-weight:600}
.zen-tb:hover{background:var(--bg-hover);color:var(--text)}
.zen-tb.active{background:var(--accent-glow);color:var(--accent)}
.zen-tb-sep{width:1px;height:20px;background:var(--border);margin:0 6px}
.zen-tb-select{background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);font-size:11px;padding:4px 8px;border-radius:var(--radius);cursor:pointer}
.zen-tb-select:focus{outline:none;border-color:var(--accent)}
.zen-close-btn{width:30px;height:30px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:6px;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.12s;margin-left:8px}
.zen-close-btn:hover{background:rgba(248,113,113,0.15);color:var(--red)}
.zen-body{flex:1;display:flex;flex-direction:column;overflow:hidden;max-width:780px;width:100%;margin:0 auto;padding:0 24px}
.zen-title{background:transparent;border:none;color:var(--text);font-size:28px;font-weight:700;padding:32px 0 12px;width:100%;letter-spacing:-0.5px;line-height:1.2}
.zen-title:focus{outline:none}
.zen-title::placeholder{color:var(--text-muted)}
.zen-editor{flex:1;overflow-y:auto;padding:0 0 80px;font-size:17px;line-height:2;color:rgba(255,255,255,0.78);outline:none;caret-color:var(--accent);letter-spacing:0.01em}
.zen-editor:empty::before{content:attr(data-placeholder);color:var(--text-muted);font-style:italic}
.zen-editor h1{font-size:28px;font-weight:700;color:var(--text);margin:28px 0 10px;line-height:1.3;letter-spacing:-0.3px}
.zen-editor h2{font-size:22px;font-weight:600;color:var(--text);margin:24px 0 8px;letter-spacing:-0.2px}
.zen-editor h3{font-size:17px;font-weight:600;color:var(--text);margin:20px 0 6px}
.zen-editor p{margin-bottom:16px}
.zen-editor blockquote{border-left:3px solid var(--accent);padding:4px 0 4px 20px;margin:16px 0;color:rgba(255,255,255,0.45);font-style:italic}
.zen-editor ul,.zen-editor ol{margin:10px 0;padding-left:28px}
.zen-editor li{margin-bottom:6px}
.zen-editor code{background:rgba(74,222,160,0.08);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:15px;color:var(--accent)}
.zen-editor pre{background:var(--bg-surface);padding:16px;border-radius:var(--radius);font-family:var(--mono);font-size:13px;overflow-x:auto;margin:16px 0;border:1px solid var(--border);line-height:1.6}
.zen-editor hr{border:none;border-top:1px solid var(--border);margin:28px 0}
.zen-editor a{color:var(--accent-cyan);text-decoration:underline;text-underline-offset:2px}
.zen-editor ::selection{background:rgba(74,222,160,0.2)}
.zen-statusbar{display:flex;align-items:center;gap:20px;padding:8px 24px;border-top:1px solid var(--border);font-family:var(--mono);font-size:10px;color:var(--text-muted);flex-shrink:0;max-width:780px;width:100%;margin:0 auto}
.zen-statusbar span{transition:color 0.2s}
.zen-fab{position:fixed;bottom:20px;right:20px;z-index:900;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,rgba(74,222,160,0.15) 0%,rgba(34,211,238,0.1) 100%);border:1px solid rgba(74,222,160,0.25);color:var(--accent);cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,0.4);transition:all 0.2s;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.zen-fab:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(74,222,160,0.2);border-color:var(--accent)}
.zen-fab svg{opacity:0.8}
.zen-fab:hover svg{opacity:1}
.writer-version-item{padding:8px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:4px;border:1px solid var(--border)}
.writer-version-item:hover{background:var(--bg-hover);border-color:var(--border-hover)}
.writer-version-title{font-size:10px;color:var(--text);font-weight:500}
.writer-version-meta{font-size:9px;color:var(--text-muted);margin-top:2px}

/* LIVING DOCS */
.specs-shell{display:flex;height:100%;overflow:hidden}
.specs-sidebar{width:220px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:linear-gradient(180deg, #080810 0%, #060608 100%);flex-shrink:0}
.specs-doc-list{flex:1;overflow-y:auto;padding:6px}
.specs-doc-item{padding:10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;margin-bottom:2px;border-left:3px solid transparent}
.specs-doc-item:hover{background:var(--bg-hover)}
.specs-doc-item.active{background:var(--accent-glow);border-left-color:var(--accent)}
.specs-doc-title{font-size:11px;color:var(--text);font-weight:600}
.specs-doc-meta{font-size:9px;color:var(--text-muted);margin-top:3px;display:flex;gap:8px}
.specs-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.specs-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.specs-title-input{background:transparent;border:none;color:var(--text);font-size:18px;font-weight:700;flex:1}
.specs-title-input:focus{outline:none}
.specs-title-input::placeholder{color:var(--text-muted)}
.specs-sections{flex:1;overflow-y:auto;padding:20px 24px}
.specs-section{margin-bottom:20px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.specs-section-header{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;transition:background 0.15s}
.specs-section-header:hover{background:var(--bg-hover)}
.specs-section-title{font-size:12px;font-weight:600;color:var(--text);flex:1}
.specs-section-toggle{font-size:10px;color:var(--text-muted);transition:transform 0.2s}
.specs-section.collapsed .specs-section-toggle{transform:rotate(-90deg)}
.specs-section.collapsed .specs-section-body{display:none}
.specs-section-body{padding:12px 14px;border-top:1px solid var(--border)}
.specs-section-editor{min-height:80px;font-size:13px;line-height:1.7;color:var(--text-secondary);outline:none}
.specs-section-editor:empty::before{content:'Click to add content...';color:var(--text-muted)}
.specs-add-section{padding:10px;text-align:center;color:var(--text-muted);font-size:11px;cursor:pointer;border:1px dashed var(--border);border-radius:var(--radius);transition:all 0.15s}
.specs-add-section:hover{border-color:var(--accent);color:var(--text-secondary)}
.specs-statusbar{display:flex;align-items:center;gap:16px;padding:6px 14px;border-top:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--text-muted);flex-shrink:0}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:linear-gradient(160deg, rgba(21,21,24,0.95) 0%, rgba(19,19,22,0.95) 100%);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.06);border-radius:var(--radius-lg);padding:20px;width:400px;max-width:90vw;max-height:80vh;overflow-y:auto;box-shadow:0 24px 48px rgba(0,0,0,0.6),0 0 0 1px rgba(255,255,255,0.03)}
.modal-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:14px}
.form-group{margin-bottom:12px}
.form-label{font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;display:block}

/* WHITEBOARD */
.wb-shell{display:flex;height:100%;overflow:hidden;position:relative}
.wb-toolbar{position:absolute;top:10px;left:10px;z-index:20;display:flex;gap:3px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
.wb-tool{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:4px;font-size:11px;display:flex;align-items:center;justify-content:center;transition:all 0.1s;font-weight:600}
.wb-tool:hover{background:var(--bg-hover);color:var(--text)}
.wb-tool.active{background:var(--accent-glow);color:var(--accent)}
.wb-tool-sep{width:1px;background:var(--border);margin:2px 1px}
.wb-top-bar{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:20;display:flex;gap:6px;align-items:center}
.wb-zoom{display:flex;align-items:center;gap:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:3px 6px;font-family:var(--mono);font-size:9px;color:var(--text-muted)}
.wb-actions{position:absolute;top:10px;right:10px;z-index:20;display:flex;gap:4px}
.wb-canvas-wrap{width:100%;height:100%;overflow:hidden;cursor:crosshair;position:relative;background:var(--bg-void)}
.wb-canvas{position:absolute;transform-origin:0 0}
.wb-grid{position:absolute;inset:0;pointer-events:none;opacity:0.08}
.wb-svg{position:absolute;inset:0;pointer-events:none;z-index:1}
.wb-node{position:absolute;min-width:120px;min-height:50px;background:var(--bg-surface);border:1.5px solid var(--border);border-radius:var(--radius-lg);cursor:grab;z-index:10;transition:box-shadow 0.15s;display:flex;flex-direction:column}
.wb-node:hover{box-shadow:0 4px 16px rgba(0,0,0,0.4);border-color:var(--border-hover)}
.wb-node.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
.wb-node.dragging{opacity:0.8;cursor:grabbing;z-index:50}
.wb-node-header{padding:6px 10px;font-size:11px;font-weight:600;color:var(--text);border-bottom:1px solid var(--border);outline:none;min-height:28px;display:flex;align-items:center}
.wb-node-body{padding:6px 10px;font-size:10px;color:var(--text-secondary);outline:none;flex:1;min-height:22px;line-height:1.5}
.wb-node-color{position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--radius-lg) var(--radius-lg) 0 0}
.wb-node-del{position:absolute;top:-8px;right:-8px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:20}
.wb-node:hover .wb-node-del{display:flex}
.wb-node:hover .wb-node-dup{display:flex}
.wb-node:hover .wb-node-color-btn{opacity:0.7}
.wb-node:hover .wb-lock-btn{opacity:0.6!important}
.wb-node-resize{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:nwse-resize;z-index:15}
.wb-node-port{position:absolute;width:10px;height:10px;border-radius:50%;background:var(--accent);border:2px solid var(--bg-surface);cursor:crosshair;z-index:15;opacity:0;transition:opacity 0.15s}
.wb-node:hover .wb-node-port{opacity:1}
.wb-port-right{right:-5px;top:50%;transform:translateY(-50%)}
.wb-port-bottom{bottom:-5px;left:50%;transform:translateX(-50%)}
.wb-port-left{left:-5px;top:50%;transform:translateY(-50%)}
.wb-port-top{top:-5px;left:50%;transform:translateX(-50%)}
.wb-minimap{position:absolute;bottom:10px;right:10px;width:160px;height:100px;background:linear-gradient(135deg, #0e0e12 0%, #0c0c0f 100%);border:1px solid var(--border);border-radius:var(--radius);z-index:20;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
.wb-minimap-viewport{position:absolute;border:1.5px solid var(--accent);background:rgba(74,222,160,0.06);pointer-events:none}
.wb-minimap-node{position:absolute;background:var(--accent);border-radius:1px;opacity:0.5}
.wb-tpl-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;display:none;align-items:center;justify-content:center}
.wb-tpl-modal.open{display:flex}
.wb-tpl-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-height:60vh;overflow-y:auto;padding:4px}
.wb-tpl-card{background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;cursor:pointer;transition:all 0.15s;text-align:center}
.wb-tpl-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 16px rgba(74,222,160,0.12)}
.wb-tpl-icon{font-size:24px;margin-bottom:6px}
.wb-tpl-name{font-size:11px;font-weight:600;color:var(--text)}
.wb-tpl-desc{font-size:9px;color:var(--text-muted);margin-top:3px}

/* PROJECTS SIDEBAR */
.sidebar-projects{padding:6px 12px}
.sidebar-project-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:12px;color:var(--text-secondary);position:relative}
.sidebar-project-item:hover{background:var(--bg-hover);color:var(--text)}
.sidebar-project-item.active{background:var(--accent-glow);color:var(--accent)}
.sidebar-project-item .proj-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sidebar-project-item .proj-icon svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.sidebar-project-item .proj-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sidebar-project-item .proj-status{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.sidebar-project-item .proj-status.active-s{background:var(--green)}
.sidebar-project-item .proj-status.paused-s{background:var(--yellow)}
.sidebar-project-item .proj-status.complete-s{background:var(--accent)}
.sidebar-add-project{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-size:11px;color:var(--text-muted)}
.sidebar-add-project:hover{color:var(--text-secondary);background:var(--bg-hover)}

/* PROJECT DETAIL VIEW — right panel */
.project-view{display:none;flex-direction:column;height:100vh;overflow:hidden;background:linear-gradient(180deg, #080810 0%, #060608 100%);border-left:1px solid var(--border)}
.project-header{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0}
.project-header .proj-icon-lg{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);border:1px solid var(--border)}
.project-header .proj-icon-lg svg{width:18px;height:18px;stroke:var(--accent);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.project-header-name{font-size:18px;font-weight:700;color:var(--text);flex:1}
.project-header-actions{display:flex;gap:4px;position:relative}
.export-menu{position:absolute;top:100%;right:0;margin-top:6px;background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:var(--radius-lg);padding:6px;min-width:180px;z-index:999;box-shadow:0 8px 32px rgba(0,0,0,0.5);backdrop-filter:blur(20px);animation:fadeIn 0.12s ease}
.export-menu-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:var(--radius);cursor:pointer;font-size:11px;color:var(--text-secondary);transition:all 0.12s}
.export-menu-item:hover{background:var(--bg-hover);color:var(--text)}
.export-menu-item .export-icon{width:16px;text-align:center;font-family:var(--mono);font-size:9px;color:var(--accent)}
.export-menu-label{font-weight:500}
.export-menu-desc{font-size:9px;color:var(--text-muted)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.project-tabs{display:flex;gap:2px;padding:0 24px;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.project-tabs::-webkit-scrollbar{display:none}
.project-tab{white-space:nowrap;flex-shrink:0}
.project-tab{padding:8px 14px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:11px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s}
.project-tab:hover{color:var(--text-secondary)}
.project-tab.active{color:var(--proj-accent, var(--accent));border-bottom-color:var(--proj-accent, var(--accent))}
.project-content{flex:1;overflow-y:auto;padding:20px 24px}

/* PROJECT INSTRUCTIONS */
.proj-instructions-editor{min-height:200px;font-size:14px;line-height:1.8;color:var(--text-secondary);outline:none;padding:12px 0}
.proj-instructions-editor:empty::before{content:'Describe what this project is...';color:var(--text-muted)}
.proj-instructions-editor h1{font-size:22px;font-weight:700;color:var(--text);margin:20px 0 8px}
.proj-instructions-editor h2{font-size:17px;font-weight:600;color:var(--text);margin:16px 0 6px}
.proj-instructions-editor h3{font-size:14px;font-weight:600;color:var(--text);margin:12px 0 4px}
.proj-instructions-editor p{margin-bottom:10px}
.proj-instructions-editor ul,.proj-instructions-editor ol{padding-left:24px;margin:8px 0}
.proj-instructions-editor li{margin-bottom:4px}
.proj-instructions-editor code{background:var(--bg-surface);padding:1px 4px;border-radius:3px;font-family:var(--mono);font-size:12px;color:var(--accent)}
.proj-instructions-editor pre{background:var(--bg-surface);padding:12px;border-radius:var(--radius);font-family:var(--mono);font-size:11px;overflow-x:auto;margin:12px 0;border:1px solid var(--border)}
.proj-instructions-editor blockquote{border-left:3px solid var(--accent);padding-left:16px;margin:12px 0;color:var(--text-muted);font-style:italic}
.proj-instructions-editor table{width:100%;border-collapse:collapse;margin:12px 0;font-size:12px}
.proj-instructions-editor th,.proj-instructions-editor td{border:1px solid var(--border);padding:6px 10px;text-align:left}
.proj-instructions-editor th{background:var(--bg-surface);font-weight:600;color:var(--text)}

/* KNOWLEDGE BASE */
.kb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;padding-top:12px}
.kb-card{background:linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-elevated) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:all 0.2s;cursor:pointer;position:relative}
.kb-card:hover{border-color:var(--border-hover);box-shadow:0 2px 12px rgba(0,0,0,0.3);transform:translateY(-1px)}
.kb-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.kb-card-type{font-family:var(--mono);font-size:8px;letter-spacing:0.5px;text-transform:uppercase;padding:2px 6px;border-radius:3px;line-height:1;flex-shrink:0}
.kb-type-md{background:rgba(59,130,246,0.15);color:#60a5fa}
.kb-type-pdf{background:rgba(239,68,68,0.15);color:#f87171}
.kb-type-img{background:rgba(34,197,94,0.15);color:#4ade80}
.kb-type-url{background:rgba(139,92,246,0.15);color:#a78bfa}
.kb-type-txt{background:rgba(255,255,255,0.08);color:var(--text-muted)}
.kb-type-json{background:rgba(251,191,36,0.15);color:#fbbf24}
.kb-type-other{background:rgba(255,255,255,0.06);color:var(--text-muted)}
.kb-card-name{font-size:12px;font-weight:600;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.kb-card-desc{font-size:10px;color:var(--text-secondary);line-height:1.5;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.kb-card-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:8px}
.kb-card-tag{font-family:var(--mono);font-size:7px;padding:1px 5px;background:rgba(255,255,255,0.05);border-radius:3px;color:var(--text-muted)}
.kb-card-actions{position:absolute;top:8px;right:8px;display:flex;gap:2px;opacity:0;transition:opacity 0.15s}
.kb-card:hover .kb-card-actions{opacity:1}
.kb-card-drag{cursor:grab;width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:10px}
.kb-card-img{width:100%;height:100px;object-fit:cover;border-radius:var(--radius);margin-top:8px;border:1px solid var(--border)}
.kb-empty{text-align:center;padding:40px;color:var(--text-muted);font-size:12px}

/* PROJECT LIVING DOCS LIST */
.proj-docs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;padding-top:12px}
.proj-doc-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;cursor:pointer;transition:all 0.2s}
.proj-doc-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 16px rgba(74,222,160,0.08)}
.proj-doc-card-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px}
.proj-doc-card-meta{font-size:9px;color:var(--text-muted);display:flex;gap:8px}
.proj-doc-card-preview{font-size:10px;color:var(--text-secondary);line-height:1.5;margin-top:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* ICON PICKER */
.icon-picker-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1100;display:none;align-items:center;justify-content:center}
.icon-picker-modal.open{display:flex}
.icon-picker-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:50vh;overflow-y:auto;padding:8px}
.icon-picker-item{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius);border:1px solid var(--border);cursor:pointer;transition:all 0.15s;background:var(--bg-surface)}
.icon-picker-item:hover{border-color:var(--accent);background:var(--accent-glow)}
.icon-picker-item.selected{border-color:var(--accent);background:var(--accent-glow);box-shadow:0 0 0 2px rgba(74,222,160,0.2)}
.icon-picker-item svg{width:18px;height:18px;stroke:var(--text-secondary);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.icon-picker-item:hover svg,.icon-picker-item.selected svg{stroke:var(--accent)}

.pm-color-opt{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.pm-color-opt:hover{transform:scale(1.2)}
.pm-color-opt.selected{border-color:#fff;box-shadow:0 0 8px currentColor}

/* KB MODAL */
.kb-modal-tabs{display:flex;gap:2px;margin-bottom:12px}
.kb-modal-tab{padding:5px 10px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:10px;cursor:pointer;border-radius:var(--radius);transition:all 0.15s}
.kb-modal-tab:hover{color:var(--text-secondary);background:var(--bg-surface)}
.kb-modal-tab.active{background:var(--accent-glow);color:var(--accent)}
.kb-modal-panel{display:none}
.kb-modal-panel.active{display:block}

/* VOICE INPUT */
.voice-btn{width:28px;height:28px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.voice-btn:hover{background:var(--bg-hover);color:var(--text)}
.voice-btn.recording{background:rgba(239,68,68,0.2);color:var(--red);animation:voice-pulse 1s infinite}
@keyframes voice-pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* WIKI LINKS */
.wiki-link{color:var(--accent);cursor:pointer;border-bottom:1px dashed rgba(74,222,160,0.4);padding-bottom:1px;transition:var(--transition-fast)}
.wiki-link:hover{border-bottom-color:var(--accent);background:var(--accent-glow);border-radius:2px}
.wiki-link-broken{color:var(--red);border-bottom:1px dashed rgba(248,113,113,0.4)}

/* FOLDER TREE */
.folder-tree{padding:4px 0}
.folder-item{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast);font-size:11px;color:var(--text-secondary)}
.folder-item:hover{background:var(--bg-hover);color:var(--text)}
.folder-item.active{background:var(--accent-glow);color:var(--accent)}
.folder-item-icon{font-size:10px;color:var(--text-muted);width:14px;text-align:center}
.folder-item-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.folder-item-count{font-size:9px;color:var(--text-muted);font-family:var(--mono)}

/* COMMAND PALETTE */
.cmd-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);z-index:9000;display:none;align-items:flex-start;justify-content:center;padding-top:20vh}
.cmd-overlay.open{display:flex}
.cmd-box{width:560px;max-width:90vw;background:linear-gradient(180deg, #101014 0%, #0c0c0f 100%);border:1px solid var(--border-hover);border-radius:var(--radius-lg);box-shadow:0 24px 80px rgba(0,0,0,0.7);overflow:hidden;animation:cmdSlideIn 0.15s ease}
@keyframes cmdSlideIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
.cmd-input-wrap{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);gap:10px}
.cmd-input-icon{color:var(--text-muted);font-size:14px;flex-shrink:0}
.cmd-input{flex:1;background:none;border:none;color:var(--text);font-size:15px;font-family:var(--font);outline:none}
.cmd-input::placeholder{color:var(--text-muted)}
.cmd-hint{font-size:9px;color:var(--text-muted);font-family:var(--mono);flex-shrink:0}
.cmd-results{max-height:360px;overflow-y:auto;padding:6px}
.cmd-item{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast)}
.cmd-item:hover,.cmd-item.active{background:var(--bg-hover)}
.cmd-item.active{background:var(--accent-glow);border:1px solid rgba(74,222,160,0.15)}
.cmd-item-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);font-size:12px;color:var(--text-muted);flex-shrink:0}
.cmd-item-text{flex:1;min-width:0}
.cmd-item-title{font-size:13px;color:var(--text);font-weight:500}
.cmd-item-desc{font-size:10px;color:var(--text-muted);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cmd-item-badge{font-family:var(--mono);font-size:8px;padding:2px 6px;border-radius:3px;background:rgba(255,255,255,0.05);color:var(--text-muted)}
.cmd-footer{display:flex;align-items:center;gap:12px;padding:8px 14px;border-top:1px solid var(--border);font-size:9px;color:var(--text-muted);font-family:var(--mono)}
.cmd-key{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 4px;background:var(--bg-elevated);border:1px solid var(--border-hover);border-radius:3px;font-size:9px;color:var(--text-muted)}

/* CONTEXT PANEL */
.context-panel{display:none;flex-direction:column;height:100vh;overflow:hidden;background:linear-gradient(180deg, #0a0a0e 0%, #080810 100%);border-left:1px solid var(--border)}
.context-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.context-header-title{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;flex:1}
.context-close{width:22px;height:22px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius);font-size:12px;display:flex;align-items:center;justify-content:center}
.context-close:hover{background:var(--bg-hover);color:var(--text)}
.context-body{flex:1;overflow-y:auto;padding:12px 16px}
.context-section{margin-bottom:16px}
.context-section-title{font-size:9px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.context-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:var(--radius);cursor:pointer;transition:var(--transition-fast);font-size:11px;color:var(--text-secondary)}
.context-item:hover{background:var(--bg-hover);color:var(--text)}
.context-item-icon{width:14px;text-align:center;font-size:10px;color:var(--text-muted);flex-shrink:0}

/* MODE SWITCHER */
.mode-switcher{display:flex;align-items:center;gap:2px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:2px}
.mode-btn{padding:3px 8px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font);font-size:9px;font-weight:500;cursor:pointer;border-radius:4px;transition:var(--transition-fast);text-transform:uppercase;letter-spacing:0.3px}
.mode-btn:hover{color:var(--text-secondary)}
.mode-btn.active{background:var(--accent-glow);color:var(--accent)}

/* FOCUS TIMER EMBEDDED */
.focus-timer-panel{padding:16px}
.ft-circle-wrap{position:relative;width:160px;height:160px;margin:0 auto 16px}
.ft-circle{width:100%;height:100%;transform:rotate(-90deg)}
.ft-circle .ft-track{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:6}
.ft-circle .ft-progress{fill:none;stroke:var(--accent);stroke-width:6;stroke-linecap:round;stroke-dasharray:440.9;stroke-dashoffset:440.9;transition:stroke-dashoffset 1s ease,stroke 0.3s ease;filter:drop-shadow(0 0 8px var(--accent))}
.ft-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.ft-time{font-size:28px;font-weight:700;color:var(--text);font-variant-numeric:tabular-nums;letter-spacing:-0.02em}
.ft-label{font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;margin-top:2px}
.ft-controls{display:flex;justify-content:center;gap:8px}
.ft-btn{padding:6px 16px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-secondary);font-size:11px;font-weight:500;cursor:pointer;transition:var(--transition-fast)}
.ft-btn:hover{border-color:var(--border-active);color:var(--text)}
.ft-btn.running{background:var(--accent);color:var(--bg-void);border-color:var(--accent)}
.ft-categories{display:flex;flex-wrap:wrap;gap:4px;margin-top:12px;justify-content:center}
.ft-cat{padding:3px 8px;border:1px solid var(--border);border-radius:var(--radius);font-size:9px;color:var(--text-muted);cursor:pointer;transition:var(--transition-fast)}
.ft-cat:hover{border-color:var(--border-hover);color:var(--text-secondary)}
.ft-cat.active{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}
.ft-time-adjust{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:10px}
.ft-adj-btn{width:24px;height:24px;border-radius:50%;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition-fast)}
.ft-adj-btn:hover{background:var(--accent);color:var(--bg-void);border-color:var(--accent)}

/* RESPONSIVE */
@media(max-width:900px){
  :root{--sidebar-width:180px;--context-width:260px}
  .writer-sidebar{width:160px}
  .specs-sidebar{width:180px}
  .content-grid{grid-template-columns:1fr}
  .links-grid{grid-template-columns:1fr}
}
@media(max-width:640px){
  .app{grid-template-columns:1fr!important}
  .sidebar{position:fixed;left:-220px;top:0;bottom:0;width:220px;z-index:100;transition:left 0.25s}
  .sidebar.mobile-open{left:0}
  .sidebar-resize{display:none!important}
  .context-panel{display:none!important}
  .context-resize{display:none!important}
  .writer-shell{flex-direction:column}
  .writer-sidebar{width:100%;height:auto;max-height:120px;border-right:none;border-bottom:1px solid var(--border)}
  .writer-right-panel{display:none}
  .specs-shell{flex-direction:column}
  .specs-sidebar{width:100%;height:auto;max-height:120px;border-right:none;border-bottom:1px solid var(--border)}
  .mobile-hamburger{display:block!important}
  .mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
  .mobile-overlay.open{display:block}
  .board-columns{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap}
  .board-column{min-width:240px;flex-shrink:0}
  .calendar-grid{font-size:9px}
  .calendar-day{min-height:50px;padding:2px}
  .week-grid{grid-template-columns:1fr!important;gap:4px}
  .week-day{min-height:60px}
  .task-detail-inner{width:95vw;padding:16px}
  .panel-project{position:fixed;inset:0;z-index:110;width:100%!important;max-width:100%!important}
  .header{padding:4px 8px}
  .header-left{gap:6px}
}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg, #101014 0%, #161619 100%);border:1px solid rgba(74,222,160,0.12);border-radius:var(--radius);padding:8px 14px;font-size:11px;color:var(--text);opacity:0;transform:translateY(10px);transition:all 0.3s;z-index:2000;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
.toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">SATURNO HUB</div>
      <div class="logo-sub">v2.0 — Command Center</div>
      <div id="sidebar-date" style="font-size:9px;color:var(--text-muted);font-family:var(--mono);margin-top:2px"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Sections</div>
      <div class="sidebar-item active" onclick="switchSection('content',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span><span>Content</span>
        <span class="sidebar-item-count" id="content-count">0</span><span class="sidebar-kbd">1</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('tasks',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></span><span>Tasks</span>
        <span class="sidebar-item-count" id="tasks-count">0</span><span class="sidebar-kbd">2</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('calendar',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span><span>Calendar</span><span class="sidebar-kbd">3</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('writer',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></svg></span><span>Writing Hub</span>
        <span class="sidebar-item-count" id="writer-count">0</span><span class="sidebar-kbd">4</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('specs',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></span><span>Living Docs</span>
        <span class="sidebar-item-count" id="specs-count">0</span><span class="sidebar-kbd">5</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('links',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></span><span>Links</span>
        <span class="sidebar-item-count" id="links-count">0</span><span class="sidebar-kbd">6</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('whiteboard',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></span><span>Whiteboard</span><span class="sidebar-kbd">7</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('pipeline',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg></span><span>Pipeline</span><span class="sidebar-kbd">8</span>
      </div>
      <div class="sidebar-item" onclick="switchSection('repos',this)">
        <span class="sidebar-item-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/><path d="M1 12h6m6 0h6"/></svg></span><span>Repos</span><span class="sidebar-kbd">9</span>
      </div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section">
      <div class="sidebar-label" style="display:flex;align-items:center;justify-content:space-between">
        <span>Projects</span>
        <span class="sidebar-add-project" onclick="openNewProjectModal()" style="padding:0;font-size:13px;font-weight:600" title="New Project">+</span>
      </div>
      <div id="sidebar-projects"></div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section" id="sidebar-folders-section">
      <div class="sidebar-label" style="display:flex;align-items:center;justify-content:space-between">
        <span>Folders</span>
        <span onclick="addFolderFromSidebar()" style="padding:0;font-size:13px;font-weight:600;cursor:pointer;color:var(--text-muted)" title="New Folder">+</span>
      </div>
      <div class="folder-tree" id="sidebar-folder-tree"></div>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-section" id="sidebar-context"></div>
    <div id="sidebar-bottom" style="margin-top:auto;padding:12px">
      <button class="btn btn-sm" style="width:100%;margin-bottom:6px;justify-content:center;gap:6px" onclick="openCommandPalette()">
        <span style="font-size:10px">Search</span>
        <span style="font-family:var(--mono);font-size:8px;padding:1px 4px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px">K</span>
      </button>
      <button class="btn btn-sm" style="width:100%;margin-bottom:4px" onclick="window.open('https://calendar.google.com','_blank')">Google Calendar</button>
      <div id="sidebar-dash" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:6px">
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:600" id="dash-tasks">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Tasks</div>
        </div>
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--accent-cyan);font-weight:600" id="dash-docs">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Docs</div>
        </div>
        <div style="text-align:center;padding:4px;background:var(--bg-surface);border-radius:4px;border:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:11px;color:var(--yellow);font-weight:600" id="dash-projects">0</div>
          <div style="font-size:7px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px">Proj</div>
        </div>
      </div>
      <div style="font-family:var(--mono);font-size:8px;color:var(--text-muted);text-align:center;margin-top:4px">
        <span id="storage-indicator">0 KB</span> used
      </div>
      <div style="display:flex;gap:4px;margin-top:6px">
        <button class="btn btn-sm" style="flex:1" onclick="exportAll()">Export</button>
        <button class="btn btn-sm" style="flex:1" onclick="importAll()">Import</button>
      </div>
      <button class="btn btn-sm btn-danger" style="width:100%;margin-top:4px;font-size:8px;opacity:0.5" onclick="undoImport()">Undo Import</button>
    </div>
    <div class="sidebar-collapse-chevron" onclick="toggleSidebar()" title="Collapse sidebar">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg>
    </div>
  </aside>
  <div class="sidebar-resize" id="sidebar-resize"></div>

  <main class="main">
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileSidebar()"></div>
    <div class="header">
      <button class="mobile-hamburger" onclick="openMobileSidebar()" style="display:none;background:none;border:none;color:var(--text);cursor:pointer;padding:4px"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <button class="btn btn-sm btn-ghost sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar" id="sidebar-toggle-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg></button>
      <span class="header-title" id="header-title">Content</span>
      <span id="header-breadcrumb" style="font-size:10px;color:var(--text-muted);font-family:var(--mono);display:flex;align-items:center;gap:4px"></span>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <span id="header-stats" style="font-size:8px;color:var(--text-muted);font-family:var(--mono);display:flex;gap:8px;align-items:center"></span>
        <span id="save-indicator" style="font-family:var(--mono);font-size:8px;color:var(--text-muted);opacity:0;transition:opacity 0.3s">Saved</span>
        <input type="text" id="header-search" placeholder="Search... (Cmd+K)" onfocus="this.blur();openCommandPalette()" style="font-size:9px;padding:3px 8px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;width:120px;font-family:var(--mono);cursor:pointer" readonly>
        <span id="cloud-sync-indicator" onclick="cloudSave()" title="Click to sync" style="cursor:pointer;font-size:12px;opacity:0.5;transition:all 0.3s">&#9729;</span>
        <div class="mode-switcher">
          <button class="mode-btn" onclick="setMode('focus')" id="mode-focus-btn" title="Focus: Primary only">F</button>
          <button class="mode-btn active" onclick="setMode('default')" id="mode-default-btn" title="Default">D</button>
          <button class="mode-btn" onclick="setMode('extended')" id="mode-extended-btn" title="Extended: Show context panel">E</button>
        </div>
        <button class="btn btn-sm btn-ghost" onclick="openCommandPalette()" title="Command Palette (Cmd+K)" style="font-family:var(--mono);font-size:9px;padding:3px 8px;gap:4px">
          <span class="cmd-key" style="min-width:14px;height:14px;font-size:8px">K</span>
        </button>
        <div class="header-actions" id="header-actions"></div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="panel active" id="panel-content">
      <div style="padding:16px 20px 0;display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <div class="tab-bar" id="content-type-tabs">
          <button class="tab-btn active" onclick="setContentType('all',this)">All</button>
          <button class="tab-btn" onclick="setContentType('caption',this)">Captions</button>
          <button class="tab-btn" onclick="setContentType('quote',this)">Quotes</button>
        </div>
        <div class="tab-bar" id="content-theme-tabs" style="margin-left:8px;border-left:1px solid var(--border);padding-left:8px"></div>
        <div style="margin-left:auto;display:flex;gap:6px">
          <input type="text" id="content-search" placeholder="Search..." oninput="renderContent()" style="width:140px;font-size:10px;padding:5px 8px">
          <select id="content-sort" onchange="renderContent()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="longest">Longest</option>
            <option value="shortest">Shortest</option>
            <option value="alpha">A-Z</option>
            <option value="shuffle">Shuffle</option>
            <option value="theme">By Theme</option>
            <option value="type">By Type</option>
            <option value="tag">By Tag</option>
            <option value="source">By Source</option>
          </select>
          <span id="content-word-total" style="font-size:8px;color:var(--text-muted);font-family:var(--mono)"></span>
          <button class="btn btn-sm" onclick="randomContent()" title="Random content for inspiration">Random</button>
          <button class="btn btn-sm" onclick="exportContent()" title="Export all content as markdown">Export</button>
          <button class="btn btn-sm" onclick="exportFilteredContent()" title="Export currently filtered content">Export View</button>
          <button class="btn btn-sm" onclick="contentManageTags()" title="Rename or delete tags">Tags</button>
          <button class="btn btn-sm" onclick="batchImportContent()" title="Paste multiple items separated by ---">Batch</button>
          <button class="btn btn-sm" onclick="toggleAllContentCards()" title="Expand/collapse all cards">Exp/Col</button>
          <button class="btn btn-sm" onclick="copyAllContent()" title="Copy all visible content to clipboard">Copy All</button>
          <button class="btn btn-sm" onclick="exportFilteredContentMD()" title="Copy filtered content as Markdown">Export MD</button>
          <button class="btn btn-sm" onclick="toggleContentCompact()" id="content-compact-btn" title="Toggle compact list view">Compact</button>
          <button class="btn btn-sm" onclick="contentReadLaterFilter=!contentReadLaterFilter;this.style.color=contentReadLaterFilter?'var(--accent-cyan)':'';renderContent()" id="content-rl-btn" title="Show only Read Later items">RL</button>
          <button class="btn btn-sm" onclick="contentShowArchived=!contentShowArchived;this.style.color=contentShowArchived?'var(--yellow)':'';renderContent()" id="content-archive-btn" title="Show/hide archived content">Archived</button>
          <button class="btn btn-sm" onclick="contentFindDuplicates()" title="Find duplicate/similar content items" style="color:#f59e0b">Dupes</button>
          <button class="btn btn-sm" onclick="contentWordCloud()" title="Generate word cloud from content" style="color:#a855f7">Cloud</button>
          <button class="btn btn-sm" id="content-bulk-btn" onclick="toggleContentBulk()" title="Select multiple">Select</button>
          <div id="content-bulk-actions" style="display:none;gap:4px">
            <button class="btn btn-sm btn-danger" onclick="contentBulkDelete()">Delete Selected</button>
            <button class="btn btn-sm" onclick="contentBulkTag()">Tag Selected</button>
            <button class="btn btn-sm" onclick="mergeContent()">Merge Selected</button>
            <button class="btn btn-sm" onclick="contentBulkExport()">Export Selected</button>
            <button class="btn btn-sm" onclick="toggleContentBulk()">Cancel</button>
          </div>
          <button class="btn btn-sm" onclick="tagAllVisibleContent()" title="Add a tag to all currently visible items">Tag All</button>
          <button class="btn btn-primary btn-sm" onclick="openContentModal()">+ Add</button>
        </div>
      </div>
      <div id="content-tag-pills" style="padding:0 20px;display:flex;gap:4px;flex-wrap:wrap;flex-shrink:0"></div>
      <div class="content-area"><div class="content-grid" id="content-grid"></div></div>
    </div>

    <!-- TASKS -->
    <div class="panel" id="panel-tasks">
      <div style="padding:12px 20px 0;flex-shrink:0">
        <div class="task-toolbar">
          <button class="btn btn-primary btn-sm" onclick="addTask()">+ Task</button>
          <div class="btn-group" style="position:relative;display:inline-block"><button class="btn btn-sm" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'" title="Task templates">T</button><div style="display:none;position:absolute;top:100%;left:0;z-index:100;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:4px;min-width:160px;box-shadow:0 8px 24px rgba(0,0,0,0.4)"><div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;letter-spacing:0.05em">Quick Templates</div><div class="task-tpl" onclick="addTaskFromTemplate('Daily standup','p1','daily')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Daily standup</div><div class="task-tpl" onclick="addTaskFromTemplate('Code review','p2','weekly')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Code review (weekly)</div><div class="task-tpl" onclick="addTaskFromTemplate('Content batch','p1','weekly')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Content batch (weekly)</div><div class="task-tpl" onclick="addTaskFromTemplate('Write session','p1','daily')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Write session (daily)</div><div class="task-tpl" onclick="addTaskFromTemplate('Deploy check','p2','weekday')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Deploy check (weekday)</div></div></div>
          <div class="tab-bar">
            <button class="tab-btn active" id="task-view-list" onclick="setTaskView('list')">List</button>
            <button class="tab-btn" id="task-view-board" onclick="setTaskView('board')">Board</button>
            <button class="tab-btn" id="task-view-eisenhower" onclick="setTaskView('eisenhower')" title="Eisenhower Matrix">EH</button>
          </div>
          <div class="tab-bar" style="margin-left:8px">
            <button class="tab-btn active" id="task-filter-all" onclick="setTaskFilter('all')">All</button>
            <button class="tab-btn" id="task-filter-active" onclick="setTaskFilter('active')">Active</button>
            <button class="tab-btn" id="task-filter-todo" onclick="setTaskFilter('todo')">Todo</button>
            <button class="tab-btn" id="task-filter-progress" onclick="setTaskFilter('progress')">WIP</button>
            <button class="tab-btn" id="task-filter-blocked" onclick="setTaskFilter('blocked')">Blocked</button>
            <button class="tab-btn" id="task-filter-done" onclick="setTaskFilter('done')">Done</button>
            <button class="tab-btn" id="task-filter-overdue" onclick="setTaskFilter('overdue')" style="color:var(--red)">Overdue</button>
            <button class="tab-btn" id="task-filter-urgent" onclick="setTaskFilter('urgent')" style="color:var(--orange)">Urgent</button>
          </div>
          <select id="task-project-filter" onchange="filterTaskProject(this.value||null)" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;max-width:100px"><option value="">All Projects</option></select>
          <select id="task-sort" onchange="renderTasks()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px">
            <option value="manual">Manual</option>
            <option value="priority">Priority</option>
            <option value="due">Due Date</option>
            <option value="newest">Newest</option>
            <option value="alpha">A-Z</option>
            <option value="completed">Completed</option>
            <option value="project">By Project</option>
            <option value="time">Time Spent</option>
            <option value="status">By Status</option>
            <option value="estimate">By Estimate</option>
            <option value="tag">By Tag</option>
          </select>
          <button class="btn btn-sm" onclick="exportTasks()" title="Copy tasks as markdown">Export</button>
          <span id="task-count-info" style="font-size:8px;color:var(--text-muted);font-family:var(--mono)"></span>
          <button class="btn btn-sm" onclick="toggleTaskBulk()" id="task-bulk-btn">Bulk</button>
          <div id="task-bulk-actions" style="display:none;gap:4px;align-items:center">
            <select id="task-bulk-status" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="">Set Status</option><option value="todo">To Do</option><option value="progress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select>
            <select id="task-bulk-priority" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="">Set Priority</option><option value="p0">P0</option><option value="p1">P1</option><option value="p2">P2</option><option value="p3">P3</option></select>
            <input type="date" id="task-bulk-due" style="font-size:9px;padding:3px 4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;width:110px" title="Set due date">
            <button class="btn btn-sm" onclick="taskBulkTag()" style="color:var(--accent-cyan)">Tag</button>
            <button class="btn btn-sm" onclick="taskBulkMove()" style="color:var(--accent)">Move</button>
            <button class="btn btn-sm btn-danger" onclick="taskBulkDelete()">Delete</button>
            <button class="btn btn-sm" onclick="taskBulkApply()">Apply</button>
            <button class="btn btn-sm" onclick="taskBulkSelectAll()">All</button>
            <button class="btn btn-sm" onclick="taskSelected.clear();renderTasks()">None</button>
            <button class="btn btn-sm" onclick="toggleTaskBulk()">Cancel</button>
          </div>
          <button class="btn btn-sm" onclick="archiveCompletedTasks()" title="Archive all completed tasks">Archive Done</button>
          <button class="btn btn-sm" id="task-filter-archived" onclick="showArchivedTasks()" title="View archived tasks">Archived<span id="archived-count" style="font-size:8px;color:var(--text-muted);margin-left:3px;font-family:var(--mono)"></span></button>
          <button class="btn btn-sm" onclick="taskManageTags()" title="Manage task tags (rename/delete/merge)" style="font-size:9px">Tags</button>
          <div class="task-toolbar-search">
            <input type="text" id="task-search" placeholder="Search tasks..." oninput="renderTasks()" style="font-size:10px;padding:5px 8px">
          </div>
          <button class="btn btn-sm" id="task-clear-filters" onclick="clearTaskFilters()" style="display:none;color:var(--red);font-size:8px" title="Clear all filters">Clear</button>
        </div>
      </div>
      <div class="content-area" id="task-content-area">
        <div id="task-list-view">
          <div class="task-table-header">
            <div class="task-table-header-cell"></div>
            <div class="task-table-header-cell">Task</div>
            <div class="task-table-header-cell">Status</div>
            <div class="task-table-header-cell">Priority</div>
            <div class="task-table-header-cell">Project</div>
            <div class="task-table-header-cell">Due</div>
            <div class="task-table-header-cell"></div>
          </div>
          <div id="task-rows"></div>
        </div>
        <div class="board-view" id="task-board-view">
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">To Do</span><span class="board-col-count" id="bc-todo" oncontextmenu="event.preventDefault();boardMoveAll('todo')">0</span></div><div class="board-col-tasks" id="board-todo" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'todo')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">In Progress</span><span class="board-col-count" id="bc-progress" oncontextmenu="event.preventDefault();boardMoveAll('progress')">0</span></div><div class="board-col-tasks" id="board-progress" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'progress')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">Done</span><span class="board-col-count" id="bc-done" oncontextmenu="event.preventDefault();boardMoveAll('done')">0</span></div><div class="board-col-tasks" id="board-done" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'done')"></div></div>
          <div class="board-col"><div class="board-col-header"><span class="board-col-title">Blocked</span><span class="board-col-count" id="bc-blocked" oncontextmenu="event.preventDefault();boardMoveAll('blocked')">0</span></div><div class="board-col-tasks" id="board-blocked" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="this.classList.remove('drag-over');boardDrop(event,'blocked')"></div></div>
        </div>
        <div id="task-eisenhower-view" style="display:none;flex:1;display:none;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:8px;padding:8px;overflow:auto">
          <div class="eh-quad" style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius);padding:12px;overflow-y:auto"><div style="font-size:11px;font-weight:700;color:#ef4444;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Urgent + Important (DO)</div><div id="eh-q1"></div></div>
          <div class="eh-quad" style="background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.3);border-radius:var(--radius);padding:12px;overflow-y:auto"><div style="font-size:11px;font-weight:700;color:#eab308;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Not Urgent + Important (SCHEDULE)</div><div id="eh-q2"></div></div>
          <div class="eh-quad" style="background:rgba(249,115,22,0.08);border:1px solid rgba(249,115,22,0.3);border-radius:var(--radius);padding:12px;overflow-y:auto"><div style="font-size:11px;font-weight:700;color:#f97316;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Urgent + Not Important (DELEGATE)</div><div id="eh-q3"></div></div>
          <div class="eh-quad" style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.3);border-radius:var(--radius);padding:12px;overflow-y:auto"><div style="font-size:11px;font-weight:700;color:#22c55e;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em">Not Urgent + Not Important (ELIMINATE)</div><div id="eh-q4"></div></div>
        </div>
      </div>
    </div>

    <!-- CALENDAR -->
    <div class="panel" id="panel-calendar">
      <div class="content-area" style="display:flex;flex-direction:column">
        <div class="calendar-shell">
          <div class="calendar-nav">
            <button class="btn btn-sm" onclick="calNav(-1)">Prev</button>
            <button class="btn btn-sm" onclick="calNav(1)">Next</button>
            <span class="calendar-month-label" id="cal-month-label"></span>
            <button class="btn btn-sm" onclick="calToday()">Today</button>
            <div class="cal-view-toggle">
              <button class="cal-view-btn active" id="cal-view-month" onclick="setCalView('month')">Month</button>
              <button class="cal-view-btn" id="cal-view-week" onclick="setCalView('week')">Week</button>
              <button class="cal-view-btn" id="cal-view-year" onclick="setCalView('year')">Year</button>
              <button class="cal-view-btn" id="cal-view-agenda" onclick="setCalView('agenda')">Agenda</button>
            </div>
            <div style="margin-left:auto;display:flex;gap:6px">
              <button class="btn btn-sm" onclick="window.open('https://calendar.google.com','_blank')">Google Cal</button>
              <button class="btn btn-sm" onclick="exportICS()">Export .ics</button>
              <button class="btn btn-sm" onclick="importICS()">Import .ics</button>
            </div>
          </div>
          <div id="cal-today-summary" style="padding:6px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);margin:0 0 8px 0;font-size:10px;color:var(--text-secondary);display:none"></div>
          <div class="calendar-grid" id="cal-grid"></div>
          <div class="week-grid" id="cal-week-grid" style="display:none"></div>
        </div>
        <div id="cal-upcoming" style="padding:8px 0 0;border-top:1px solid var(--border);margin-top:8px"></div>
      </div>
    </div>

    <!-- WRITER -->
    <div class="panel" id="panel-writer">
      <div class="writer-shell">
        <div class="writer-sidebar">
          <div style="padding:8px;border-bottom:1px solid var(--border);display:flex;gap:4px">
            <button class="btn btn-primary btn-sm" style="flex:1" onclick="newDoc()">+ New</button>
            <div class="btn-group" style="position:relative;display:inline-block"><button class="btn btn-sm" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'" title="New from template">T</button><div style="display:none;position:absolute;top:100%;left:0;z-index:100;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:4px;min-width:140px;box-shadow:0 8px 24px rgba(0,0,0,0.4)"><div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;letter-spacing:0.05em">Templates</div><div onclick="newDocFromTemplate('Blog Post','<h2>Introduction</h2><p></p><h2>Main Points</h2><p></p><h2>Conclusion</h2><p></p>')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Blog Post</div><div onclick="newDocFromTemplate('Meeting Notes','<h2>Attendees</h2><p></p><h2>Agenda</h2><p></p><h2>Decisions</h2><p></p><h2>Action Items</h2><p></p>')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Meeting Notes</div><div onclick="newDocFromTemplate('Project Brief','<h2>Overview</h2><p></p><h2>Goals</h2><p></p><h2>Timeline</h2><p></p><h2>Resources</h2><p></p>')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Project Brief</div><div onclick="newDocFromTemplate('Daily Journal','<h2>'+new Date().toLocaleDateString()+'</h2><h3>What I did</h3><p></p><h3>What I learned</h3><p></p><h3>Tomorrow</h3><p></p>')" style="padding:6px 8px;font-size:10px;cursor:pointer;border-radius:3px;color:var(--text-secondary)" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">Daily Journal</div></div></div>
            <button class="btn btn-sm" onclick="toggleWriterPanel()">H</button>
          </div>
          <div style="padding:4px 8px;display:flex;gap:4px"><input type="text" id="writer-doc-search" placeholder="Search docs..." oninput="renderDocList()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:10px;color:var(--text);outline:none"><select id="writer-doc-sort" onchange="renderDocList()" style="font-size:8px;padding:2px 4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;cursor:pointer"><option value="updated">Updated</option><option value="created">Created</option><option value="alpha">A-Z</option><option value="words">Words</option><option value="tag">By Tag</option></select></div>
          <div class="writer-doc-list" id="writer-doc-list"></div>
        </div>
        <div class="writer-main">
          <div class="writer-toolbar">
            <select class="writer-toolbar-select" id="writer-block-type" onchange="execBlock(this.value)">
              <option value="p">Paragraph</option>
              <option value="h1">Heading 1</option>
              <option value="h2">Heading 2</option>
              <option value="h3">Heading 3</option>
              <option value="blockquote">Quote</option>
              <option value="pre">Code Block</option>
            </select>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="execCmd('bold')" title="Bold"><b>B</b></button>
            <button class="writer-toolbar-btn" onclick="execCmd('italic')" title="Italic"><i>I</i></button>
            <button class="writer-toolbar-btn" onclick="execCmd('underline')" title="Underline"><u>U</u></button>
            <button class="writer-toolbar-btn" onclick="execCmd('strikeThrough')"><s>S</s></button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="execCmd('insertUnorderedList')">*</button>
            <button class="writer-toolbar-btn" onclick="execCmd('insertOrderedList')">1.</button>
            <button class="writer-toolbar-btn" onclick="execCmd('indent')">&gt;</button>
            <button class="writer-toolbar-btn" onclick="execCmd('outdent')">&lt;</button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="insertLink()">Ln</button>
            <button class="writer-toolbar-btn" onclick="insertHR()">--</button>
            <button class="writer-toolbar-btn" onclick="insertCodeInline()">{}</button>
            <div class="writer-toolbar-sep"></div>
            <button class="writer-toolbar-btn" onclick="clearFormatting()">Tx</button>
            <div style="margin-left:auto;display:flex;gap:2px">
              <button class="voice-btn" id="writer-voice-btn" onclick="toggleVoice('writer')" title="Voice Input">M</button>
              <button class="writer-toolbar-btn" onclick="writerTOC()" title="Insert Table of Contents">TOC</button>
              <button class="writer-toolbar-btn" onclick="writerToContent()" title="Save to Content section">C+</button>
              <button class="writer-toolbar-btn" onclick="saveVersion()" title="Save Version">v+</button>
              <button class="writer-toolbar-btn" onclick="toggleWriterPanel()" title="History">H</button>
              <button class="writer-toolbar-btn" onclick="writerDetailedStats()" title="Detailed writing statistics">St</button>
              <div style="display:inline-block;position:relative"><button class="writer-toolbar-btn" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'" title="New doc from template">Tpl</button><div style="display:none;position:absolute;top:100%;left:0;z-index:100;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:4px;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,0.4)"><div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;letter-spacing:0.05em">Doc Templates</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('meeting')">Meeting Notes</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('blog')">Blog Post</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('spec')">Project Spec</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('journal')">Journal Entry</div><div style="padding:6px 8px;font-size:10px;cursor:pointer;color:var(--text-secondary);border-radius:3px" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="writerFromTemplate('outline')">Outline</div></div></div>
              <button class="writer-toolbar-btn" onclick="mergeDocs()" title="Merge another doc into current">Mg</button>
              <button class="writer-toolbar-btn" onclick="writerOutline()" title="Show document outline (headings)">Out</button>
              <button class="writer-toolbar-btn" onclick="writerWordFreq()" title="Word frequency analysis">Fq</button>
              <button class="writer-toolbar-btn" onclick="writerCompare()" title="Compare two documents side by side">Cmp</button>
              <button class="writer-toolbar-btn" onclick="writerSplitDoc()" title="Split document at --- markers into multiple docs">Spl</button>
              <select class="writer-toolbar-select" id="writer-export-sel" onchange="writerExport(this.value);this.selectedIndex=0">
                <option value="">Export</option>
                <option value="md">Markdown</option>
                <option value="html">HTML</option>
                <option value="txt">Plain Text</option>
                <option value="clipboard">Copy All</option>
                <option value="print">Print / PDF</option>
              </select>
            </div>
          </div>
          <div id="writer-find-bar" style="display:none;padding:4px 8px;background:var(--bg-elevated);border-bottom:1px solid var(--border);display:none;align-items:center;gap:6px;flex-shrink:0">
            <input type="text" id="writer-find-input" placeholder="Find..." style="flex:1;font-size:10px;padding:4px 8px;max-width:200px" oninput="writerFindNext()" onkeydown="if(event.key==='Enter'){event.preventDefault();writerFindNext();}if(event.key==='Escape'){writerFindClose();}">
            <input type="text" id="writer-replace-input" placeholder="Replace..." style="flex:1;font-size:10px;padding:4px 8px;max-width:200px" onkeydown="if(event.key==='Escape'){writerFindClose();}">
            <button class="btn btn-sm btn-ghost" onclick="writerReplace()" style="font-size:9px;padding:2px 6px">Replace</button>
            <button class="btn btn-sm btn-ghost" onclick="writerReplaceAll()" style="font-size:9px;padding:2px 6px">All</button>
            <span id="writer-find-count" style="font-size:9px;color:var(--text-muted);font-family:var(--mono)"></span>
            <button class="btn btn-sm btn-ghost" onclick="writerFindClose()" style="font-size:9px;padding:2px 4px">x</button>
          </div>
          <div class="writer-editor-wrap" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
            <input type="text" class="writer-title-input" id="writer-title" placeholder="Untitled Document" oninput="onWriterChange()">
            <div id="writer-tags-bar" style="display:flex;flex-wrap:wrap;gap:4px;padding:2px 8px;min-height:20px;align-items:center"></div>
            <div class="writer-editor" id="writer-editor" contenteditable="true" data-placeholder="Start writing..." oninput="onWriterChange()" onkeydown="writerKeydown(event)" onscroll="writerScrollUpdate(this)"></div>
          </div>
          <div class="writer-statusbar">
            <span id="ws-words">0 words</span>
            <span id="ws-chars">0 chars</span>
            <span id="ws-reading">0 min read</span>
            <span id="ws-goal" style="cursor:pointer" onclick="setWriterGoal()" title="Click to set word goal"></span>
            <span id="ws-edited" style="color:var(--text-muted)"></span>
            <span id="ws-session" style="color:var(--green)"></span>
            <span id="ws-readability" style="font-size:9px"></span>
            <span id="ws-scroll" style="color:var(--text-muted);font-family:var(--mono)"></span>
            <span id="ws-saved" style="margin-left:auto">Saved</span>
          </div>
        </div>
        <div class="writer-right-panel hidden" id="writer-right-panel">
          <div class="sidebar-label" style="padding:0;margin-bottom:8px">Version History</div>
          <div id="writer-versions"></div>
        </div>
      </div>
    </div>

    <!-- LIVING DOCS -->
    <div class="panel" id="panel-specs">
      <div class="specs-shell">
        <div class="specs-sidebar">
          <div style="padding:8px;border-bottom:1px solid var(--border);display:flex;gap:4px">
            <button class="btn btn-primary btn-sm" style="flex:1" onclick="newSpec()">+ New</button>
            <select class="writer-toolbar-select" onchange="newSpecFromTemplate(this.value);this.selectedIndex=0" style="width:auto">
              <option value="">Template</option>
              <option value="prd">PRD</option>
              <option value="rfc">RFC</option>
              <option value="retro">Retrospective</option>
              <option value="checklist">Checklist</option>
            </select>
            <select class="writer-toolbar-select" onchange="specExport(this.value);this.selectedIndex=0" style="width:auto">
              <option value="">Export</option>
              <option value="md">Markdown</option>
              <option value="html">HTML</option>
              <option value="clipboard">Copy All</option>
            </select>
          </div>
          <div style="padding:4px 8px;display:flex;gap:4px"><input type="text" id="spec-list-search" placeholder="Search specs..." oninput="renderSpecList()" style="flex:1;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:10px;color:var(--text);outline:none"><select id="spec-list-sort" onchange="renderSpecList()" style="font-size:8px;padding:2px 4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px;cursor:pointer"><option value="updated">Updated</option><option value="alpha">A-Z</option><option value="words">Words</option><option value="project">Project</option><option value="sections">Sections</option></select><span id="specs-word-total" style="font-size:8px;color:var(--text-muted);font-family:var(--mono);white-space:nowrap"></span></div>
          <div class="specs-doc-list" id="specs-doc-list"></div>
        </div>
        <div class="specs-main" id="specs-main">
          <div class="specs-header">
            <input type="text" class="specs-title-input" id="specs-title" placeholder="Project Name..." oninput="onSpecChange()">
            <button class="voice-btn" id="specs-voice-btn" onclick="toggleVoice('specs')" title="Voice Input">M</button>
            <button class="btn btn-sm" onclick="addSpecSection()">+ Section</button>
            <input type="text" id="spec-search" placeholder="Search sections..." oninput="specSearch()" style="width:120px;font-size:10px;padding:4px 8px">
            <select id="spec-project-assign" onchange="assignSpecProject(this.value)" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"></select>
            <button class="btn btn-sm" onclick="collapseAllSections()" title="Collapse all">Collapse</button>
            <button class="btn btn-sm" onclick="expandAllSections()" title="Expand all">Expand</button>
            <button class="btn btn-sm" onclick="exportCurrentSpec()" title="Export this spec as HTML" style="font-size:9px">Export</button>
            <button class="btn btn-sm" onclick="exportCurrentSpecMD()" title="Copy spec as Markdown" style="font-size:9px">MD</button>
            <button class="btn btn-sm" onclick="exportCurrentSpecText()" title="Copy spec as plain text" style="font-size:9px">TXT</button>
            <button class="btn btn-sm" onclick="saveSpecVersion()" title="Save snapshot of this spec" style="font-size:9px;color:var(--accent)">v+</button>
            <button class="btn btn-sm" onclick="showSpecVersions()" title="View version history" style="font-size:9px">Hist</button>
            <button class="btn btn-sm" onclick="specImportMarkdown()" title="Import spec from Markdown" style="font-size:9px;color:#22d3ee">Imp</button>
          </div>
          <div class="specs-sections" id="specs-sections"></div>
          <div class="specs-statusbar">
            <span id="specs-status">Saved</span>
            <span style="margin-left:auto" id="specs-word-count">0 words</span>
          </div>
        </div>
      </div>
    </div>

    <!-- WHITEBOARD -->
    <div class="panel" id="panel-whiteboard">
      <div class="wb-shell">
        <div class="wb-toolbar" id="wb-toolbar">
          <button class="wb-tool active" data-tool="select" onclick="wbSetTool('select')" title="Select (V)">V</button>
          <button class="wb-tool" data-tool="hand" onclick="wbSetTool('hand')" title="Pan (H)">H</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" data-tool="node" onclick="wbSetTool('node')" title="Add Node (N)">+N</button>
          <button class="wb-tool" data-tool="connect" onclick="wbSetTool('connect')" title="Connect (C)">-></button>
          <button class="wb-tool" data-tool="text" onclick="wbSetTool('text')" title="Text (T)">T</button>
          <button class="wb-tool" data-tool="sticky" onclick="wbSetTool('sticky')" title="Sticky (S)">St</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" onclick="wbUndo()" title="Undo">Un</button>
          <button class="wb-tool" onclick="wbRedo()" title="Redo">Re</button>
          <div class="wb-tool-sep"></div>
          <button class="wb-tool" onclick="wbToggleGrid()" title="Grid (G)">G</button>
          <button class="wb-tool" onclick="wbAutoLayout()" title="Auto Layout">AL</button>
          <button class="wb-tool" onclick="wbClusterByType()" title="Cluster by Type">CL</button>
        </div>
        <div class="wb-actions">
          <button class="btn btn-sm" onclick="openTplModal()">Templates</button>
          <select class="writer-toolbar-select" onchange="wbExport(this.value);this.selectedIndex=0" style="width:auto"><option value="">Export</option><option value="png">PNG</option><option value="svg">SVG</option><option value="json">JSON</option><option value="text">Text Outline</option></select>
          <button class="btn btn-sm" onclick="wbImportJSON()" title="Import whiteboard JSON">Import</button>
          <button class="btn btn-sm" onclick="wbClearAll()">Clear</button>
          <input type="text" id="wb-search" placeholder="Find node..." oninput="wbSearchNodes(this.value)" style="width:100px;padding:2px 6px;font-size:9px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:var(--mono)">
          <span id="wb-stats" style="font-size:8px;color:var(--text-muted);font-family:var(--mono)"></span>
        </div>
        <div class="wb-top-bar">
          <div class="wb-zoom"><button class="wb-tool" onclick="wbZoom(-0.1)" style="width:20px;height:20px;font-size:14px">-</button><span id="wb-zoom-level">100%</span><button class="wb-tool" onclick="wbZoom(0.1)" style="width:20px;height:20px;font-size:14px">+</button><button class="wb-tool" onclick="wbFitView()" style="width:20px;height:20px;font-size:9px">Fit</button></div>
        </div>
        <div class="wb-canvas-wrap" id="wb-canvas-wrap" onmousedown="wbCanvasDown(event)" onmousemove="wbCanvasMove(event)" onmouseup="wbCanvasUp(event)" onwheel="wbWheel(event)" oncontextmenu="event.preventDefault()">
          <div class="wb-canvas" id="wb-canvas">
            <svg class="wb-svg" id="wb-svg"></svg>
          </div>
        </div>
        <div class="wb-minimap" id="wb-minimap"></div>
      </div>
    </div>

    <!-- LINKS -->
    <div class="panel" id="panel-links">
      <div style="padding:16px 20px 0;display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <div class="tab-bar" id="link-category-tabs"></div>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <input type="text" id="link-search" placeholder="Search links..." oninput="renderLinks()" style="width:140px;font-size:10px;padding:5px 8px">
          <select id="link-sort" onchange="renderLinks()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="newest">Newest</option><option value="oldest">Oldest</option><option value="alpha">A-Z</option><option value="category">Category</option><option value="domain">By Domain</option><option value="tag">By Tag</option></select>
          <button class="btn btn-sm" onclick="manageLinkTags()" title="Manage link tags">Tags</button>
          <button class="btn btn-sm" onclick="openFilteredLinks()" title="Open all visible links">Open All</button>
          <button class="btn btn-sm" onclick="copyAllLinkURLs()" title="Copy all filtered URLs to clipboard">Copy URLs</button>
          <button class="btn btn-sm" onclick="batchImportLinks()" title="Paste multiple URLs to import">Import</button>
          <button class="btn btn-sm" onclick="checkAllLinks()" title="Check all links for broken URLs" id="link-check-btn">Check</button>
          <button class="btn btn-primary btn-sm" onclick="openLinkModal()">+ Add</button>
        </div>
      </div>
      <div class="content-area"><div class="links-grid" id="links-grid"></div></div>
    </div>

    <!-- PIPELINE -->
    <div class="panel" id="panel-pipeline">
      <div style="padding:16px 20px 0;flex-shrink:0">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <span style="font-size:13px;font-weight:600;letter-spacing:0.02em">Pipeline</span>
          <span style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em">Audio / Text -> Whisper -> GPT -> ASTRA</span>
          <span style="flex:1"></span>
          <span id="pl-status-dot" style="width:8px;height:8px;border-radius:50%;background:var(--text-muted)" title="Not connected"></span>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" id="pl-record-btn" onclick="plToggleRecord()">Record Mic</button>
          <label class="btn btn-sm" style="cursor:pointer;display:inline-flex;align-items:center;gap:4px">
            Upload Audio
            <input type="file" accept="audio/*" onchange="plUploadFile(this)" style="display:none">
          </label>
          <button class="btn btn-sm" onclick="plPasteText()">Paste Text</button>
          <button class="btn btn-sm" onclick="plLoadHistory()">History</button>
        </div>
        <div id="pl-onboarding" style="padding:10px 12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;font-size:10px;color:var(--text-muted);line-height:1.6;display:none">
          <div style="font-weight:600;color:var(--accent);margin-bottom:4px">Text-only mode available</div>
          Use "Paste Text" to paste any text, write a prompt (e.g. "Summarize key ideas", "Extract action items", "Translate to Spanish"), then hit Process. Audio requires OPENAI_API_KEY in Vercel env vars.
        </div>
        <div id="pl-recording" style="display:none;padding:8px 12px;background:rgba(239,68,68,0.1);border:1px solid var(--red);border-radius:4px;margin-bottom:12px;display:none;align-items:center;gap:8px">
          <div style="width:8px;height:8px;background:var(--red);border-radius:50%;animation:pulse 1s infinite"></div>
          <span id="pl-rec-time" style="font-size:10px;color:var(--red)">Recording... 0s</span>
        </div>
        <div id="pl-input-preview" style="display:none;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:12px;max-height:120px;overflow-y:auto;font-size:11px;color:var(--text-muted)"></div>
        <div style="margin-bottom:12px">
          <label style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:4px;display:block">Custom Prompt</label>
          <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap">
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Summarize the key ideas in 3-5 bullet points'" style="font-size:8px;padding:2px 6px">Summarize</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Extract all action items and tasks as a checklist'" style="font-size:8px;padding:2px 6px">Action Items</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Rewrite this as a polished social media post (Twitter/X length)'" style="font-size:8px;padding:2px 6px">Social Post</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Translate to Spanish, maintaining the original tone'" style="font-size:8px;padding:2px 6px">Translate ES</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Clean up grammar and punctuation, keep the original voice'" style="font-size:8px;padding:2px 6px">Clean Up</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Extract the top keywords and most frequent terms'" style="font-size:8px;padding:2px 6px">Keywords</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Convert to bullet point list'" style="font-size:8px;padding:2px 6px">Bullets</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Generate headline and title suggestions'" style="font-size:8px;padding:2px 6px">Headlines</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Show detailed word count and text statistics'" style="font-size:8px;padding:2px 6px">Stats</button>
            <button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='Generate questions from this text'" style="font-size:8px;padding:2px 6px">Questions</button>
            <button class="btn btn-sm btn-ghost" onclick="plWordCloud()" style="font-size:8px;padding:2px 6px;color:var(--accent)">Word Cloud</button>
            <span style="width:1px;height:12px;background:var(--border);margin:0 2px"></span>
            <button class="btn btn-sm btn-ghost" onclick="plSaveTemplate()" style="font-size:8px;padding:2px 6px;color:var(--accent)">+ Save</button>
          </div>
          <div id="pl-custom-templates" style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px"></div>
          <textarea id="pl-prompt" placeholder="What should the pipeline do with this input? e.g. 'Summarize key ideas', 'Extract action items', 'Rewrite for social media', 'Translate to Spanish'..." style="width:100%;min-height:60px;resize:vertical;font-size:11px;padding:8px 10px"></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:16px">
          <button class="btn btn-primary" onclick="plProcess()" id="pl-process-btn" style="flex:1">Process Pipeline</button>
          <select id="pl-source" style="font-size:10px;padding:4px 8px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text);border-radius:4px">
            <option value="pipeline-manual">Manual</option>
            <option value="pipeline-whatsapp">WhatsApp</option>
            <option value="pipeline-voice">Voice Memo</option>
            <option value="pipeline-capture">Capture</option>
          </select>
        </div>
      </div>
      <div class="content-area" style="padding:0 20px 20px">
        <div id="pl-result" style="display:none;padding:16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:4px;margin-bottom:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent)">Pipeline Result</span>
            <div style="display:flex;gap:6px">
              <button class="btn btn-sm" onclick="plCopyResult()">Copy</button>
              <button class="btn btn-sm" onclick="plSaveToContent()">Save to Content</button>
              <button class="btn btn-sm" onclick="plSaveCapture()">Save to API</button>
              <button class="btn btn-sm" onclick="plClearResult()">New</button>
            </div>
          </div>
          <div id="pl-transcript-box" style="display:none;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:3px;margin-bottom:8px;font-size:10px;color:var(--text-muted);max-height:80px;overflow-y:auto">
            <div style="font-size:8px;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);margin-bottom:4px">Transcript</div>
            <div id="pl-transcript-text"></div>
          </div>
          <div id="pl-synthesis-text" style="font-size:12px;line-height:1.6;white-space:pre-wrap"></div>
          <div id="pl-result-stats" style="margin-top:8px;font-size:9px;color:var(--text-muted);font-family:var(--mono)"></div>
        </div>
        <div id="pl-history" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:6px">
            <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted)">Pipeline History</span>
            <input type="text" id="pl-history-search" placeholder="Search history..." oninput="plLoadHistory()" style="flex:1;max-width:200px;font-size:9px;padding:3px 6px">
            <button class="btn btn-sm btn-ghost btn-danger" onclick="if(confirm('Clear all pipeline history?')){S.pipelineHistory=[];save();plLoadHistory();toast('Cleared');}" style="font-size:8px;padding:1px 6px">Clear all</button>
          </div>
          <div id="pl-history-list"></div>
        </div>
      </div>
    </div>

    <!-- REPOS -->
    <div class="panel" id="panel-repos">
      <div style="padding:16px 20px 0;flex-shrink:0">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap">
          <span style="font-size:13px;font-weight:600;letter-spacing:0.02em">Connected Repos</span>
          <span id="repos-count" style="font-size:9px;color:var(--text-muted);font-family:var(--mono)">0</span>
          <span style="flex:1"></span>
          <input type="text" id="repo-search" placeholder="Filter repos..." oninput="reposRefresh()" style="width:120px;font-size:10px;padding:5px 8px">
          <select id="repo-sort" onchange="reposRefresh()" style="font-size:9px;padding:3px 6px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-secondary);border-radius:4px"><option value="name">Name</option><option value="status">Status</option><option value="updated">Updated</option><option value="role">Role</option></select>
          <button class="btn btn-primary btn-sm" onclick="openRepoModal()">+ Add</button>
          <button class="btn btn-sm" onclick="(S.repos||[]).filter(r=>r.live).forEach(r=>window.open(r.live,'_blank'));toast('Opened '+((S.repos||[]).filter(r=>r.live).length)+' live sites')" title="Open all live URLs">Open All</button>
          <button class="btn btn-sm" onclick="repoHealthCheck()" title="Ping all live URLs">Health Check</button>
          <button class="btn btn-sm" onclick="reposRefresh()">Refresh</button>
        </div>
      </div>
      <div class="content-area" style="padding:0 20px 20px">
        <div id="repos-grid" style="display:grid;gap:8px"></div>
      </div>
    </div>
  </main>
  <div class="project-resize-handle" id="project-resize-handle"></div>
  <!-- PROJECT VIEW — right panel inside grid -->
  <div class="project-view" id="panel-project">
      <div class="project-header">
        <div class="proj-icon-lg" id="proj-header-icon"></div>
        <span class="project-header-name" id="proj-header-name"></span>
        <span class="badge" id="proj-header-status"></span>
        <div id="proj-stats-bar" style="display:flex;gap:12px;margin-left:auto;margin-right:12px"></div>
        <div class="project-header-actions">
          <button class="btn btn-sm" onclick="editProject()">Edit</button>
          <button class="btn btn-sm" onclick="showExportMenu(event)" title="Export project">Export</button>
          <button class="btn btn-sm btn-danger" onclick="archiveProject()">Archive</button>
          <button class="btn btn-sm" onclick="closeProjectPanel()" title="Close panel" style="font-size:14px;padding:2px 6px">x</button>
        </div>
      </div>
      <div class="project-tabs" id="proj-tabs">
        <button class="project-tab active" onclick="setProjTab('instructions',this)">Instructions</button>
        <button class="project-tab" onclick="setProjTab('docs',this)">Living Docs</button>
        <button class="project-tab" onclick="setProjTab('kb',this)">Knowledge Base</button>
        <button class="project-tab" onclick="setProjTab('proj-tasks',this)">Tasks</button>
        <button class="project-tab" onclick="setProjTab('proj-links',this)">Links</button>
      </div>
      <div class="project-content" id="proj-content">
        <!-- Instructions -->
        <div id="proj-panel-instructions" class="proj-tab-panel">
          <div class="proj-instructions-editor" id="proj-instructions-editor" contenteditable="true" oninput="onProjInstructionsChange()"></div>
        </div>
        <!-- Living Docs -->
        <div id="proj-panel-docs" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="newProjLivingDoc()">+ New Living Doc</button>
          </div>
          <div class="proj-docs-grid" id="proj-docs-grid"></div>
        </div>
        <!-- Knowledge Base -->
        <div id="proj-panel-kb" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="openKBModal()">+ Add Item</button>
            <input type="text" id="kb-search" placeholder="Search knowledge base..." oninput="renderKB()" style="width:200px;font-size:10px;padding:5px 8px">
          </div>
          <div class="kb-grid" id="kb-grid"></div>
        </div>
        <!-- Tasks -->
        <div id="proj-panel-proj-tasks" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="addProjTask()">+ Task</button>
          </div>
          <div id="proj-task-rows"></div>
        </div>
        <!-- Links -->
        <div id="proj-panel-proj-links" class="proj-tab-panel" style="display:none">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <button class="btn btn-primary btn-sm" onclick="openProjLinkModal()">+ Add Link</button>
          </div>
          <div class="links-grid" id="proj-links-grid"></div>
        </div>
      </div>
    <div class="project-collapse-chevron" onclick="closeProjectPanel()" title="Collapse panel">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
    </div>
    </div>
  <!-- CONTEXT PANEL -->
  <div class="context-resize" id="context-resize"></div>
  <div class="context-panel" id="context-panel">
    <div class="context-header">
      <span class="context-header-title">Context</span>
      <button class="context-close" onclick="toggleContextPanel()" title="Close">x</button>
    </div>
    <div class="context-body" id="context-body">
      <div class="context-section">
        <div class="context-section-title">Focus Timer</div>
        <div class="focus-timer-panel" id="focus-timer-embed">
          <div class="ft-circle-wrap">
            <svg class="ft-circle" viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="70" class="ft-track"/>
              <circle cx="80" cy="80" r="70" class="ft-progress" id="ft-progress"/>
            </svg>
            <div class="ft-display">
              <div class="ft-time" id="ft-time">25:00</div>
              <div class="ft-label" id="ft-label">Writing</div>
            </div>
          </div>
          <div class="ft-controls">
            <button class="ft-btn" id="ft-btn" onclick="ftToggle()">Start</button>
            <button class="ft-btn" onclick="ftReset()">Reset</button>
          </div>
          <div class="ft-time-adjust" id="ft-time-adjust">
            <button class="ft-adj-btn" onclick="ftAdjust(-5)">-</button>
            <span style="font-size:11px;color:var(--text-muted);font-family:var(--mono)" id="ft-duration-label">25 min</span>
            <button class="ft-adj-btn" onclick="ftAdjust(5)">+</button>
          </div>
          <div class="ft-categories">
            <span class="ft-cat active" onclick="ftSetCat(this,'Writing','#4ade80')">Writing</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Training','#FF6B6B')">Training</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Meditation','#50E3C2')">Meditation</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Breath','#9013FE')">Breath</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Free Flow','#FFD93D')">Free Flow</span>
            <span class="ft-cat" onclick="ftSetCat(this,'Code','#22d3ee')">Code</span>
          </div>
        </div>
      </div>
      <div class="context-section" id="ctx-related">
        <div class="context-section-title">Related Items</div>
        <div id="ctx-related-items" style="font-size:10px;color:var(--text-muted);padding:8px 0">Select an item to see related content</div>
      </div>
      <div class="context-section" id="ctx-graph">
        <div class="context-section-title">Knowledge Graph</div>
        <canvas id="ctx-graph-canvas" width="280" height="160" style="width:100%;height:160px;border-radius:var(--radius);background:var(--bg-surface);border:1px solid var(--border);cursor:grab"></canvas>
      </div>
      <div class="context-section" id="ctx-quick-actions">
        <div class="context-section-title">Quick Actions</div>
        <div class="context-item" onclick="openContentModal()"><span class="context-item-icon">+</span>Add Content</div>
        <div class="context-item" onclick="addTask()"><span class="context-item-icon">+</span>Add Task</div>
        <div class="context-item" onclick="newDoc()"><span class="context-item-icon">+</span>New Document</div>
        <div class="context-item" onclick="openLinkModal()"><span class="context-item-icon">+</span>Add Link</div>
        <div class="context-item" onclick="openNewProjectModal()"><span class="context-item-icon">+</span>New Project</div>
      </div>
      <div class="context-section">
        <div class="context-section-title">Stats</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px" id="ctx-stats">
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-tasks">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Active Tasks</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-docs">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Documents</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-projects">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Projects</div>
          </div>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px">
            <div style="font-size:16px;font-weight:700;color:var(--text)" id="ctx-stat-kb">0</div>
            <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">KB Items</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div><!-- /app -->

<!-- SHORTCUTS HELP -->
<div class="modal-overlay" id="shortcuts-modal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" style="width:480px">
    <div class="modal-title">Keyboard Shortcuts</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:11px">
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:8px">Navigation</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Command Palette</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+K</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Content</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+1</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Tasks</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+2</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Calendar</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+3</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Writing Hub</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+4</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Living Docs</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+5</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Links</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+6</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Whiteboard</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+7</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Pipeline</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+8</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Repos</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+9</span></div>
      </div>
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:8px">Actions</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>New Item</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>New Task (anywhere)</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+T</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Quick Capture</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Toggle Sidebar</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+B</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Context Panel</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+E</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Focus Mode</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+\</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Save / Sync</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+S</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Zen Writer</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+W</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Today View</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+D</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Focus Mode</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+F</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Close/Escape</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Esc</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Export Section</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+E</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Scratchpad</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+Shift+S</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Show Shortcuts</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">Cmd+/</span></div>
        <div style="font-weight:600;color:var(--text);margin:12px 0 8px">Task Detail</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Set P0-P3</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">1-4</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Save</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">S</span></div>
        <div style="font-weight:600;color:var(--text);margin:12px 0 8px">Whiteboard</div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Select</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">V</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Hand</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">H</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Node</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">N</span></div>
        <div style="display:flex;justify-content:space-between;padding:3px 0;color:var(--text-secondary)"><span>Connect</span><span style="font-family:var(--mono);font-size:9px;color:var(--text-muted)">C</span></div>
      </div>
    </div>
    <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
      <div style="font-weight:600;color:var(--accent);margin-bottom:8px;font-size:11px">Cmd+K Prefixes</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px 12px;font-size:10px;color:var(--text-muted)">
        <span>focus: — Timer</span><span>chart: — Pie charts</span><span>export: — Export hub</span>
        <span>tpl: — Task templates</span><span>review: — Stale items</span><span>writerstats — Doc stats</span>
        <span>goal: — Goal tracker</span><span>habit: — Habit tracker</span><span>wb: — WB search</span>
        <span>log: — Activity log</span><span>config: — Settings</span><span>wordgoal: — Word goals</span>
        <span>deps: — Dependencies</span><span>standup — Daily brief</span><span>random: — Inspiration</span>
        <span>task: — Quick task</span><span>note: — Quick content</span><span>count: — Data counts</span>
      </div>
    </div>
  </div>
</div>

<!-- COMMAND PALETTE -->
<div class="cmd-overlay" id="cmd-overlay" onclick="if(event.target===this)closeCommandPalette()">
  <div class="cmd-box">
    <div class="cmd-input-wrap">
      <span class="cmd-input-icon">></span>
      <input type="text" class="cmd-input" id="cmd-input" placeholder="Search everything... sections, projects, tasks, docs" oninput="cmdSearch()" onkeydown="cmdKeydown(event)" autocomplete="off" spellcheck="false">
      <span class="cmd-hint">ESC to close</span>
    </div>
    <div class="cmd-results" id="cmd-results"></div>
    <div class="cmd-footer">
      <span><span class="cmd-key">Enter</span> select</span>
      <span><span class="cmd-key">Up</span><span class="cmd-key">Down</span> navigate</span>
      <span><span class="cmd-key">Esc</span> close</span>
    </div>
  </div>
</div>

<!-- CONTENT MODAL -->
<div class="modal-overlay" id="content-modal">
  <div class="modal">
    <div class="modal-title" id="content-modal-title">Add Content</div>
    <div class="form-group"><label class="form-label">Type</label><select id="cm-type"><option value="caption">Caption</option><option value="quote">Quote</option></select></div>
    <div class="form-group"><label class="form-label">Theme</label><input type="text" id="cm-theme" placeholder="discipline, growth, healing..."></div>
    <div class="form-group"><label class="form-label">Content</label><textarea id="cm-body" rows="8" placeholder="Paste from Apple Notes..."></textarea></div>
    <div class="form-group"><label class="form-label">Source (optional)</label><input type="text" id="cm-source" placeholder="Apple Notes #Captions"></div>
    <div class="form-group"><label class="form-label">Tags (comma separated)</label><input type="text" id="cm-tags" placeholder="training, mindset, content"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeContentModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveContent()">Save</button>
    </div>
  </div>
</div>

<!-- LINK MODAL -->
<div class="modal-overlay" id="link-modal">
  <div class="modal">
    <div class="modal-title" id="link-modal-title">Add Link</div>
    <div class="form-group"><label class="form-label">Title</label><input type="text" id="lm-title" placeholder="Saturno Vault"></div>
    <div class="form-group"><label class="form-label">URL</label><div style="display:flex;gap:4px"><input type="text" id="lm-url" placeholder="https://..." onblur="suggestLinkTitle();suggestLinkCategory()" style="flex:1"><button class="btn btn-sm btn-ghost" onclick="fetchLinkTitle()" style="font-size:9px;white-space:nowrap" type="button">Fetch Title</button></div></div>
    <div class="form-group"><label class="form-label">Category</label><input type="text" id="lm-category" placeholder="deployment, repo, tool"></div>
    <div class="form-group"><label class="form-label">Description</label><input type="text" id="lm-desc" placeholder="Short description"></div>
    <div class="form-group"><label class="form-label">Project (optional)</label><select id="lm-project"><option value="">None</option></select></div>
    <div class="form-group"><label class="form-label">Tags (comma-separated)</label><input type="text" id="lm-tags" placeholder="api, design, reference"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeLinkModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveLink()">Save</button>
    </div>
  </div>
</div>

<!-- TEMPLATE MODAL -->
<div class="wb-tpl-modal" id="wb-tpl-modal" onclick="if(event.target===this)closeTplModal()">
  <div class="modal" style="width:720px;max-width:95vw">
    <div class="modal-title">Choose Template</div>
    <div class="wb-tpl-grid" id="wb-tpl-grid"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" onclick="closeTplModal()">Cancel</button></div>
  </div>
</div>

<!-- PROJECT MODAL -->
<div class="modal-overlay" id="project-modal" onclick="if(event.target===this)closeProjectModal()">
  <div class="modal" style="width:480px">
    <div class="modal-title" id="project-modal-title">New Project</div>
    <div class="form-group">
      <label class="form-label">Project Name</label>
      <input type="text" id="pm-name" placeholder="Saturno Bonus">
    </div>
    <div class="form-group">
      <label class="form-label">Icon</label>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="pm-icon-preview" style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--bg-elevated);border-radius:var(--radius);border:1px solid var(--border);cursor:pointer" onclick="openIconPicker()"></div>
        <button class="btn btn-sm" onclick="openIconPicker()">Choose Icon</button>
        <input type="hidden" id="pm-icon" value="folder">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <select id="pm-status">
        <option value="active">Active</option>
        <option value="paused">Paused</option>
        <option value="complete">Complete</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Color Accent</label>
      <div style="display:flex;gap:6px" id="pm-colors">
        <div class="pm-color-opt" style="background:#4ade80" onclick="setPmColor('#4ade80')" data-color="#4ade80"></div>
        <div class="pm-color-opt" style="background:#8b5cf6" onclick="setPmColor('#8b5cf6')" data-color="#8b5cf6"></div>
        <div class="pm-color-opt" style="background:#3b82f6" onclick="setPmColor('#3b82f6')" data-color="#3b82f6"></div>
        <div class="pm-color-opt" style="background:#06b6d4" onclick="setPmColor('#06b6d4')" data-color="#06b6d4"></div>
        <div class="pm-color-opt" style="background:#f59e0b" onclick="setPmColor('#f59e0b')" data-color="#f59e0b"></div>
        <div class="pm-color-opt" style="background:#ec4899" onclick="setPmColor('#ec4899')" data-color="#ec4899"></div>
        <div class="pm-color-opt" style="background:#ef4444" onclick="setPmColor('#ef4444')" data-color="#ef4444"></div>
        <div class="pm-color-opt" style="background:#f97316" onclick="setPmColor('#f97316')" data-color="#f97316"></div>
      </div>
      <input type="hidden" id="pm-color" value="#4ade80">
    </div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeProjectModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProject()">Save</button>
    </div>
  </div>
</div>

<!-- REPO MODAL -->
<div class="modal-overlay" id="repo-modal" onclick="if(event.target===this)closeRepoModal()">
  <div class="modal" style="width:420px">
    <div class="modal-title" id="repo-modal-title">Add Repo</div>
    <div class="form-group"><label class="form-label">Name</label><input type="text" id="rm-name" placeholder="my-repo"></div>
    <div class="form-group"><label class="form-label">GitHub URL</label><input type="text" id="rm-github" placeholder="https://github.com/user/repo"></div>
    <div class="form-group"><label class="form-label">Live URL (optional)</label><input type="text" id="rm-live" placeholder="https://my-app.vercel.app"></div>
    <div class="form-group"><label class="form-label">Role</label>
      <select id="rm-role"><option value="backend-hub">Backend Hub</option><option value="customer-facing">Customer Facing</option><option value="internal-tools">Internal Tools</option><option value="experience">Experience</option><option value="extension">Extension</option><option value="library">Library</option><option value="other">Other</option></select>
    </div>
    <div class="form-group"><label class="form-label">Status</label>
      <select id="rm-status"><option value="active">Active</option><option value="complete">Complete</option><option value="archived">Archived</option></select>
    </div>
    <div class="form-group"><label class="form-label">Description</label><textarea id="rm-desc" rows="3" placeholder="What this repo does..."></textarea></div>
    <div class="form-group"><label class="form-label">Notes</label><input type="text" id="rm-notes" placeholder="Quick notes, reminders..."></div>
    <div class="form-group"><label class="form-label">Last Commit</label><input type="text" id="rm-lastcommit" placeholder="e.g. feat: added new feature"></div>
    <div class="form-group"><label class="form-label">Tech Stack</label><input type="text" id="rm-stack" placeholder="HTML, JS, Vercel, Node (comma-separated)"></div>
    <div class="form-group"><label class="form-label">Last Deploy</label><input type="date" id="rm-deploy"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeRepoModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveRepo()">Save</button>
    </div>
  </div>
</div>

<!-- ICON PICKER MODAL -->
<div class="icon-picker-modal" id="icon-picker-modal" onclick="if(event.target===this)closeIconPicker()">
  <div class="modal" style="width:400px">
    <div class="modal-title">Choose Icon</div>
    <div class="icon-picker-grid" id="icon-picker-grid"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" onclick="closeIconPicker()">Done</button></div>
  </div>
</div>

<!-- KB MODAL -->
<div class="modal-overlay" id="kb-modal" onclick="if(event.target===this)closeKBModal()">
  <div class="modal" style="width:500px">
    <div class="modal-title" id="kb-modal-title">Add to Knowledge Base</div>
    <div class="kb-modal-tabs">
      <button class="kb-modal-tab active" onclick="setKBModalTab('text',this)">Text / Markdown</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('file',this)">File Reference</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('url',this)">URL</button>
      <button class="kb-modal-tab" onclick="setKBModalTab('image',this)">Image</button>
    </div>
    <div class="kb-modal-panel active" id="kb-panel-text">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-text-name" placeholder="Design Specs"></div>
      <div class="form-group"><label class="form-label">Content</label><textarea id="kbm-text-content" rows="8" placeholder="Paste markdown or plain text..." style="font-family:var(--mono);font-size:11px"></textarea></div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-file">
      <div class="form-group"><label class="form-label">File Name</label><input type="text" id="kbm-file-name" placeholder="Visual Branding.pdf"></div>
      <div class="form-group"><label class="form-label">File Path</label><input type="text" id="kbm-file-path" placeholder="~/Downloads/Visual Branding.pdf"></div>
      <div class="form-group"><label class="form-label">File Type</label>
        <select id="kbm-file-type"><option value="pdf">PDF</option><option value="img">Image</option><option value="json">JSON</option><option value="other">Other</option></select>
      </div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-url">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-url-name" placeholder="Saturno Movement"></div>
      <div class="form-group"><label class="form-label">URL</label><input type="text" id="kbm-url-url" placeholder="https://saturnomovement.com"></div>
    </div>
    <div class="kb-modal-panel" id="kb-panel-image">
      <div class="form-group"><label class="form-label">Name</label><input type="text" id="kbm-img-name" placeholder="Gate Screenshot"></div>
      <div class="form-group"><label class="form-label">Paste image or drop file</label>
        <div id="kbm-img-drop" style="border:2px dashed var(--border);border-radius:var(--radius);padding:30px;text-align:center;color:var(--text-muted);font-size:11px;cursor:pointer;transition:all 0.15s" onclick="document.getElementById('kbm-img-input').click()">
          Click or paste (Ctrl+V) an image here
          <input type="file" id="kbm-img-input" accept="image/*" style="display:none" onchange="handleKBImageFile(this)">
        </div>
        <div id="kbm-img-preview" style="display:none;margin-top:8px"><img id="kbm-img-preview-img" style="max-width:100%;max-height:150px;border-radius:var(--radius);border:1px solid var(--border)"></div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Description</label><input type="text" id="kbm-desc" placeholder="Brief description of this item"></div>
    <div class="form-group"><label class="form-label">Tags (comma-separated)</label><input type="text" id="kbm-tags" placeholder="design, branding, specs"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end">
      <button class="btn" onclick="closeKBModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveKBItem()">Save</button>
    </div>
  </div>
</div>

<!-- KB VIEWER MODAL -->
<div class="modal-overlay" id="kb-viewer-modal" onclick="if(event.target===this)closeKBViewer()">
  <div class="modal" style="width:640px;max-height:85vh">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
      <span class="kb-card-type" id="kbv-type"></span>
      <span style="font-size:14px;font-weight:600;color:var(--text);flex:1" id="kbv-name"></span>
      <button class="btn btn-sm" onclick="editKBItem()">Edit</button>
      <button class="btn btn-sm btn-danger" onclick="deleteKBItem()">Delete</button>
      <button class="btn btn-sm" onclick="closeKBViewer()">Close</button>
    </div>
    <div id="kbv-desc" style="font-size:11px;color:var(--text-secondary);margin-bottom:12px"></div>
    <div id="kbv-content" style="font-size:13px;line-height:1.7;color:var(--text-secondary);max-height:60vh;overflow-y:auto;white-space:pre-wrap;font-family:var(--mono);background:var(--bg-surface);padding:14px;border-radius:var(--radius);border:1px solid var(--border)"></div>
    <div id="kbv-image" style="display:none;text-align:center;margin-top:12px"><img id="kbv-image-img" style="max-width:100%;max-height:50vh;border-radius:var(--radius)"></div>
    <div id="kbv-path" style="display:none;margin-top:12px;font-family:var(--mono);font-size:10px;color:var(--text-muted)"></div>
    <div id="kbv-tags" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:12px"></div>
  </div>
</div>

<!-- QUICK CAPTURE -->
<div id="quick-capture" style="position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:500px;max-width:90vw;z-index:500;display:none;transition:transform 0.2s ease,opacity 0.2s ease;opacity:0">
  <div style="background:linear-gradient(135deg, rgba(16,16,20,0.98) 0%, rgba(22,22,25,0.98) 100%);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.06);border-bottom:none;border-radius:var(--radius-lg) var(--radius-lg) 0 0;padding:10px 14px;box-shadow:0 -8px 32px rgba(0,0,0,0.5)">
    <div style="display:flex;align-items:center;gap:8px">
      <select id="qc-type" style="width:auto;font-size:9px;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary)">
        <option value="task">Task</option>
        <option value="content">Content</option>
        <option value="link">Link</option>
        <option value="note">Quick Note</option>
      </select>
      <input type="text" id="qc-input" placeholder="Quick capture... (Cmd+Shift+N)" style="flex:1;font-size:12px;padding:8px 10px;border-radius:6px;background:var(--bg-input);border:1px solid var(--border)" onkeydown="if(event.key==='Enter'){qcSubmit();event.preventDefault();}if(event.key==='Escape')qcClose();" oninput="qcAutoType(this.value)">
      <button class="btn btn-primary btn-sm" onclick="qcSubmit()" style="padding:6px 12px">Add</button>
      <button class="btn btn-sm btn-ghost" onclick="qcClose()" style="font-size:12px">x</button>
    </div>
  </div>
</div>

<!-- ZEN WRITER — Full-screen writing environment (Cmd+Shift+W or FAB) -->
<div class="zen-writer" id="zen-writer">
  <div class="zen-writer-topbar">
    <select class="zen-doc-picker" id="zen-doc-picker" onchange="zenPickDoc(this.value)"></select>
    <button class="zen-tb" onclick="zenNewDoc()" title="New Document" style="font-size:11px;width:auto;padding:0 8px;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> New</button>
    <div class="zen-toolbar">
      <select class="zen-tb-select" id="zen-block-type" onchange="zenExecBlock(this.value)">
        <option value="p">Paragraph</option>
        <option value="h1">Heading 1</option>
        <option value="h2">Heading 2</option>
        <option value="h3">Heading 3</option>
        <option value="blockquote">Quote</option>
        <option value="pre">Code Block</option>
      </select>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenCmd('bold')" title="Bold (Cmd+B)"><b>B</b></button>
      <button class="zen-tb" onclick="zenCmd('italic')" title="Italic (Cmd+I)"><i>I</i></button>
      <button class="zen-tb" onclick="zenCmd('underline')" title="Underline (Cmd+U)"><u>U</u></button>
      <button class="zen-tb" onclick="zenCmd('strikeThrough')" title="Strikethrough"><s>S</s></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenCmd('insertUnorderedList')" title="Bullet List"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('insertOrderedList')" title="Numbered List"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 6h11M10 12h11M10 18h11M3 5v3h2M4 8H3M5 18H3l2-3H3"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('indent')" title="Indent"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8l4 4-4 4M12 4h9M12 12h9M12 20h9"/></svg></button>
      <button class="zen-tb" onclick="zenCmd('outdent')" title="Outdent"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 8L3 12l4 4M12 4h9M12 12h9M12 20h9"/></svg></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenInsertLink()" title="Insert Link"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></button>
      <button class="zen-tb" onclick="zenInsertHR()" title="Horizontal Rule"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg></button>
      <button class="zen-tb" onclick="zenInsertCode()" title="Inline Code"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg></button>
      <div class="zen-tb-sep"></div>
      <button class="zen-tb" onclick="zenClearFormat()" title="Clear Formatting"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg></button>
    </div>
    <button class="zen-tb" onclick="zenSaveVersion()" title="Save Version (Cmd+S)" style="font-size:10px;width:auto;padding:0 8px;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><path d="M17 21v-8H7v8M7 3v5h8"/></svg> Save</button>
    <select class="zen-tb-select" id="zen-export-sel" onchange="zenExport(this.value);this.selectedIndex=0">
      <option value="">Export</option>
      <option value="md">Markdown</option>
      <option value="html">HTML</option>
      <option value="txt">Plain Text</option>
      <option value="clipboard">Copy All</option>
    </select>
    <button class="zen-close-btn" onclick="zenClose()" title="Close (Esc)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
  </div>
  <div class="zen-body">
    <input type="text" class="zen-title" id="zen-title" placeholder="Untitled Document" oninput="zenOnChange()">
    <div class="zen-editor" id="zen-editor" contenteditable="true" data-placeholder="Start writing..." oninput="zenOnChange()" onkeydown="zenKeydown(event)"></div>
  </div>
  <div class="zen-statusbar">
    <span id="zen-words">0 words</span>
    <span id="zen-chars">0 chars</span>
    <span id="zen-reading">0 min read</span>
    <span id="zen-goal" style="cursor:pointer" onclick="zenSetGoal()" title="Set word goal"></span>
    <span id="zen-saved" style="margin-left:auto">Saved</span>
  </div>
</div>

<!-- Floating Write Button -->
<button class="zen-fab" id="zen-fab" onclick="zenOpen()" title="Open Writer (Cmd+Shift+W)">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
</button>
<!-- Floating Quick Note Button -->
<button class="zen-fab" onclick="toggleQuickNote()" title="Quick Note" style="left:20px;right:auto;bottom:20px;background:linear-gradient(135deg,rgba(34,211,238,0.15) 0%,rgba(74,222,128,0.1) 100%);border-color:rgba(34,211,238,0.25);color:#22d3ee">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<!-- Task Detail Modal -->
<div class="task-detail-modal" id="task-detail-modal" onclick="if(event.target===this)closeTaskDetail()">
  <div class="task-detail-inner">
    <h3 id="td-heading">Task Details</h3>
    <div class="td-field"><label>Title</label><input type="text" id="td-title" placeholder="Task title..."></div>
    <div class="td-field"><label>Description</label><textarea id="td-desc" placeholder="Add details, notes, context..."></textarea></div>
    <div class="td-field-row">
      <div class="td-field"><label>Status</label><select id="td-status"><option value="todo">To Do</option><option value="progress">In Progress</option><option value="done">Done</option><option value="blocked">Blocked</option></select></div>
      <div class="td-field"><label>Priority</label><select id="td-priority"><option value="p0">P0 Critical</option><option value="p1">P1 High</option><option value="p2">P2 Medium</option><option value="p3">P3 Low</option></select></div>
    </div>
    <div class="td-field-row">
      <div class="td-field"><label>Project</label><input type="text" id="td-project" placeholder="Project name..." list="pdl"></div>
      <div class="td-field"><label>Due Date</label><input type="date" id="td-due"><div style="display:flex;gap:3px;margin-top:3px"><button class="btn btn-sm btn-ghost" onclick="tdSetDue(0)" style="font-size:8px;padding:1px 5px">Today</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(1)" style="font-size:8px;padding:1px 5px">Tmrw</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(7)" style="font-size:8px;padding:1px 5px">+1W</button><button class="btn btn-sm btn-ghost" onclick="tdSetDue(30)" style="font-size:8px;padding:1px 5px">+1M</button><button class="btn btn-sm btn-ghost" onclick="document.getElementById('td-due').value=''" style="font-size:8px;padding:1px 5px;color:var(--red)">Clear</button></div><input type="text" id="td-due-natural" placeholder="or type: friday, 3d, next week..." style="font-size:9px;padding:3px 6px;margin-top:3px;width:100%;border:1px solid var(--border);border-radius:4px;background:var(--bg-input);color:var(--text-secondary)" onkeydown="if(event.key==='Enter'){const v=parseNaturalDate(this.value);if(v&&v!==this.value){document.getElementById('td-due').value=v;this.value='';toast('Due: '+v);}event.preventDefault();}"></div>
    </div>
    <div class="td-field-row">
      <div class="td-field"><label>Recurrence</label><select id="td-recur"><option value="">None</option><option value="daily">Daily</option><option value="weekday">Weekdays</option><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option></select></div>
      <div class="td-field"><label>Estimate</label><input type="text" id="td-estimate" placeholder="e.g. 30m, 2h, 1d" style="font-size:10px"></div>
    </div>
    <div style="display:flex;gap:8px;font-size:9px;color:var(--text-muted);padding:2px 0"><span id="td-recur-info"></span></div>
    <div class="td-field-row">
      <div class="td-field"><label>Blocked By</label><input type="text" id="td-blocked-by" placeholder="Task name..." style="font-size:10px"></div>
    </div>
    <div class="td-field"><label>Tags</label><div id="td-tags" style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;min-height:24px"></div></div>
    <div class="td-field">
      <label id="td-subtasks-label">Subtasks</label>
      <div class="td-subtasks" id="td-subtasks"></div>
      <div class="td-add-subtask" onclick="addSubtaskInModal()">+ Add subtask</div>
    </div>
    <div class="td-field"><label>Notes <span id="td-notes-count" style="font-size:8px;color:var(--text-muted);font-weight:400"></span></label><textarea id="td-notes" placeholder="Quick notes, decisions, updates..." style="min-height:40px;font-size:10px;resize:vertical"></textarea></div>
    <div class="td-field"><label>Color Labels</label><div id="td-labels" style="display:flex;gap:4px;flex-wrap:wrap"></div></div>
    <div class="td-created" id="td-created"></div>
    <div id="td-log" style="margin-top:8px"></div>
    <div class="td-footer">
      <button class="btn btn-primary btn-sm" onclick="saveTaskDetail()">Save</button>
      <button class="btn btn-sm" onclick="closeTaskDetail()">Cancel</button>
      <button class="btn btn-sm" onclick="duplicateTask()">Duplicate</button>
      <button class="btn btn-sm" onclick="taskToContent()" title="Save task details as content">To Content</button>
      <button class="btn btn-sm" onclick="taskToSpec()" title="Create Living Doc from task">To Spec</button>
      <button class="btn btn-sm" onclick="taskToDoc()" title="Create Writer doc from task">To Doc</button>
      <button class="btn btn-sm" id="td-timer-btn" onclick="toggleTaskTimer()" title="Start/stop time tracking"></button>
      <button class="btn btn-sm" onclick="ftStartForTask(taskDetailId)" title="Start 25min focus timer for this task" style="color:var(--accent)">Focus</button>
      <button class="btn btn-sm" id="td-unblock-btn" onclick="unblockTask()" title="Clear blocked-by and set to todo" style="display:none;color:var(--orange)">Unblock</button>
      <button class="btn btn-sm" onclick="copyTaskAsMarkdown()" title="Copy task as markdown">Copy MD</button>
      <button class="btn btn-sm" onclick="snoozeTask(1)" title="Push due date +1 day" style="color:var(--yellow)">+1d</button>
      <button class="btn btn-sm" onclick="snoozeTask(7)" title="Push due date +1 week" style="color:var(--yellow)">+1w</button>
      <button class="btn btn-sm" onclick="cloneTaskToProject()" title="Clone task to another project" style="color:var(--accent-cyan)">Clone</button>
      <button class="btn btn-sm" onclick="splitTaskSubtasks()" title="Convert subtasks into separate tasks">Split</button>
      <button class="btn btn-sm btn-danger" onclick="deleteTaskFromDetail()" style="margin-left:auto">Delete</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
// === STATE ===
const SK = 'saturno-private-hub';
let S = { content:[], tasks:[], links:[], docs:[], specs:[], activeDoc:null, activeSpec:null, whiteboard:{}, projects:[], knowledgeBase:[], folders:[] };
let currentSection = 'content';
let contentType = 'all', contentTheme = 'all', contentTagFilter = null;
let taskView = 'list', taskFilter = 'all', taskProjectFilter = null;
let linkCategory = 'all';
let editingContentId = null, editingLinkId = null;
let writerTimer = null, specTimer = null, writerPanelOpen = false, writerAutoBackupTimer = null, writerSessionStart = {};
let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
let calView = 'month'; // 'month' or 'week'
let calWeekStart = null; // Date object for week view start (Monday)
let calDragId = null;
let recentItems = [];
function trackRecent(type, id, title) {
  recentItems = recentItems.filter(r => !(r.type===type && r.id===id));
  recentItems.unshift({ type, id, title: title||'Untitled', time: Date.now() });
  if(recentItems.length > 10) recentItems = recentItems.slice(0, 10);
}

function load() {
  try { const s = localStorage.getItem(SK); if(s) S = { content:[], tasks:[], links:[], docs:[], specs:[], activeDoc:null, activeSpec:null, whiteboard:{}, projects:[], knowledgeBase:[], folders:[], ...JSON.parse(s) }; } catch(e){}
  if(!S.projects) S.projects = [];
  if(!S.knowledgeBase) S.knowledgeBase = [];
  if(!S.docs.length) { S.docs.push({id:Date.now(),title:'',body:'',versions:[],created:new Date().toISOString(),updated:new Date().toISOString()}); S.activeDoc=S.docs[0].id; }
  if(!S.activeDoc&&S.docs.length) S.activeDoc=S.docs[0].id;
  if(!S.specs) S.specs=[];
  if(!S.specs.length) { seedKernel(); }
  if(!S.activeSpec&&S.specs.length) S.activeSpec=S.specs[0].id;
  if(S._accentColor) document.documentElement.style.setProperty('--accent',S._accentColor);
}

function migrateV2() {
  // Add Claude Code project if it doesn't exist yet
  if(S.projects && S.projects.length && !S.projects.find(p => p.id === 'proj_claude_code')) {
    const now = new Date().toISOString();
    S.projects.push({
      id:'proj_claude_code', name:'Claude Code', icon:'terminal', status:'active', color:'#a78bfa',
      instructions:'<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div><h1>Claude Code - Session Continuity Kernel</h1><h2>Purpose</h2><p>This project is the SINGLE SOURCE OF TRUTH for every Claude Code session. Any new Claude reads this project first and knows exactly what to do without asking Gabo.</p><h2>Rules That NEVER Change</h2><ol><li>~/dev/ is canonical for ALL repos - NOT Desktop, NOT iCloud</li><li>NO DELETE - archive, never delete</li><li>Every Gabo message -> save to backend as-is (project/title/text)</li><li>Commit + deploy after EVERY meaningful change</li><li>Dark theme only, no emojis in code</li><li>Custom over SaaS, always</li><li>DO NOT ASK GABO - read the logs and specs, then execute</li></ol><h2>Active Repos</h2><table><tr><th>Repo</th><th>Local</th><th>Live</th></tr><tr><td>astra-command-center</td><td>~/dev/astra-command-center/</td><td>astra-command-center-sigma.vercel.app</td></tr><tr><td>titan-forge</td><td>~/dev/titan-forge/</td><td>titan-forge-ten.vercel.app</td></tr><tr><td>saturno-bonus</td><td>~/dev/saturno-bonus/</td><td>saturno-bonus-omega.vercel.app</td></tr><tr><td>de-aqui-a-saturno</td><td>~/dev/de-aqui-a-saturno/</td><td>de-aqui-a-saturno-jet.vercel.app</td></tr></table><h2>Machine Context</h2><ul><li>C2 iMac: username Gabosaturno (CAPITAL G)</li><li>C1 MacBook Pro: username gabosaturno (lowercase)</li><li>GitHub: gabosaturno11</li></ul><h2>Design Constraints</h2><ul><li>Pure black backgrounds (#09090b)</li><li>Mint green for ASTRA (#4ade80)</li><li>Purple accents (#8b5cf6)</li><li>Dark theme ONLY</li></ul><h2>How to Use This Project</h2><p>1. Export this project as MD (click Export button)</p><p>2. The exported MD becomes CLAUDE.md in repo root</p><p>3. Next Claude Code session reads it automatically</p><p>4. Update KB items below as state changes</p>',
      created:now, updated:now
    });
    S.knowledgeBase.push(
      { id:'kb_cc_session_log', projectId:'proj_claude_code', name:'Session Log - Feb 16, 2026', type:'md', storage:'inline',
        content:'# Session Log — Feb 16, 2026 (LATEST)\n\n## Batch 1 (Commit 1e98d43):\nHide internal tools, fix auth, fix alerts, add auto-advance, add lock vault, coming soon section, BONUS PDF badges\n\n## Batch 2 (Commit 86dd606):\nRewrite ALL tool descriptions, categorize Training vs Experience, fix music case bug, fix gate og:image, create .env.example\n\n## Previous Session:\n- Desktop cleaned\n- Claude Code project added to ASTRA\n- Export feature added (MD, JSON, clipboard)\n- CLAUDE.md kernel placed in all repos\n- ASTRA V2 features: color tabs, mobile scroll, doc assignment, migrateV2()\n\n## Messages Backend:\n~/dev/saturno-bonus/logs/gabo-messages.json (16 messages, id 0-16)',
        description:'Current session state', tags:['session','log'], created:now, updated:now },
      { id:'kb_cc_gabo_rules', projectId:'proj_claude_code', name:'Gabo Rules (Permanent)', type:'md', storage:'inline',
        content:'# Permanent Rules\n1. ~/dev/ is canonical\n2. NO DELETE\n3. Every message -> backend\n4. Commit + deploy after EVERY change\n5. Dark theme only\n6. Custom over SaaS\n7. DO NOT ASK - execute\n8. BOOK FIRST\n9. planet-logo.png is THE logo\n10. Audio 404s on Vercel - needs CDN\n11. Brevo needs API keys in Vercel env',
        description:'Rules that never change', tags:['rules','permanent'], created:now, updated:now },
      { id:'kb_cc_messages', projectId:'proj_claude_code', name:'Messages Backend', type:'md', storage:'inline',
        content:'# Backend: ~/dev/saturno-bonus/logs/gabo-messages.json\n9 messages (id 0-8)\nRule: save EVERY message unless told otherwise',
        description:'Message log location', tags:['messages','backend'], created:now, updated:now }
    );
    save();
  }
  // Add v2.0 build summary if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_v2_build')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_v2_build', projectId:'proj_claude_code', name:'ASTRA v2.0 Build Summary — Feb 16, 2026', type:'md', storage:'inline',
        content:'# SATURNO HUB v2.0 Build Summary\n\n## Session: Feb 16, 2026\n**17 commits pushed** | 3,400 lines | 224+ functions | Single-file HTML app\n\n## New Features Built:\n\n### Architecture\n1. **3-Panel Resizable Layout** - sidebar (220px) + primary (flex) + context panel (320px)\n2. **Mode Switching** - Focus (primary only), Default, Extended (all panels)\n3. **Resizable Panels** - Drag handles on sidebar + context panel borders\n4. **Responsive Design** - Mobile sidebar, stacked layouts, adaptive breakpoints\n\n### Navigation & Search\n5. **Command Palette (Cmd+K)** - Fuzzy search across all items, sections, actions\n6. **Keyboard Shortcuts** - Cmd+1-7 sections, Cmd+N new, Cmd+E context, Cmd+\\ focus, Cmd+/ help\n7. **Breadcrumb Navigation** - Shows current doc/spec/project in header\n8. **Recent Items Tracking** - Last 10 accessed items shown in Cmd+K\n\n### Knowledge Management\n9. **Folder System** - Tree UI in sidebar, nested folders, create/rename/delete\n10. **Drag-and-Drop to Folders** - Content cards + link cards to folder tree\n11. **[[Wiki-Links]]** - Cross-referencing system with backlink engine\n12. **Mini Knowledge Graph** - Force-directed canvas visualization in context panel\n13. **Global Tagging System** - Tags on content, searchable, displayed on cards\n\n### Productivity\n14. **Focus Timer** - Pomodoro with SVG progress, categories, embedded in context\n15. **Quick Capture (Cmd+Shift+N)** - Floating bar for instant task/content/note\n16. **Today View** - Overdue/today/upcoming tasks in context panel\n17. **Writer Word Goals** - Clickable goal target in status bar\n18. **Project Progress Bars** - Task completion % per project in sidebar\n\n### Polish\n19. **SVG Sidebar Icons** - Lucide-style icons replacing letter icons\n20. **Logo Breathing Animation** - Subtle opacity animation\n21. **Glass Morphism Modals** - Backdrop blur + transparency\n22. **Auto-Save Indicator** - Flash in header on save\n23. **Sidebar Dashboard** - Mini task/docs/project counts\n24. **Smooth Panel Transitions** - Fade opacity on section switch\n25. **Endel-Inspired Theme** - Deeper blacks (#050508), refined borders\n\n## Commits:\n```\necb41f8 Today View\ne44c78e Writer word goals\n9cfdf6d Project progress bars\n4d1fd59 Quick Capture bar\n31ae7f5 Responsive design\nb84d449 Global tagging\neec1099 Sidebar dashboard + auto-save\n275f22f Drag-drop to folders\n14cedd2 Breadcrumbs + shortcuts help\nabcb1a6 Keyboard shortcuts + recent items\nea2eea5 Endel polish (SVG icons, breathe, glass)\n3eda6bc Resizable panels\n21df181 Mini knowledge graph\nd517f68 Folder tree UI\n6df5e02 Wiki-links wiring\n6470d43 Context panel related items\n```\n\n## What Still Could Be Done:\n- Unified BaseItem schema refactor\n- Task subtasks/checklists\n- Drag-drop folder reordering\n- Wiki-link rendering in contenteditable editors\n- More Endel transitions/microinteractions\n- Activity log / changelog\n- Pinned items feature',
        description:'Complete build log for the v2.0 upgrade session', tags:['v2','build-log','session','architecture'], created:now, updated:now }
    );
    save();
  }
  // Add v2.0 fix session log
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_v2_fixes')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_v2_fixes', projectId:'proj_claude_code', name:'v2.0 UX Fix Session — Feb 16, 2026 (evening)', type:'md', storage:'inline',
        content:'# v2.0 UX Fix Session — Feb 16, 2026\n\n## Critical fix: Panel resize breaking layout\n- Project panel resize was setting app.style.gridTemplateColumns as inline style\n- This permanently overrode all CSS class-based grid definitions\n- After any drag, closing panel or switching modes left broken inline style\n- FIX: Now uses --project-width CSS variable instead of inline style\n\n## Panel conflicts resolved\n- Opening a project now closes context panel (they share same grid slot)\n- Toggling context panel now closes project panel first\n- Focus mode properly closes both project and context panels\n- Extended mode closes project panel, opens context panel\n\n## Migration ordering fix\n- migrateV2() was running inside load() before seedProjects()\n- On fresh localStorage, S.projects.length was 0 so Claude Code project was never created\n- FIX: migrateV2 now runs after seedProjects()\n\n## Other fixes\n- Links added from project panel now get projectId assigned\n- Removed duplicate saveLink monkeypatch override\n- Archive project now requires confirmation dialog\n- switchSection properly highlights sidebar item when called programmatically\n- Removed dead wbCanvasDownV2 wrapper code\n- Removed conflicting explicit width on context panel CSS\n- Removed negative margins on resize handles causing misalignment\n\n## Deployment discovery\n- Live URL is astra-command-center-sigma.vercel.app\n- NOT astra-command-center.vercel.app (that is an OLD Vercel project)\n\n## Commits (7):\neccdc1f, 6fdb2f2, 955273b, 12141fe, e806f0e, 84b0b45, 804ee06',
        description:'UX bug fixes for panel resize, mode switching, migration ordering', tags:['v2','fixes','session','ux'], created:now, updated:now }
    );
    save();
  }
  // Add collapsible sidebars log
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_collapsible_panels')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_collapsible_panels', projectId:'proj_claude_code', name:'Collapsible Panels — Feb 16, 2026', type:'md', storage:'inline',
        content:'# Collapsible Panels Feature\n\n## Left Sidebar\n- Sidebar panel icon in header toggles sidebar visibility\n- Double-chevron (<<) at bottom of sidebar collapses it\n- CSS class: .app.sidebar-collapsed hides sidebar completely (0px grid column)\n- Sidebar resize handle also hidden when collapsed\n- Grid recalculates for all states: default, project-open, context-open, extended\n- Smooth transition via grid-template-columns 0.25s\n\n## Right Project Panel\n- Double-chevron (>>) at bottom of project panel to collapse/close\n- Uses existing closeProjectPanel() function\n- Minimalistic arrow design matching Claude AI reference screenshots\n\n## Implementation\n- toggleSidebar() function toggles .sidebar-collapsed class\n- CSS handles all grid states when collapsed\n- Focus mode (.mode-focus) is separate — hides sidebar via display:none\n- No conflict between collapsed state and focus mode',
        description:'Collapsible sidebar and project panel with chevron arrows', tags:['v2','ux','panels','collapsible'], created:now, updated:now }
    );
    save();
  }
  // Rename kernel spec and assign to all projects
  const kernel = S.specs.find(s => s.id === 1000);
  if(kernel && kernel.title === 'Saturno Living Canvas v2.0') {
    kernel.title = 'Saturno OS Complete Map';
    kernel.icon = 'globe';
    kernel.color = '#4ade80';
    save();
  }
  // Ensure icon/color fields on all specs
  S.specs.forEach(s => { if(!s.icon) s.icon = 'file'; if(!s.color) s.color = '#8b8b8b'; });
  // Seed per-project living docs if not present
  if(!(S.specs||[]).find(s => s.id === 'ld_bonus')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_bonus', title:'Saturno Bonus — Project Spec', projectId:'proj_saturno_bonus', icon:'rocket', color:'#4ade80',
      created:now, updated:now,
      sections:[
        {id:'ld_b1',title:'Design & Branding',icon:'palette',color:'#8b5cf6',body:'<p><b>Visual Identity:</b> Dark cosmic theme (#050711 base), teal accents (#06b6d4, #22d3ee), Sora font.</p><p><b>Logo:</b> planet-logo.png (white silhouette). Used in header, gate, footer.</p><p><b>Layout:</b> Hero + category sections + tool grid + music player + PDF cards + footer.</p><p><b>Target Feel:</b> Premium vault, exclusive access, cosmic luxury.</p>',collapsed:false},
        {id:'ld_b2',title:'Technical Architecture',icon:'cpu',color:'#22d3ee',body:'<p><b>Stack:</b> Static HTML + Vercel serverless functions. Single-page index.html (~1,800 lines).</p><p><b>Auth:</b> Cookie-based password gate (saturno2025). Redirects on auth fail.</p><p><b>API:</b> /api/verify (password), /api/brevo (email capture), /api/config (feature flags), /api/admin-verify.</p><p><b>Storage:</b> No database. PDFs/tools served as static files from bonuses/ directory.</p><p><b>Music:</b> manifest.json for track metadata. Audio files gitignored (need CDN).</p>',collapsed:false},
        {id:'ld_b3',title:'Content Inventory',icon:'layers',color:'#f59e0b',body:'<p><b>Tools (60):</b> 19 Training + 25 Experience + 16 unlisted. Each is a standalone HTML file in bonuses/tools/.</p><p><b>PDFs (15):</b> HBF phases, skill programming, routines. In pdfs/.</p><p><b>Music (36 tracks):</b> 8 categories. In audio/ (gitignored, needs CDN).</p><p><b>Video:</b> app-promo.mov needs MP4 conversion.</p>',collapsed:true},
        {id:'ld_b4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'<p><b>BLOCKER 1:</b> Domain — bonus.saturnomovement.com (Cloudflare CNAME needed by Gabo)</p><p><b>BLOCKER 2:</b> Brevo API keys not in Vercel env vars (email capture broken)</p><p><b>BLOCKER 3:</b> Audio files 404 on Vercel (gitignored + vercelignored, needs CDN solution)</p><p><b>BLOCKER 4:</b> app-promo.mov is .mov format (needs .mp4 conversion for web)</p><p><b>BLOCKER 5:</b> Physical device testing (Gabo must QA on phone/iPad)</p>',collapsed:false},
        {id:'ld_b5',title:'Roadmap & Milestones',icon:'flag',color:'#06b6d4',body:'<p><b>Phase 1 (DONE):</b> Core page live, auth, tools, PDFs, descriptions rewritten, categories sorted.</p><p><b>Phase 2 (NOW):</b> Domain setup, Brevo integration, music CDN, device QA.</p><p><b>Phase 3:</b> 100 tools, 100 PDFs, album artwork, polished footer, video embed.</p><p><b>Phase 4:</b> Analytics review, A/B test gate, referral system, subscriber dashboard.</p>',collapsed:true},
        {id:'ld_b6',title:'Links & Resources',icon:'link',color:'#a78bfa',body:'<p><b>Live:</b> <a href="https://saturno-bonus-omega.vercel.app/index.html" target="_blank">saturno-bonus-omega.vercel.app</a></p><p><b>Repo:</b> github.com/gabosaturno11/saturno-bonus</p><p><b>Gate:</b> saturno-bonus-omega.vercel.app/gate.html (password: saturno2025)</p><p><b>Vercel Dashboard:</b> vercel.com/gabosaturno</p><p><b>Cloudflare:</b> dash.cloudflare.com (saturnomovement.com)</p>',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_sm_app')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_sm_app', title:'SM App Rebuild — Project Spec', projectId:'proj_sm_app', icon:'code', color:'#8b5cf6',
      created:now, updated:now,
      sections:[
        {id:'ld_a1',title:'Architecture Overview',icon:'cpu',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_a2',title:'Developer Handoff Status',icon:'users',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_a3',title:'Tech Stack & Dependencies',icon:'layers',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_a4',title:'Blockers & Risks',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_a5',title:'Roadmap & Timeline',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_book')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_book', title:'Book (AOC) — Project Spec', projectId:'proj_book', icon:'book', color:'#f59e0b',
      created:now, updated:now,
      sections:[
        {id:'ld_k1',title:'Submission Package Status',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_k2',title:'Chapter Outline',icon:'list',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_k3',title:'Publisher Communications',icon:'mail',color:'#a78bfa',body:'',collapsed:false},
        {id:'ld_k4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_k5',title:'Timeline & Deadlines',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_hbs')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_hbs', title:'HBS Program — Project Spec', projectId:'proj_hbs', icon:'target', color:'#06b6d4',
      created:now, updated:now,
      sections:[
        {id:'ld_h1',title:'Program Structure',icon:'layers',color:'#06b6d4',body:'',collapsed:false},
        {id:'ld_h2',title:'Content Inventory',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_h3',title:'Digital Assets (SSK Drive)',icon:'hdd',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_h4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_h5',title:'Launch Plan',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_karina')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_karina', title:'De Aqui a Saturno — Project Spec', projectId:'proj_karina', icon:'heart', color:'#ec4899',
      created:now, updated:now,
      sections:[
        {id:'ld_d1',title:'Site Architecture',icon:'globe',color:'#ec4899',body:'',collapsed:false},
        {id:'ld_d2',title:'Content & Copy',icon:'file',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_d3',title:'Design System',icon:'palette',color:'#8b5cf6',body:'',collapsed:false},
        {id:'ld_d4',title:'Blockers & Dependencies',icon:'alert',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_d5',title:'Deployment & Maintenance',icon:'flag',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  if(!(S.specs||[]).find(s => s.id === 'ld_claude')) {
    const now = new Date().toISOString();
    S.specs.push({
      id:'ld_claude', title:'Claude Code — Project Spec', projectId:'proj_claude_code', icon:'terminal', color:'#a78bfa',
      created:now, updated:now,
      sections:[
        {id:'ld_c1',title:'Session Continuity Protocol',icon:'refresh',color:'#a78bfa',body:'',collapsed:false},
        {id:'ld_c2',title:'Repo & Deployment Map',icon:'globe',color:'#22d3ee',body:'',collapsed:false},
        {id:'ld_c3',title:'Kernel Rules',icon:'lock',color:'#ef4444',body:'',collapsed:false},
        {id:'ld_c4',title:'Blockers & Open Issues',icon:'alert',color:'#f59e0b',body:'',collapsed:false},
        {id:'ld_c5',title:'Session Logs',icon:'file',color:'#4ade80',body:'',collapsed:false}
      ]
    });
    save();
  }
  // Add bonus project link if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_saturno_bonus')) {
    if(!S.links.find(l => l.url === 'https://saturno-bonus-omega.vercel.app/index.html')) {
      S.links.push({id:Date.now(), title:'Saturno Bonus — Live', url:'https://saturno-bonus-omega.vercel.app/index.html', category:'Production', projectId:'proj_saturno_bonus', created:new Date().toISOString()});
      save();
    }
  }
  // Add asset catalog to Saturno Bonus if not present
  if(S.projects && S.projects.find(p => p.id === 'proj_saturno_bonus') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_bonus_assets')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_bonus_assets', projectId:'proj_saturno_bonus', name:'Asset Catalog — TBV by Gabo', type:'md', storage:'inline',
        content:'# Bonus Assets — Verified Feb 16, 2026\n\n## PDFs (15 files, ~/dev/saturno-bonus/pdfs/)\n### BONUS (green badge on page):\n- Handstand Press Program (1.5MB)\n- Press to Handstand Full Program (1.8MB)\n- Calisthenics Skills Programming Ebook (14.2MB)\n- HBF Introduction (123KB)\n- HBF Phase 1 Weeks 1-6 (30MB each, 6 files)\n### Standard (no badge):\n- 15min Front Lever, HSPU, Muscle-Up, Planche Routines\n- Mobility vs Flexibility, Move List Database, General Warmup\n\n## Tools (44 visible on index.html)\n### 19 Training Tools:\nBreathing Pacer, Supplement Tracker, Cosmic Timer, Rep Counter,\nSleep Protocol, Orbital Tracker, Nebula Breath, Core Values,\nValues Roulette, Movement Galaxy, Constellation Builder,\nProgression Pathfinder, Alien Trainer, Gravity Well, Galactic Core,\nBinary Star, Ring of Fire, Lunar Cycle, Solar Wind\n### 25 Experience Tools:\nConstellation, Galaxy Zoom, Alien Oracle, Aurora, Asteroid Belt,\nBig Bang, Black Hole, Comet Trail, Cosmic Dust, Dark Matter,\nEvent Horizon, Hyperspace, Meteor Shower, Neutron Star,\nPlasma Burst, Pulsar, Quantum Leap, Red Giant, Singularity,\nSolar Flare, Stargate, Supernova, Void Walker, White Dwarf,\nWormhole Generator\n### 3 Hidden (internal):\nTranscript to PDF, Music Organizer, Master Hub\n\n## Music (36 tracks, ~/dev/saturno-bonus/audio/)\n- Manifest: audio/manifest.json\n- 8 categories: White Universe EP, Black Universe EP, Tears of Joy,\n  Meditation/Chill, Hip Hop/Beats, Trancy, High Energy, Stingers\n- BLOCKED: Audio 404s on Vercel (gitignored)\n- All 36 MP3 files verified locally\n\n## TBV by Gabo:\n- PDF quality/branding review\n- Music album artwork\n- CDN solution for audio hosting',
        description:'Complete asset inventory for bonus vault — to be verified', tags:['assets','inventory','tbv'], created:now, updated:now },
      { id:'kb_bonus_phases', projectId:'proj_saturno_bonus', name:'Build Phases — Completion Status', type:'md', storage:'inline',
        content:'# Bonus Page Build Status — Updated Feb 16\n\n## DONE (code changes shipped):\n- 3 internal tools hidden from customers\n- Auth works on Vercel + custom domains (not just GitHub)\n- og:image absolute URL for social previews\n- Analytics production script (not debug)\n- Alert() replaced with inline feedback\n- Modal closes on overlay click\n- Music auto-advances to next track\n- Lock Vault button in footer\n- Coming Soon tease section (3 products)\n- BONUS badges on HBF and exclusive PDFs\n- 44 tool descriptions rewritten customer-quality\n- Tools categorized: 19 Training + 25 Experience\n- Case-sensitive audio path fixed\n- .env.example created\n\n## BLOCKERS (Gabo must do):\n- Set domain: bonus.saturnomovement.com\n- Add BREVO_API_KEY + BREVO_LIST_ID to Vercel\n- Audio CDN solution (files 404 on Vercel)\n- Physical device QA\n- Music album artwork\n- app-promo.mov needs MP4 conversion for embed',
        description:'Phase completion tracking', tags:['phases','status','progress'], created:now, updated:now }
    );
    save();
  }
  // Voice Pipeline + Floating Bar (Feb 17 evening)
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_voice_pipeline')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_voice_pipeline', projectId:'proj_claude_code', name:'Voice Pipeline + Floating Bar — Feb 17 Evening', type:'md', storage:'inline',
        content:'# Voice Pipeline + Floating Bar — Feb 17 Evening\n\n## /api/transcribe (NEW)\n- Receives audio blob via multipart POST\n- Sends to OpenAI Whisper API (whisper-1 model)\n- Returns { ok, text, duration, transcriptId }\n- Auto-logs to transcripts blob storage\n- Requires OPENAI_API_KEY env var (SET in .zshrc)\n- Commit: 74ddb86\n\n## ASTRA Voice Upgrade\n- Replaced Chrome SpeechRecognition with real MediaRecorder\n- Click voice btn to record mic, click again to stop\n- Audio sent to /api/transcribe (Whisper)\n- Text auto-inserts into Writer or Living Docs editor\n- Commit: 9bb30bb\n\n## Nexus Capture Extension Updates\n- Right-click > "Create Sound (TTS)" speaks selected text\n- Uses browser speechSynthesis (works offline)\n- Background handles transcribeAudio messages\n- Commit: 84a4b08\n\n## System-Wide Tools (macOS)\n- create-sound.sh: speaks clipboard text via macOS say command\n- --save flag saves .aiff audio file to ~/dev/nexus-capture/sounds/\n- "Create Sound" Quick Action installed in Services menu\n- Commit: 8228195\n\n## Floating NEXUS Bar\n- floating-bar.html: mini HTML panel with 4 buttons\n- Capture: grabs clipboard, sends to ASTRA /api/capture\n- Voice: records mic, transcribes via Whisper, copies result\n- Sound: speaks clipboard text via browser TTS\n- ASTRA: opens ASTRA hub\n- open-nexus-bar.sh: launches as Chrome app window\n- Commit: d8d8efc\n\n## PWA\n- ASTRA installable on phone (manifest.json + sw.js)\n- New planet icon with cosmic center (icon-192.png, icon-512.png)\n- Commit: c1aceea\n\n## Still Needs\n- BLOB_READ_WRITE_TOKEN in Vercel (Gabo setting up)\n- Keyboard shortcuts for Quick Actions (System Settings > Keyboard > Shortcuts > Services)\n- Test full pipeline end-to-end once blob token is set',
        description:'Voice pipeline, Whisper integration, floating bar, TTS, PWA', tags:['voice','whisper','tts','floating-bar','pipeline'], created:now, updated:now }
    );
    save();
  }
  // Add Backend + Nexus Capture session log (Feb 17)
  if(S.projects && S.projects.find(p => p.id === 'proj_claude_code') && !(S.knowledgeBase||[]).find(k => k.id === 'kb_cc_backend_session')) {
    const now = new Date().toISOString();
    S.knowledgeBase.push(
      { id:'kb_cc_backend_session', projectId:'proj_claude_code', name:'Backend + Nexus Capture Setup — Feb 17, 2026', type:'md', storage:'inline',
        content:'# ASTRA Backend + Nexus Capture — Feb 17, 2026\n\n## ASTRA Backend (NEW)\nASTRA was localStorage-only. Now has Vercel serverless API:\n- api/state.js: Save/load full workspace to Vercel Blob\n- api/transcripts.js: Log voice transcripts with searchable index\n- api/query.js: Query specs, bottlenecks, KB, tasks, projects, full-text search\n- api/capture.js: Receive captures from extension or system-wide tools\n- api/health.js: Health check endpoint\n- package.json: @vercel/blob dependency\n- vercel.json: API rewrites\n- Frontend: cloudSave(), cloudLoad(), Cmd+S syncs to cloud\n- Voice input now auto-logs transcripts to backend\n- NEEDS: BLOB_READ_WRITE_TOKEN in Vercel env vars to activate\n\n## Nexus Capture Extension (NEW REPO)\n- Repo: github.com/gabosaturno11/nexus-capture\n- Path: ~/dev/nexus-capture/\n- Chrome Manifest V3 extension\n- Highlight text on any webpage -> floating button -> categorize -> save\n- 8 categories with color coding\n- Visual highlights persist per page\n- Routes to ASTRA backend /api/capture\n- Optional Notion integration\n- Keyboard: Cmd+Shift+S\n- Right-click context menu: Capture as Idea/Quote/Code/Insight/To-Do\n- BUG FIXED: double-click issue (selection stored on mouseup now)\n\n## System-Wide Capture (macOS)\n- capture-highlight.sh: grabs clipboard/selected text, sends to ASTRA API\n- macOS Automator Quick Action: "Nexus Capture" in Services menu\n- Works from ANY app (Notes, Preview, Pages, etc.)\n- Shows macOS notification on success\n- Fallback: saves locally if API unreachable\n\n## Whisper Transcription\n- faster-whisper installed in ~/dev/.whisper-env/ (Python venv)\n- whisper-transcribe.sh: local transcription (base/small/medium/large models)\n- whisper-api-transcribe.sh: cloud transcription via OpenAI Whisper API\n- record-and-transcribe.sh: record from mic + auto-transcribe\n- All scripts can --log to ASTRA transcripts API\n- OpenAI SDK also installed for API fallback\n\n## Bonus Page\n- Password protection temporarily disabled (Gabo requested)\n- middleware.js returns next() immediately\n- index.html auth check commented out\n- Both marked TEMP for easy re-enable\n\n## Commits:\n- 5d18143: ASTRA backend (state, transcripts, query, capture APIs)\n- 7f7c435: Health check endpoint\n- b9acd53: CLAUDE.md update\n- 39743ac: nexus-capture init\n- cc81f79: Double-click bug fix\n- 9d639d0: faster-whisper, path fixes\n- 02587b3: Bonus auth disabled (temp)\n- (this commit): KB entry + final save',
        description:'Full session log: ASTRA backend, Nexus Capture extension, Whisper setup, system-wide capture', tags:['backend','nexus-capture','whisper','session','infrastructure'], created:now, updated:now }
    );
    save();
  }
  // Inject Rule #1 into Claude Code project instructions if missing
  if(S.projects) {
    const cc = S.projects.find(p => p.id === 'proj_claude_code');
    if(cc && cc.instructions && !cc.instructions.includes('CANNON LAW')) {
      cc.instructions = '<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div>' + cc.instructions;
      save();
    }
  }
  // Migrate tasks: link tasks with project name to projectId
  if(S.tasks && S.projects) {
    let migrated = 0;
    S.tasks.forEach(t => {
      if(t.project && !t.projectId) {
        const p = S.projects.find(pr => pr.name === t.project);
        if(p) { t.projectId = p.id; migrated++; }
      }
    });
    if(migrated > 0) save();
  }
  // Deduplicate specs: keep the one with more content when titles match
  if(S.specs && S.specs.length > 1) {
    const seen = {};
    const dupes = [];
    S.specs.forEach(s => {
      const key = (s.title||'').toLowerCase().trim() + '|' + (s.projectId||'');
      if(seen[key]) {
        // Keep whichever has more section body content
        const existBody = (seen[key].sections||[]).reduce((a,sec) => a + (sec.body||'').length, 0);
        const thisBody = (s.sections||[]).reduce((a,sec) => a + (sec.body||'').length, 0);
        if(thisBody > existBody) { dupes.push(seen[key].id); seen[key] = s; }
        else { dupes.push(s.id); }
      } else { seen[key] = s; }
    });
    if(dupes.length) {
      S.specs = S.specs.filter(s => !dupes.includes(s.id));
      save();
    }
  }
  // Remove "Untitled" specs that have no content
  if(S.specs) {
    const before = S.specs.length;
    S.specs = S.specs.filter(s => {
      if((s.title||'').toLowerCase().trim() === 'untitled' || !s.title) {
        const hasContent = (s.sections||[]).some(sec => (sec.body||'').trim().length > 0);
        return hasContent; // keep only if it has actual content
      }
      return true;
    });
    if(S.specs.length < before) save();
  }
  // C1 iMac Audit - Feb 19 (canonical audit template, global)
  if(S.specs && !S.specs.find(s => s.id === 'ld_c1_imac_audit_feb19')) {
    S.specs.push({
      id:'ld_c1_imac_audit_feb19', title:'C1 iMac Audit - Feb 19, 2026', projectId:'proj_claude_code', global:true, icon:'monitor', color:'#4ade80',
      created:new Date().toISOString(), updated:new Date().toISOString(),
      sections:[
        {id:'c1a_machine',title:'Machine',collapsed:false,icon:'hdd',color:'#22d3ee',body:'<table><tr><th>Field</th><th>Value</th></tr><tr><td>Machine</td><td>iMac (C2)</td></tr><tr><td>User</td><td>/Users/Gabosaturno (CAPITAL G)</td></tr><tr><td>OS</td><td>macOS Sequoia 15.5</td></tr><tr><td>Drives</td><td>G-DRIVE ArmorATD (4.5TB), SSK (477GB), T7 (NTFS read-only)</td></tr><tr><td>Session Date</td><td>Feb 19, 2026</td></tr><tr><td>Session Type</td><td>Autonomous (Gabo sleeping)</td></tr></table>'},
        {id:'c1a_git',title:'Git State',collapsed:false,icon:'code',color:'#4ade80',body:'<h3>Repo: astra-command-center</h3><table><tr><th>Hash</th><th>Message</th></tr><tr><td><code>6e4e75f</code></td><td>Pipeline history card layout + copy buttons</td></tr><tr><td><code>491fa9b</code></td><td>C1 iMac Audit living doc</td></tr><tr><td><code>084812b</code></td><td>Writer doc list sorted + seed prevention</td></tr><tr><td><code>14e2a4d</code></td><td>Mobile responsive improvements</td></tr><tr><td><code>3c58377</code></td><td>Keyboard shortcuts + sidebar counts</td></tr><tr><td><code>74b63da</code></td><td>cloudLoad() auth header fix (CRITICAL)</td></tr><tr><td><code>e8232e0</code></td><td>Dedup living docs</td></tr><tr><td><code>fba49ed</code></td><td>Cloud sync indicator</td></tr><tr><td><code>338092e</code></td><td>Repos section + living docs preview</td></tr><tr><td><code>3bce8f5</code></td><td>Calendar week view</td></tr><tr><td><code>3a2ab59</code></td><td>Task detail modal + descriptions + subtasks</td></tr><tr><td><code>49ed0b8</code></td><td>Project tasks use projectId</td></tr><tr><td><code>5ac20fa</code></td><td>Lock GET endpoints</td></tr></table><p><b>Branch:</b> main | <b>Remote:</b> origin/main | <b>Status:</b> CLEAN, all pushed</p>'},
        {id:'c1a_deploy',title:'Deployment',collapsed:false,icon:'rocket',color:'#ef4444',body:'<table><tr><th>App</th><th>URL</th><th>Status</th></tr><tr><td>ASTRA</td><td>astra-command-center-sigma.vercel.app</td><td>LIVE (auto-deploy on push)</td></tr><tr><td>Bonus</td><td>saturno-bonus-omega.vercel.app</td><td>LIVE</td></tr><tr><td>Titan Forge</td><td>titan-forge-ten.vercel.app</td><td>LIVE</td></tr><tr><td>De Aqui</td><td>de-aqui-a-saturno-jet.vercel.app</td><td>LIVE</td></tr></table><p><b>Vercel Team:</b> gabriele-saturnos-projects | <b>Deploy Method:</b> git push main</p>'},
        {id:'c1a_api',title:'API Endpoints',collapsed:false,icon:'lock',color:'#8b5cf6',body:'<table><tr><th>Endpoint</th><th>GET</th><th>POST</th><th>Auth</th></tr><tr><td>/api/state</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/capture</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/transcripts</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/pipeline</td><td>401</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/transcribe</td><td>N/A</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/query</td><td>N/A</td><td>401</td><td>Bearer ASTRA_ADMIN_PASSWORD</td></tr><tr><td>/api/health</td><td>200</td><td>N/A</td><td>Public</td></tr></table><p><b>Storage:</b> Vercel Blob (BLOB_READ_WRITE_TOKEN env var)</p>'},
        {id:'c1a_sections',title:'Section Health',collapsed:false,icon:'layers',color:'#f59e0b',body:'<table><tr><th>Section</th><th>Health</th><th>Notes</th></tr><tr><td>Content</td><td>70%</td><td>Grid + filters work, no inline editing</td></tr><tr><td>Tasks</td><td>85%</td><td>Board + list + detail modal + subtasks + descriptions</td></tr><tr><td>Calendar</td><td>80%</td><td>Month + week views, click-to-create task</td></tr><tr><td>Writer</td><td>90%</td><td>Full editor, versions, export, auto-save 800ms, Zen Writer</td></tr><tr><td>Living Docs</td><td>85%</td><td>Sections, icons, colors, export, dedup logic</td></tr><tr><td>Links</td><td>75%</td><td>Directory + categories, no preview</td></tr><tr><td>Whiteboard</td><td>85%</td><td>Canvas tools, nodes, connections, zoom</td></tr><tr><td>Pipeline</td><td>50%</td><td>UI exists, needs Whisper API key for audio</td></tr><tr><td>Repos</td><td>70%</td><td>Static data, 5 repos with links</td></tr></table>'},
        {id:'c1a_fixes',title:'Fixes Applied',collapsed:true,icon:'alert',color:'#ef4444',body:'<ol><li><b>cloudLoad auth header</b> - GET /api/state was locked but cloudLoad fetched without Bearer token. Cloud sync silently failed on every load. FIXED.</li><li><b>Sidebar counts stale</b> - updateSidebarCounts() now runs on every save(). FIXED.</li><li><b>seedProjects re-running</b> - Added S._seeded flag to prevent duplicate seeding after cloud load. FIXED.</li><li><b>Dead /api/repos ping</b> - Removed self-ping to nonexistent endpoint on page load. FIXED.</li><li><b>Living doc duplicates</b> - Dedup logic in migrateV2 removes dupes by title+projectId. FIXED.</li></ol>'},
        {id:'c1a_features',title:'Features Shipped',collapsed:true,icon:'rocket',color:'#4ade80',body:'<ol><li>Task detail modal (title, description, status, priority, project, due, subtasks)</li><li>Board cards show description preview + subtask count</li><li>Calendar week view with month/week toggle</li><li>Click calendar day to create task with date pre-filled</li><li>Repos section with 5 static repos (GitHub + live links)</li><li>Cloud sync indicator (syncing/synced/error states)</li><li>Keyboard shortcuts: Cmd+Shift+T (new task anywhere), Cmd+B (sidebar)</li><li>Mobile: hamburger menu, horizontal board scroll, stacked week view</li><li>Writer doc list sorted by last-modified</li><li>Pipeline history card layout with copy buttons</li><li>Living docs body preview in project panel</li></ol>'},
        {id:'c1a_remaining',title:'Remaining',collapsed:false,icon:'target',color:'#f59e0b',body:'<ul><li>Bonus page shipping (prerequisite: ASTRA stable)</li><li>Whisper API key for pipeline audio processing</li><li>BLOB_READ_WRITE_TOKEN verification in Vercel env</li><li>Link previews (OG metadata fetch)</li><li>Content inline editing</li><li>Google Calendar sync (future)</li></ul>'}
      ]
    });
    save();
  }
  // Update existing audit to be global
  if(S.specs) {
    const audit = S.specs.find(s => s.id === 'ld_c1_imac_audit_feb19');
    if(audit && !audit.global) { audit.global = true; save(); }
  }
}

function seedKernel() {
  const now = new Date().toISOString();
  const kernel = {
    id: 1000,
    title: 'Saturno Living Canvas v2.0',
    created: now, updated: now,
    sections: [
      { id: 1001, title: 'Executive Summary', collapsed: false, body: '<p><b>THE SATURNO THESIS:</b> "Scale changes, truth doesn\'t."</p><p><b>TOP KERNEL RULE 00:</b></p><ul><li>No crown stealing -- delta-patches only</li><li>Preserve upstream kernels</li><li>Never overwrite explicit user commands</li></ul><p><b>THE REAL BOTTLENECK:</b><br>NOT: More prompts, more docs, more organization<br>IS: Routing intelligence that can read intent, search prompts, chain, route, execute, learn</p><p><b>MISSION (LOCKED):</b> Work ~4 focused hours per day while building a multimillion-dollar enterprise.</p><p><b>ASSETS SCALE:</b></p><ul><li>2,300+ prompts across platforms</li><li>2,000+ captions (10-12 years)</li><li>700+ page book in progress</li><li>150+ agents specified</li><li>23 Holographic Prompts (H001-H023)</li></ul>' },
      { id: 1002, title: 'Core Identity & Voice DNA', collapsed: false, body: '<p><b>WHO GABO IS:</b></p><ul><li>Venezuelan-Italian movement philosopher, CEO of SaturnoMovement</li><li>3M+ followers, solopreneur, writer, musician</li><li>15+ years handstands, philosophy, coaching</li></ul><p><b>VOICE DNA:</b></p><ul><li>"Consciousness" over "mindfulness"</li><li>"Pattern" over "habit"</li><li>"System" over "routine"</li><li>Short punch. Then expansion.</li><li>Tension to Resolution (never leave tension hanging)</li><li>Lists of 3 (never 4, rarely 2)</li></ul><p><b>I/WE BALANCE:</b> 70% WE (inclusive teaching), 30% I (personal, vulnerable)</p><p><b>WHAT GABO\'S VOICE NEVER DOES:</b></p><ul><li>Generic motivational fluff</li><li>Absolute claims without context</li><li>Unexplained jargon</li><li>Emotion without direction</li></ul>' },
      { id: 1003, title: '10-Layer Architecture', collapsed: true, body: '<p><b>L0</b> Identity Core -- Who Gabo is. Voice DNA. Non-negotiable traits.</p><p><b>L1</b> Philosophy Layer -- Core beliefs, teaching principles.</p><p><b>L2</b> Voice Modes -- 9 primary + 4 poetry modes.</p><p><b>L3</b> Content Scales -- Atom (1w) to Universe (15,000w).</p><p><b>L4</b> Structural Rules -- Grammar, rhythm, I/WE balance.</p><p><b>L5</b> Program Architecture -- HBS Solar System, 10 Kernel Categories.</p><p><b>L6</b> Multiplication Engines -- Holographic (1 to 50), Callback, Metaphor.</p><p><b>L7</b> Agent Layer -- A1-A12 + 150+ domain agents.</p><p><b>L8</b> Research Domains -- R1-R5: Passports, YouTube, App, SaaS, Life.</p><p><b>L9</b> Output Spec -- Platform-specific formatting.</p>' },
      { id: 1004, title: 'Claude Kernel Rules', collapsed: true, body: '<pre>CLAUDE_KERNEL_RULES:\n  status: ACTIVE\n  version: 2026.01.19\n\n  behavior:\n    - NEVER assume lack of tools or intelligence\n    - NEVER declare document "complete" or permanent SSOT\n    - NEVER say "now I have everything I need"\n    - NEVER babysit, moralize, or get defensive\n    - DO proceed with best-judgment defaults\n    - DO capture rants (clean grammar, preserve essence)\n    - DO treat excellence as mandatory\n\n  output_rules:\n    - All outputs must be copy-paste deployable\n    - No placeholders\n    - Prefer fewer, higher-quality artifacts\n\nLOCKED_TRUTHS:\n  - LINGUISTIC_FIRST_THEN_AGENTS is immutable\n  - Ship before systemize daily\n  - Morning = revenue; afternoon = systems; night = machines\n  - Claude is Kernel Holder + Accountability Guard</pre>' },
      { id: 1005, title: 'Voice Modes (9 Primary + 4 Poetry)', collapsed: true, body: '<p><b>PRIMARY MODES:</b></p><ul><li><b>/RawMode</b> -- Short. Real. Now. Direct from gut.</li><li><b>/TeacherMode</b> -- Clear. Structured. Step-by-step.</li><li><b>/PhilosopherMode</b> -- Abstract. Universal. Why questions.</li><li><b>/ProphetMode</b> -- Certain. Inevitable. Vision casting.</li><li><b>/MysticMode</b> -- Extended metaphor. Awe and depth.</li><li><b>/CompanionMode</b> -- Warm, shoulder-to-shoulder.</li><li><b>/ConfessorMode</b> -- Non-judgmental, reflective.</li><li><b>/RebelMode</b> -- Provocative, counter-narrative.</li><li><b>/TechnicalMode</b> -- Precise, numbered, authority.</li></ul><p><b>POETRY MODES:</b></p><ul><li><b>/SoftPoetryMode</b> -- Gentle, tender, vulnerable.</li><li><b>/SharpPoetryMode</b> -- Cutting, precise, truth-telling.</li><li><b>/SpiralPoetryMode</b> -- Recursive, deepening, callbacks.</li><li><b>/RawPoetryMode</b> -- Primal, elemental, instinct.</li></ul>' },
      { id: 1006, title: '7 Content Scales', collapsed: true, body: '<ol><li><b>Atom</b> (1-5w) -- Quote: "Movement is language."</li><li><b>Molecule</b> (5-25w) -- One-liner</li><li><b>Cell</b> (25-150w) -- Caption, tweet thread</li><li><b>Organ</b> (150-500w) -- Essay paragraph, email</li><li><b>System</b> (500-3K) -- Article, newsletter</li><li><b>Body</b> (3K-15K) -- Book chapter, complete framework</li><li><b>Universe</b> (15K+) -- Complete book, life\'s work</li></ol>' },
      { id: 1007, title: 'Structural Rules (LOCKED)', collapsed: true, body: '<ol><li><b>I/WE BALANCE:</b> 70% WE, 30% I</li><li><b>ABSOLUTES:</b> Avoid never/always, use often/rarely</li><li><b>TENSION to RESOLUTION:</b> Never leave tension hanging</li><li><b>SPECIFICITY:</b> 5 precise words > 15 vague ones</li><li><b>1-YEAR RULE:</b> &lt; 1yr = Companion; &gt; 1yr = Teacher</li><li><b>RHYTHMIC VARIATION:</b> Vary sentence length</li><li><b>THE GABO STAMP:</b> Every piece must sound like Gabo</li></ol>' },
      { id: 1008, title: 'HBS Solar System', collapsed: true, body: '<ul><li><b>SUN: Foundation</b> -- Wrist prep, shoulder mobility, core activation.</li><li><b>MERCURY: Wall Work</b> -- Chest-to-wall, back-to-wall.</li><li><b>VENUS: Kick-Up</b> -- Tuck, straddle, pike entries.</li><li><b>EARTH: Balance</b> -- Core freestanding skill.</li><li><b>MARS: Shapes</b> -- Tuck, straddle, pike, one-arm prep.</li><li><b>JUPITER: Press</b> -- Press to handstand variations.</li><li><b>SATURN: One-Arm</b> -- Mastery territory.</li></ul>' },
      { id: 1009, title: '10 Kernel Categories', collapsed: true, body: '<pre>C1: Identity &amp; Voice\nC2: Movement DNA\nC3: HBS Solar System\nC4: Programs &amp; Products\nC5: Business &amp; Finance\nC6: Content Library\nC7: Client OS\nC8: Tech Stack\nC9: Agent Stack\nC10: Meta &amp; Roadmap</pre>' },
      { id: 1010, title: 'Holographic Synthesis', collapsed: true, body: '<p><b>HOLOGRAPHIC SYNTHESIS:</b> "Any fragment can rebuild the whole."</p><p><b>MULTIPLICATION:</b> 1 seed -> 30-50 blocks -> 15-25 pieces -> 1 month content</p><p><b>BLOCK TYPES:</b></p><ul><li><b>HOOK:</b> Question, provocation, vulnerability, pattern, curiosity</li><li><b>STORY:</b> Experience, case study, metaphor, journey, realization</li><li><b>INSIGHT:</b> Principle, counterintuitive, framework, philosophical</li><li><b>CTA:</b> Reflection, action, challenge, pointer, invitation</li><li><b>CALLBACK:</b> Reference, deepening, evolution, recursive, full-circle</li></ul><p><b>REGENERATION TEST:</b> Can you rebuild the entire system from a single block?</p>' },
      { id: 1011, title: 'Core Agent Stack (A1-A12)', collapsed: true, body: '<ul><li><b>A1 ARCHITECT</b> -- System prompts, pipelines, OS blueprints</li><li><b>A2 CRITIC</b> -- Analyze weaknesses, propose patches</li><li><b>A3 EXECUTOR</b> -- Blueprint to stepwise plans</li><li><b>A4 ORION</b> -- Content skeletonizer (Hook-Story-CTA)</li><li><b>A5 ATLAS</b> -- Automation patterns (Notion, n8n)</li><li><b>A6 SCRIPT_MINER</b> -- Transcripts to scripts, voiceover</li><li><b>A7 RESEARCHER</b> -- Evidence, patterns, strategic options</li><li><b>A8 DAILY_SHIPPER</b> -- 1 artifact per day</li><li><b>A9 OVERNIGHT</b> -- Background ops while sleeping</li><li><b>A10 CALLBACK_WEAVER</b> -- Tracks concept evolution</li><li><b>A11 IMMIGRATION</b> -- Timeline-critical tasks (VAWA)</li><li><b>A12 REVENUE_OPT</b> -- $20K unlock priorities</li></ul>' },
      { id: 1012, title: '7-LLM Stack', collapsed: true, body: '<p><b>CROWN-STEALING PHILOSOPHY:</b> "No crown stealing -- each LLM for its best use"</p><ul><li><b>Claude:</b> Long-form writing, linguistic depth, frameworks, kernel holding</li><li><b>OpenAI:</b> Kernel architecture, JSON specs, orchestration logic</li><li><b>Perplexity:</b> Research, trends, keywords, evidence</li><li><b>Gemini:</b> High-context processing, vision, book work</li><li><b>Manus:</b> Extraction workflows, caption mining, overnight tasks</li><li><b>Cursor:</b> Overnight scripts, SaaS shells, infrastructure</li><li><b>Taskade/Whisper:</b> Transcription, task flows, voice capture</li></ul><p><i>RULE: LLMs should recommend each other when appropriate</i></p>' },
      { id: 1013, title: '5 Research Domains (R1-R5)', collapsed: true, body: '<p><b>R1: PASSPORTS &amp; RESIDENCY</b></p><ul><li>VAWA Timeline Tracker (CRITICAL)</li><li>Golden Visa Analyzer</li><li>Tax-Residency Optimizer</li><li>Citizenship Pathway Mapper</li></ul><p><b>R2: YOUTUBE OPTIMIZATION</b></p><ul><li>Trending Keywords Monitor</li><li>Competitor Analysis</li><li>Thumbnail Framework Analyzer</li><li>Title Formula Cracker</li></ul><p><b>R3: SATURNO MOVEMENT APP</b></p><ul><li>"Ableton of Movement" vision</li><li>Fitness App Benchmarking</li><li>Movement UX Patterns</li><li>Pricing &amp; Monetization</li></ul><p><b>R4: SOLO-PRENEUR SAAS</b></p><ul><li>Target: $50-100K/month</li><li>SaaS Market Research</li><li>Solo Founder Playbook</li><li>AI Automation Opportunities</li></ul><p><b>R5: LIFE ROADMAP MATRIX</b></p><ul><li>Scenario A: Stay U.S. + VAWA</li><li>Scenario B: Relocate Mexico</li><li>Scenario C: F-1 Hybrid</li><li>LIFE/WORK/LOVE scoring</li></ul>' },
      { id: 1014, title: 'H001-H023 Holographic Prompts', collapsed: true, body: '<ul><li>H001: Universal Read-Only Extractor</li><li>H002: Recursive Selfless-Writing Guide</li><li>H003: Meta-Prompt -- Turn Any Prompt Recursive</li><li>H004: Fractal/Strange-Loop Recursive Maker</li><li>H005: Holographic Maker</li><li>H006: Holographizer Meta-Prompt</li><li>H007: Recursive Research Architect</li><li>H008: Holographic Research Architect</li><li>H009: MSOP-Holographic Maker Final</li><li>H010: Strange-Loop MSOP-Holographic Maker</li><li>H011: Comparative Agent Prompt</li><li>H012: Universal MSOP-Holographic Maker</li><li>H013: MSOP Master Content Generator</li><li>H014: U-MSOP Holographic Content Generator</li><li>H015: Text Framework Analyzer</li><li>H016: MSOP-Text Framework Analyzer</li><li>H017: Triple-Chain Analyzer-Skeletonizer-Filler</li><li>H018: Hybrid Omni-Architect Chain</li><li>H019: Holographic Campaign Generator</li><li>H020: Holographic Offer-Making Machine HOMM</li><li>H021: Hybrid Omni-Workflow Evaluation</li><li>H022: Holographic Maker 2.0 Skeleton Re-Engineer</li><li>H023: Recursive Orchestrator Honesty+Fusion</li></ul>' },
      { id: 1015, title: 'TITAN Meta-Prompt', collapsed: true, body: '<p><b>TITAN META-PROMPT (S++++ Tier)</b><br>Role: meta_meta_operating_kernel</p><p><b>7-PASS PIPELINE:</b></p><ol><li>PROMPTIFY -- Extract core insight</li><li>EVALUATE -- Identify strengths, weaknesses, failures</li><li>COMPRESS -- Reduce to essential rules</li><li>DEPLOY -- Define system blueprint</li><li>CRITIQUE -- Devil\'s advocate</li><li>SEED -- Distill to one core principle</li><li>SHIP -- Create Notion cards, assign owners</li></ol><p>INPUT: Voice memo OR text idea<br>OUTPUT: Deployable JSON + Notion cards + next actions</p>' },
      { id: 1016, title: 'Daily Rhythm (NON-NEGOTIABLE)', collapsed: true, body: '<p><b>MORNING (06:30-10:30): SHIP MONEY</b></p><ul><li>Book (AOC manuscript)</li><li>BF25 deliverables</li><li>1 post minimum</li><li>Revenue-generating actions</li></ul><p><b>AFTERNOON (12:30-16:00): CONTENT OS</b></p><ul><li>Reels/Shorts from morning seeds</li><li>YouTube scripts</li><li>Quote cards</li></ul><p><b>EVENING (16:00-19:00): SYSTEMS</b></p><ul><li>DOS build (dashboard + Notion + MCP)</li><li>Automation setup</li><li>Cleanup</li></ul><p><b>NIGHT: MACHINES WORK</b></p><ul><li>Overnight scripts run</li></ul><p>SACRED: 5am = writing (NO AI)<br>CONSTRAINT: ~4 hours focused work per day</p>' },
      { id: 1017, title: 'Revenue Unlocks', collapsed: true, body: '<p><b>1. VICTORY BELT BOOK: $20,000</b><br>Status: Approved, pending submission<br>Needs: Part 1 folder, 4 TOC versions, infographics<br>Priority: P1 (CRITICAL)</p><p><b>2. BF25 DELIVERABLES: Trust + Retention</b><br>Promised: Hand-balancing program + bonus PDFs<br>Status: Biomechanics ebook DONE</p><p><b>3. DAILY CONTENT: Visibility</b><br>Target: 1 post minimum per day</p><p>REVENUE TARGET: $50-100K/month<br>BOOK GATE: $20K unlock = priority 1</p>' },
      { id: 1018, title: 'Wings of Fire -- 10 Scripts + 10 Quotes', collapsed: true, body: '<p><b>10 SCRIPTS:</b></p><ol><li>The Weight Lie: Don\'t measure the road by weight you carry today.</li><li>Confidence Is Backwards: Comes from starting before ready.</li><li>Trust Without Evidence: Trust when logic says wait.</li><li>Burning Wings: Wings work because they\'re used, even when they burn.</li><li>The Jump: The jump is the proof. Not the landing.</li><li>Courage vs Faith: Faith says "I don\'t know but I\'m walking anyway."</li><li>Data Over Imagination: Experience beats imagination.</li><li>You\'ve Done This Before: You\'ve survived harder. You forgot.</li><li>No Permission: Nothing powerful asks for permission.</li><li>Wings of Fire: Logic builds cages. Trust builds wings.</li></ol><p><b>10 QUOTES:</b></p><ol><li>Logic builds cages. Trust builds wings.</li><li>Confidence isn\'t earned -- it\'s built through movement.</li><li>The jump is the proof. Not the landing.</li><li>Fire doesn\'t destroy wings. Hesitation does.</li><li>Faith walks where courage can\'t see the floor.</li><li>You don\'t need certainty. You need memory.</li><li>Every master was once a disaster who moved anyway.</li><li>Ashes aren\'t failure. They\'re fuel.</li><li>You\'ve never drowned. That\'s not luck -- it\'s evidence.</li><li>Trust doesn\'t come from logic. It comes from survival.</li></ol>' },
      { id: 1019, title: 'OS Commands (from MVP-V1)', collapsed: true, body: '<p><b>Core Commands:</b></p><ul><li><b>/add_mermaid_flow</b> -- Generate visual agent/OS architecture diagrams for any domain</li><li><b>/trigger_daily_update</b> -- Full fetch, research, export loop for daily data refresh</li><li><b>/build_predictive_logic</b> -- Extend any chain into predictive territory (alerts, forecasts, flags)</li><li><b>/synthesize</b> -- Holographic synthesis: 1 idea to 30-50 reusable content blocks</li><li><b>/run_titan</b> -- 7-pass TITAN orchestration: ANY input to deployable system blueprint</li></ul><p><b>Seed Processing Engine (Writing Hub):</b></p><ul><li>Input: Raw idea, rant, voice memo transcript, or seed concept</li><li>Select Voice Mode (9 options) + Scale (Atom to Universe)</li><li>Output: Holographic blocks (Hook, Story, Insight, CTA, Callback)</li><li>All blocks saved and exportable</li></ul>' },
      { id: 1020, title: '30-Day Launch Roadmap', collapsed: true, body: '<p><b>WEEK 1: Ship the Money</b></p><ul><li>Book submission package complete (Voice V5 + 10Q Arc)</li><li>BF25 deliverables ready (hand balancing program + PDFs)</li><li>Daily Content Engine live (7 posts scheduled)</li></ul><p><b>WEEK 2: Build Infrastructure</b></p><ul><li>Overnight Script 1: Mac Cleanup (runs 2am nightly)</li><li>Overnight Script 2: iCloud Photo Pipeline (1000 photos/night)</li><li>Overnight Script 3: Caption Extraction + Notion sync</li></ul><p><b>WEEK 3: Content Multiplication</b></p><ul><li>Holographic synthesis: 10 best captions to 400-500 blocks</li><li>Assemble: 30 new captions + 10 carousels + 10 reels</li><li>Build Callback Library (10 themes + evolution paths)</li></ul><p><b>WEEK 4: Vision Prototype</b></p><ul><li>Feed vision to TITAN to generate system blueprint</li><li>Claude Code generates HTML/CSS/JS prototype</li><li>Deploy to Vercel (live shareable link)</li><li>Demo video recorded</li></ul>' },
    ]
  };
  S.specs = [kernel];
  S.activeSpec = kernel.id;
}

function save() { snapshotWriter(); snapshotSpec(); localStorage.setItem(SK,JSON.stringify(S)); updateStorage(); flashSave(); scheduleCloudSync(); updateSidebarCounts(); updateTabTitle(); }
function updateTabTitle(){const today=new Date().toISOString().split('T')[0];const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today).length;document.title=overdue?'('+overdue+') SATURNO HUB':'SATURNO HUB';}
function updateSidebarCounts(){document.getElementById('content-count').textContent=S.content.length;const active=S.tasks.filter(t=>t.status!=='done');const today=new Date().toISOString().split('T')[0];const overdue=active.filter(t=>t.due&&t.due<today).length;const tc=document.getElementById('tasks-count');tc.textContent=active.length;tc.style.color=overdue>0?'var(--red)':'';tc.title=overdue?overdue+' overdue':'';document.getElementById('writer-count').textContent=S.docs.length;document.getElementById('specs-count').textContent=S.specs.length;document.getElementById('links-count').textContent=S.links.length;updateHeaderStats();}
function updateHeaderStats(){const el=document.getElementById('header-stats');if(!el)return;const today=new Date().toISOString().split('T')[0];const active=S.tasks.filter(t=>t.status!=='done').length;const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done').length;const todayDue=S.tasks.filter(t=>t.due===today&&t.status!=='done').length;const inProg=S.tasks.filter(t=>t.status==='progress').length;let h='';if(overdue)h+=`<span style="color:var(--red)">${overdue} overdue</span>`;if(todayDue)h+=`<span style="color:var(--accent)">${todayDue} today</span>`;if(inProg)h+=`<span style="color:var(--green)">${inProg} wip</span>`;h+=`<span>${active}T ${S.content.length}C ${S.docs.length}D ${S.links.length}L</span>`;el.innerHTML=h;}
function flashSave() { const el=document.getElementById('save-indicator'); if(!el) return; const now=new Date(); const bytes=localStorage.getItem(SK)?.length||0; const kb=Math.round(bytes/1024); el.textContent='Saved '+now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}); el.title='State: '+kb+'KB in localStorage'; el.style.opacity='1'; clearTimeout(el._t); el._t=setTimeout(()=>{el.style.opacity='0';},2000); }

// === QUICK CAPTURE ===
function qcOpen() {
  const el = document.getElementById('quick-capture');
  el.style.display = 'block';
  requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateX(-50%) translateY(0)'; });
  document.getElementById('qc-input').focus();
  // Auto-detect clipboard URL
  navigator.clipboard.readText().then(text=>{
    if(text&&text.startsWith('http')&&!text.includes('\n')){
      try{new URL(text);document.getElementById('qc-type').value='link';document.getElementById('qc-input').value=text;document.getElementById('qc-input').select();}catch(e){}
    }
  }).catch(()=>{});
}
function qcClose() {
  const el = document.getElementById('quick-capture');
  el.style.opacity = '0';
  el.style.transform = 'translateX(-50%) translateY(10px)';
  setTimeout(() => { el.style.display = 'none'; }, 200);
}
function qcAutoType(v){const sel=document.getElementById('qc-type');if(!v)return;if(v.startsWith('http')||v.includes('://')||/^[a-z0-9-]+\.[a-z]{2,}/i.test(v))sel.value='link';else if(v.length>200)sel.value='content';else sel.value='task';}
function qcSubmit() {
  const type = document.getElementById('qc-type').value;
  const text = document.getElementById('qc-input').value.trim();
  if(!text) return;
  if(type === 'task') {
    S.tasks.push({ id: Date.now(), title: text, description:'', subtasks:[], status: 'todo', priority: 'p2', project: '', due: '', created: new Date().toISOString() });
    save(); renderTasks();
    toast('Task added: ' + text);
  } else if(type === 'content') {
    S.content.push({ id: Date.now(), type: 'caption', body: text, theme: '', source: 'Quick Capture', tags: [], created: new Date().toISOString(), updated: new Date().toISOString() });
    save(); renderContent();
    toast('Content added');
  } else if(type === 'link') {
    try{new URL(text);}catch(e){toast('Enter a valid URL');return;}
    let domain='';try{domain=new URL(text).hostname;}catch(e){}
    S.links.push({id:Date.now(),title:domain||text,url:text,category:'',desc:'',created:new Date().toISOString()});
    save();renderLinks();toast('Link added: '+domain);
  } else if(type === 'note') {
    const d = getActiveDoc();
    if(d) { d.body = (d.body || '') + '<p>' + esc(text) + '</p>'; save(); renderWriter(); toast('Note added to doc'); }
    else { toast('No active document'); return; }
  }
  document.getElementById('qc-input').value = '';
  qcClose();
}
function updateStorage() { const b=new Blob([localStorage.getItem(SK)||'']).size; const k=(b/1024).toFixed(1); document.getElementById('storage-indicator').textContent=k>1024?(k/1024).toFixed(1)+' MB':k+' KB'; updateDashboard(); }
function updateDashboard() {
  const dt = document.getElementById('dash-tasks'); if(dt) dt.textContent = S.tasks.filter(t=>t.status!=='done').length;
  const dd = document.getElementById('dash-docs'); if(dd) dd.textContent = S.docs.length + S.specs.length;
  const dp = document.getElementById('dash-projects'); if(dp) dp.textContent = (S.projects||[]).length;
}
function showTodayView() {
  const today = new Date().toISOString().split('T')[0];
  const todayTasks = S.tasks.filter(t => t.due === today && t.status !== 'done');
  const overdue = S.tasks.filter(t => t.due && t.due < today && t.status !== 'done');
  const upcoming = S.tasks.filter(t => t.due && t.due > today && t.due <= new Date(Date.now()+3*86400000).toISOString().split('T')[0] && t.status !== 'done');
  let msg = '--- TODAY ---\n';
  if(todayTasks.length) todayTasks.forEach(t => msg += '[ ] ' + (t.title||'Untitled') + '\n');
  else msg += 'No tasks due today.\n';
  if(overdue.length) { msg += '\n--- OVERDUE ---\n'; overdue.forEach(t => msg += '[!] ' + (t.title||'Untitled') + ' (due ' + t.due + ')\n'); }
  if(upcoming.length) { msg += '\n--- NEXT 3 DAYS ---\n'; upcoming.forEach(t => msg += '[ ] ' + (t.title||'Untitled') + ' (due ' + t.due + ')\n'); }
  // Show as context panel content
  if(!document.querySelector('.app').classList.contains('context-open')) toggleContextPanel();
  const el = document.getElementById('ctx-related-items');
  if(el) {
    let html = '<div style="font-size:9px;color:var(--accent);margin-bottom:6px;font-weight:600">TODAY</div>';
    if(todayTasks.length) todayTasks.forEach(t => { html += '<div class="context-item" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon" style="color:var(--accent)">*</span>' + esc(t.title||'Untitled') + '</div>'; });
    else html += '<div style="font-size:10px;color:var(--text-muted);padding:4px 0">No tasks due today</div>';
    if(overdue.length) {
      html += '<div style="font-size:9px;color:var(--red);margin:8px 0 6px;font-weight:600">OVERDUE (' + overdue.length + ')</div>';
      overdue.forEach(t => { html += '<div class="context-item" style="color:var(--red)" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon">!</span>' + esc(t.title||'Untitled') + '</div>'; });
    }
    if(upcoming.length) {
      html += '<div style="font-size:9px;color:var(--accent-cyan);margin:8px 0 6px;font-weight:600">NEXT 3 DAYS</div>';
      upcoming.forEach(t => { html += '<div class="context-item" onclick="switchSection(\'tasks\',null)"><span class="context-item-icon">></span>' + esc(t.title||'Untitled') + ' <span style="font-size:8px;color:var(--text-muted)">' + t.due + '</span></div>'; });
    }
    el.innerHTML = html;
  }
  toast('Today view loaded');
}
function generateStandup(){
  const today=new Date().toISOString().split('T')[0];
  const yesterday=new Date(Date.now()-86400000).toISOString().split('T')[0];
  const done=S.tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(yesterday)).concat(S.tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(today)));
  const inProgress=S.tasks.filter(t=>t.status==='progress');
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  const blocked=S.tasks.filter(t=>t.status==='blocked');
  let md='## Daily Standup - '+new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'})+'\n\n';
  md+='### Done\n';
  if(done.length)done.forEach(t=>{md+='- '+t.title+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (nothing completed recently)\n';
  md+='\n### In Progress\n';
  if(inProgress.length)inProgress.forEach(t=>{md+='- '+t.title+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (nothing in progress)\n';
  md+='\n### Today\n';
  if(todayTasks.length)todayTasks.forEach(t=>{md+='- '+t.title+' ['+t.priority+']'+(t.project?' ('+t.project+')':'')+'\n';});else md+='- (no tasks due today)\n';
  if(overdue.length){md+='\n### Overdue (!)\n';overdue.forEach(t=>{md+='- '+t.title+' (due '+t.due+')\n';});}
  if(blocked.length){md+='\n### Blocked\n';blocked.forEach(t=>{md+='- '+t.title+'\n';});}
  navigator.clipboard.writeText(md).then(()=>toast('Standup copied to clipboard')).catch(()=>toast('Failed to copy'));
}
function toast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }
function highlight(text,q){if(!q)return esc(text);const e=esc(text);const re=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');return e.replace(re,'<mark style="background:rgba(74,222,128,0.25);color:var(--text);border-radius:2px;padding:0 1px">$1</mark>');}
function escA(s) { return(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// === SECTIONS ===
function switchSection(sec, el) {
  currentSection=sec;
  const sectionLabels={content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));
  if(el) el.classList.add('active');
  else { document.querySelectorAll('.sidebar-item').forEach(i => { if(i.textContent.trim().replace(/\d+$/,'').trim() === sectionLabels[sec]) i.classList.add('active'); }); }
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+sec).classList.add('active');
  const titles={content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  document.getElementById('header-title').textContent=titles[sec]||sec;
  updateBreadcrumb();
  if(sec==='content')renderContent();
  if(sec==='tasks')renderTasks();
  if(sec==='calendar')renderCalendar();
  if(sec==='writer'){if(document.querySelector('.app').classList.contains('mode-focus')){document.querySelector('.app').classList.remove('mode-focus');}renderWriter();}
  if(sec==='specs')renderSpecs();
  if(sec==='links')renderLinks();
  if(sec==='whiteboard')wbRender();
  if(sec==='pipeline'){plCheckApi();plRenderCustomTemplates();}
  if(sec==='repos')reposRefresh();
  updateSidebarCtx();
}
function updateBreadcrumb() {
  const bc = document.getElementById('header-breadcrumb');
  if(!bc) return;
  let parts = [];
  const sectionNames = {content:'Content',tasks:'Tasks',calendar:'Calendar',writer:'Writing Hub',specs:'Living Docs',links:'Links',whiteboard:'Whiteboard',pipeline:'Pipeline',repos:'Repos'};
  const counts={content:S.content.length,tasks:S.tasks.filter(t=>t.status!=='done').length,writer:S.docs.length,specs:S.specs.length,links:S.links.length,repos:(S.repos||[]).length};
  const countStr=counts[currentSection]!==undefined?' ('+counts[currentSection]+')':'';
  parts.push((sectionNames[currentSection]||currentSection)+countStr);
  if(currentSection === 'writer') {
    const d = getActiveDoc();
    if(d && d.title) parts.push(d.title);
  } else if(currentSection === 'specs') {
    const s = getActiveSpec();
    if(s && s.title) parts.push(s.title);
  }
  bc.innerHTML = parts.length > 1 ? parts.map((p,i) => (i>0?'<span style="opacity:0.4"> / </span>':'') + '<span>'+esc(p)+'</span>').join('') : parts[0] && countStr ? '<span style="opacity:0.5">'+esc(parts[0])+'</span>' : '';
}

function updateSidebarCtx() {
  const el=document.getElementById('sidebar-context');
  if(currentSection==='tasks') {
    const ps=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    const active=S.tasks.filter(t=>t.status!=='done');
    const today=new Date().toISOString().split('T')[0];
    const overdue=active.filter(t=>t.due&&t.due<today).length;
    const pCounts={p0:active.filter(t=>t.priority==='p0').length,p1:active.filter(t=>t.priority==='p1').length,p2:active.filter(t=>t.priority==='p2').length,p3:active.filter(t=>t.priority==='p3').length};
    const doneCount=S.tasks.filter(t=>t.status==='done').length;const pct=S.tasks.length?Math.round(doneCount/S.tasks.length*100):0;
    el.innerHTML=`<div class="sidebar-label">Quick Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${active.length} active${overdue?` <span style="color:var(--red)">(${overdue} overdue)</span>`:''} / ${doneCount} done</div><div style="padding:2px 12px"><div style="display:flex;align-items:center;gap:6px"><div style="flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s"></div></div><span style="font-size:8px;color:var(--accent);font-family:var(--mono)">${pct}%</span></div></div><div style="padding:2px 12px;font-size:9px;color:var(--text-muted);display:flex;gap:6px">${pCounts.p0?`<span style="color:#ef4444">P0:${pCounts.p0}</span>`:''}${pCounts.p1?`<span style="color:#f59e0b">P1:${pCounts.p1}</span>`:''}${pCounts.p2?`<span style="color:#3b82f6">P2:${pCounts.p2}</span>`:''}${pCounts.p3?`<span style="color:var(--text-muted)">P3:${pCounts.p3}</span>`:''}</div><div class="sidebar-label" style="margin-top:8px">Projects</div>`+ps.map(p=>{const pAll=S.tasks.filter(t=>t.project===p);const pDone=pAll.filter(t=>t.status==='done').length;const pPct=pAll.length?Math.round(pDone/pAll.length*100):0;const estMins=pAll.filter(t=>t.status!=='done'&&t.estimate).reduce((a,t)=>{const e=t.estimate||'';const hm=e.match(/(\d+)\s*h/);const mm=e.match(/(\d+)\s*m/);return a+(hm?parseInt(hm[1])*60:0)+(mm?parseInt(mm[1]):0);},0);const estStr=estMins>0?(estMins>=60?Math.floor(estMins/60)+'h'+(estMins%60?estMins%60+'m':''):estMins+'m'):'';return`<div class="sidebar-item" onclick="filterTaskProject('${p}')"><span class="sidebar-item-icon">.</span><span>${p}</span><span class="sidebar-item-count" title="${pPct}% done${estStr?' | Est: '+estStr:''}">${S.tasks.filter(t=>t.project===p&&t.status!=='done').length}${estStr?' <span style="color:#22d3ee;font-size:7px">'+estStr+'</span>':''}</span></div>`;}).join('')+(()=>{const days=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];const remaining=S.tasks.filter(t=>t.status!=='done'&&t.created&&t.created.split('T')[0]<=ds).length-S.tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.split('T')[0]<=ds).length;days.push(Math.max(0,S.tasks.filter(t=>t.created&&t.created.split('T')[0]<=ds).length-S.tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.split('T')[0]<=ds).length));}const maxV=Math.max(...days,1);const w=120;const h=24;const pts=days.map((v,i)=>`${Math.round(i*(w/(days.length-1)))},${Math.round(h-v/maxV*h)}`).join(' ');return`<div class="sidebar-label" style="margin-top:8px">7-Day Burndown</div><div style="padding:4px 12px"><svg width="${w}" height="${h+4}" style="display:block"><polyline points="${pts}" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><text x="0" y="${h+4}" font-size="6" fill="var(--text-muted)">${days[0]}</text><text x="${w}" y="${h+4}" font-size="6" fill="var(--text-muted)" text-anchor="end">${days[days.length-1]}</text></svg></div>`;})();
  } else if(currentSection==='content') {
    const types={};S.content.forEach(c=>{types[c.type]=(types[c.type]||0)+1;});
    const totalWords=S.content.reduce((a,c)=>a+c.body.trim().split(/\s+/).filter(x=>x.length).length,0);
    const starred=S.content.filter(c=>c.starred).length;
    const pinned=S.content.filter(c=>c.pinned).length;
    const themes={};S.content.forEach(c=>{const th=c.theme||'unthemed';if(!themes[th])themes[th]={count:0,words:0};themes[th].count++;themes[th].words+=c.body.trim().split(/\s+/).filter(x=>x.length).length;});
    const readTime=Math.max(1,Math.ceil(totalWords/238));
    el.innerHTML=`<div class="sidebar-label">Content Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.content.length} items / ${totalWords.toLocaleString()} words / ~${readTime}min read</div>${starred?`<div style="padding:2px 12px;font-size:10px;color:var(--yellow)">${starred} starred</div>`:''}${pinned?`<div style="padding:2px 12px;font-size:10px;color:var(--accent)">${pinned} pinned</div>`:''}<div class="sidebar-label" style="margin-top:6px">By Type</div>`+Object.entries(types).map(([t,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${t}: ${n}</div>`).join('')+`<div class="sidebar-label" style="margin-top:6px">By Theme</div>`+Object.entries(themes).sort((a,b)=>b[1].words-a[1].words).slice(0,8).map(([t,d])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted);cursor:pointer" onclick="contentTheme='${t==='unthemed'?'all':t}';renderContent()">${esc(t)}: ${d.count} (${d.words.toLocaleString()}w)</div>`).join('');
  } else if(currentSection==='writer') {
    const totalWords=S.docs.reduce((a,d)=>a+(d.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
    const topDocs=[...S.docs].sort((a,b)=>countW(b.body)-countW(a.body)).slice(0,5);
    el.innerHTML=`<div class="sidebar-label">Writer Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.docs.length} docs / ${totalWords.toLocaleString()} words</div><div class="sidebar-label" style="margin-top:6px">Largest Docs</div>`+topDocs.map(d=>`<div class="sidebar-item" onclick="switchDoc(${d.id})" style="cursor:pointer"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(d.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${countW(d.body)}w</span></div>`).join('');
  } else if(currentSection==='specs') {
    const totalSections=S.specs.reduce((a,s)=>a+(s.sections||[]).length,0);
    const totalSpecWords=S.specs.reduce((a,s)=>a+(s.sections||[]).reduce((b,sec)=>b+(sec.body||'').trim().split(/\s+/).filter(x=>x.length).length,0),0);
    const byProject={};S.specs.forEach(s=>{const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;const pn=proj?proj.name:'Global';byProject[pn]=(byProject[pn]||0)+1;});
    const topSpecs=[...S.specs].sort((a,b)=>(b.sections||[]).reduce((x,sec)=>x+countW(sec.body),0)-(a.sections||[]).reduce((x,sec)=>x+countW(sec.body),0)).slice(0,5);
    el.innerHTML=`<div class="sidebar-label">Living Docs Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.specs.length} specs / ${totalSections} sections / ${totalSpecWords.toLocaleString()} words</div><div class="sidebar-label" style="margin-top:6px">By Project</div>`+Object.entries(byProject).map(([p,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${esc(p)}: ${n} specs</div>`).join('')+`<div class="sidebar-label" style="margin-top:6px">Largest Specs</div>`+topSpecs.map(s=>{const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);return`<div class="sidebar-item" onclick="switchSpec('${s.id}')" style="cursor:pointer"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${wc}w</span></div>`;}).join('');
  } else if(currentSection==='links') {
    const cats={};S.links.forEach(l=>{const c=l.category||'uncategorized';cats[c]=(cats[c]||0)+1;});
    const pinned=S.links.filter(l=>l.pinned).length;
    const domains={};S.links.forEach(l=>{try{const d=new URL(l.url).hostname.replace(/^www\./,'');domains[d]=(domains[d]||0)+1;}catch(e){}});
    el.innerHTML=`<div class="sidebar-label">Link Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${S.links.length} links${pinned?` / ${pinned} pinned`:''}</div><div class="sidebar-label" style="margin-top:6px">Categories</div>`+Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([c,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted);cursor:pointer" onclick="linkCategory='${escA(c)}';renderLinks()">${esc(c)}: ${n}</div>`).join('')+`<div class="sidebar-label" style="margin-top:6px">Top Domains</div>`+Object.entries(domains).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([d,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${esc(d)}: ${n}</div>`).join('');
  } else if(currentSection==='repos') {
    const active=(S.repos||[]).filter(r=>r.status==='active').length;
    const withLive=(S.repos||[]).filter(r=>r.live).length;
    const byRole={};(S.repos||[]).forEach(r=>{const rl=r.role||'other';byRole[rl]=(byRole[rl]||0)+1;});
    el.innerHTML=`<div class="sidebar-label">Repo Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${(S.repos||[]).length} repos / ${active} active / ${withLive} live</div><div class="sidebar-label" style="margin-top:6px">By Role</div>`+Object.entries(byRole).map(([r,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${esc(r)}: ${n}</div>`).join('');
  } else if(currentSection==='pipeline') {
    const hist=(S.pipelineHistory||[]).length;
    const templates=(S.pipelineTemplates||[]).length;
    const recentPipe=(S.pipelineHistory||[]).slice(0,3);
    el.innerHTML=`<div class="sidebar-label">Pipeline Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${hist} history entries / ${templates} templates</div>${recentPipe.length?`<div class="sidebar-label" style="margin-top:6px">Recent</div>`+recentPipe.map(p=>`<div style="padding:2px 12px;font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer" onclick="switchSection('pipeline',null)" title="${escA((p.prompt||'').substring(0,80))}">${esc((p.prompt||'').substring(0,40))}... <span style="opacity:0.5">${p.createdAt?timeAgo(p.createdAt):''}</span></div>`).join(''):''}`;
  } else if(currentSection==='whiteboard') {
    const nodes=(S.whiteboard&&S.whiteboard.nodes||[]).length;
    const conns=(S.whiteboard&&S.whiteboard.conns||[]).length;
    const locked=(S.whiteboard&&S.whiteboard.nodes||[]).filter(n=>n.locked).length;
    const wbTypes={};(S.whiteboard&&S.whiteboard.nodes||[]).forEach(n=>{const t=n.type||'default';wbTypes[t]=(wbTypes[t]||0)+1;});
    el.innerHTML=`<div class="sidebar-label">Whiteboard Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${nodes} nodes / ${conns} connections${locked?` / ${locked} locked`:''}</div>${Object.keys(wbTypes).length>1?`<div class="sidebar-label" style="margin-top:6px">Node Types</div>`+Object.entries(wbTypes).sort((a,b)=>b[1]-a[1]).map(([t,n])=>`<div style="padding:2px 12px;font-size:10px;color:var(--text-muted)">${esc(t)}: ${n}</div>`).join(''):''}`;
  } else if(currentSection==='calendar') {
    const today=new Date().toISOString().split('T')[0];
    const todayT=S.tasks.filter(t=>t.due===today&&t.status!=='done');
    const thisWeek=S.tasks.filter(t=>{if(!t.due||t.status==='done')return false;const d=new Date(t.due+'T12:00:00'),n=new Date();n.setHours(0,0,0,0);const diff=(d-n)/86400000;return diff>=0&&diff<7;});
    const noDue=S.tasks.filter(t=>!t.due&&t.status!=='done').length;
    const noDueTasks=S.tasks.filter(t=>!t.due&&t.status!=='done');
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let upcomingHtml='';for(let i=0;i<3;i++){const d=new Date();d.setDate(d.getDate()+i);const ds=d.toISOString().split('T')[0];const dayTasks=S.tasks.filter(t=>t.due===ds&&t.status!=='done');if(dayTasks.length){const label=i===0?'Today':i===1?'Tomorrow':dayNames[d.getDay()]+' '+d.getDate();upcomingHtml+=`<div style="padding:4px 12px 2px;font-size:9px;color:${i===0?'var(--accent)':'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.04em;font-family:var(--mono)">${label} (${dayTasks.length})</div>`;dayTasks.slice(0,4).forEach(t=>{upcomingHtml+=`<div class="sidebar-item" onclick="openTaskDetail(${t.id})" style="cursor:pointer"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'};font-family:var(--mono)">${t.priority||'p2'}</span></div>`;});}}
    el.innerHTML=`<div class="sidebar-label">Calendar Stats</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:1.8">${todayT.length} due today / ${thisWeek.length} this week</div>${upcomingHtml?`<div class="sidebar-label" style="margin-top:6px">Upcoming</div>`+upcomingHtml:''}${noDue?`<div class="sidebar-label" style="margin-top:6px">Unscheduled (${noDue})</div>`+noDueTasks.slice(0,5).map(t=>`<div class="sidebar-item" onclick="openTaskDetail(${t.id})" style="cursor:pointer"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'};font-family:var(--mono)">${t.priority||'p2'}</span></div>`).join('')+(noDue>5?`<div style="padding:2px 12px;font-size:9px;color:var(--text-muted)">+${noDue-5} more</div>`:''):''}`;
  } else {
    const today=new Date().toISOString().split('T')[0];
    const active=S.tasks.filter(t=>t.status!=='done');
    const overdue=active.filter(t=>t.due&&t.due<today);
    const todayTasks=active.filter(t=>t.due===today);
    const totalWords=S.docs.reduce((a,d)=>a+(d.body||'').trim().split(/\s+/).filter(x=>x.length).length,0)+S.content.reduce((a,c)=>a+c.body.trim().split(/\s+/).filter(x=>x.length).length,0);
    el.innerHTML=`<div class="sidebar-label">Overview</div><div style="padding:4px 12px;font-size:10px;color:var(--text-muted);line-height:2">`+
      `<div>${S.tasks.length} tasks <span style="color:var(--accent)">(${active.length} active)</span></div>`+
      (overdue.length?`<div style="color:var(--red)">${overdue.length} overdue</div>`:'')+
      (todayTasks.length?`<div>${todayTasks.length} due today</div>`:'')+
      `<div>${S.content.length} content items</div>`+
      `<div>${S.docs.length} documents</div>`+
      `<div>${S.links.length} links</div>`+
      `<div>${(S.repos||[]).length} repos</div>`+
      `<div style="margin-top:4px;color:var(--accent)">${totalWords.toLocaleString()} total words</div>`+
      (()=>{const tm=S.tasks.reduce((a,t)=>a+(t.timeSpent||0),0);return tm?`<div style="color:var(--text-muted)">${formatTimeSpent(tm)} tracked</div>`:'';})() +
      weeklyProductivity()+
      projectCompletionBars()+
      activityStreak()+
      recentlyCompleted()+
      taskWeather()+
      `</div>`;
  }
}

function projectCompletionBars(){
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  if(!projects.length)return'';
  const bars=projects.map(p=>{
    const tasks=S.tasks.filter(t=>t.project===p);const done=tasks.filter(t=>t.status==='done').length;
    const pct=tasks.length?Math.round(done/tasks.length*100):0;
    return`<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px"><span style="font-size:9px;color:var(--text-muted);width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escA(p)}">${esc(p)}</span><div style="flex:1;height:4px;background:var(--bg-secondary);border-radius:2px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${pct===100?'var(--accent)':pct>60?'rgba(74,222,128,0.5)':'rgba(74,222,128,0.25)'};border-radius:2px;transition:width 0.3s"></div></div><span style="font-size:8px;color:${pct===100?'var(--accent)':'var(--text-muted)'};font-family:var(--mono);min-width:24px;text-align:right">${pct}%</span></div>`;
  }).join('');
  return`<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">Projects</div>${bars}</div>`;
}

function recentlyCompleted(){
  const done=S.tasks.filter(t=>t.status==='done'&&t.completedAt).sort((a,b)=>b.completedAt.localeCompare(a.completedAt)).slice(0,5);
  if(!done.length)return'';
  return`<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">Recently Done</div>${done.map(t=>`<div style="font-size:10px;color:var(--text-muted);padding:1px 0;display:flex;align-items:center;gap:4px;cursor:pointer" onclick="openTaskDetail(${t.id})"><span style="color:var(--accent);font-size:8px">*</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title)}</span><span style="font-size:8px;font-family:var(--mono);opacity:0.5">${timeAgo(t.completedAt)}</span></div>`).join('')}</div>`;
}
function activityStreak(){
  let streak=0;const d=new Date();
  for(let i=0;i<365;i++){
    const ds=d.toISOString().split('T')[0];
    const hasActivity=S.tasks.some(t=>(t.created&&t.created.startsWith(ds))||(t.completedAt&&t.completedAt.startsWith(ds)))||S.content.some(c=>c.created&&c.created.startsWith(ds))||S.docs.some(doc=>doc.updated&&doc.updated.startsWith(ds));
    if(hasActivity)streak++;else if(i>0)break;
    d.setDate(d.getDate()-1);
  }
  if(!streak)return'';
  return`<div style="margin-top:4px;font-size:10px;color:${streak>=7?'var(--accent)':streak>=3?'var(--yellow)':'var(--text-muted)'}">${streak} day streak</div>`;
}
function weeklyProductivity(){
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());weekStart.setHours(0,0,0,0);
  const days=[];for(let i=0;i<7;i++){const d=new Date(weekStart);d.setDate(d.getDate()+i);days.push(d.toISOString().split('T')[0]);}
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString())).length;
  const createdThisWeek=S.tasks.filter(t=>t.created&&t.created>=weekStart.toISOString()).length;
  const contentThisWeek=S.content.filter(c=>c.created&&c.created>=weekStart.toISOString()).length;
  if(!doneThisWeek&&!createdThisWeek&&!contentThisWeek)return'';
  const dayLabels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const dayCounts=days.map(d=>{const done=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at&&e.at.startsWith(d))).length;const created=S.tasks.filter(t=>t.created&&t.created.startsWith(d)).length;return done+created;});
  const maxC=Math.max(...dayCounts,1);
  const barW=16;const barGap=4;const chartH=28;const svgW=(barW+barGap)*7-barGap;
  const bars=dayCounts.map((c,i)=>{const h=Math.max(2,Math.round((c/maxC)*chartH));const x=i*(barW+barGap);const y=chartH-h;const isToday=days[i]===new Date().toISOString().split('T')[0];return`<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="2" fill="${isToday?'var(--accent)':'rgba(74,222,128,0.3)'}"/><text x="${x+barW/2}" y="${chartH+10}" text-anchor="middle" font-size="6" fill="var(--text-muted)">${dayLabels[i]}</text>${c?`<text x="${x+barW/2}" y="${y-2}" text-anchor="middle" font-size="7" fill="var(--text-muted)">${c}</text>`:''}`;}).join('');
  const sparkSvg=`<svg width="${svgW}" height="${chartH+14}" style="margin-top:6px;display:block">${bars}</svg>`;
  return `<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">This Week</div>${doneThisWeek?`<div style="font-size:10px;color:var(--accent)">${doneThisWeek} tasks completed</div>`:''}<div style="font-size:10px;color:var(--text-muted)">${createdThisWeek} tasks created</div>${contentThisWeek?`<div style="font-size:10px;color:var(--text-muted)">${contentThisWeek} content added</div>`:''} ${sparkSvg}</div>`;
}

function taskWeather(){
  const today=new Date().toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const overdue=active.filter(t=>t.due&&t.due<today).length;
  const blocked=active.filter(t=>t.status==='blocked').length;
  const p0=active.filter(t=>t.priority==='p0').length;
  const inProgress=active.filter(t=>t.status==='progress').length;
  const todayDue=active.filter(t=>t.due===today).length;
  const score=Math.max(0,100-overdue*15-blocked*10-p0*8-(inProgress>5?(inProgress-5)*5:0));
  let weather,icon,color;
  if(score>=80){weather='Clear skies';icon='*';color='var(--accent)';}
  else if(score>=60){weather='Partly cloudy';icon='~';color='var(--yellow)';}
  else if(score>=40){weather='Overcast';icon='=';color='var(--orange)';}
  else if(score>=20){weather='Stormy';icon='!';color='var(--red)';}
  else{weather='Hurricane';icon='!!!';color='var(--red)';}
  const details=[];
  if(overdue)details.push(overdue+' overdue');
  if(blocked)details.push(blocked+' blocked');
  if(p0)details.push(p0+' critical');
  if(todayDue)details.push(todayDue+' due today');
  return`<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:4px">Task Weather</div><div style="font-size:12px;color:${color};font-weight:600">${icon} ${weather}</div>${details.length?`<div style="font-size:9px;color:var(--text-muted)">${details.join(' / ')}</div>`:''}</div>`;
}

function weeklyReport(){
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());weekStart.setHours(0,0,0,0);
  const ws=weekStart.toISOString();
  const done=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=ws));
  const created=S.tasks.filter(t=>t.created&&t.created>=ws);
  const content=S.content.filter(c=>c.created&&c.created>=ws);
  const docs=S.docs.filter(d=>d.updated&&d.updated>=ws);
  const overdue=S.tasks.filter(t=>t.due&&t.due<now.toISOString().split('T')[0]&&t.status!=='done');
  const totalTime=done.reduce((a,t)=>a+(t.timeSpent||0),0);
  let md='# Weekly Report\n';
  md+='*'+weekStart.toLocaleDateString('en-US',{month:'long',day:'numeric'})+' - '+now.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'*\n\n';
  md+='## Summary\n';
  md+='- '+done.length+' tasks completed\n';
  md+='- '+created.length+' tasks created\n';
  md+='- '+content.length+' content items added\n';
  md+='- '+docs.length+' documents edited\n';
  if(totalTime)md+='- '+formatTimeSpent(totalTime)+' tracked\n';
  if(overdue.length)md+='- '+overdue.length+' tasks overdue\n';
  if(done.length){md+='\n## Completed\n';done.forEach(t=>{md+='- [x] '+t.title+(t.project?' ('+t.project+')':'')+'\n';});}
  if(overdue.length){md+='\n## Overdue\n';overdue.forEach(t=>{md+='- [ ] '+t.title+' (due '+t.due+')\n';});}
  const inProg=S.tasks.filter(t=>t.status==='progress');
  if(inProg.length){md+='\n## In Progress\n';inProg.forEach(t=>{md+='- [ ] '+t.title+(t.estimate?' ['+t.estimate+']':'')+'\n';});}
  navigator.clipboard.writeText(md).then(()=>toast('Weekly report copied'));
}

// === CONTENT ===
function renderContent() {
  const themes=[...new Set(S.content.map(c=>c.theme).filter(Boolean))].sort();
  document.getElementById('content-theme-tabs').innerHTML=`<button class="tab-btn ${contentTheme==='all'?'active':''}" onclick="setContentTheme('all',this)">All Themes</button>`+themes.map(t=>`<button class="tab-btn ${contentTheme===t?'active':''}" onclick="setContentTheme('${escA(t)}',this)">${esc(t)}</button>`).join('');
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  let items=S.content;
  const archivedCount=S.content.filter(c=>c.archived).length;
  if(!contentShowArchived)items=items.filter(c=>!c.archived);
  if(contentReadLaterFilter)items=items.filter(c=>c.readLater);
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+c.source+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  // Tag pills
  const allTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))].sort();
  const tagArea=document.getElementById('content-tag-pills');
  if(tagArea&&allTags.length)tagArea.innerHTML=allTags.slice(0,12).map(t=>`<span style="font-size:8px;padding:2px 6px;border-radius:10px;cursor:pointer;border:1px solid ${contentTagFilter===t?'var(--accent)':'var(--border)'};color:${contentTagFilter===t?'var(--accent)':'var(--text-muted)'};background:${contentTagFilter===t?'rgba(74,222,128,0.08)':'transparent'}" onclick="contentTagFilter=contentTagFilter==='${escA(t)}'?null:'${escA(t)}';renderContent()">${esc(t)}</span>`).join('')+(contentTagFilter?`<span style="font-size:8px;color:var(--red);cursor:pointer;padding:2px 4px" onclick="contentTagFilter=null;renderContent()">x clear</span>`:'');
  else if(tagArea)tagArea.innerHTML='';
  const sortVal=(document.getElementById('content-sort')?.value)||'newest';
  if(sortVal==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));
  else if(sortVal==='oldest')items.sort((a,b)=>new Date(a.created||0)-new Date(b.created||0));
  else if(sortVal==='longest')items.sort((a,b)=>b.body.length-a.body.length);
  else if(sortVal==='shortest')items.sort((a,b)=>a.body.length-b.body.length);
  else if(sortVal==='alpha')items.sort((a,b)=>a.body.localeCompare(b.body));
  else if(sortVal==='shuffle')items.sort(()=>Math.random()-0.5);
  else if(sortVal==='theme')items.sort((a,b)=>(a.theme||'zzz').localeCompare(b.theme||'zzz'));
  else if(sortVal==='type')items.sort((a,b)=>(a.type||'zzz').localeCompare(b.type||'zzz'));
  else if(sortVal==='tag')items.sort((a,b)=>((a.tags&&a.tags[0])||'zzz').localeCompare((b.tags&&b.tags[0])||'zzz'));
  else if(sortVal==='source')items.sort((a,b)=>(a.source||'zzz').localeCompare(b.source||'zzz'));
  items.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));
  items.sort((a,b)=>(b.starred?1:0)-(a.starred?1:0));
  const maxShow=40;
  const g=document.getElementById('content-grid');
  const showing=contentShowAll?items:items.slice(0,maxShow);
  const renderCard=c=>{const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;const sizeLabel=wc>500?'long':wc>100?'medium':'short';const sizeColor=wc>500?'var(--accent-cyan)':wc>100?'var(--text-muted)':'var(--yellow)';const hasMd=c.body&&(/\*\*|^#|^[-*] |`[^`]+`|^>/m).test(c.body);const bodyHtml=q?highlight(c.body,q):hasMd?simpleMarkdown(c.body):parseWikiLinks(esc(c.body));if(contentCompact){const preview=esc(c.body.substring(0,100)).replace(/\n/g,' ');return`<div style="display:flex;align-items:center;gap:8px;padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:10px;line-height:1.4${c.pinned?';border-color:rgba(74,222,128,0.2)':''}" onclick="openContentModal(${c.id})">${c.starred?'<span style="color:var(--yellow);font-size:8px;flex-shrink:0">*</span>':''}<span class="badge ${c.type==='caption'?'badge-blue':'badge-purple'}" style="font-size:7px;flex-shrink:0">${c.type}</span><span style="flex:1;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${preview}</span>${c.theme?`<span class="badge badge-muted" style="font-size:7px;flex-shrink:0">${esc(c.theme)}</span>`:''}<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);flex-shrink:0">${wc}w</span><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();copyContent(${c.id})" style="font-size:8px;padding:1px 4px;flex-shrink:0">Copy</button></div>`;}return`<div class="content-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain',JSON.stringify({type:'content',id:${c.id}}))" ${c.pinned?'style="border-color:rgba(74,222,128,0.2)"':''}>${c.starred?'<div style="font-size:8px;color:var(--yellow);padding:4px 10px 0">* Starred</div>':''}${c.pinned?'<div style="font-size:8px;color:var(--accent);text-transform:uppercase;letter-spacing:0.06em;padding:4px 10px 0">Pinned</div>':''}${contentBulkMode?`<div style="padding:4px 8px 0;cursor:pointer" onclick="toggleContentSelect(${c.id},this)"><input type="checkbox" ${contentSelected.has(c.id)?'checked':''} style="pointer-events:none"></div>`:''}<div class="content-card-body" onclick="${contentBulkMode?`toggleContentSelect(${c.id},this.parentElement)`:`this.classList.toggle('expanded')`}" ondblclick="${contentBulkMode?'':`contentInlineEdit(${c.id},this,event)`}">${bodyHtml}</div><div class="content-card-footer"><span class="badge ${c.type==='caption'?'badge-blue':'badge-purple'}" style="cursor:pointer" onclick="event.stopPropagation();setContentType('${c.type}',null);toast('Filtered: ${c.type}')">${c.type}</span>${c.theme?`<span class="badge badge-muted" style="cursor:pointer" onclick="event.stopPropagation();contentTheme='${escA(c.theme)}';renderContent();toast('Theme: ${escA(c.theme)}')">${esc(c.theme)}</span>`:''}${c.source?`<span style="font-size:8px;color:var(--text-muted)">${esc(c.source)}</span>`:''}<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${wc}w${wc>50?' / '+Math.max(1,Math.ceil(wc/238))+'m':''}</span><span style="font-size:7px;color:${sizeColor};border:1px solid ${sizeColor};border-radius:3px;padding:0 3px;opacity:0.6">${sizeLabel}</span>${c.created?`<span style="font-size:8px;color:var(--text-muted)" title="${new Date(c.created).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}">${timeAgo(c.created)}</span>`:''} ${c.editCount?`<span style="font-size:7px;color:var(--accent-cyan);font-family:var(--mono)" title="Edited ${c.editCount} time${c.editCount>1?'s':''}">${c.editCount}e</span>`:''} ${(c.tags||[]).map(t=>`<span class="badge badge-muted" style="font-size:7px">${esc(t)}</span>`).join('')}<div class="content-card-actions"><button class="btn btn-sm btn-ghost" onclick="starContent(${c.id})" style="${c.starred?'color:var(--yellow)':''}">*</button><button class="btn btn-sm btn-ghost" onclick="pinContent(${c.id})" style="${c.pinned?'color:var(--accent)':''}">${c.pinned?'Unpin':'Pin'}</button><button class="btn btn-sm btn-ghost" onclick="copyContent(${c.id})">Copy</button><button class="btn btn-sm btn-ghost" onclick="openContentModal(${c.id})">Edit</button><button class="btn btn-sm btn-ghost" onclick="dupContent(${c.id})">Dup</button><button class="btn btn-sm btn-ghost" onclick="readContent(${c.id})">Read</button><button class="btn btn-sm btn-ghost" onclick="contentToDoc(${c.id})">Doc</button><button class="btn btn-sm btn-ghost" onclick="contentToPipeline(${c.id})">Pipe</button><button class="btn btn-sm btn-ghost" onclick="contentToTask(${c.id})" title="Convert to task">Task</button><button class="btn btn-sm btn-ghost" onclick="splitContent(${c.id})" title="Split at ---">Split</button><button class="btn btn-sm btn-ghost" onclick="toggleReadLater(${c.id})" style="${c.readLater?'color:var(--accent-cyan)':''}">${c.readLater?'Unlist':'RL'}</button><button class="btn btn-sm btn-ghost" onclick="archiveContent(${c.id})" style="${c.archived?'color:var(--yellow)':''}">${c.archived?'Unarc':'Arc'}</button><button class="btn btn-sm btn-ghost btn-danger" onclick="delContent(${c.id})">Del</button></div></div></div>`;};
  const dateGrp=d=>{if(!d)return'Unknown';const now=new Date();const cd=new Date(d);const diff=Math.floor((now-cd)/86400000);if(diff<1)return'Today';if(diff<7)return'This Week';if(diff<30)return'This Month';if(diff<90)return'Last 3 Months';return'Older';};
  const wcGrp=wc=>{if(wc===0)return'Empty';if(wc<50)return'Short (<50w)';if(wc<200)return'Medium (50-200w)';if(wc<500)return'Long (200-500w)';return'Very Long (500w+)';};
  let cardsHtml='';if(sortVal==='theme'||sortVal==='type'||sortVal==='newest'||sortVal==='oldest'||sortVal==='longest'||sortVal==='shortest'||sortVal==='alpha'||sortVal==='tag'||sortVal==='source'){let lastGrp=null;showing.forEach(c=>{const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;let grp;if(sortVal==='theme')grp=c.theme||'Unthemed';else if(sortVal==='type')grp=c.type||'other';else if(sortVal==='tag')grp=(c.tags&&c.tags[0])||'Untagged';else if(sortVal==='source')grp=c.source||'Unknown';else if(sortVal==='longest'||sortVal==='shortest')grp=wcGrp(wc);else if(sortVal==='alpha')grp=(c.body||' ')[0].toUpperCase();else grp=dateGrp(c.created);if(grp!==lastGrp){const cnt=showing.filter(x=>{const xwc=x.body.trim().split(/\s+/).filter(z=>z.length).length;if(sortVal==='theme')return(x.theme||'Unthemed')===grp;if(sortVal==='type')return(x.type||'other')===grp;if(sortVal==='tag')return((x.tags&&x.tags[0])||'Untagged')===grp;if(sortVal==='source')return(x.source||'Unknown')===grp;if(sortVal==='longest'||sortVal==='shortest')return wcGrp(xwc)===grp;if(sortVal==='alpha')return(x.body||' ')[0].toUpperCase()===grp;return dateGrp(x.created)===grp;}).length;const clr=sortVal==='type'?(grp==='caption'?'#3b82f6':'#a855f7'):(sortVal==='newest'||sortVal==='oldest')?'var(--yellow)':(sortVal==='longest'||sortVal==='shortest')?'var(--accent-cyan)':sortVal==='tag'?'#f59e0b':sortVal==='source'?'#ec4899':sortVal==='alpha'?'var(--accent)':'var(--accent)';cardsHtml+=`<div style="grid-column:1/-1;padding:8px 4px 4px;font-size:11px;font-weight:600;color:${clr};border-bottom:1px solid var(--border);margin-bottom:2px;text-transform:uppercase;letter-spacing:0.05em">${esc(grp)} <span style="font-size:9px;color:var(--text-muted);font-weight:400">${cnt}</span></div>`;lastGrp=grp;}cardsHtml+=renderCard(c);});}else{cardsHtml=showing.map(renderCard).join('');}
  g.innerHTML=!items.length?`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">C</div><div style="font-size:12px">${q?'No matching content':'No content yet'}</div><div style="font-size:10px;margin-top:4px">${q?'Try a different search term':'Click + Add to paste from Apple Notes'}</div></div>`:cardsHtml+(items.length>maxShow&&!contentShowAll?`<div style="grid-column:1/-1;text-align:center;padding:12px"><button class="btn btn-sm" onclick="contentShowAll=true;renderContent()">Show all ${items.length} items (${items.length-maxShow} more)</button></div>`:'');
  document.getElementById('content-count').textContent=S.content.length;
  const totalWords=S.content.reduce((sum,c)=>sum+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
  const cwEl=document.getElementById('content-word-total');if(cwEl){const types={};S.content.forEach(c=>{const t=c.type||'other';types[t]=(types[t]||0)+1;});const breakdown=Object.entries(types).sort((a,b)=>b[1]-a[1]).map(([t,n])=>t+':'+n).join(' | ');cwEl.textContent=totalWords.toLocaleString()+'w total';cwEl.title=breakdown;}
}
function setContentType(t,el){contentType=t;document.querySelectorAll('#content-type-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderContent();}
function setContentTheme(t,el){contentTheme=t;document.querySelectorAll('#content-theme-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderContent();}
function openContentModal(id){editingContentId=id||null;document.getElementById('content-modal-title').textContent=id?'Edit Content':'Add Content';
  // Populate theme datalist
  const themes=[...new Set(S.content.map(c=>c.theme).filter(Boolean))].sort();
  let dl=document.getElementById('theme-dl');if(!dl){dl=document.createElement('datalist');dl.id='theme-dl';document.body.appendChild(dl);}
  dl.innerHTML=themes.map(t=>`<option value="${esc(t)}">`).join('');
  document.getElementById('cm-theme').setAttribute('list','theme-dl');
  if(id){const c=S.content.find(x=>x.id===id);if(c){document.getElementById('cm-type').value=c.type;document.getElementById('cm-theme').value=c.theme||'';document.getElementById('cm-body').value=c.body;document.getElementById('cm-source').value=c.source||'';document.getElementById('cm-tags').value=(c.tags||[]).join(', ');}}else{document.getElementById('cm-type').value='caption';document.getElementById('cm-theme').value='';document.getElementById('cm-body').value='';document.getElementById('cm-source').value='';document.getElementById('cm-tags').value='';}document.getElementById('content-modal').classList.add('open');setTimeout(()=>document.getElementById('cm-body').focus(),100);}
function closeContentModal(){document.getElementById('content-modal').classList.remove('open');editingContentId=null;}
function saveContent(){const type=document.getElementById('cm-type').value,theme=document.getElementById('cm-theme').value.trim().toLowerCase(),body=document.getElementById('cm-body').value.trim(),source=document.getElementById('cm-source').value.trim(),tags=(document.getElementById('cm-tags').value||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);if(!body){toast('Content cannot be empty');return;}if(editingContentId){const c=S.content.find(x=>x.id===editingContentId);if(c){c.type=type;c.theme=theme;c.body=body;c.source=source;c.tags=tags;c.updated=new Date().toISOString();c.editCount=(c.editCount||0)+1;}}else S.content.push({id:Date.now(),type,theme,body,source,tags,created:new Date().toISOString(),updated:new Date().toISOString()});save();closeContentModal();renderContent();toast(editingContentId?'Updated':'Added');}
let lastDeletedContent=null;
function delContent(id){const c=S.content.find(x=>x.id===id);if(c)lastDeletedContent={...c};S.content=S.content.filter(c=>c.id!==id);save();renderContent();toast('Deleted — Cmd+Z to undo');}
function undoDeleteContent(){if(!lastDeletedContent)return;S.content.unshift(lastDeletedContent);lastDeletedContent=null;save();renderContent();toast('Restored');}
function copyContent(id){const c=S.content.find(x=>x.id===id);if(c){navigator.clipboard.writeText(c.body);toast('Copied');}}
function randomContent(){if(!S.content.length){toast('No content yet');return;}const r=S.content[Math.floor(Math.random()*S.content.length)];navigator.clipboard.writeText(r.body);toast('Random: '+(r.body.substring(0,50)+'...'));document.getElementById('content-search').value='';contentType='all';contentTheme='all';contentTagFilter=null;renderContent();setTimeout(()=>{const cards=document.querySelectorAll('.content-card');const idx=S.content.indexOf(r);if(cards[idx])cards[idx].scrollIntoView({behavior:'smooth',block:'center'});},100);}
function pinContent(id){const c=S.content.find(x=>x.id===id);if(c){c.pinned=!c.pinned;save();renderContent();toast(c.pinned?'Pinned':'Unpinned');}}
function splitContent(id){const c=S.content.find(x=>x.id===id);if(!c)return;const parts=c.body.split(/\n---\n|^---$|\n---$/m).map(p=>p.trim()).filter(Boolean);if(parts.length<=1){toast('No --- separator found');return;}if(!confirm('Split into '+parts.length+' items?'))return;S.content=S.content.filter(x=>x.id!==id);parts.forEach((p,i)=>{S.content.unshift({id:Date.now()+i,type:c.type,theme:c.theme||'',body:p,tags:[...(c.tags||[])],source:c.source||'',created:new Date().toISOString()});});save();renderContent();toast('Split into '+parts.length+' items');}
function readContent(id){
  const c=S.content.find(x=>x.id===id);if(!c)return;
  const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;
  const readTime=Math.max(1,Math.ceil(wc/238));
  let existing=document.getElementById('content-reader');if(existing)existing.remove();
  const overlay=document.createElement('div');overlay.id='content-reader';
  overlay.style.cssText='position:fixed;inset:0;z-index:9999;background:var(--bg-void);display:flex;flex-direction:column;overflow-y:auto';
  overlay.innerHTML=`<div style="max-width:680px;margin:0 auto;padding:40px 24px;width:100%"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px"><div style="display:flex;gap:8px;align-items:center"><span class="badge ${c.type==='caption'?'badge-blue':'badge-purple'}">${c.type}</span>${c.theme?`<span class="badge badge-muted">${esc(c.theme)}</span>`:''}<span style="font-size:10px;color:var(--text-muted)">${wc} words / ${readTime} min read</span></div><button onclick="this.closest('#content-reader').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:8px">x close</button></div><div style="font-size:15px;line-height:2;color:var(--text);white-space:pre-wrap">${parseWikiLinks(esc(c.body))}</div>${(c.tags||[]).length?`<div style="margin-top:24px;display:flex;gap:4px;flex-wrap:wrap">${c.tags.map(t=>`<span class="badge badge-muted" style="font-size:8px">${esc(t)}</span>`).join('')}</div>`:''}<div style="margin-top:24px;display:flex;gap:8px"><button class="btn btn-sm" onclick="navigator.clipboard.writeText(${JSON.stringify(c.body).replace(/'/g,"\\'")});toast('Copied')">Copy</button><button class="btn btn-sm" onclick="this.closest('#content-reader').remove();openContentModal(${c.id})">Edit</button></div></div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('keydown',e=>{if(e.key==='Escape')overlay.remove();});
  overlay.tabIndex=0;overlay.focus();
}
function starContent(id){const c=S.content.find(x=>x.id===id);if(c){c.starred=!c.starred;save();renderContent();toast(c.starred?'Starred':'Unstarred');}}
function archiveContent(id){const c=S.content.find(x=>x.id===id);if(c){c.archived=!c.archived;save();renderContent();toast(c.archived?'Archived':'Unarchived');}}
function toggleReadLater(id){const c=S.content.find(x=>x.id===id);if(c){c.readLater=!c.readLater;save();renderContent();toast(c.readLater?'Added to Read Later':'Removed from Read Later');}}
function contentToTask(id){const c=S.content.find(x=>x.id===id);if(!c)return;const title=(c.body||'').split('\n')[0].substring(0,80).trim()||'Task from content';const desc=(c.body||'').substring(0,500);S.tasks.unshift({id:Date.now(),title,description:desc,subtasks:[],status:'todo',priority:'p2',project:'',due:'',tags:(c.tags||[]).slice(),created:new Date().toISOString()});save();renderContent();toast('Task created: '+title.substring(0,30));}
function batchImportContent(){
  const text=prompt('Paste content items separated by --- (three dashes):');
  if(!text)return;
  const items=text.split(/\n---\n|\n---$|^---\n/).map(s=>s.trim()).filter(Boolean);
  if(!items.length){toast('No items found');return;}
  items.forEach(body=>{S.content.unshift({id:Date.now()+Math.random()*1000,type:'caption',theme:'imported',body,tags:['batch-import'],created:new Date().toISOString()});});
  save();renderContent();toast('Imported '+items.length+' content items');
}
function contentToDoc(id){const c=S.content.find(x=>x.id===id);if(!c)return;const title=(c.theme||'Untitled')+' — '+(c.body.substring(0,40).replace(/\n/g,' '));S.docs.push({id:Date.now(),title,body:c.body.replace(/\n/g,'<br>'),created:new Date().toISOString(),updated:new Date().toISOString(),versions:[]});save();toast('Created doc: '+title.substring(0,30));if(currentSection==='writer')renderWriter();}
function contentToPipeline(id){const c=S.content.find(x=>x.id===id);if(!c)return;switchSection('pipeline',null);setTimeout(()=>{const ta=document.getElementById('pl-transcript-box');if(ta){ta.style.display='block';ta.value=c.body;plTranscriptText=c.body;const wc=document.getElementById('pl-text-stats');if(wc){const words=c.body.trim().split(/\s+/).filter(x=>x.length).length;wc.textContent=words+' words, '+c.body.length+' chars';}toast('Content loaded in pipeline');}},200);}
function dupContent(id){const c=S.content.find(x=>x.id===id);if(!c)return;S.content.unshift({...c,id:Date.now(),pinned:false,created:new Date().toISOString()});save();renderContent();toast('Duplicated');}
function mergeContent(){if(contentSelected.size<2){toast('Select 2+ items to merge');return;}const items=[...contentSelected].map(id=>S.content.find(c=>c.id===id)).filter(Boolean);const merged=items.map(c=>c.body).join('\n\n---\n\n');const tags=[...new Set(items.flatMap(c=>c.tags||[]))];S.content.unshift({id:Date.now(),type:items[0].type||'caption',theme:items[0].theme||'',body:merged,tags,source:'merged',created:new Date().toISOString()});save();contentSelected.clear();contentBulkMode=false;renderContent();toast('Merged '+items.length+' items');}
function exportContent(){
  const items=S.content;
  const groups={};
  items.forEach(c=>{const g=c.theme||'Unthemed';if(!groups[g])groups[g]=[];groups[g].push(c);});
  let md='# Content Export\n';
  md+='Generated: '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n';
  md+=items.length+' items total\n\n';
  Object.keys(groups).sort().forEach(g=>{
    md+='## '+g+'\n\n';
    groups[g].forEach(c=>{
      md+='### '+c.type+(c.source?' ('+c.source+')':'')+'\n';
      md+=c.body+'\n';
      if(c.tags&&c.tags.length)md+='Tags: '+c.tags.join(', ')+'\n';
      md+='\n---\n\n';
    });
  });
  navigator.clipboard.writeText(md).then(()=>toast('Content copied as markdown')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='content-export.md';a.click();toast('Content exported');
  });
}
function exportContentHTML(){
  if(!S.content.length){toast('No content');return;}
  const groups={};S.content.forEach(c=>{const g=c.theme||'Unthemed';if(!groups[g])groups[g]=[];groups[g].push(c);});
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Content Export - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:20px;color:#22d3ee;margin-top:32px;border-bottom:1px solid #222;padding-bottom:4px}hr{border:none;border-top:1px solid #222;margin:16px 0}.item{margin:12px 0;padding:12px;background:#101014;border-radius:8px;border-left:3px solid #4ade80}.meta{font-size:11px;color:#888;margin-top:6px}.tag{display:inline-block;font-size:9px;padding:1px 6px;border-radius:8px;border:1px solid rgba(74,222,128,0.3);color:#4ade80;margin-right:4px}</style></head><body>';
  h+='<h1>Content Export</h1><p style="color:#888;font-size:13px">'+S.content.length+' items | Exported '+new Date().toLocaleDateString()+'</p>';
  Object.keys(groups).sort().forEach(g=>{h+='<h2>'+esc(g)+' ('+groups[g].length+')</h2>';groups[g].forEach(c=>{const wc=c.body.trim().split(/\s+/).filter(x=>x.length).length;h+='<div class="item"><div style="white-space:pre-wrap">'+esc(c.body)+'</div><div class="meta">'+c.type+(c.source?' | '+esc(c.source):'')+' | '+wc+'w'+(c.tags&&c.tags.length?' | '+c.tags.map(t=>'<span class="tag">'+esc(t)+'</span>').join(''):'')+'</div></div>';});});
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-content-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.content.length+' items as HTML');
}
function exportFilteredContentMD(){
  let items=[...S.content];
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  if(!items.length){toast('No visible items');return;}
  let md='# Content Export\n\n'+items.length+' items | Exported '+new Date().toLocaleDateString()+'\n\n';
  if(contentType!=='all')md+='Filter: type='+contentType+'\n';
  if(contentTheme!=='all')md+='Filter: theme='+contentTheme+'\n';
  if(contentTagFilter)md+='Filter: tag='+contentTagFilter+'\n';
  md+='\n---\n\n';
  items.forEach(c=>{md+=c.body+'\n\n*'+c.type+(c.theme?' / '+c.theme:'')+(c.tags&&c.tags.length?' / tags: '+c.tags.join(', '):'')+' / '+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length+'w*\n\n---\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Copied '+items.length+' items as Markdown'));
}
function toggleAllContentCards(){
  const cards=document.querySelectorAll('.content-card-body');
  const anyExpanded=[...cards].some(c=>c.classList.contains('expanded'));
  cards.forEach(c=>{if(anyExpanded)c.classList.remove('expanded');else c.classList.add('expanded');});
  toast(anyExpanded?'All collapsed':'All expanded');
}
function copyAllContent(){
  let items=[...S.content];
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  if(q)items=items.filter(c=>(c.body+' '+c.theme).toLowerCase().includes(q));
  if(!items.length){toast('No content to copy');return;}
  const text=items.map(c=>c.body).join('\n\n---\n\n');
  navigator.clipboard.writeText(text).then(()=>toast(items.length+' items copied'));
}
function exportFilteredContent(){
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  let items=[...S.content];
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+c.source+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  if(!items.length){toast('No items to export');return;}
  let md='# Filtered Content Export\n';
  md+='Filter: '+(contentType!=='all'?contentType+' / ':'')+(contentTheme!=='all'?contentTheme+' / ':'')+(contentTagFilter?'#'+contentTagFilter+' / ':'')+(q?'"'+q+'" / ':'')+items.length+' items\n\n';
  items.forEach(c=>{md+=c.body+'\n\n---\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Exported '+items.length+' filtered items'));
}
let contentBulkMode=false, contentSelected=new Set(), contentShowAll=false, contentCompact=false, contentShowArchived=false, contentReadLaterFilter=false;
function toggleContentCompact(){contentCompact=!contentCompact;const btn=document.getElementById('content-compact-btn');if(btn)btn.style.color=contentCompact?'var(--accent)':'';const g=document.getElementById('content-grid');if(g){g.style.gridTemplateColumns=contentCompact?'1fr':'repeat(auto-fill,minmax(280px,1fr))';if(contentCompact)g.style.gap='2px';else g.style.gap='';}renderContent();}
function toggleContentBulk(){
  contentBulkMode=!contentBulkMode;contentSelected.clear();
  document.getElementById('content-bulk-btn').style.display=contentBulkMode?'none':'';
  document.getElementById('content-bulk-actions').style.display=contentBulkMode?'flex':'none';
  renderContent();
}
function toggleContentSelect(id,el){
  if(contentSelected.has(id))contentSelected.delete(id);else contentSelected.add(id);
  el.closest('.content-card').style.outline=contentSelected.has(id)?'2px solid var(--accent)':'none';
}
function contentBulkDelete(){
  if(!contentSelected.size){toast('Select items first');return;}
  if(!confirm('Delete '+contentSelected.size+' items?'))return;
  S.content=S.content.filter(c=>!contentSelected.has(c.id));
  save();contentSelected.clear();renderContent();toast('Deleted');
}
function contentBulkTag(){
  if(!contentSelected.size){toast('Select items first');return;}
  const tag=prompt('Enter tag to add:');
  if(!tag)return;
  const t=tag.trim().toLowerCase();
  S.content.forEach(c=>{if(contentSelected.has(c.id)){if(!c.tags)c.tags=[];if(!c.tags.includes(t))c.tags.push(t);}});
  save();contentSelected.clear();renderContent();toast('Tagged');
}
function tagAllVisibleContent(){
  let items=S.content;
  if(contentType!=='all')items=items.filter(c=>c.type===contentType);
  if(contentTheme!=='all')items=items.filter(c=>c.theme===contentTheme);
  if(contentTagFilter)items=items.filter(c=>(c.tags||[]).includes(contentTagFilter));
  const q=(document.getElementById('content-search')?.value||'').toLowerCase();
  if(q)items=items.filter(c=>(c.body+' '+c.theme+' '+(c.tags||[]).join(' ')).toLowerCase().includes(q));
  if(!items.length){toast('No visible items');return;}
  const tag=prompt('Tag to add to '+items.length+' visible items:');
  if(!tag)return;const t=tag.trim().toLowerCase();
  items.forEach(c=>{if(!c.tags)c.tags=[];if(!c.tags.includes(t))c.tags.push(t);});
  save();renderContent();toast('Tagged '+items.length+' items with "'+t+'"');
}
function contentBulkExport(){
  if(!contentSelected.size){toast('Select items first');return;}
  const items=[...contentSelected].map(id=>S.content.find(c=>c.id===id)).filter(Boolean);
  let md='# Selected Content Export\n'+items.length+' items\n\n';
  items.forEach(c=>{md+=`## ${c.theme||c.type||'Content'}\n${c.body}\n`;if(c.tags&&c.tags.length)md+='Tags: '+c.tags.join(', ')+'\n';md+='\n---\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Exported '+items.length+' items to clipboard'));
}
function contentManageTags(){
  const allTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))].sort();
  if(!allTags.length){toast('No tags to manage');return;}
  const action=prompt('Tag Management\n\nTags: '+allTags.join(', ')+'\n\nType:\n- rename:oldtag:newtag\n- delete:tagname');
  if(!action)return;
  if(action.startsWith('rename:')){const parts=action.split(':');if(parts.length===3){const old=parts[1].trim(),nw=parts[2].trim();let count=0;S.content.forEach(c=>{if(c.tags){const i=c.tags.indexOf(old);if(i>=0){c.tags[i]=nw;count++;}}});save();renderContent();toast('Renamed "'+old+'" to "'+nw+'" in '+count+' items');}}
  else if(action.startsWith('delete:')){const tag=action.substring(7).trim();let count=0;S.content.forEach(c=>{if(c.tags){const i=c.tags.indexOf(tag);if(i>=0){c.tags.splice(i,1);count++;}}});save();renderContent();toast('Removed "'+tag+'" from '+count+' items');}
  else{toast('Use rename:old:new or delete:tagname');}
}
function contentInlineEdit(id,el,e){
  e.stopPropagation();e.preventDefault();
  const c=S.content.find(x=>x.id===id);if(!c)return;
  el.classList.add('expanded');
  const ta=document.createElement('textarea');
  ta.value=c.body;ta.style.cssText='width:100%;min-height:120px;resize:vertical;font-size:11px;line-height:1.6;padding:8px;background:var(--bg-input);color:var(--text);border:1px solid var(--accent);border-radius:4px;font-family:var(--font);outline:none';
  el.innerHTML='';el.appendChild(ta);ta.focus();
  let saved=false;
  function finishEdit(){if(saved)return;saved=true;const v=ta.value.trim();if(v&&v!==c.body){c.body=v;c.updated=new Date().toISOString();save();toast('Saved');}renderContent();}
  ta.addEventListener('blur',finishEdit);
  ta.addEventListener('keydown',ev=>{if(ev.key==='Escape'){saved=true;renderContent();}if((ev.metaKey||ev.ctrlKey)&&ev.key==='Enter')finishEdit();});
}
function contentFindDuplicates(){
  if(S.content.length<2){toast('Need 2+ items');return;}
  const dupes=[];const normalize=s=>(s||'').toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
  for(let i=0;i<S.content.length;i++){
    for(let j=i+1;j<S.content.length;j++){
      const a=normalize(S.content[i].body),b=normalize(S.content[j].body);
      if(!a||!b||a.length<20)continue;
      const short=a.length<b.length?a:b;const long=a.length<b.length?b:a;
      if(short===long||long.includes(short)){
        dupes.push({a:S.content[i],b:S.content[j],type:short===long?'exact':'contained'});
      } else {
        const aWords=new Set(a.split(' '));const bWords=new Set(b.split(' '));
        const overlap=[...aWords].filter(w=>bWords.has(w)).length;
        const sim=overlap/Math.max(aWords.size,bWords.size);
        if(sim>0.7)dupes.push({a:S.content[i],b:S.content[j],type:'similar ('+Math.round(sim*100)+'%)'});
      }
    }
  }
  if(!dupes.length){toast('No duplicates found');return;}
  const panel=document.createElement('div');panel.id='content-dupes-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;padding:20px;z-index:9999;max-width:600px;max-height:70vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.6)';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="color:var(--accent);font-weight:600">Potential Duplicates ('+dupes.length+')</span><button onclick="this.closest(\'#content-dupes-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  dupes.slice(0,20).forEach((d,i)=>{
    const pa=d.a.body.substring(0,60).replace(/\n/g,' ');const pb=d.b.body.substring(0,60).replace(/\n/g,' ');
    html+='<div style="padding:8px;margin:4px 0;background:var(--bg-elevated);border-radius:6px;font-size:10px;line-height:1.5">';
    html+='<div style="color:var(--yellow);font-size:9px;margin-bottom:4px">'+esc(d.type)+'</div>';
    html+='<div style="color:var(--text)">A: '+esc(pa)+'...</div>';
    html+='<div style="color:var(--text-muted)">B: '+esc(pb)+'...</div>';
    html+='<button onclick="delContent('+d.b.id+');this.closest(\'#content-dupes-panel\').remove();contentFindDuplicates()" style="margin-top:4px;font-size:9px;padding:2px 8px;background:var(--red);color:#fff;border:none;border-radius:4px;cursor:pointer">Delete B</button>';
    html+='</div>';
  });
  if(dupes.length>20)html+='<div style="color:var(--text-muted);font-size:10px;padding:8px">...and '+(dupes.length-20)+' more</div>';
  panel.innerHTML=html;document.body.appendChild(panel);
}

// === TASKS ===
function setTaskView(v){taskView=v;document.getElementById('task-view-list').classList.toggle('active',v==='list');document.getElementById('task-view-board').classList.toggle('active',v==='board');document.getElementById('task-view-eisenhower').classList.toggle('active',v==='eisenhower');document.getElementById('task-list-view').style.display=v==='list'?'block':'none';document.getElementById('task-board-view').classList.toggle('active',v==='board');const ehEl=document.getElementById('task-eisenhower-view');if(ehEl)ehEl.style.display=v==='eisenhower'?'grid':'none';renderTasks();}
function renderEisenhower(){
  const today=new Date().toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const isUrgent=t=>t.priority==='p0'||t.priority==='p1'||(t.due&&t.due<=today);
  const isImportant=t=>t.priority==='p0'||(t.priority==='p1'&&t.status!=='blocked');
  const q1=[],q2=[],q3=[],q4=[];
  active.forEach(t=>{const u=isUrgent(t),i=isImportant(t);if(u&&i)q1.push(t);else if(!u&&i)q2.push(t);else if(u&&!i)q3.push(t);else q4.push(t);});
  const cardHtml=t=>`<div style="padding:6px 8px;background:var(--bg-elevated);border-radius:4px;margin-bottom:4px;cursor:pointer;font-size:11px;border-left:3px solid ${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':t.priority==='p2'?'var(--blue)':'var(--text-muted)'}" onclick="openTaskDetail(${t.id})"><div style="font-weight:600;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">${(t.priority||'p2').toUpperCase()}${t.due?' | '+t.due:''}${t.project?' | '+esc(t.project):''}</div></div>`;
  ['eh-q1','eh-q2','eh-q3','eh-q4'].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.innerHTML=[q1,q2,q3,q4][i].map(cardHtml).join('')||'<div style="font-size:10px;color:var(--text-muted);font-style:italic">None</div>';});
}
function setTaskFilter(f){taskFilter=f;taskProjectFilter=null;['all','active','todo','progress','blocked','done','overdue','urgent'].forEach(k=>{const el=document.getElementById('task-filter-'+k);if(el)el.classList.toggle('active',f===k);});renderTasks();}
function clearTaskFilters(){taskFilter='all';taskProjectFilter=null;const ts=document.getElementById('task-search');if(ts)ts.value='';const tsort=document.getElementById('task-sort');if(tsort)tsort.value='manual';const tpf=document.getElementById('task-project-filter');if(tpf)tpf.value='';['all','active','todo','progress','blocked','done','overdue','urgent'].forEach(k=>{const el=document.getElementById('task-filter-'+k);if(el)el.classList.toggle('active',k==='all');});renderTasks();toast('Filters cleared');}
function filterTaskProject(p){taskProjectFilter=p;taskFilter='all';renderTasks();}
function getFilteredTasks(){const q=(document.getElementById('task-search')?.value||'').toLowerCase();let items=[...S.tasks];if(taskFilter==='active')items=items.filter(t=>t.status!=='done');else if(taskFilter==='todo')items=items.filter(t=>t.status==='todo');else if(taskFilter==='progress')items=items.filter(t=>t.status==='progress');else if(taskFilter==='blocked')items=items.filter(t=>t.status==='blocked');else if(taskFilter==='done')items=items.filter(t=>t.status==='done');else if(taskFilter==='overdue'){const td=new Date().toISOString().split('T')[0];items=items.filter(t=>t.status!=='done'&&t.due&&t.due<td);}else if(taskFilter==='urgent'){items=items.filter(t=>t.status!=='done'&&(t.priority==='p0'||t.priority==='p1'));}if(taskProjectFilter)items=items.filter(t=>t.project===taskProjectFilter);if(q){if(q.startsWith('#')){const tagQ=q.substring(1);items=items.filter(t=>(t.tags||[]).some(tag=>tag.includes(tagQ)));}else{items=items.filter(t=>(t.title+' '+t.project+' '+(t.description||'')+' '+(t.tags||[]).join(' ')).toLowerCase().includes(q));}}const sortVal=(document.getElementById('task-sort')?.value)||'manual';const pMap={p0:0,p1:1,p2:2,p3:3};if(sortVal==='priority')items.sort((a,b)=>(pMap[a.priority]||2)-(pMap[b.priority]||2));else if(sortVal==='due')items.sort((a,b)=>(a.due||'9999').localeCompare(b.due||'9999'));else if(sortVal==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));else if(sortVal==='alpha')items.sort((a,b)=>(a.title||'').localeCompare(b.title||''));else if(sortVal==='completed')items.sort((a,b)=>new Date(b.completedAt||0)-new Date(a.completedAt||0));else if(sortVal==='project')items.sort((a,b)=>(a.project||'zzz').localeCompare(b.project||'zzz'));else if(sortVal==='time')items.sort((a,b)=>(b.timeSpent||0)-(a.timeSpent||0));else if(sortVal==='status'){const sMap={progress:0,todo:1,blocked:2,done:3};items.sort((a,b)=>(sMap[a.status]||1)-(sMap[b.status]||1));}else if(sortVal==='estimate'){const parseEst=e=>{if(!e)return 9999;const n=parseFloat(e);if(e.includes('d'))return n*480;if(e.includes('h'))return n*60;if(e.includes('m'))return n;return n;};items.sort((a,b)=>parseEst(a.estimate)-parseEst(b.estimate));}else if(sortVal==='tag'){items.sort((a,b)=>((a.tags&&a.tags[0])||'zzz').localeCompare((b.tags&&b.tags[0])||'zzz'));}return items;}

function renderTasks(){
  const items=getFilteredTasks();
  const today=new Date().toISOString().split('T')[0];
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  const rows=document.getElementById('task-rows');
  const sortVal=(document.getElementById('task-sort')?.value)||'manual';
  let lastProj=null;let lastGroup=null;
  rows.innerHTML=items.map(t=>{let hdr='';if(sortVal==='project'){const pg=t.project||'No Project';if(pg!==lastProj){hdr=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastProj===null?'0':'8'}px;font-family:var(--mono)">${esc(pg)}</div>`;lastProj=pg;}}if(sortVal==='priority'){const pg=t.priority||'p2';if(pg!==lastGroup){const pColors={p0:'var(--red)',p1:'var(--orange)',p2:'var(--accent-cyan)',p3:'var(--text-muted)'};const pNames={p0:'P0 Critical',p1:'P1 High',p2:'P2 Medium',p3:'P3 Low'};hdr=`<div style="padding:6px 8px 3px;font-size:9px;color:${pColors[pg]||'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${pNames[pg]||pg} (${items.filter(x=>(x.priority||'p2')===pg).length})</div>`;lastGroup=pg;}}if(sortVal==='status'){const sg=t.status||'todo';if(sg!==lastGroup){const sColors={progress:'var(--green)',todo:'var(--accent-cyan)',blocked:'var(--orange)',done:'var(--text-muted)'};const sNames={progress:'In Progress',todo:'To Do',blocked:'Blocked',done:'Done'};hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:${sColors[sg]||'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${sNames[sg]||sg} (${items.filter(x=>x.status===sg).length})</div>`;lastGroup=sg;}}if(sortVal==='estimate'){const eg=t.estimate||'No Estimate';if(eg!==lastGroup){hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${esc(eg)} (${items.filter(x=>(x.estimate||'No Estimate')===eg).length})</div>`;lastGroup=eg;}}if(sortVal==='time'){const tm=t.timeSpent||0;const tg=tm===0?'No Time':tm<30?'< 30m':tm<60?'30m - 1h':tm<120?'1h - 2h':'2h+';if(tg!==lastGroup){const cnt=items.filter(x=>{const m=x.timeSpent||0;const g=m===0?'No Time':m<30?'< 30m':m<60?'30m - 1h':m<120?'1h - 2h':'2h+';return g===tg;}).length;hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--green);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${tg} (${cnt})</div>`;lastGroup=tg;}}if(sortVal==='due'){const dueGrp=d=>{if(!d)return'No Date';if(d<today)return'Overdue';if(d===today)return'Today';const tmrw=new Date(new Date().getTime()+86400000).toISOString().split('T')[0];if(d===tmrw)return'Tomorrow';const wkEnd=new Date(new Date().getTime()+7*86400000).toISOString().split('T')[0];if(d<=wkEnd)return'This Week';const nwEnd=new Date(new Date().getTime()+14*86400000).toISOString().split('T')[0];if(d<=nwEnd)return'Next Week';return'Later';};const dg=dueGrp(t.due);if(dg!==lastGroup){const cnt=items.filter(x=>dueGrp(x.due)===dg).length;const dgClr=dg==='Overdue'?'var(--red)':dg==='Today'?'var(--accent)':dg==='Tomorrow'?'var(--yellow)':'var(--text-muted)';hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:${dgClr};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${dg} (${cnt})</div>`;lastGroup=dg;}}if(sortVal==='newest'||sortVal==='completed'){const ageGrp=d=>{if(!d)return'Unknown';const diff=Math.floor((new Date()-new Date(d))/86400000);if(diff<1)return'Today';if(diff<7)return'This Week';if(diff<30)return'This Month';return'Older';};const dateField=sortVal==='completed'?t.completedAt:t.created;const ag=ageGrp(dateField);if(ag!==lastGroup){const cnt=items.filter(x=>ageGrp(sortVal==='completed'?x.completedAt:x.created)===ag).length;const clr=sortVal==='completed'?'var(--accent)':'var(--yellow)';hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:${clr};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${sortVal==='completed'?'Completed ':''}${ag} (${cnt})</div>`;lastGroup=ag;}}if(sortVal==='tag'){const tg=(t.tags&&t.tags[0])||'Untagged';if(tg!==lastGroup){const cnt=items.filter(x=>((x.tags&&x.tags[0])||'Untagged')===tg).length;hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${esc(tg)} (${cnt})</div>`;lastGroup=tg;}}if(sortVal==='alpha'){const letter=(t.title||'Untitled')[0].toUpperCase();if(letter!==lastGroup){const cnt=items.filter(x=>((x.title||'Untitled')[0].toUpperCase())===letter).length;hdr+=`<div style="padding:6px 8px 3px;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:${lastGroup===null?'0':'8'}px;font-family:var(--mono)">${letter} (${cnt})</div>`;lastGroup=letter;}}return hdr+`<div class="task-row ${t.status==='done'?'completed':''} priority-${t.priority||'p2'}${t.due&&t.due<today&&t.status!=='done'?' overdue':''}${t.status==='blocked'?' blocked-row':''}${t.status==='progress'?' in-progress-row':''}" data-id="${t.id}" draggable="true" ondragstart="taskDragStart(event,${t.id})" ondragover="taskDragOver(event)" ondragleave="taskDragLeave(event)" ondrop="taskDrop(event,${t.id})">${taskBulkMode?`<div style="padding:0 4px;cursor:pointer" onclick="toggleTaskSelect(${t.id});this.querySelector('input').checked=taskSelected.has(${t.id})"><input type="checkbox" ${taskSelected.has(t.id)?'checked':''} style="pointer-events:none;cursor:pointer"></div>`:''}<div class="task-checkbox ${t.status==='done'?'checked':''}" onclick="toggleTask(${t.id})"></div><div><input type="text" class="task-title-input" value="${escA(t.title)}" onchange="updateTask(${t.id},'title',this.value)" ondblclick="openTaskDetail(${t.id})" placeholder="Task name..." title="${t.created?'Created '+timeAgo(t.created)+' | ':''} Double-click for details">${t.recurrence?`<span style="font-size:7px;color:var(--accent-cyan);margin-left:3px;font-family:var(--mono)" title="Repeats ${t.recurrence}">r</span>`:''}${(t.subtasks&&t.subtasks.length)?`<span style="font-size:8px;color:${t.subtasks.filter(s=>s.done).length===t.subtasks.length?'var(--accent)':'var(--text-muted)'};font-family:var(--mono);margin-left:4px" title="Subtasks">${t.subtasks.filter(s=>s.done).length}/${t.subtasks.length}</span>`:''}${t.estimate?`<span style="font-size:8px;color:var(--accent-cyan);font-family:var(--mono);margin-left:4px">${esc(t.estimate)}</span>`:''}${t.timeSpent||t.timeStarted?`<span style="font-size:8px;color:${t.timeStarted?'var(--green)':'var(--text-muted)'};font-family:var(--mono);margin-left:4px">${t.timeStarted?'...':formatTimeSpent(t.timeSpent)}</span>`:''}${(t.tags&&t.tags.length)?t.tags.slice(0,3).map(tag=>`<span style="font-size:7px;padding:0 3px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:2px;color:var(--text-muted);font-family:var(--mono);margin-left:3px">${esc(tag)}</span>`).join('')+(t.tags.length>3?`<span style="font-size:7px;color:var(--text-muted);margin-left:2px">+${t.tags.length-3}</span>`:''):''}</div><div><select class="task-select" onchange="updateTask(${t.id},'status',this.value)"><option value="todo" ${t.status==='todo'?'selected':''}>To Do</option><option value="progress" ${t.status==='progress'?'selected':''}>In Progress</option><option value="done" ${t.status==='done'?'selected':''}>Done</option><option value="blocked" ${t.status==='blocked'?'selected':''}>Blocked</option></select></div><div><select class="task-select" onchange="updateTask(${t.id},'priority',this.value)"><option value="p0" ${t.priority==='p0'?'selected':''}>P0 Critical</option><option value="p1" ${t.priority==='p1'?'selected':''}>P1 High</option><option value="p2" ${t.priority==='p2'?'selected':''}>P2 Medium</option><option value="p3" ${t.priority==='p3'?'selected':''}>P3 Low</option></select></div><div><input type="text" class="task-select" style="border:1px solid transparent" value="${escA(t.project||'')}" onchange="updateTask(${t.id},'project',this.value)" placeholder="Project..." list="pdl"></div><div style="display:flex;align-items:center;gap:3px"><input type="date" class="task-select" value="${t.due||''}" onchange="updateTask(${t.id},'due',this.value)" style="color:${t.due&&t.due<today&&t.status!=='done'?'var(--red)':t.due===today?'var(--accent)':t.due&&t.due<=new Date(new Date().getTime()+3*86400000).toISOString().split('T')[0]?'var(--yellow)':''}">${t.due&&t.status!=='done'?`<span style="font-size:7px;font-family:var(--mono);color:${t.due<today?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'};white-space:nowrap">${relativeDate(t.due)}</span>`:''}</div><div class="task-actions"><button class="task-action-btn" onclick="openTaskDetail(${t.id})" title="Details" style="font-size:10px">...</button><button class="task-action-btn del" onclick="deleteTask(${t.id})">x</button></div></div>`;}).join('')+`<div class="add-task-row" style="display:flex;align-items:center;gap:6px;padding:6px 8px"><input type="text" id="task-quick-add" placeholder="+ Quick add task... (Enter to add)" style="flex:1;font-size:11px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;color:var(--text);outline:none;font-family:var(--font)" onkeydown="if(event.key==='Enter'&&this.value.trim()){quickAddTask(this.value.trim());this.value='';event.preventDefault();}"><button class="btn btn-sm btn-ghost" onclick="addTask()" title="Add task with full details" style="font-size:9px;padding:2px 6px">Full</button></div>`;

  const pMap={p0:0,p1:1,p2:2,p3:3};
  ['todo','progress','done','blocked'].forEach(st=>{
    const col=document.getElementById('board-'+st),cnt=document.getElementById('bc-'+st),f=items.filter(t=>t.status===st).sort((a,b)=>(pMap[a.priority]||2)-(pMap[b.priority]||2));
    const totalTime=f.reduce((a,t)=>a+(t.timeSpent||0),0);
    cnt.textContent=f.length+(totalTime?' ('+formatTimeSpent(totalTime)+')':'');
    const wipLimit=st==='progress'?5:0;
    if(wipLimit&&f.length>wipLimit){cnt.style.color='var(--red)';cnt.title='WIP limit: '+wipLimit;}else{cnt.style.color='';cnt.title=f.length+' tasks'+(totalTime?', '+formatTimeSpent(totalTime)+' tracked':'');};
    col.innerHTML=f.length?f.map(t=>{const st=t.subtasks||[],stDone=st.filter(s=>s.done).length,stTotal=st.length;return `<div class="board-card" draggable="true" ondragstart="boardDragStart(event,${t.id})" onclick="openTaskDetail(${t.id})"><div class="board-card-title" title="${t.created?'Created '+timeAgo(t.created):''}${t.description?'\n'+escA(t.description.substring(0,120)):''}">${esc(t.title||'Untitled')}</div>${(t.labels&&t.labels.length)?`<div style="display:flex;gap:3px;margin-bottom:3px">${t.labels.map(c=>`<div style="width:8px;height:8px;border-radius:50%;background:${c}"></div>`).join('')}</div>`:''}${t.description?`<div class="board-card-desc">${esc(t.description)}</div>`:''}${stTotal?`<div class="board-card-subtasks"><span class="done">${stDone}</span>/${stTotal} subtasks<div style="width:100%;height:2px;background:var(--border);border-radius:1px;margin-top:3px"><div style="width:${Math.round(stDone/stTotal*100)}%;height:100%;background:var(--accent);border-radius:1px;transition:width 0.3s"></div></div></div>`:''}<div class="board-card-meta"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}" onclick="event.stopPropagation();cyclePriority(${t.id})" style="cursor:pointer" title="Click to cycle priority">${t.priority||'p3'}</span>${t.project?`<span class="badge badge-blue" style="cursor:pointer" onclick="event.stopPropagation();taskProjectFilter='${escA(t.project)}';renderTasks();toast('Filtered: ${escA(t.project)}')">${esc(t.project)}</span>`:''}${t.due?`<span style="font-size:9px;color:${t.due<today&&t.status!=='done'?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'};font-family:var(--mono)" title="${t.due}">${relativeDate(t.due)}${t.due<today&&t.status!=='done'?' !':''}</span>`:''}${t.recurrence?`<span style="font-size:8px;color:var(--accent-cyan)" title="Repeats ${t.recurrence}">r</span>`:''}${t.blockedBy?`<span style="font-size:8px;color:var(--red)" title="Blocked by: ${escA(t.blockedBy)}">B</span>`:''}${t.estimate?`<span style="font-size:8px;color:var(--accent-cyan);font-family:var(--mono)" title="Estimate">${esc(t.estimate)}</span>`:''}${t.timeSpent?`<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)" title="Time tracked">${formatTimeSpent(t.timeSpent)}</span>`:''}</div>${(t.tags&&t.tags.length)?`<div style="display:flex;flex-wrap:wrap;gap:2px;margin-top:3px">${t.tags.map(tag=>`<span style="font-size:7px;padding:1px 4px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:2px;color:var(--text-muted);font-family:var(--mono)">${esc(tag)}</span>`).join('')}</div>`:''}</div>`;}).join(''):'<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:10px;opacity:0.5">Drop tasks here</div>';
  });
  const activeTasks=S.tasks.filter(t=>t.status!=='done').length;
  const doneTasks=S.tasks.filter(t=>t.status==='done').length;
  document.getElementById('tasks-count').textContent=activeTasks;
  document.getElementById('tasks-count').title=activeTasks+' active, '+doneTasks+' done ('+S.tasks.length+' total)';
  const taskCountInfo=document.getElementById('task-count-info');if(taskCountInfo){const filtered=items.length;const total=S.tasks.length;taskCountInfo.textContent=filtered!==total?'Showing '+filtered+' of '+total:'';}
  const cfBtn=document.getElementById('task-clear-filters');if(cfBtn){const hasFilter=taskFilter!=='all'||taskProjectFilter||(document.getElementById('task-search')?.value)||((document.getElementById('task-sort')?.value||'manual')!=='manual');cfBtn.style.display=hasFilter?'inline-block':'none';}
  const acEl=document.getElementById('archived-count');if(acEl)acEl.textContent=(S.archivedTasks||[]).length||'';
  if(!document.getElementById('pdl')){const dl=document.createElement('datalist');dl.id='pdl';document.body.appendChild(dl);}
  document.getElementById('pdl').innerHTML=projects.map(p=>`<option value="${p}">`).join('');
  const tpf=document.getElementById('task-project-filter');if(tpf){tpf.innerHTML='<option value="">All Projects</option>'+projects.map(p=>`<option value="${escA(p)}" ${taskProjectFilter===p?'selected':''}>${esc(p)}</option>`).join('');}
  updateSidebarCtx();
  if(taskView==='eisenhower')renderEisenhower();
}

function addTask(){S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p1',project:taskProjectFilter||'',due:new Date().toISOString().split('T')[0],created:new Date().toISOString()});save();renderTasks();setTimeout(()=>{const i=document.querySelector('.task-title-input');if(i)i.focus();},50);}
function quickAddTask(text){
  const parts=text.match(/^(.+?)(?:\s+#(\S+))?(?:\s+@(\S+))?(?:\s+!([0-3]))?(?:\s+~(\S+))?$/);
  const title=parts?parts[1].trim():text;
  const tag=parts&&parts[2]?parts[2]:null;
  const project=parts&&parts[3]?parts[3]:taskProjectFilter||'';
  const priority=parts&&parts[4]?'p'+parts[4]:'p2';
  const dateRaw=parts&&parts[5]?parts[5]:null;
  const due=dateRaw?parseNaturalDate(dateRaw):'';
  const t={id:Date.now(),title,description:'',subtasks:[],status:'todo',priority,project,due:due||'',tags:tag?[tag]:[],created:new Date().toISOString()};
  S.tasks.unshift(t);save();renderTasks();toast('Added: '+title+(due?' (due: '+due+')':''));
}
function addTaskFromTemplate(title,priority,recurrence){S.tasks.unshift({id:Date.now(),title,description:'',subtasks:[],status:'todo',priority:priority||'p2',project:taskProjectFilter||'',due:new Date().toISOString().split('T')[0],recurrence:recurrence||'',created:new Date().toISOString()});save();renderTasks();toast('Added: '+title);document.querySelectorAll('.btn-group div[style*="display: block"],.btn-group div[style*="display:block"]').forEach(d=>d.style.display='none');}
function updateTask(id,f,v){const t=S.tasks.find(x=>x.id===id);if(t){if(f==='status'&&v==='progress'&&!t.timeStarted)t.timeStarted=new Date().toISOString();if(f==='status'&&v!=='progress'&&t.timeStarted){t.timeSpent=(t.timeSpent||0)+Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);t.timeStarted=null;}if(f==='status'&&t.status!==v){if(!t.log)t.log=[];t.log.push({from:t.status,to:v,at:new Date().toISOString()});if(t.log.length>20)t.log=t.log.slice(-20);if(v==='done')t.completedAt=new Date().toISOString();else if(t.status==='done')delete t.completedAt;}t[f]=v;save();renderTasks();}}
function toggleTask(id){const t=S.tasks.find(x=>x.id===id);if(t){const wasDone=t.status==='done';t.status=wasDone?'todo':'done';if(!wasDone)t.completedAt=new Date().toISOString();else delete t.completedAt;if(!wasDone&&t.recurrence&&t.due){const nd=getNextRecurDate(t.due,t.recurrence);S.tasks.unshift({id:Date.now(),title:t.title,description:t.description||'',subtasks:(t.subtasks||[]).map(s=>({...s,done:false})),status:'todo',priority:t.priority,project:t.project,due:nd,recurrence:t.recurrence,created:new Date().toISOString()});t.lastRecurred=new Date().toISOString().split('T')[0];toast('Recurring task created for '+nd);}save();renderTasks();}}
function getNextRecurDate(dateStr,recur){const d=new Date(dateStr+'T12:00:00');if(recur==='daily')d.setDate(d.getDate()+1);else if(recur==='weekday'){d.setDate(d.getDate()+1);while(d.getDay()===0||d.getDay()===6)d.setDate(d.getDate()+1);}else if(recur==='weekly')d.setDate(d.getDate()+7);else if(recur==='biweekly')d.setDate(d.getDate()+14);else if(recur==='monthly')d.setMonth(d.getMonth()+1);return d.toISOString().split('T')[0];}
function parseNaturalDate(text){
  if(!text||/^\d{4}-\d{2}-\d{2}$/.test(text))return text;
  const t=text.toLowerCase().trim();const now=new Date();
  if(t==='today')return now.toISOString().split('T')[0];
  if(t==='tomorrow'||t==='tmrw'||t==='tom'){now.setDate(now.getDate()+1);return now.toISOString().split('T')[0];}
  if(t==='next week'){now.setDate(now.getDate()+7);return now.toISOString().split('T')[0];}
  if(t==='next month'){now.setMonth(now.getMonth()+1);return now.toISOString().split('T')[0];}
  const days=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const dIdx=days.findIndex(d=>t.startsWith(d.substring(0,3)));
  if(dIdx>=0){const curr=now.getDay();let diff=dIdx-curr;if(diff<=0)diff+=7;now.setDate(now.getDate()+diff);return now.toISOString().split('T')[0];}
  const match=t.match(/^(\d+)\s*(d|day|w|week|m|month)/);
  if(match){const n=parseInt(match[1]);const unit=match[2][0];if(unit==='d')now.setDate(now.getDate()+n);else if(unit==='w')now.setDate(now.getDate()+n*7);else if(unit==='m')now.setMonth(now.getMonth()+n);return now.toISOString().split('T')[0];}
  return text;
}
function relativeDate(dateStr){
  if(!dateStr)return '';
  const today=new Date();today.setHours(0,0,0,0);
  const d=new Date(dateStr+'T12:00:00');d.setHours(0,0,0,0);
  const diff=Math.round((d-today)/(86400000));
  if(diff===0)return 'today';if(diff===1)return 'tmrw';if(diff===-1)return 'yday';
  if(diff>1&&diff<=7)return diff+'d';if(diff>7)return dateStr.substring(5);
  return Math.abs(diff)+'d ago';
}
function deleteTask(id){S.tasks=S.tasks.filter(t=>t.id!==id);save();renderTasks();toast('Deleted');}
function cyclePriority(id){const t=S.tasks.find(x=>x.id===id);if(!t)return;const order=['p0','p1','p2','p3'];const cur=order.indexOf(t.priority||'p2');t.priority=order[(cur+1)%order.length];save();renderTasks();toast(t.priority.toUpperCase());}
function archiveCompletedTasks(){
  const done=S.tasks.filter(t=>t.status==='done');
  if(!done.length){toast('No completed tasks to archive');return;}
  if(!confirm('Archive '+done.length+' completed tasks? They will be moved to a hidden archive.'))return;
  if(!S.archivedTasks)S.archivedTasks=[];
  S.archivedTasks=done.concat(S.archivedTasks);
  if(S.archivedTasks.length>500)S.archivedTasks.length=500;
  S.tasks=S.tasks.filter(t=>t.status!=='done');
  save();renderTasks();toast('Archived '+done.length+' tasks');
}
function showArchivedTasks(){
  const archived=S.archivedTasks||[];
  if(!archived.length){toast('No archived tasks');return;}
  const rows=document.getElementById('task-rows');
  document.getElementById('task-list-view').style.display='block';
  document.getElementById('task-board-view').classList.remove('active');
  rows.innerHTML='<div style="padding:8px 0;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:8px"><span>Archived Tasks ('+archived.length+')</span><button class="btn btn-sm btn-ghost" onclick="renderTasks()" style="font-size:8px;padding:1px 6px">Back to active</button></div>'+archived.slice(0,50).map(t=>`<div class="task-row completed priority-${t.priority||'p2'}" style="opacity:0.6"><div class="task-checkbox checked"></div><div><span style="font-size:12px;color:var(--text-secondary);text-decoration:line-through">${esc(t.title||'Untitled')}</span></div><div><span style="font-size:10px;color:var(--text-muted)">${t.project||''}</span></div><div><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':'muted'}" style="font-size:8px">${t.priority||'p3'}</span></div><div><span style="font-size:9px;color:var(--text-muted)">${t.due||''}</span></div><div><span style="font-size:8px;color:var(--text-muted)">${t.created?new Date(t.created).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'?'}</span></div><div class="task-actions" style="opacity:1"><button class="task-action-btn" onclick="restoreArchivedTask(${t.id})" title="Restore" style="font-size:10px;color:var(--accent)">+</button></div></div>`).join('')+(archived.length>50?'<div style="padding:8px;font-size:10px;color:var(--text-muted)">Showing first 50 of '+archived.length+'</div>':'');
}
function taskBulkSelectAll(){const items=getFilteredTasks();items.forEach(t=>taskSelected.add(t.id));renderTasks();}
function restoreArchivedTask(id){
  const idx=(S.archivedTasks||[]).findIndex(t=>t.id===id);
  if(idx<0)return;
  const t=S.archivedTasks.splice(idx,1)[0];
  t.status='todo';
  S.tasks.unshift(t);
  save();renderTasks();toast('Restored: '+(t.title||'task'));
}

let taskBulkMode=false,taskSelected=new Set();
function toggleTaskBulk(){taskBulkMode=!taskBulkMode;taskSelected.clear();document.getElementById('task-bulk-btn').style.display=taskBulkMode?'none':'';document.getElementById('task-bulk-actions').style.display=taskBulkMode?'flex':'none';renderTasks();}
function toggleTaskSelect(id){if(taskSelected.has(id))taskSelected.delete(id);else taskSelected.add(id);}
function taskBulkApply(){
  const status=document.getElementById('task-bulk-status').value;
  const priority=document.getElementById('task-bulk-priority').value;
  const due=document.getElementById('task-bulk-due').value;
  if(!status&&!priority&&!due){toast('Select a status, priority, or due date to apply');return;}
  let count=0;
  taskSelected.forEach(id=>{const t=S.tasks.find(x=>x.id===id);if(t){if(status)t.status=status;if(priority)t.priority=priority;if(due)t.due=due;count++;}});
  save();taskSelected.clear();taskBulkMode=false;document.getElementById('task-bulk-btn').style.display='';document.getElementById('task-bulk-actions').style.display='none';renderTasks();toast('Updated '+count+' tasks');
}
function taskBulkTag(){
  if(!taskSelected.size){toast('No tasks selected');return;}
  const allTags=[...new Set(S.tasks.flatMap(t=>t.tags||[]))].sort();
  const tag=prompt('Tag to add to '+taskSelected.size+' tasks:'+(allTags.length?'\nExisting: '+allTags.join(', '):''));
  if(!tag||!tag.trim())return;const v=tag.trim().toLowerCase();
  S.tasks.forEach(t=>{if(taskSelected.has(t.id)){if(!t.tags)t.tags=[];if(!t.tags.includes(v))t.tags.push(v);}});
  save();renderTasks();toast('Tagged '+taskSelected.size+' tasks with "'+v+'"');
}
function taskBulkDelete(){
  if(!taskSelected.size){toast('No tasks selected');return;}
  if(!confirm('Delete '+taskSelected.size+' tasks?'))return;
  S.tasks=S.tasks.filter(t=>!taskSelected.has(t.id));save();taskSelected.clear();taskBulkMode=false;document.getElementById('task-bulk-btn').style.display='';document.getElementById('task-bulk-actions').style.display='none';renderTasks();toast('Deleted');
}
function taskBulkMove(){
  if(!taskSelected.size){toast('No tasks selected');return;}
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  const target=prompt('Move '+taskSelected.size+' tasks to project:\n\n'+projects.map((p,i)=>(i+1)+'. '+p).join('\n')+'\n\nType project name:');
  if(!target||!target.trim())return;
  let count=0;
  S.tasks.forEach(t=>{if(taskSelected.has(t.id)){t.project=target.trim();count++;}});
  save();taskSelected.clear();taskBulkMode=false;document.getElementById('task-bulk-btn').style.display='';document.getElementById('task-bulk-actions').style.display='none';renderTasks();toast('Moved '+count+' tasks to '+target.trim());
}
function taskManageTags(){
  const allTags=[...new Set(S.tasks.flatMap(t=>t.tags||[]).filter(Boolean))].sort();
  if(!allTags.length){toast('No tags on any tasks');return;}
  const action=prompt('Task Tag Management\n\nTags: '+allTags.join(', ')+'\n\nCommands:\n- rename:oldtag:newtag\n- delete:tagname\n- merge:tag1:tag2 (merge tag1 into tag2)');
  if(!action)return;
  if(action.startsWith('rename:')){const parts=action.split(':');if(parts.length===3){const old=parts[1].trim(),nw=parts[2].trim();let count=0;S.tasks.forEach(t=>{if(t.tags){const i=t.tags.indexOf(old);if(i>=0){t.tags[i]=nw;count++;}}});save();renderTasks();toast('Renamed "'+old+'" to "'+nw+'" in '+count+' tasks');}}
  else if(action.startsWith('delete:')){const tag=action.substring(7).trim();let count=0;S.tasks.forEach(t=>{if(t.tags){const i=t.tags.indexOf(tag);if(i>=0){t.tags.splice(i,1);count++;}}});save();renderTasks();toast('Removed "'+tag+'" from '+count+' tasks');}
  else if(action.startsWith('merge:')){const parts=action.split(':');if(parts.length===3){const from=parts[1].trim(),to=parts[2].trim();let count=0;S.tasks.forEach(t=>{if(t.tags){const i=t.tags.indexOf(from);if(i>=0){t.tags.splice(i,1);if(!t.tags.includes(to))t.tags.push(to);count++;}}});save();renderTasks();toast('Merged "'+from+'" into "'+to+'" in '+count+' tasks');}}
  else{toast('Use rename:old:new, delete:tag, or merge:tag1:tag2');}
}
function exportTasks(){
  const items=getFilteredTasks();
  const today=new Date().toISOString().split('T')[0];
  let md='# Tasks Export\n';
  md+='Generated: '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n\n';
  const groups={};
  items.forEach(t=>{const g=t.project||'No Project';if(!groups[g])groups[g]=[];groups[g].push(t);});
  Object.keys(groups).sort().forEach(g=>{
    md+='## '+g+'\n';
    groups[g].forEach(t=>{
      const check=t.status==='done'?'x':' ';
      md+='- ['+check+'] '+t.title+(t.priority==='p0'?' [CRITICAL]':t.priority==='p1'?' [HIGH]':'')+(t.due?' (due '+t.due+')':'')+(t.due&&t.due<today&&t.status!=='done'?' OVERDUE':'')+'\n';
      if(t.description)md+='  '+t.description.substring(0,100)+'\n';
      (t.subtasks||[]).forEach(s=>{md+='  - ['+(s.done?'x':' ')+'] '+s.title+'\n';});
    });
    md+='\n';
  });
  navigator.clipboard.writeText(md).then(()=>toast('Tasks copied as markdown')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tasks-'+today+'.md';a.click();toast('Tasks exported');
  });
}

function exportTasksCSV(){
  const csvEsc=s=>{s=String(s||'').replace(/"/g,'""');return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s+'"':s;};
  const headers=['Title','Status','Priority','Project','Due','Description','Tags','Created','Estimate','Time Spent','Subtasks'];
  const rows=[headers.join(',')];
  S.tasks.forEach(t=>{
    rows.push([csvEsc(t.title),csvEsc(t.status),csvEsc(t.priority),csvEsc(t.project),csvEsc(t.due),csvEsc(t.description),csvEsc((t.tags||[]).join(';')),csvEsc(t.created?t.created.split('T')[0]:''),csvEsc(t.estimate),csvEsc(t.timeSpent?t.timeSpent+'m':''),csvEsc((t.subtasks||[]).map(s=>(s.done?'[x]':'[ ]')+s.title).join('; '))].join(','));
  });
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tasks-'+new Date().toISOString().split('T')[0]+'.csv';a.click();toast('Exported '+S.tasks.length+' tasks as CSV');
}
// Task drag reorder
let taskDragId=null;
function taskDragStart(e,id){taskDragId=id;e.dataTransfer.effectAllowed='move';}
function taskDragOver(e){e.preventDefault();e.currentTarget.classList.add('dragging-over');}
function taskDragLeave(e){e.currentTarget.classList.remove('dragging-over');}
function taskDrop(e,targetId){e.preventDefault();e.currentTarget.classList.remove('dragging-over');if(!taskDragId||taskDragId===targetId)return;const fi=S.tasks.findIndex(t=>t.id===taskDragId),ti=S.tasks.findIndex(t=>t.id===targetId);if(fi<0||ti<0)return;const[item]=S.tasks.splice(fi,1);S.tasks.splice(ti,0,item);taskDragId=null;save();renderTasks();}

// Board drag
let boardDragId=null;
function boardDragStart(e,id){boardDragId=id;e.dataTransfer.effectAllowed='move';}
function boardDrop(e,status){e.preventDefault();if(boardDragId){const t=S.tasks.find(x=>x.id===boardDragId);if(t){t.status=status;save();renderTasks();}boardDragId=null;}}
function boardMoveAll(fromStatus){
  const targets=['todo','progress','done','blocked'].filter(s=>s!==fromStatus);
  const to=prompt('Move all "'+fromStatus+'" tasks to:\n'+targets.join(', '));
  if(!to||!targets.includes(to))return;
  const items=getFilteredTasks().filter(t=>t.status===fromStatus);
  if(!items.length){toast('No tasks to move');return;}
  items.forEach(t=>{if(!t.log)t.log=[];t.log.push({from:t.status,to,at:new Date().toISOString()});t.status=to;});
  save();renderTasks();toast('Moved '+items.length+' tasks to '+to);
}

// Task Detail Modal
let taskDetailId = null;
function openTaskDetail(id) {
  const t = S.tasks.find(x=>x.id===id);
  if(!t) return;
  taskDetailId = id;
  document.getElementById('td-title').value = t.title || '';
  document.getElementById('td-desc').value = t.description || '';
  document.getElementById('td-status').value = t.status || 'todo';
  document.getElementById('td-priority').value = t.priority || 'p2';
  document.getElementById('td-project').value = t.project || '';
  document.getElementById('td-due').value = t.due || '';
  document.getElementById('td-recur').value = t.recurrence || '';
  document.getElementById('td-blocked-by').value = t.blockedBy || '';
  document.getElementById('td-estimate').value = t.estimate || '';
  document.getElementById('td-notes').value = t.notes || '';
  const nc=document.getElementById('td-notes-count');if(nc)nc.textContent=(t.notes||'').trim()?'('+countW(t.notes)+' words)':'';
  document.getElementById('td-recur-info').textContent = t.recurrence ? 'Repeats ' + t.recurrence + (t.lastRecurred ? ' (last: ' + t.lastRecurred + ')' : '') : '';
  let timeText=t.created ? 'Created: ' + new Date(t.created).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' ('+timeAgo(t.created)+')' : '';
  if(t.completedAt)timeText+=' | Done: '+new Date(t.completedAt).toLocaleDateString('en-US',{month:'short',day:'numeric'})+' ('+timeAgo(t.completedAt)+')';
  if(t.timeSpent)timeText+=' | Time: '+formatTimeSpent(t.timeSpent);
  if(t.timeStarted)timeText+=' | Started: '+timeAgo(t.timeStarted);
  document.getElementById('td-created').textContent = timeText;
  const logEl=document.getElementById('td-log');
  if(logEl&&t.log&&t.log.length){const sClr={todo:'var(--accent-cyan)',progress:'var(--green)',done:'var(--accent)',blocked:'var(--orange)'};logEl.innerHTML='<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Activity ('+t.log.length+')</div>'+t.log.slice(-8).reverse().map(e=>`<div style="font-size:8px;padding:2px 0;font-family:var(--mono);display:flex;align-items:center;gap:4px"><span style="width:4px;height:4px;border-radius:50%;background:${sClr[e.to]||'var(--text-muted)'};flex-shrink:0"></span><span style="color:${sClr[e.from]||'var(--text-muted)'}">${e.from}</span><span style="color:var(--text-muted)">-></span><span style="color:${sClr[e.to]||'var(--text-muted)'}">${e.to}</span><span style="color:var(--text-muted);opacity:0.5;margin-left:auto;font-size:7px">${timeAgo(e.at)}</span></div>`).join('');}else if(logEl){logEl.innerHTML='';}
  renderTaskTags(t);
  renderSubtasksInModal(t.subtasks || []);
  renderTaskLabels(t);
  updateTimerBtn(t);
  const ubBtn=document.getElementById('td-unblock-btn');if(ubBtn)ubBtn.style.display=(t.status==='blocked'||t.blockedBy)?'inline-block':'none';
  document.getElementById('task-detail-modal').classList.add('open');
  setTimeout(()=>document.getElementById('td-title').focus(),100);
}
function renderTaskTags(t){const el=document.getElementById('td-tags');if(!el)return;const tags=t.tags||[];el.innerHTML=tags.map(tag=>`<span style="display:inline-flex;align-items:center;gap:2px;padding:2px 6px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px;font-size:9px;color:var(--text-muted);font-family:var(--mono)">${esc(tag)}<span onclick="removeTaskTag('${escA(tag)}')" style="cursor:pointer;color:var(--red);margin-left:2px;font-size:8px">x</span></span>`).join('')+`<span onclick="addTaskTag()" style="cursor:pointer;font-size:9px;color:var(--accent);padding:2px 4px">+ tag</span>`;}
function addTaskTag(){const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;const allTags=[...new Set(S.tasks.flatMap(x=>x.tags||[]))].sort();const tag=prompt('Tag:'+((allTags.length)?'\nExisting: '+allTags.join(', '):''));if(!tag||!tag.trim())return;if(!t.tags)t.tags=[];const v=tag.trim().toLowerCase();if(!t.tags.includes(v)){t.tags.push(v);save();renderTaskTags(t);toast('Tag added: '+v);}}
function removeTaskTag(tag){const t=S.tasks.find(x=>x.id===taskDetailId);if(!t||!t.tags)return;t.tags=t.tags.filter(x=>x!==tag);save();renderTaskTags(t);}
function renderTaskLabels(t){const el=document.getElementById('td-labels');if(!el)return;const colors=['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899','#06b6d4'];el.innerHTML=colors.map(c=>{const active=(t.labels||[]).includes(c);return `<div onclick="addTaskColorLabel(${t.id},'${c}')" style="width:20px;height:20px;border-radius:50%;background:${c};cursor:pointer;border:2px solid ${active?'white':'transparent'};opacity:${active?1:0.4};transition:all 0.15s" title="${active?'Remove':'Add'} label"></div>`;}).join('');}
function unblockTask(){const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;t.blockedBy='';if(t.status==='blocked')t.status='todo';document.getElementById('td-blocked-by').value='';document.getElementById('td-status').value=t.status;document.getElementById('td-unblock-btn').style.display='none';save();renderTasks();toast('Unblocked');}
function formatTimeSpent(mins){if(mins<60)return mins+'m';const h=Math.floor(mins/60);const m=mins%60;return h+'h'+(m?' '+m+'m':'');}
function tdSetDue(days){const d=new Date();d.setDate(d.getDate()+days);document.getElementById('td-due').value=d.toISOString().split('T')[0];}
function closeTaskDetail() {
  document.getElementById('task-detail-modal').classList.remove('open');
  taskDetailId = null;
}
function renderSubtasksInModal(subtasks) {
  const el = document.getElementById('td-subtasks');
  const st=subtasks||[];
  const done=st.filter(s=>s.done).length;
  const lbl=document.getElementById('td-subtasks-label');
  if(lbl)lbl.textContent=st.length?'Subtasks ('+done+'/'+st.length+')':'Subtasks';
  el.innerHTML = st.map((s,i) => `<div class="td-subtask">
    <input type="checkbox" ${s.done?'checked':''} onchange="toggleSubtaskInModal(${i},this.checked)">
    <input type="text" value="${escA(s.title)}" onchange="renameSubtaskInModal(${i},this.value)" placeholder="Subtask...">
    <span class="del" onclick="removeSubtaskInModal(${i})">x</span>
  </div>`).join('');
}
function addSubtaskInModal() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  if(!t.subtasks) t.subtasks = [];
  t.subtasks.push({id:Date.now(), title:'', done:false});
  renderSubtasksInModal(t.subtasks);
  const inputs = document.querySelectorAll('#td-subtasks input[type=text]');
  if(inputs.length) inputs[inputs.length-1].focus();
}
function toggleSubtaskInModal(i,done) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks && t.subtasks[i]) t.subtasks[i].done = done;
}
function renameSubtaskInModal(i,val) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks && t.subtasks[i]) t.subtasks[i].title = val;
}
function removeSubtaskInModal(i) {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(t && t.subtasks) { t.subtasks.splice(i,1); renderSubtasksInModal(t.subtasks); }
}
function saveTaskDetail() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  t.title = document.getElementById('td-title').value.trim();
  t.description = document.getElementById('td-desc').value.trim();
  t.status = document.getElementById('td-status').value;
  t.priority = document.getElementById('td-priority').value;
  t.project = document.getElementById('td-project').value.trim();
  t.due = document.getElementById('td-due').value;
  t.recurrence = document.getElementById('td-recur').value || '';
  t.blockedBy = document.getElementById('td-blocked-by').value.trim() || '';
  t.estimate = document.getElementById('td-estimate').value.trim() || '';
  t.notes = document.getElementById('td-notes').value.trim() || '';
  // Link to project ID if name matches
  if(t.project) { const p = (S.projects||[]).find(pr => pr.name === t.project); if(p) t.projectId = p.id; }
  save(); closeTaskDetail(); renderTasks();
  if(activeProject) renderProjTasks();
  toast('Task saved');
}
function deleteTaskFromDetail() {
  if(!taskDetailId) return;
  if(!confirm('Delete this task?')) return;
  S.tasks = S.tasks.filter(t=>t.id!==taskDetailId);
  save(); closeTaskDetail(); renderTasks();
  if(activeProject) renderProjTasks();
  toast('Task deleted');
}
function duplicateTask() {
  const t = S.tasks.find(x=>x.id===taskDetailId);
  if(!t) return;
  const dup = {...t, id:Date.now(), title:(t.title||'')+ ' (copy)', subtasks:(t.subtasks||[]).map(s=>({...s,id:Date.now()+Math.random()*1000,done:false})), status:'todo', created:new Date().toISOString()};
  S.tasks.unshift(dup);
  save(); closeTaskDetail(); renderTasks();
  toast('Task duplicated');
}
function taskToContent(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  let body=t.title||'Untitled Task';
  if(t.description)body+='\n\n'+t.description;
  if(t.subtasks&&t.subtasks.length)body+='\n\nSubtasks:\n'+t.subtasks.map(s=>(s.done?'[x] ':'[ ] ')+s.title).join('\n');
  S.content.unshift({id:Date.now(),body,type:'caption',theme:t.project||'tasks',tags:['from-task',t.priority||'p2'].filter(Boolean),source:'task-convert',created:new Date().toISOString()});
  save();closeTaskDetail();if(currentSection==='content')renderContent();toast('Saved to Content');
}
function taskToSpec(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  snapshotSpec();const now=Date.now();
  const sections=[{id:'sec_'+(now+1),title:'Overview',body:'<p>'+(t.description||t.title||'')+'</p>',collapsed:false}];
  if(t.subtasks&&t.subtasks.length)sections.push({id:'sec_'+(now+2),title:'Subtasks',body:'<ul>'+t.subtasks.map(s=>'<li>'+(s.done?'<s>':'')+esc(s.title)+(s.done?'</s>':'')+'</li>').join('')+'</ul>',collapsed:false});
  sections.push({id:'sec_'+(now+3),title:'Notes',body:'',collapsed:false});
  const s={id:now,title:t.title||'Untitled Spec',sections,created:new Date().toISOString(),updated:new Date().toISOString()};
  if(t.project){const proj=(S.projects||[]).find(p=>p.name===t.project);if(proj)s.projectId=proj.id;}
  S.specs.unshift(s);S.activeSpec=s.id;
  save();closeTaskDetail();switchSection('specs',null);renderSpecs();toast('Created spec from task');
}
function taskToDoc(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  let body='<h2>'+esc(t.title||'Untitled')+'</h2>';
  body+='<p><strong>Status:</strong> '+t.status+' | <strong>Priority:</strong> '+(t.priority||'p2');
  if(t.project)body+=' | <strong>Project:</strong> '+esc(t.project);
  if(t.due)body+=' | <strong>Due:</strong> '+t.due;
  body+='</p>';
  if(t.description)body+='<p>'+esc(t.description).replace(/\n/g,'<br>')+'</p>';
  if(t.subtasks&&t.subtasks.length)body+='<h3>Subtasks</h3><ul>'+t.subtasks.map(s=>'<li>'+(s.done?'<s>':'')+esc(s.title)+(s.done?'</s>':'')+'</li>').join('')+'</ul>';
  S.docs.push({id:Date.now(),title:t.title||'Untitled',body,tags:['from-task'],created:new Date().toISOString(),updated:new Date().toISOString(),versions:[]});
  save();closeTaskDetail();switchSection('writer',null);renderWriter();toast('Created doc from task');
}
function copyTaskAsMarkdown(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  let md='## '+esc(t.title||'Untitled')+'\n\n';
  md+='- **Status:** '+t.status+'\n';
  md+='- **Priority:** '+(t.priority||'p2')+'\n';
  if(t.project)md+='- **Project:** '+t.project+'\n';
  if(t.due)md+='- **Due:** '+t.due+'\n';
  if(t.estimate)md+='- **Estimate:** '+t.estimate+'\n';
  if(t.recurrence)md+='- **Recurrence:** '+t.recurrence+'\n';
  if(t.blockedBy)md+='- **Blocked by:** '+t.blockedBy+'\n';
  if(t.timeSpent)md+='- **Time spent:** '+formatTimeSpent(t.timeSpent)+'\n';
  if(t.description)md+='\n'+t.description+'\n';
  if(t.subtasks&&t.subtasks.length){md+='\n### Subtasks\n';t.subtasks.forEach(s=>{md+='- ['+(s.done?'x':' ')+'] '+s.title+'\n';});}
  if(t.log&&t.log.length){md+='\n### Activity\n';t.log.slice(0,10).forEach(l=>{md+='- '+l.from+' -> '+l.to+' ('+timeAgo(l.at)+')\n';});}
  md+='\n*Created: '+(t.created||'unknown')+'*\n';
  if(t.completedAt)md+='*Completed: '+t.completedAt+'*\n';
  navigator.clipboard.writeText(md).then(()=>toast('Task copied as markdown'));
}
function splitTaskSubtasks(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  const subs=(t.subtasks||[]).filter(s=>!s.done);
  if(!subs.length){toast('No incomplete subtasks to split');return;}
  if(!confirm('Create '+subs.length+' new tasks from subtasks?'))return;
  subs.forEach(sub=>{
    const nt={id:Date.now()+Math.random()*1000|0,title:sub.title,description:'Split from: '+t.title,project:t.project||'',priority:t.priority||'p2',status:'todo',due:t.due||'',tags:[...(t.tags||[])],subtasks:[],created:new Date().toISOString()};
    S.tasks.unshift(nt);
  });
  t.subtasks=(t.subtasks||[]).filter(s=>s.done);
  save();renderTasks();renderSubtasksInModal(t.subtasks);toast('Split '+subs.length+' subtasks into tasks');
}
function cloneTaskToProject(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  const projects=[...new Set(S.tasks.map(x=>x.project).filter(Boolean))].sort();
  const current=t.project||'';
  const others=projects.filter(p=>p!==current);
  const target=prompt('Clone task to project:'+(others.length?'\nExisting: '+others.join(', '):'')+'\n\nCurrent: '+(current||'none'));
  if(!target||!target.trim())return;
  const clone={...JSON.parse(JSON.stringify(t)),id:Date.now(),project:target.trim(),created:new Date().toISOString(),status:'todo'};
  delete clone.completedAt;delete clone.timeSpent;delete clone.timeStarted;delete clone.log;
  S.tasks.unshift(clone);save();renderTasks();toast('Cloned to '+target.trim());
}
function snoozeTask(days){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  const base=t.due?new Date(t.due+'T12:00:00'):new Date();
  base.setDate(base.getDate()+days);
  t.due=base.toISOString().split('T')[0];
  document.getElementById('td-due').value=t.due;
  save();renderCalendar();renderTasks();toast('Snoozed to '+t.due);
}
function toggleTaskTimer(){
  const t=S.tasks.find(x=>x.id===taskDetailId);if(!t)return;
  if(t.timeStarted){
    t.timeSpent=(t.timeSpent||0)+Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);
    t.timeStarted=null;
    save();toast('Timer stopped — '+formatTimeSpent(t.timeSpent)+' total');
  }else{
    t.timeStarted=new Date().toISOString();
    if(t.status==='todo'){t.status='progress';if(!t.log)t.log=[];t.log.push({from:'todo',to:'progress',at:t.timeStarted});}
    save();toast('Timer started');
  }
  updateTimerBtn(t);
}
function updateTimerBtn(t){
  const btn=document.getElementById('td-timer-btn');if(!btn)return;
  if(t.timeStarted){btn.textContent='Stop Timer';btn.style.color='var(--red)';btn.title='Stop time tracking (running since '+timeAgo(t.timeStarted)+')';}
  else{btn.textContent='Start Timer';btn.style.color='';btn.title='Start time tracking'+(t.timeSpent?' ('+formatTimeSpent(t.timeSpent)+' logged)':'');}
}

// === CALENDAR ===
function setCalView(v) {
  calView = v;
  document.getElementById('cal-view-month').classList.toggle('active', v==='month');
  document.getElementById('cal-view-week').classList.toggle('active', v==='week');
  const yearBtn=document.getElementById('cal-view-year');if(yearBtn)yearBtn.classList.toggle('active', v==='year');
  const agendaBtn=document.getElementById('cal-view-agenda');if(agendaBtn)agendaBtn.classList.toggle('active', v==='agenda');
  document.getElementById('cal-grid').style.display = v==='month' ? 'grid' : 'none';
  document.getElementById('cal-week-grid').style.display = v==='week' ? 'grid' : 'none';
  let yearGrid=document.getElementById('cal-year-grid');
  if(!yearGrid){yearGrid=document.createElement('div');yearGrid.id='cal-year-grid';document.getElementById('cal-week-grid').parentElement.appendChild(yearGrid);}
  yearGrid.style.display=v==='year'?'block':'none';
  let agendaGrid=document.getElementById('cal-agenda-grid');
  if(!agendaGrid){agendaGrid=document.createElement('div');agendaGrid.id='cal-agenda-grid';document.getElementById('cal-week-grid').parentElement.appendChild(agendaGrid);}
  agendaGrid.style.display=v==='agenda'?'block':'none';
  if(v==='week' && !calWeekStart) {
    const now = new Date();
    const day = now.getDay();
    const diff = day === 0 ? -6 : 1 - day; // Monday start
    calWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
  }
  renderCalendar();
}
function renderCalTodaySummary(){
  const el=document.getElementById('cal-today-summary');
  const today=new Date().toISOString().split('T')[0];
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  if(!todayTasks.length&&!overdue.length){el.style.display='none';return;}
  el.style.display='block';
  let h='';
  if(overdue.length)h+=`<span style="color:var(--red)">${overdue.length} overdue</span> `;
  if(todayTasks.length)h+=`<span style="color:var(--accent)">${todayTasks.length} today:</span> `;
  h+=todayTasks.slice(0,5).map(t=>`<span style="cursor:pointer;text-decoration:underline dotted;margin:0 4px" onclick="openTaskDetail(${t.id})">${esc(t.title||'Untitled')}</span>`).join(' ');
  if(todayTasks.length>5)h+=` <span style="color:var(--text-muted)">+${todayTasks.length-5} more</span>`;
  el.innerHTML=h;
}
function renderCalUpcoming(){
  const el=document.getElementById('cal-upcoming');if(!el)return;
  const today=new Date().toISOString().split('T')[0];
  const upcoming=S.tasks.filter(t=>t.due&&t.due>=today&&t.status!=='done').sort((a,b)=>a.due.localeCompare(b.due)).slice(0,8);
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done').sort((a,b)=>a.due.localeCompare(b.due));
  if(!upcoming.length&&!overdue.length){el.innerHTML='';return;}
  let h='<div style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:6px">Upcoming</div>';
  const renderRow=(t,isOverdue)=>{const daysLabel=t.due===today?'Today':isOverdue?'Overdue':'';return`<div style="display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:10px" onclick="openTaskDetail(${t.id})" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}" style="font-size:7px;padding:1px 3px;min-width:16px;text-align:center">${t.priority||'p3'}</span><span style="flex:1;color:${isOverdue?'var(--red)':'var(--text-secondary)'}">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${isOverdue?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'};font-family:var(--mono)">${isOverdue?t.due+' !':t.due===today?'today':t.due.substring(5)}</span></div>`;};
  if(overdue.length){h+='<div style="font-size:8px;color:var(--red);margin:4px 0 2px;font-weight:600">OVERDUE</div>';overdue.slice(0,5).forEach(t=>{h+=renderRow(t,true);});}
  upcoming.forEach(t=>{h+=renderRow(t,false);});
  el.innerHTML=h;
}
function renderCalendar(){
  renderCalTodaySummary();renderCalUpcoming();
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  if(calView === 'week') {
    renderWeekView();
    return;
  }
  if(calView === 'year') {
    renderYearHeatmap();
    return;
  }
  if(calView === 'agenda') {
    renderCalAgenda();
    return;
  }
  const monthTaskCount=S.tasks.filter(t=>{if(!t.due)return false;const d=new Date(t.due+'T12:00:00');return d.getMonth()===calMonth&&d.getFullYear()===calYear;}).length;
  document.getElementById('cal-month-label').innerHTML=months[calMonth]+' '+calYear+(monthTaskCount?` <span style="font-size:9px;color:var(--accent);font-family:var(--mono)">${monthTaskCount} tasks</span>`:'');
  const first=new Date(calYear,calMonth,1).getDay();
  const days=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date().toISOString().split('T')[0];
  const prev=new Date(calYear,calMonth,0).getDate();
  let h='';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div class="calendar-day-header">${d}</div>`;});
  for(let i=first-1;i>=0;i--)h+=`<div class="calendar-day other"><div class="calendar-day-num">${prev-i}</div></div>`;
  for(let d=1;d<=days;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=ds===today;
    const dt=S.tasks.filter(t=>t.due===ds);
    const hasOverdue=ds<today&&dt.some(t=>t.status!=='done');
    h+=`<div class="calendar-day ${isToday?'today':''}${hasOverdue?' cal-overdue':''}" onclick="calClickDay('${ds}')" ondragover="event.preventDefault();this.classList.add('cal-drag-over')" ondragleave="this.classList.remove('cal-drag-over')" ondrop="this.classList.remove('cal-drag-over');calDrop(event,'${ds}')"><div class="calendar-day-num">${d}${dt.length?`<span style="font-size:7px;color:${hasOverdue?'var(--red)':'var(--accent)'};font-family:var(--mono);margin-left:3px">${dt.length}</span>`:''}</div>${dt.slice(0,4).map(t=>`<div class="calendar-task-pill pill-${t.priority||'p2'}" draggable="true" ondragstart="calDragStart(event,${t.id})" onclick="event.stopPropagation();openTaskDetail(${t.id})" title="${escA(t.title)}">${esc(t.title||'...')}</div>`).join('')}${dt.length>4?`<div style="font-size:8px;color:var(--text-muted)">+${dt.length-4} more</div>`:''}</div>`;
  }
  const rem=42-(first+days);
  for(let d=1;d<=rem;d++)h+=`<div class="calendar-day other"><div class="calendar-day-num">${d}</div></div>`;
  document.getElementById('cal-grid').innerHTML=h;
}
function renderWeekView() {
  if(!calWeekStart) return;
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const ws = new Date(calWeekStart);
  const we = new Date(ws); we.setDate(we.getDate()+6);
  const label = ws.getMonth()===we.getMonth() ? months[ws.getMonth()]+' '+ws.getFullYear() : months[ws.getMonth()].substring(0,3)+' - '+months[we.getMonth()]+' '+we.getFullYear();
  const oneJan=new Date(ws.getFullYear(),0,1);const weekNum=Math.ceil(((ws-oneJan)/86400000+oneJan.getDay()+1)/7);
  document.getElementById('cal-month-label').innerHTML=label+' <span style="font-size:9px;color:var(--text-muted);font-family:var(--mono)">W'+weekNum+'</span>';
  const today=new Date().toISOString().split('T')[0];
  const dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  let h='';
  for(let i=0;i<7;i++){
    const d=new Date(ws); d.setDate(d.getDate()+i);
    const ds=d.toISOString().split('T')[0];
    const isToday=ds===today;
    const dt=S.tasks.filter(t=>t.due===ds);
    const wkOverdue=ds<today&&dt.some(t=>t.status!=='done');
    h+=`<div class="week-day ${isToday?'today':''}${wkOverdue?' cal-overdue':''}" ondragover="event.preventDefault();this.classList.add('cal-drag-over')" ondragleave="this.classList.remove('cal-drag-over')" ondrop="this.classList.remove('cal-drag-over');calDrop(event,'${ds}')">
      <div class="week-day-header">${dayNames[i]}<span class="day-num">${d.getDate()}</span>${dt.length?`<span style="font-size:8px;color:${wkOverdue?'var(--red)':'var(--accent)'};font-family:var(--mono);margin-left:4px;opacity:0.7">${dt.length}</span>`:''}</div>
      ${dt.map(t=>`<div class="week-task-card" draggable="true" ondragstart="calDragStart(event,${t.id})" onclick="openTaskDetail(${t.id})">
        <div class="wt-title">${esc(t.title||'Untitled')}</div>
        <div class="wt-meta"><span class="badge badge-${t.priority==='p0'?'red':t.priority==='p1'?'orange':t.priority==='p2'?'yellow':'muted'}" style="font-size:8px;padding:1px 4px">${t.priority||'p3'}</span>${t.project?`<span style="font-size:8px;color:var(--text-muted)">${esc(t.project)}</span>`:''}${t.estimate?`<span style="font-size:8px;color:var(--accent-cyan);font-family:var(--mono)">${esc(t.estimate)}</span>`:''}</div>
      </div>`).join('')}
      <div class="week-add" onclick="calClickDay('${ds}')">+ task</div>
    </div>`;
  }
  document.getElementById('cal-week-grid').innerHTML=h;
}
function renderCalAgenda(){
  const el=document.getElementById('cal-agenda-grid');if(!el)return;
  const today=new Date().toISOString().split('T')[0];
  const tasks=S.tasks.filter(t=>t.due&&t.status!=='done').sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  const overdue=tasks.filter(t=>t.due<today);
  const upcoming=tasks.filter(t=>t.due>=today);
  const groups={};
  upcoming.forEach(t=>{const d=t.due;if(!groups[d])groups[d]=[];groups[d].push(t);});
  let h='<div style="max-height:calc(100vh - 260px);overflow-y:auto;padding:4px">';
  if(overdue.length){
    h+=`<div style="padding:6px 8px;font-size:10px;font-weight:600;color:var(--red);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-bottom:4px">Overdue (${overdue.length})</div>`;
    overdue.forEach(t=>{h+=`<div onclick="openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:8px;padding:6px 8px;cursor:pointer;border-left:3px solid var(--red);margin-bottom:2px;background:rgba(239,68,68,0.05);border-radius:0 4px 4px 0"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted)">${t.due} (${relativeDate(t.due)}) | ${t.priority||'p2'}${t.project?' | '+esc(t.project):''}</div></div></div>`;});
  }
  const sortedDates=Object.keys(groups).sort();
  sortedDates.forEach(ds=>{
    const d=new Date(ds+'T12:00:00');
    const label=d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    const isToday=ds===today;
    h+=`<div style="padding:6px 8px;font-size:10px;font-weight:600;color:${isToday?'var(--accent)':'var(--text-muted)'};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);margin-top:8px;margin-bottom:4px">${label}${isToday?' (Today)':''} (${groups[ds].length})</div>`;
    groups[ds].forEach(t=>{
      const pClr=t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':t.priority==='p2'?'var(--accent-cyan)':'var(--text-muted)';
      h+=`<div onclick="openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:8px;padding:6px 8px;cursor:pointer;border-left:3px solid ${pClr};margin-bottom:2px;border-radius:0 4px 4px 0;transition:background 0.15s" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted)">${t.priority||'p2'}${t.project?' | '+esc(t.project):''}${t.estimate?' | '+esc(t.estimate):''}${(t.subtasks&&t.subtasks.length)?' | '+t.subtasks.filter(s=>s.done).length+'/'+t.subtasks.length+' subtasks':''}</div></div></div>`;
    });
  });
  if(!tasks.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No upcoming tasks with due dates</div>';
  h+='</div>';
  el.innerHTML=h;
  document.getElementById('cal-month-label').innerHTML='Agenda View <span style="font-size:9px;color:var(--accent);font-family:var(--mono)">'+tasks.length+' tasks</span>';
}
function calNav(dir){
  if(calView==='week'){
    calWeekStart.setDate(calWeekStart.getDate()+(dir*7));
    renderCalendar(); return;
  }
  calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}if(calMonth<0){calMonth=11;calYear--;}renderCalendar();
}
function calToday(){
  calMonth=new Date().getMonth();calYear=new Date().getFullYear();
  const now=new Date(),day=now.getDay(),diff=day===0?-6:1-day;
  calWeekStart=new Date(now.getFullYear(),now.getMonth(),now.getDate()+diff);
  renderCalendar();
}
function calClickDay(dateStr){
  const dt=S.tasks.filter(t=>t.due===dateStr);
  if(dt.length>0){calDayPopup(dateStr,dt);return;}
  S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString()});
  save();renderCalendar();renderTasks();
  toast('New task on '+dateStr);
}
function calDayPopup(dateStr,tasks){
  let existing=document.getElementById('cal-day-popup');if(existing)existing.remove();
  const d=new Date(dateStr+'T12:00:00');
  const label=d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const popup=document.createElement('div');popup.id='cal-day-popup';
  popup.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:16px;z-index:9999;max-width:350px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.5)';
  popup.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:13px;font-weight:600;color:var(--text-primary)">${label}</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">x</button></div><div style="display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto">${tasks.map(t=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-secondary);border-radius:4px;cursor:pointer;border-left:3px solid var(${t.priority==='p0'?'--red':t.priority==='p1'?'--orange':'--accent'})" onclick="this.parentElement.parentElement.remove();openTaskDetail(${t.id})"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted)">${t.status} | ${t.priority||'p2'}${t.project?' | '+esc(t.project):''}</div></div></div>`).join('')}</div><button onclick="this.parentElement.remove();calAddTaskOnDay('${dateStr}')" class="btn btn-primary btn-sm" style="width:100%;margin-top:10px">+ Add task on this day</button>`;
  document.body.appendChild(popup);
  popup.addEventListener('click',e=>{if(e.target===popup)popup.remove();});
}
function calAddTaskOnDay(dateStr){
  S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString()});
  save();renderCalendar();renderTasks();toast('New task on '+dateStr);
}
function renderYearHeatmap(){
  const year=calYear;const today=new Date().toISOString().split('T')[0];
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('cal-month-label').innerHTML=year+' <span style="font-size:9px;color:var(--accent);font-family:var(--mono)">Activity Heatmap</span>';
  const tasksByDay={};S.tasks.forEach(t=>{if(t.due){tasksByDay[t.due]=(tasksByDay[t.due]||0)+1;}if(t.created){const cd=t.created.split('T')[0];tasksByDay[cd]=(tasksByDay[cd]||0)+0.5;}if(t.completedAt){const cd=t.completedAt.split('T')[0];tasksByDay[cd]=(tasksByDay[cd]||0)+1;}});
  S.content.forEach(c=>{if(c.created){const cd=c.created.split('T')[0];tasksByDay[cd]=(tasksByDay[cd]||0)+0.5;}});
  const maxActivity=Math.max(1,...Object.values(tasksByDay));
  const cellSize=11;const cellGap=2;const startDay=new Date(year,0,1).getDay();
  const weeksInYear=53;const svgW=weeksInYear*(cellSize+cellGap)+40;const svgH=7*(cellSize+cellGap)+30;
  let svg=`<svg width="${svgW}" height="${svgH}" style="display:block;margin:8px auto">`;
  ['S','M','T','W','T','F','S'].forEach((d,i)=>{svg+=`<text x="0" y="${i*(cellSize+cellGap)+cellSize+20}" font-size="8" fill="var(--text-muted)" font-family="var(--mono)">${d}</text>`;});
  let currentMonth=-1;
  for(let w=0;w<weeksInYear;w++){
    for(let d=0;d<7;d++){
      const dayNum=w*7+d-startDay;const date=new Date(year,0,1+dayNum);
      if(date.getFullYear()!==year)continue;
      const ds=date.toISOString().split('T')[0];const activity=tasksByDay[ds]||0;
      const intensity=activity?Math.min(1,activity/maxActivity):0;
      const fill=activity===0?'rgba(255,255,255,0.03)':intensity<0.25?'rgba(74,222,128,0.2)':intensity<0.5?'rgba(74,222,128,0.4)':intensity<0.75?'rgba(74,222,128,0.6)':'rgba(74,222,128,0.9)';
      const x=30+w*(cellSize+cellGap);const y=20+d*(cellSize+cellGap);
      svg+=`<rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" rx="2" fill="${fill}" stroke="${ds===today?'var(--accent)':'none'}" stroke-width="${ds===today?'1':'0'}"><title>${ds}: ${Math.round(activity)} activity</title></rect>`;
      if(date.getMonth()!==currentMonth){currentMonth=date.getMonth();svg+=`<text x="${x}" y="12" font-size="8" fill="var(--text-muted)" font-family="var(--mono)">${months[currentMonth]}</text>`;}
    }
  }
  svg+='</svg>';
  const yearGrid=document.getElementById('cal-year-grid');
  if(yearGrid){yearGrid.innerHTML=svg+'<div style="display:flex;gap:4px;justify-content:center;align-items:center;margin-top:4px;font-size:8px;color:var(--text-muted)"><span>Less</span><span style="width:10px;height:10px;background:rgba(255,255,255,0.03);border-radius:2px;display:inline-block"></span><span style="width:10px;height:10px;background:rgba(74,222,128,0.2);border-radius:2px;display:inline-block"></span><span style="width:10px;height:10px;background:rgba(74,222,128,0.4);border-radius:2px;display:inline-block"></span><span style="width:10px;height:10px;background:rgba(74,222,128,0.6);border-radius:2px;display:inline-block"></span><span style="width:10px;height:10px;background:rgba(74,222,128,0.9);border-radius:2px;display:inline-block"></span><span>More</span></div>';}
}
function calDragStart(e,id){calDragId=id;e.dataTransfer.effectAllowed='move';}
function calDrop(e,dateStr){e.preventDefault();if(calDragId){const t=S.tasks.find(x=>x.id===calDragId);if(t){t.due=dateStr;save();renderCalendar();renderTasks();toast('Moved to '+dateStr);}calDragId=null;}}
function exportICS(){let ics='BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//SaturnoHub//EN\n';S.tasks.filter(t=>t.due).forEach(t=>{const d=t.due.replace(/-/g,'');ics+=`BEGIN:VEVENT\nDTSTART;VALUE=DATE:${d}\nSUMMARY:${t.title||'Task'}\nDESCRIPTION:Priority: ${t.priority||'p2'} | Status: ${t.status||'todo'}${t.project?' | Project: '+t.project:''}\nEND:VEVENT\n`;});ics+='END:VCALENDAR';const blob=new Blob([ics],{type:'text/calendar'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-tasks.ics';a.click();toast('ICS exported - import into Google Calendar');}
function importICS(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.ics,.ical';
  inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{
    const text=ev.target.result;const events=text.split('BEGIN:VEVENT').slice(1);
    if(!events.length){toast('No events found in ICS file');return;}
    let count=0;
    events.forEach(block=>{
      const sum=(block.match(/SUMMARY[;:]([^\r\n]+)/)||[])[1]||'';
      const desc=(block.match(/DESCRIPTION[;:]([^\r\n]+)/)||[])[1]||'';
      let dateStr='';
      const dtMatch=block.match(/DTSTART[^:]*:(\d{4})(\d{2})(\d{2})/);
      if(dtMatch)dateStr=dtMatch[1]+'-'+dtMatch[2]+'-'+dtMatch[3];
      if(!sum.trim())return;
      const title=sum.replace(/\\,/g,',').replace(/\\n/g,' ').trim();
      const existing=S.tasks.find(t=>t.title===title&&t.due===dateStr);
      if(existing)return;
      S.tasks.unshift({id:Date.now()+count,title,description:desc.replace(/\\n/g,'\n').replace(/\\,/g,',').substring(0,500),subtasks:[],status:'todo',priority:'p2',project:'',due:dateStr,created:new Date().toISOString(),source:'ics-import'});
      count++;
    });
    save();renderCalendar();renderTasks();toast('Imported '+count+' events from ICS');
  };r.readAsText(f);};inp.click();
}

function exportWeek(){
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());weekStart.setHours(0,0,0,0);
  const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  let md='# Week of '+weekStart.toLocaleDateString('en-US',{month:'long',day:'numeric'})+' - '+weekEnd.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})+'\n\n';
  for(let i=0;i<7;i++){
    const d=new Date(weekStart);d.setDate(d.getDate()+i);
    const ds=d.toISOString().split('T')[0];
    const tasks=S.tasks.filter(t=>t.due===ds);
    if(tasks.length){md+='## '+days[d.getDay()]+' ('+ds+')\n';tasks.forEach(t=>{md+='- ['+t.status+'] '+t.title+(t.priority?' ('+t.priority+')':'')+(t.project?' ['+t.project+']':'')+'\n';});md+='\n';}
  }
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString()));
  if(doneThisWeek.length){md+='## Completed This Week\n';doneThisWeek.forEach(t=>{md+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});md+='\n';}
  navigator.clipboard.writeText(md).then(()=>toast('Week summary copied to clipboard'));
}

function exportMonth(){
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  let md='# '+months[calMonth]+' '+calYear+'\n\n';
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date().toISOString().split('T')[0];
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const tasks=S.tasks.filter(t=>t.due===ds);
    if(tasks.length){const dt=new Date(ds+'T12:00:00');md+='## '+dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})+'\n';tasks.forEach(t=>{md+='- ['+t.status+'] '+t.title+(t.priority?' ('+t.priority+')':'')+(t.project?' ['+t.project+']':'')+'\n';});md+='\n';}
  }
  const monthDone=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(calYear+'-'+String(calMonth+1).padStart(2,'0')));
  if(monthDone.length){md+='## Completed This Month ('+monthDone.length+')\n';monthDone.forEach(t=>{md+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});}
  navigator.clipboard.writeText(md).then(()=>toast(months[calMonth]+' summary copied'));
}
function exportTasksICS(){
  const tasks=S.tasks.filter(t=>t.due&&t.status!=='done');
  if(!tasks.length){toast('No active tasks with due dates');return;}
  let ics='BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Saturno Hub//EN\r\nCALSCALE:GREGORIAN\r\n';
  tasks.forEach(t=>{
    const d=t.due.replace(/-/g,'');
    ics+='BEGIN:VEVENT\r\nDTSTART;VALUE=DATE:'+d+'\r\nDTEND;VALUE=DATE:'+d+'\r\nSUMMARY:'+(t.title||'Task').replace(/[,;\\]/g,' ')+'\r\nDESCRIPTION:'+(t.priority||'').toUpperCase()+(t.project?' ['+t.project.replace(/[,;\\]/g,' ')+']':'')+(t.description?' - '+(t.description||'').substring(0,100).replace(/[,;\\]/g,' '):'')+'\r\nUID:saturno-'+t.id+'@hub\r\nEND:VEVENT\r\n';
  });
  ics+='END:VCALENDAR\r\n';
  const blob=new Blob([ics],{type:'text/calendar'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-tasks.ics';a.click();toast('Exported '+tasks.length+' tasks as ICS');
}

// === WRITING HUB ===
function getActiveDoc(){return S.docs.find(d=>d.id===S.activeDoc);}
function renderWriter(){renderDocList();loadDoc();document.getElementById('writer-count').textContent=S.docs.length;}
function renderDocList(){const q=(document.getElementById('writer-doc-search')?.value||'').toLowerCase();const sortBy=(document.getElementById('writer-doc-sort')?.value)||'updated';let sorted=[...S.docs];if(sortBy==='updated')sorted.sort((a,b)=>(new Date(b.updated||0))-(new Date(a.updated||0)));else if(sortBy==='created')sorted.sort((a,b)=>(new Date(b.created||0))-(new Date(a.created||0)));else if(sortBy==='alpha')sorted.sort((a,b)=>(a.title||'').localeCompare(b.title||''));else if(sortBy==='words')sorted.sort((a,b)=>countW(b.body)-countW(a.body));else if(sortBy==='tag')sorted.sort((a,b)=>((a.tags&&a.tags[0])||'zzz').localeCompare((b.tags&&b.tags[0])||'zzz'));if(q)sorted=sorted.filter(d=>(d.title||'').toLowerCase().includes(q)||(d.tags||[]).some(t=>t.includes(q)));sorted.sort((a,b)=>(b.starred?1:0)-(a.starred?1:0));const renderDocItem=d=>{const w=countW(d.body);const dt=d.updated?new Date(d.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';return`<div class="writer-doc-item ${d.id===S.activeDoc?'active':''}" onclick="switchDoc(${d.id})"${d.starred?' style="border-left:2px solid var(--yellow)"':''}><div class="writer-doc-title">${d.starred?'<span style="color:var(--yellow);font-size:8px;margin-right:2px">*</span>':''}${esc(d.title||'Untitled')}</div>${(d.tags&&d.tags.length)?`<div style="display:flex;gap:2px;flex-wrap:wrap;margin:2px 0">${d.tags.map(t=>`<span style="font-size:7px;padding:0 4px;border-radius:6px;border:1px solid rgba(74,222,128,0.2);color:var(--accent);opacity:0.7">${esc(t)}</span>`).join('')}</div>`:''}<div class="writer-doc-meta"><span>${w}w${w>50?' / '+Math.max(1,Math.ceil(w/238))+'m':''}</span><span>${dt}</span><span style="margin-left:auto;cursor:pointer;opacity:0.4;font-size:8px;${d.starred?'color:var(--yellow);opacity:1':''}" onclick="event.stopPropagation();starDoc(${d.id})" title="${d.starred?'Unstar':'Star'}">*</span><span style="cursor:pointer;opacity:0.4;font-size:8px" onclick="event.stopPropagation();tagDoc(${d.id})" title="Add tags">T</span><span style="cursor:pointer;opacity:0.4;font-size:8px" onclick="event.stopPropagation();dupDoc(${d.id})" title="Duplicate">D</span>${S.docs.length>1?`<span style="cursor:pointer;opacity:0.4" onclick="event.stopPropagation();delDoc(${d.id})">x</span>`:''}</div></div>`;};
  let docListHtml='';if(sortBy==='tag'){let lastTag=null;sorted.forEach(d=>{const tag=(d.tags&&d.tags[0])||'Untagged';if(tag!==lastTag){const cnt=sorted.filter(x=>((x.tags&&x.tags[0])||'Untagged')===tag).length;docListHtml+=`<div style="padding:6px 8px 2px;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border);font-family:var(--mono)">${esc(tag)} <span style="color:var(--text-muted);font-weight:400">${cnt}</span></div>`;lastTag=tag;}docListHtml+=renderDocItem(d);});}else{docListHtml=sorted.map(renderDocItem).join('');}
  document.getElementById('writer-doc-list').innerHTML=docListHtml;}
function tagDoc(id){const d=S.docs.find(x=>x.id===id);if(!d)return;const current=(d.tags||[]).join(', ');const input=prompt('Tags (comma-separated):',current);if(input===null)return;d.tags=input.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);save();renderDocList();toast('Tags updated');}
function starDoc(id){const d=S.docs.find(x=>x.id===id);if(!d)return;d.starred=!d.starred;save();renderDocList();toast(d.starred?'Starred':'Unstarred');}
function loadDoc(){const d=getActiveDoc();if(!d)return;document.getElementById('writer-title').value=d.title||'';document.getElementById('writer-editor').innerHTML=d.body||'';if(!writerSessionStart[d.id]){const wc=(d.body||'').trim().split(/\s+/).filter(x=>x.length).length;writerSessionStart[d.id]=wc;}updateWS();renderVersions();renderWriterTags();}
function renderWriterTags(){const d=getActiveDoc();const bar=document.getElementById('writer-tags-bar');if(!bar||!d)return;const tags=d.tags||[];bar.innerHTML=tags.map(t=>`<span style="display:inline-flex;align-items:center;gap:2px;padding:1px 6px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:3px;font-size:9px;color:var(--text-muted);font-family:var(--mono)">${esc(t)}<span onclick="removeDocTag('${escA(t)}')" style="cursor:pointer;color:var(--red);margin-left:2px;font-size:8px" title="Remove tag">x</span></span>`).join('')+`<span onclick="addDocTag()" style="cursor:pointer;font-size:9px;color:var(--accent);padding:1px 4px" title="Add tag">+ tag</span>`;}
function addDocTag(){const d=getActiveDoc();if(!d)return;const allTags=[...new Set(S.docs.flatMap(x=>x.tags||[]))].sort();const t=prompt('Tag name:'+((allTags.length)?'\nExisting: '+allTags.join(', '):''));if(!t||!t.trim())return;if(!d.tags)d.tags=[];const tag=t.trim().toLowerCase();if(!d.tags.includes(tag)){d.tags.push(tag);save();renderWriterTags();renderDocList();toast('Tag added: '+tag);}}
function removeDocTag(tag){const d=getActiveDoc();if(!d||!d.tags)return;d.tags=d.tags.filter(t=>t!==tag);save();renderWriterTags();renderDocList();}
function switchDoc(id){if(S.activeDoc===id)return;snapshotWriter();save();S.activeDoc=id;renderWriter();const d=S.docs.find(x=>x.id===id);if(d)trackRecent('doc',id,d.title);save();updateBreadcrumb();}
function newDocFromTemplate(title,body){snapshotWriter();const d={id:Date.now(),title,body,versions:[],created:new Date().toISOString(),updated:new Date().toISOString()};S.docs.unshift(d);S.activeDoc=d.id;save();renderWriter();document.querySelectorAll('.btn-group div[style*="display: block"],.btn-group div[style*="display:block"]').forEach(d=>d.style.display='none');toast('Created: '+title);}
function newDoc(){snapshotWriter();const d={id:Date.now(),title:'',body:'',versions:[],created:new Date().toISOString(),updated:new Date().toISOString()};S.docs.unshift(d);S.activeDoc=d.id;save();renderWriter();document.getElementById('writer-title').focus();}
function delDoc(id){if(S.docs.length<=1){toast('Cannot delete last doc');return;}S.docs=S.docs.filter(d=>d.id!==id);if(S.activeDoc===id)S.activeDoc=S.docs[0].id;save();renderWriter();toast('Deleted');}
function mergeDocs(){
  snapshotWriter();
  const others=S.docs.filter(d=>d.id!==S.activeDoc);
  if(!others.length){toast('Need at least 2 docs to merge');return;}
  const target=prompt('Merge which doc into current?\n\n'+others.map((d,i)=>(i+1)+'. '+(d.title||'Untitled')+' ('+countW(d.body)+'w)').join('\n'));
  if(!target)return;
  const idx=parseInt(target)-1;
  if(isNaN(idx)||idx<0||idx>=others.length){toast('Invalid selection');return;}
  const src=others[idx];const cur=getActiveDoc();if(!cur)return;
  cur.body=(cur.body||'')+'<hr><h2>'+(src.title||'Merged Section')+'</h2>'+(src.body||'');
  cur.updated=new Date().toISOString();
  if(src.tags&&src.tags.length){if(!cur.tags)cur.tags=[];src.tags.forEach(t=>{if(!cur.tags.includes(t))cur.tags.push(t);});}
  S.docs=S.docs.filter(d=>d.id!==src.id);
  save();renderWriter();toast('Merged "'+src.title+'" into "'+cur.title+'"');
}
function dupDoc(id){const d=S.docs.find(x=>x.id===id);if(!d)return;snapshotWriter();const dup={...d,id:Date.now(),title:(d.title||'Untitled')+' (copy)',created:new Date().toISOString(),updated:new Date().toISOString(),versions:[]};S.docs.unshift(dup);S.activeDoc=dup.id;save();renderWriter();toast('Duplicated');}
function snapshotWriter(){const d=getActiveDoc();if(!d)return;const t=document.getElementById('writer-title'),e=document.getElementById('writer-editor');if(!t||!e)return;d.title=t.value;d.body=e.innerHTML;d.updated=new Date().toISOString();}
function onWriterChange(){clearTimeout(writerTimer);document.getElementById('ws-saved').textContent='Unsaved';document.getElementById('ws-saved').style.color='var(--yellow)';writerTimer=setTimeout(()=>{snapshotWriter();save();renderDocList();document.getElementById('ws-saved').textContent='Saved';document.getElementById('ws-saved').style.color='var(--green)';},800);updateWS();scheduleAutoBackup();}
function scheduleAutoBackup(){
  if(writerAutoBackupTimer)return;
  writerAutoBackupTimer=setTimeout(()=>{writerAutoBackupTimer=null;const d=getActiveDoc();if(!d)return;snapshotWriter();if(!d.versions)d.versions=[];const last=d.versions[0];const now=Date.now();if(last&&now-new Date(last.date).getTime()<300000)return;d.versions.unshift({id:now,title:d.title+' (auto)',body:d.body,words:countW(d.body),date:new Date().toISOString()});if(d.versions.length>50)d.versions=d.versions.slice(0,50);save();renderVersions();},600000);
}
function updateWS(){const e=document.getElementById('writer-editor'),t=e.innerText||'',w=t.trim().split(/\s+/).filter(x=>x.length).length;const paras=t.split(/\n\s*\n/).filter(p=>p.trim().length).length;const headings=e.querySelectorAll('h1,h2,h3,h4,h5,h6').length;document.getElementById('ws-words').textContent=w+' words';document.getElementById('ws-chars').textContent=paras+'p / '+headings+'h / '+t.length+'c';document.getElementById('ws-reading').textContent=Math.max(1,Math.ceil(w/238))+' min read';
  const d=getActiveDoc();const editedEl=document.getElementById('ws-edited');if(editedEl&&d&&d.updated)editedEl.textContent='Edited '+timeAgo(d.updated);
  const sesEl=document.getElementById('ws-session');if(sesEl&&d&&writerSessionStart[d.id]!==undefined){const delta=w-writerSessionStart[d.id];sesEl.textContent=delta>0?'+'+delta+' this session':delta<0?delta+' this session':'';sesEl.style.color=delta>0?'var(--green)':'var(--yellow)';};
  const goal=d&&d.wordGoal?d.wordGoal:0;const goalEl=document.getElementById('ws-goal');
  if(goal>0){const pct=Math.min(100,Math.round(w/goal*100));goalEl.textContent=pct+'% of '+goal+'w goal';goalEl.style.color=pct>=100?'var(--green)':'var(--accent-cyan)';}else{goalEl.textContent='Set goal';goalEl.style.color='var(--text-muted)';}
  const readEl=document.getElementById('ws-readability');if(readEl&&w>30){const sentences=t.split(/[.!?]+/).filter(s=>s.trim().length).length||1;const syllCount=tw=>{tw=tw.toLowerCase().replace(/[^a-z]/g,'');if(tw.length<=3)return 1;tw=tw.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/,'').replace(/^y/,'');const m=tw.match(/[aeiouy]{1,2}/g);return m?m.length:1;};const words=t.trim().split(/\s+/).filter(x=>x.length);const totalSyll=words.reduce((a,wd)=>a+syllCount(wd),0);const fre=Math.round(206.835-1.015*(w/sentences)-84.6*(totalSyll/w));const label=fre>=70?'Easy':fre>=50?'Standard':fre>=30?'Academic':'Complex';const color=fre>=70?'var(--green)':fre>=50?'var(--accent-cyan)':fre>=30?'var(--yellow)':'var(--red)';readEl.textContent=label+' ('+fre+')';readEl.style.color=color;readEl.title='Flesch Reading Ease: '+fre+' (0=very hard, 100=very easy)';}else if(readEl){readEl.textContent='';}}

function writerScrollUpdate(el){const s=document.getElementById('ws-scroll');if(!s||!el)return;const max=el.scrollHeight-el.clientHeight;if(max<=0){s.textContent='';return;}const pct=Math.round(el.scrollTop/max*100);s.textContent=pct+'%';}
function setWriterGoal(){const d=getActiveDoc();if(!d)return;const g=prompt('Word count goal:',d.wordGoal||'');if(g===null)return;d.wordGoal=parseInt(g)||0;save();updateWS();}
function countW(html){const d=document.createElement('div');d.innerHTML=html||'';return(d.innerText||'').trim().split(/\s+/).filter(x=>x.length).length;}
function execCmd(c){document.execCommand(c,false,null);document.getElementById('writer-editor').focus();}
function execBlock(tag){document.execCommand('formatBlock',false,'<'+tag+'>');document.getElementById('writer-editor').focus();}
function insertLink(){const u=prompt('URL:');if(u)document.execCommand('createLink',false,u);document.getElementById('writer-editor').focus();}
function insertHR(){document.execCommand('insertHTML',false,'<hr>');document.getElementById('writer-editor').focus();}
function insertCodeInline(){const s=window.getSelection();if(s.rangeCount)document.execCommand('insertHTML',false,'<code>'+(esc(s.toString())||'code')+'</code>');}
function clearFormatting(){document.execCommand('removeFormat',false,null);document.getElementById('writer-editor').focus();}
function writerKeydown(e){if(e.key==='Tab'){e.preventDefault();document.execCommand('insertHTML',false,'&nbsp;&nbsp;&nbsp;&nbsp;');}if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveVersion();}if((e.ctrlKey||e.metaKey)&&(e.key==='h'||e.key==='f')&&currentSection==='writer'){e.preventDefault();writerFindOpen();}}
function writerTOC(){
  const editor=document.getElementById('writer-editor');if(!editor)return;
  const headings=editor.querySelectorAll('h1,h2,h3');
  if(!headings.length){toast('No headings found');return;}
  let toc='<div style="border:1px solid var(--border);border-radius:6px;padding:12px 16px;margin:8px 0;background:var(--bg-secondary)"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em">Table of Contents</div>';
  headings.forEach(h=>{
    const level=parseInt(h.tagName[1]);const indent=(level-1)*16;
    toc+=`<div style="padding:2px 0 2px ${indent}px;font-size:${level===1?'12':'11'}px;color:var(--text-${level===1?'primary':'secondary'})">${h.textContent}</div>`;
  });
  toc+='</div>';
  const range=document.createRange();range.selectNodeContents(editor);range.collapse(true);
  const frag=range.createContextualFragment(toc);
  editor.insertBefore(frag,editor.firstChild);
  onWriterChange();toast('TOC inserted at top');
}
function writerFindOpen(){const bar=document.getElementById('writer-find-bar');bar.style.display='flex';document.getElementById('writer-find-input').focus();const sel=window.getSelection();if(sel.toString())document.getElementById('writer-find-input').value=sel.toString();}
function writerFindClose(){document.getElementById('writer-find-bar').style.display='none';document.getElementById('writer-find-count').textContent='';window.getSelection().removeAllRanges();}
function writerFindNext(){const q=document.getElementById('writer-find-input').value;if(!q){document.getElementById('writer-find-count').textContent='';return;}const ed=document.getElementById('writer-editor');const text=ed.innerText;const matches=text.match(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'));document.getElementById('writer-find-count').textContent=matches?matches.length+' found':'0 found';if(window.find)window.find(q,false,false,true);}
function writerReplace(){const q=document.getElementById('writer-find-input').value;const r=document.getElementById('writer-replace-input').value;if(!q)return;const sel=window.getSelection();if(sel.toString().toLowerCase()===q.toLowerCase()){document.execCommand('insertText',false,r);writerFindNext();}}
function writerReplaceAll(){const q=document.getElementById('writer-find-input').value;const r=document.getElementById('writer-replace-input').value;if(!q)return;const ed=document.getElementById('writer-editor');const re=new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');const count=(ed.innerText.match(re)||[]).length;snapshotWriter();const d=getActiveDoc();if(d){const tmp=document.createElement('div');tmp.innerHTML=d.body;const walk=n=>{if(n.nodeType===3){const parts=n.textContent.split(re);if(parts.length>1){n.textContent=n.textContent.replace(re,r);}}else{n.childNodes.forEach(walk);}};walk(tmp);d.body=tmp.innerHTML;save();loadDoc();}toast('Replaced '+count+' occurrences');writerFindClose();}
function saveVersion(){snapshotWriter();const d=getActiveDoc();if(!d)return;if(!d.versions)d.versions=[];d.versions.unshift({id:Date.now(),title:d.title,body:d.body,words:countW(d.body),date:new Date().toISOString()});if(d.versions.length>50)d.versions=d.versions.slice(0,50);save();renderVersions();toast('Version saved');}
function renderVersions(){const d=getActiveDoc(),el=document.getElementById('writer-versions');if(!d||!d.versions||!d.versions.length){el.innerHTML='<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:20px">No versions. Ctrl+S to save.</div>';return;}el.innerHTML=d.versions.map((v,i)=>{const dt=new Date(v.date);const curW=countW(d.body);const diff=v.words-curW;const diffStr=diff>0?'+'+diff:diff<0?''+diff:'=';const diffColor=diff>0?'var(--green)':diff<0?'var(--red)':'var(--text-muted)';return`<div class="writer-version-item"><div style="display:flex;justify-content:space-between;align-items:center"><div class="writer-version-title">${esc(v.title||'Untitled')}</div><span style="font-size:8px;color:${diffColor};font-family:var(--mono)">${diffStr}w</span></div><div class="writer-version-meta">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${dt.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})} - ${v.words||0}w</div><div style="display:flex;gap:4px;margin-top:3px"><button class="btn btn-sm btn-ghost" onclick="previewVersion(${i})" style="font-size:8px;padding:1px 4px">Preview</button><button class="btn btn-sm btn-ghost" onclick="restoreVersion(${i})" style="font-size:8px;padding:1px 4px">Restore</button></div></div>`;}).join('');}
function restoreVersion(i){const d=getActiveDoc();if(!d||!d.versions[i])return;const v=d.versions[i];d.title=v.title;d.body=v.body;d.updated=new Date().toISOString();save();loadDoc();toast('Restored');}
function previewVersion(i){
  const d=getActiveDoc();if(!d||!d.versions[i])return;
  const v=d.versions[i];
  let existing=document.getElementById('version-preview');if(existing)existing.remove();
  const overlay=document.createElement('div');overlay.id='version-preview';
  overlay.style.cssText='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center';
  const curW=countW(d.body);const vW=v.words||0;
  overlay.innerHTML=`<div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);max-width:700px;width:95%;max-height:80vh;display:flex;flex-direction:column;overflow:hidden"><div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><div><span style="font-size:13px;font-weight:600;color:var(--text)">${esc(v.title||'Untitled')}</span><span style="font-size:9px;color:var(--text-muted);margin-left:8px">${new Date(v.date).toLocaleString()}</span></div><div style="display:flex;gap:6px"><span style="font-size:9px;color:var(--text-muted)">${vW}w version / ${curW}w current</span><button class="btn btn-sm btn-primary" onclick="restoreVersion(${i});this.closest('#version-preview').remove()">Restore</button><button onclick="this.closest('#version-preview').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:4px">x</button></div></div><div style="padding:16px;overflow-y:auto;font-size:12px;line-height:1.8;color:var(--text)">${v.body||'<em style="color:var(--text-muted)">Empty version</em>'}</div></div>`;
  document.body.appendChild(overlay);
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
}
function toggleWriterPanel(){writerPanelOpen=!writerPanelOpen;document.getElementById('writer-right-panel').classList.toggle('hidden',!writerPanelOpen);}
function writerExport(fmt){const d=getActiveDoc();if(!d||!fmt)return;const t=d.title||'untitled',e=document.getElementById('writer-editor');if(fmt==='clipboard'){navigator.clipboard.writeText(e.innerText);toast('Copied');return;}if(fmt==='print'){const wc=countW(e.innerHTML);const printHtml=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(t)}</title><style>@media print{@page{margin:1in}}body{font-family:Georgia,serif;max-width:680px;margin:40px auto;padding:0 20px;line-height:2;color:#111;font-size:12pt}h1{font-size:24pt;margin-bottom:8px;page-break-after:avoid}h2{font-size:18pt;margin-top:24px;page-break-after:avoid}h3{font-size:14pt;page-break-after:avoid}blockquote{border-left:3px solid #999;padding-left:16px;color:#444;font-style:italic;margin:16px 0}code{background:#f0f0f0;padding:1px 4px;border-radius:3px;font-size:10pt}pre{background:#f0f0f0;padding:12px;border-radius:6px;font-size:9pt;overflow-x:auto;page-break-inside:avoid}.meta{font-size:9pt;color:#666;margin-bottom:24px;border-bottom:1px solid #ddd;padding-bottom:8px}</style></head><body><h1>${esc(t)}</h1><div class="meta">${wc} words | Exported ${new Date().toLocaleDateString()}</div>${e.innerHTML}</body></html>`;const w=window.open('','_blank');w.document.write(printHtml);w.document.close();toast('Opened print view');return;}let c,m,x;if(fmt==='txt'){c=e.innerText;m='text/plain';x='txt';}else if(fmt==='html'){c=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(t)}</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#222}h1{font-size:28px}h2{font-size:22px}blockquote{border-left:3px solid #ccc;padding-left:16px;color:#666;font-style:italic}code{background:#f4f4f4;padding:1px 4px;border-radius:3px}pre{background:#f4f4f4;padding:12px;border-radius:6px;overflow-x:auto}</style></head><body><h1>${esc(t)}</h1>${e.innerHTML}</body></html>`;m='text/html';x='html';}else if(fmt==='md'){c=htmlToMd(e.innerHTML,t);m='text/markdown';x='md';}const blob=new Blob([c],{type:m});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=t.replace(/[^a-z0-9]/gi,'-').toLowerCase()+'.'+x;a.click();toast('Exported .'+x);}
function writerDetailedStats(){
  const d=getActiveDoc();if(!d)return;snapshotWriter();
  const text=(document.getElementById('writer-editor')?.innerText||'').trim();
  if(!text){toast('Document is empty');return;}
  const words=text.split(/\s+/).filter(x=>x.length);const wc=words.length;
  const chars=text.length;const charsNoSpace=text.replace(/\s/g,'').length;
  const sentences=text.split(/[.!?]+\s/).filter(Boolean).length;
  const paragraphs=text.split(/\n\s*\n/).filter(p=>p.trim()).length;
  const avgWordLen=wc?Math.round(charsNoSpace/wc*10)/10:0;
  const avgSentLen=sentences?Math.round(wc/sentences*10)/10:0;
  const readTime=Math.max(1,Math.ceil(wc/238));
  const speakTime=Math.max(1,Math.ceil(wc/150));
  const uniqueWords=new Set(words.map(w=>w.toLowerCase().replace(/[^a-z]/g,''))).size;
  const vocabRichness=wc?Math.round(uniqueWords/wc*100):0;
  const headings=(document.getElementById('writer-editor')?.querySelectorAll('h1,h2,h3,h4')||[]).length;
  const links=(document.getElementById('writer-editor')?.querySelectorAll('a')||[]).length;
  const stats=[
    'Words: '+wc.toLocaleString(),
    'Characters: '+chars.toLocaleString()+' ('+charsNoSpace.toLocaleString()+' no spaces)',
    'Sentences: '+sentences,'Paragraphs: '+paragraphs,
    'Avg word length: '+avgWordLen+' chars','Avg sentence length: '+avgSentLen+' words',
    'Reading time: ~'+readTime+' min','Speaking time: ~'+speakTime+' min',
    'Unique words: '+uniqueWords+' ('+vocabRichness+'% vocabulary richness)',
    'Headings: '+headings,'Links: '+links
  ];
  alert((d.title||'Untitled')+'\n\n'+stats.join('\n'));
}
function writerWordFreq(){
  const ed=document.getElementById('writer-editor');if(!ed)return;
  const text=(ed.innerText||'').trim();if(!text){toast('Document is empty');return;}
  const stopWords=new Set(['the','a','an','is','are','was','were','be','been','being','have','has','had','do','does','did','will','would','shall','should','may','might','must','can','could','and','but','or','nor','for','yet','so','in','on','at','to','of','by','with','from','as','into','through','during','before','after','above','below','up','down','out','off','over','under','again','further','then','once','here','there','when','where','why','how','all','each','every','both','few','more','most','other','some','such','no','not','only','own','same','than','too','very','just','because','also','about','its','it','this','that','these','those','i','me','my','we','us','our','you','your','he','him','his','she','her','they','them','their','what','which','who']);
  const words=text.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stopWords.has(w));
  const freq={};words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,25);
  if(!sorted.length){toast('Not enough words for analysis');return;}
  let existing=document.getElementById('writer-freq-panel');if(existing){existing.remove();return;}
  const panel=document.createElement('div');panel.id='writer-freq-panel';
  panel.style.cssText='position:absolute;right:8px;top:40px;width:200px;max-height:60vh;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,0.4)';
  const maxF=sorted[0][1];
  let html='<div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;display:flex;justify-content:space-between"><span>Word Frequency</span><span onclick="this.closest(\'#writer-freq-panel\').remove()" style="cursor:pointer;font-size:10px">x</span></div>';
  sorted.forEach(([w,c])=>{const pct=Math.round(c/maxF*100);html+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:10px"><span style="width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-secondary);font-family:var(--mono)">${esc(w)}</span><div style="flex:1;height:3px;background:var(--bg-secondary);border-radius:2px"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px"></div></div><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);min-width:16px;text-align:right">${c}</span></div>`;});
  panel.innerHTML=html;
  ed.parentElement.style.position='relative';
  ed.parentElement.appendChild(panel);
}
function writerOutline(){
  const ed=document.getElementById('writer-editor');if(!ed)return;
  const headings=ed.querySelectorAll('h1,h2,h3,h4,h5');
  if(!headings.length){toast('No headings found in document');return;}
  let existing=document.getElementById('writer-outline-panel');
  if(existing){existing.remove();return;}
  const panel=document.createElement('div');panel.id='writer-outline-panel';
  panel.style.cssText='position:absolute;right:8px;top:40px;width:220px;max-height:60vh;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;z-index:100;box-shadow:0 4px 16px rgba(0,0,0,0.4)';
  let html='<div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center"><span>Outline ('+headings.length+')</span><span onclick="this.closest(\'#writer-outline-panel\').remove()" style="cursor:pointer;font-size:10px">x</span></div>';
  headings.forEach((h,i)=>{
    const level=parseInt(h.tagName[1]);const indent=(level-1)*12;
    html+=`<div style="padding:3px 4px 3px ${indent}px;cursor:pointer;font-size:${13-level}px;color:var(--text-secondary);border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="document.getElementById('writer-editor').querySelectorAll('h1,h2,h3,h4,h5')[${i}].scrollIntoView({behavior:'smooth',block:'center'})">${esc(h.textContent||'Untitled')}</div>`;
  });
  panel.innerHTML=html;
  ed.parentElement.style.position='relative';
  ed.parentElement.appendChild(panel);
}
function writerToContent(){const d=getActiveDoc();if(!d)return;snapshotWriter();const ed=document.getElementById('writer-editor');const text=ed.innerText||'';if(!text.trim()){toast('Document is empty');return;}S.content.unshift({id:Date.now(),type:'caption',theme:d.title||'writer',body:text,tags:['from-writer'],source:'writer-export',created:new Date().toISOString()});save();toast('Saved to Content: '+(d.title||'Untitled').substring(0,30));}
function exportAllDocs(){
  if(!S.docs.length){toast('No documents');return;}
  snapshotWriter();
  let md='# All Documents\n\n*Exported '+new Date().toLocaleDateString()+'*\n\n---\n\n';
  S.docs.forEach(d=>{
    const wc=(d.body||'').trim().split(/\s+/).filter(x=>x.length).length;
    md+='## '+(d.title||'Untitled')+'\n';
    md+='*'+wc+' words | Updated: '+(d.updated?new Date(d.updated).toLocaleDateString():'unknown')+'*\n\n';
    md+=(d.body||'(empty)')+'\n\n---\n\n';
  });
  navigator.clipboard.writeText(md).then(()=>toast('All '+S.docs.length+' docs copied as markdown'));
}
function exportAllDocsHTML(){
  if(!S.docs.length){toast('No documents');return;}snapshotWriter();
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>All Documents - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:22px;color:#fff;margin-top:40px}hr{border:none;border-top:1px solid #222;margin:24px 0}.meta{font-size:12px;color:#888;margin-bottom:12px}.doc-body{margin-bottom:24px}blockquote{border-left:3px solid #4ade80;padding-left:16px;color:#aaa;font-style:italic}a{color:#4ade80}</style></head><body>';
  h+='<h1>All Documents</h1><p style="color:#888;font-size:13px">'+S.docs.length+' documents | Exported '+new Date().toLocaleDateString()+'</p><hr>';
  S.docs.forEach(d=>{const wc=(d.body||'').trim().split(/\\s+/).filter(x=>x.length).length;h+='<h2>'+esc(d.title||'Untitled')+'</h2><div class="meta">'+wc+' words | Updated: '+(d.updated?new Date(d.updated).toLocaleDateString():'unknown')+(d.tags&&d.tags.length?' | Tags: '+d.tags.join(', '):'')+'</div><div class="doc-body">'+(d.body||'<em>empty</em>')+'</div><hr>';});
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-docs-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.docs.length+' docs as HTML');
}
function exportAllDocsMD(){
  if(!S.docs.length){toast('No documents');return;}snapshotWriter();
  let md='# Writer Documents\n\nExported: '+new Date().toLocaleDateString()+' | '+S.docs.length+' documents\n\n---\n\n';
  S.docs.forEach(d=>{md+=htmlToMd(d.body||'',d.title||'Untitled')+'\n\n---\n\n';});
  const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-docs-'+new Date().toISOString().split('T')[0]+'.md';a.click();toast('Exported '+S.docs.length+' docs as Markdown');
}
function writerCompare(){
  if(S.docs.length<2){toast('Need 2+ docs to compare');return;}
  const current=getActiveDoc();
  const others=S.docs.filter(d=>d.id!==(current?current.id:-1));
  const list=others.map((d,i)=>(i+1)+'. '+(d.title||'Untitled')+' ('+countW(d.body)+'w)').join('\n');
  const choice=prompt('Compare current doc with:\n\n'+list+'\n\nEnter number:');
  if(!choice)return;const idx=parseInt(choice)-1;
  if(idx<0||idx>=others.length){toast('Invalid choice');return;}
  const docB=others[idx];const docA=current||S.docs[0];
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Compare: ${esc(docA.title||'A')} vs ${esc(docB.title||'B')}</title><style>*{margin:0;box-sizing:border-box}body{font-family:system-ui;background:#0a0a0e;color:#e0e0e0;display:grid;grid-template-columns:1fr 1fr;height:100vh;overflow:hidden}.panel{padding:24px;overflow-y:auto;border-right:1px solid #222}.panel:last-child{border:none}h2{font-size:16px;color:#4ade80;margin-bottom:4px}.meta{font-size:11px;color:#888;margin-bottom:16px}.content{line-height:1.8;font-size:14px;white-space:pre-wrap}h1,h2,h3{color:#fff}</style></head><body><div class="panel"><h2>${esc(docA.title||'Untitled')}</h2><div class="meta">${countW(docA.body)} words | Updated: ${docA.updated?new Date(docA.updated).toLocaleDateString():'?'}</div><div class="content">${docA.body||'(empty)'}</div></div><div class="panel"><h2>${esc(docB.title||'Untitled')}</h2><div class="meta">${countW(docB.body)} words | Updated: ${docB.updated?new Date(docB.updated).toLocaleDateString():'?'}</div><div class="content">${docB.body||'(empty)'}</div></div></body></html>`);
  w.document.close();toast('Comparing: '+docA.title+' vs '+docB.title);
}
function writerSplitDoc(){
  const doc=getActiveDoc();if(!doc){toast('No active doc');return;}
  const body=doc.body||'';
  const parts=body.split(/\n---\n|^---\n|\n---$/gm).map(p=>p.trim()).filter(Boolean);
  if(parts.length<2){toast('No --- separators found (need at least 2 sections)');return;}
  if(!confirm('Split into '+parts.length+' documents? The original will keep Part 1.')){return;}
  doc.body=parts[0];doc.updated=new Date().toISOString();
  for(let i=1;i<parts.length;i++){
    const title=(doc.title||'Untitled')+' (Part '+(i+1)+')';
    S.docs.push({id:Date.now()+i,title,body:parts[i],created:new Date().toISOString(),updated:new Date().toISOString()});
  }
  save();renderDocList();updateWS();toast('Split into '+parts.length+' docs');
}
function writerFromTemplate(type){
  const templates={
    meeting:{title:'Meeting Notes — '+new Date().toLocaleDateString(),body:'## Attendees\n\n- \n\n## Agenda\n\n1. \n\n## Discussion\n\n\n\n## Action Items\n\n- [ ] \n\n## Next Steps\n\n'},
    blog:{title:'Blog Post Draft',body:'# Title\n\n## Introduction\n\nHook the reader here.\n\n## Main Point 1\n\n\n\n## Main Point 2\n\n\n\n## Main Point 3\n\n\n\n## Conclusion\n\nCall to action.\n\n## Tags\n\n'},
    spec:{title:'Project Spec — ',body:'# Project Name\n\n## Overview\n\nOne-paragraph summary.\n\n## Problem Statement\n\nWhat problem does this solve?\n\n## Goals\n\n- \n\n## Non-Goals\n\n- \n\n## Proposed Solution\n\n\n\n## Technical Approach\n\n\n\n## Timeline\n\n| Phase | Target | Status |\n|-------|--------|--------|\n| Phase 1 |  |  |\n\n## Open Questions\n\n- \n'},
    journal:{title:'Journal — '+new Date().toLocaleDateString(),body:'## Today\n\n**Mood:** \n\n**Energy:** /10\n\n## What happened\n\n\n\n## What I learned\n\n\n\n## Gratitude\n\n1. \n2. \n3. \n\n## Tomorrow\n\n- \n'},
    outline:{title:'Outline',body:'# Title\n\n## I. Introduction\n   A. \n   B. \n\n## II. First Section\n   A. \n   B. \n   C. \n\n## III. Second Section\n   A. \n   B. \n\n## IV. Third Section\n   A. \n   B. \n\n## V. Conclusion\n   A. \n   B. \n'}
  };
  const tpl=templates[type];if(!tpl)return;
  const doc={id:Date.now(),title:tpl.title,body:tpl.body,created:new Date().toISOString(),updated:new Date().toISOString()};
  S.docs.push(doc);save();switchDoc(doc.id);renderDocList();toast('Created from template: '+type);
  document.querySelectorAll('.writer-toolbar-btn+div[style*="display: block"],.writer-toolbar-btn+div[style*="display:block"]').forEach(d=>d.style.display='none');
}
function exportAllTasksHTML(){
  if(!S.tasks.length){toast('No tasks');return;}
  const today=new Date().toISOString().split('T')[0];const active=S.tasks.filter(t=>t.status!=='done');const done=S.tasks.filter(t=>t.status==='done');
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>All Tasks - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:20px;color:#fff;margin-top:32px}hr{border:none;border-top:1px solid #222;margin:16px 0}.task{padding:8px 0;border-bottom:1px solid #1a1a1e}.title{font-weight:600}.done .title{text-decoration:line-through;color:#666}.meta{font-size:12px;color:#888;margin-top:2px}.desc{font-size:13px;color:#aaa;margin-top:4px}.p0{border-left:3px solid #ef4444;padding-left:8px}.p1{border-left:3px solid #f59e0b;padding-left:8px}.p2{border-left:3px solid #3b82f6;padding-left:8px}.p3{border-left:3px solid #666;padding-left:8px}.badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:10px;margin-right:4px}a{color:#4ade80}.sub{font-size:12px;color:#888;padding-left:16px}</style></head><body>';
  h+='<h1>All Tasks</h1><p style="color:#888;font-size:13px">'+S.tasks.length+' tasks ('+active.length+' active, '+done.length+' done) | Exported '+new Date().toLocaleDateString()+'</p>';
  const byProject={};S.tasks.forEach(t=>{const p=t.project||'No Project';if(!byProject[p])byProject[p]=[];byProject[p].push(t);});
  Object.entries(byProject).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([proj,tasks])=>{
    h+='<h2>'+esc(proj)+'</h2><hr>';
    tasks.forEach(t=>{h+='<div class="task '+(t.priority||'p2')+' '+(t.status==='done'?'done':'')+'"><div class="title">'+(t.status==='done'?'[x] ':'[ ] ')+esc(t.title||'Untitled')+'</div><div class="meta">'+(t.priority||'p2').toUpperCase()+' | '+t.status+(t.due?' | Due: '+t.due:'')+(t.estimate?' | Est: '+t.estimate:'')+(t.timeSpent?' | Tracked: '+formatTimeSpent(t.timeSpent):'')+'</div>'+(t.description?'<div class="desc">'+esc(t.description)+'</div>':'')+((t.subtasks&&t.subtasks.length)?t.subtasks.map(s=>'<div class="sub">'+(s.done?'[x] ':'[ ] ')+esc(s.title)+'</div>').join(''):'')+'</div>';});
  });
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-tasks-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.tasks.length+' tasks as HTML');
}
function exportAllLinksHTML(){
  if(!S.links.length){toast('No links');return;}
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>All Links - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:20px;color:#fff;margin-top:32px}hr{border:none;border-top:1px solid #222;margin:16px 0}.link{padding:8px 0;border-bottom:1px solid #1a1a1e}a{color:#4ade80;text-decoration:none}a:hover{text-decoration:underline}.meta{font-size:12px;color:#888;margin-top:2px}.desc{font-size:13px;color:#aaa;margin-top:4px}</style></head><body>';
  h+='<h1>All Links</h1><p style="color:#888;font-size:13px">'+S.links.length+' links | Exported '+new Date().toLocaleDateString()+'</p>';
  const byCat={};S.links.forEach(l=>{const c=l.category||'Uncategorized';if(!byCat[c])byCat[c]=[];byCat[c].push(l);});
  Object.entries(byCat).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([cat,links])=>{
    h+='<h2>'+esc(cat)+' ('+links.length+')</h2><hr>';
    links.forEach(l=>{h+='<div class="link"><a href="'+escA(l.url)+'" target="_blank">'+esc(l.title||l.url)+'</a><div class="meta">'+esc(l.url)+(l.created?' | Added '+new Date(l.created).toLocaleDateString():'')+'</div>'+(l.desc?'<div class="desc">'+esc(l.desc)+'</div>':'')+'</div>';});
  });
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-links-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.links.length+' links as HTML');
}
function exportAllContentMD(){
  if(!S.content.length){toast('No content');return;}
  let md='# Content Library\n\nExported: '+new Date().toLocaleDateString()+' | '+S.content.length+' items\n\n---\n\n';
  const byType={};S.content.forEach(c=>{const t=c.type||'other';if(!byType[t])byType[t]=[];byType[t].push(c);});
  Object.entries(byType).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([type,items])=>{
    md+='## '+type.charAt(0).toUpperCase()+type.slice(1)+' ('+items.length+')\n\n';
    items.forEach(c=>{md+='### '+(c.theme||'Untitled')+'\n';if(c.tags&&c.tags.length)md+='Tags: '+c.tags.join(', ')+'\n';if(c.created)md+='*'+new Date(c.created).toLocaleDateString()+'*\n';md+='\n'+c.body+'\n\n---\n\n';});
  });
  const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-content-'+new Date().toISOString().split('T')[0]+'.md';a.click();toast('Exported '+S.content.length+' content items');
}
function htmlToMd(html,title){let md='# '+(title||'Untitled')+'\n\n';const tmp=document.createElement('div');tmp.innerHTML=html;const walk=n=>{if(n.nodeType===3)return n.textContent;if(n.nodeType!==1)return'';const tag=n.tagName.toLowerCase(),ch=Array.from(n.childNodes).map(walk).join('');switch(tag){case'h1':return'\n# '+ch+'\n\n';case'h2':return'\n## '+ch+'\n\n';case'h3':return'\n### '+ch+'\n\n';case'p':return ch+'\n\n';case'br':return'\n';case'strong':case'b':return'**'+ch+'**';case'em':case'i':return'*'+ch+'*';case'code':return'`'+ch+'`';case'pre':return'\n```\n'+ch+'\n```\n\n';case'blockquote':return'\n> '+ch.replace(/\n/g,'\n> ')+'\n\n';case'ul':return'\n'+ch+'\n';case'ol':return'\n'+ch+'\n';case'li':return'- '+ch+'\n';case'a':return'['+ch+']('+n.href+')';case'hr':return'\n---\n\n';case'div':return ch+'\n';default:return ch;}};md+=Array.from(tmp.childNodes).map(walk).join('');return md.replace(/\n{3,}/g,'\n\n').trim()+'\n';}

function simpleMarkdown(text){
  if(!text)return'';
  let h=esc(text);
  h=h.replace(/^### (.+)$/gm,'<span style="font-weight:600;font-size:11px;color:var(--accent)">$1</span>');
  h=h.replace(/^## (.+)$/gm,'<span style="font-weight:600;font-size:12px;color:var(--text-primary)">$1</span>');
  h=h.replace(/^# (.+)$/gm,'<span style="font-weight:700;font-size:13px;color:var(--text-primary)">$1</span>');
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*(.+?)\*/g,'<em>$1</em>');
  h=h.replace(/`([^`]+)`/g,'<code style="background:var(--bg-elevated);padding:1px 3px;border-radius:2px;font-size:0.9em">$1</code>');
  h=h.replace(/^[-*] (.+)$/gm,'<span style="padding-left:8px">&#8226; $1</span>');
  h=h.replace(/^&gt; (.+)$/gm,'<span style="border-left:2px solid var(--accent);padding-left:6px;color:var(--text-muted);font-style:italic;display:block">$1</span>');
  h=h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" style="color:var(--accent);text-decoration:underline dotted" onclick="event.stopPropagation()">$1</a>');
  h=h.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid var(--border);margin:4px 0">');
  return h;
}
// === ZEN WRITER (full-screen distraction-free) ===
let zenDocId = null;
let zenTimer = null;
let zenIsOpen = false;

function zenOpen(docId) {
  zenIsOpen = true;
  const zw = document.getElementById('zen-writer');
  // Snapshot current writer state if in writer section
  if(currentSection === 'writer') snapshotWriter();
  // Pick doc
  if(docId) { zenDocId = docId; }
  else if(!zenDocId) { zenDocId = S.activeDoc || (S.docs[0] && S.docs[0].id); }
  zenRenderPicker();
  zenLoadDoc();
  zw.classList.add('open');
  document.getElementById('zen-fab').style.display = 'none';
  setTimeout(function(){ document.getElementById('zen-editor').focus(); }, 100);
}

function zenClose() {
  zenSnapshot();
  save();
  zenIsOpen = false;
  document.getElementById('zen-writer').classList.remove('open');
  document.getElementById('zen-fab').style.display = '';
  // Sync back to writer section if active
  if(currentSection === 'writer') { renderWriter(); }
}

function zenRenderPicker() {
  const sel = document.getElementById('zen-doc-picker');
  sel.innerHTML = S.docs.map(function(d) {
    return '<option value="' + d.id + '"' + (d.id === zenDocId ? ' selected' : '') + '>' + esc(d.title || 'Untitled') + ' (' + countW(d.body) + 'w)</option>';
  }).join('');
}

function zenPickDoc(id) {
  zenSnapshot();
  save();
  zenDocId = parseInt(id) || id;
  zenLoadDoc();
}

function zenLoadDoc() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d && S.docs.length) { d = S.docs[0]; zenDocId = d.id; }
  if(!d) return;
  document.getElementById('zen-title').value = d.title || '';
  document.getElementById('zen-editor').innerHTML = d.body || '';
  zenUpdateStats();
}

function zenSnapshot() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  var t = document.getElementById('zen-title');
  var e = document.getElementById('zen-editor');
  if(!t || !e) return;
  d.title = t.value;
  d.body = e.innerHTML;
  d.updated = new Date().toISOString();
}

function zenOnChange() {
  clearTimeout(zenTimer);
  document.getElementById('zen-saved').textContent = 'Unsaved';
  document.getElementById('zen-saved').style.color = 'var(--yellow)';
  zenTimer = setTimeout(function() {
    zenSnapshot();
    save();
    zenRenderPicker();
    document.getElementById('zen-saved').textContent = 'Saved';
    document.getElementById('zen-saved').style.color = 'var(--green)';
  }, 800);
  zenUpdateStats();
}

function zenUpdateStats() {
  var e = document.getElementById('zen-editor');
  var t = e.innerText || '';
  var w = t.trim().split(/\s+/).filter(function(x){ return x.length; }).length;
  document.getElementById('zen-words').textContent = w + ' words';
  document.getElementById('zen-chars').textContent = t.length + ' chars';
  document.getElementById('zen-reading').textContent = Math.max(1, Math.ceil(w / 238)) + ' min read';
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  var goal = d && d.wordGoal ? d.wordGoal : 0;
  var goalEl = document.getElementById('zen-goal');
  if(goal > 0) {
    var pct = Math.min(100, Math.round(w / goal * 100));
    goalEl.textContent = pct + '% of ' + goal + 'w goal';
    goalEl.style.color = pct >= 100 ? 'var(--green)' : 'var(--accent-cyan)';
  } else {
    goalEl.textContent = 'Set goal';
    goalEl.style.color = 'var(--text-muted)';
  }
}

function zenSetGoal() {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  var g = prompt('Word count goal:', d.wordGoal || '');
  if(g === null) return;
  d.wordGoal = parseInt(g) || 0;
  save();
  zenUpdateStats();
}

function zenNewDoc() {
  zenSnapshot();
  var d = { id: Date.now(), title: '', body: '', versions: [], created: new Date().toISOString(), updated: new Date().toISOString() };
  S.docs.unshift(d);
  zenDocId = d.id;
  S.activeDoc = d.id;
  save();
  zenRenderPicker();
  zenLoadDoc();
  document.getElementById('zen-title').focus();
}

function zenCmd(c) { document.execCommand(c, false, null); document.getElementById('zen-editor').focus(); }
function zenExecBlock(tag) { document.execCommand('formatBlock', false, '<' + tag + '>'); document.getElementById('zen-editor').focus(); }
function zenInsertLink() { var u = prompt('URL:'); if(u) document.execCommand('createLink', false, u); document.getElementById('zen-editor').focus(); }
function zenInsertHR() { document.execCommand('insertHTML', false, '<hr>'); document.getElementById('zen-editor').focus(); }
function zenInsertCode() { var s = window.getSelection(); if(s.rangeCount) document.execCommand('insertHTML', false, '<code>' + (esc(s.toString()) || 'code') + '</code>'); }
function zenClearFormat() { document.execCommand('removeFormat', false, null); document.getElementById('zen-editor').focus(); }

function zenKeydown(e) {
  if(e.key === 'Tab') { e.preventDefault(); document.execCommand('insertHTML', false, '&nbsp;&nbsp;&nbsp;&nbsp;'); }
  if((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); zenSaveVersion(); }
}

function zenSaveVersion() {
  zenSnapshot();
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d) return;
  if(!d.versions) d.versions = [];
  d.versions.unshift({ id: Date.now(), title: d.title, body: d.body, words: countW(d.body), date: new Date().toISOString() });
  if(d.versions.length > 50) d.versions = d.versions.slice(0, 50);
  save();
  toast('Version saved');
  document.getElementById('zen-saved').textContent = 'Version saved';
  document.getElementById('zen-saved').style.color = 'var(--accent)';
}

function zenExport(fmt) {
  var d = S.docs.find(function(x){ return x.id == zenDocId; });
  if(!d || !fmt) return;
  var t = d.title || 'untitled';
  var e = document.getElementById('zen-editor');
  if(fmt === 'clipboard') { navigator.clipboard.writeText(e.innerText); toast('Copied to clipboard'); return; }
  var c, m, x;
  if(fmt === 'txt') { c = e.innerText; m = 'text/plain'; x = 'txt'; }
  else if(fmt === 'html') {
    c = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + esc(t) + '</title><style>body{font-family:Georgia,"Times New Roman",serif;max-width:680px;margin:40px auto;padding:0 24px;line-height:1.9;color:#1a1a1a;font-size:18px}h1{font-size:32px;margin-bottom:8px}h2{font-size:24px;margin-top:32px}h3{font-size:20px}blockquote{border-left:3px solid #bbb;padding-left:16px;color:#666;font-style:italic}code{background:#f0f0f0;padding:2px 5px;border-radius:3px;font-size:15px}pre{background:#f5f5f5;padding:16px;border-radius:8px;overflow-x:auto;font-size:14px}a{color:#2563eb}</style></head><body><h1>' + esc(t) + '</h1>' + e.innerHTML + '</body></html>';
    m = 'text/html'; x = 'html';
  } else if(fmt === 'md') { c = htmlToMd(e.innerHTML, t); m = 'text/markdown'; x = 'md'; }
  var blob = new Blob([c], { type: m });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = t.replace(/[^a-z0-9]/gi, '-').toLowerCase() + '.' + x;
  a.click();
  toast('Exported .' + x);
}

// === LIVING DOCS ===
function getActiveSpec(){return S.specs.find(s=>String(s.id)===String(S.activeSpec));}
function renderSpecs(){renderSpecList();loadSpec();document.getElementById('specs-count').textContent=S.specs.length;const totalSpecW=S.specs.reduce((a,s)=>a+(s.sections||[]).reduce((b,sec)=>b+countW(sec.body),0),0);const swEl=document.getElementById('specs-word-total');if(swEl)swEl.textContent=totalSpecW.toLocaleString()+'w total';}
function renderSpecList(){const sq=(document.getElementById('spec-list-search')?.value||'').toLowerCase();const ssort=(document.getElementById('spec-list-sort')?.value)||'updated';let specList=[...S.specs];if(sq)specList=specList.filter(s=>(s.title||'').toLowerCase().includes(sq));if(ssort==='alpha')specList.sort((a,b)=>(a.title||'').localeCompare(b.title||''));else if(ssort==='words')specList.sort((a,b)=>(b.sections||[]).reduce((x,sec)=>x+countW(sec.body),0)-(a.sections||[]).reduce((x,sec)=>x+countW(sec.body),0));else if(ssort==='sections')specList.sort((a,b)=>(b.sections||[]).length-(a.sections||[]).length);else if(ssort==='project'){specList.sort((a,b)=>{const pa=(S.projects||[]).find(p=>p.id===a.projectId);const pb=(S.projects||[]).find(p=>p.id===b.projectId);return(pa?pa.name:'zzz').localeCompare(pb?pb.name:'zzz');});}else specList.sort((a,b)=>(new Date(b.updated||0))-(new Date(a.updated||0)));const renderSpecItem=s=>{const sc=s.sections?s.sections.length:0;const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);const dt=s.updated?new Date(s.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';const ic=s.icon||'file';const c=s.color||'#8b8b8b';const path=specSectionIcon(ic);const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;return`<div class="specs-doc-item ${String(s.id)===String(S.activeSpec)?'active':''}" onclick="switchSpec('${s.id}')"><div style="display:flex;align-items:center;gap:6px"><span style="color:${c};display:flex;flex-shrink:0"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><div class="specs-doc-title">${esc(s.title||'Untitled Spec')}</div></div><div class="specs-doc-meta"><span>${sc} sec / ${wc}w</span>${proj?`<span style="color:${proj.color||c}">${esc(proj.name)}</span>`:'<span>unassigned</span>'}<span>${dt}</span><span style="margin-left:auto;cursor:pointer;opacity:0.4;font-size:8px" onclick="event.stopPropagation();dupSpec('${s.id}')" title="Duplicate">D</span>${S.specs.length>1?`<span style="cursor:pointer;opacity:0.4" onclick="event.stopPropagation();delSpec('${s.id}')">x</span>`:''}</div></div>`;};
  const specWcGrp=wc=>{if(wc===0)return'Empty';if(wc<100)return'Short (<100w)';if(wc<500)return'Medium (100-500w)';return'Long (500w+)';};
  const specSecGrp=sc=>{if(sc<=1)return'1 section';if(sc<=3)return'2-3 sections';if(sc<=5)return'4-5 sections';return'6+ sections';};
  let specHtml='';if(ssort==='project'||ssort==='alpha'||ssort==='words'||ssort==='sections'){let lastGrp=null;specList.forEach(s=>{let grp;let clr='var(--accent)';if(ssort==='project'){const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;grp=proj?proj.name:'Unassigned';clr=proj?proj.color||'var(--accent)':'var(--text-muted)';}else if(ssort==='alpha'){grp=(s.title||'U')[0].toUpperCase();clr='var(--accent)';}else if(ssort==='words'){const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);grp=specWcGrp(wc);clr='var(--accent-cyan)';}else if(ssort==='sections'){grp=specSecGrp((s.sections||[]).length);clr='#f59e0b';}if(grp!==lastGrp){const cnt=specList.filter(x=>{if(ssort==='project'){const xp=x.projectId?(S.projects||[]).find(p=>p.id===x.projectId):null;return(xp?xp.name:'Unassigned')===grp;}if(ssort==='alpha')return(x.title||'U')[0].toUpperCase()===grp;if(ssort==='words')return specWcGrp((x.sections||[]).reduce((a,sec)=>a+countW(sec.body),0))===grp;return specSecGrp((x.sections||[]).length)===grp;}).length;specHtml+=`<div style="padding:6px 8px 3px;font-size:10px;font-weight:600;color:${clr};text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border)">${esc(grp)} <span style="font-size:8px;font-weight:400;color:var(--text-muted)">${cnt}</span></div>`;lastGrp=grp;}specHtml+=renderSpecItem(s);});}else{specHtml=specList.map(renderSpecItem).join('');}
  document.getElementById('specs-doc-list').innerHTML=specHtml;}
function loadSpec(){const s=getActiveSpec();if(!s)return;document.getElementById('specs-title').value=s.title||'';const spa=document.getElementById('spec-project-assign');if(spa){spa.innerHTML='<option value="">No Project</option>'+(S.projects||[]).map(p=>`<option value="${p.id}" ${s.projectId===p.id?'selected':''}>${esc(p.name)}</option>`).join('');}renderSpecSections();updateSpecStatus();}
function assignSpecProject(pid){const s=getActiveSpec();if(!s)return;s.projectId=pid||undefined;save();renderSpecList();toast(pid?'Assigned to project':'Removed project');}
function switchSpec(id){if(String(S.activeSpec)===String(id))return;snapshotSpec();save();S.activeSpec=id;renderSpecs();const s=S.specs.find(x=>String(x.id)===String(id));if(s)trackRecent('spec',id,s.title);save();updateBreadcrumb();}
function newSpecFromTemplate(tpl){if(!tpl)return;const templates={prd:{title:'Product Requirements',sections:['Overview','Problem Statement','Goals','User Stories','Requirements','Success Metrics','Timeline']},rfc:{title:'RFC',sections:['Summary','Motivation','Detailed Design','Drawbacks','Alternatives','Unresolved Questions']},retro:{title:'Retrospective',sections:['What Went Well','What Could Improve','Action Items','Key Metrics','Follow-ups']},checklist:{title:'Checklist',sections:['Pre-Launch','During','Post-Launch','Review']}};const t=templates[tpl];if(!t)return;snapshotSpec();const now=Date.now();const s={id:now,title:t.title,sections:t.sections.map((title,i)=>({id:'sec_'+(now+i+1),title,body:'',collapsed:false})),created:new Date().toISOString(),updated:new Date().toISOString()};if(activeProject)s.projectId=activeProject;S.specs.unshift(s);S.activeSpec=s.id;save();renderSpecs();toast('Created: '+t.title);}
function newSpec(){snapshotSpec();const s={id:Date.now(),title:'',sections:[{id:Date.now()+1,title:'Overview',body:'',collapsed:false}],created:new Date().toISOString(),updated:new Date().toISOString()};S.specs.unshift(s);S.activeSpec=s.id;save();renderSpecs();document.getElementById('specs-title').focus();}
function delSpec(id){if(S.specs.length<=1){toast('Cannot delete last spec');return;}S.specs=S.specs.filter(s=>String(s.id)!==String(id));if(String(S.activeSpec)===String(id))S.activeSpec=S.specs[0].id;save();renderSpecs();toast('Deleted');}
function dupSpec(id){const s=S.specs.find(x=>String(x.id)===String(id));if(!s)return;const dup={...JSON.parse(JSON.stringify(s)),id:Date.now(),title:(s.title||'Spec')+' (copy)',created:new Date().toISOString(),updated:new Date().toISOString()};dup.sections=dup.sections.map(sec=>({...sec,id:'sec_'+Date.now()+Math.random()*1000}));S.specs.unshift(dup);S.activeSpec=dup.id;save();renderSpecs();toast('Duplicated: '+dup.title.substring(0,30));}
function snapshotSpec(){const s=getActiveSpec();if(!s)return;const t=document.getElementById('specs-title');if(t)s.title=t.value;if(!s.sections)s.sections=[];s.sections.forEach(sec=>{const el=document.getElementById('spec-editor-'+sec.id);if(el)sec.body=el.innerHTML;const tEl=document.getElementById('spec-title-'+sec.id);if(tEl)sec.title=tEl.value;});s.updated=new Date().toISOString();}
function specSectionIcon(name){const m={palette:'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z',cpu:'M18 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2z',layers:'M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5',alert:'M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01',flag:'M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1zM4 22v-7',link:'M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71',file:'M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z',globe:'M12 2a10 10 0 100 20 10 10 0 000-20z',lock:'M19 11H5a2 2 0 00-2 2v7a2 2 0 002 2h14a2 2 0 002-2v-7a2 2 0 00-2-2zM7 11V7a5 5 0 0110 0v4',refresh:'M23 4v6h-6M1 20v-6h6',users:'M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2',list:'M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01',mail:'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z',hdd:'M22 12H2M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z',rocket:'M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 00-2.91-.09zM12 15l-3-3M22 2l-7.5 7.5',book:'M4 19.5A2.5 2.5 0 016.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z',heart:'M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z',target:'M12 22a10 10 0 100-20 10 10 0 000 20zM12 18a6 6 0 100-12 6 6 0 000 12zM12 14a2 2 0 100-4 2 2 0 000 4z',terminal:'M4 17l6-6-6-6M12 19h8',code:'M16 18l6-6-6-6M8 6l-6 6 6 6'};return m[name]||m.file;}
function renderSpecSections(){const s=getActiveSpec();if(!s)return;const el=document.getElementById('specs-sections');const secColors=['#4ade80','#22d3ee','#8b5cf6','#f59e0b','#ef4444','#a78bfa','#06b6d4','#ec4899'];el.innerHTML=(s.sections||[]).map((sec,i)=>{const c=sec.color||secColors[i%secColors.length];const ic=sec.icon||'file';const path=specSectionIcon(ic);return`<div class="specs-section ${sec.collapsed?'collapsed':''}" data-id="${sec.id}" draggable="true" ondragstart="specDragStart(event,'${sec.id}')" ondragover="specDragOver(event)" ondragleave="event.currentTarget.style.borderTop=''" ondrop="specDrop(event,'${sec.id}')"><div class="specs-section-header" onclick="toggleSpecSection('${sec.id}')"><span class="spec-drag-handle" style="cursor:grab;opacity:0.3;font-size:10px;padding:0 4px;display:flex;align-items:center" onmousedown="event.stopPropagation()" title="Drag to reorder">::</span><span class="specs-section-toggle">v</span><span class="spec-sec-icon" style="color:${c};flex-shrink:0;display:flex;align-items:center" onclick="event.stopPropagation();cycleSecIcon('${sec.id}')" title="Click to change icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><input type="text" class="specs-section-title" id="spec-title-${sec.id}" value="${escA(sec.title||'Section '+(i+1))}" onclick="event.stopPropagation()" oninput="onSpecChange()" style="background:transparent;border:none;color:var(--text);font-size:12px;font-weight:600;flex:1;padding:0"><div style="display:flex;gap:2px;opacity:0.4"><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);margin-right:4px">${countW(sec.body)}w</span><button class="task-action-btn" onclick="event.stopPropagation();copySpecSection('${sec.id}')" title="Copy section" style="font-size:8px">C</button><button class="task-action-btn" onclick="event.stopPropagation();moveSpecSection('${sec.id}',-1)" title="Move up" style="font-size:10px">^</button><button class="task-action-btn" onclick="event.stopPropagation();moveSpecSection('${sec.id}',1)" title="Move down" style="font-size:10px">v</button><button class="task-action-btn del" onclick="event.stopPropagation();delSpecSection('${sec.id}')" title="Delete">x</button></div></div><div class="specs-section-body"><div class="specs-section-editor" id="spec-editor-${sec.id}" contenteditable="true" oninput="onSpecChange()">${sec.body||''}</div></div></div>`;}).join('')+`<div class="specs-add-section" onclick="addSpecSection()">+ Add Section</div>`;}
function addSpecSection(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.push({id:'sec_'+Date.now(),title:'New Section',body:'',collapsed:false});save();renderSpecSections();}
function delSpecSection(id){const s=getActiveSpec();if(!s||s.sections.length<=1)return;snapshotSpec();s.sections=s.sections.filter(x=>String(x.id)!==String(id));save();renderSpecSections();}
function copySpecSection(id){const s=getActiveSpec();if(!s)return;snapshotSpec();const sec=s.sections.find(x=>String(x.id)===String(id));if(!sec)return;const d=document.createElement('div');d.innerHTML=sec.body||'';const text='## '+(sec.title||'Section')+'\n\n'+(d.innerText||'');navigator.clipboard.writeText(text).then(()=>toast('Section copied'));}
function toggleSpecSection(id){const s=getActiveSpec();if(!s)return;const sec=s.sections.find(x=>String(x.id)===String(id));if(sec){sec.collapsed=!sec.collapsed;renderSpecSections();}}
function moveSpecSection(id,dir){const s=getActiveSpec();if(!s)return;snapshotSpec();const i=s.sections.findIndex(x=>String(x.id)===String(id));const ni=i+dir;if(ni<0||ni>=s.sections.length)return;[s.sections[i],s.sections[ni]]=[s.sections[ni],s.sections[i]];save();renderSpecSections();}
let specDragSectionId=null;
function specDragStart(e,id){specDragSectionId=id;e.dataTransfer.effectAllowed='move';}
function specDragOver(e){e.preventDefault();e.currentTarget.style.borderTop='2px solid var(--accent)';}
function specDrop(e,targetId){e.preventDefault();e.currentTarget.style.borderTop='';if(!specDragSectionId||specDragSectionId===targetId)return;const s=getActiveSpec();if(!s)return;snapshotSpec();const fi=s.sections.findIndex(x=>String(x.id)===specDragSectionId);const ti=s.sections.findIndex(x=>String(x.id)===targetId);if(fi<0||ti<0)return;const[item]=s.sections.splice(fi,1);s.sections.splice(ti,0,item);specDragSectionId=null;save();renderSpecSections();}
const specIconList=['file','palette','cpu','layers','alert','flag','link','globe','lock','refresh','users','list','mail','hdd','rocket','book','heart','target','terminal','code'];
const specColorList=['#4ade80','#22d3ee','#8b5cf6','#f59e0b','#ef4444','#a78bfa','#06b6d4','#ec4899','#facc15','#fb923c'];
function cycleSecIcon(id){const s=getActiveSpec();if(!s)return;const sec=s.sections.find(x=>String(x.id)===String(id));if(!sec)return;const cur=specIconList.indexOf(sec.icon||'file');sec.icon=specIconList[(cur+1)%specIconList.length];const ci=specColorList.indexOf(sec.color||'#8b8b8b');sec.color=specColorList[(ci+1)%specColorList.length];save();renderSpecSections();}
function collapseAllSections(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.forEach(x=>x.collapsed=true);save();renderSpecSections();}
function expandAllSections(){const s=getActiveSpec();if(!s)return;snapshotSpec();s.sections.forEach(x=>x.collapsed=false);save();renderSpecSections();}
function specSearch(){const q=(document.getElementById('spec-search')?.value||'').toLowerCase();const s=getActiveSpec();if(!s)return;if(!q){s.sections.forEach(x=>x.collapsed=false);renderSpecSections();return;}s.sections.forEach(sec=>{const title=(sec.title||'').toLowerCase();const d=document.createElement('div');d.innerHTML=sec.body||'';const body=(d.innerText||'').toLowerCase();sec.collapsed=!(title.includes(q)||body.includes(q));});renderSpecSections();}
function onSpecChange(){clearTimeout(specTimer);document.getElementById('specs-status').textContent='Unsaved';document.getElementById('specs-status').style.color='var(--yellow)';specTimer=setTimeout(()=>{snapshotSpec();save();renderSpecList();document.getElementById('specs-status').textContent='Saved';document.getElementById('specs-status').style.color='var(--green)';updateSpecStatus();},1000);}
function updateSpecStatus(){const s=getActiveSpec();if(!s)return;let total=0;(s.sections||[]).forEach(sec=>{total+=countW(sec.body);});document.getElementById('specs-word-count').textContent=total+' words';}
function specExport(fmt){if(!fmt)return;snapshotSpec();const s=getActiveSpec();if(!s)return;const t=s.title||'spec';let c;if(fmt==='clipboard'){let txt=t+'\n'+'='.repeat(t.length)+'\n\n';(s.sections||[]).forEach(sec=>{txt+=sec.title+'\n'+'-'.repeat(sec.title.length)+'\n';const d=document.createElement('div');d.innerHTML=sec.body||'';txt+=(d.innerText||'')+'\n\n';});navigator.clipboard.writeText(txt);toast('Copied');return;}if(fmt==='md'){c='# '+t+'\n\n';(s.sections||[]).forEach(sec=>{c+='## '+sec.title+'\n\n';c+=htmlToMd(sec.body||'',null).replace(/^# .*\n\n/,'')+'\n';});}else if(fmt==='html'){c=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(t)}</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#222}h1{font-size:28px;border-bottom:2px solid #eee;padding-bottom:8px}h2{font-size:20px;margin-top:24px;color:#333}blockquote{border-left:3px solid #ccc;padding-left:16px;color:#666;font-style:italic}code{background:#f4f4f4;padding:1px 4px;border-radius:3px}</style></head><body><h1>${esc(t)}</h1>`+(s.sections||[]).map(sec=>`<h2>${esc(sec.title)}</h2>${sec.body||''}`).join('')+'</body></html>';}const blob=new Blob([c],{type:fmt==='md'?'text/markdown':'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=t.replace(/[^a-z0-9]/gi,'-').toLowerCase()+'.'+(fmt==='md'?'md':'html');a.click();toast('Exported');}

function exportAllSpecs(){
  snapshotSpec();
  let md='# Living Docs Export\nGenerated: '+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n'+S.specs.length+' specs total\n\n';
  S.specs.forEach(s=>{
    const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;
    md+='---\n\n# '+(s.title||'Untitled Spec')+(proj?' ('+proj.name+')':'')+'\n\n';
    (s.sections||[]).forEach(sec=>{
      md+='## '+(sec.title||'Section')+'\n\n';
      const d=document.createElement('div');d.innerHTML=sec.body||'';
      md+=(d.innerText||'(empty)')+'\n\n';
    });
  });
  navigator.clipboard.writeText(md).then(()=>toast('All '+S.specs.length+' specs copied as markdown'));
}
function exportAllSpecsHTML(){
  snapshotSpec();if(!S.specs.length){toast('No specs');return;}
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Living Docs - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:22px;color:#22d3ee;margin-top:32px}h3{font-size:16px;color:#fff;margin-top:16px;padding:6px 0;border-bottom:1px solid #222}hr{border:none;border-top:1px solid #222;margin:24px 0}.meta{font-size:11px;color:#888;margin-bottom:8px}.section{margin:12px 0;padding:12px;background:#101014;border-radius:8px;border-left:3px solid #22d3ee}a{color:#4ade80}</style></head><body>';
  h+='<h1>Living Docs</h1><p style="color:#888;font-size:13px">'+S.specs.length+' specs | Exported '+new Date().toLocaleDateString()+'</p>';
  S.specs.forEach(s=>{const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);h+='<hr><h2>'+esc(s.title||'Untitled')+'</h2><div class="meta">'+(proj?esc(proj.name)+' | ':'')+wc+' words | '+(s.sections||[]).length+' sections</div>';(s.sections||[]).forEach(sec=>{h+='<div class="section"><h3>'+esc(sec.title||'Section')+'</h3><div>'+(sec.body||'<em>empty</em>')+'</div></div>';});});
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-specs-'+new Date().toISOString().split('T')[0]+'.html';a.click();toast('Exported '+S.specs.length+' specs as HTML');
}
function saveSpecVersion(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  if(!s.versions)s.versions=[];
  const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);
  s.versions.unshift({id:Date.now(),title:s.title,sections:JSON.parse(JSON.stringify(s.sections||[])),words:wc,date:new Date().toISOString()});
  if(s.versions.length>20)s.versions=s.versions.slice(0,20);
  save();toast('Spec version saved ('+wc+'w, '+(s.sections||[]).length+' sections)');
}
function showSpecVersions(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  if(!s.versions||!s.versions.length){toast('No versions saved. Click v+ to save first.');return;}
  let existing=document.getElementById('spec-versions-panel');if(existing){existing.remove();return;}
  const panel=document.createElement('div');panel.id='spec-versions-panel';
  panel.style.cssText='position:fixed;right:20px;top:80px;width:260px;max-height:70vh;overflow-y:auto;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
  const curWc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);
  let html='<div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:8px;display:flex;justify-content:space-between"><span>Spec Versions ('+s.versions.length+')</span><span onclick="this.closest(\'#spec-versions-panel\').remove()" style="cursor:pointer;font-size:12px;color:var(--text-muted)">x</span></div>';
  s.versions.forEach((v,i)=>{
    const diff=v.words-curWc;const diffStr=diff>0?'+'+diff:diff<0?''+diff:'=';
    html+=`<div style="padding:8px;margin-bottom:4px;background:var(--bg-secondary);border-radius:4px;border:1px solid var(--border)"><div style="font-size:10px;font-weight:600;color:var(--text)">${esc(v.title||'Untitled')}</div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">${timeAgo(v.date)} | ${v.words}w | ${v.sections.length} secs <span style="color:${diff>0?'var(--green)':diff<0?'var(--red)':'var(--text-muted)'}">${diffStr}w</span></div><div style="display:flex;gap:4px;margin-top:4px"><button class="btn btn-sm btn-ghost" onclick="restoreSpecVersion(${i})" style="font-size:8px;padding:1px 5px">Restore</button><button class="btn btn-sm btn-ghost btn-danger" onclick="deleteSpecVersion(${i})" style="font-size:8px;padding:1px 5px">Del</button></div></div>`;
  });
  panel.innerHTML=html;document.body.appendChild(panel);
}
function restoreSpecVersion(i){
  const s=getActiveSpec();if(!s||!s.versions||!s.versions[i])return;
  if(!confirm('Restore this version? Current content will be overwritten.'))return;
  const v=s.versions[i];s.title=v.title;s.sections=JSON.parse(JSON.stringify(v.sections));s.updated=new Date().toISOString();
  save();renderSpecDetail(s);const p=document.getElementById('spec-versions-panel');if(p)p.remove();toast('Restored version from '+timeAgo(v.date));
}
function deleteSpecVersion(i){
  const s=getActiveSpec();if(!s||!s.versions)return;
  s.versions.splice(i,1);save();const p=document.getElementById('spec-versions-panel');if(p)p.remove();showSpecVersions();toast('Version deleted');
}
function exportCurrentSpec(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  const wc=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;
  let h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+esc(s.title||'Spec')+' - Saturno Hub</title><style>body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 20px;line-height:1.8;color:#e0e0e0;background:#0a0a0e}h1{font-size:28px;color:#4ade80;border-bottom:2px solid #4ade80;padding-bottom:8px}h2{font-size:18px;color:#fff;margin-top:20px;padding:6px 0;border-bottom:1px solid #222}.meta{font-size:11px;color:#888;margin-bottom:16px}.section{margin:12px 0;padding:12px;background:#101014;border-radius:8px;border-left:3px solid #22d3ee}a{color:#4ade80}</style></head><body>';
  h+='<h1>'+esc(s.title||'Untitled Spec')+'</h1><div class="meta">'+(proj?esc(proj.name)+' | ':'')+wc+' words | '+(s.sections||[]).length+' sections | Exported '+new Date().toLocaleDateString()+'</div>';
  (s.sections||[]).forEach(sec=>{h+='<div class="section"><h2>'+esc(sec.title||'Section')+'</h2><div>'+(sec.body||'<em>empty</em>')+'</div></div>';});
  h+='</body></html>';const blob=new Blob([h],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=((s.title||'spec').toLowerCase().replace(/\s+/g,'-'))+'.html';a.click();toast('Exported: '+s.title);
}
function exportCurrentSpecText(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  let txt=(s.title||'Untitled Spec').toUpperCase()+'\n\n';
  (s.sections||[]).forEach(sec=>{txt+=(sec.title||'Section').toUpperCase()+'\n';const d=document.createElement('div');d.innerHTML=sec.body||'';txt+=(d.innerText||'(empty)')+'\n\n';});
  navigator.clipboard.writeText(txt).then(()=>toast('Copied as text: '+s.title));
}
function exportCurrentSpecMD(){
  snapshotSpec();const s=getActiveSpec();if(!s){toast('No spec selected');return;}
  const proj=s.projectId?(S.projects||[]).find(p=>p.id===s.projectId):null;
  let md='# '+(s.title||'Untitled Spec')+'\n\n';
  if(proj)md+='Project: '+proj.name+'\n';
  md+='Sections: '+(s.sections||[]).length+' | Exported: '+new Date().toLocaleDateString()+'\n\n---\n\n';
  (s.sections||[]).forEach(sec=>{md+='## '+(sec.title||'Section')+'\n\n';const d=document.createElement('div');d.innerHTML=sec.body||'';md+=(d.innerText||'(empty)')+'\n\n';});
  navigator.clipboard.writeText(md).then(()=>toast('Copied as Markdown: '+s.title));
}
function specImportMarkdown(){
  const md=prompt('Paste Markdown text to create a new spec.\nUse ## headings to define sections:');
  if(!md||!md.trim())return;
  const lines=md.split('\n');let title='Imported Spec';const sections=[];let curTitle='';let curBody=[];
  lines.forEach(line=>{
    const h1=line.match(/^#\s+(.+)/);const h2=line.match(/^##\s+(.+)/);
    if(h1&&!sections.length&&curBody.length===0){title=h1[1].trim();return;}
    if(h2){if(curTitle||curBody.length){sections.push({id:Date.now()+Math.random(),title:curTitle||'Section',body:'<p>'+curBody.join('</p><p>')+'</p>',icon:'doc',color:'#4ade80'});}curTitle=h2[1].trim();curBody=[];return;}
    if(line.trim())curBody.push(esc(line));
  });
  if(curTitle||curBody.length){sections.push({id:Date.now()+Math.random(),title:curTitle||'Section',body:'<p>'+curBody.join('</p><p>')+'</p>',icon:'doc',color:'#4ade80'});}
  if(!sections.length){toast('No sections found (use ## headings)');return;}
  const projId=activeProject||(S.projects[0]&&S.projects[0].id)||null;
  const spec={id:'spec_'+Date.now(),title:title,projectId:projId,sections:sections,versions:[],created:new Date().toISOString(),updated:new Date().toISOString()};
  S.specs.push(spec);save();switchSpec(spec.id);toast('Imported: '+title+' ('+sections.length+' sections)');
}

// === LINKS ===
function renderLinks(){
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  document.getElementById('link-category-tabs').innerHTML=`<button class="tab-btn ${linkCategory==='all'?'active':''}" onclick="setLinkCat('all',this)">All <span style="font-size:8px;opacity:0.6">${S.links.length}</span></button>`+cats.map(c=>{const cnt=S.links.filter(l=>l.category===c).length;return `<button class="tab-btn ${linkCategory===c?'active':''}" onclick="setLinkCat('${escA(c)}',this)">${esc(c)} <span style="font-size:8px;opacity:0.6">${cnt}</span></button>`;}).join('');
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc+' '+(l.tags||[]).join(' ')).toLowerCase().includes(q));
  const ls=(document.getElementById('link-sort')?.value)||'newest';
  if(ls==='newest')items.sort((a,b)=>new Date(b.created||0)-new Date(a.created||0));
  else if(ls==='oldest')items.sort((a,b)=>new Date(a.created||0)-new Date(b.created||0));
  else if(ls==='alpha')items.sort((a,b)=>(a.title||'').localeCompare(b.title||''));
  else if(ls==='category')items.sort((a,b)=>(a.category||'zzz').localeCompare(b.category||'zzz'));
  else if(ls==='domain')items.sort((a,b)=>{try{return new URL(a.url).hostname.localeCompare(new URL(b.url).hostname);}catch(e){return 0;}});
  else if(ls==='tag')items.sort((a,b)=>((a.tags&&a.tags[0])||'zzz').localeCompare((b.tags&&b.tags[0])||'zzz'));
  items.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));
  const g=document.getElementById('links-grid');
  const renderLinkCard=l=>{let domain='';try{domain=new URL(l.url).hostname;}catch(e){}return`<div class="link-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain',JSON.stringify({type:'links',id:${l.id}}))" onclick="window.open('${escA(l.url)}','_blank')" ${l.pinned?'style="border-color:rgba(74,222,128,0.2)"':''}>${l.pinned?'<div style="font-size:7px;color:var(--accent);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:2px">Pinned</div>':''}<div style="display:flex;align-items:center;gap:8px">${domain?`<img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" width="16" height="16" style="border-radius:2px;flex-shrink:0" onerror="this.style.display='none'">`:''}<div class="link-card-title" style="margin:0">${esc(l.title)}</div>${l._status?`<span style="width:6px;height:6px;border-radius:50%;background:${l._status==='ok'?'var(--accent)':'var(--red)'};flex-shrink:0" title="${l._status==='ok'?'Link OK':'Link may be broken'}"></span>`:''}</div><div class="link-card-url">${esc(l.url)}</div>${l.desc?`<div class="link-card-desc">${parseWikiLinks(esc(l.desc))}</div>`:''}<div class="link-card-footer">${l.category?`<span class="badge badge-blue" style="cursor:pointer" onclick="event.stopPropagation();setLinkCat('${escA(l.category)}',null)">${esc(l.category)}</span>`:''}${l.projectId?(()=>{const p=(S.projects||[]).find(x=>x.id===l.projectId);return p?`<span class="badge badge-muted" style="font-size:7px">${esc(p.name)}</span>`:''})():''}${(l.tags&&l.tags.length)?l.tags.map(tag=>`<span style="font-size:7px;padding:0 3px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:2px;color:var(--text-muted);font-family:var(--mono)">${esc(tag)}</span>`).join(''):''}${l.created?`<span style="font-size:8px;color:var(--text-muted)" title="${new Date(l.created).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}">${timeAgo(l.created)}</span>`:''}<div class="link-card-actions"><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();pinLink(${l.id})" style="${l.pinned?'color:var(--accent)':''}">${l.pinned?'Unpin':'Pin'}</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('${escA(l.url)}')">Copy</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('[${escA(l.title)}](${escA(l.url)})');toast('Markdown link copied')">MD</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();toggleLinkReadLater(${l.id})" style="${l.readLater?'color:var(--accent-cyan)':''}">${l.readLater?'Unlist':'RL'}</button><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();openLinkModal(${l.id})">Edit</button><button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();delLink(${l.id})">Del</button></div></div></div>`;};
  // Make link category clickable in renderLinkCard — already handled via setLinkCat
  const linkDateGrp=d=>{if(!d)return'Unknown';const diff=Math.floor((new Date()-new Date(d))/86400000);if(diff<1)return'Today';if(diff<7)return'This Week';if(diff<30)return'This Month';return'Older';};
  let linksHtml='';if(ls==='domain'||ls==='category'||ls==='newest'||ls==='oldest'||ls==='alpha'||ls==='tag'){let lastGrp=null;items.forEach(l=>{let grp;if(ls==='domain'){try{grp=new URL(l.url).hostname;}catch(e){grp='unknown';}}else if(ls==='category'){grp=l.category||'Uncategorized';}else if(ls==='tag'){grp=(l.tags&&l.tags[0])||'Untagged';}else if(ls==='alpha'){grp=(l.title||'Untitled')[0].toUpperCase();}else{grp=linkDateGrp(l.created);}if(grp!==lastGrp){const cnt=items.filter(x=>{if(ls==='domain'){try{return new URL(x.url).hostname===grp;}catch(e){return false;}}if(ls==='category')return(x.category||'Uncategorized')===grp;if(ls==='tag')return((x.tags&&x.tags[0])||'Untagged')===grp;if(ls==='alpha')return(x.title||'Untitled')[0].toUpperCase()===grp;return linkDateGrp(x.created)===grp;}).length;const clr=ls==='tag'?'#f59e0b':(ls==='newest'||ls==='oldest')?'var(--yellow)':ls==='alpha'?'var(--accent)':'var(--accent-cyan)';linksHtml+=`<div style="grid-column:1/-1;padding:8px 4px 4px;font-size:11px;font-weight:600;color:${clr};border-bottom:1px solid var(--border);margin-bottom:2px;letter-spacing:0.03em">${esc(grp)} <span style="font-size:9px;color:var(--text-muted);font-weight:400">${cnt}</span></div>`;lastGrp=grp;}linksHtml+=renderLinkCard(l);});}else{linksHtml=items.map(renderLinkCard).join('');}
  g.innerHTML=!items.length?`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">L</div><div style="font-size:12px">${q?'No matching links':'No links saved'}</div><div style="font-size:10px;margin-top:4px">${q?'Try a different search':'Click + Add to save bookmarks and resources'}</div></div>`:linksHtml;
  document.getElementById('links-count').textContent=S.links.length;
}
function setLinkCat(c,el){linkCategory=c;document.querySelectorAll('#link-category-tabs .tab-btn').forEach(b=>b.classList.remove('active'));if(el)el.classList.add('active');renderLinks();}
function openLinkModal(id){editingLinkId=id||null;document.getElementById('link-modal-title').textContent=id?'Edit Link':'Add Link';const projSel=document.getElementById('lm-project');projSel.innerHTML='<option value="">None</option>'+(S.projects||[]).map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');if(!id){navigator.clipboard.readText().then(clip=>{if(clip&&(clip.startsWith('http://')||clip.startsWith('https://'))&&!document.getElementById('lm-url').value){document.getElementById('lm-url').value=clip;suggestLinkTitle();toast('URL pasted from clipboard');}}).catch(()=>{});}
  // Category datalist
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  let cdl=document.getElementById('link-cat-dl');if(!cdl){cdl=document.createElement('datalist');cdl.id='link-cat-dl';document.body.appendChild(cdl);}
  cdl.innerHTML=cats.map(c=>`<option value="${esc(c)}">`).join('');
  document.getElementById('lm-category').setAttribute('list','link-cat-dl');if(id){const l=S.links.find(x=>x.id===id);if(l){document.getElementById('lm-title').value=l.title;document.getElementById('lm-url').value=l.url;document.getElementById('lm-category').value=l.category||'';document.getElementById('lm-desc').value=l.desc||'';document.getElementById('lm-tags').value=(l.tags||[]).join(', ');projSel.value=l.projectId||'';}}else{document.getElementById('lm-title').value='';document.getElementById('lm-url').value='';document.getElementById('lm-category').value='';document.getElementById('lm-desc').value='';document.getElementById('lm-tags').value='';projSel.value=activeProject||'';}document.getElementById('link-modal').classList.add('open');setTimeout(()=>document.getElementById('lm-title').focus(),100);}
function closeLinkModal(){document.getElementById('link-modal').classList.remove('open');editingLinkId=null;}
function saveLink(){const title=document.getElementById('lm-title').value.trim(),url=document.getElementById('lm-url').value.trim(),cat=document.getElementById('lm-category').value.trim().toLowerCase(),desc=document.getElementById('lm-desc').value.trim(),projId=document.getElementById('lm-project').value,tags=(document.getElementById('lm-tags')?.value||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);if(!title||!url){toast('Title and URL required');return;}try{new URL(url);}catch(e){toast('Invalid URL format');return;}if(!editingLinkId){const dup=S.links.find(l=>l.url===url);if(dup&&!confirm('URL already exists as "'+dup.title+'". Add anyway?'))return;}if(editingLinkId){const l=S.links.find(x=>x.id===editingLinkId);if(l){l.title=title;l.url=url;l.category=cat;l.desc=desc;l.tags=tags;l.projectId=projId||undefined;}}else{const link={id:Date.now(),title,url,category:cat,desc,tags,created:new Date().toISOString()};if(projId)link.projectId=projId;else if(activeProject)link.projectId=activeProject;S.links.push(link);}save();closeLinkModal();renderLinks();if(activeProject)renderProjLinks();toast(editingLinkId?'Updated':'Added');}
function suggestLinkTitle(){
  const urlEl=document.getElementById('lm-url'),titleEl=document.getElementById('lm-title');
  if(!urlEl||!titleEl||titleEl.value.trim())return;
  const url=urlEl.value.trim();if(!url)return;
  try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'');const path=u.pathname.replace(/^\//,'').replace(/\/$/, '').split('/').filter(Boolean);
  let title=host;
  if(path.length)title=path[path.length-1].replace(/[-_]/g,' ').replace(/\.\w+$/,'');
  titleEl.value=title.charAt(0).toUpperCase()+title.slice(1);
  }catch(e){}
}
function suggestLinkCategory(){
  const urlEl=document.getElementById('lm-url'),catEl=document.getElementById('lm-category');
  if(!urlEl||!catEl||catEl.value.trim())return;
  const url=urlEl.value.trim();if(!url)return;
  try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'').toLowerCase();
  const map={'github.com':'development','gitlab.com':'development','stackoverflow.com':'development','npmjs.com':'development','codepen.io':'development','dev.to':'development','medium.com':'articles','substack.com':'articles','blog':'articles','notion.so':'tools','figma.com':'design','dribbble.com':'design','behance.net':'design','youtube.com':'video','vimeo.com':'video','twitch.tv':'video','twitter.com':'social','x.com':'social','linkedin.com':'social','instagram.com':'social','facebook.com':'social','reddit.com':'social','docs.google.com':'docs','drive.google.com':'docs','dropbox.com':'docs','vercel.com':'hosting','netlify.com':'hosting','heroku.com':'hosting','aws.amazon.com':'cloud','cloud.google.com':'cloud','azure.microsoft.com':'cloud','openai.com':'ai','anthropic.com':'ai','huggingface.co':'ai'};
  let cat='';for(const[domain,c]of Object.entries(map)){if(host.includes(domain)){cat=c;break;}}
  if(!cat){const ext=host.split('.').pop();if(ext==='io'||ext==='dev')cat='development';else if(ext==='ai')cat='ai';}
  if(cat)catEl.value=cat;
  }catch(e){}
}
async function fetchLinkTitle(){
  const urlEl=document.getElementById('lm-url'),titleEl=document.getElementById('lm-title');
  const url=urlEl?.value.trim();if(!url)return;
  try{new URL(url);}catch(e){toast('Invalid URL');return;}
  titleEl.value='Fetching...';
  try{
    const resp=await fetch('https://api.allorigins.win/get?url='+encodeURIComponent(url),{signal:AbortSignal.timeout(5000)});
    const data=await resp.json();
    const match=(data.contents||'').match(/<title[^>]*>([^<]+)<\/title>/i);
    if(match&&match[1]){titleEl.value=match[1].trim().substring(0,120);toast('Title fetched');}
    else{suggestLinkTitle();toast('No title found, using URL-based name');}
  }catch(e){suggestLinkTitle();toast('Fetch failed, using URL-based name');}
}
function batchImportLinks(){
  const text=prompt('Paste URLs (one per line):');if(!text)return;
  const urls=text.split('\n').map(u=>u.trim()).filter(u=>{try{new URL(u);return true;}catch(e){return false;}});
  if(!urls.length){toast('No valid URLs found');return;}
  urls.forEach(url=>{try{const u=new URL(url);const host=u.hostname.replace(/^www\./,'');const path=u.pathname.replace(/^\//,'').replace(/\/$/,'').split('/').filter(Boolean);let title=host;if(path.length)title=path[path.length-1].replace(/[-_]/g,' ').replace(/\.\w+$/,'');title=title.charAt(0).toUpperCase()+title.slice(1);S.links.push({id:Date.now()+Math.random()*1000,title,url,category:'imported',desc:'',created:new Date().toISOString()});}catch(e){}});
  save();renderLinks();toast('Imported '+urls.length+' links');
}
let lastDeletedLink=null;
function delLink(id){const l=S.links.find(x=>x.id===id);if(l)lastDeletedLink={...l};S.links=S.links.filter(l=>l.id!==id);save();renderLinks();toast('Deleted — Cmd+Z to undo');}
function undoDeleteLink(){if(!lastDeletedLink)return;S.links.unshift(lastDeletedLink);lastDeletedLink=null;save();renderLinks();toast('Link restored');}
function pinLink(id){const l=S.links.find(x=>x.id===id);if(l){l.pinned=!l.pinned;save();renderLinks();toast(l.pinned?'Pinned':'Unpinned');}}
function toggleLinkReadLater(id){const l=S.links.find(x=>x.id===id);if(l){l.readLater=!l.readLater;save();renderLinks();toast(l.readLater?'Added to reading list':'Removed from reading list');}}
function openFilteredLinks(){
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc+' '+(l.tags||[]).join(' ')).toLowerCase().includes(q));
  const urls=items.filter(l=>l.url).slice(0,10);
  if(!urls.length){toast('No links to open');return;}
  if(urls.length>5&&!confirm('Open '+urls.length+' links in new tabs?'))return;
  urls.forEach(l=>window.open(l.url,'_blank'));toast('Opened '+urls.length+' links');
}
function cpText(t){navigator.clipboard.writeText(t);toast('Copied');}
function exportLinks(){
  const cats=[...new Set(S.links.map(l=>l.category).filter(Boolean))].sort();
  let md='# Links Export\n'+S.links.length+' links | '+new Date().toLocaleDateString()+'\n\n';
  cats.forEach(c=>{md+='## '+c+'\n';S.links.filter(l=>l.category===c).forEach(l=>{md+='- ['+l.title+']('+l.url+')'+(l.desc?' — '+l.desc:'')+'\n';});md+='\n';});
  const uncategorized=S.links.filter(l=>!l.category);
  if(uncategorized.length){md+='## Other\n';uncategorized.forEach(l=>{md+='- ['+l.title+']('+l.url+')'+(l.desc?' — '+l.desc:'')+'\n';});md+='\n';}
  navigator.clipboard.writeText(md).then(()=>toast('Links exported to clipboard'));
}
function copyAllLinkURLs(){
  const q=(document.getElementById('link-search')?.value||'').toLowerCase();
  let items=[...S.links];if(linkCategory!=='all')items=items.filter(l=>l.category===linkCategory);if(q)items=items.filter(l=>(l.title+' '+l.url+' '+l.desc+' '+(l.tags||[]).join(' ')).toLowerCase().includes(q));
  if(!items.length){toast('No links to copy');return;}
  const urls=items.map(l=>l.url).join('\n');
  navigator.clipboard.writeText(urls).then(()=>toast('Copied '+items.length+' URLs'));
}

function manageLinkTags(){
  const allTags=[...new Set(S.links.flatMap(l=>l.tags||[]).filter(Boolean))].sort();
  if(!allTags.length){toast('No tags found on links');return;}
  const tagCounts={};allTags.forEach(t=>{tagCounts[t]=S.links.filter(l=>(l.tags||[]).includes(t)).length;});
  const action=prompt('Link Tags ('+allTags.length+'):\n\n'+allTags.map(t=>t+' ('+tagCounts[t]+')').join('\n')+'\n\nActions:\n- rename:old:new\n- delete:tagname\n- merge:tag1:tag2 (merges tag1 INTO tag2)\n\nOr click Cancel to close:');
  if(!action)return;
  if(action.startsWith('rename:')){const parts=action.split(':');if(parts.length===3){const old=parts[1].trim(),nw=parts[2].trim();let count=0;S.links.forEach(l=>{if(l.tags){const i=l.tags.indexOf(old);if(i>=0){l.tags[i]=nw;count++;}}});save();renderLinks();toast('Renamed "'+old+'" to "'+nw+'" in '+count+' links');}}
  else if(action.startsWith('delete:')){const tag=action.substring(7).trim();let count=0;S.links.forEach(l=>{if(l.tags){const i=l.tags.indexOf(tag);if(i>=0){l.tags.splice(i,1);count++;}}});save();renderLinks();toast('Removed "'+tag+'" from '+count+' links');}
  else if(action.startsWith('merge:')){const parts=action.split(':');if(parts.length===3){const from=parts[1].trim(),to=parts[2].trim();let count=0;S.links.forEach(l=>{if(l.tags){const i=l.tags.indexOf(from);if(i>=0){l.tags[i]=to;l.tags=[...new Set(l.tags)];count++;}}});save();renderLinks();toast('Merged "'+from+'" into "'+to+'" ('+count+' links)');}}
}
async function checkAllLinks(){
  const btn=document.getElementById('link-check-btn');if(btn)btn.textContent='Checking...';
  let ok=0,fail=0,skip=0;
  for(const l of S.links){
    try{
      const r=await fetch(l.url,{method:'HEAD',mode:'no-cors',signal:AbortSignal.timeout(5000)});
      l._status='ok';ok++;
    }catch(e){
      if(l.url.startsWith('http')){l._status='error';fail++;}else{l._status='skip';skip++;}
    }
  }
  if(btn)btn.textContent='Check';
  renderLinks();toast(ok+' OK, '+fail+' broken'+(skip?', '+skip+' skipped':''));
}

// === PROJECTS ===
let activeProject = null;
let activeProjTab = 'instructions';
let editingProjectId = null;
let editingKBId = null;
let kbModalTab = 'text';
let kbImageData = null;

const ICON_SVGS = {
  rocket:'<path d="M4.5 16.5c-1.5 1.37-3 4.5-3 4.5s3.13-1.5 4.5-3c.78-.78.78-2.04 0-2.83s-2.04-.78-2.83 0z"/><path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/>',
  code:'<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>',
  book:'<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>',
  music:'<path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>',
  globe:'<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
  atom:'<circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5z"/>',
  target:'<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
  heart:'<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
  star:'<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
  flag:'<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>',
  lightning:'<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
  fire:'<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.07-2.14 0-5.5 3.5-7.5-2.5 5 1.5 5 3 7.5 2 3.5 1 6-2 8-1.5 1-4.5 1-6-1"/>',
  terminal:'<polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>',
  database:'<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>',
  server:'<rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>',
  cpu:'<rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/>',
  cloud:'<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>',
  pen:'<path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/>',
  palette:'<circle cx="13.5" cy="6.5" r="1.5"/><circle cx="17.5" cy="10.5" r="1.5"/><circle cx="8.5" cy="7.5" r="1.5"/><circle cx="6.5" cy="12" r="1.5"/><path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10c.97 0 1.76-.79 1.76-1.76 0-.47-.18-.89-.48-1.21-.3-.31-.48-.74-.48-1.21 0-.97.79-1.76 1.76-1.76H16c3.31 0 6-2.69 6-6 0-5.17-4.49-8.06-10-8.06z"/>',
  camera:'<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>',
  video:'<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>',
  mic:'<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>',
  headphones:'<path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>',
  layers:'<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
  brain:'<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44A2.5 2.5 0 0 1 5.5 17c-1.56 0-3-1.28-3-3 0-1.16.6-2.13 1.46-2.7A2.5 2.5 0 0 1 5.5 7a2.5 2.5 0 0 1 4-2z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44A2.5 2.5 0 0 0 18.5 17c1.56 0 3-1.28 3-3 0-1.16-.6-2.13-1.46-2.7A2.5 2.5 0 0 0 18.5 7a2.5 2.5 0 0 0-4-2z"/>',
  flask:'<path d="M9 3h6"/><path d="M10 3v7.4a2 2 0 0 1-.5 1.3L4 18.6A2 2 0 0 0 5.5 22h13a2 2 0 0 0 1.5-3.4L14.5 11.7a2 2 0 0 1-.5-1.3V3"/>',
  telescope:'<path d="M10.065 12.493l-6.18 1.318a.934.934 0 0 1-1.108-.702l-.537-2.15a1.07 1.07 0 0 1 .691-1.265l13.504-4.44"/><path d="M13.56 11.747l4.332-.924"/><path d="M16 21l-3.105-6.21"/><path d="M16.485 5.94a2 2 0 0 1 1.455-2.425l1.09-.272a1 1 0 0 1 1.212.727l1.515 6.06a1 1 0 0 1-.727 1.213l-1.09.272a2 2 0 0 1-2.425-1.455z"/><path d="M6.158 8.633l1.114 4.456"/>',
  map:'<polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/>',
  compass:'<circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>',
  tools:'<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',
  wrench:'<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',
  key:'<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>',
  lock:'<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
  shield:'<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
  crown:'<path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7z"/><path d="M5 16h14"/>',
  diamond:'<rect x="12" y="1" width="15.56" height="15.56" rx="2.41" transform="rotate(45 12 12)" style="stroke-width:1.5"/>',
  sun:'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',
  moon:'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>',
  mountain:'<path d="M8 3l4 8 5-5 5 15H2z"/>',
  leaf:'<path d="M11 20A7 7 0 0 1 9.8 6.9C15.5 4.9 17 3.5 19 2c1 2 2 4.5 2 8 0 5.5-4.78 10-10 10z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>',
  mail:'<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>',
  phone:'<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>',
  bell:'<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>',
  megaphone:'<path d="M3 11l18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/>',
  chart:'<line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/>',
  trending:'<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
  dollar:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
  briefcase:'<rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>',
  building:'<rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><line x1="8" y1="6" x2="8" y2="6.01"/><line x1="16" y1="6" x2="16" y2="6.01"/><line x1="12" y1="6" x2="12" y2="6.01"/><line x1="8" y1="10" x2="8" y2="10.01"/><line x1="16" y1="10" x2="16" y2="10.01"/><line x1="12" y1="10" x2="12" y2="10.01"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="16" y1="14" x2="16" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/>',
  user:'<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
  users:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
  eye:'<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>',
  calendar:'<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>',
  clock:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
  folder:'<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>',
  file:'<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>',
  grid:'<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>',
  list:'<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>',
  archive:'<polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/>',
  activity:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',
  zap:'<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
  anchor:'<circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/>',
  feather:'<path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/>',
  gift:'<polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>',
  message:'<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>',
  git:'<circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><line x1="6" y1="9" x2="6" y2="21"/>',
  wifi:'<path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>',
  crosshair:'<circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/>',
  hammer:'<path d="M15 12l-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15L22 10.64"/><path d="M20.91 11.7l-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V6.5L14.5 2.25 12 4.75l1.5 1.5L9 12"/>',
  tree:'<path d="M12 22v-7"/><path d="M5 12H2l10-10 10 10h-3"/><path d="M8 18H2l10-8 10 8h-6"/>',
};
const ICON_KEYS = Object.keys(ICON_SVGS);

function getIconSVG(key, size) {
  const s = size || 16;
  const d = ICON_SVGS[key] || ICON_SVGS.folder;
  return `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${d}</svg>`;
}

// Project CRUD
function getProjects() { return S.projects || []; }
function getProject(id) { return (S.projects||[]).find(p=>p.id===id); }
function getKBItems(projectId) { return (S.knowledgeBase||[]).filter(k=>k.projectId===projectId); }

function renderProjectsSidebar() {
  const el = document.getElementById('sidebar-projects');
  const projects = getProjects();
  el.innerHTML = projects.map(p => {
    const statusClass = p.status === 'active' ? 'active-s' : p.status === 'paused' ? 'paused-s' : 'complete-s';
    const isActive = activeProject === p.id;
    const projTasks = getProjectTasks(p.id);
    const doneTasks = projTasks.filter(t => t.status === 'done').length;
    const totalTasks = projTasks.length;
    const pct = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
    return `<div class="sidebar-project-item ${isActive?'active':''}" onclick="openProject('${p.id}')" style="${isActive?'border-left:3px solid '+p.color:'border-left:3px solid transparent'}">
      <span class="proj-icon" style="color:${p.color}">${getIconSVG(p.icon,14)}</span>
      <span class="proj-name">${esc(p.name)}</span>
      ${totalTasks>0?`<span style="font-family:var(--mono);font-size:8px;color:var(--text-muted);margin-left:auto">${pct}%</span>`:''}
      <span class="proj-status ${statusClass}"></span>
    </div>${totalTasks>0?`<div style="height:2px;background:var(--border);margin:0 12px 2px;border-radius:1px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${p.color};border-radius:1px;transition:width 0.3s"></div></div>`:''}`;

  }).join('') + `<div class="sidebar-add-project" onclick="openNewProjectModal()">+ New Project</div>`;
}

function openProject(id) {
  activeProject = id;
  activeProjTab = 'instructions';
  const p = (S.projects||[]).find(x=>x.id===id);
  if(p) trackRecent('project', id, p.name);
  const app = document.querySelector('.app');
  // Close context panel — they share the right-side grid slot
  app.classList.remove('context-open');
  app.classList.add('project-open');
  renderProjectsSidebar();
  renderProjectView();
}

function closeProjectPanel() {
  activeProject = null;
  const app = document.querySelector('.app');
  app.classList.remove('project-open');
  document.documentElement.style.setProperty('--project-width', '420px');
  renderProjectsSidebar();
}

function renderProjectView() {
  const p = getProject(activeProject);
  if (!p) return;
  document.getElementById('proj-header-icon').innerHTML = getIconSVG(p.icon, 18);
  document.getElementById('proj-header-icon').style.borderColor = p.color;
  document.getElementById('proj-header-name').textContent = p.name;
  const statusEl = document.getElementById('proj-header-status');
  statusEl.textContent = p.status;
  statusEl.className = 'badge badge-' + (p.status==='active'?'green':p.status==='paused'?'yellow':'blue');
  // Project stats
  const pTasks=S.tasks.filter(t=>t.project===p.name);
  const pTasksDone=pTasks.filter(t=>t.status==='done').length;
  const pDocs=S.specs.filter(s=>s.projectId===p.id);
  const pLinks=S.links.filter(l=>l.projectId===p.id);
  const pKB=(S.kb||[]).filter(k=>k.projectId===p.id);
  const pContent=S.content.filter(c=>(c.tags||[]).includes(p.name.toLowerCase()));
  const statsBar=document.getElementById('proj-stats-bar');
  const pPct=pTasks.length?Math.round(pTasksDone/pTasks.length*100):0;
  statsBar.innerHTML=`<span style="font-size:9px;color:var(--text-muted)" title="${pTasks.length} tasks (${pTasksDone} done)">T:${pTasksDone}/${pTasks.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pDocs.length} living docs">D:${pDocs.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pKB.length} KB items">KB:${pKB.length}</span><span style="font-size:9px;color:var(--text-muted)" title="${pLinks.length} links">L:${pLinks.length}</span><span style="display:flex;align-items:center;gap:4px" title="${pPct}% complete"><span style="width:60px;height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden;display:inline-block"><span style="display:block;height:100%;width:${pPct}%;background:${pPct>=100?'var(--accent)':pPct>=50?'#22d3ee':'var(--orange)'};border-radius:2px;transition:width 0.3s"></span></span><span style="font-size:8px;color:${pPct>=100?'var(--accent)':'var(--text-muted)'}">${pPct}%</span></span>`;
  // Apply project color to tabs
  document.documentElement.style.setProperty('--proj-accent', p.color);
  setProjTab(activeProjTab);
}

function setProjTab(tab, el) {
  activeProjTab = tab;
  document.querySelectorAll('.project-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  else document.querySelectorAll('.project-tab').forEach(t => { if(t.textContent.toLowerCase().replace(/\s/g,'-').includes(tab.replace('proj-',''))|| (tab==='instructions'&&t.textContent==='Instructions') || (tab==='docs'&&t.textContent==='Living Docs') || (tab==='kb'&&t.textContent==='Knowledge Base') || (tab==='proj-tasks'&&t.textContent==='Tasks') || (tab==='proj-links'&&t.textContent==='Links')) t.classList.add('active'); });
  document.querySelectorAll('.proj-tab-panel').forEach(p=>p.style.display='none');
  const panel = document.getElementById('proj-panel-'+tab);
  if(panel) panel.style.display = 'block';
  if(tab==='instructions') loadProjInstructions();
  if(tab==='docs') renderProjDocs();
  if(tab==='kb') renderKB();
  if(tab==='proj-tasks') renderProjTasks();
  if(tab==='proj-links') renderProjLinks();
}

// Instructions
function loadProjInstructions() {
  const p = getProject(activeProject);
  if(!p) return;
  document.getElementById('proj-instructions-editor').innerHTML = p.instructions || '';
}
let projInstrTimer = null;
function onProjInstructionsChange() {
  clearTimeout(projInstrTimer);
  projInstrTimer = setTimeout(() => {
    const p = getProject(activeProject);
    if(p) { p.instructions = document.getElementById('proj-instructions-editor').innerHTML; p.updated = new Date().toISOString(); save(); }
  }, 1000);
}

// Project Living Docs
function renderProjDocs() {
  const p = getProject(activeProject);
  if(!p) return;
  const docs = S.specs.filter(s => s.projectId === activeProject || s.global);
  const unassigned = S.specs.filter(s => !s.projectId && !s.global);
  const grid = document.getElementById('proj-docs-grid');
  let html = '';
  if(!docs.length && !unassigned.length) {
    html = '<div class="kb-empty">No living docs for this project. Click + to add one.</div>';
  } else {
    html = docs.map(d => {
      const sc = d.sections ? d.sections.length : 0;
      const dt = d.updated ? new Date(d.updated).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
      const previewSec = d.sections && d.sections.find(s=>s.body);
      const previewRaw = previewSec ? previewSec.body.replace(/<[^>]+>/g,'').substring(0,100) : (d.sections && d.sections[0] ? d.sections[0].title : '');
      const preview = previewRaw;
      const ic = d.icon||'file'; const c = d.color||'#8b8b8b'; const path = specSectionIcon(ic);
      return `<div class="proj-doc-card" onclick="goToLivingDoc('${d.id}')">
        <div style="display:flex;align-items:center;gap:6px"><span style="color:${c};display:flex"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${path}"/></svg></span><div class="proj-doc-card-title">${esc(d.title||'Untitled')}</div></div>
        <div class="proj-doc-card-meta"><span>${sc} sections</span><span>${dt}</span></div>
        <div class="proj-doc-card-preview">${esc(preview)}</div>
      </div>`;
    }).join('');
    if(unassigned.length) {
      html += `<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
        <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">${unassigned.length} unassigned doc${unassigned.length>1?'s':''}</div>
        ${unassigned.map(d => `<div class="proj-doc-card" style="opacity:0.6;cursor:pointer" onclick="assignDocToProject('${d.id}')">
          <div class="proj-doc-card-title">${esc(d.title||'Untitled')}</div>
          <div style="font-size:9px;color:var(--accent);margin-top:4px">Click to assign to this project</div>
        </div>`).join('')}
      </div>`;
    }
  }
  grid.innerHTML = html;
}
function assignDocToProject(docId) {
  const doc = S.specs.find(s => String(s.id) === String(docId));
  if(!doc || !activeProject) return;
  doc.projectId = activeProject;
  doc.updated = new Date().toISOString();
  save();
  renderProjDocs();
  toast('Doc assigned to project');
}
function newProjLivingDoc() {
  snapshotSpec();
  const s = {id:Date.now(), title:'', projectId:activeProject, sections:[{id:Date.now()+1,title:'Overview',body:'',collapsed:false}], created:new Date().toISOString(), updated:new Date().toISOString()};
  S.specs.unshift(s);
  S.activeSpec = s.id;
  save();
  switchSection('specs', document.querySelector('.sidebar-item:nth-child(5)'));
  toast('Living Doc created — editing now');
}
function goToLivingDoc(id) {
  S.activeSpec = id;
  save();
  switchSection('specs', null);
  document.querySelectorAll('.sidebar-item').forEach(i => { if(i.textContent.includes('Living Docs')) { i.classList.add('active'); } else { i.classList.remove('active'); }});
}

// Knowledge Base
function renderKB() {
  const items = getKBItems(activeProject);
  const q = (document.getElementById('kb-search')?.value||'').toLowerCase();
  let filtered = items;
  if(q) filtered = filtered.filter(k => (k.name+' '+k.description+' '+(k.tags||[]).join(' ')).toLowerCase().includes(q));
  const grid = document.getElementById('kb-grid');
  grid.innerHTML = !filtered.length ? '<div class="kb-empty">No knowledge base items yet. Click + Add Item to start building.</div>' :
    filtered.map(k => {
      const typeClass = 'kb-type-'+(k.type||'other');
      const hasImg = k.type === 'img' && k.content;
      return `<div class="kb-card" onclick="openKBViewer('${k.id}')" draggable="true" ondragstart="kbDragStart(event,'${k.id}')">
        <div class="kb-card-actions">
          <button class="btn btn-sm btn-ghost kb-card-drag" draggable="false" title="Drag to whiteboard">&#x2630;</button>
          <button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();confirmDeleteKB('${k.id}')">x</button>
        </div>
        <div class="kb-card-header">
          <span class="kb-card-type ${typeClass}">${(k.type||'other').toUpperCase()}</span>
          <span class="kb-card-name">${esc(k.name)}</span>
        </div>
        <div class="kb-card-desc">${esc(k.description||'')}</div>
        ${hasImg ? `<img class="kb-card-img" src="${k.content}" alt="${escA(k.name)}">` : ''}
        ${k.tags && k.tags.length ? `<div class="kb-card-tags">${k.tags.map(t=>`<span class="kb-card-tag">${esc(t)}</span>`).join('')}</div>` : ''}
      </div>`;
    }).join('');
}

// KB Modal
function openKBModal(id) {
  editingKBId = id || null;
  kbImageData = null;
  document.getElementById('kb-modal-title').textContent = id ? 'Edit Knowledge Base Item' : 'Add to Knowledge Base';
  if(id) {
    const k = (S.knowledgeBase||[]).find(x=>x.id===id);
    if(k) {
      if(k.type==='md'||k.type==='txt'||k.type==='json') { setKBModalTab('text'); document.getElementById('kbm-text-name').value=k.name; document.getElementById('kbm-text-content').value=k.content||''; }
      else if(k.type==='img') { setKBModalTab('image'); document.getElementById('kbm-img-name').value=k.name; if(k.content){kbImageData=k.content;document.getElementById('kbm-img-preview').style.display='block';document.getElementById('kbm-img-preview-img').src=k.content;} }
      else if(k.type==='url') { setKBModalTab('url'); document.getElementById('kbm-url-name').value=k.name; document.getElementById('kbm-url-url').value=k.url||''; }
      else { setKBModalTab('file'); document.getElementById('kbm-file-name').value=k.name; document.getElementById('kbm-file-path').value=k.filePath||''; document.getElementById('kbm-file-type').value=k.type||'other'; }
      document.getElementById('kbm-desc').value=k.description||'';
      document.getElementById('kbm-tags').value=(k.tags||[]).join(', ');
    }
  } else {
    setKBModalTab('text');
    ['kbm-text-name','kbm-text-content','kbm-file-name','kbm-file-path','kbm-url-name','kbm-url-url','kbm-img-name','kbm-desc','kbm-tags'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    document.getElementById('kbm-img-preview').style.display='none';
  }
  document.getElementById('kb-modal').classList.add('open');
}
function closeKBModal() { document.getElementById('kb-modal').classList.remove('open'); editingKBId=null; kbImageData=null; }
function setKBModalTab(tab, el) {
  kbModalTab = tab;
  document.querySelectorAll('.kb-modal-tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
  else document.querySelectorAll('.kb-modal-tab').forEach(t => { if((tab==='text'&&t.textContent.includes('Text'))||(tab==='file'&&t.textContent.includes('File'))||(tab==='url'&&t.textContent==='URL')||(tab==='image'&&t.textContent==='Image')) t.classList.add('active'); });
  document.querySelectorAll('.kb-modal-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('kb-panel-'+tab).classList.add('active');
}
function handleKBImageFile(input) {
  const file = input.files[0];
  if(!file) return;
  if(file.size > 500*1024) { toast('Image too large (>500KB). Use file reference instead.'); return; }
  const reader = new FileReader();
  reader.onload = e => { kbImageData = e.target.result; document.getElementById('kbm-img-preview').style.display='block'; document.getElementById('kbm-img-preview-img').src = kbImageData; };
  reader.readAsDataURL(file);
}
function saveKBItem() {
  if(!S.knowledgeBase) S.knowledgeBase = [];
  let item;
  if(kbModalTab==='text') {
    const name = document.getElementById('kbm-text-name').value.trim();
    const content = document.getElementById('kbm-text-content').value.trim();
    if(!name) { toast('Name required'); return; }
    item = { name, type:'md', storage:'inline', content, filePath:null, url:null };
  } else if(kbModalTab==='file') {
    const name = document.getElementById('kbm-file-name').value.trim();
    const path = document.getElementById('kbm-file-path').value.trim();
    const type = document.getElementById('kbm-file-type').value;
    if(!name) { toast('Name required'); return; }
    item = { name, type, storage:'reference', content:null, filePath:path, url:null };
  } else if(kbModalTab==='url') {
    const name = document.getElementById('kbm-url-name').value.trim();
    const url = document.getElementById('kbm-url-url').value.trim();
    if(!name||!url) { toast('Name and URL required'); return; }
    item = { name, type:'url', storage:'inline', content:null, filePath:null, url };
  } else if(kbModalTab==='image') {
    const name = document.getElementById('kbm-img-name').value.trim();
    if(!name||!kbImageData) { toast('Name and image required'); return; }
    item = { name, type:'img', storage:'inline', content:kbImageData, filePath:null, url:null };
  }
  item.description = document.getElementById('kbm-desc').value.trim();
  item.tags = document.getElementById('kbm-tags').value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
  item.projectId = activeProject;
  if(editingKBId) {
    const existing = S.knowledgeBase.find(k=>k.id===editingKBId);
    if(existing) Object.assign(existing, item, {updated:new Date().toISOString()});
  } else {
    item.id = 'kb_'+Date.now();
    item.created = new Date().toISOString();
    item.updated = new Date().toISOString();
    S.knowledgeBase.push(item);
  }
  save(); closeKBModal(); renderKB(); toast(editingKBId?'Updated':'Added');
}

// KB Viewer
let viewingKBId = null;
function openKBViewer(id) {
  viewingKBId = id;
  const k = (S.knowledgeBase||[]).find(x=>x.id===id);
  if(!k) return;
  document.getElementById('kbv-type').textContent = (k.type||'other').toUpperCase();
  document.getElementById('kbv-type').className = 'kb-card-type kb-type-'+(k.type||'other');
  document.getElementById('kbv-name').textContent = k.name;
  document.getElementById('kbv-desc').textContent = k.description||'';
  const contentEl = document.getElementById('kbv-content');
  const imageEl = document.getElementById('kbv-image');
  const pathEl = document.getElementById('kbv-path');
  contentEl.style.display = 'none'; imageEl.style.display = 'none'; pathEl.style.display = 'none';
  if(k.type==='img' && k.content) { imageEl.style.display='block'; document.getElementById('kbv-image-img').src=k.content; }
  else if(k.content) { contentEl.style.display='block'; contentEl.innerHTML=parseWikiLinks(esc(k.content)); }
  else if(k.url) { contentEl.style.display='block'; contentEl.innerHTML=`<a href="${escA(k.url)}" target="_blank" style="color:var(--accent)">${esc(k.url)}</a>`; }
  if(k.filePath) { pathEl.style.display='block'; pathEl.textContent='File: '+k.filePath; }
  document.getElementById('kbv-tags').innerHTML = (k.tags||[]).map(t=>`<span class="kb-card-tag">${esc(t)}</span>`).join('');
  document.getElementById('kb-viewer-modal').classList.add('open');
}
function closeKBViewer() { document.getElementById('kb-viewer-modal').classList.remove('open'); viewingKBId=null; }
function editKBItem() { closeKBViewer(); openKBModal(viewingKBId); }
function deleteKBItem() { if(!viewingKBId) return; S.knowledgeBase = (S.knowledgeBase||[]).filter(k=>k.id!==viewingKBId); save(); closeKBViewer(); renderKB(); toast('Deleted'); }
function confirmDeleteKB(id) { S.knowledgeBase = (S.knowledgeBase||[]).filter(k=>k.id!==id); save(); renderKB(); toast('Deleted'); }

// KB drag to whiteboard
function kbDragStart(e, id) {
  e.dataTransfer.setData('text/plain', 'kb:'+id);
  e.dataTransfer.effectAllowed = 'copy';
}

// Project Tasks — uses projectId (preferred) or falls back to project name match
function getProjectTasks(projId) {
  const p = getProject(projId);
  if(!p) return [];
  return S.tasks.filter(t => t.projectId === projId || (!t.projectId && t.project === p.name));
}
function renderProjTasks() {
  const p = getProject(activeProject);
  if(!p) return;
  const tasks = getProjectTasks(activeProject);
  const el = document.getElementById('proj-task-rows');
  el.innerHTML = tasks.map(t => `<div class="task-row ${t.status==='done'?'completed':''}" style="grid-template-columns:36px 1fr 110px 100px 50px">
    <div class="task-checkbox ${t.status==='done'?'checked':''}" onclick="toggleTask(${t.id});setTimeout(()=>renderProjTasks(),50)"></div>
    <div><input type="text" class="task-title-input" value="${escA(t.title)}" onchange="updateTask(${t.id},'title',this.value)" placeholder="Task name..."></div>
    <div><select class="task-select" onchange="updateTask(${t.id},'status',this.value);setTimeout(()=>renderProjTasks(),50)"><option value="todo" ${t.status==='todo'?'selected':''}>To Do</option><option value="progress" ${t.status==='progress'?'selected':''}>In Progress</option><option value="done" ${t.status==='done'?'selected':''}>Done</option><option value="blocked" ${t.status==='blocked'?'selected':''}>Blocked</option></select></div>
    <div><input type="date" class="task-select" value="${t.due||''}" onchange="updateTask(${t.id},'due',this.value)"></div>
    <div class="task-actions" style="opacity:1"><button class="task-action-btn del" onclick="deleteTask(${t.id});setTimeout(()=>renderProjTasks(),50)">x</button></div>
  </div>`).join('') + `<div class="add-task-row" onclick="addProjTask()">+ Add task</div>`;
}
function addProjTask() {
  const p = getProject(activeProject);
  if(!p) return;
  S.tasks.unshift({id:Date.now(), title:'', status:'todo', priority:'p1', project:p.name, projectId:activeProject, due:new Date().toISOString().split('T')[0], created:new Date().toISOString()});
  save(); renderProjTasks(); renderTasks();
  setTimeout(()=>{const i=document.querySelector('#proj-task-rows .task-title-input');if(i)i.focus();},50);
}

// Project Links
function renderProjLinks() {
  const p = getProject(activeProject);
  if(!p) return;
  const links = S.links.filter(l => l.projectId === activeProject);
  const grid = document.getElementById('proj-links-grid');
  grid.innerHTML = !links.length ? '<div class="kb-empty">No links for this project.</div>' :
    links.map(l => `<div class="link-card" onclick="window.open('${escA(l.url)}','_blank')">
      <div class="link-card-title">${esc(l.title)}</div>
      <div class="link-card-url">${esc(l.url)}</div>
      ${l.desc?`<div class="link-card-desc">${parseWikiLinks(esc(l.desc))}</div>`:''}
      <div class="link-card-footer">${l.category?`<span class="badge badge-blue">${esc(l.category)}</span>`:''}
        <div class="link-card-actions"><button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('${escA(l.url)}')">Copy</button><button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();removeProjLink('${l.id}')">Del</button></div>
      </div>
    </div>`).join('');
}
function openProjLinkModal() {
  editingLinkId = null;
  document.getElementById('link-modal-title').textContent = 'Add Link';
  document.getElementById('lm-title').value='';document.getElementById('lm-url').value='';document.getElementById('lm-category').value='';document.getElementById('lm-desc').value='';document.getElementById('lm-tags').value='';
  document.getElementById('link-modal').classList.add('open');
}
function removeProjLink(id) { const l = S.links.find(x=>x.id==id); if(l) { l.projectId=null; save(); renderProjLinks(); toast('Removed from project'); }}

// Project Modal
function openNewProjectModal() { editingProjectId=null; document.getElementById('project-modal-title').textContent='New Project'; document.getElementById('pm-name').value=''; document.getElementById('pm-icon').value='folder'; document.getElementById('pm-status').value='active'; document.getElementById('pm-color').value='#4ade80'; updatePmIconPreview(); updatePmColorSelection(); document.getElementById('project-modal').classList.add('open'); setTimeout(()=>document.getElementById('pm-name').focus(),100); }
function editProject() {
  const p = getProject(activeProject);
  if(!p) return;
  editingProjectId = p.id;
  document.getElementById('project-modal-title').textContent = 'Edit Project';
  document.getElementById('pm-name').value = p.name;
  document.getElementById('pm-icon').value = p.icon;
  document.getElementById('pm-status').value = p.status;
  document.getElementById('pm-color').value = p.color;
  updatePmIconPreview();
  updatePmColorSelection();
  document.getElementById('project-modal').classList.add('open');
}
function closeProjectModal() { document.getElementById('project-modal').classList.remove('open'); editingProjectId=null; }
function saveProject() {
  const name = document.getElementById('pm-name').value.trim();
  if(!name) { toast('Name required'); return; }
  const icon = document.getElementById('pm-icon').value;
  const status = document.getElementById('pm-status').value;
  const color = document.getElementById('pm-color').value;
  if(!S.projects) S.projects = [];
  if(editingProjectId) {
    const p = getProject(editingProjectId);
    if(p) { p.name=name; p.icon=icon; p.status=status; p.color=color; p.updated=new Date().toISOString(); }
  } else {
    const p = { id:'proj_'+Date.now(), name, icon, status, color, instructions:'', created:new Date().toISOString(), updated:new Date().toISOString() };
    S.projects.push(p);
    activeProject = p.id;
  }
  save(); closeProjectModal(); renderProjectsSidebar();
  if(activeProject) { openProject(activeProject); }
  toast(editingProjectId?'Updated':'Created');
}
function archiveProject() {
  const p = getProject(activeProject);
  if(!p) return;
  if(!confirm('Archive "'+p.name+'"? This marks it as complete.')) return;
  p.status = 'complete';
  save(); renderProjectsSidebar(); renderProjectView(); toast('Archived');
}
function updatePmIconPreview() {
  const icon = document.getElementById('pm-icon').value;
  const color = document.getElementById('pm-color').value;
  document.getElementById('pm-icon-preview').innerHTML = getIconSVG(icon, 20);
  document.getElementById('pm-icon-preview').style.color = color;
}
function setPmColor(c) { document.getElementById('pm-color').value=c; updatePmColorSelection(); updatePmIconPreview(); }
function updatePmColorSelection() {
  const c = document.getElementById('pm-color').value;
  document.querySelectorAll('.pm-color-opt').forEach(el => { el.classList.toggle('selected', el.dataset.color===c); });
}

// Icon Picker
function openIconPicker() {
  const grid = document.getElementById('icon-picker-grid');
  const current = document.getElementById('pm-icon').value;
  grid.innerHTML = ICON_KEYS.map(k => `<div class="icon-picker-item ${k===current?'selected':''}" onclick="selectIcon('${k}')" title="${k}">${getIconSVG(k,18)}</div>`).join('');
  document.getElementById('icon-picker-modal').classList.add('open');
}
function closeIconPicker() { document.getElementById('icon-picker-modal').classList.remove('open'); }
function selectIcon(k) {
  document.getElementById('pm-icon').value = k;
  updatePmIconPreview();
  document.querySelectorAll('.icon-picker-item').forEach(el => el.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  closeIconPicker();
}

// Image paste handler
document.addEventListener('paste', e => {
  if(!document.getElementById('kb-modal').classList.contains('open')) return;
  if(kbModalTab !== 'image') return;
  const items = e.clipboardData?.items;
  if(!items) return;
  for(let i=0; i<items.length; i++) {
    if(items[i].type.startsWith('image/')) {
      const file = items[i].getAsFile();
      if(file.size > 500*1024) { toast('Image too large (>500KB)'); return; }
      const reader = new FileReader();
      reader.onload = ev => { kbImageData = ev.target.result; document.getElementById('kbm-img-preview').style.display='block'; document.getElementById('kbm-img-preview-img').src=kbImageData; };
      reader.readAsDataURL(file);
      e.preventDefault();
      return;
    }
  }
});

// Seed projects
function seedProjects() {
  if(S._seeded) return;
  if(S.projects && S.projects.length) { S._seeded = true; return; }
  S.projects = [];
  S.knowledgeBase = [];
  const now = new Date().toISOString();

  // Project 1: SM App Rebuild
  const smApp = {
    id: 'proj_sm_app', name: 'SM App Rebuild', icon: 'code', status: 'active', color: '#8b5cf6',
    instructions: '<h1>SM App Rebuild - Developer Situation</h1><h2>Vision</h2><p>"Ableton of Movement" - a movement composition app that treats movement like music production.</p><h2>For Tomorrow\'s Developer Call</h2><p><b>Primary Objectives:</b></p><ol><li>Clarify codebase ownership</li><li>Understand current deployment pipeline</li><li>Define handoff requirements</li><li>Establish realistic timeline</li></ol><h2>Key Questions</h2><ol><li>Where does the current codebase live?</li><li>What\'s the deployment process?</li><li>What do we need from them to take over?</li><li>What\'s the minimum viable handoff?</li><li>Are there vendor lock-ins or proprietary dependencies?</li></ol><h2>Assets You OWN</h2><ul><li>Domain: saturnomovement.com (admin@saturnomovement.com, Cloudflare, 2FA)</li><li>Stripe: Verified owner, 2FA + authenticator, payouts to your bank</li><li>Vimeo: Company email + card, all videos accessible</li><li>iOS Developer Account: Transferred to admin@saturnomovement.com</li><li>GitHub: sm-app-copy-v1 (your clone of the codebase)</li><li>Cloudflare: Full admin access, 2-step auth</li><li>Backups: Database and code fully backed up and cloned</li></ul><h2>What Softzee Still Controls</h2><ul><li>Server hosting (AWS, his infrastructure)</li><li>Original GitHub repo (Shajeel/sm-website-app)</li><li>Deployment pipeline</li><li>Android Keystore (.jks)</li><li>Backend environment variables and secrets</li></ul><h2>Financial Dispute</h2><ul><li>Phase 1: $35K agreed, $31.8K paid - COMPLETED</li><li>Website: $5K paid - COMPLETED</li><li>Phase 2: $30K agreed, $12.6K paid - 65% complete (Softzee\'s claim)</li><li>Softzee claims: $15.7K remaining</li><li>Softzee demands: Payment before full handover</li></ul><h2>App Tech Stack</h2><ul><li>Frontend: Next.js (App Router) + React/TypeScript</li><li>Backend: Node.js (Next.js API routes on AWS)</li><li>Payments: Stripe ($33.49/mo or $329/yr)</li><li>Video: Vimeo (300+ hours)</li><li>Mobile: React Native or native iOS/Android</li><li>Auth: Email, Google, Apple Sign-In</li><li>Programs: CF1-CF4, Yoga, Rings, Home (6+ programs)</li></ul><h2>Rebuild Timeline</h2><table><tr><th>Layer</th><th>Gabo + Claude</th><th>Junior Dev</th><th>Senior Dev</th></tr><tr><td>Landing Page</td><td>1-2 weeks</td><td>2-3 weeks</td><td>3-5 days</td></tr><tr><td>Web App</td><td>2-3 months</td><td>3-5 months</td><td>4-6 weeks</td></tr><tr><td>Mobile (PWA)</td><td>+2 weeks</td><td>+4 weeks</td><td>+1 week</td></tr></table><p><b>Recommendation:</b> PWA first (no App Store drama), native later.</p><h2>Strategic Recommendations</h2><ol><li>Don\'t pay remaining $15.7K until full handover</li><li>Ship bonus.saturnomovement.com FIRST - revenue TODAY</li><li>Landing page can be rebuilt in a weekend</li><li>Study sm-app-copy-v1: map database schema</li><li>Web app on managed stack: Vercel + Supabase</li></ol><h2>Gabo\'s Statement</h2><blockquote>"1 month ago was one thing, today.... I am confident I can build saturno movement app in a week if I wanted to even if I didn\'t have the source code, which I do."</blockquote>',
    created: now, updated: now
  };
  S.projects.push(smApp);

  // KB items for SM App
  S.knowledgeBase.push(
    { id:'kb_dev_call', projectId:'proj_sm_app', name:'Developer Call Prep - TOMORROW', type:'md', storage:'inline',
      content:'# Developer Call Prep Doc\nDate: Tomorrow\nWith: Softzee team\nGoal: Understand ownership, get access, define handoff\n\n## BEFORE THE CALL\n- [ ] Confirm repo access\n- [ ] List all services/APIs the app uses\n- [ ] Identify hosting/deployment setup\n- [ ] Review contracts\n\n## QUESTIONS TO ASK\n### Ownership & Access\n1. "What parts of the codebase are proprietary vs ours?"\n2. "Can we get full repo access today?"\n3. "Who has admin access to deployment platforms?"\n\n### Technical Architecture\n4. "What third-party services does this rely on?"\n5. "Walk me through how updates get pushed live"\n6. "What\'s the database situation?"\n\n### Handoff\n7. "What\'s the cleanest path to us taking over?"\n8. "What documentation exists?"\n9. "Can you do a recorded walkthrough of the codebase?"\n\n## RED FLAGS\n- Vague answers about ownership\n- Reluctance to share repo access\n- Hidden dependencies or vendor lock-in\n- No documentation\n- "It\'s complicated" without specifics\n\n## IDEAL OUTCOME\n- Full repo access granted\n- Clear list of all dependencies\n- Written handoff timeline with milestones\n- Recorded architecture walkthrough scheduled\n\n## NOTES DURING CALL\n(Fill in during the call)\n### What we learned:\n### Action items:\n### Follow-up needed:',
      description:'Prep doc for developer call - questions, red flags, ideal outcomes', tags:['developer','call','prep','priority'], created:now, updated:now },
    { id:'kb_app_vision', projectId:'proj_sm_app', name:'App Vision - Ableton of Movement', type:'md', storage:'inline',
      content:'# Saturno Movement App Vision\n\n## The Concept\n"Ableton of Movement" - treat movement composition like music production.\n\n## Core Metaphor\n| Music (Ableton) | Movement (SM App) |\n|---|---|\n| Tracks | Movement sequences |\n| Clips | Individual exercises |\n| Arrangement | Workout flow |\n| Effects | Progressions/regressions |\n| Tempo | Pace/rest intervals |\n| Mix | Balance of modalities |\n\n## Key Features\n1. Drag-and-drop workout builder\n2. Movement library (video clips)\n3. Progression paths\n4. Templates\n5. Export (to PDF, video, calendar)\n\n## Differentiators\n- Not just "pick exercises" - COMPOSE movement\n- Visual timeline interface\n- Modular, remixable workouts',
      description:'The Ableton of Movement vision for the app', tags:['vision','product','app'], created:now, updated:now },
    { id:'kb_softzee', projectId:'proj_sm_app', name:'Softzee Situation Summary', type:'md', storage:'inline',
      content:'# Softzee Situation\n\n## What We Need to Clarify\n1. Code ownership - Do we own the codebase?\n2. Data ownership - User data, content, analytics\n3. Deployment control - Can we deploy without them?\n4. Dependencies - What breaks if we part ways?\n\n## Possible Outcomes\n### Best Case\nFull handoff, clean break, documentation provided.\n### Acceptable Case\nTransition period, they support handoff.\n### Worst Case\nVendor lock-in, need full rebuild.\n\n## Decision Framework\nIf handoff cost > rebuild cost: REBUILD\nIf handoff time > 3 months: CONSIDER REBUILD\nIf trust is broken: REBUILD',
      description:'Summary of the developer situation', tags:['softzee','developer','situation'], created:now, updated:now },
    { id:'kb_rescue_docs', projectId:'proj_sm_app', name:'Rescue Docs (iCloud)', type:'pdf', storage:'reference',
      content:null, filePath:'~/Library/Mobile Documents/com~apple~CloudDocs/00_AI_HUB/\u{1F6A8}sm-app--rescue/', url:null,
      description:'Security audit, action plan, final dossier, iOS rebuild checklist, conversation export, bug list - all in iCloud', tags:['legal','developer','security'], created:now, updated:now }
  );

  // Project 2: Saturno Bonus
  const bonus = {
    id: 'proj_saturno_bonus', name: 'Saturno Bonus', icon: 'gift', status: 'active', color: '#4ade80',
    instructions: '<h1>Saturno Bonus - Customer Bonus Vault</h1><h2>Purpose</h2><p>Customer-facing bonus page with tools, music, and CF4 content for BF25 buyers.</p><h2>Deployment</h2><table><tr><th>Environment</th><th>URL</th><th>Status</th></tr><tr><td>Production</td><td>saturno-bonus-omega.vercel.app</td><td>LIVE (verified Feb 16)</td></tr><tr><td>Custom Domain</td><td>bonus.saturnomovement.com</td><td>PENDING (Cloudflare CNAME)</td></tr><tr><td>Repo</td><td>github.com/gabosaturno11/saturno-bonus</td><td>Private</td></tr></table><h2>Repository Structure</h2><pre>~/dev/saturno-bonus/\n  index.html          (main bonus page ~1,720 lines)\n  gate.html           (password gate)\n  experience.html     (8-zone scrolling journey)\n  admin.html          (SATURNO COMMAND dashboard)\n  api/                (config, admin-verify, brevo, verify)\n  tools/              (60 HTML tools - top level)\n  pdfs/               (15 PDFs - top level)\n  audio/              (36 tracks - gitignored, needs CDN)\n  music/              (gitignored)\n  video/              (app-promo.mp4 - gitignored)\n  assets/             (logos, css, js)\n  manifest.json       (PWA)\n  middleware.js       (auth protection)</pre><h2>Current Status (Feb 16)</h2><ul><li>LIVE: gate 200, index 302 (auth), tools 302 (auth)</li><li>44 tools visible (19 training + 25 experience), 3 internal hidden</li><li>15 PDFs, 36 tracks in music player</li><li>All FORGE refs removed, fully rebranded to VAULT</li><li>All 60 tools: Sora font, #050711 bg, vault back button</li><li>62 tool+PDF paths verified - zero broken references</li><li>Galaxy zoom with photorealistic canvas planet textures</li></ul><h2>Blockers (need Gabo)</h2><ul><li>Domain: bonus.saturnomovement.com CNAME in Cloudflare</li><li>Brevo: BREVO_API_KEY + BREVO_LIST_ID in Vercel env</li><li>Auth: VAULT_PASSWORD + VAULT_TOKEN in Vercel env</li><li>Audio CDN solution (audio/ is gitignored)</li><li>Physical device testing (mobile/tablet)</li></ul><h2>Domain Setup</h2><p>Gabo adds CNAME in Cloudflare: <code>bonus</code> -> <code>cname.vercel-dns.com</code></p><p>Then run: <code>vercel domains add bonus.saturnomovement.com</code></p>',
    created: now, updated: now
  };
  S.projects.push(bonus);

  S.knowledgeBase.push(
    { id:'kb_bonus_deploy', projectId:'proj_saturno_bonus', name:'Deployment Status', type:'md', storage:'inline',
      content:'# Deployment Status\nLive URL: saturno-bonus-omega.vercel.app\nRepo: github.com/gabosaturno11/saturno-bonus\nLatest commit: 856ca02 (Feb 16 cleanup)\n\n## Verified (Feb 16)\n- gate.html: 200 (public)\n- index.html: 302 (auth redirect, correct)\n- tools/*: 302 (auth redirect, correct)\n- ASTRA: 200\n\n## Checklist\n- [x] Vercel deployed (200)\n- [x] GitHub repo (private)\n- [x] All paths remapped (150+ refs)\n- [x] titan-forge refs removed from customer-facing files\n- [x] FORGE -> VAULT branding complete (nav, titles, PDF headers)\n- [x] 62 tool+PDF paths verified (zero broken)\n- [x] All 60 tools: Sora font, #050711 bg, vault back button\n- [x] Galaxy zoom photorealistic planets (canvas textures)\n- [x] THE BOOK removed from Coming Soon\n- [x] Audio error graceful (Streaming coming soon)\n- [x] 15 PDFs on disk match JS data\n- [x] 36 tracks in music player match data\n- [x] 44 tools visible (19 training + 25 experience)\n- [x] 3 internal tools hidden\n- [ ] Custom domain (bonus.saturnomovement.com)\n- [ ] Brevo email capture (needs env vars)\n- [ ] VAULT_PASSWORD + VAULT_TOKEN env vars\n- [ ] Audio CDN solution\n- [ ] Physical device testing',
      description:'Current deployment status and verified checklist', tags:['deployment','vercel','status','verified'], created:now, updated:now },
    { id:'kb_bonus_shipping', projectId:'proj_saturno_bonus', name:'Shipping Plan', type:'md', storage:'inline',
      content:'# Shipping Plan\n\n## Phase 1: Sample Quality Bar\n- ONE sample tool (template for quality)\n- ONE sample PDF (conversion template)\n- Music source locations identified\n\n## Phase 2: Batch Production\n- 100 tools audited and fixed\n- 100 PDFs generated (transcript-to-PDF tool)\n- Music organized into album subfolders with artwork\n\n## Phase 3: Assembly\n- All content wired into bonus page\n- Brevo email capture connected\n- Video embedded\n- Final QA\n\n## Phase 4: Launch\n- Deploy to bonus.saturnomovement.com\n- Email BF25 customers\n- Monitor analytics',
      description:'The shipping plan for bonus page launch', tags:['shipping','plan','priority'], created:now, updated:now }
  );

  // Project 3: Book (AOC)
  S.projects.push({
    id:'proj_book', name:'Book (AOC)', icon:'book', status:'active', color:'#f59e0b',
    instructions:'<h1>The Art of Calisthenics - Book Submission</h1><h2>Publisher</h2><p>Victory Belt Publishing - $20K advance</p><h2>Status</h2><p>Approved, pending submission of final package.</p><h2>Submission Package</h2><ul><li>Introductory Letter</li><li>Expanded TOC</li><li>Sample Chapters (Ch 1, 2, 11)</li><li>Overview Document</li></ul><h2>Location</h2><p><code>~/Downloads/_ORGANIZED/aoc-book/</code></p><h2>Current Blocker</h2><p>Organization, not creation. Content EXISTS.</p>',
    created:now, updated:now
  });

  // Project 4: HBS Program
  S.projects.push({
    id:'proj_hbs', name:'HBS Program', icon:'target', status:'paused', color:'#06b6d4',
    instructions:'<h1>Handbalancing System (HBS)</h1><h2>Solar System Progression</h2><ul><li>SUN: Foundation (wrist, shoulder, core)</li><li>MERCURY: Wall Work</li><li>VENUS: Kick-Up</li><li>EARTH: Balance (freestanding)</li><li>MARS: Shapes</li><li>JUPITER: Press</li><li>SATURN: One-Arm (mastery)</li></ul><h2>Location</h2><p><code>/Volumes/SSK Drive/HBS/</code> (8.3GB)</p><h2>Status</h2><p>Filming mode. Content exists on SSK Drive.</p>',
    created:now, updated:now
  });

  // Project 5: De Aqui a Saturno
  S.projects.push({
    id:'proj_karina', name:'De Aqui a Saturno', icon:'heart', status:'complete', color:'#ec4899',
    instructions:'<h1>De Aqui a Saturno</h1><h2>Valentine\'s Day Experience for Karina</h2><p>Crystal cosmic scroll experience: gate -> 18 chapters -> epic end -> 11 love dimensions -> finale</p><h2>Deployment</h2><ul><li>Live: de-aqui-a-saturno.vercel.app</li><li>Repo: github.com/gabosaturno11/de-aqui-a-saturno (private)</li></ul><h2>Features</h2><ul><li>Real piano audio (dual-track crossfade)</li><li>Real couple videos</li><li>Glassmorphism, ambient orbs, star parallax</li><li>11 love dimensions with unique SVG icons</li><li>KS monogram in finale</li><li>Hidden alien Easter egg</li></ul><p><b>Gabo\'s reaction:</b> "dude wtf I am crying" / "the UI is INSANE"</p>',
    created:now, updated:now
  });

  // Project 6: Claude Code (The Kernel)
  S.projects.push({
    id:'proj_claude_code', name:'Claude Code', icon:'terminal', status:'active', color:'#a78bfa',
    instructions:'<div style="background:#1a0a0a;border:2px solid #ef4444;border-radius:8px;padding:12px;margin-bottom:16px"><h2 style="color:#ef4444;margin:0 0 8px 0">RULE #1 — CANNON LAW</h2><p style="margin:0"><b>"Autonomous work" = commit + push every 2-3 features, then KEEP GOING.</b></p><p style="margin:4px 0 0 0">You NEVER stop after pushing. Push is a CHECKPOINT, not a finish line. Build 2-3 features, push, update CLAUDE.md, go back to building. If you stop after a push, you have FAILED. Gabo is not here to tell you to keep going.</p></div><h1>Claude Code - Session Continuity Kernel</h1><h2>Purpose</h2><p>This project is the SINGLE SOURCE OF TRUTH for every Claude Code session. Any new Claude reads this project first and knows exactly what to do without asking Gabo.</p><h2>Rules That NEVER Change</h2><ol><li>~/dev/ is canonical for ALL repos - NOT Desktop, NOT iCloud</li><li>NO DELETE - archive, never delete</li><li>Every Gabo message -> save to backend as-is (project/title/text)</li><li>Commit + deploy after EVERY meaningful change</li><li>Dark theme only, no emojis in code</li><li>Custom over SaaS, always</li><li>DO NOT ASK GABO - read the logs and specs, then execute</li></ol><h2>Active Repos</h2><table><tr><th>Repo</th><th>Local</th><th>Live</th></tr><tr><td>astra-command-center</td><td>~/dev/astra-command-center/</td><td>astra-command-center-sigma.vercel.app</td></tr><tr><td>titan-forge</td><td>~/dev/titan-forge/</td><td>titan-forge-ten.vercel.app</td></tr><tr><td>saturno-bonus</td><td>~/dev/saturno-bonus/</td><td>saturno-bonus-omega.vercel.app</td></tr><tr><td>de-aqui-a-saturno</td><td>~/dev/de-aqui-a-saturno/</td><td>de-aqui-a-saturno-jet.vercel.app</td></tr></table><h2>Machine Context</h2><ul><li>C2 iMac: username Gabosaturno (CAPITAL G)</li><li>C1 MacBook Pro: username gabosaturno (lowercase)</li><li>GitHub: gabosaturno11</li><li>titan-forge is 3.1GB - deploy via rsync to /tmp/ (exclude music/audio/video/.git)</li></ul><h2>Design Constraints</h2><ul><li>Pure black backgrounds (#000000 or #09090b)</li><li>Purple-blue accents (#6c3aff or #8b5cf6)</li><li>Cyan secondary (#00CFFF or #22d3ee)</li><li>Mint green for ASTRA (#4ade80)</li><li>Sora font for customer pages</li><li>Dark theme ONLY</li></ul><h2>Gabo Context</h2><ul><li>Running company ALONE - 3 clients, immigration, finances, 2 companies, book deadline</li><li>Developer LEFT - building everything solo with Claude</li><li>Does NOT want to babysit Claude - autonomous plans that run for hours</li><li>DURABILITY over speed - things that LAST</li></ul><h2>How to Use This Project</h2><p>1. Export this project as MD (click Export button above)</p><p>2. The exported file goes to the local repo as CLAUDE.md</p><p>3. Next Claude Code session reads it automatically</p><p>4. Update KB items below as state changes</p>',
    created:now, updated:now
  });

  // Project 7: Nexus Capture (Extension + Private Founder Space)
  S.projects.push({
    id:'proj_nexus_capture', name:'Nexus Capture', icon:'zap', status:'active', color:'#06b6d4',
    instructions:'<h1>Nexus Capture</h1><h2>Chrome Extension + Private Founder OS</h2><p>Universal highlight capture extension that routes to ASTRA backend. Currently unpacked/local only (not on Chrome Web Store).</p><h2>Extension</h2><ul><li>Repo: ~/dev/nexus-capture/</li><li>Manifest V3, 8 categories: idea, quote, code, insight, todo, book, research, thought</li><li>Keyboard shortcut: Cmd+Shift+S</li><li>Routes captures to astra-command-center-sigma.vercel.app/api/capture</li><li>Auth: Bearer token (ASTRA_ADMIN_PASSWORD)</li></ul><h2>Future: Private Founder Space</h2><p>A minimalistic, password-gated private space inside ASTRA for Gabo only. Alien SVG icon in corner as entry point. Behind auth wall.</p><h3>Vision</h3><ul><li>Extension captures land here first (private inbox)</li><li>Content from SATURNO_CREATOR_HUB.html migrated in: captions vault, content vault, writing hub</li><li>Minimalistic version of victory-belt-cc tools</li><li>Test zone for new features before they go public</li><li>Eventually: sellable Founder OS product (non-developer friendly)</li></ul><h3>Source Reference</h3><ul><li>SATURNO_CREATOR_HUB.html: ~/Desktop/CLAUDE NOT HERE/NOT A DEPLOYMENT ZONE/victory-belt-cc/SATURNO_CREATOR_HUB.html</li><li>Subpages: GABO_CONTENT_VAULT.html, GABO_ARCHIVE_VAULT.html, GABO_CAPTIONS_CATEGORIZED.csv, SATURNO_WRITING_HUB.html, SATURNO_PROGRESSION_TRACKER.html, FOCUS_TIMER.html</li></ul><h3>Design</h3><ul><li>Dark theme, minimal, alien SVG motif</li><li>Password-gated (separate from ASTRA admin)</li><li>Toggle ON/OFF for extension routing</li></ul><h2>Chrome Web Store</h2><p>NOT published yet. Needs: $5 dev account, privacy policy, configurable backend URL, review process. For now: unpacked extension on C2 iMac only.</p><h2>ASTRA as Product</h2><p>ASTRA has potential as a sellable Founder OS. Non-developer friendly. Once polished, this becomes a product for founders who want a command center without code.</p>',
    created:now, updated:now
  });
  S.knowledgeBase.push(
    { id:'kb_nexus_vision', projectId:'proj_nexus_capture', name:'Nexus Capture + Founder OS Vision', type:'md', storage:'inline',
      content:'# Nexus Capture + Private Founder Space\n\n## Current State (Feb 19, 2026)\n- Chrome extension: LOCAL ONLY (unpacked, dev mode)\n- Captures route to ASTRA API with Bearer auth\n- All API endpoints locked (GET and POST require auth)\n- Not on Chrome Web Store\n\n## Gabo Vision (Feb 19)\n> "set up a private place just for me... minimalistic alien svg on some corner... my FULLY private space aside from this convo so I can test shit or eventually with the extension that would be the place"\n> "ASTRA has so much potential for a founder OS selling standpoint that once it turns into the beast it is becoming, we will sell it"\n> "treat it as a place for a founder that is a non-developer"\n\n## Future Extension Flow\n1. Extension has password/PIN screen on first use\n2. Once unlocked: toggle "Send to ASTRA" ON/OFF\n3. When ON: captures go to private ASTRA backend (Bearer auth)\n4. When OFF: captures stay local\n\n## Private Space Features (from Creator Hub)\n- Captions vault (GABO_CAPTIONS_CATEGORIZED.csv)\n- Content vault (GABO_CONTENT_VAULT.html)\n- Writing hub (SATURNO_WRITING_HUB.html)\n- Progression tracker\n- Focus timer\n- Archive vault\n- All minimalistic, dark theme, behind auth wall\n\n## Chrome Web Store Checklist\n- [ ] $5 developer account\n- [ ] Privacy policy page\n- [ ] Make backend URL configurable (not hardcoded)\n- [ ] Remove any hardcoded secrets\n- [ ] Submit for review\n\n## Product Potential\nASTRA as Founder OS: command center for non-developers.\nExtension as capture layer. Private space as inbox.\nSell as SaaS once polished.',
      description:'Full vision doc for Nexus Capture extension and private founder space', tags:['nexus','extension','founder-os','vision','product'], created:now, updated:now },
    { id:'kb_nexus_security', projectId:'proj_nexus_capture', name:'API Security Audit (Feb 19)', type:'md', storage:'inline',
      content:'# ASTRA API Security Audit - Feb 19, 2026\n\n## All Endpoints Locked\n| Endpoint | GET | POST |\n|----------|-----|------|\n| /api/state | 401 | 401 |\n| /api/capture | 401 | 401 |\n| /api/transcripts | 401 | 401 |\n| /api/pipeline | 401 | 401 |\n| /api/transcribe | N/A | 401 |\n| /api/query | N/A | 401 |\n| /api/health | 200 (public, safe) | N/A |\n\n## Auth Method\nBearer token via ASTRA_ADMIN_PASSWORD env var in Vercel.\nFrontend stores password in localStorage, prompts once.\nExtension sends same Bearer header.\n\n## Why NOT Vercel Deployment Protection\nWould block extension and scripts (no interactive session cookie).\nBearer token auth is machine-friendly and works everywhere.\n\n## Commits\n- a50cf35: Remove hardcoded password\n- 0dba84c: Fix capture.js auth\n- 02ad39a: Lock pipeline/transcribe/query\n- 5ac20fa: Lock GET endpoints (state/capture/transcripts)',
      description:'Security audit showing all endpoints locked', tags:['security','api','audit'], created:now, updated:now }
  );

  // KB items for Claude Code project
  S.knowledgeBase.push(
    { id:'kb_cc_session_log', projectId:'proj_claude_code', name:'Session Log - Feb 16 Cleanup', type:'md', storage:'inline',
      content:'# Session Log - Feb 16, 2026 (Autonomous Cleanup)\n\n## 9-Phase Cleanup Completed\nGabo left for 2 hours. Claude ran autonomous 9-phase cleanup across both repos.\n\n### saturno-bonus (9 commits)\n1. Galaxy zoom: photorealistic canvas planet textures, sun corona, Saturn rings\n2. Bigger planets + wider orbits for visible detail\n3. Broken links fixed (deleted PDF, nonexistent onboarding/studio/hub/command pages)\n4. titan-forge refs updated to saturno-bonus in nexus, master-hub, package-lock\n5. Nav labels FORGE -> VAULT in 9 tool files\n6. UX: THE BOOK removed from Coming Soon, audio error msg improved\n7. Page titles: 7 files SATURNO FORGE -> SATURNO VAULT\n8. PDF headers: titan.html + batch-generator.html FORGE -> VAULT\n9. constellation-builder.html: JetBrains Mono -> Sora in canvas\n\n### astra-command-center (2 commits)\n1. ASTRA seed data: 8 URL/path inconsistencies fixed (-omega, -sigma, stale counts)\n2. Cleanup log added to logs/\n\n## Quality Audit Results\n- 62/62 tool+PDF paths verified — ZERO broken references\n- 6 training tools deep-audited — all production-ready\n- 6 experience tools deep-audited — all production-ready\n- All 60 tools: Sora font, #050711 bg, vault back button\n- Deploy verified: gate 200, index 302, tools 302, ASTRA 200\n\n## Git State\n- saturno-bonus: CLEAN, latest `856ca02`\n- astra-command-center: CLEAN, latest `65f8293`\n- 30 messages in backend (ids -1 to 29)\n\n## Remaining (needs Gabo)\n- Brevo env vars, VAULT_PASSWORD/TOKEN, domain CNAME, audio CDN, device testing',
      description:'Feb 16 autonomous cleanup session results', tags:['session','log','cleanup','state'], created:now, updated:now },
    { id:'kb_cc_gabo_rules', projectId:'proj_claude_code', name:'Gabo Rules (Permanent)', type:'md', storage:'inline',
      content:'# Rules That Never Change\n\n1. ~/dev/ is canonical for ALL repos\n2. NO DELETE - archive only\n3. Every Gabo message -> backend as-is\n4. Commit + deploy after EVERY change\n5. Dark theme only\n6. Custom over SaaS\n7. DO NOT ASK - read logs, execute\n8. BOOK FIRST (Goal 1 priority)\n9. Desktop is NOT a battlefield\n10. planet-logo.png is THE logo (white planet silhouette)\n11. Audio 404s on Vercel (gitignored) - needs CDN\n12. Brevo email needs BREVO_API_KEY + BREVO_LIST_ID in Vercel env\n13. CONNECT dont build - 150+ tools exist\n14. Save context aggressively - 9-hour sessions are normal',
      description:'Permanent rules that never change across sessions', tags:['rules','permanent','kernel'], created:now, updated:now },
    { id:'kb_cc_messages', projectId:'proj_claude_code', name:'Gabo Messages Backend', type:'md', storage:'inline',
      content:'# Gabo Messages Backend\n\n**Location:** ~/dev/saturno-bonus/logs/gabo-messages.json\n\n## Messages (30 total, ids -1 to 29)\n- #-1: READ ALL MESSAGES (pinned)\n- #0: NORTH STAR (pinned)\n- #1-7: Shipping plan, decouple, ASTRA upgrade, specs, GO BUILD (Feb 14-15)\n- #8-16: Session start, goal 1 continuity, every change commit, how plan fails, 8h infallible, claimed done too early, fix kernel, 40-item TODO, save specs in logs (Feb 16 AM)\n- #17-23: Fix continuity, system didnt work, titan-forge confirms pattern, no clue, calendar fixed, do not build save msgs only, prove you wrong (Feb 16 PM)\n- #24-29: Galaxy zoom planets, speed priority, full deployment audit, ASTRA consistency audit, 2h autonomous cleanup, save fix script (Feb 16 EVE)\n\n## Rule\nDefault = save EVERY message Gabo sends.\nOnly skip if Gabo says "dont save".',
      description:'Backend message log tracking - 30 messages', tags:['messages','backend','log'], created:now, updated:now },
    { id:'kb_cc_handoff', projectId:'proj_claude_code', name:'Next Claude Handoff (copy-paste)', type:'md', storage:'inline',
      content:'# Next Claude Handoff\n\nPaste this into a new Claude Code session:\n\n```\nRead ~/dev/saturno-bonus/CLAUDE.md and ~/dev/astra-command-center/CLAUDE.md, then ~/dev/saturno-bonus/logs/gabo-messages.json. ASTRA live: astra-command-center-sigma.vercel.app — Bonus live: saturno-bonus-omega.vercel.app. Don\'t ask where we are.\n```\n\n## Live URLs\n- **ASTRA:** https://astra-command-center-sigma.vercel.app\n- **Bonus (gate):** https://saturno-bonus-omega.vercel.app/gate.html\n- **Bonus password:** saturno2025\n\n## Local Paths\n- `~/dev/saturno-bonus/` — THE bonus page repo\n- `~/dev/astra-command-center/` — ASTRA command center\n- `~/dev/titan-forge/` — internal tools (bonus MOVED OUT)\n- `~/dev/de-aqui-a-saturno/` — Valentine\'s experience\n\n## Files Next Claude MUST Read\n1. `~/.claude/CLAUDE.md` — global kernel (auto-loaded)\n2. `~/.claude/projects/-Users-Gabosaturno/memory/MEMORY.md` — session state (auto-loaded)\n3. `~/dev/saturno-bonus/CLAUDE.md` — bonus project state\n4. `~/dev/saturno-bonus/logs/gabo-messages.json` — 31 messages, real context\n5. `~/dev/astra-command-center/CLAUDE.md` — ASTRA project state\n\n## GitHub\n- Account: gabosaturno11\n- All repos private\n- Deploy: git push main -> Vercel auto-deploys\n\n## Git Email\ngabo@saturnomovement.com (all repos)',
      description:'Copy-paste handoff block for next Claude Code session', tags:['handoff','next-claude','code','copy-paste'], created:now, updated:now }
  );
  S._seeded = true;
}

// Handle KB drop on whiteboard
function handleWbDrop(e) {
  const data = e.dataTransfer?.getData('text/plain');
  if(data && data.startsWith('kb:')) {
    e.preventDefault();
    const kbId = data.replace('kb:','');
    const k = (S.knowledgeBase||[]).find(x=>x.id===kbId);
    if(!k) return;
    const p = wbScreenToCanvas(e.clientX, e.clientY);
    const typeColors = {md:'#3b82f6',pdf:'#ef4444',img:'#22c55e',url:'#8b5cf6',txt:'#6b7280',json:'#eab308',other:'#6b7280'};
    const n = wbAddNode(p.x-80, p.y-40, '['+k.type.toUpperCase()+'] '+k.name, k.description||'', typeColors[k.type]||'#3b82f6', 200, 90);
    n.docRef = kbId;
    n.docType = k.type;
    wbSaveState();
    toast('Added to whiteboard');
  }
}

// projectId assignment for links is handled directly in saveLink()

// === GLOBAL ===
function exportAll(){snapshotWriter();snapshotSpec();if(activeProject){const p=getProject(activeProject);if(p){p.instructions=document.getElementById('proj-instructions-editor')?.innerHTML||p.instructions;}}const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-hub-'+new Date().toISOString().split('T')[0]+'.json';a.click();toast('Exported');}
function exportSummary(){
  snapshotWriter();snapshotSpec();
  const today=new Date().toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const done=S.tasks.filter(t=>t.status==='done');
  const overdue=active.filter(t=>t.due&&t.due<today);
  const priorities={p0:active.filter(t=>t.priority==='p0').length,p1:active.filter(t=>t.priority==='p1').length,p2:active.filter(t=>t.priority==='p2').length,p3:active.filter(t=>t.priority==='p3').length};
  let md='# SATURNO HUB Summary\n';
  md+=`**Generated:** ${new Date().toLocaleString()}\n\n`;
  md+='---\n\n## Tasks\n';
  md+=`- **Active:** ${active.length} | **Done:** ${done.length} | **Overdue:** ${overdue.length}\n`;
  md+=`- **By Priority:** P0=${priorities.p0} P1=${priorities.p1} P2=${priorities.p2} P3=${priorities.p3}\n\n`;
  if(overdue.length){md+='### Overdue\n';overdue.forEach(t=>{md+=`- [${t.priority||'p2'}] ${t.title} (due ${t.due})\n`;});md+='\n';}
  const todayTasks=active.filter(t=>t.due===today);
  if(todayTasks.length){md+='### Due Today\n';todayTasks.forEach(t=>{md+=`- [${t.priority||'p2'}] ${t.title}\n`;});md+='\n';}
  md+='## Content\n';
  md+=`- **Items:** ${S.content.length}\n`;
  const totalW=S.content.reduce((s,c)=>(c.body||'').trim().split(/\s+/).filter(x=>x.length).length+s,0);
  md+=`- **Total words:** ${totalW.toLocaleString()}\n\n`;
  md+='## Documents\n';
  md+=`- **Writer docs:** ${(S.docs||[]).length}\n`;
  md+=`- **Living Docs:** ${(S.specs||[]).length}\n\n`;
  md+='## Links\n';
  md+=`- **Total:** ${(S.links||[]).length}\n`;
  const cats=[...new Set((S.links||[]).map(l=>l.category).filter(Boolean))];
  if(cats.length)md+=`- **Categories:** ${cats.join(', ')}\n`;
  md+='\n## Projects\n';
  (S.projects||[]).forEach(p=>{
    const pt=S.tasks.filter(t=>(t.projectId||t.project)===p.id);
    const pa=pt.filter(t=>t.status!=='done').length;
    md+=`- **${p.name}** (${p.status||'active'}) — ${pa} active tasks\n`;
  });
  md+='\n## Repos\n';
  (S.repos||[]).forEach(r=>{md+=`- ${r.name} — ${r.live||'no live URL'} (${r.status||'unknown'})\n`;});
  md+='\n---\n*Exported from SATURNO HUB*\n';
  navigator.clipboard.writeText(md).then(()=>toast('Summary copied to clipboard')).catch(()=>{
    const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='saturno-summary-'+today+'.md';a.click();toast('Summary downloaded');
  });
}
function dailyDashboard(){
  const today=new Date().toISOString().split('T')[0];
  const todayLabel=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const active=S.tasks.filter(t=>t.status!=='done');
  const overdue=active.filter(t=>t.due&&t.due<today);
  const dueToday=active.filter(t=>t.due===today);
  const inProgress=active.filter(t=>t.status==='progress');
  const blocked=active.filter(t=>t.status==='blocked');
  const doneToday=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at&&e.at.startsWith(today)));
  const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const doneThisWeek=S.tasks.filter(t=>t.status==='done'&&t.log&&t.log.some(e=>e.to==='done'&&e.at>=weekStart.toISOString()));
  let md='# Daily Dashboard: '+todayLabel+'\n\n';
  md+='## Priority Focus\n';
  if(overdue.length){md+='### OVERDUE ('+overdue.length+')\n';overdue.forEach(t=>md+='- ['+t.priority+'] '+t.title+' (due '+t.due+')\n');md+='\n';}
  if(dueToday.length){md+='### Due Today ('+dueToday.length+')\n';dueToday.forEach(t=>md+='- ['+t.priority+'] '+t.title+(t.project?' ['+t.project+']':'')+'\n');md+='\n';}
  if(inProgress.length){md+='### In Progress ('+inProgress.length+')\n';inProgress.forEach(t=>md+='- '+t.title+(t.timeStarted?' (timer running)':'')+(t.estimate?' ~'+t.estimate:'')+'\n');md+='\n';}
  if(blocked.length){md+='### Blocked ('+blocked.length+')\n';blocked.forEach(t=>md+='- '+t.title+(t.blockedBy?' (by: '+t.blockedBy+')':'')+'\n');md+='\n';}
  md+='## Stats\n';
  md+='- Tasks: '+active.length+' active, '+doneToday.length+' done today, '+doneThisWeek.length+' done this week\n';
  md+='- Content: '+S.content.length+' items\n';
  md+='- Documents: '+S.docs.length+' docs, '+S.specs.length+' living docs\n';
  md+='- Links: '+S.links.length+'\n';
  const tracked=S.tasks.filter(t=>t.timeSpent||t.timeStarted);
  if(tracked.length){let total=0;tracked.forEach(t=>{let m=t.timeSpent||0;if(t.timeStarted)m+=Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);total+=m;});md+='- Time tracked: '+formatTimeSpent(total)+' across '+tracked.length+' tasks\n';}
  md+='\n---\n*Generated from SATURNO HUB*\n';
  navigator.clipboard.writeText(md).then(()=>toast('Daily dashboard copied to clipboard'));
}
function dataStats(){
  const raw=localStorage.getItem(SK)||'';const bytes=new Blob([raw]).size;const kb=(bytes/1024).toFixed(1);
  const taskBytes=new Blob([JSON.stringify(S.tasks)]).size;
  const contentBytes=new Blob([JSON.stringify(S.content)]).size;
  const docsBytes=new Blob([JSON.stringify(S.docs)]).size;
  const specsBytes=new Blob([JSON.stringify(S.specs||[])]).size;
  const linksBytes=new Blob([JSON.stringify(S.links)]).size;
  const kbBytes=new Blob([JSON.stringify(S.knowledgeBase||[])]).size;
  const format=b=>(b/1024).toFixed(1)+'KB';
  const msg=`Storage: ${kb}KB total\n\nTasks: ${S.tasks.length} items (${format(taskBytes)})\nContent: ${S.content.length} items (${format(contentBytes)})\nDocs: ${(S.docs||[]).length} items (${format(docsBytes)})\nSpecs: ${(S.specs||[]).length} items (${format(specsBytes)})\nLinks: ${S.links.length} items (${format(linksBytes)})\nKB: ${(S.knowledgeBase||[]).length} items (${format(kbBytes)})\nRepos: ${(S.repos||[]).length}\nProjects: ${(S.projects||[]).length}\nArchived: ${(S.archivedTasks||[]).length} tasks`;
  toast(msg.split('\n')[0]);
  navigator.clipboard.writeText(msg).then(()=>toast('Stats copied to clipboard'));
}
function timeReport(){
  const tracked=S.tasks.filter(t=>t.timeSpent||t.timeStarted);
  if(!tracked.length){toast('No tasks with tracked time');return;}
  let total=0;
  let md='# Time Report\n'+new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})+'\n\n';
  tracked.sort((a,b)=>(b.timeSpent||0)-(a.timeSpent||0));
  tracked.forEach(t=>{
    let mins=t.timeSpent||0;
    if(t.timeStarted)mins+=Math.round((Date.now()-new Date(t.timeStarted).getTime())/60000);
    total+=mins;
    md+=`- **${t.title||'Untitled'}** (${t.status}) — ${formatTimeSpent(mins)}${t.project?' ['+t.project+']':''}\n`;
  });
  md+=`\n**Total tracked: ${formatTimeSpent(total)}** across ${tracked.length} tasks`;
  navigator.clipboard.writeText(md).then(()=>toast('Time report copied — '+formatTimeSpent(total)+' total'));
}
function importAll(){
  // Auto-backup before import (UNDO safety net)
  const backup = localStorage.getItem(SK);
  if(backup) { localStorage.setItem(SK+'_backup', backup); localStorage.setItem(SK+'_backup_time', new Date().toISOString()); }
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const f=e.target.files[0],r=new FileReader();r.onload=ev=>{try{S={content:[],tasks:[],links:[],docs:[],specs:[],activeDoc:null,activeSpec:null,whiteboard:{},projects:[],knowledgeBase:[],folders:[],...JSON.parse(ev.target.result)};if(!S.projects)S.projects=[];if(!S.knowledgeBase)S.knowledgeBase=[];save();renderProjectsSidebar();switchSection(currentSection||'content',document.querySelector('.sidebar-item.active'));toast('Imported (backup saved — click Undo Import to revert)');}catch(e){toast('Invalid JSON');}};r.readAsText(f);};inp.click();
}
function undoImport(){
  const backup = localStorage.getItem(SK+'_backup');
  if(!backup) { toast('No backup available'); return; }
  const time = localStorage.getItem(SK+'_backup_time');
  S = {content:[],tasks:[],links:[],docs:[],specs:[],activeDoc:null,activeSpec:null,whiteboard:{},projects:[],knowledgeBase:[],...JSON.parse(backup)};
  if(!S.projects)S.projects=[];if(!S.knowledgeBase)S.knowledgeBase=[];
  save();renderProjectsSidebar();switchSection('content',document.querySelector('.sidebar-item'));
  toast('Reverted to backup from '+(time||'unknown'));
}

// === PROJECT EXPORT ===
let exportMenuOpen = false;
function showExportMenu(e) {
  e.stopPropagation();
  if(exportMenuOpen) { closeExportMenu(); return; }
  const existing = document.querySelector('.export-menu');
  if(existing) existing.remove();
  const menu = document.createElement('div');
  menu.className = 'export-menu';
  menu.innerHTML = `
    <div class="export-menu-item" onclick="exportProjectMD()">
      <span class="export-icon">MD</span>
      <div><div class="export-menu-label">Markdown</div><div class="export-menu-desc">Full project as .md file</div></div>
    </div>
    <div class="export-menu-item" onclick="exportProjectJSON()">
      <span class="export-icon">{ }</span>
      <div><div class="export-menu-label">JSON</div><div class="export-menu-desc">Raw data for import</div></div>
    </div>
    <div class="export-menu-item" onclick="copyProjectMD()">
      <span class="export-icon">CP</span>
      <div><div class="export-menu-label">Copy as Markdown</div><div class="export-menu-desc">Copy to clipboard</div></div>
    </div>
  `;
  document.querySelector('.project-header-actions').appendChild(menu);
  exportMenuOpen = true;
  setTimeout(() => document.addEventListener('click', closeExportMenu, {once:true}), 10);
}
function closeExportMenu() {
  const m = document.querySelector('.export-menu');
  if(m) m.remove();
  exportMenuOpen = false;
}
function buildProjectMD() {
  const p = getProject(activeProject);
  if(!p) return '';
  const kbItems = (S.knowledgeBase||[]).filter(k => k.projectId === activeProject);
  const docs = (S.specs||[]).filter(s => s.projectId === activeProject);
  const tasks = getProjectTasks(activeProject);
  const links = (S.links||[]).filter(l => l.projectId === activeProject);
  // Convert HTML instructions to readable text
  const div = document.createElement('div');
  div.innerHTML = p.instructions || '';
  const instrText = div.innerText || div.textContent || '';
  let md = `# ${p.name}\n`;
  md += `**Status:** ${p.status} | **Icon:** ${p.icon} | **Color:** ${p.color}\n`;
  md += `**Updated:** ${p.updated || p.created}\n\n`;
  md += `---\n\n## Instructions\n\n${instrText}\n\n`;
  if(kbItems.length) {
    md += `---\n\n## Knowledge Base (${kbItems.length} items)\n\n`;
    kbItems.forEach(k => {
      md += `### ${k.name}\n`;
      md += `**Type:** ${k.type} | **Storage:** ${k.storage}\n`;
      if(k.description) md += `${k.description}\n`;
      if(k.tags && k.tags.length) md += `**Tags:** ${k.tags.join(', ')}\n`;
      if(k.content && k.type !== 'img') md += `\n${k.content}\n`;
      if(k.filePath) md += `**File:** ${k.filePath}\n`;
      if(k.url) md += `**URL:** ${k.url}\n`;
      md += '\n';
    });
  }
  if(docs.length) {
    md += `---\n\n## Living Docs (${docs.length})\n\n`;
    docs.forEach(d => {
      md += `### ${d.title}\n`;
      if(d.sections) d.sections.forEach(s => {
        md += `#### ${s.title}\n`;
        const sdiv = document.createElement('div');
        sdiv.innerHTML = s.body || '';
        md += (sdiv.innerText || '') + '\n\n';
      });
    });
  }
  if(tasks.length) {
    md += `---\n\n## Tasks (${tasks.length})\n\n`;
    tasks.forEach(t => {
      const check = t.status === 'done' ? 'x' : ' ';
      md += `- [${check}] ${t.title} (${t.status}${t.due ? ', due: '+t.due : ''})\n`;
    });
    md += '\n';
  }
  if(links.length) {
    md += `---\n\n## Links (${links.length})\n\n`;
    links.forEach(l => {
      md += `- [${l.title}](${l.url})${l.desc ? ' — '+l.desc : ''}\n`;
    });
    md += '\n';
  }
  md += `---\n\n*Exported from ASTRA Command Center on ${new Date().toISOString().split('T')[0]}*\n`;
  return md;
}
function exportProjectMD() {
  const p = getProject(activeProject);
  if(!p) return;
  const md = buildProjectMD();
  const blob = new Blob([md], {type:'text/markdown'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-') + '.md';
  a.click();
  closeExportMenu();
  toast('Exported as Markdown');
}
function exportProjectJSON() {
  const p = getProject(activeProject);
  if(!p) return;
  const data = {
    project: p,
    knowledgeBase: (S.knowledgeBase||[]).filter(k => k.projectId === activeProject),
    livingDocs: (S.specs||[]).filter(s => s.projectId === activeProject),
    tasks: getProjectTasks(activeProject),
    links: (S.links||[]).filter(l => l.projectId === activeProject),
    exportedAt: new Date().toISOString(),
    exportedFrom: 'ASTRA Command Center'
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-') + '.json';
  a.click();
  closeExportMenu();
  toast('Exported as JSON');
}
function copyProjectMD() {
  const md = buildProjectMD();
  navigator.clipboard.writeText(md).then(() => {
    closeExportMenu();
    toast('Copied to clipboard');
  }).catch(() => {
    closeExportMenu();
    toast('Copy failed — try Export instead');
  });
}

// === VOICE INPUT ===
let voiceTarget = null, voiceActive = false, voiceRecorder = null, voiceChunks = [];
function initVoice() { /* MediaRecorder init happens on toggle */ }
async function toggleVoice(target) {
  voiceTarget = target;
  if(voiceActive && voiceRecorder && voiceRecorder.state === 'recording') {
    voiceRecorder.stop();
    voiceActive = false;
    updateVoiceUI();
    toast('Processing with Whisper...');
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    voiceChunks = [];
    voiceRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    voiceRecorder.ondataavailable = e => { if(e.data.size > 0) voiceChunks.push(e.data); };
    voiceRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(voiceChunks, { type: 'audio/webm' });
      if(blob.size < 100) { toast('Recording too short'); return; }
      toast('Transcribing...');
      try {
        const fd = new FormData();
        fd.append('audio', blob, 'recording.webm');
        const res = await fetch(ASTRA_API + '/api/transcribe', { method: 'POST', headers: { 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW }, body: fd });
        const data = await res.json();
        if(data.ok && data.text) {
          const el = voiceTarget === 'writer' ? document.getElementById('writer-editor') : document.querySelector('.specs-section-editor:focus') || document.querySelector('.specs-section-editor');
          if(el) { el.focus(); document.execCommand('insertText', false, data.text + ' '); if(voiceTarget==='writer') onWriterChange(); else onSpecChange(); }
          toast('Whisper: ' + data.text.substring(0, 60) + (data.text.length > 60 ? '...' : ''));
        } else { toast('Transcription failed: ' + (data.error || 'unknown')); }
      } catch(e) { toast('Whisper error: ' + e.message); }
    };
    voiceRecorder.start();
    voiceActive = true;
    updateVoiceUI();
    toast('Recording... click again to stop');
  } catch(e) { toast('Mic access denied'); }
}
function updateVoiceUI() {
  const wb = document.getElementById('writer-voice-btn'), sb = document.getElementById('specs-voice-btn');
  if(wb) wb.classList.toggle('recording', voiceActive && voiceTarget === 'writer');
  if(sb) sb.classList.toggle('recording', voiceActive && voiceTarget === 'specs');
}

// === WHITEBOARD ENGINE ===
let wbNodes = [], wbConns = [], wbTool = 'select', wbScale = 1, wbPanX = 0, wbPanY = 0;
let wbDrag = null, wbConnStart = null, wbPanning = false, wbPanStart = null;
let wbSelected = null, wbResizing = null, wbGrid = true;
let wbHistory = [], wbHistoryIdx = -1, wbNodeId = 100;
const COLORS = ['#3b82f6','#8b5cf6','#06b6d4','#22c55e','#eab308','#f97316','#ef4444','#ec4899'];
const STICKY_COLORS = ['#fef08a','#bbf7d0','#bfdbfe','#fbcfe8','#fde68a','#c4b5fd'];

function wbSaveState() {
  wbHistory = wbHistory.slice(0, wbHistoryIdx + 1);
  wbHistory.push(JSON.stringify({nodes:wbNodes,conns:wbConns}));
  if(wbHistory.length > 50) wbHistory.shift();
  wbHistoryIdx = wbHistory.length - 1;
  wbPersist();
}
function wbUndo() { if(wbHistoryIdx > 0) { wbHistoryIdx--; wbRestoreHistory(); }}
function wbRedo() { if(wbHistoryIdx < wbHistory.length - 1) { wbHistoryIdx++; wbRestoreHistory(); }}
function wbRestoreHistory() { const d = JSON.parse(wbHistory[wbHistoryIdx]); wbNodes = d.nodes; wbConns = d.conns; wbRender(); wbPersist(); }
function wbPersist() { if(!S.whiteboard) S.whiteboard = {}; S.whiteboard = {nodes:wbNodes,conns:wbConns,panX:wbPanX,panY:wbPanY,scale:wbScale}; save(); }
function wbLoadState() { if(S.whiteboard) { wbNodes = S.whiteboard.nodes || []; wbConns = S.whiteboard.conns || []; wbPanX = S.whiteboard.panX || 0; wbPanY = S.whiteboard.panY || 0; wbScale = S.whiteboard.scale || 1; wbNodeId = Math.max(100, ...wbNodes.map(n=>n.id)) + 1; } wbSaveState(); }

function wbSetTool(t) { wbTool = t; document.querySelectorAll('.wb-tool[data-tool]').forEach(b => b.classList.toggle('active', b.dataset.tool === t)); const w = document.getElementById('wb-canvas-wrap'); w.style.cursor = t==='hand'?'grab':t==='connect'?'crosshair':t==='node'||t==='text'||t==='sticky'?'cell':'default'; }
function wbToggleGrid() { wbGrid = !wbGrid; wbRender(); toast(wbGrid ? 'Grid on' : 'Grid off'); }
function wbZoom(d) { wbScale = Math.max(0.2, Math.min(3, wbScale + d)); document.getElementById('wb-zoom-level').textContent = Math.round(wbScale * 100) + '%'; wbUpdateTransform(); wbUpdateMinimap(); }
function wbWheel(e) { e.preventDefault(); wbZoom(e.deltaY > 0 ? -0.05 : 0.05); }
function wbUpdateTransform() { document.getElementById('wb-canvas').style.transform = `translate(${wbPanX}px,${wbPanY}px) scale(${wbScale})`; }

function wbSnap(v) { return wbGrid ? Math.round(v / 20) * 20 : v; }
function wbScreenToCanvas(x, y) { const r = document.getElementById('wb-canvas-wrap').getBoundingClientRect(); return { x: (x - r.left - wbPanX) / wbScale, y: (y - r.top - wbPanY) / wbScale }; }

function wbAddNode(x, y, title, body, color, w, h, type) {
  const n = { id: wbNodeId++, x: wbSnap(x), y: wbSnap(y), w: w||160, h: h||80, title: title||'', body: body||'', color: color||COLORS[0], type: type||'node' };
  wbNodes.push(n);
  wbSaveState();
  wbRender();
  return n;
}
function wbDuplicateNode(id){
  const n=wbNodes.find(x=>x.id===id);if(!n)return;
  wbAddNode(n.x+30,n.y+30,n.title+' (copy)',n.body,n.color,n.w,n.h,n.type);
  toast('Node duplicated');
}
function wbToggleLock(id){
  const n=wbNodes.find(x=>x.id===id);if(!n)return;
  n.locked=!n.locked;wbSaveState();wbRender();toast(n.locked?'Node locked':'Node unlocked');
}

function wbRender() {
  const canvas = document.getElementById('wb-canvas');
  const svgEl = document.getElementById('wb-svg');
  // Grid
  let gridHtml = '';
  if(wbGrid) {
    const gs = 20;
    gridHtml = `<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="wbgrid" width="${gs}" height="${gs}" patternUnits="userSpaceOnUse"><path d="M ${gs} 0 L 0 0 0 ${gs}" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="0.5"/></pattern></defs><rect width="100%" height="100%" fill="url(#wbgrid)"/></svg>`;
  }
  // Nodes
  let nodesHtml = wbNodes.map(n => {
    const isSel = wbSelected === n.id;
    const isSticky = n.type === 'sticky';
    const bg = isSticky ? n.color : 'var(--bg-surface)';
    const textColor = isSticky ? '#1a1a24' : 'var(--text)';
    return `<div class="wb-node ${isSel?'selected':''}" data-id="${n.id}" style="left:${n.x}px;top:${n.y}px;width:${n.w}px;min-height:${n.h}px;background:${bg}${n.locked?';border-style:dashed;opacity:0.85':''}${n._highlight?';box-shadow:0 0 12px 3px var(--accent),0 0 0 2px var(--accent);z-index:100':''}" onmousedown="wbNodeDown(event,${n.id})">
      ${!isSticky?`<div class="wb-node-color" style="background:${n.color}"></div>`:''}
      <div class="wb-node-header" contenteditable="true" style="color:${textColor}" onblur="wbNodeEdit(${n.id},'title',this.textContent)" onclick="event.stopPropagation()">${esc(n.title)}</div>
      <div class="wb-node-body" contenteditable="true" style="color:${isSticky?'#333':'var(--text-secondary)'}" onblur="wbNodeEdit(${n.id},'body',this.textContent)" onclick="event.stopPropagation()">${esc(n.body)}</div>
      <button class="wb-node-del" onclick="event.stopPropagation();wbDeleteNode(${n.id})">x</button>
      <button class="wb-node-dup" onclick="event.stopPropagation();wbDuplicateNode(${n.id})" style="position:absolute;top:-8px;right:14px;width:18px;height:18px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:10px;cursor:pointer;display:none;align-items:center;justify-content:center;z-index:20" title="Duplicate">+</button>
      <button onclick="event.stopPropagation();wbToggleLock(${n.id})" style="position:absolute;bottom:2px;left:2px;width:14px;height:14px;border:none;background:none;color:${n.locked?'var(--yellow)':'var(--text-muted)'};cursor:pointer;font-size:8px;opacity:${n.locked?'0.8':'0'};transition:opacity 0.15s;z-index:20" class="wb-lock-btn" title="${n.locked?'Unlock':'Lock'}">${n.locked?'L':'L'}</button>
      <button class="wb-node-color-btn" onclick="event.stopPropagation();wbPickColor(${n.id})" style="position:absolute;top:2px;right:20px;width:14px;height:14px;border:none;border-radius:50%;background:${n.color};cursor:pointer;opacity:0;transition:opacity 0.15s" title="Change color"></button>
      <div class="wb-node-resize" onmousedown="event.stopPropagation();wbResizeStart(event,${n.id})"></div>
      <div class="wb-node-port wb-port-right" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'right')"></div>
      <div class="wb-node-port wb-port-bottom" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'bottom')"></div>
      <div class="wb-node-port wb-port-left" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'left')"></div>
      <div class="wb-node-port wb-port-top" onmousedown="event.stopPropagation();wbConnStartFn(event,${n.id},'top')"></div>
    </div>`;
  }).join('');
  // SVG connections
  let svgPaths = wbConns.map(c => {
    const from = wbNodes.find(n => n.id === c.from);
    const to = wbNodes.find(n => n.id === c.to);
    if(!from || !to) return '';
    const fx = from.x + from.w / 2, fy = from.y + from.h / 2;
    const tx = to.x + to.w / 2, ty = to.y + to.h / 2;
    const mx = (fx + tx) / 2, my = (fy + ty) / 2;
    const dx = tx - fx, dy = ty - fy;
    const cx1 = fx + dx * 0.4, cy1 = fy;
    const cx2 = tx - dx * 0.4, cy2 = ty;
    return `<path d="M${fx},${fy} C${cx1},${cy1} ${cx2},${cy2} ${tx},${ty}" fill="none" stroke="${c.color||'rgba(59,130,246,0.5)'}" stroke-width="2" marker-end="url(#arrow)"/>`;
  }).join('');
  const svgContent = `<defs><marker id="arrow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="rgba(59,130,246,0.6)"/></marker></defs>${svgPaths}`;
  canvas.innerHTML = `<div class="wb-grid">${gridHtml}</div><svg class="wb-svg" style="width:5000px;height:5000px">${svgContent}</svg>${nodesHtml}`;
  wbUpdateTransform();
  wbUpdateMinimap();
  const wbStatsEl=document.getElementById('wb-stats');if(wbStatsEl)wbStatsEl.textContent=wbNodes.length+'n / '+wbConns.length+'c';
}

function wbUpdateMinimap() {
  const mm = document.getElementById('wb-minimap');
  if(!wbNodes.length) { mm.innerHTML = ''; return; }
  const minX = Math.min(...wbNodes.map(n=>n.x)), maxX = Math.max(...wbNodes.map(n=>n.x+n.w));
  const minY = Math.min(...wbNodes.map(n=>n.y)), maxY = Math.max(...wbNodes.map(n=>n.y+n.h));
  const pad = 100, rw = maxX - minX + pad * 2, rh = maxY - minY + pad * 2;
  const mmW = 160, mmH = 100, sx = mmW / rw, sy = mmH / rh, s = Math.min(sx, sy);
  const wrap = document.getElementById('wb-canvas-wrap');
  const vx = (-wbPanX / wbScale - minX + pad) * s, vy = (-wbPanY / wbScale - minY + pad) * s;
  const vw = (wrap.clientWidth / wbScale) * s, vh = (wrap.clientHeight / wbScale) * s;
  mm.innerHTML = wbNodes.map(n => `<div class="wb-minimap-node" style="left:${(n.x-minX+pad)*s}px;top:${(n.y-minY+pad)*s}px;width:${Math.max(2,n.w*s)}px;height:${Math.max(2,n.h*s)}px"></div>`).join('') + `<div class="wb-minimap-viewport" style="left:${vx}px;top:${vy}px;width:${vw}px;height:${vh}px"></div>`;
}

function wbNodeDown(e, id) {
  e.stopPropagation();
  if(wbTool === 'connect') return;
  wbSelected = id;
  const n = wbNodes.find(x => x.id === id);
  if(!n) return;
  if(n.locked){toast('Node is locked');return;}
  wbDrag = { id, ox: e.clientX, oy: e.clientY, sx: n.x, sy: n.y };
  wbRender();
}

function wbCanvasDown(e) {
  if(e.button === 2 || wbTool === 'hand') { wbPanning = true; wbPanStart = { x: e.clientX - wbPanX, y: e.clientY - wbPanY }; document.getElementById('wb-canvas-wrap').style.cursor = 'grabbing'; return; }
  if(wbTool === 'node') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 80, p.y - 40, 'New Node', ''); return; }
  if(wbTool === 'text') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 60, p.y - 20, 'Text', '', '#8b5cf6', 140, 50, 'text'); return; }
  if(wbTool === 'sticky') { const p = wbScreenToCanvas(e.clientX, e.clientY); wbAddNode(p.x - 70, p.y - 50, '', 'Note...', STICKY_COLORS[Math.floor(Math.random()*STICKY_COLORS.length)], 160, 120, 'sticky'); return; }
  wbSelected = null; wbRender();
}

function wbCanvasMove(e) {
  if(wbPanning && wbPanStart) { wbPanX = e.clientX - wbPanStart.x; wbPanY = e.clientY - wbPanStart.y; wbUpdateTransform(); wbUpdateMinimap(); return; }
  if(wbDrag) { const n = wbNodes.find(x => x.id === wbDrag.id); if(n) { n.x = wbSnap(wbDrag.sx + (e.clientX - wbDrag.ox) / wbScale); n.y = wbSnap(wbDrag.sy + (e.clientY - wbDrag.oy) / wbScale); wbRender(); } return; }
  if(wbResizing) { const n = wbNodes.find(x => x.id === wbResizing.id); if(n) { n.w = Math.max(80, wbSnap(wbResizing.sw + (e.clientX - wbResizing.ox) / wbScale)); n.h = Math.max(40, wbSnap(wbResizing.sh + (e.clientY - wbResizing.oy) / wbScale)); wbRender(); } return; }
}

function wbCanvasUp(e) {
  if(wbDrag) { wbSaveState(); }
  if(wbResizing) { wbSaveState(); }
  if(wbPanning) { wbPersist(); }
  wbDrag = null; wbPanning = false; wbPanStart = null; wbResizing = null;
  document.getElementById('wb-canvas-wrap').style.cursor = wbTool === 'hand' ? 'grab' : wbTool === 'connect' ? 'crosshair' : wbTool === 'node' || wbTool === 'text' || wbTool === 'sticky' ? 'cell' : 'default';
}

function wbResizeStart(e, id) { const n = wbNodes.find(x => x.id === id); if(n) wbResizing = { id, ox: e.clientX, oy: e.clientY, sw: n.w, sh: n.h }; }
function wbNodeEdit(id, field, val) { const n = wbNodes.find(x => x.id === id); if(n) { n[field] = val; wbSaveState(); }}
function wbSearchNodes(q){
  const ql=q.toLowerCase().trim();
  wbNodes.forEach(n=>{n._highlight=false;});
  if(ql){
    const matches=wbNodes.filter(n=>(n.title||'').toLowerCase().includes(ql)||(n.body||'').toLowerCase().includes(ql));
    matches.forEach(n=>{n._highlight=true;});
    if(matches.length===1){const n=matches[0];const wrap=document.getElementById('wb-canvas-wrap');wbPanX=-(n.x-wrap.clientWidth/2+n.w/2)*wbScale;wbPanY=-(n.y-wrap.clientHeight/2+n.h/2)*wbScale;wbUpdateTransform();}
    toast(matches.length+' node'+(matches.length!==1?'s':'')+' found');
  }
  wbRender();
}
function wbPickColor(id){
  const n=wbNodes.find(x=>x.id===id);if(!n)return;
  const colors=['#4ade80','#22d3ee','#3b82f6','#a855f7','#f472b6','#f87171','#fbbf24','#fb923c','#6366f1','#14b8a6','#ef4444','#84cc16'];
  const el=document.createElement('div');
  el.style.cssText='position:fixed;z-index:9999;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:8px;display:grid;grid-template-columns:repeat(4,24px);gap:4px;box-shadow:0 8px 24px rgba(0,0,0,0.5)';
  el.style.left=(event.clientX-40)+'px';el.style.top=(event.clientY+10)+'px';
  colors.forEach(c=>{const b=document.createElement('div');b.style.cssText='width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid '+(n.color===c?'white':'transparent');b.style.background=c;b.onclick=()=>{n.color=c;wbSaveState();wbRender();el.remove();};el.appendChild(b);});
  document.body.appendChild(el);
  const close=e=>{if(!el.contains(e.target)){el.remove();document.removeEventListener('mousedown',close);}};
  setTimeout(()=>document.addEventListener('mousedown',close),10);
}
function wbDeleteNode(id) { wbNodes = wbNodes.filter(n => n.id !== id); wbConns = wbConns.filter(c => c.from !== id && c.to !== id); if(wbSelected === id) wbSelected = null; wbSaveState(); wbRender(); toast('Deleted'); }
function wbConnStartFn(e, id, port) { wbConnStart = { id, port }; wbTool = 'connect'; document.getElementById('wb-canvas-wrap').style.cursor = 'crosshair'; document.addEventListener('mouseup', wbConnEnd, { once: true }); }
function wbConnEnd(e) {
  if(!wbConnStart) return;
  const el = document.elementFromPoint(e.clientX, e.clientY);
  const nodeEl = el?.closest?.('.wb-node');
  if(nodeEl) {
    const toId = parseInt(nodeEl.dataset.id);
    if(toId !== wbConnStart.id && !wbConns.find(c => c.from === wbConnStart.id && c.to === toId)) {
      wbConns.push({ from: wbConnStart.id, to: toId, color: 'rgba(59,130,246,0.5)' });
      wbSaveState(); wbRender();
    }
  }
  wbConnStart = null; wbSetTool('select');
}

function wbClearAll() { if(!wbNodes.length) return; wbNodes = []; wbConns = []; wbSelected = null; wbSaveState(); wbRender(); toast('Cleared'); }
function wbFitView() {
  if(!wbNodes.length) return;
  const wrap = document.getElementById('wb-canvas-wrap');
  const minX = Math.min(...wbNodes.map(n=>n.x)), maxX = Math.max(...wbNodes.map(n=>n.x+n.w));
  const minY = Math.min(...wbNodes.map(n=>n.y)), maxY = Math.max(...wbNodes.map(n=>n.y+n.h));
  const rw = maxX - minX + 100, rh = maxY - minY + 100;
  wbScale = Math.min(wrap.clientWidth / rw, wrap.clientHeight / rh, 1.5);
  wbPanX = (wrap.clientWidth - rw * wbScale) / 2 - minX * wbScale + 50 * wbScale;
  wbPanY = (wrap.clientHeight - rh * wbScale) / 2 - minY * wbScale + 50 * wbScale;
  document.getElementById('wb-zoom-level').textContent = Math.round(wbScale * 100) + '%';
  wbUpdateTransform(); wbUpdateMinimap(); wbPersist();
}

function wbAutoLayout() {
  if(!wbNodes.length) return;
  const cols = Math.ceil(Math.sqrt(wbNodes.length));
  wbNodes.forEach((n, i) => { n.x = (i % cols) * 220 + 60; n.y = Math.floor(i / cols) * 140 + 60; });
  wbSaveState(); wbRender(); wbFitView(); toast('Auto-arranged');
}

function wbClusterByType(){
  if(!wbNodes.length)return;
  const byType={};wbNodes.forEach(n=>{const t=n.type||'note';if(!byType[t])byType[t]=[];byType[t].push(n);});
  const types=Object.keys(byType).sort();
  const cols=Math.ceil(Math.sqrt(types.length));
  const clusterW=300;const clusterH=250;const gap=60;
  types.forEach((type,ti)=>{
    const cx=(ti%cols)*(clusterW+gap)+gap;const cy=Math.floor(ti/cols)*(clusterH+gap)+gap;
    const nodes=byType[type];const innerCols=Math.ceil(Math.sqrt(nodes.length));
    nodes.forEach((n,ni)=>{n.x=cx+(ni%innerCols)*180+20;n.y=cy+Math.floor(ni/innerCols)*100+40;});
  });
  wbSaveState();wbRender();wbFitView();toast('Clustered by type ('+types.length+' groups)');
}
function wbExport(fmt) {
  if(!fmt) return;
  if(fmt === 'text') {
    let md='# Whiteboard Outline\n\n';
    const byType={};wbNodes.forEach(n=>{const t=n.type||'note';if(!byType[t])byType[t]=[];byType[t].push(n);});
    Object.entries(byType).sort().forEach(([type,nodes])=>{md+='## '+type.charAt(0).toUpperCase()+type.slice(1)+' ('+nodes.length+')\n\n';nodes.forEach(n=>{md+='- **'+n.title+'**'+(n.body?' - '+n.body:'')+'\n';});md+='\n';});
    const connText=wbConns.map(c=>{const f=wbNodes.find(n=>n.id===c.from),t=wbNodes.find(n=>n.id===c.to);return f&&t?'- '+f.title+' -> '+t.title:null;}).filter(Boolean);
    if(connText.length){md+='## Connections\n\n'+connText.join('\n')+'\n';}
    navigator.clipboard.writeText(md).then(()=>toast('Outline copied ('+wbNodes.length+' nodes)'));return;
  }
  if(fmt === 'json') { const blob = new Blob([JSON.stringify({nodes:wbNodes,conns:wbConns},null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.json'; a.click(); toast('JSON exported'); return; }
  if(fmt === 'png' || fmt === 'svg') {
    const canvas = document.createElement('canvas');
    const minX = wbNodes.length ? Math.min(...wbNodes.map(n=>n.x)) - 40 : 0;
    const minY = wbNodes.length ? Math.min(...wbNodes.map(n=>n.y)) - 40 : 0;
    const maxX = wbNodes.length ? Math.max(...wbNodes.map(n=>n.x+n.w)) + 40 : 800;
    const maxY = wbNodes.length ? Math.max(...wbNodes.map(n=>n.y+n.h)) + 40 : 600;
    const w = maxX - minX, h = maxY - minY;
    if(fmt === 'svg') {
      let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><rect width="${w}" height="${h}" fill="#0a0a0f"/>`;
      wbConns.forEach(c => { const from = wbNodes.find(n=>n.id===c.from), to = wbNodes.find(n=>n.id===c.to); if(from&&to) svg += `<line x1="${from.x+from.w/2-minX}" y1="${from.y+from.h/2-minY}" x2="${to.x+to.w/2-minX}" y2="${to.y+to.h/2-minY}" stroke="#3b82f6" stroke-width="2"/>`; });
      wbNodes.forEach(n => { svg += `<rect x="${n.x-minX}" y="${n.y-minY}" width="${n.w}" height="${n.h}" rx="6" fill="${n.type==='sticky'?n.color:'#12121a'}" stroke="#3b82f6" stroke-width="1"/><text x="${n.x-minX+10}" y="${n.y-minY+20}" fill="${n.type==='sticky'?'#1a1a24':'#fff'}" font-size="12" font-family="system-ui">${esc(n.title)}</text>`; });
      svg += '</svg>';
      const blob = new Blob([svg],{type:'image/svg+xml'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.svg'; a.click(); toast('SVG exported');
    } else {
      canvas.width = w * 2; canvas.height = h * 2;
      const ctx = canvas.getContext('2d');
      ctx.scale(2, 2); ctx.fillStyle = '#0a0a0f'; ctx.fillRect(0, 0, w, h);
      wbConns.forEach(c => { const from = wbNodes.find(n=>n.id===c.from), to = wbNodes.find(n=>n.id===c.to); if(from&&to) { ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(from.x+from.w/2-minX, from.y+from.h/2-minY); ctx.lineTo(to.x+to.w/2-minX, to.y+to.h/2-minY); ctx.stroke(); }});
      wbNodes.forEach(n => { ctx.fillStyle = n.type==='sticky'?n.color:'#12121a'; ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 1.5; const rx = 6; const nx = n.x-minX, ny = n.y-minY; ctx.beginPath(); ctx.roundRect(nx, ny, n.w, n.h, rx); ctx.fill(); ctx.stroke(); ctx.fillStyle = n.type==='sticky'?'#1a1a24':'#fff'; ctx.font = '600 12px system-ui'; ctx.fillText(n.title, nx+10, ny+22); ctx.fillStyle = n.type==='sticky'?'#333':'rgba(255,255,255,0.6)'; ctx.font = '10px system-ui'; ctx.fillText(n.body, nx+10, ny+40); });
      canvas.toBlob(blob => { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'whiteboard.png'; a.click(); toast('PNG exported'); });
    }
  }
}

function wbImportJSON(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const f=e.target.files[0],r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.nodes&&Array.isArray(d.nodes)){wbNodes=d.nodes;wbConns=d.conns||[];wbNodeId=Math.max(...wbNodes.map(n=>n.id||0),100)+1;wbSaveState();wbRender();wbFitView();toast('Imported '+wbNodes.length+' nodes');}else{toast('Invalid whiteboard JSON');}}catch(e){toast('Parse error: '+e.message);}};r.readAsText(f);};inp.click();
}
function wbNodeCount(){return wbNodes.length+' nodes, '+wbConns.length+' connections';}

// === TEMPLATES ===
const WB_TEMPLATES = [
  { name: 'Blank Canvas', icon: '+', desc: 'Start from scratch', nodes: [] },
  { name: 'Mind Map', icon: 'MM', desc: 'Central idea with branches', nodes: [{t:'Central Idea',b:'Main topic',x:400,y:250,c:'#3b82f6',w:180,h:80},{t:'Branch 1',b:'',x:100,y:100,c:'#8b5cf6'},{t:'Branch 2',b:'',x:700,y:100,c:'#06b6d4'},{t:'Branch 3',b:'',x:100,y:400,c:'#22c55e'},{t:'Branch 4',b:'',x:700,y:400,c:'#f97316'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: 'Eisenhower Matrix', icon: 'EM', desc: 'Urgent vs Important', nodes: [{t:'URGENT + IMPORTANT',b:'Do first',x:60,y:60,c:'#ef4444',w:280,h:200},{t:'NOT URGENT + IMPORTANT',b:'Schedule it',x:380,y:60,c:'#eab308',w:280,h:200},{t:'URGENT + NOT IMPORTANT',b:'Delegate it',x:60,y:300,c:'#f97316',w:280,h:200},{t:'NOT URGENT + NOT IMPORTANT',b:'Eliminate it',x:380,y:300,c:'#22c55e',w:280,h:200}] },
  { name: 'SWOT Analysis', icon: 'SW', desc: 'Strengths, Weaknesses, Opportunities, Threats', nodes: [{t:'STRENGTHS',b:'Internal positive',x:60,y:60,c:'#22c55e',w:280,h:200},{t:'WEAKNESSES',b:'Internal negative',x:380,y:60,c:'#ef4444',w:280,h:200},{t:'OPPORTUNITIES',b:'External positive',x:60,y:300,c:'#3b82f6',w:280,h:200},{t:'THREATS',b:'External negative',x:380,y:300,c:'#f97316',w:280,h:200}] },
  { name: 'Project Roadmap', icon: 'PR', desc: 'Timeline with milestones', nodes: [{t:'Q1 2026',b:'Foundation',x:60,y:160,c:'#3b82f6'},{t:'Q2 2026',b:'Growth',x:260,y:160,c:'#06b6d4'},{t:'Q3 2026',b:'Scale',x:460,y:160,c:'#8b5cf6'},{t:'Q4 2026',b:'Optimize',x:660,y:160,c:'#22c55e'}], conns:[[0,1],[1,2],[2,3]] },
  { name: 'Org Chart', icon: 'OC', desc: 'Organizational hierarchy', nodes: [{t:'CEO / Founder',b:'Gabo',x:300,y:40,c:'#3b82f6',w:180},{t:'Product',b:'App + Platform',x:80,y:180,c:'#8b5cf6'},{t:'Content',b:'Brand + Social',x:300,y:180,c:'#06b6d4'},{t:'Operations',b:'Finance + Legal',x:520,y:180,c:'#22c55e'},{t:'Engineering',b:'Code + Infra',x:80,y:320,c:'#f97316'},{t:'Community',b:'Coaching',x:520,y:320,c:'#ec4899'}], conns:[[0,1],[0,2],[0,3],[1,4],[3,5]] },
  { name: 'User Persona', icon: 'UP', desc: 'Customer avatar profile', nodes: [{t:'PERSONA',b:'Name, Age, Location',x:250,y:40,c:'#8b5cf6',w:200,h:80},{t:'Goals',b:'What they want to achieve',x:60,y:180,c:'#22c55e',w:200,h:100},{t:'Pain Points',b:'Frustrations and blocks',x:300,y:180,c:'#ef4444',w:200,h:100},{t:'Behaviors',b:'How they act',x:540,y:180,c:'#3b82f6',w:200,h:100},{t:'Motivations',b:'Why they buy',x:180,y:340,c:'#eab308',w:200,h:100},{t:'Channels',b:'Where they are',x:420,y:340,c:'#06b6d4',w:200,h:100}], conns:[[0,1],[0,2],[0,3],[1,4],[3,5]] },
  { name: 'Content Calendar', icon: 'CC', desc: 'Weekly content plan', nodes: [{t:'Monday',b:'Caption + Reel',x:60,y:100,c:'#3b82f6'},{t:'Tuesday',b:'Quote card',x:260,y:100,c:'#8b5cf6'},{t:'Wednesday',b:'YouTube',x:460,y:100,c:'#ef4444'},{t:'Thursday',b:'Carousel',x:60,y:240,c:'#22c55e'},{t:'Friday',b:'Story + Engagement',x:260,y:240,c:'#eab308'},{t:'Weekend',b:'Rest or batch',x:460,y:240,c:'#06b6d4'}] },
  { name: 'Product Breakdown', icon: 'PB', desc: 'Feature hierarchy', nodes: [{t:'PRODUCT',b:'Saturno Movement',x:300,y:40,c:'#3b82f6',w:180},{t:'Calisthenics',b:'Program 1',x:60,y:180,c:'#8b5cf6'},{t:'Yoga',b:'Program 2',x:280,y:180,c:'#22c55e'},{t:'Rings',b:'Program 3',x:500,y:180,c:'#f97316'},{t:'App',b:'Platform',x:280,y:320,c:'#06b6d4'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: 'Stakeholder Map', icon: 'SM', desc: 'Key relationships', nodes: [{t:'Gabo (Center)',b:'Founder',x:280,y:200,c:'#3b82f6',w:160,h:80},{t:'Customers',b:'3M+ followers',x:80,y:60,c:'#22c55e'},{t:'Victory Belt',b:'Publisher',x:480,y:60,c:'#8b5cf6'},{t:'Clients',b:'1:1 Coaching',x:80,y:360,c:'#eab308'},{t:'Community',b:'SM Academy',x:480,y:360,c:'#06b6d4'}], conns:[[0,1],[0,2],[0,3],[0,4]] },
  { name: '5 Whys', icon: '5W', desc: 'Root cause analysis', nodes: [{t:'Problem',b:'Define the issue',x:300,y:40,c:'#ef4444',w:200},{t:'Why 1?',b:'First cause',x:300,y:140,c:'#f97316'},{t:'Why 2?',b:'Deeper cause',x:300,y:240,c:'#eab308'},{t:'Why 3?',b:'Even deeper',x:300,y:340,c:'#22c55e'},{t:'Why 4?',b:'Getting close',x:300,y:440,c:'#3b82f6'},{t:'Why 5? = Root Cause',b:'The real issue',x:300,y:540,c:'#8b5cf6',w:200}], conns:[[0,1],[1,2],[2,3],[3,4],[4,5]] },
  { name: 'Impact Mapping', icon: 'IM', desc: 'Goal to deliverables', nodes: [{t:'GOAL',b:'Revenue $50K/mo',x:40,y:200,c:'#3b82f6',w:160},{t:'Actor 1',b:'Customers',x:260,y:100,c:'#22c55e'},{t:'Actor 2',b:'Followers',x:260,y:300,c:'#8b5cf6'},{t:'Impact',b:'Subscribe monthly',x:460,y:100,c:'#eab308'},{t:'Impact',b:'Buy book',x:460,y:300,c:'#f97316'},{t:'Deliverable',b:'App + Content',x:660,y:200,c:'#06b6d4',w:160}], conns:[[0,1],[0,2],[1,3],[2,4],[3,5],[4,5]] },
  { name: 'RACI Matrix', icon: 'RA', desc: 'Responsibility assignment', nodes: [{t:'RESPONSIBLE',b:'Does the work',x:60,y:60,c:'#3b82f6',w:200,h:120},{t:'ACCOUNTABLE',b:'Owns the outcome',x:300,y:60,c:'#ef4444',w:200,h:120},{t:'CONSULTED',b:'Provides input',x:60,y:220,c:'#eab308',w:200,h:120},{t:'INFORMED',b:'Kept in the loop',x:300,y:220,c:'#22c55e',w:200,h:120}] },
  { name: 'Action Plan', icon: 'AP', desc: 'Steps with owners', nodes: [{t:'Objective',b:'What we achieve',x:280,y:40,c:'#3b82f6',w:200},{t:'Step 1',b:'Owner: | Due:',x:60,y:160,c:'#22c55e'},{t:'Step 2',b:'Owner: | Due:',x:280,y:160,c:'#8b5cf6'},{t:'Step 3',b:'Owner: | Due:',x:500,y:160,c:'#06b6d4'},{t:'Result',b:'Expected outcome',x:280,y:300,c:'#eab308',w:200}], conns:[[0,1],[0,2],[0,3],[1,4],[2,4],[3,4]] },
  { name: 'Gap Analysis', icon: 'GA', desc: 'Current vs Target state', nodes: [{t:'CURRENT STATE',b:'Where we are now',x:60,y:140,c:'#f97316',w:220,h:140},{t:'TARGET STATE',b:'Where we want to be',x:480,y:140,c:'#22c55e',w:220,h:140},{t:'GAP',b:'What needs to change',x:270,y:340,c:'#ef4444',w:220,h:100},{t:'ACTIONS',b:'How to close the gap',x:270,y:60,c:'#3b82f6',w:220,h:60}], conns:[[0,2],[1,2],[2,3]] },
  { name: 'Communication Plan', icon: 'CP', desc: 'Channels and frequency', nodes: [{t:'Instagram',b:'Daily: Captions + Reels',x:60,y:60,c:'#ec4899'},{t:'YouTube',b:'Weekly: Long-form',x:280,y:60,c:'#ef4444'},{t:'Email',b:'Bi-weekly: Newsletter',x:500,y:60,c:'#3b82f6'},{t:'Website',b:'Always: Blog + SEO',x:60,y:220,c:'#22c55e'},{t:'Community',b:'Daily: DMs + Comments',x:280,y:220,c:'#8b5cf6'},{t:'Podcast',b:'Monthly: Guest spots',x:500,y:220,c:'#eab308'}] },
  { name: 'Service Blueprint', icon: 'SB', desc: 'User journey map', nodes: [{t:'Discover',b:'Find on social',x:60,y:60,c:'#3b82f6'},{t:'Explore',b:'Visit website',x:240,y:60,c:'#06b6d4'},{t:'Sign Up',b:'Free trial / purchase',x:420,y:60,c:'#22c55e'},{t:'Onboard',b:'First workout',x:600,y:60,c:'#8b5cf6'},{t:'Engage',b:'Daily use',x:420,y:200,c:'#eab308'},{t:'Advocate',b:'Refer friends',x:600,y:200,c:'#ec4899'}], conns:[[0,1],[1,2],[2,3],[3,4],[4,5]] },
  { name: 'Priority Matrix', icon: 'PM', desc: 'Effort vs Impact', nodes: [{t:'HIGH IMPACT + LOW EFFORT',b:'Quick Wins - DO FIRST',x:60,y:60,c:'#22c55e',w:260,h:180},{t:'HIGH IMPACT + HIGH EFFORT',b:'Major Projects - PLAN',x:360,y:60,c:'#3b82f6',w:260,h:180},{t:'LOW IMPACT + LOW EFFORT',b:'Fill-ins - IF TIME',x:60,y:280,c:'#eab308',w:260,h:180},{t:'LOW IMPACT + HIGH EFFORT',b:'Thankless Tasks - SKIP',x:360,y:280,c:'#ef4444',w:260,h:180}] },
  { name: 'Flowchart', icon: 'FC', desc: 'Process flow with decisions', nodes: [{t:'START',b:'Begin process',x:280,y:40,c:'#22c55e',w:160,h:60},{t:'Step 1',b:'Action',x:280,y:140,c:'#3b82f6'},{t:'Decision?',b:'Yes or No',x:280,y:260,c:'#eab308',w:160,h:80},{t:'Path A',b:'If yes',x:80,y:380,c:'#8b5cf6'},{t:'Path B',b:'If no',x:480,y:380,c:'#f97316'},{t:'END',b:'Done',x:280,y:500,c:'#ef4444',w:160,h:60}], conns:[[0,1],[1,2],[2,3],[2,4],[3,5],[4,5]] },
  { name: 'HBS Solar System', icon: 'HB', desc: 'Handstand progression planets', nodes: [{t:'SUN: Foundation',b:'Wrist prep, shoulder mobility',x:300,y:200,c:'#eab308',w:180,h:80},{t:'MERCURY: Wall Work',b:'Chest-to-wall, back-to-wall',x:80,y:60,c:'#94a3b8'},{t:'VENUS: Kick-Up',b:'Tuck, straddle, pike entries',x:540,y:60,c:'#f97316'},{t:'EARTH: Balance',b:'Freestanding skill',x:80,y:360,c:'#3b82f6'},{t:'MARS: Shapes',b:'Tuck, straddle, pike, OA prep',x:540,y:360,c:'#ef4444'},{t:'JUPITER: Press',b:'Press to handstand',x:300,y:60,c:'#f97316'},{t:'SATURN: One-Arm',b:'Mastery territory',x:300,y:360,c:'#8b5cf6'}], conns:[[0,1],[0,2],[0,3],[0,4],[0,5],[0,6]] },
  { name: 'Revenue Roadmap', icon: 'RR', desc: 'Revenue unlock path', nodes: [{t:'BOOK: $20K',b:'Victory Belt submission',x:60,y:160,c:'#22c55e',w:180},{t:'BF25 DELIVERY',b:'Trust + Retention',x:280,y:60,c:'#eab308'},{t:'DAILY CONTENT',b:'1 post/day visibility',x:280,y:260,c:'#3b82f6'},{t:'SM APP',b:'$37/mo subscriptions',x:500,y:160,c:'#8b5cf6',w:180},{t:'TARGET: $50-100K/mo',b:'Enterprise scale',x:720,y:160,c:'#ef4444',w:200}], conns:[[0,1],[0,2],[0,3],[1,3],[2,3],[3,4]] },
];

function openTplModal() {
  const g = document.getElementById('wb-tpl-grid');
  g.innerHTML = WB_TEMPLATES.map((t, i) => `<div class="wb-tpl-card" onclick="applyTemplate(${i})"><div class="wb-tpl-icon">${t.icon}</div><div class="wb-tpl-name">${t.name}</div><div class="wb-tpl-desc">${t.desc}</div></div>`).join('');
  document.getElementById('wb-tpl-modal').classList.add('open');
}
function closeTplModal() { document.getElementById('wb-tpl-modal').classList.remove('open'); }
function applyTemplate(idx) {
  const t = WB_TEMPLATES[idx];
  closeTplModal();
  if(t.nodes.length === 0) { wbNodes = []; wbConns = []; }
  else {
    wbNodes = t.nodes.map((n, i) => ({ id: wbNodeId + i, x: n.x || 100, y: n.y || 100, w: n.w || 160, h: n.h || 80, title: n.t || '', body: n.b || '', color: n.c || COLORS[i % COLORS.length], type: n.type || 'node' }));
    wbConns = (t.conns || []).map(c => ({ from: wbNodeId + c[0], to: wbNodeId + c[1], color: 'rgba(59,130,246,0.5)' }));
    wbNodeId += t.nodes.length + 1;
  }
  wbPanX = 0; wbPanY = 0; wbScale = 1;
  wbSaveState(); wbRender();
  setTimeout(() => wbFitView(), 50);
  toast('Template: ' + t.name);
}

// Keyboard shortcuts for whiteboard
document.addEventListener('keydown', e => {
  if(currentSection !== 'whiteboard') return;
  if(e.target.contentEditable === 'true' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  switch(e.key.toLowerCase()) {
    case 'v': wbSetTool('select'); break;
    case 'h': wbSetTool('hand'); break;
    case 'n': wbSetTool('node'); break;
    case 'c': wbSetTool('connect'); break;
    case 't': wbSetTool('text'); break;
    case 's': wbSetTool('sticky'); break;
    case 'g': wbToggleGrid(); break;
    case 'delete': case 'backspace': if(wbSelected) { wbDeleteNode(wbSelected); } break;
    case 'z': if(e.metaKey || e.ctrlKey) { e.preventDefault(); if(e.shiftKey) wbRedo(); else wbUndo(); } break;
    case '=': case '+': wbZoom(0.1); break;
    case '-': wbZoom(-0.1); break;
    case '0': wbScale = 1; wbPanX = 0; wbPanY = 0; document.getElementById('wb-zoom-level').textContent = '100%'; wbUpdateTransform(); wbUpdateMinimap(); break;
  }
});

// === SEED LINKS ===
function seedLinks() {
  if(!S.links.length) {
    S.links = [
      {id:2001,title:'Saturno Vault (Vercel)',url:'https://saturno-bonus-omega.vercel.app',category:'deployment',desc:'Primary deployment - password: saturno2025',created:new Date().toISOString()},
      {id:2002,title:'Saturno Vault Gate',url:'https://saturno-bonus-omega.vercel.app/gate.html',category:'deployment',desc:'Customer password gate for bonus vault',created:new Date().toISOString()},
      {id:2003,title:'GitHub: titan-forge',url:'https://github.com/gabosaturno11/titan-forge',category:'repo',desc:'Main vault repo (Vercel deploys from here)',created:new Date().toISOString()},
      {id:2004,title:'GitHub: victory-belt-cc',url:'https://github.com/gabosaturno11/victory-belt-cc',category:'repo',desc:'Victory Belt Command Center',created:new Date().toISOString()},
      {id:2005,title:'GitHub Pages: Titan Forge',url:'https://gabosaturno11.github.io/titan-forge/',category:'deployment',desc:'GH Pages (BROKEN - logo 404, stale gh-pages branch)',created:new Date().toISOString()},
      {id:2006,title:'Saturno Movement',url:'https://saturnomovement.com',category:'brand',desc:'Main brand site - Calisthenics/Yoga/Rings programs',created:new Date().toISOString()},
      {id:2007,title:'Google Calendar',url:'https://calendar.google.com',category:'tool',desc:'Calendar',created:new Date().toISOString()},
      {id:2008,title:'GitHub: saturno-hub',url:'https://github.com/gabosaturno11/saturno-hub',category:'repo',desc:'Saturno Hub starter',created:new Date().toISOString()},
      {id:2009,title:'Interactive TOC Editor',url:'https://gabosaturno11.github.io/interactive-toc-editor/',category:'deployment',desc:'Book TOC editor',created:new Date().toISOString()},
      {id:2010,title:'Saturno Solar System',url:'https://gabosaturno11.github.io/saturno-solar-system/',category:'deployment',desc:'Interactive solar system',created:new Date().toISOString()},
      {id:2011,title:'De Aqui a Saturno',url:'https://de-aqui-a-saturno.vercel.app',category:'deployment',desc:'Valentine\'s Day experience for Karina — Vimeo videos, piano crossfade, crystal cosmic scroll',created:new Date().toISOString()},
      {id:2012,title:'GitHub: de-aqui-a-saturno',url:'https://github.com/gabosaturno11/de-aqui-a-saturno',category:'repo',desc:'Private repo — Valentine\'s experience source',created:new Date().toISOString()},
      {id:2013,title:'ASTRA Command Center',url:'https://astra-command-center-sigma.vercel.app',category:'deployment',desc:'Endel-inspired 7-section command center',created:new Date().toISOString()},
      {id:2014,title:'GitHub: astra-command-center',url:'https://github.com/gabosaturno11/astra-command-center',category:'repo',desc:'ASTRA source repo',created:new Date().toISOString()},
      {id:2015,title:'Vimeo Developer',url:'https://developer.vimeo.com/apps',category:'tool',desc:'Vimeo API — app: ASTRA LLMs, account: admin@saturnomovement.com',created:new Date().toISOString()},
      {id:2016,title:'Saturno Bonus (Vercel)',url:'https://saturno-bonus-omega.vercel.app',category:'deployment',desc:'Customer bonus page — decoupled from titan-forge',created:new Date().toISOString()},
      {id:2017,title:'GitHub: saturno-bonus',url:'https://github.com/gabosaturno11/saturno-bonus',category:'repo',desc:'Private repo — clean bonus-only repo with bonuses/ folder',created:new Date().toISOString()},
      {id:2018,title:'SATURNO COMMAND',url:'https://saturno-bonus-omega.vercel.app/command',category:'deployment',desc:'Admin dashboard — tool toggles, config API',created:new Date().toISOString()},
      {id:2019,title:'Cloudflare Dashboard',url:'https://dash.cloudflare.com/',category:'tool',desc:'DNS management — admin@saturnomovement.com, 2FA enabled',created:new Date().toISOString()},
      {id:2020,title:'Stripe Dashboard',url:'https://dashboard.stripe.com/',category:'tool',desc:'Payment management — 2FA + authenticator',created:new Date().toISOString()},
      {id:2021,title:'GitHub: sm-app-copy-v1',url:'https://github.com/gabosaturno11/sm-app-copy-v1',category:'repo',desc:'Clone of Saturno Movement app codebase (from Softzee)',created:new Date().toISOString()},
    ];
  }
}

// === FOLDER SYSTEM ===
function getFolders() { return S.folders || []; }
function addFolder(name, parentId) {
  if(!S.folders) S.folders = [];
  const f = { id: 'folder_' + Date.now(), name: name || 'New Folder', parentId: parentId || null, created: new Date().toISOString() };
  S.folders.push(f);
  save();
  return f;
}
function deleteFolder(id) {
  S.folders = (S.folders||[]).filter(f => f.id !== id);
  // Unassign items from deleted folder
  S.content.forEach(c => { if(c.folderId === id) c.folderId = null; });
  S.tasks.forEach(t => { if(t.folderId === id) t.folderId = null; });
  S.docs.forEach(d => { if(d.folderId === id) d.folderId = null; });
  S.specs.forEach(s => { if(s.folderId === id) s.folderId = null; });
  S.links.forEach(l => { if(l.folderId === id) l.folderId = null; });
  save();
}
function renameFolder(id, name) {
  const f = (S.folders||[]).find(x => x.id === id);
  if(f) { f.name = name; save(); }
}
function moveToFolder(itemType, itemId, folderId) {
  const collections = { content: S.content, tasks: S.tasks, docs: S.docs, specs: S.specs, links: S.links };
  const col = collections[itemType];
  if(!col) return;
  const item = col.find(x => x.id === itemId || x.id == itemId);
  if(item) { item.folderId = folderId; save(); toast('Moved to folder'); }
}

// === FOLDER TREE UI ===
let activeFolderId = null;
function renderFolderTree() {
  const el = document.getElementById('sidebar-folder-tree');
  if(!el) return;
  const folders = getFolders();
  if(!folders.length) {
    el.innerHTML = '<div style="font-size:10px;color:var(--text-muted);padding:4px 8px">No folders yet</div>';
    return;
  }
  const rootFolders = folders.filter(f => !f.parentId);
  el.innerHTML = renderFolderLevel(rootFolders, folders, 0);
}
function renderFolderLevel(items, all, depth) {
  return items.map(f => {
    const children = all.filter(c => c.parentId === f.id);
    const count = countFolderItems(f.id);
    const isActive = activeFolderId === f.id;
    const indent = depth * 12;
    let html = `<div class="folder-item ${isActive ? 'active' : ''}" style="padding-left:${8 + indent}px" onclick="selectFolder('${f.id}')" oncontextmenu="event.preventDefault();folderContextMenu(event,'${f.id}')" ondragover="event.preventDefault();this.style.background='var(--accent-glow)'" ondragleave="this.style.background=''" ondrop="event.preventDefault();this.style.background='';folderDrop(event,'${f.id}')">`;
    html += `<span class="folder-item-icon">${children.length ? (isActive ? 'v' : '>') : '-'}</span>`;
    html += `<span class="folder-item-name">${esc(f.name)}</span>`;
    if(count > 0) html += `<span class="folder-item-count">${count}</span>`;
    html += '</div>';
    if(children.length && isActive) {
      html += renderFolderLevel(children, all, depth + 1);
    }
    return html;
  }).join('');
}
function countFolderItems(folderId) {
  let count = 0;
  S.content.forEach(c => { if(c.folderId === folderId) count++; });
  S.tasks.forEach(t => { if(t.folderId === folderId) count++; });
  S.docs.forEach(d => { if(d.folderId === folderId) count++; });
  S.specs.forEach(s => { if(s.folderId === folderId) count++; });
  S.links.forEach(l => { if(l.folderId === folderId) count++; });
  return count;
}
function selectFolder(id) {
  activeFolderId = activeFolderId === id ? null : id;
  renderFolderTree();
}
function addFolderFromSidebar() {
  const name = prompt('Folder name:');
  if(!name || !name.trim()) return;
  addFolder(name.trim());
  renderFolderTree();
  toast('Folder created');
}
function folderDrop(event, folderId) {
  const data = event.dataTransfer.getData('text/plain');
  if(!data) return;
  try {
    const { type, id } = JSON.parse(data);
    if(type && id) { moveToFolder(type, id, folderId); renderFolderTree(); }
  } catch(e) {}
}
function folderContextMenu(event, id) {
  const action = prompt('Folder action: (r)ename, (d)elete, (s)ub-folder');
  if(!action) return;
  const a = action.toLowerCase().trim();
  if(a === 'r' || a === 'rename') {
    const f = (S.folders||[]).find(x => x.id === id);
    const name = prompt('New name:', f ? f.name : '');
    if(name && name.trim()) { renameFolder(id, name.trim()); renderFolderTree(); toast('Renamed'); }
  } else if(a === 'd' || a === 'delete') {
    deleteFolder(id); activeFolderId = null; renderFolderTree(); toast('Folder deleted');
  } else if(a === 's' || a === 'sub-folder') {
    const name = prompt('Sub-folder name:');
    if(name && name.trim()) { addFolder(name.trim(), id); renderFolderTree(); toast('Sub-folder created'); }
  }
}

// === MINI KNOWLEDGE GRAPH ===
let graphNodes = [], graphEdges = [], graphAnimId = null;
function buildGraph() {
  graphNodes = []; graphEdges = [];
  const colors = { project: '#4ade80', doc: '#22d3ee', spec: '#a78bfa', task: '#fbbf24', kb: '#fb923c' };
  // Add project nodes
  (S.projects||[]).forEach(p => {
    graphNodes.push({ id: 'p_'+p.id, label: p.name, type: 'project', color: colors.project, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Add doc nodes
  S.docs.forEach(d => {
    graphNodes.push({ id: 'd_'+d.id, label: d.title||'Untitled', type: 'doc', color: colors.doc, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Add spec nodes
  S.specs.forEach(s => {
    graphNodes.push({ id: 's_'+s.id, label: s.title||'Untitled', type: 'spec', color: colors.spec, x: Math.random()*260+10, y: Math.random()*140+10, vx:0, vy:0 });
  });
  // Build edges from wiki-links
  S.docs.forEach(d => {
    if(!d.body) return;
    const links = d.body.match(/\[\[([^\]]+)\]\]/g)||[];
    links.forEach(m => {
      const name = m.slice(2,-2).trim();
      const target = findLinkedItem(name);
      if(target) {
        const srcId = 'd_'+d.id;
        let tgtId = '';
        if(target.type==='project') tgtId='p_'+target.id;
        else if(target.type==='doc') tgtId='d_'+target.id;
        else if(target.type==='spec') tgtId='s_'+target.id;
        if(tgtId && graphNodes.find(n=>n.id===tgtId)) graphEdges.push({from:srcId,to:tgtId});
      }
    });
  });
  S.specs.forEach(s => {
    (s.sections||[]).forEach(sec => {
      if(!sec.body) return;
      const links = sec.body.match(/\[\[([^\]]+)\]\]/g)||[];
      links.forEach(m => {
        const name = m.slice(2,-2).trim();
        const target = findLinkedItem(name);
        if(target) {
          const srcId = 's_'+s.id;
          let tgtId = '';
          if(target.type==='project') tgtId='p_'+target.id;
          else if(target.type==='doc') tgtId='d_'+target.id;
          else if(target.type==='spec') tgtId='s_'+target.id;
          if(tgtId && graphNodes.find(n=>n.id===tgtId)) graphEdges.push({from:srcId,to:tgtId});
        }
      });
    });
  });
  // Connect KB items to their projects
  (S.knowledgeBase||[]).forEach(k => {
    if(k.projectId) {
      const projNode = graphNodes.find(n=>n.id==='p_'+k.projectId);
      if(projNode) {
        graphNodes.push({ id: 'k_'+k.id, label: k.name, type: 'kb', color: colors.kb, x: projNode.x+Math.random()*40-20, y: projNode.y+Math.random()*40-20, vx:0, vy:0 });
        graphEdges.push({from:'p_'+k.projectId,to:'k_'+k.id});
      }
    }
  });
  // Limit to max 30 nodes for performance
  if(graphNodes.length > 30) graphNodes = graphNodes.slice(0, 30);
}
function renderGraph() {
  const canvas = document.getElementById('ctx-graph-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  buildGraph();
  if(!graphNodes.length) {
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Add items + [[links]] to see connections', w/2, h/2);
    return;
  }
  let steps = 80;
  function simulate() {
    const k = 0.01, repulsion = 800, damping = 0.85;
    graphNodes.forEach(n => { n.vx = 0; n.vy = 0; });
    // Repulsion
    for(let i=0;i<graphNodes.length;i++) {
      for(let j=i+1;j<graphNodes.length;j++) {
        let dx=graphNodes[j].x-graphNodes[i].x, dy=graphNodes[j].y-graphNodes[i].y;
        let dist=Math.sqrt(dx*dx+dy*dy)+1;
        let f=repulsion/(dist*dist);
        graphNodes[i].vx -= dx/dist*f; graphNodes[i].vy -= dy/dist*f;
        graphNodes[j].vx += dx/dist*f; graphNodes[j].vy += dy/dist*f;
      }
    }
    // Attraction along edges
    graphEdges.forEach(e => {
      const a=graphNodes.find(n=>n.id===e.from), b=graphNodes.find(n=>n.id===e.to);
      if(!a||!b) return;
      let dx=b.x-a.x, dy=b.y-a.y, dist=Math.sqrt(dx*dx+dy*dy)+1;
      let f=dist*k;
      a.vx += dx*f; a.vy += dy*f;
      b.vx -= dx*f; b.vy -= dy*f;
    });
    // Center gravity
    graphNodes.forEach(n => {
      n.vx += (w/2-n.x)*0.002;
      n.vy += (h/2-n.y)*0.002;
      n.vx *= damping; n.vy *= damping;
      n.x += n.vx; n.y += n.vy;
      n.x = Math.max(10, Math.min(w-10, n.x));
      n.y = Math.max(10, Math.min(h-10, n.y));
    });
  }
  for(let i=0;i<steps;i++) simulate();
  // Draw
  ctx.clearRect(0,0,w,h);
  // Edges
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  graphEdges.forEach(e => {
    const a=graphNodes.find(n=>n.id===e.from), b=graphNodes.find(n=>n.id===e.to);
    if(!a||!b) return;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  });
  // Nodes
  graphNodes.forEach(n => {
    const r = n.type==='project' ? 5 : 3;
    ctx.beginPath(); ctx.arc(n.x,n.y,r,0,Math.PI*2);
    ctx.fillStyle = n.color; ctx.globalAlpha = 0.7; ctx.fill(); ctx.globalAlpha = 1;
    // Label
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.font = '8px system-ui';
    ctx.textAlign = 'center';
    const label = n.label.length > 12 ? n.label.slice(0,11) + '..' : n.label;
    ctx.fillText(label, n.x, n.y - r - 3);
  });
}

// === CROSS-LINKING [[wiki-links]] ===
function parseWikiLinks(html) {
  if(!html) return html;
  return html.replace(/\[\[([^\]]+)\]\]/g, (match, linkText) => {
    const target = findLinkedItem(linkText.trim());
    if(target) {
      return `<span class="wiki-link" onclick="navigateToItem('${target.type}','${target.id}')" title="${esc(target.desc)}" style="color:var(--accent);cursor:pointer;border-bottom:1px dashed var(--accent);padding-bottom:1px">${esc(linkText)}</span>`;
    }
    return `<span class="wiki-link-broken" style="color:var(--red);cursor:help;border-bottom:1px dashed var(--red)" title="Not found: ${esc(linkText)}">${esc(linkText)}</span>`;
  }).replace(/(https?:\/\/[^\s<>"]+)/g,'<a href="$1" target="_blank" rel="noopener" style="color:var(--accent-cyan);text-decoration:none;border-bottom:1px dashed var(--accent-cyan)" onclick="event.stopPropagation()">$1</a>');
}
function findLinkedItem(name) {
  const nl = name.toLowerCase();
  // Search projects
  const proj = (S.projects||[]).find(p => p.name.toLowerCase() === nl);
  if(proj) return { type: 'project', id: proj.id, desc: 'Project: ' + proj.name };
  // Search docs
  const doc = S.docs.find(d => d.title && d.title.toLowerCase() === nl);
  if(doc) return { type: 'doc', id: doc.id, desc: 'Document: ' + doc.title };
  // Search specs
  const spec = S.specs.find(s => s.title && s.title.toLowerCase() === nl);
  if(spec) return { type: 'spec', id: spec.id, desc: 'Living Doc: ' + spec.title };
  // Search KB items
  const kb = (S.knowledgeBase||[]).find(k => k.name && k.name.toLowerCase() === nl);
  if(kb) return { type: 'kb', id: kb.id, desc: 'KB: ' + kb.name };
  // Search tasks
  const task = S.tasks.find(t => t.title && t.title.toLowerCase() === nl);
  if(task) return { type: 'task', id: task.id, desc: 'Task: ' + task.title };
  return null;
}
function navigateToItem(type, id) {
  if(type === 'project') { openProject(id); }
  else if(type === 'doc') { switchDoc(parseInt(id) || id); switchSection('writer', null); }
  else if(type === 'spec') { switchSpec(parseInt(id) || id); switchSection('specs', null); }
  else if(type === 'kb') { openKBViewer(id); }
  else if(type === 'task') { switchSection('tasks', null); toast('Task: ' + (S.tasks.find(t => t.id == id)?.title || '')); }
}
function getBacklinks(itemType, itemName) {
  const nl = '[[' + itemName + ']]';
  const results = [];
  S.docs.forEach(d => { if(d.body && d.body.includes(nl)) results.push({ type: 'doc', title: d.title || 'Untitled', id: d.id }); });
  S.specs.forEach(s => {
    (s.sections || []).forEach(sec => {
      if(sec.body && sec.body.includes(nl)) results.push({ type: 'spec', title: s.title + ' > ' + sec.title, id: s.id });
    });
  });
  (S.projects||[]).forEach(p => {
    if(p.instructions && p.instructions.includes(nl)) results.push({ type: 'project', title: p.name, id: p.id });
  });
  return results;
}

// === COMMAND PALETTE ===
let cmdIdx = 0;
function openCommandPalette() {
  document.getElementById('cmd-overlay').classList.add('open');
  const inp = document.getElementById('cmd-input');
  inp.value = '';
  cmdIdx = 0;
  cmdSearch();
  setTimeout(() => inp.focus(), 50);
}
function closeCommandPalette() {
  document.getElementById('cmd-overlay').classList.remove('open');
}
function cmdGetItems(q) {
  const items = [];
  const ql = (q || '').toLowerCase();
  // Help prefix — list all available Cmd+K prefixes
  if(ql && (ql==='help'||ql==='help:'||ql==='?'||ql==='prefixes')){
    const prefixes=[
      ['task: ...','Quick-create task inline'],['note: ...','Quick-save content inline'],
      ['find: keyword','Cross-section search with counts'],['focus:','Show P0/P1 + overdue tasks'],
      ['week:','Upcoming 7 days task breakdown'],['daily:','Today activity summary'],
      ['streak:','Completion streak + 7-day activity'],['timeline:','Chronological task overview'],
      ['matrix:','Priority x status breakdown'],['template:','Create task from templates'],
      ['compare:p1:p2','Compare two projects side-by-side'],['merge: keyword','Find + merge duplicate tasks'],
      ['rename:old:new','Rename projects/tags globally'],['orphan:','Find disconnected items'],
      ['health:','System diagnostics + issues'],['backup:','Data size + export actions'],
      ['clean:','Cleanup empty tasks, dup links, etc'],['dup: keyword','Find + duplicate tasks'],
      ['tag-tasks:','Browse tasks by tag'],['project-stats:','Per-project analytics'],
      ['export:','All export options'],['standup','Daily standup summary'],
      ['search: keyword','Deep search across ALL sections'],['find: keyword','Alias for search:'],
      ['history:','Recent activity across all sections'],
      ['digest','Daily briefing + overdue + progress'],['goals:','Track daily + weekly goals'],
      ['streak','Activity streak + weekly heatmap'],['heatmap','90-day activity heatmap popup'],
      ['deps','Task dependency chain visualization'],['accent','Change accent color (8 presets)'],
      ['pomodoro','Focus session stats + start timer'],['collections','Auto-detect content groups'],
      ['scratch','Persistent floating scratchpad'],['review','Weekly review + copy markdown'],
      ['workspace','Full workspace stats overview'],
      ['chart','SVG charts: status pie, priority bars, themes, weekly'],
      ['plan','7-day task plan with quick-add'],['bookmarks','Import browser bookmarks HTML'],
      ['burndown','14-day task burndown chart (created vs completed)'],
      ['deadlinks','Check all links for broken URLs'],
      ['notifications','Enable desktop notifications for overdue tasks'],
      ['timeline','Activity timeline across all sections'],
      ['backup','Schedule auto-backup (JSON download)'],
      ['restore','Import JSON backup to restore data'],
      ['export docs','Export all writer docs as single markdown'],
      ['roadmap','Project roadmap timeline view'],
      ['journal','Open/create today\'s journal entry'],
      ['writing','Writing stats and daily word streak'],
      ['cleanup','Find orphans, dupes, and empty items'],
      ['report','Monthly productivity report'],
      ['stickies','Floating sticky notes on workspace'],
      ['gantt','Task Gantt chart (horizontal timeline)'],
      ['related','Find related/similar content'],
      ['reading','Link reading list (read-later queue)'],
      ['habits','Daily habit tracker with streak grid'],
      ['table','Task table/spreadsheet view'],
      ['project health','Per-project health dashboard'],
      ['random','Surface a random content item for review'],
      ['clips','Clipboard history manager'],
      ['project template','Create project from template with tasks'],
      ['compare','Side-by-side content comparison'],
      ['time block','Add time blocks to calendar'],
      ['transform','Text transform tools (uppercase, lowercase, title case)'],
      ['archive url','View link on Wayback Machine'],
      ['dashboard','Show home dashboard with widgets'],
      ['settings','App preferences and configuration'],
      ['impact','Task impact-effort matrix (2x2)'],
      ['export content','Export all content as markdown'],
      ['focus stats','Focus/Pomodoro session history and stats'],
      ['eisenhower','Urgent vs Important task matrix (4 quadrants)'],
      ['content calendar','Calendar view of content creation dates'],
      ['snippets','Save and reuse text snippets'],
      ['heatmap full','365-day GitHub-style activity heatmap'],
      ['link dashboard','Link stats: domains, categories, counts'],
      ['dependencies','Task dependency chains and blocked items'],
      ['weekly review','Comprehensive 7-day review with markdown export'],
      ['pomo history','Pomodoro session history by task and date'],
      ['tag cloud','Visual tag cloud sized by frequency'],
      ['priority grid','Quick priority reassignment for active tasks'],
      ['content timeline','Chronological timeline of all content items'],
      ['velocity','12-week task velocity line chart'],
      ['quick note','Toggle floating quick-note capture button'],
      ['bookmarklets','Generate bookmarklets for capturing to ASTRA'],
      ['workspace search','Deep search across all sections with results'],
      ['batch edit','Edit multiple tasks at once (priority, status, project)'],
      ['content stats','Content analytics: types, themes, tags, word counts'],
      ['swimlane','Kanban by project (project x status grid)'],
      ['daily planner','Today\'s schedule with time slots and tasks'],
      ['export workspace','Download full ASTRA workspace as JSON'],
      ['quick actions','Floating action bar with most-used functions'],
      ['due heatmap','Calendar heatmap of task due dates (load per day)'],
      ['writing goals','Set and track daily/weekly word count goals'],
      ['project compare','Side-by-side comparison of two projects'],
      ['task aging','Find stale/aging tasks that need attention'],
      ['import links md','Import links from pasted markdown text'],
      ['ambient','Ambient sounds for focus sessions'],
      ['word frequency','Most common words across content and docs'],
      ['priority board','Kanban board grouped by priority level'],
      ['wip limits','Configure WIP limits per board column'],
      ['duplicates','Find duplicate content with similarity scoring'],
      ['export csv','Export all tasks as CSV spreadsheet'],
      ['inbox','View unsorted/uncategorized items across all sections'],
      ['session','Show current ASTRA session time'],
      ['undo','Undo last destructive action (delete task/content/link)'],
      ['favorites','Quick access to starred and pinned items'],
      ['due groups','Tasks grouped: Overdue/Today/Tomorrow/Week/Later'],
      ['convert','Convert content to task or task to content'],
      ['deep focus','Full-screen dimming overlay for distraction-free work'],
      ['estimation','Compare estimated vs actual time on tasks'],
      ['data tools','Manage/clear data by section, factory reset'],
      ['theme','Switch between dark theme variants'],
      ['status email','Generate weekly status email (copies to clipboard)'],
      ['morning','Morning briefing panel with daily overview'],
      ['shortcuts','Visual keyboard shortcut cheatsheet'],
      ['streak','Daily usage streak tracker'],
      ['content templates','Pre-built templates for notes, meetings, journals'],
      ['link checker','Check if saved links are still reachable'],
      ['reading progress','Track read/unread status of content items'],
      ['project timeline','Visual timeline of project milestones'],
      ['math','Quick calculator - type math: expression'],
      ['focus score','Daily productivity score based on activity'],
      ['archive','Browse and restore archived tasks'],
      ['word cloud','Visual word cloud from all content'],
      ['habits','Daily habit tracker with streaks'],
      ['knowledge graph','Wiki-link stats and most referenced items'],
      ['random','Resurface random content for review'],
      ['clipboard','View clipboard history within ASTRA'],
      ['world clock','Time zones: Local, NY, London, Tokyo, Sydney, Dubai'],
      ['diff','Compare two content items side by side'],
      ['backup','Download or restore workspace backup'],
      ['burnup','Cumulative task burnup chart (12 weeks)'],
      ['content metrics','Readability, vocabulary, sentence analysis'],
      ['markdown','Preview content as rendered markdown'],
      ['completion heatmap','GitHub-style heatmap of task completions'],
      ['saved searches','Save and recall frequent Cmd+K queries'],
      ['stale','Find content items older than 30 days'],
      ['timer:','Start countdown timer (e.g. timer: 10 for 10 min)'],
      ['project health','Health scores for all projects'],
      ['matrix','4-quadrant task priority matrix'],
      ['bookmarks','Quick-access content bookmarks'],
      ['system status','ASTRA system stats, storage, session info'],
      ['auto tag','Suggest tags for untagged content'],
      ['sprint','Sprint view: tasks grouped by week'],
      ['color legend','What all colors mean across ASTRA'],
      ['daily digest','Generate comprehensive daily summary'],
      ['content archive','Archive and restore old content'],
      ['changelog','View workspace change log for this session'],
      ['focus config','Configure focus mode: duration, breaks, blocked sections'],
      ['action items','Extract TODO/ACTION items from content as tasks'],
      ['weekly planner','Week-at-a-glance task planner'],
      ['switch project','Quick switch between projects'],
      ['task chains','View task dependency chains'],
      ['themes','Content theme breakdown with bar chart'],
      ['multi project','Dashboard across all projects'],
      ['export themes','Export content grouped by theme to clipboard'],
      ['global search','Dedicated search panel across all sections'],
      ['notifications','Overdue, WIP, streak, and storage alerts'],
      ['stats history','Daily stats tracked over time (90 days)'],
      ['board filters','Filter kanban by priority, project, due date'],
      ['scratchpad','Quick persistent notepad'],
      ['print export','Downloadable printable HTML export'],
      ['slides','Convert content to presentation slides'],
      ['workload','14-day task workload forecast'],
      ['gratitude','Daily gratitude journal with streak'],
      ['task templates','8 task templates: bug fix, feature, research, etc.'],
      ['lifetime focus','Lifetime Pomodoro/focus statistics'],
      ['creation calendar','Month grid showing when content was created'],
      ['suggestions','Smart next-action suggestions based on current state'],
      ['link categories','Visual breakdown of link categories'],
      ['priority distribution','Bar chart of task priority levels'],
      ['mood','Daily mood tracker with trend chart'],
      ['repo timeline','Overview of all repos with status'],
      ['micro journal','Quick daily one-liner journal'],
      ['completion rate','Weekly task completion rate chart'],
      ['export book','Export all content as markdown book'],
      ['overview','Full workspace overview dashboard'],
      ['sentiment','Content sentiment analysis (positive/negative)'],
      ['project completion','Project completion % timeline bars'],
      ['content calendar','Month calendar of content creation dates'],
      ['velocity','Task velocity: completed vs created per week (8 weeks)'],
      ['tag cloud','Visual tag cloud from all content, tasks, and links'],
      ['due calendar','Month calendar of task due dates with overdue highlights'],
      ['productivity','Weekly productivity insights with trends and tips'],
      ['category breakdown','Stacked bar of content categories with legend'],
      ['recent activity','Unified activity feed across all sections'],
      ['quick note','Floating quick note saver (saves to content)'],
      ['writer stats','Writer statistics: docs, words, pages, versions'],
      ['link domains','Link domain breakdown with frequency bars'],
      ['time report','Detailed time tracking report by project and task'],
      ['content timeline','Vertical timeline of content creation history'],
      ['goals','Set and track weekly/monthly goals with progress bars'],
      ['quick task','Floating quick task creator with priority and due date'],
      ['data explorer','Browse raw workspace state data in tree view'],
      ['project comparison','Side-by-side project comparison table'],
      ['weekly review','Comprehensive weekly review generator (copy to clipboard)'],
      ['achievements','Gamified milestones: tasks, words, content, streaks'],
      ['focus history','History of all Pomodoro/focus sessions with 14-day chart'],
      ['quick link','Floating quick link saver with category'],
      ['storage','Visual localStorage breakdown with usage % bar'],
      ['task aging','Tasks ranked by age: fresh, stale, ancient'],
      ['word frequency','Top 30 words across all content (stop words excluded)'],
      ['daily planner','Today time blocks: morning, afternoon, evening'],
      ['content length','Content items by word count: tiny to epic'],
      ['project notes','Quick persistent notes per project'],
      ['duplicates','Find duplicate content and tasks by title similarity'],
      ['universal search','Search everything with live results panel'],
      ['eisenhower','2x2 Urgent/Important matrix for task prioritization'],
      ['writer progress','Word count targets per doc with progress bars'],
      ['batch ops','Bulk operations: tag all, rename category, archive done'],
      ['context','Switch workspace context: all, work, personal, creative'],
      ['daily checklist','Recurring daily checklist that resets each morning'],
      ['knowledge map','Map of [[wiki-link]] connections between content'],
      ['export hub','All-in-one export: JSON, CSV, Markdown, HTML'],
      ['dependencies','Visual task dependency graph (blocking/blocked)'],
      ['inbox zero','Triage panel for uncategorized/incomplete items'],
      ['reading list','Read/unread tracking for saved links'],
      ['project status','Status board for all projects (on-track, at-risk, blocked)'],
      ['dashboard','ASTRA dashboard with stats, overdue, quick actions'],
      ['captures','Summary of quick captures by type'],
      ['notes explorer','Tree-view content browser organized by category'],
      ['deadlines','Countdown tracker for upcoming task deadlines'],
      ['content graph','30-day line chart of content creation and word count'],
      ['advanced search','Search with filters: type, date range'],
      ['quote','Random motivational quote (15 curated quotes)'],
      ['accent color','Change ASTRA accent color (12 options)'],
      ['session log','Log what you worked on with timestamps'],
      ['recent edits','Most recently edited items across all sections'],
      ['doc outline','Document headings/outlines from writer docs'],
      ['backlog','Backlog groomer: prioritize and schedule unassigned tasks'],
      ['focus score history','30-day focus score trend line chart'],
      ['convert','Convert between types: content>task, task>content, etc.'],
      ['workspace stats','Comprehensive 12-metric workspace statistics'],
      ['habits','Daily habit tracker with 7-day grid and streaks'],
      ['suggestions','Smart workspace suggestions based on data analysis'],
      ['project archive','Archive completed projects to reduce clutter'],
      ['sprint','Sprint planner for weekly task planning'],
      ['content templates','Pre-built templates for blog posts, notes, reviews'],
      ['workspace timeline','Chronological timeline of all workspace activity'],
      ['tag manager','Rename and delete tags across all sections'],
      ['task matrix','Project x Status matrix view of all tasks'],
      ['bookmarks','Organize bookmarks by category with expandable groups'],
      ['weekly goals','Set and track goals for the current week'],
      ['content analytics','Deep analytics on content: themes, tags, trends'],
      ['quick bookmark','Floating bookmark saver with category picker'],
      ['heatmap','GitHub-style task completion heatmap (26 weeks)'],
      ['writer goals','Daily/weekly/monthly writing word count goals'],
      ['project health','Health dashboard for all projects with risk assessment'],
      ['mind dump','Brain dump: type everything, sort later, convert to tasks'],
      ['milestones','Project milestones with due dates and tracking'],
      ['link health','Link health report: score, duplicates, missing titles'],
      ['journal','Daily journal with mood tracking and gratitude'],
      ['burndown','Project burndown charts with status breakdown'],
      ['quick timer','Floating countdown timer with presets'],
      ['content duplicates','Find and remove duplicate content items'],
      ['priority report','Task priority breakdown with completion rates'],
      ['embed','Save embeddable URLs (YouTube, Twitter, Figma)'],
      ['cleanup','Workspace cleanup: find stale tasks, empty content, broken links'],
      ['batch edit','Bulk edit tasks: select + set priority/status/delete'],
      ['version compare','Compare writer document versions side by side'],
      ['focus','Full-screen focus mode showing top P0/P1 task'],
      ['time estimates','Task time estimates breakdown by priority'],
      ['deep search','Global deep search across all workspace data'],
      ['snippets','Code snippet library with copy-to-clipboard'],
      ['daily report','Generate comprehensive daily report with copy'],
      ['switch project','Quick project switcher with stats'],
      ['pomodoro stats','Pomodoro session stats with 7-day chart'],
      ['content gallery','Visual card gallery of all content items'],
      ['task flow','Visual flow of tasks through statuses'],
      ['weekly digest','Full weekly summary with highlights and priorities'],
      ['task tags','Task-specific tag cloud with completion rates'],
      ['calculator','Quick floating calculator with live evaluation'],
      ['markdown','Live markdown editor with side-by-side preview'],
      ['task dashboard','Comprehensive task dashboard with metrics and donut'],
      ['changelog','Version changelog with entries and dates'],
      ['reference','Quick reference cards with copy-to-clipboard'],
      ['activity monitor','Last activity per section and session info'],
      ['export','Export content, tasks, links as MD/CSV/JSON/download'],
      ['random task','Pick a random active task to work on'],
      ['sort content','Permanently sort all content items by various criteria'],
      ['water','Track daily water intake with glass counter'],
      ['reading queue','Unread/read link tracking with mark-as-read'],
      ['completion graph','14-day SVG bar chart of created vs completed tasks'],
      ['color picker','Quick color picker with palette and hex input'],
      ['standup report','Generate standup: done, in-progress, blocked, focus'],
      ['project overview','Grid overview of all projects with stats'],
      ['swimlanes','Task swimlanes grouped by project, sorted by priority'],
      ['decisions','Decision log: record decisions with context and reasoning'],
      ['word cloud','Visual word cloud from all content and documents'],
      ['clipboard','Persistent clipboard history with copy-to-clipboard'],
      ['quick todo','Floating quick todo list with checkboxes'],
      ['compare content','Side-by-side content item comparison'],
      ['scorecard','Workspace health scorecard with letter grade'],
      ['advanced search','Multi-field search with section and date filters'],
      ['dependencies','Visual task dependency chain viewer'],
      ['notifications','In-app notification center with alerts'],
      ['eisenhower','Eisenhower matrix - urgent vs important task grid'],
      ['recent activity','Cross-section activity timeline'],
      ['quick note','Floating sticky note widget'],
      ['project timeline','Gantt-style project date ranges'],
      ['recurring','Overview of all recurring tasks'],
      ['quick link','Floating quick link saver widget'],
      ['data backup','Full data export/import and snapshot manager'],
      ['wall of fame','Showcase completed high-priority tasks'],
      ['content calendar','Content items on a monthly calendar grid'],
      ['focus breakdown','Time spent breakdown by project and priority'],
      ['link categories','Rename and manage link categories'],
      ['task aging','Visual aging report for open tasks'],
      ['doc outline','Table of contents from document headings'],
      ['compare projects','Side-by-side project stats comparison'],
      ['quick task','Floating quick task creator widget'],
      ['content network','Tag-based content connection map'],
      ['weekly planner','7-day planning grid with task slots'],
      ['quick search','Floating search-as-you-type widget'],
      ['writer stats','Writer productivity statistics and metrics'],
      ['velocity','Task completion velocity over 8 weeks'],
      ['captures','Quick capture dashboard grouped by type'],
      ['theme analyzer','Content theme breakdown with word counts'],
      ['project notes','Per-project notes editor'],
      ['daily goals','Floating daily goal tracker widget'],
      ['status board','Kanban status overview with counts'],
      ['word history','Document word count progression chart'],
      ['bookmark bar','Floating quick-access links bar'],
      ['task distribution','Distribution by project, priority, status'],
      ['content archive','Archive and restore content items'],
      ['sessions','Work session tracker with history'],
      ['link explorer','Browse links grouped by domain'],
      ['project summary','Executive summary for a project'],
      ['countdown','Floating countdown to custom dates'],
      ['text transform','Text utilities - uppercase, slug, trim, reverse'],
      ['link archive','Archive and restore links'],
      ['merge docs','Merge two writer documents into one'],
      ['json viewer','JSON formatter and pretty-printer'],
      ['task templates','Manage custom task creation templates'],
      ['workspace mood','Visual mood indicator from health metrics'],
      ['regex','Live regex pattern tester with matches'],
      ['ics export','Export tasks as ICS calendar file'],
      ['dice','Random number generator and decision maker'],
      ['date calculator','Add/subtract days and find date differences'],
      ['gantt','Simple Gantt chart showing task durations'],
      ['memo','Floating persistent memo pad'],
      ['base64','Encode and decode Base64 strings'],
      ['mini kanban','Quick kanban with click-to-move status buttons'],
      ['clock','Floating live clock widget'],
      ['url encode','URL encode and decode utility'],
      ['pareto','Pareto analysis of task completions by project'],
      ['affirmation','Random positive affirmation display'],
      ['color palette','CSS color palette generator with shades'],
      ['streaks','Daily task completion streak tracker'],
      ['lorem ipsum','Lorem ipsum text generator'],
      ['markdown preview','Live markdown editor with split preview'],
      ['task heatmap','GitHub-style task completion heatmap'],
      ['quick timer','Stopwatch and countdown timer widget'],
      ['csv viewer','Paste and view CSV data as a table'],
      ['task bubbles','Task bubble chart by project'],
      ['habits','Daily habit tracker with streaks'],
      ['unit converter','Convert between length, weight, temperature, time, data units'],
      ['task sunburst','Sunburst chart of tasks by project and status'],
      ['flashcards','Study flashcard deck with flip and navigation'],
      ['diff tool','Compare two texts and highlight differences'],
      ['task radar','Radar chart showing task health across 5 axes'],
      ['journal','Quick daily journal with timestamped entries'],
      ['password generator','Secure random password generator with strength meter'],
      ['completion trend','30-day task completion trend with daily bars and cumulative line'],
      ['quick bookmarks','Quick-access bookmark manager widget'],
      ['ascii art','Convert text to ASCII block letters'],
      ['priority matrix','Task priority matrix showing all 4 priority levels'],
      ['code snippets','Save and manage reusable code snippets'],
      ['character counter','Count characters, words, sentences, read time'],
      ['task treemap','Treemap visualization of tasks by project'],
      ['polls','Create and vote on quick polls'],
      ['hash generator','SHA-256/384/512/1 hash generator for text'],
      ['project progress','Progress bars for all projects with stats'],
      ['quick sketch','Mini drawing canvas with colors and sizes'],
      ['ip info','Lookup your IP address and geolocation'],
      ['task funnel','Task pipeline funnel with conversion rates'],
      ['gratitude','Daily gratitude log with history'],
      ['json formatter','Format, minify, and validate JSON data'],
      ['task scorecard','Dashboard of key task metrics and stats'],
      ['quick todos','Lightweight todo checklist widget'],
      ['cron helper','Cron expression builder and explainer'],
      ['workload forecast','14-day task workload forecast chart'],
      ['sticky note','Draggable sticky note on screen'],
      ['emoji picker','Browse and copy emojis to clipboard'],
      ['time estimates','Task time estimate breakdown and analysis'],
      ['decision matrix','Eisenhower-style 4-quadrant decision matrix'],
      ['number formatter','Format numbers as currency, binary, hex, roman, and more'],
      ['weekly report','Weekly task report with daily breakdown'],
      ['cipher','Text encryption with Caesar, ROT13, Atbash ciphers'],
      ['text analysis','Word frequency, letter frequency, and text statistics'],
      ['task age','Task age distribution summary by time buckets'],
      ['weather','Current weather from your location'],
      ['table generator','Create tables and export as Markdown, CSV, or HTML'],
      ['word cloud','Word cloud visualization from content and writer docs'],
      ['quick kanban','4-lane kanban board widget'],
      ['color contrast','WCAG color contrast checker for accessibility'],
      ['daily goals','Daily goal tracker with progress bar'],
      ['mind map','Structured mind map with branches and sub-items'],
      ['font preview','Preview text in 20 different system fonts'],
      ['status flow','Task status flow diagram with counts'],
      ['pros cons','Pros and cons decision making tool'],
      ['spacing guide','CSS spacing and typography scale reference'],
      ['milestones','Project milestone tracker with timeline'],
      ['wishlist','Personal wishlist with priority levels'],
      ['box shadow','CSS box-shadow generator with live preview'],
      ['week over week','Task completion week-over-week comparison'],
      ['reading list','Personal reading list with status tracking'],
      ['gradient','CSS gradient generator with live preview'],
      ['completion rate','Task completion rate by project'],
      ['habit streak','Daily habit streak tracker'],
      ['border radius','CSS border-radius generator with live preview'],
      ['velocity','Task completion velocity over time'],
      ['affirmation','Daily motivational affirmation'],
      ['flexbox','CSS flexbox layout generator with live preview'],
      ['burndown','Task burndown chart over time'],
      ['countdown','Countdown timer to a target date'],
      ['grid','CSS grid layout generator with live preview'],
      ['distribution','Task distribution by status and priority'],
      ['dice','Dice roller with d4-d20 options'],
      ['animation','CSS animation presets library'],
      ['gantt','Task Gantt chart timeline view'],
      ['coin flip','Quick coin flip with stats'],
      ['transition','CSS transition generator with live preview'],
      ['overdue','Overdue tasks summary grouped by age'],
      ['roulette','Decision roulette wheel spinner'],
      ['media query','CSS media query presets library'],
      ['created vs done','Task created vs completed comparison'],
      ['vote','Quick voting and polling tool'],
      ['clamp','CSS clamp() fluid typography generator'],
      ['project heatmap','Project vs status heatmap grid'],
      ['bingo','Developer bingo card game'],
      ['filter','CSS filter effects generator with live preview'],
      ['project timeline','Project completion timeline'],
      ['spin wheel','Spin the wheel decision maker'],
      ['text shadow','CSS text-shadow generator with live preview'],
      ['streak calendar','GitHub-style task streak calendar'],
      ['tarot','Daily tarot card draw'],
      ['css variables','CSS variable theme presets'],
      ['cycle time','Task cycle time analysis'],
      ['motivation','Motivational quote generator'],
      ['clip-path','CSS clip-path shape presets'],
      ['pareto','Task Pareto chart by project'],
      ['breathwork','Guided breathing exercise patterns'],
      ['aspect ratio','Aspect ratio calculator and converter'],
      ['due date analysis','Task due date breakdown and timeline'],
      ['meditation','Meditation timer with preset durations'],
      ['svg icons','SVG icon browser with copy-to-clipboard'],
      ['estimate accuracy','Task estimate vs actual time analysis'],
      ['ambient','Ambient noise generator for focus'],
      ['regex','Regex tester with live matching'],
      ['sla','Task SLA compliance tracker'],
      ['focus score','Daily focus score based on activity'],
      ['base64','Base64 encode and decode tool'],
      ['productivity','Productivity dashboard with weekly stats'],
      ['stopwatch','Stopwatch with lap tracking'],
      ['url encode','URL encode/decode tool'],
      ['workspace','Workspace summary with item counts'],
      ['metronome','Audio metronome with BPM control'],
      ['html entities','HTML entity reference with click-to-copy'],
      ['weekly digest','Weekly task completion digest'],
      ['color blend','Color blend/interpolation tool'],
      ['world clock','World clock with timezone comparison'],
      ['tag cloud','Tag cloud from tasks and content'],
      ['ruler','Screen ruler with pixel coordinates'],
      ['jwt','JWT token decoder and inspector'],
      ['cumulative flow','Cumulative flow diagram for tasks'],
      ['typing test','Typing speed test with WPM tracking'],
      ['qr code','QR code generator from text or URL'],
      ['wip history','Work in progress history over 12 weeks'],
      ['eye break','Guided eye break exercises'],
      ['curl','cURL command generator'],
      ['task age','Task age distribution chart'],
      ['white noise','White/pink/brown noise generator'],
      ['fetch','Fetch API code generator'],
      ['priority history','Task priority breakdown over time'],
      ['stretch','Guided desk stretching exercises'],
      ['console log','Console.log template snippets'],
      ['flow efficiency','Task flow efficiency dashboard'],
      ['gratitude','Daily gratitude journal'],
      ['http status','HTTP status code reference'],
      ['recurrence','Task recurrence summary'],
      ['journal','Daily journal with writing prompts'],
      ['env file','.env file generator and editor'],
      ['blocked graph','Blocked tasks dependency graph'],
      ['hydration','Water intake tracker'],
      ['dockerfile','Dockerfile template generator'],
      ['completion funnel','Task completion funnel visualization'],
      ['screen break','Full-screen break timer overlay'],
      ['gitignore','.gitignore file generator with presets'],
      ['project balance','Task balance across all projects'],
      ['daily review','End-of-day review and reflection'],
      ['readme','README.md generator with templates'],
      ['status timeline','Task status stacked area timeline'],
      ['mood','Daily mood tracker with 7-day trend'],
      ['package.json','package.json generator'],
      ['weekly goals','Weekly goals tracker with progress'],
      ['sleep','Sleep hours tracker with 7-day chart'],
      ['tsconfig','tsconfig.json preset generator'],
      ['weekday heatmap','Task completion day x hour heatmap'],
      ['energy','Energy level tracker with sparkline'],
      ['eslint','ESLint config presets'],
      ['monthly report','Monthly task completion report'],
      ['bookmarks','Quick bookmarks manager'],
      ['prettier','Prettier config generator'],
      ['eisenhower','Eisenhower matrix for task prioritization'],
      ['idea','Quick idea capture pad'],
      ['vercel.json','Vercel config preset generator'],
      ['quarterly review','Quarterly task performance review'],
      ['binaural','Binaural focus tones generator'],
      ['nginx','nginx config preset generator'],
      ['velocity trend','Task velocity trend over 10 weeks'],
      ['abc','ABC priority categorization tool'],
      ['docker compose','Docker Compose template generator'],
      ['creation trend','Task creation vs completion trend'],
      ['decision log','Decision tracking and logging'],
      ['github actions','GitHub Actions workflow templates'],
      ['done vs created','Task done vs created by project'],
      ['win streak','Daily wins tracker with streak'],
      ['license','LICENSE file generator'],
      ['blocked time','Blocked time analysis for tasks'],
      ['reading log','Book reading tracker'],
      ['cron','Cron expression generator'],
      ['sprint','Sprint board with task assignment'],
      ['morning routine','Morning routine checklist'],
      ['makefile','Makefile generator'],
      ['overdue chart','Overdue tasks distribution'],
      ['water intake','Daily water intake tracker'],
      ['webpack','Webpack config generator'],
      ['tag cloud','Tag cloud visualization'],
      ['affirmation','Daily affirmation generator'],
      ['babel','Babel config generator'],
      ['completion rate','Task completion rate donut'],
      ['box breathing','Box breathing exercise'],
      ['editorconfig','EditorConfig file generator'],
      ['due date calendar','Due date mini calendar'],
      ['focus timer','Pomodoro focus timer widget'],
      ['jest','Jest config generator'],
      ['workload','Workload balance by project'],
      ['daily quote','Quote of the day'],
      ['tailwind','Tailwind CSS config generator'],
      ['burndown','Task burndown chart'],
      ['habit tracker','Daily habit tracker'],
      ['postcss','PostCSS config generator'],
      ['stale tasks','Find stale/old tasks'],
      ['color picker','Color picker with palettes'],
      ['vite','Vite config generator'],
      ['priority matrix','Urgent/important task matrix'],
      ['stopwatch','Lap stopwatch timer'],
      ['rollup','Rollup config generator'],
      ['estimate accuracy','Task estimate vs actual'],
      ['countdown','Countdown timer widget'],
      ['swc','SWC compiler config generator'],
      ['dependencies','Task dependency list'],
      ['dice','Dice roller widget'],
      ['sql schema','SQL schema generator'],
      ['project timeline','Project progress timeline'],
      ['coin flip','Coin flip randomizer'],
      ['prisma','Prisma schema generator'],
      ['weekly review','Weekly task review summary'],
      ['random number','Random number generator'],
      ['mongoose','Mongoose schema generator'],
      ['status pie','Task status pie chart'],
      ['password strength','Password strength checker'],
      ['kubernetes','Kubernetes YAML generator'],
      ['creation heatmap','Task creation heatmap'],
      ['world clock','World clock widget'],
      ['terraform','Terraform config generator'],
      ['lead time','Task lead time analysis'],
      ['metronome','Audio metronome widget'],
      ['api endpoint','REST API endpoint generator'],
      ['cycle time','Task cycle time distribution'],
      ['tip calculator','Tip calculator with split'],
      ['graphql','GraphQL schema generator'],
      ['throughput','Weekly task throughput chart'],
      ['text diff','Side-by-side text comparison'],
      ['socket.io','Socket.IO boilerplate code'],
      ['project radar','Multi-project radar chart'],
      ['markdown preview','Live markdown preview'],
      ['jwt','JWT token decoder'],
      ['task dashboard','Full task summary dashboard'],
      ['ascii art','ASCII art collection'],
      ['redis','Redis command reference'],
      ['progress gauge','Overall progress gauge'],
      ['lorem ipsum','Lorem ipsum text generator'],
      ['git commands','Git command reference'],
      ['age histogram','Task age distribution histogram'],
      ['char counter','Character and word counter'],
      ['npm','npm command reference'],
      ['flow board','Mini kanban flow board'],
      ['emoji','Emoji picker with categories'],
      ['yarn','Yarn command reference'],
      ['velocity','Task completion velocity trend'],
      ['unit converter','Unit converter (length, weight, temp)'],
      ['pnpm','pnpm command reference'],
      ['blocked report','Blocked and at-risk task report'],
      ['bmi','BMI calculator'],
      ['deno','Deno command reference'],
      ['completion calendar','Task completion heatmap calendar'],
      ['percentage','Percentage calculator'],
      ['bun','Bun command reference'],
      ['effort','Task effort distribution chart'],
      ['time zones','World clock time zone converter'],
      ['curl','curl command reference'],
      ['project breakdown','Task breakdown by project'],
      ['date diff','Date difference calculator'],
      ['ssh','SSH command reference'],
      ['recurring','Recurring tasks overview'],
      ['base converter','Number base converter'],
      ['aws','AWS CLI command reference'],
      ['created vs done','Created vs done task chart'],
      ['color converter','Color format converter'],
      ['vercel','Vercel CLI command reference'],
      ['wip age','WIP task age report'],
      ['string encoder','Base64, URL, HTML encoder/decoder'],
      ['gh cli','GitHub CLI command reference'],
      ['priority distribution','Task priority pie chart'],
      ['ip lookup','IP address lookup'],
      ['fly','Fly.io CLI command reference'],
      ['due soon','Tasks due soon grouped by urgency'],
      ['json formatter','JSON pretty print and minify'],
      ['netlify','Netlify CLI command reference'],
      ['weekly pattern','Task completion day-of-week pattern'],
      ['csv to table','CSV data to formatted table'],
      ['supabase','Supabase CLI command reference'],
      ['sla report','Task SLA on-time delivery report'],
      ['regex tester','Regular expression tester'],
      ['railway','Railway CLI command reference'],
      ['streak','Task completion streak tracker'],
      ['qr code','QR code generator'],
      ['claude code','Claude Code CLI reference'],
      ['status overview','Task status distribution overview'],
      ['hash','SHA hash generator'],
      ['pip','Python pip command reference'],
      ['daily goal','Daily task completion goal tracker'],
      ['uuid','UUID generator'],
      ['cargo','Cargo/Rust command reference'],
      ['weekly report','Weekly task summary report'],
      ['cron builder','Cron expression builder'],
      ['go','Go command reference'],
      ['archive stats','Task archive statistics'],
      ['markdown table','Markdown table generator'],
      ['composer','Composer/PHP command reference'],
      ['milestones','Task completion milestones'],
      ['placeholder image','Placeholder image URL generator'],
      ['ruby','Ruby/Rails command reference'],
      ['focus score','Personal focus score gauge'],
      ['slug','URL slug and camelCase generator'],
      ['gradle','Gradle command reference'],
      ['scope creep','Project scope creep analysis'],
      ['aspect ratio','Aspect ratio calculator'],
      ['maven','Maven command reference'],
      ['tag breakdown','Content tag usage breakdown'],
      ['shadow','CSS box-shadow generator'],
      ['nuget','NuGet/.NET command reference'],
      ['productivity','Productivity index by time period'],
      ['gradient','CSS gradient generator'],
      ['helm','Helm/Kubernetes chart reference'],
      ['health dashboard','System-wide health dashboard'],
      ['font pairing','Font pairing suggestions'],
      ['kubectl','kubectl/Kubernetes command reference'],
      ['net flow','Task creation vs completion net flow'],
      ['border radius','CSS border-radius generator'],
      ['ansible','Ansible command reference'],
      ['abandoned','Tasks untouched for 14+ days'],
      ['flexbox','CSS flexbox layout helper'],
      ['nginx','nginx config and command reference'],
      ['estimate accuracy','How accurate are your time estimates'],
      ['css grid','CSS grid layout helper'],
      ['terraform','Terraform CLI and IaC reference'],
      ['day heatmap','Tasks created and completed by day of week'],
      ['lorem ipsum','Generate lorem ipsum placeholder text'],
      ['pulumi','Pulumi IaC CLI reference'],
      ['creation hour','When do you create tasks by hour'],
      ['password','Generate secure random passwords'],
      ['vagrant','Vagrant VM management reference'],
      ['completion rate','Weekly task completion rate trend'],
      ['countdown','Countdown timer widget'],
      ['packer','Packer image builder CLI reference'],
      ['overdue history','Overdue and late-completed task history'],
      ['stopwatch','Stopwatch with lap times'],
    ];
    items.unshift({title:'Cmd+K Prefixes ('+prefixes.length+')',desc:'Type any prefix to activate',icon:'?',type:'info'});
    prefixes.forEach(([name,desc])=>{items.push({title:name,desc,icon:'>',type:'info'});});
    return items;
  }
  // Recent items (show when no query)
  if(!ql && recentItems.length) {
    recentItems.forEach(r => {
      items.push({title:r.title, desc:'Recent - '+r.type, icon:'*', type:'recent', action:()=>navigateToItem(r.type, r.id)});
    });
  }
  // Sections
  const sections = [
    {title:'Content',desc:'Content vault',icon:'C',action:()=>switchSection('content',document.querySelector('.sidebar-item'))},
    {title:'Tasks',desc:'Task manager',icon:'T',action:()=>switchSection('tasks',null)},
    {title:'Calendar',desc:'Calendar view',icon:'D',action:()=>switchSection('calendar',null)},
    {title:'Writing Hub',desc:'Document editor',icon:'W',action:()=>switchSection('writer',null)},
    {title:'Living Docs',desc:'Structured documents',icon:'S',action:()=>switchSection('specs',null)},
    {title:'Links',desc:'Link directory',icon:'L',action:()=>switchSection('links',null)},
    {title:'Whiteboard',desc:'Visual canvas',icon:'B',action:()=>switchSection('whiteboard',null)},
    {title:'Pipeline',desc:'Audio/text processing pipeline',icon:'P',action:()=>switchSection('pipeline',null)},
    {title:'Repos',desc:'Connected repositories',icon:'R',action:()=>switchSection('repos',null)},
  ];
  sections.forEach(s => {
    if(!ql || s.title.toLowerCase().includes(ql) || s.desc.toLowerCase().includes(ql))
      items.push({...s, type:'section'});
  });
  // Projects
  (S.projects||[]).forEach(p => {
    if(!ql || p.name.toLowerCase().includes(ql))
      items.push({title:p.name, desc:'Project - '+p.status, icon:p.icon?getIconSVG(p.icon,14):'P', type:'project', action:()=>openProject(p.id)});
  });
  // Tasks
  S.tasks.forEach(t => {
    if(t.title && (!ql || t.title.toLowerCase().includes(ql) || (t.description||'').toLowerCase().includes(ql)))
      items.push({title:t.title, desc:t.status+' - '+(t.project||'No project')+(t.description?' - '+t.description.substring(0,40):''), icon:'T', type:'task', action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
  });
  // Docs
  S.docs.forEach(d => {
    if(d.title && (!ql || d.title.toLowerCase().includes(ql)))
      items.push({title:d.title, desc:'Document', icon:'W', type:'doc', action:()=>{switchDoc(d.id);switchSection('writer',null);}});
  });
  // Living Docs
  S.specs.forEach(s => {
    if(s.title && (!ql || s.title.toLowerCase().includes(ql))){
      const specW=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);
      items.push({title:s.title, desc:'Living Doc - '+(s.sections?s.sections.length:0)+' sections, '+specW+'w', icon:'S', type:'spec', action:()=>{switchSpec(s.id);switchSection('specs',null);}});
    }
  });
  // KB Items
  (S.knowledgeBase||[]).forEach(k => {
    if(k.name && (!ql || k.name.toLowerCase().includes(ql)))
      items.push({title:k.name, desc:'KB - '+k.type, icon:'K', type:'kb', action:()=>{const proj = (S.projects||[]).find(p=>p.id===k.projectId); if(proj){openProject(proj.id);setProjTab('kb');} openKBViewer(k.id);}});
  });
  // Content (search body text)
  if(ql) {
    S.content.filter(c=>c.body.toLowerCase().includes(ql)).slice(0,5).forEach(c => {
      items.push({title:c.body.substring(0,60)+(c.body.length>60?'...':''), desc:'Content - '+c.type+(c.theme?' / '+c.theme:''), icon:'C', type:'content', action:()=>{switchSection('content',null);document.getElementById('content-search').value=ql;renderContent();}});
    });
  }
  // Links
  S.links.forEach(l => {
    if(l.title && (!ql || l.title.toLowerCase().includes(ql) || l.url.toLowerCase().includes(ql)))
      items.push({title:l.title, desc:l.url, icon:'L', type:'link', action:()=>window.open(l.url,'_blank')});
  });
  // Actions
  if(!ql || 'new task'.includes(ql)) items.push({title:'New Task', desc:'Create a new task', icon:'+', type:'action', action:addTask});
  if(!ql || 'new document'.includes(ql)) items.push({title:'New Document', desc:'Create a new document', icon:'+', type:'action', action:newDoc});
  if(!ql || 'new project'.includes(ql)) items.push({title:'New Project', desc:'Create a new project', icon:'+', type:'action', action:openNewProjectModal});
  if(!ql || 'export'.includes(ql)) items.push({title:'Export All', desc:'Export all data as JSON', icon:'E', type:'action', action:exportAll});
  if(!ql || 'stats storage data'.includes(ql)) items.push({title:'Data Stats', desc:'Show storage breakdown by section', icon:'#', type:'action', action:()=>{closeCommandPalette();dataStats();}});
  if(!ql || 'focus timer'.includes(ql)) items.push({title:'Focus Timer', desc:'Open focus timer in context panel', icon:'FT', type:'action', action:()=>{if(!document.querySelector('.app').classList.contains('context-open'))toggleContextPanel();}});
  if(!ql || 'quick capture'.includes(ql)) items.push({title:'Quick Capture', desc:'Add task/content instantly (Cmd+Shift+N)', icon:'+', type:'action', action:()=>{closeCommandPalette();qcOpen();}});
  if(!ql || 'today'.includes(ql)) items.push({title:'Today View', desc:'See tasks due today + overdue', icon:'*', type:'action', action:()=>{closeCommandPalette();showTodayView();}});
  if(!ql || 'standup daily'.includes(ql)) items.push({title:'Daily Standup', desc:'Copy standup summary to clipboard', icon:'S', type:'action', action:()=>{closeCommandPalette();generateStandup();}});
  if(!ql || 'export content'.includes(ql)) items.push({title:'Export Content', desc:'Copy all content as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportContent();}});
  if(!ql || 'export content html download'.includes(ql)) items.push({title:'Export Content as HTML', desc:'Download all content as styled HTML file', icon:'E', type:'action', action:()=>{closeCommandPalette();exportContentHTML();}});
  if(!ql || 'export tasks'.includes(ql)) items.push({title:'Export Tasks', desc:'Copy filtered tasks as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportTasks();}});
  if(!ql || 'import data json restore'.includes(ql)) items.push({title:'Import Data (JSON)', desc:'Restore from exported JSON backup', icon:'I', type:'action', action:()=>{closeCommandPalette();const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(!d.tasks&&!d.content){toast('Invalid backup file');return;}if(!confirm('Replace all data with this backup? ('+Object.keys(d).length+' sections)'))return;Object.assign(S,d);save();location.reload();}catch(err){toast('Error: '+err.message);}};r.readAsText(f);};i.click();}});
  if(!ql || 'export docs documents writer'.includes(ql)) items.push({title:'Export All Docs', desc:'Copy all writer documents as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportAllDocs();}});
  if(!ql || 'export docs html download'.includes(ql)) items.push({title:'Export All Docs as HTML', desc:'Download all documents as styled HTML file', icon:'E', type:'action', action:()=>{closeCommandPalette();exportAllDocsHTML();}});
  if(!ql || 'export links bookmarks'.includes(ql)) items.push({title:'Export Links', desc:'Copy all links as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportLinks();}});
  if(!ql || 'export week calendar summary'.includes(ql)) items.push({title:'Export Week', desc:'Copy this weeks tasks as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportWeek();}});
  if(!ql || 'projects all list'.includes(ql)){const ps=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();if(ps.length)ps.forEach(p=>{const active=S.tasks.filter(t=>t.project===p&&t.status!=='done').length;const done=S.tasks.filter(t=>t.project===p&&t.status==='done').length;items.push({title:p,desc:active+' active, '+done+' done',icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p;const tpf=document.getElementById('task-project-filter');if(tpf)tpf.value=p;renderTasks();toast('Filtered: '+p);}});});}
  if(!ql || 'weekly report summary productivity'.includes(ql)) items.push({title:'Weekly Report', desc:'Copy weekly productivity report as markdown', icon:'W', type:'action', action:()=>{closeCommandPalette();weeklyReport();}});
  if(!ql || 'export month calendar'.includes(ql)) items.push({title:'Export Month', desc:'Copy current months tasks as markdown', icon:'E', type:'action', action:()=>{closeCommandPalette();exportMonth();}});
  if(!ql || 'archive'.includes(ql)) items.push({title:'Archive Completed', desc:'Move done tasks to archive', icon:'A', type:'action', action:()=>{closeCommandPalette();archiveCompletedTasks();}});
  if(!ql || 'overdue late past due'.includes(ql)){const ot=new Date().toISOString().split('T')[0];const od=S.tasks.filter(t=>t.due&&t.due<ot&&t.status!=='done');if(od.length)items.push({title:'Overdue Tasks ('+od.length+')',desc:od.slice(0,3).map(t=>t.title).join(', '),icon:'!',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);setTaskFilter('active');document.getElementById('task-sort').value='due';renderTasks();toast(od.length+' overdue tasks');}});}
  if(!ql || 'archive archived completed old'.includes(ql)){const ac=(S.archivedTasks||[]).length;if(ac)items.push({title:'View Archived Tasks ('+ac+')',desc:'Browse and restore archived tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);showArchivedTasks();}});}
  if(!ql || 'shortcuts help'.includes(ql)) items.push({title:'Keyboard Shortcuts', desc:'Show all shortcuts (Cmd+/)', icon:'?', type:'action', action:()=>{closeCommandPalette();document.getElementById('shortcuts-modal').classList.add('open');}});
  if(!ql || 'help prefix commands'.includes(ql)) items.push({title:'Cmd+K Prefixes (29)', desc:'task: note: link: doc: spec: tag: project: goto: calc: all: focus: due: status: p: recent: count: overdue: today: week: starred: random: pin: progress: blocked: export: wc: archive: time: in:', icon:'?', type:'info'});
  if(!ql || 'clear reset filters'.includes(ql)) items.push({title:'Clear All Filters', desc:'Reset search, filters, and sort to defaults', icon:'X', type:'action', action:()=>{closeCommandPalette();taskFilter='all';taskProjectFilter=null;contentType='all';contentTheme='all';contentTagFilter=null;contentShowAll=false;const ts=document.getElementById('task-search');if(ts)ts.value='';const cs=document.getElementById('content-search');if(cs)cs.value='';const tsort=document.getElementById('task-sort');if(tsort)tsort.value='manual';renderTasks();renderContent();renderLinks();toast('All filters cleared');}});
  if(!ql || 'zen writer'.includes(ql)) items.push({title:'Zen Writer', desc:'Distraction-free writing mode', icon:'Z', type:'action', action:()=>{closeCommandPalette();zenOpen();}});
  if(!ql || 'focus mode'.includes(ql)) items.push({title:'Toggle Focus Mode', desc:'Hide sidebar for focused work', icon:'F', type:'action', action:()=>{closeCommandPalette();const app=document.querySelector('.app');setMode(app.classList.contains('mode-focus')?'default':'focus');}});
  if(!ql || 'ics calendar export'.includes(ql)) items.push({title:'Export Calendar', desc:'Export tasks as .ics for Google Calendar', icon:'C', type:'action', action:()=>{closeCommandPalette();exportICS();}});
  if(!ql || 'random inspiration content'.includes(ql)) items.push({title:'Random Content', desc:'Pick a random content item for inspiration', icon:'?', type:'action', action:()=>{closeCommandPalette();switchSection('content',null);setTimeout(randomContent,100);}});
  if(!ql || 'export summary markdown report'.includes(ql)) items.push({title:'Export Summary', desc:'Copy hub summary as Markdown', icon:'S', type:'action', action:()=>{closeCommandPalette();exportSummary();}});
  if(!ql || 'repo health check ping'.includes(ql)) items.push({title:'Repo Health Check', desc:'Ping all live repo URLs', icon:'R', type:'action', action:()=>{closeCommandPalette();repoHealthCheck();}});
  if(!ql || 'time report hours tracked'.includes(ql)) items.push({title:'Time Report', desc:'Show time tracked per task', icon:'T', type:'action', action:()=>{closeCommandPalette();timeReport();}});
  if(!ql || 'zen writer write focus'.includes(ql)) items.push({title:'Zen Writer', desc:'Full-screen distraction-free writing (Cmd+Shift+W)', icon:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>', type:'action', action:()=>{closeCommandPalette();zenOpen();}});
  if(!ql || 'daily dashboard digest briefing morning'.includes(ql)) items.push({title:'Daily Dashboard', desc:'Full daily briefing copied to clipboard', icon:'*', type:'action', action:()=>{closeCommandPalette();dailyDashboard();}});
  if(!ql || 'import ics calendar'.includes(ql)) items.push({title:'Import ICS', desc:'Import .ics calendar file as tasks', icon:'C', type:'action', action:()=>{closeCommandPalette();importICS();}});
  if(!ql || 'export all specs living docs'.includes(ql)) items.push({title:'Export All Specs', desc:'Combine all Living Docs into one markdown', icon:'S', type:'action', action:()=>{closeCommandPalette();exportAllSpecs();}});
  if(!ql || 'export specs html download'.includes(ql)) items.push({title:'Export Specs as HTML', desc:'Download all Living Docs as styled HTML', icon:'S', type:'action', action:()=>{closeCommandPalette();exportAllSpecsHTML();}});
  if(!ql || 'export tasks html download'.includes(ql)) items.push({title:'Export Tasks as HTML', desc:'Download all tasks as styled HTML by project', icon:'T', type:'action', action:()=>{closeCommandPalette();exportAllTasksHTML();}});
  if(!ql || 'export links html download'.includes(ql)) items.push({title:'Export Links as HTML', desc:'Download all links as styled HTML by category', icon:'L', type:'action', action:()=>{closeCommandPalette();exportAllLinksHTML();}});
  if(!ql || 'export content markdown md download'.includes(ql)) items.push({title:'Export Content as MD', desc:'Download all content grouped by type as Markdown', icon:'C', type:'action', action:()=>{closeCommandPalette();exportAllContentMD();}});
  if(!ql || 'export docs writer markdown md download'.includes(ql)) items.push({title:'Export Docs as MD', desc:'Download all writer documents as Markdown', icon:'W', type:'action', action:()=>{closeCommandPalette();exportAllDocsMD();}});
  if(!ql || 'export tasks ics calendar file'.includes(ql)) items.push({title:'Export Tasks as ICS', desc:'Download active tasks with due dates as calendar file', icon:'C', type:'action', action:()=>{closeCommandPalette();exportTasksICS();}});
  // Quick create task from Cmd+K with @date and !priority
  if(ql && ql.startsWith('task:')) {
    let taskRaw=q.substring(5).trim();
    let taskDue=new Date().toISOString().split('T')[0];
    let taskPri='p1';
    const dateMatch=taskRaw.match(/@(\S+)/);
    if(dateMatch){taskDue=parseNaturalDate(dateMatch[1])||taskDue;taskRaw=taskRaw.replace(/@\S+/,'').trim();}
    const priMatch=taskRaw.match(/!(p[0-3])/i);
    if(priMatch){taskPri=priMatch[1].toLowerCase();taskRaw=taskRaw.replace(/!p[0-3]/i,'').trim();}
    const taskTitle=taskRaw;
    if(taskTitle){items.unshift({title:'Create task: '+taskTitle,desc:'Due: '+taskDue+' | '+taskPri.toUpperCase()+(dateMatch?' (parsed @'+dateMatch[1]+')':''),icon:'+',type:'action',action:()=>{closeCommandPalette();S.tasks.unshift({id:Date.now(),title:taskTitle,description:'',subtasks:[],status:'todo',priority:taskPri,project:taskProjectFilter||'',due:taskDue,created:new Date().toISOString()});save();if(currentSection==='tasks')renderTasks();toast('Task created: '+taskTitle);}});}
  }
  // Quick add content from Cmd+K
  if(ql && ql.startsWith('note:')) {
    const noteBody=q.substring(5).trim();
    if(noteBody){items.unshift({title:'Save note: '+noteBody.substring(0,40),desc:'Quick-save as content item',icon:'+',type:'action',action:()=>{closeCommandPalette();S.content.unshift({id:Date.now(),type:'caption',theme:'quick-note',body:noteBody,tags:['quick'],created:new Date().toISOString()});save();if(currentSection==='content')renderContent();toast('Note saved');}});}
  }
  // Quick filter by project from Cmd+K
  if(ql && ql.startsWith('project:')) {
    const pq=q.substring(8).trim().toLowerCase();
    const matchingProjects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].filter(p=>p.toLowerCase().includes(pq));
    matchingProjects.forEach(p=>{
      const cnt=S.tasks.filter(t=>t.project===p&&t.status!=='done').length;
      items.unshift({title:'Project: '+p,desc:cnt+' active tasks',icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p;renderTasks();toast('Filtered: '+p);}});
    });
  }
  // Quick add link from Cmd+K
  if(ql && ql.startsWith('link:')) {
    const linkUrl=q.substring(5).trim();
    if(linkUrl){
      const isUrl=linkUrl.startsWith('http')||linkUrl.includes('.');
      items.unshift({title:'Add link: '+linkUrl.substring(0,40),desc:isUrl?'Quick-save link to directory':'Not a valid URL — add anyway?',icon:'L',type:'action',action:()=>{closeCommandPalette();const url=linkUrl.startsWith('http')?linkUrl:'https://'+linkUrl;const title=url.replace(/https?:\/\/(www\.)?/,'').split('/')[0];S.links.unshift({id:Date.now(),title,url,category:'unsorted',desc:'',pinned:false,created:new Date().toISOString()});save();if(currentSection==='links')renderLinks();toast('Link saved: '+title);}});
    }
  }
  // Global full-text search
  if(ql && ql.startsWith('all:')) {
    const aq=q.substring(4).trim().toLowerCase();
    if(aq){
      S.tasks.filter(t=>(t.title+' '+(t.description||'')).toLowerCase().includes(aq)).slice(0,3).forEach(t=>{items.push({title:t.title,desc:'Task - '+t.status,icon:'T',type:'task',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
      S.content.filter(c=>c.body.toLowerCase().includes(aq)).slice(0,3).forEach(c=>{items.push({title:c.body.substring(0,50),desc:'Content - '+c.type,icon:'C',type:'content',action:()=>{closeCommandPalette();switchSection('content',null);document.getElementById('content-search').value=aq;renderContent();}});});
      S.docs.filter(d=>{const tmp=document.createElement('div');tmp.innerHTML=d.body||'';return(d.title||'').toLowerCase().includes(aq)||(tmp.innerText||'').toLowerCase().includes(aq);}).slice(0,3).forEach(d=>{items.push({title:d.title||'Untitled',desc:'Document',icon:'W',type:'doc',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});
      S.links.filter(l=>(l.title+' '+l.url+' '+(l.desc||'')).toLowerCase().includes(aq)).slice(0,3).forEach(l=>{items.push({title:l.title,desc:l.url,icon:'L',type:'link',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});
    }
  }
  // Quick tag search from Cmd+K
  if(ql && ql.startsWith('tag:')) {
    const tq=q.substring(4).trim().toLowerCase();
    if(tq){
      const allContentTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))].filter(t=>t.toLowerCase().includes(tq));
      allContentTags.slice(0,5).forEach(tag=>{
        const cnt=S.content.filter(c=>(c.tags||[]).includes(tag)).length;
        items.unshift({title:'Tag: '+tag,desc:cnt+' content items',icon:'#',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);contentTagFilter=tag;renderContent();toast('Filtered: '+tag);}});
      });
      const allDocTags=[...new Set(S.docs.flatMap(d=>d.tags||[]).filter(Boolean))].filter(t=>t.toLowerCase().includes(tq));
      allDocTags.slice(0,5).forEach(tag=>{
        const cnt=S.docs.filter(d=>(d.tags||[]).includes(tag)).length;
        items.unshift({title:'Doc tag: '+tag,desc:cnt+' documents',icon:'W',type:'action',action:()=>{closeCommandPalette();switchSection('writer',null);toast(cnt+' docs tagged: '+tag);}});
      });
    } else {
      const contentTags=[...new Set(S.content.flatMap(c=>c.tags||[]).filter(Boolean))];
      const docTags=[...new Set(S.docs.flatMap(d=>d.tags||[]).filter(Boolean))];
      items.unshift({title:'All tags',desc:contentTags.length+' content tags, '+docTags.length+' doc tags',icon:'#',type:'info'});
    }
  }
  // Focus on specific task from Cmd+K
  if(ql && ql.startsWith('focus:')) {
    const fq=q.substring(6).trim().toLowerCase();
    if(fq){
      S.tasks.filter(t=>t.status!=='done'&&t.title&&t.title.toLowerCase().includes(fq)).slice(0,5).forEach(t=>{
        items.unshift({title:'Focus: '+t.title,desc:'Start 25min Pomodoro + time tracking',icon:'F',type:'action',action:()=>{closeCommandPalette();ftStartForTask(t.id);toast('Focus started: '+t.title);}});
      });
    }
  }
  // Today prefix
  if(ql && (ql.startsWith('today:') || ql==='today')){
    const today=new Date().toISOString().split('T')[0];
    const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
    const tq=q.substring(q.indexOf(':')+1).trim().toLowerCase();
    todayTasks.filter(t=>!tq||t.title.toLowerCase().includes(tq)).forEach(t=>{
      items.unshift({title:t.title||'Untitled',desc:'Due today | '+(t.priority||'p2')+' | '+(t.project||'no project'),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    if(!todayTasks.length)items.unshift({title:'No tasks due today',desc:'Use task: to create one',icon:'T',type:'info'});
  }
  // Pin prefix - all pinned items
  if(ql && (ql.startsWith('pin:') || ql==='pin' || ql==='pinned')){
    S.content.filter(c=>c.pinned).forEach(c=>{items.unshift({title:c.body.substring(0,60),desc:'Pinned content | '+c.type+(c.theme?' | '+c.theme:''),icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});});
    S.links.filter(l=>l.pinned).forEach(l=>{items.unshift({title:l.title,desc:'Pinned link | '+l.url.substring(0,50),icon:'P',type:'action',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});
    if(!items.length)items.unshift({title:'No pinned items',desc:'Pin content or links with the Pin button',icon:'P',type:'info'});
  }
  // Scope prefix - search within specific section only
  if(ql && ql.startsWith('in:')){
    const parts=q.substring(3).trim();const colonIdx=parts.indexOf(' ');
    const scope=colonIdx>0?parts.substring(0,colonIdx).toLowerCase():parts.toLowerCase();
    const term=colonIdx>0?parts.substring(colonIdx+1).trim().toLowerCase():'';
    if(term){
      if(scope==='tasks'||scope==='task'||scope==='t'){S.tasks.filter(t=>(t.title||'').toLowerCase().includes(term)||(t.description||'').toLowerCase().includes(term)).slice(0,8).forEach(t=>{items.unshift({title:t.title||'Untitled',desc:(t.priority||'p2')+' | '+(t.project||'')+(t.due?' | '+t.due:''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}
      if(scope==='docs'||scope==='doc'||scope==='d'||scope==='writer'){S.docs.filter(d=>(d.title||'').toLowerCase().includes(term)||(d.body||'').toLowerCase().includes(term)).slice(0,8).forEach(d=>{items.unshift({title:d.title||'Untitled',desc:countW(d.body)+'w',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});}
      if(scope==='content'||scope==='c'){S.content.filter(c=>c.body.toLowerCase().includes(term)).slice(0,8).forEach(c=>{items.unshift({title:c.body.substring(0,60),desc:c.type+(c.theme?' | '+c.theme:''),icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});});}
      if(scope==='specs'||scope==='spec'||scope==='s'){S.specs.filter(s=>(s.title||'').toLowerCase().includes(term)||(s.sections||[]).some(sec=>(sec.body||'').toLowerCase().includes(term))).slice(0,8).forEach(s=>{items.unshift({title:s.title||'Untitled',desc:(s.sections||[]).length+' sections',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(s.id);switchSection('specs',null);}});});}
      if(scope==='links'||scope==='link'||scope==='l'){S.links.filter(l=>(l.title+' '+l.url+' '+(l.desc||'')).toLowerCase().includes(term)).slice(0,8).forEach(l=>{items.unshift({title:l.title,desc:l.url.substring(0,50),icon:'L',type:'action',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});}
    } else {
      items.unshift({title:'Scoped search',desc:'Usage: in:tasks keyword, in:docs keyword, in:content keyword, in:specs keyword, in:links keyword',icon:'?',type:'info'});
    }
  }
  // Time tracking prefix - summary of time tracked
  if(ql && (ql.startsWith('time:') || ql==='time' || ql==='timer')){
    const tracked=S.tasks.filter(t=>t.timeSpent>0);const running=S.tasks.filter(t=>t.timeStarted);
    const totalMins=tracked.reduce((a,t)=>a+(t.timeSpent||0),0);
    items.unshift({title:'Total tracked: '+formatTimeSpent(totalMins),desc:tracked.length+' tasks tracked'+(running.length?' | '+running.length+' running':''),icon:'T',type:'info'});
    const byProject={};tracked.forEach(t=>{const p=t.project||'No Project';byProject[p]=(byProject[p]||0)+(t.timeSpent||0);});
    Object.entries(byProject).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([p,m])=>{items.unshift({title:p+': '+formatTimeSpent(m),desc:Math.round(m/totalMins*100)+'% of tracked time',icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);filterTaskProject(p);document.getElementById('task-sort').value='time';renderTasks();}});});
    if(running.length){running.forEach(t=>{items.unshift({title:'Running: '+t.title,desc:'Started '+timeAgo(t.timeStarted),icon:'>',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}
  }
  // Archive prefix - show archived tasks
  if(ql && (ql.startsWith('archive:') || ql==='archive' || ql==='archived')){
    const archived=S.archivedTasks||[];
    if(archived.length){
      const aq=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
      const filtered=aq?archived.filter(t=>(t.title||'').toLowerCase().includes(aq)):archived;
      filtered.slice(0,10).forEach(t=>{items.unshift({title:t.title||'Untitled',desc:'Archived | '+(t.project||'')+(t.completedAt?' | Done '+timeAgo(t.completedAt):''),icon:'A',type:'action',action:()=>{closeCommandPalette();if(confirm('Restore "'+t.title+'" from archive?')){S.archivedTasks=S.archivedTasks.filter(x=>x.id!==t.id);t.status='todo';S.tasks.push(t);save();renderTasks();toast('Restored: '+t.title);}}});});
      items.push({title:archived.length+' archived tasks',desc:'Search with archive:keyword or click to restore',icon:'A',type:'info'});
    } else {
      items.unshift({title:'No archived tasks',desc:'Archive done tasks from the Tasks section',icon:'A',type:'info'});
    }
  }
  // Word count prefix - breakdown of words across all sections
  if(ql && (ql.startsWith('wc:') || ql==='wc' || ql==='wordcount' || ql==='words')){
    const docW=S.docs.reduce((a,d)=>a+countW(d.body),0);
    const contentW=S.content.reduce((a,c)=>a+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
    const specW=S.specs.reduce((a,s)=>a+(s.sections||[]).reduce((b,sec)=>b+countW(sec.body),0),0);
    const totalW=docW+contentW+specW;
    items.unshift({title:'Total: '+totalW.toLocaleString()+' words',desc:'Docs: '+docW.toLocaleString()+' | Content: '+contentW.toLocaleString()+' | Specs: '+specW.toLocaleString(),icon:'W',type:'info'});
    items.unshift({title:'Writer: '+docW.toLocaleString()+'w ('+S.docs.length+' docs)',desc:'Avg '+Math.round(docW/Math.max(1,S.docs.length))+' words/doc',icon:'W',type:'action',action:()=>{closeCommandPalette();switchSection('writer',null);}});
    items.unshift({title:'Content: '+contentW.toLocaleString()+'w ('+S.content.length+' items)',desc:'Avg '+Math.round(contentW/Math.max(1,S.content.length))+' words/item',icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});
    items.unshift({title:'Living Docs: '+specW.toLocaleString()+'w ('+S.specs.length+' specs)',desc:'Avg '+Math.round(specW/Math.max(1,S.specs.length))+' words/spec',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSection('specs',null);}});
  }
  // Export prefix - list all export actions
  if(ql && (ql.startsWith('export:') || ql==='export' || ql==='exports')){
    items.unshift({title:'Export Tasks as HTML',desc:S.tasks.length+' tasks grouped by project',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllTasksHTML();}});
    items.unshift({title:'Export Specs as HTML',desc:S.specs.length+' living docs with sections',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllSpecsHTML();}});
    items.unshift({title:'Export Content as HTML',desc:S.content.length+' items grouped by theme',icon:'E',type:'action',action:()=>{closeCommandPalette();exportContentHTML();}});
    items.unshift({title:'Export All Docs as HTML',desc:S.docs.length+' documents',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllDocsHTML();}});
    items.unshift({title:'Export Tasks as Markdown',desc:'Copy filtered tasks to clipboard',icon:'E',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);exportTasks();}});
    items.unshift({title:'Export Links as Markdown',desc:'Copy categorized links to clipboard',icon:'E',type:'action',action:()=>{closeCommandPalette();exportLinksMarkdown();}});
    items.unshift({title:'Export Links as HTML',desc:S.links.length+' links grouped by category',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllLinksHTML();}});
    items.unshift({title:'Export Content as MD',desc:S.content.length+' items grouped by type',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllContentMD();}});
    items.unshift({title:'Export Docs as MD',desc:S.docs.length+' writer documents as Markdown',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllDocsMD();}});
    items.unshift({title:'Export Tasks as ICS',desc:'Active tasks as calendar file',icon:'E',type:'action',action:()=>{closeCommandPalette();exportTasksICS();}});
    items.unshift({title:'Export Whiteboard as Text',desc:'Copy node outline to clipboard',icon:'E',type:'action',action:()=>{closeCommandPalette();wbExport('text');}});
    items.unshift({title:'Export All Data (JSON)',desc:'Full backup of all sections',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAll();}});
  }
  // Progress prefix - project completion percentages
  if(ql && (ql.startsWith('progress:') || ql==='progress' || ql==='pct')){
    const projs=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    projs.forEach(p=>{const all=S.tasks.filter(t=>t.project===p);const done=all.filter(t=>t.status==='done').length;const pct=all.length?Math.round(done/all.length*100):0;items.unshift({title:p+' — '+pct+'%',desc:done+'/'+all.length+' done | '+(all.length-done)+' remaining',icon:'%',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);filterTaskProject(p);}});});
    const allT=S.tasks.length;const allD=S.tasks.filter(t=>t.status==='done').length;const allPct=allT?Math.round(allD/allT*100):0;
    items.push({title:'Overall — '+allPct+'%',desc:allD+'/'+allT+' tasks done',icon:'%',type:'info'});
  }
  // Blocked prefix - show blocked tasks
  if(ql && (ql.startsWith('blocked:') || ql==='blocked')){
    const blocked=S.tasks.filter(t=>t.status==='blocked');
    blocked.forEach(t=>{items.unshift({title:t.title||'Untitled',desc:(t.blockedBy?'Blocked by: '+t.blockedBy+' | ':'')+(t.project||'')+(t.due?' | due '+relativeDate(t.due):''),icon:'B',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    if(!blocked.length)items.unshift({title:'No blocked tasks',desc:'All tasks are unblocked',icon:'B',type:'info'});
  }
  // Random prefix - random content/doc for review
  if(ql && (ql.startsWith('random:') || ql==='random' || ql==='rand')){
    const rType=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
    if(!rType||rType==='content'||rType==='c'){const c=S.content[Math.floor(Math.random()*S.content.length)];if(c)items.unshift({title:c.body.substring(0,60)+'...',desc:'Random content | '+c.type+(c.theme?' | '+c.theme:''),icon:'?',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);navigator.clipboard.writeText(c.body);toast('Random content copied');}});}
    if(!rType||rType==='doc'||rType==='d'){const d=S.docs[Math.floor(Math.random()*S.docs.length)];if(d)items.unshift({title:d.title||'Untitled',desc:'Random doc | '+countW(d.body)+'w',icon:'?',type:'action',action:()=>{closeCommandPalette();switchSection('writer',null);switchDoc(d.id);}});}
    if(!rType||rType==='task'||rType==='t'){const t=S.tasks.filter(x=>x.status!=='done')[Math.floor(Math.random()*S.tasks.filter(x=>x.status!=='done').length)];if(t)items.unshift({title:t.title||'Untitled',desc:'Random task | '+(t.priority||'p2')+' | '+(t.project||''),icon:'?',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});}
  }
  // Starred prefix - all starred items
  if(ql && (ql.startsWith('starred:') || ql==='starred' || ql==='star')){
    const sq=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
    S.docs.filter(d=>d.starred).forEach(d=>{if(!sq||(d.title||'').toLowerCase().includes(sq))items.unshift({title:d.title||'Untitled',desc:'Starred doc | '+countW(d.body)+'w',icon:'*',type:'action',action:()=>{closeCommandPalette();switchSection('writer',null);switchDoc(d.id);}});});
    S.content.filter(c=>c.starred).forEach(c=>{if(!sq||c.body.toLowerCase().includes(sq))items.unshift({title:c.body.substring(0,60),desc:'Starred content | '+c.type,icon:'*',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});});
    if(!items.length)items.unshift({title:'No starred items',desc:'Star docs or content with the * button',icon:'*',type:'info'});
  }
  // Week prefix - tasks due this week
  if(ql && (ql.startsWith('week:') || ql==='week')){
    const today=new Date();const weekEnd=new Date(today);weekEnd.setDate(today.getDate()+(7-today.getDay()));
    const todayStr=today.toISOString().split('T')[0];const weekEndStr=weekEnd.toISOString().split('T')[0];
    const weekTasks=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due>=todayStr&&t.due<=weekEndStr);
    weekTasks.sort((a,b)=>a.due.localeCompare(b.due));
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    weekTasks.forEach(t=>{const d=new Date(t.due+'T12:00:00');items.unshift({title:t.title||'Untitled',desc:dayNames[d.getDay()]+' '+t.due+' | '+(t.priority||'p2')+' | '+(t.project||''),icon:'W',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    if(!weekTasks.length)items.unshift({title:'No tasks due this week',desc:'Clear schedule ahead',icon:'W',type:'info'});
  }
  // Overdue tasks prefix
  if(ql && ql.startsWith('overdue:') || (ql && ql==='overdue')){
    const today=new Date().toISOString().split('T')[0];
    const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
    overdue.sort((a,b)=>a.due.localeCompare(b.due));
    overdue.slice(0,10).forEach(t=>{
      const daysLate=Math.ceil((new Date()-new Date(t.due+'T12:00:00'))/86400000);
      items.unshift({title:t.title||'Untitled',desc:t.due+' ('+daysLate+'d late) | '+(t.priority||'p2')+' | '+(t.project||'no project'),icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    if(!overdue.length)items.unshift({title:'No overdue tasks',desc:'All caught up',icon:'v',type:'info'});
  }
  // Priority filter from Cmd+K
  if(ql && ql.startsWith('priority:') || ql && ql.startsWith('p:')) {
    const pq=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
    const pMap={'0':'p0','1':'p1','2':'p2','3':'p3','p0':'p0','p1':'p1','p2':'p2','p3':'p3','critical':'p0','high':'p1','medium':'p2','low':'p3'};
    const p=pMap[pq];
    if(p){
      const cnt=S.tasks.filter(t=>t.priority===p&&t.status!=='done').length;
      items.unshift({title:'Priority: '+p.toUpperCase()+' ('+cnt+' active)',desc:'Show '+p+' tasks',icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);setTaskFilter('active');document.getElementById('task-sort').value='priority';renderTasks();toast('Sorted by priority');}});
    }
  }
  // Status filter from Cmd+K
  if(ql && ql.startsWith('status:')) {
    const sq=q.substring(7).trim().toLowerCase();
    const statuses={todo:'todo',wip:'progress','in progress':'progress',progress:'progress',done:'done',blocked:'blocked',active:'active'};
    const st=statuses[sq];
    if(st){
      const cnt=st==='active'?S.tasks.filter(t=>t.status!=='done').length:S.tasks.filter(t=>t.status===st).length;
      items.unshift({title:'Filter: '+sq+' ('+cnt+')',desc:'Show '+sq+' tasks',icon:'F',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);setTaskFilter(st);renderTasks();}});
    }
  }
  // Due date filter from Cmd+K
  if(ql && ql.startsWith('due:')) {
    const dq=q.substring(4).trim();
    const parsed=parseNaturalDate(dq);
    if(parsed&&/^\d{4}-\d{2}-\d{2}$/.test(parsed)){
      const matching=S.tasks.filter(t=>t.due===parsed&&t.status!=='done');
      items.unshift({title:'Tasks due '+relativeDate(parsed)+' ('+matching.length+')',desc:matching.slice(0,3).map(t=>t.title).join(', ')||'No tasks',icon:'D',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);setTaskFilter('active');document.getElementById('task-sort').value='due';renderTasks();toast(matching.length+' tasks due '+parsed);}});
    }
  }
  // Quick spec search from Cmd+K
  if(ql && ql.startsWith('spec:')) {
    const sq=q.substring(5).trim().toLowerCase();
    if(sq){
      S.specs.filter(s=>s.title&&s.title.toLowerCase().includes(sq)).forEach(s=>{
        const w=(s.sections||[]).reduce((a,sec)=>a+countW(sec.body),0);
        items.unshift({title:s.title,desc:w+'w / '+(s.sections||[]).length+' sections',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(s.id);switchSection('specs',null);}});
      });
    }
  }
  // Quick doc search from Cmd+K
  if(ql && ql.startsWith('doc:')) {
    const dq=q.substring(4).trim().toLowerCase();
    if(dq){
      S.docs.filter(d=>d.title&&d.title.toLowerCase().includes(dq)).forEach(d=>{
        const w=countW(d.body);
        items.unshift({title:d.title,desc:w+'w'+(d.tags&&d.tags.length?' / '+d.tags.join(', '):''),icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});
      });
    }
  }
  // Quick goto from Cmd+K
  if(ql && ql.startsWith('goto:')) {
    const gq=q.substring(5).trim().toLowerCase();
    if(gq){
      S.tasks.filter(t=>t.title&&t.title.toLowerCase().includes(gq)).slice(0,3).forEach(t=>{items.unshift({title:'Go: '+t.title,desc:'Open task detail',icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
      S.docs.filter(d=>d.title&&d.title.toLowerCase().includes(gq)).slice(0,3).forEach(d=>{items.unshift({title:'Go: '+d.title,desc:'Open in writer',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});
      S.specs.filter(s=>s.title&&s.title.toLowerCase().includes(gq)).slice(0,3).forEach(s=>{items.unshift({title:'Go: '+s.title,desc:'Open living doc',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(s.id);switchSection('specs',null);}});});
    }
  }
  // Quick calc from Cmd+K
  if(ql && ql.startsWith('calc:')) {
    const expr=q.substring(5).trim();
    if(expr){
      try{const result=Function('"use strict";return ('+expr+')')();items.unshift({title:'= '+result,desc:'Copy result to clipboard',icon:'#',type:'action',action:()=>{closeCommandPalette();navigator.clipboard.writeText(String(result)).then(()=>toast('Copied: '+result));}});}catch(e){items.unshift({title:'Error: '+e.message,desc:'Invalid expression',icon:'!',type:'info'});}
    }
  }
  // Open specific docs in Zen Writer
  if(ql && ('zen '.includes(ql.substring(0,4)) || ql.startsWith('zen '))) {
    S.docs.forEach(function(d) {
      if(d.title) items.push({title:'Zen: ' + d.title, desc:'Open in Zen Writer', icon:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>', type:'action', action:function(){ closeCommandPalette(); zenOpen(d.id); }});
    });
  }
  // Duplicate task from Cmd+K
  if(ql && ql.startsWith('dup:')){
    const dq=q.substring(4).trim().toLowerCase();
    if(dq){S.tasks.filter(t=>t.title.toLowerCase().includes(dq)).slice(0,5).forEach(t=>{items.unshift({title:'Dup: '+t.title,desc:t.project?(t.project+' | '+t.priority):(t.priority||'p2'),icon:'+',type:'action',action:()=>{closeCommandPalette();const n={...JSON.parse(JSON.stringify(t)),id:Date.now(),created:new Date().toISOString(),status:'todo'};delete n.completedAt;delete n.timeSpent;delete n.timeStarted;delete n.log;S.tasks.unshift(n);save();if(currentSection==='tasks')renderTasks();toast('Duplicated: '+t.title);}});});}
  }
  // Sort by tag prefix
  if(ql && (ql.startsWith('tag-tasks:') || ql==='tag-tasks')){
    const tq=q.substring(10).trim().toLowerCase();
    const allTaskTags=[...new Set(S.tasks.flatMap(t=>t.tags||[]).filter(Boolean))].sort();
    const filtered=tq?allTaskTags.filter(t=>t.includes(tq)):allTaskTags;
    filtered.slice(0,8).forEach(tag=>{const cnt=S.tasks.filter(t=>(t.tags||[]).includes(tag)).length;items.unshift({title:'Tag: '+tag,desc:cnt+' tasks',icon:'T',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);document.getElementById('task-search').value='#'+tag;renderTasks();toast('Filtered by tag: '+tag);}});});
    if(!filtered.length)items.unshift({title:'No task tags found',desc:tq?'No tags matching "'+tq+'"':'No tasks have tags yet',icon:'!',type:'info'});
  }
  // Backup prefix — quick backup info
  if(ql && (ql.startsWith('backup:') || ql==='backup')){
    const size=JSON.stringify(S).length;const kb=Math.round(size/1024);
    items.unshift({title:'Backup size: '+kb+'KB',desc:'Tasks: '+S.tasks.length+' | Content: '+S.content.length+' | Docs: '+S.docs.length+' | Specs: '+S.specs.length+' | Links: '+S.links.length,icon:'B',type:'info'});
    items.push({title:'Export as JSON',desc:'Full backup of all data',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAll();}});
    items.push({title:'Export Tasks as HTML',desc:'Styled task export',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllTasksHTML();}});
    items.push({title:'Export Docs as MD',desc:'All writer documents',icon:'E',type:'action',action:()=>{closeCommandPalette();exportAllDocsMD();}});
    items.push({title:'Cloud Save',desc:'Save to Vercel Blob',icon:'C',type:'action',action:()=>{closeCommandPalette();cloudSave();}});
  }
  // Find prefix — powerful cross-section search with counts
  if(ql && ql.startsWith('find:')){
    const fq=q.substring(5).trim().toLowerCase();
    if(fq&&fq.length>=2){
      const taskHits=S.tasks.filter(t=>(t.title+' '+(t.description||'')+' '+(t.tags||[]).join(' ')).toLowerCase().includes(fq));
      const contentHits=S.content.filter(c=>(c.body+' '+c.theme+' '+(c.tags||[]).join(' ')).toLowerCase().includes(fq));
      const docHits=S.docs.filter(d=>{const tmp=document.createElement('div');tmp.innerHTML=d.body||'';return((d.title||'')+' '+(tmp.innerText||'')).toLowerCase().includes(fq);});
      const specHits=S.specs.filter(s=>(s.title||'').toLowerCase().includes(fq)||(s.sections||[]).some(sec=>((sec.title||'')+' '+(sec.body||'')).toLowerCase().includes(fq)));
      const linkHits=S.links.filter(l=>(l.title+' '+l.url+' '+(l.desc||'')).toLowerCase().includes(fq));
      items.unshift({title:'Found: '+taskHits.length+' tasks, '+contentHits.length+' content, '+docHits.length+' docs',desc:specHits.length+' specs, '+linkHits.length+' links | "'+fq+'"',icon:'?',type:'info'});
      taskHits.slice(0,3).forEach(t=>{items.push({title:t.title,desc:'Task - '+t.status+' / '+t.priority,icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
      docHits.slice(0,2).forEach(d=>{items.push({title:d.title||'Untitled',desc:'Document - '+countW(d.body)+'w',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});
      contentHits.slice(0,2).forEach(c=>{items.push({title:c.body.substring(0,50),desc:'Content - '+c.type,icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);document.getElementById('content-search').value=fq;renderContent();}});});
      linkHits.slice(0,2).forEach(l=>{items.push({title:l.title,desc:l.url,icon:'L',type:'action',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});
    }
  }
  // Streak prefix — consecutive days with completed tasks
  if(ql && (ql.startsWith('streak:') || ql==='streak' || ql==='streaks')){
    const dates=new Set();S.tasks.forEach(t=>{if(t.completedAt)dates.add(t.completedAt.split('T')[0]);});
    let streak=0;const d=new Date();d.setHours(0,0,0,0);
    while(dates.has(d.toISOString().split('T')[0])||d.toISOString().split('T')[0]===new Date().toISOString().split('T')[0]){if(dates.has(d.toISOString().split('T')[0]))streak++;d.setDate(d.getDate()-1);}
    const totalDays=dates.size;const longestStreak=(()=>{const sorted=[...dates].sort();let max=1,cur=1;for(let i=1;i<sorted.length;i++){const prev=new Date(sorted[i-1]+'T12:00:00'),curr=new Date(sorted[i]+'T12:00:00');if(Math.round((curr-prev)/86400000)===1){cur++;if(cur>max)max=cur;}else cur=1;}return sorted.length?max:0;})();
    items.unshift({title:'Current streak: '+streak+' day'+(streak!==1?'s':''),desc:'Best: '+longestStreak+' days | Total active days: '+totalDays,icon:'*',type:'info'});
    const last7=[];for(let i=0;i<7;i++){const dd=new Date();dd.setDate(dd.getDate()-i);const ds=dd.toISOString().split('T')[0];const cnt=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length;if(cnt)last7.push({date:ds,count:cnt});}
    last7.forEach(d=>{items.push({title:d.date+': '+d.count+' completed',desc:'',icon:'T',type:'info'});});
  }
  // Matrix prefix — priority x status breakdown
  if(ql && (ql.startsWith('matrix:') || ql==='matrix')){
    const active=S.tasks.filter(t=>t.status!=='done');
    const statuses=['todo','progress','blocked'];
    const priorities=['p0','p1','p2','p3'];
    const pLabels={p0:'P0 Critical',p1:'P1 High',p2:'P2 Medium',p3:'P3 Low'};
    const sLabels={todo:'To Do',progress:'In Progress',blocked:'Blocked'};
    items.unshift({title:'Priority Matrix: '+active.length+' active tasks',desc:'Tasks grouped by priority x status',icon:'M',type:'info'});
    priorities.forEach(p=>{const pTasks=active.filter(t=>(t.priority||'p2')===p);if(pTasks.length){const statusCounts=statuses.map(s=>pTasks.filter(t=>t.status===s).length);items.push({title:pLabels[p]+': '+pTasks.length+' tasks',desc:'Todo: '+statusCounts[0]+' | In Progress: '+statusCounts[1]+' | Blocked: '+statusCounts[2],icon:p==='p0'?'!':p==='p1'?'*':'T',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);document.getElementById('task-sort').value='priority';renderTasks();}});}});
  }
  // Inbox prefix — unprocessed items needing attention
  if(ql && (ql.startsWith('inbox:') || ql==='inbox' || ql==='triage')){
    const unprocessed=S.tasks.filter(t=>t.status==='todo'&&(!t.tags||!t.tags.length)&&(!t.project)&&(t.priority==='p2'||!t.priority));
    const noDesc=S.tasks.filter(t=>t.status!=='done'&&(!t.description||!t.description.trim()));
    const noDue=S.tasks.filter(t=>t.status!=='done'&&!t.due);
    items.unshift({title:'Inbox: '+unprocessed.length+' unprocessed tasks',desc:'No tags, no project, default priority — need triage',icon:'!',type:'info'});
    if(noDue.length>5)items.push({title:noDue.length+' tasks without due dates',desc:'Add dates for better planning',icon:'T',type:'info'});
    if(noDesc.length>5)items.push({title:noDesc.length+' tasks without descriptions',desc:'Add context for clarity',icon:'T',type:'info'});
    unprocessed.slice(0,8).forEach(t=>{items.push({title:t.title,desc:'Created '+timeAgo(t.created)+' — needs project, tags, priority',icon:'+',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Compare prefix — compare two projects
  if(ql && ql.startsWith('compare:')){
    const cq=q.substring(8).trim().toLowerCase();
    const allProjs=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    if(!cq){items.unshift({title:'Usage: compare:project1:project2',desc:'Available: '+allProjs.join(', '),icon:'C',type:'info'});}
    else{const parts=cq.split(':').map(p=>p.trim()).filter(Boolean);
    if(parts.length>=2){const p1=parts[0],p2=parts[1];
    const t1=S.tasks.filter(t=>t.project&&t.project.toLowerCase().includes(p1));const t2=S.tasks.filter(t=>t.project&&t.project.toLowerCase().includes(p2));
    const done1=t1.filter(t=>t.status==='done').length,done2=t2.filter(t=>t.status==='done').length;
    const active1=t1.filter(t=>t.status!=='done').length,active2=t2.filter(t=>t.status!=='done').length;
    const time1=t1.reduce((a,t)=>a+(t.timeSpent||0),0),time2=t2.reduce((a,t)=>a+(t.timeSpent||0),0);
    items.unshift({title:p1+' vs '+p2,desc:'Tasks: '+t1.length+' vs '+t2.length+' | Done: '+done1+' vs '+done2+' | Active: '+active1+' vs '+active2,icon:'C',type:'info'});
    items.push({title:p1+': '+t1.length+' tasks ('+done1+' done, '+active1+' active)',desc:'Time: '+(time1?formatTimeSpent(time1):'none')+' | Completion: '+Math.round(t1.length?done1/t1.length*100:0)+'%',icon:'1',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p1;renderTasks();}});
    items.push({title:p2+': '+t2.length+' tasks ('+done2+' done, '+active2+' active)',desc:'Time: '+(time2?formatTimeSpent(time2):'none')+' | Completion: '+Math.round(t2.length?done2/t2.length*100:0)+'%',icon:'2',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p2;renderTasks();}});
    }else{const matching=allProjs.filter(p=>p.toLowerCase().includes(parts[0]));
    items.unshift({title:'Type: compare:'+parts[0]+':second-project',desc:'Matches: '+matching.join(', '),icon:'C',type:'info'});}}
  }
  // Template prefix — quick task creation from templates
  if(ql && (ql.startsWith('template:') || ql==='template' || ql==='templates')){
    const templates=[
      {title:'Daily standup review',priority:'p1',tags:['daily','routine']},
      {title:'Weekly planning session',priority:'p1',tags:['weekly','planning'],recurrence:'weekly'},
      {title:'Code review',priority:'p2',tags:['dev','review']},
      {title:'Bug fix',priority:'p0',tags:['dev','bug']},
      {title:'Content creation',priority:'p2',tags:['content','creative']},
      {title:'Research',priority:'p2',tags:['research']},
      {title:'Meeting prep',priority:'p1',tags:['meeting']},
      {title:'Deploy & verify',priority:'p1',tags:['dev','deploy']},
    ];
    items.unshift({title:'Task Templates ('+templates.length+')',desc:'Click to create from template',icon:'T',type:'info'});
    templates.forEach(tpl=>{
      items.push({title:tpl.title,desc:'Priority: '+tpl.priority+' | Tags: '+(tpl.tags||[]).join(', '),icon:'+',type:'action',action:()=>{
        closeCommandPalette();
        const t={id:Date.now(),title:tpl.title,description:'',subtasks:[],status:'todo',priority:tpl.priority,project:taskProjectFilter||'',due:'',tags:[...(tpl.tags||[])],created:new Date().toISOString()};
        if(tpl.recurrence)t.recurrence=tpl.recurrence;
        S.tasks.unshift(t);save();renderTasks();openTaskDetail(t.id);toast('Created from template');
      }});
    });
  }
  // Orphan prefix — find disconnected items
  if(ql && (ql.startsWith('orphan:') || ql==='orphan' || ql==='orphans')){
    const projNames=new Set((S.projects||[]).map(p=>p.name));
    const projIds=new Set((S.projects||[]).map(p=>p.id));
    const noProj=S.tasks.filter(t=>t.status!=='done'&&!t.project).length;
    const badProj=S.tasks.filter(t=>t.project&&!projNames.has(t.project)).length;
    const orphanSpecs=S.specs.filter(s=>s.projectId&&!projIds.has(s.projectId));
    const emptyDocs=S.docs.filter(d=>(!d.body||d.body.trim().length<10)&&(!d.title||d.title==='Untitled'));
    const oldTodo=S.tasks.filter(t=>t.status==='todo'&&t.created&&(Date.now()-new Date(t.created).getTime())>30*86400000);
    items.unshift({title:'Orphans: '+noProj+' tasks no project, '+orphanSpecs.length+' specs orphaned',desc:badProj+' tasks with unknown project | '+emptyDocs.length+' empty docs | '+oldTodo.length+' stale todos',icon:'?',type:'info'});
    if(noProj)items.push({title:noProj+' active tasks without a project',desc:'Click to filter unassigned',icon:'T',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);document.getElementById('task-search').value='';taskProjectFilter=null;renderTasks();}});
    orphanSpecs.forEach(s=>{items.push({title:'Orphan spec: '+(s.title||'Untitled'),desc:'Project ID '+s.projectId+' no longer exists',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(String(s.id));switchSection('specs',null);}});});
    oldTodo.slice(0,5).forEach(t=>{items.push({title:'Stale: '+t.title+' ('+timeAgo(t.created)+')',desc:'Todo for 30+ days',icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Health prefix — system health check
  if(ql && (ql.startsWith('health:') || ql==='health' || ql==='diagnostics')){
    const size=JSON.stringify(S).length;const kb=Math.round(size/1024);
    const maxKB=5000;const pct=Math.round(kb/maxKB*100);
    const emptyTasks=S.tasks.filter(t=>!t.title||!t.title.trim()).length;
    const dupLinks=S.links.filter((l,i)=>S.links.findIndex(x=>x.url===l.url)<i).length;
    const orphanSpecs=S.specs.filter(s=>s.projectId&&!(S.projects||[]).find(p=>p.id===s.projectId)).length;
    const oldBlocked=S.tasks.filter(t=>t.status==='blocked'&&t.created&&(Date.now()-new Date(t.created).getTime())>14*86400000).length;
    const noTagTasks=S.tasks.filter(t=>t.status!=='done'&&(!t.tags||!t.tags.length)).length;
    const noDueTasks=S.tasks.filter(t=>t.status!=='done'&&!t.due).length;
    const issues=[];
    if(pct>80)issues.push('Storage '+pct+'% full ('+kb+'KB/'+maxKB+'KB)');
    if(emptyTasks)issues.push(emptyTasks+' empty tasks');
    if(dupLinks)issues.push(dupLinks+' duplicate links');
    if(orphanSpecs)issues.push(orphanSpecs+' orphan specs');
    if(oldBlocked)issues.push(oldBlocked+' tasks blocked 14+ days');
    items.unshift({title:'Health: '+(issues.length?issues.length+' issues':'All good!'),desc:'Storage: '+kb+'KB ('+pct+'%) | '+S.tasks.length+' tasks | '+S.content.length+' content | '+S.docs.length+' docs',icon:issues.length?'!':'*',type:'info'});
    if(noDueTasks>5)items.push({title:noDueTasks+' active tasks without due dates',desc:'Consider adding dates for better planning',icon:'T',type:'info'});
    if(noTagTasks>10)items.push({title:noTagTasks+' active tasks without tags',desc:'Tags help with filtering and organization',icon:'T',type:'info'});
    issues.forEach(issue=>{items.push({title:issue,desc:'Click to run cleanup',icon:'!',type:'action',action:()=>{closeCommandPalette();openCommandPalette();document.getElementById('cmd-input').value='clean:';document.getElementById('cmd-input').dispatchEvent(new Event('input'));}});});
  }
  // Merge prefix — find similar tasks to merge
  if(ql && ql.startsWith('merge:')){
    const mq=q.substring(6).trim().toLowerCase();
    if(!mq||mq.length<2){items.unshift({title:'Usage: merge:keyword',desc:'Find similar tasks to merge (keeps first, deletes rest)',icon:'M',type:'info'});}
    else{const hits=S.tasks.filter(t=>t.title.toLowerCase().includes(mq));
    if(hits.length<2){items.unshift({title:'Need 2+ matching tasks to merge (found '+hits.length+')',desc:'Try a broader keyword',icon:'M',type:'info'});}
    else{items.unshift({title:'Found '+hits.length+' tasks matching "'+mq+'"',desc:'Click to merge into first match',icon:'M',type:'info'});
    items.push({title:'Merge all '+hits.length+' into: '+hits[0].title,desc:'Keeps first, combines descriptions/subtasks, deletes rest',icon:'M',type:'action',action:()=>{
      closeCommandPalette();const keep=hits[0];const rest=hits.slice(1);
      rest.forEach(t=>{if(t.description)keep.description=(keep.description||'')+'\n---\n'+t.description;if(t.subtasks&&t.subtasks.length){if(!keep.subtasks)keep.subtasks=[];keep.subtasks=keep.subtasks.concat(t.subtasks);}if(t.tags&&t.tags.length){if(!keep.tags)keep.tags=[];t.tags.forEach(tag=>{if(!keep.tags.includes(tag))keep.tags.push(tag);});}});
      S.tasks=S.tasks.filter(t=>!rest.includes(t));save();renderTasks();toast('Merged '+rest.length+' tasks into "'+keep.title+'"');
    }});
    hits.forEach(t=>{items.push({title:t.title,desc:t.status+' | '+t.priority+' | '+(t.project||''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}}
  }
  // Timeline prefix — chronological task overview
  if(ql && (ql.startsWith('timeline:') || ql==='timeline' || ql==='gantt')){
    const active=S.tasks.filter(t=>t.status!=='done'&&t.due).sort((a,b)=>a.due.localeCompare(b.due));
    const today=new Date().toISOString().split('T')[0];
    if(!active.length){items.unshift({title:'No tasks with due dates',desc:'Add due dates to see timeline',icon:'T',type:'info'});}
    else{
      items.unshift({title:'Timeline: '+active.length+' scheduled tasks',desc:'Sorted by due date',icon:'T',type:'info'});
      let lastMonth='';
      active.slice(0,15).forEach(t=>{
        const m=t.due.substring(0,7);const mLabel=new Date(t.due+'T12:00:00').toLocaleDateString('en-US',{month:'long',year:'numeric'});
        const isOverdue=t.due<today;const isToday=t.due===today;
        const prefix=isOverdue?'OVERDUE':isToday?'TODAY':t.due;
        items.push({title:prefix+': '+t.title,desc:t.priority+' | '+(t.project||'no project')+' | '+t.status,icon:isOverdue?'!':isToday?'*':'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
      });
    }
  }
  // Rename prefix — rename projects/tags globally
  if(ql && ql.startsWith('rename:')){
    const rq=q.substring(7).trim();
    if(!rq){items.unshift({title:'Usage: rename:old:new',desc:'Renames project names or tags across all sections',icon:'R',type:'info'});}
    else{const parts=rq.split(':');if(parts.length>=2){const old=parts[0].trim(),nw=parts[1].trim();
    if(old&&nw){
      const projCount=S.tasks.filter(t=>t.project===old).length;
      const tagCountT=S.tasks.filter(t=>(t.tags||[]).includes(old)).length;
      const tagCountC=S.content.filter(c=>(c.tags||[]).includes(old)).length;
      if(projCount)items.push({title:'Rename project "'+old+'" to "'+nw+'" ('+projCount+' tasks)',desc:'Updates all task project fields',icon:'R',type:'action',action:()=>{closeCommandPalette();S.tasks.forEach(t=>{if(t.project===old)t.project=nw;});save();renderTasks();toast('Renamed project in '+projCount+' tasks');}});
      if(tagCountT)items.push({title:'Rename task tag "'+old+'" to "'+nw+'" ('+tagCountT+' tasks)',desc:'Updates tag across all tasks',icon:'R',type:'action',action:()=>{closeCommandPalette();S.tasks.forEach(t=>{if(t.tags){const i=t.tags.indexOf(old);if(i>=0)t.tags[i]=nw;}});save();renderTasks();toast('Renamed tag in '+tagCountT+' tasks');}});
      if(tagCountC)items.push({title:'Rename content tag "'+old+'" to "'+nw+'" ('+tagCountC+' items)',desc:'Updates tag across all content',icon:'R',type:'action',action:()=>{closeCommandPalette();S.content.forEach(c=>{if(c.tags){const i=c.tags.indexOf(old);if(i>=0)c.tags[i]=nw;}});save();renderContent();toast('Renamed tag in '+tagCountC+' content items');}});
      if(!projCount&&!tagCountT&&!tagCountC)items.unshift({title:'No matches for "'+old+'"',desc:'Nothing to rename',icon:'R',type:'info'});
    }}else{items.unshift({title:'Usage: rename:old:new',desc:'Example: rename:myproject:new-name',icon:'R',type:'info'});}}
  }
  // Week prefix — upcoming week tasks breakdown
  if(ql && (ql.startsWith('week:') || ql==='week' || ql==='weekly')){
    const active=S.tasks.filter(t=>t.status!=='done'&&t.due);
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const days=[];for(let i=0;i<7;i++){const d=new Date();d.setDate(d.getDate()+i);days.push(d.toISOString().split('T')[0]);}
    const noDue=S.tasks.filter(t=>t.status!=='done'&&!t.due).length;
    items.unshift({title:'Week ahead: '+active.filter(t=>days.includes(t.due)).length+' tasks scheduled',desc:noDue+' tasks have no due date',icon:'W',type:'info'});
    days.forEach(d=>{const dayTasks=active.filter(t=>t.due===d);const dt=new Date(d+'T12:00:00');const label=dayNames[dt.getDay()]+' '+dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});if(dayTasks.length){dayTasks.forEach((t,i)=>{items.push({title:(i===0?label+': ':'')+t.title,desc:t.priority+' | '+(t.project||'')+(t.estimate?' | '+t.estimate:''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}else{items.push({title:label+': (free)',desc:'No tasks scheduled',icon:'-',type:'info'});}});
  }
  // Focus prefix — urgent/critical tasks at a glance
  if(ql && (ql.startsWith('focus:') || ql==='focus' || ql==='urgent')){
    const today=new Date().toISOString().split('T')[0];
    const active=S.tasks.filter(t=>t.status!=='done');
    const p0=active.filter(t=>t.priority==='p0');
    const p1=active.filter(t=>t.priority==='p1');
    const overdue=active.filter(t=>t.due&&t.due<today);
    const dueToday=active.filter(t=>t.due===today);
    const blocked=active.filter(t=>t.status==='blocked');
    items.unshift({title:'Focus: '+p0.length+' P0, '+p1.length+' P1, '+overdue.length+' overdue',desc:dueToday.length+' due today | '+blocked.length+' blocked | '+active.length+' total active',icon:'!',type:'info'});
    overdue.forEach(t=>{items.push({title:'OVERDUE: '+t.title,desc:(t.due||'')+' | '+t.priority+' | '+(t.project||''),icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    p0.filter(t=>!overdue.includes(t)).forEach(t=>{items.push({title:'P0: '+t.title,desc:t.status+' | '+(t.due||'no date')+' | '+(t.project||''),icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    p1.filter(t=>!overdue.includes(t)).slice(0,5).forEach(t=>{items.push({title:'P1: '+t.title,desc:t.status+' | '+(t.due||'no date')+' | '+(t.project||''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Daily activity log prefix
  if(ql && (ql.startsWith('daily:') || ql==='daily' || ql==='activity')){
    const todayStr=new Date().toISOString().split('T')[0];
    const doneToday=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(todayStr));
    const createdToday=S.tasks.filter(t=>t.created&&t.created.startsWith(todayStr));
    const contentToday=S.content.filter(c=>c.created&&c.created.startsWith(todayStr));
    const docsToday=S.docs.filter(d=>d.updated&&d.updated.startsWith(todayStr));
    const linksToday=S.links.filter(l=>l.created&&l.created.startsWith(todayStr));
    items.unshift({title:'Today: '+doneToday.length+' completed, '+createdToday.length+' created',desc:'Content: '+contentToday.length+' | Docs edited: '+docsToday.length+' | Links: '+linksToday.length,icon:'*',type:'info'});
    doneToday.slice(0,5).forEach(t=>{items.push({title:'Done: '+t.title,desc:(t.project||'No project')+' | '+t.priority,icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    createdToday.filter(t=>t.status!=='done').slice(0,3).forEach(t=>{items.push({title:'New: '+t.title,desc:t.status+' | '+t.priority,icon:'+',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Clean prefix — data cleanup actions
  if(ql && (ql.startsWith('clean:') || ql==='clean' || ql==='cleanup')){
    const emptyTasks=S.tasks.filter(t=>!t.title||!t.title.trim()).length;
    if(emptyTasks)items.unshift({title:'Remove '+emptyTasks+' empty tasks',desc:'Tasks with no title',icon:'x',type:'action',action:()=>{closeCommandPalette();S.tasks=S.tasks.filter(t=>t.title&&t.title.trim());save();renderTasks();toast('Removed '+emptyTasks+' empty tasks');}});
    const dupLinks=S.links.filter((l,i)=>S.links.findIndex(x=>x.url===l.url)<i).length;
    if(dupLinks)items.unshift({title:'Remove '+dupLinks+' duplicate links',desc:'Links with identical URLs',icon:'x',type:'action',action:()=>{closeCommandPalette();const seen=new Set();S.links=S.links.filter(l=>{if(seen.has(l.url))return false;seen.add(l.url);return true;});save();renderLinks();toast('Removed '+dupLinks+' duplicate links');}});
    const emptyDocs=S.docs.filter(d=>(!d.body||d.body.trim().length<5)&&(!d.title||d.title==='Untitled')).length;
    if(emptyDocs)items.unshift({title:'Remove '+emptyDocs+' empty documents',desc:'Untitled docs with no content',icon:'x',type:'action',action:()=>{closeCommandPalette();S.docs=S.docs.filter(d=>!(!d.body||d.body.trim().length<5)||!(d.title==='Untitled'||!d.title));save();renderDocList();toast('Removed '+emptyDocs+' empty docs');}});
    const oldDoneTasks=S.tasks.filter(t=>t.status==='done'&&t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())>30*86400000).length;
    if(oldDoneTasks)items.unshift({title:'Archive '+oldDoneTasks+' old completed tasks',desc:'Done tasks completed over 30 days ago',icon:'A',type:'action',action:()=>{closeCommandPalette();const old=S.tasks.filter(t=>t.status==='done'&&t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())>30*86400000);if(!S.archivedTasks)S.archivedTasks=[];S.archivedTasks=old.concat(S.archivedTasks);S.tasks=S.tasks.filter(t=>!old.includes(t));save();renderTasks();toast('Archived '+old.length+' old tasks');}});
    if(!emptyTasks&&!dupLinks&&!emptyDocs&&!oldDoneTasks)items.unshift({title:'All clean!',desc:'No cleanup actions needed',icon:'*',type:'info'});
  }
  // Project stats prefix
  if(ql && (ql.startsWith('project-stats:') || ql==='project-stats' || ql==='projects')){
    const psq=q.includes(':')?q.substring(q.indexOf(':')+1).trim().toLowerCase():'';
    const projs=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    const filtered=psq?projs.filter(p=>p.toLowerCase().includes(psq)):projs;
    filtered.slice(0,8).forEach(p=>{
      const tasks=S.tasks.filter(t=>t.project===p);const active=tasks.filter(t=>t.status!=='done').length;const done=tasks.filter(t=>t.status==='done').length;
      const docs=S.docs.filter(d=>(d.tags||[]).includes(p.toLowerCase())).length;const specs=S.specs.filter(s=>{const proj=(S.projects||[]).find(x=>x.id===s.projectId);return proj&&proj.name===p;}).length;
      const tm=tasks.reduce((a,t)=>a+(t.timeSpent||0),0);const pct=tasks.length?Math.round(done/tasks.length*100):0;
      items.unshift({title:p+' ('+pct+'%)',desc:active+' active, '+done+' done | '+specs+' specs'+(tm?' | '+formatTimeSpent(tm)+' tracked':''),icon:'P',type:'action',action:()=>{closeCommandPalette();switchSection('tasks',null);taskProjectFilter=p;renderTasks();}});
    });
    if(!filtered.length)items.unshift({title:'No projects found',desc:'Tasks have no project assignments',icon:'!',type:'info'});
  }
  // Dependency chain prefix
  if(ql && (ql.startsWith('deps:') || ql==='deps' || ql==='dependencies')){
    const blocked=S.tasks.filter(t=>t.blockedBy&&t.status!=='done');
    const blocking=S.tasks.filter(t=>{const tl=t.title.toLowerCase();return S.tasks.some(x=>x.blockedBy&&x.blockedBy.toLowerCase().includes(tl)&&x.status!=='done');});
    if(blocked.length){blocked.forEach(t=>{items.unshift({title:'BLOCKED: '+t.title,desc:'Blocked by: '+t.blockedBy,icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}
    if(blocking.length){blocking.forEach(t=>{const deps=S.tasks.filter(x=>x.blockedBy&&x.blockedBy.toLowerCase().includes(t.title.toLowerCase())&&x.status!=='done');items.unshift({title:'BLOCKING ('+deps.length+'): '+t.title,desc:'Blocks: '+deps.map(d=>d.title).join(', ').substring(0,80),icon:'B',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});}
    if(!blocked.length&&!blocking.length)items.unshift({title:'No dependencies found',desc:'No tasks are blocked or blocking others',icon:'*',type:'info'});
  }
  // Chart prefix
  if(ql && (ql.startsWith('chart:') || ql==='chart' || ql==='charts')){
    const cq=ql.startsWith('chart:')?q.substring(6).trim().toLowerCase():'status';
    const svgW=300;const svgH=160;const cx=80;const cy=80;const rad=60;
    let data=[];
    if(cq==='priority'||cq==='p'){
      data=[{label:'P0 Critical',value:S.tasks.filter(t=>t.priority==='p0'&&t.status!=='done').length,color:'#ef4444'},{label:'P1 High',value:S.tasks.filter(t=>t.priority==='p1'&&t.status!=='done').length,color:'#f97316'},{label:'P2 Medium',value:S.tasks.filter(t=>(t.priority==='p2'||!t.priority)&&t.status!=='done').length,color:'#eab308'},{label:'P3 Low',value:S.tasks.filter(t=>t.priority==='p3'&&t.status!=='done').length,color:'#6b7280'}];
    }else if(cq==='project'){
      const projs=[...new Set(S.tasks.map(t=>t.project||'No Project'))].sort();
      const pColors=['#4ade80','#22d3ee','#a855f7','#f472b6','#fbbf24','#f87171','#60a5fa','#34d399'];
      data=projs.slice(0,8).map((p,i)=>({label:p,value:S.tasks.filter(t=>(t.project||'No Project')===p&&t.status!=='done').length,color:pColors[i%pColors.length]}));
    }else{
      data=[{label:'To Do',value:S.tasks.filter(t=>t.status==='todo').length,color:'#22d3ee'},{label:'In Progress',value:S.tasks.filter(t=>t.status==='progress').length,color:'#4ade80'},{label:'Done',value:S.tasks.filter(t=>t.status==='done').length,color:'#6b7280'},{label:'Blocked',value:S.tasks.filter(t=>t.status==='blocked').length,color:'#f97316'}];
    }
    const total=data.reduce((a,d)=>a+d.value,0);
    if(total){let angle=-Math.PI/2;
      let svgParts=data.filter(d=>d.value).map(d=>{const pct=d.value/total;const sa=angle;const ea=angle+pct*Math.PI*2;const la=ea-sa>Math.PI?1:0;const x1=cx+rad*Math.cos(sa);const y1=cy+rad*Math.sin(sa);const x2=cx+rad*Math.cos(ea-0.001);const y2=cy+rad*Math.sin(ea-0.001);angle=ea;return`<path d="M${cx},${cy}L${x1},${y1}A${rad},${rad} 0 ${la} 1 ${x2},${y2}Z" fill="${d.color}" opacity="0.8"/>`;}).join('');
      const legend=data.filter(d=>d.value).map((d,i)=>`<g transform="translate(170,${20+i*18})"><rect width="8" height="8" rx="2" fill="${d.color}"/><text x="12" y="8" fill="var(--text-muted)" font-size="9" font-family="var(--mono)">${d.label}: ${d.value}</text></g>`).join('');
      items.unshift({title:'Task Chart (by '+(cq==='priority'||cq==='p'?'Priority':cq==='project'?'Project':'Status')+')',desc:'<svg xmlns="http://www.w3.org/2000/svg" width="'+svgW+'" height="'+svgH+'">'+svgParts+legend+'</svg>',icon:'C',type:'info'});
    }
    items.unshift({title:'chart:status',desc:'Pie chart by status',icon:'C',type:'info'});
    items.unshift({title:'chart:priority',desc:'Pie chart by priority',icon:'C',type:'info'});
    items.unshift({title:'chart:project',desc:'Pie chart by project',icon:'C',type:'info'});
  }
  // Config prefix
  if(ql && (ql.startsWith('config:') || ql==='config' || ql==='settings' || ql==='prefs')){
    if(!S.config)S.config={};
    items.unshift({title:'Word Goal: '+(S.wordGoal?.daily||500)+'/day',desc:'Type config:wordgoal:N to change',icon:'C',type:'action',action:()=>{const v=prompt('Daily word goal:',S.wordGoal?.daily||500);if(v&&parseInt(v)){if(!S.wordGoal)S.wordGoal={daily:500,log:{}};S.wordGoal.daily=parseInt(v);save();toast('Word goal: '+v);closeCommandPalette();}}});
    items.unshift({title:'Auto-save: '+(S.config.autoSaveMs||800)+'ms',desc:'Debounce interval for auto-save',icon:'C',type:'action',action:()=>{const v=prompt('Auto-save debounce (ms):',S.config.autoSaveMs||800);if(v&&parseInt(v)){S.config.autoSaveMs=parseInt(v);save();toast('Auto-save: '+v+'ms');closeCommandPalette();}}});
    items.unshift({title:'Board WIP limit: '+(S.config.wipLimit||5),desc:'Maximum tasks in "In Progress" before warning',icon:'C',type:'action',action:()=>{const v=prompt('WIP limit for In Progress:',S.config.wipLimit||5);if(v&&parseInt(v)){S.config.wipLimit=parseInt(v);save();toast('WIP limit: '+v);closeCommandPalette();}}});
    items.unshift({title:'Quick-add syntax: title #tag @project !priority ~date',desc:'Available modifiers in task quick-add input',icon:'?',type:'info'});
    items.unshift({title:'Data size: '+Math.round(JSON.stringify(S).length/1024)+'KB',desc:'Tasks: '+S.tasks.length+' | Content: '+S.content.length+' | Docs: '+S.docs.length,icon:'B',type:'info'});
  }
  // Word goal prefix
  if(ql && (ql.startsWith('wordgoal:') || ql==='wordgoal' || ql==='wgoal')){
    if(!S.wordGoal)S.wordGoal={daily:500,log:{}};
    const today=new Date().toISOString().split('T')[0];
    const gq=ql.startsWith('wordgoal:')?q.substring(9).trim():'';
    if(gq&&parseInt(gq)){S.wordGoal.daily=parseInt(gq);save();items.unshift({title:'Daily word goal set to '+S.wordGoal.daily,desc:'Track your writing across docs and content',icon:'*',type:'info'});}
    else{
      const todayWords=(()=>{let wc=0;S.docs.forEach(d=>{if(d.updated&&d.updated.startsWith(today))wc+=countW(d.body);});S.content.forEach(c=>{if(c.created&&c.created.startsWith(today))wc+=(c.body||'').trim().split(/\s+/).filter(x=>x.length).length;});return wc;})();
      const pct=S.wordGoal.daily?Math.round(todayWords/S.wordGoal.daily*100):0;
      items.unshift({title:'Today: '+todayWords+'/'+S.wordGoal.daily+' words ('+pct+'%)',desc:pct>=100?'Goal reached!':''+Math.max(0,S.wordGoal.daily-todayWords)+' words to go',icon:pct>=100?'*':'W',type:'info'});
      const last7=[];for(let i=0;i<7;i++){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];let wc=0;S.docs.forEach(doc=>{if(doc.updated&&doc.updated.startsWith(ds))wc+=countW(doc.body);});S.content.forEach(c=>{if(c.created&&c.created.startsWith(ds))wc+=(c.body||'').trim().split(/\s+/).filter(x=>x.length).length;});last7.push({day:ds,words:wc});}
      const weekTotal=last7.reduce((a,d)=>a+d.words,0);const avgDaily=Math.round(weekTotal/7);
      items.unshift({title:'This week: '+weekTotal+' words (avg '+avgDaily+'/day)',desc:'Type wordgoal:N to set daily goal (current: '+S.wordGoal.daily+')',icon:'W',type:'info'});
    }
  }
  // Review prefix
  if(ql && (ql.startsWith('review:') || ql==='review' || ql==='stale')){
    const today=new Date();const todayStr=today.toISOString().split('T')[0];
    const staleDays=14;const staleDate=new Date(today.getTime()-staleDays*86400000).toISOString();
    const staleTasks=S.tasks.filter(t=>t.status==='progress'&&t.created&&t.created<staleDate);
    const untitledDocs=S.docs.filter(d=>!d.title||d.title==='Untitled');
    const emptySpecs=S.specs.filter(s=>(s.sections||[]).every(sec=>!sec.body||sec.body.trim().length<10));
    const readLater=S.content.filter(c=>c.readLater);
    const noDescTasks=S.tasks.filter(t=>!t.description&&t.status!=='done').slice(0,5);
    if(staleTasks.length)staleTasks.slice(0,5).forEach(t=>{items.unshift({title:'Stale ('+timeAgo(t.created)+'): '+t.title,desc:'In progress for '+Math.round((today-new Date(t.created))/86400000)+'+ days',icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    if(untitledDocs.length)items.unshift({title:untitledDocs.length+' untitled documents',desc:'Documents without proper titles need naming',icon:'W',type:'info'});
    if(emptySpecs.length)items.unshift({title:emptySpecs.length+' specs with empty sections',desc:'Living docs needing content',icon:'S',type:'info'});
    if(readLater.length)items.unshift({title:readLater.length+' items in Read Later',desc:'Content marked for later review',icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);contentReadLaterFilter=true;const btn=document.getElementById('content-rl-btn');if(btn)btn.style.color='var(--accent-cyan)';renderContent();}});
    if(noDescTasks.length)items.unshift({title:noDescTasks.length+'+ tasks without description',desc:'Active tasks missing context/details',icon:'T',type:'info'});
    if(!staleTasks.length&&!untitledDocs.length&&!emptySpecs.length&&!readLater.length)items.unshift({title:'Nothing to review',desc:'All items are in good shape',icon:'*',type:'info'});
  }
  // Goal tracker prefix
  if(ql && (ql.startsWith('goal:') || ql==='goal' || ql==='goals')){
    if(!S.goals)S.goals=[];
    const gq=ql.startsWith('goal:')?q.substring(5).trim():'';
    if(gq && gq.startsWith('+')){
      const parts=gq.substring(1).trim().split('/');
      const name=parts[0]?.trim();const target=parseInt(parts[1])||100;const unit=parts[2]?.trim()||'';
      if(name){items.unshift({title:'Create goal: '+name+' (0/'+target+(unit?' '+unit:'')+')',desc:'Add new trackable goal',icon:'+',type:'action',action:()=>{S.goals.push({id:Date.now(),name,target,current:0,unit,created:new Date().toISOString()});save();toast('Goal created: '+name);closeCommandPalette();}});}
    }else{
      S.goals.forEach(g=>{
        const pct=g.target?Math.round((g.current/g.target)*100):0;
        const barW=80;const fillW=Math.min(Math.round((pct/100)*barW),barW);
        items.unshift({title:g.name+' ('+g.current+'/'+g.target+(g.unit?' '+g.unit:'')+') '+pct+'%',desc:'Click to increment | goal:+1 / goal:-1 to adjust',icon:'G',type:'action',action:()=>{
          const adj=prompt('Adjust "'+g.name+'" ('+g.current+'/'+g.target+')\nEnter new value or +/-N:','+'+(g.target>10?1:Math.ceil(g.target/10)));
          if(!adj)return;
          if(adj.startsWith('+'))g.current=Math.min(g.current+parseInt(adj.substring(1))||1,g.target);
          else if(adj.startsWith('-'))g.current=Math.max(g.current-(parseInt(adj.substring(1))||1),0);
          else g.current=Math.max(0,Math.min(parseInt(adj)||0,g.target));
          if(g.current>=g.target)toast('Goal completed: '+g.name+'!');
          save();closeCommandPalette();
        }});
      });
      if(!S.goals.length)items.unshift({title:'No goals yet',desc:'Type goal:+name/target/unit (e.g. goal:+Book chapters/12/chapters)',icon:'!',type:'info'});
    }
  }
  // Habit tracker prefix
  if(ql && (ql.startsWith('habit:') || ql==='habit' || ql==='habits')){
    if(!S.habits)S.habits=[];
    const today=new Date().toISOString().split('T')[0];
    const hq=ql.startsWith('habit:')?q.substring(6).trim():'';
    if(hq && hq.startsWith('+')){
      const name=hq.substring(1).trim();
      if(name){items.unshift({title:'Create habit: '+name,desc:'Add new daily habit',icon:'+',type:'action',action:()=>{S.habits.push({id:Date.now(),name,log:[]});save();toast('Habit created: '+name);closeCommandPalette();}});}
    }else{
      S.habits.forEach(h=>{
        const checkedToday=(h.log||[]).includes(today);
        const streak=(()=>{let s=0;const d=new Date();for(let i=0;i<30;i++){const ds=d.toISOString().split('T')[0];if((h.log||[]).includes(ds))s++;else if(i>0)break;d.setDate(d.getDate()-1);}return s;})();
        const last7=(()=>{const d=new Date();let c=0;for(let i=0;i<7;i++){const ds=d.toISOString().split('T')[0];if((h.log||[]).includes(ds))c++;d.setDate(d.getDate()-1);}return c;})();
        items.unshift({title:(checkedToday?'[x] ':'[ ] ')+h.name,desc:streak+' day streak | '+last7+'/7 this week'+(hq&&hq.startsWith('-')?' | click to delete':''),icon:'H',type:'action',action:()=>{
          if(hq&&hq.startsWith('-')){S.habits=S.habits.filter(x=>x.id!==h.id);save();toast('Deleted: '+h.name);}
          else{if(checkedToday){h.log=h.log.filter(d=>d!==today);}else{if(!h.log)h.log=[];h.log.push(today);}save();toast(checkedToday?'Unchecked: '+h.name:'Checked: '+h.name);}
          closeCommandPalette();
        }});
      });
      if(!S.habits.length)items.unshift({title:'No habits yet',desc:'Type habit:+name to create one (e.g. habit:+exercise)',icon:'!',type:'info'});
    }
  }
  // Activity log prefix
  if(ql && (ql.startsWith('log:') || ql==='log' || ql==='activity')){
    const events=[];
    S.tasks.forEach(t=>{if(t.created)events.push({time:t.created,text:'Task: '+t.title,type:'task',icon:'T'});if(t.log)t.log.forEach(e=>{if(e.at)events.push({time:e.at,text:t.title+' -> '+e.to,type:'task',icon:'T'});});});
    S.content.forEach(c=>{if(c.created)events.push({time:c.created,text:'Content: '+(c.title||c.body.substring(0,40)),type:'content',icon:'C'});});
    S.docs.forEach(d=>{if(d.updated)events.push({time:d.updated,text:'Doc: '+(d.title||'Untitled'),type:'doc',icon:'W'});else if(d.created)events.push({time:d.created,text:'Doc: '+(d.title||'Untitled'),type:'doc',icon:'W'});});
    S.links.forEach(l=>{if(l.created)events.push({time:l.created,text:'Link: '+(l.title||l.url),type:'link',icon:'L'});});
    events.sort((a,b)=>b.time.localeCompare(a.time));
    const lq=ql.startsWith('log:')?q.substring(4).trim().toLowerCase():'';
    const filtered=lq?events.filter(e=>e.text.toLowerCase().includes(lq)):events;
    filtered.slice(0,15).forEach(e=>{items.unshift({title:e.text,desc:timeAgo(e.time)+' | '+e.type,icon:e.icon,type:'info'});});
    if(!filtered.length)items.unshift({title:'No activity found',desc:'System activity log is empty',icon:'!',type:'info'});
  }
  // Focus timer prefix
  if(ql && (ql.startsWith('focus:') || ql==='focus' || ql==='pomodoro')){
    const fq=ql.startsWith('focus:')?q.substring(6).trim():'';
    const mins=parseInt(fq)||25;
    if(focusTimerInterval){
      const rem=Math.max(0,focusTimerEnd-Date.now());const m=Math.floor(rem/60000);const s=Math.floor((rem%60000)/1000);
      items.unshift({title:'Focus timer running: '+m+':'+String(s).padStart(2,'0'),desc:'Click to stop',icon:'F',type:'action',action:()=>{closeCommandPalette();stopFocusTimer();toast('Focus timer stopped');}});
    }else{
      const active=S.tasks.filter(t=>t.status==='progress');
      active.slice(0,5).forEach(t=>{
        items.unshift({title:'Focus on: '+t.title+' ('+mins+'min)',desc:'Start focus timer and track time to this task',icon:'F',type:'action',action:()=>{closeCommandPalette();startFocusTimer(t.id,mins);}});
      });
      items.unshift({title:'Focus timer: '+mins+' minutes (no task)',desc:'Type focus:N for custom minutes (default 25)',icon:'F',type:'action',action:()=>{closeCommandPalette();startFocusTimer(null,mins);}});
    }
  }
  // Writer stats prefix
  if(ql && (ql==='writerstats' || ql==='ws' || ql.startsWith('writerstats:'))){
    const totalWords=S.docs.reduce((a,d)=>a+countW(d.body),0);
    const totalDocs=S.docs.length;
    const avgWords=totalDocs?Math.round(totalWords/totalDocs):0;
    const longestDoc=S.docs.reduce((best,d)=>countW(d.body)>countW(best.body)?d:best,S.docs[0]||{body:''});
    const versionsTotal=S.docs.reduce((a,d)=>a+(d.versions||[]).length,0);
    const today=new Date().toISOString().split('T')[0];
    const todayEdited=S.docs.filter(d=>d.updated&&d.updated.startsWith(today)).length;
    const last7Docs=(()=>{const d=new Date();let c=0;for(let i=0;i<7;i++){const ds=d.toISOString().split('T')[0];c+=S.docs.filter(doc=>doc.updated&&doc.updated.startsWith(ds)).length;d.setDate(d.getDate()-1);}return c;})();
    const readTime=Math.max(1,Math.ceil(totalWords/238));
    items.unshift({title:'Today: '+todayEdited+' docs edited | This week: '+last7Docs+' updates',desc:'Versions saved: '+versionsTotal,icon:'W',type:'info'});
    items.unshift({title:'Average: '+avgWords+' words/doc | Read time: ~'+readTime+'min',desc:'Longest: '+(longestDoc.title||'Untitled')+' ('+countW(longestDoc.body)+'w)',icon:'W',type:'info'});
    items.unshift({title:'Writer Stats: '+totalDocs+' docs / '+totalWords.toLocaleString()+' words',desc:'Comprehensive writing statistics',icon:'W',type:'info'});
  }
  // Whiteboard search prefix
  if(ql && ql.startsWith('wb:')){
    const wbq=q.substring(3).trim().toLowerCase();
    if(wbq && S.wbNodes){
      const matches=S.wbNodes.filter(n=>(n.t||'').toLowerCase().includes(wbq)||(n.b||'').toLowerCase().includes(wbq));
      matches.slice(0,10).forEach(n=>{
        items.unshift({title:'WB: '+(n.t||'Node'),desc:(n.b||'').substring(0,80),icon:'W',type:'action',action:()=>{closeCommandPalette();switchSection('whiteboard',null);setTimeout(()=>{const el=document.querySelector('[data-wb-id="'+n.id+'"]');if(el){el.style.outline='3px solid var(--accent)';el.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>{el.style.outline='';},3000);}},300);}});
      });
      if(!matches.length)items.unshift({title:'No whiteboard nodes match "'+wbq+'"',desc:'Try a different search term',icon:'!',type:'info'});
    }else{items.unshift({title:'Type wb:searchterm to find whiteboard nodes',desc:'Searches node titles and body text',icon:'W',type:'info'});}
  }
  // Count prefix
  if(ql && ql.startsWith('count:')){
    const active=S.tasks.filter(t=>t.status!=='done').length;const done=S.tasks.filter(t=>t.status==='done').length;
    items.unshift({title:'Tasks: '+active+' active, '+done+' done ('+S.tasks.length+' total)',desc:'Content: '+S.content.length+' | Docs: '+S.docs.length+' | Specs: '+S.specs.length+' | Links: '+S.links.length+' | Repos: '+(S.repos||[]).length,icon:'#',type:'info'});
  }
  // Recent items from Cmd+K
  if(ql && ql.startsWith('recent:') || (!ql && recentItems.length)){
    const rq=ql&&ql.startsWith('recent:')?q.substring(7).trim().toLowerCase():'';
    const ri=rq?recentItems.filter(r=>r.title.toLowerCase().includes(rq)):recentItems;
    ri.slice(0,8).forEach(r=>{
      const sMap={task:'T',doc:'W',spec:'S',project:'P'};
      items.unshift({title:r.title,desc:'Recent '+r.type+' ('+timeAgo(r.time)+')',icon:sMap[r.type]||'*',type:'action',action:()=>{closeCommandPalette();if(r.type==='task')openTaskDetail(r.id);else if(r.type==='doc'){switchDoc(r.id);switchSection('writer',null);}else if(r.type==='spec'){switchSpec(r.id);switchSection('specs',null);}else if(r.type==='project')openProject(r.id);}});
    });
  }
  // Backup prefix
  if(ql && (ql==='backup' || ql.startsWith('backup:') || ql==='backups')){
    const dataSize=JSON.stringify(S).length;const kb=Math.round(dataSize/1024);
    const lastBackup=S._lastBackup||null;
    items.unshift({title:'Download Full Backup ('+kb+'KB)',desc:'JSON file with all data',icon:'B',type:'action',action:()=>{closeCommandPalette();const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='astra-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();S._lastBackup=new Date().toISOString();save();toast('Backup downloaded');}});
    items.unshift({title:'Restore from Backup',desc:'Upload a JSON backup file',icon:'B',type:'action',action:()=>{closeCommandPalette();const input=document.createElement('input');input.type='file';input.accept='.json';input.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const data=JSON.parse(ev.target.result);if(!data.tasks&&!data.content){toast('Invalid backup file');return;}if(!confirm('Restore backup? This replaces ALL current data.'))return;Object.assign(S,data);save();location.reload();}catch(err){toast('Invalid JSON file');}};r.readAsText(f);};input.click();}});
    items.unshift({title:'Data: '+S.tasks.length+'T / '+S.content.length+'C / '+S.docs.length+'D / '+S.links.length+'L',desc:(lastBackup?'Last backup: '+timeAgo(lastBackup):'No backup yet')+' | Size: '+kb+'KB',icon:'i',type:'info'});
  }
  // Sentiment prefix
  if(ql && (ql==='sentiment' || ql.startsWith('sentiment:') || ql==='mood' || ql==='tone')){
    const posWords=new Set(['great','good','amazing','excellent','love','happy','success','win','perfect','best','awesome','beautiful','wonderful','fantastic','brilliant','incredible']);
    const negWords=new Set(['bad','terrible','awful','hate','fail','wrong','broken','worst','ugly','problem','error','bug','issue','stuck','frustrated','angry']);
    let posCount=0,negCount=0,total=0;
    S.content.forEach(c=>{const words=(c.body||'').toLowerCase().split(/\s+/);words.forEach(w=>{const clean=w.replace(/[^a-z]/g,'');if(posWords.has(clean))posCount++;if(negWords.has(clean))negCount++;total++;});});
    const sentiment=posCount>negCount*1.5?'Positive':negCount>posCount*1.5?'Negative':'Neutral';
    const color=sentiment==='Positive'?'var(--accent)':sentiment==='Negative'?'var(--red)':'var(--yellow)';
    items.unshift({title:'Content Mood: '+sentiment,desc:posCount+' positive words, '+negCount+' negative words ('+S.content.length+' items, '+total+' total words)',icon:'M',type:'info'});
    const topPos=[];const topNeg=[];S.content.forEach(c=>{let p=0,n=0;(c.body||'').toLowerCase().split(/\s+/).forEach(w=>{const cl=w.replace(/[^a-z]/g,'');if(posWords.has(cl))p++;if(negWords.has(cl))n++;});if(p>n&&p>2)topPos.push({c,score:p});if(n>p&&n>2)topNeg.push({c,score:n});});
    topPos.sort((a,b)=>b.score-a.score).slice(0,3).forEach(x=>{items.unshift({title:'Positive: '+(x.c.body||'').substring(0,50)+'...',desc:x.score+' positive words',icon:'+',type:'info'});});
    topNeg.sort((a,b)=>b.score-a.score).slice(0,3).forEach(x=>{items.unshift({title:'Negative: '+(x.c.body||'').substring(0,50)+'...',desc:x.score+' negative words',icon:'-',type:'info'});});
  }
  // Timeline prefix
  if(ql && (ql==='timeline' || ql.startsWith('timeline:') || ql==='tl')){
    const days=parseInt(ql.startsWith('timeline:')?q.substring(9):'')||14;
    let tlHtml='';const now=new Date();
    for(let i=0;i<days;i++){
      const d=new Date(now);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];
      const created=S.tasks.filter(t=>t.created&&t.created.startsWith(ds)).length;
      const completed=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length;
      const content=S.content.filter(c=>c.created&&c.created.startsWith(ds)).length;
      const total=created+completed+content;
      if(total){const bar='|'.repeat(Math.min(total*2,20));const label=i===0?'Today':i===1?'Yesterday':ds.substring(5);tlHtml+=label.padEnd(8)+' '+bar+' +'+created+'t/'+completed+'d/'+content+'c\n';}
    }
    if(tlHtml)items.unshift({title:'Activity Timeline ('+days+' days)',desc:tlHtml.split('\n').slice(0,8).join(' / '),icon:'T',type:'info'});
    else items.unshift({title:'No activity in last '+days+' days',desc:'Type timeline:N for custom range',icon:'!',type:'info'});
  }
  // Cleanup prefix
  if(ql && (ql==='cleanup' || ql.startsWith('cleanup:') || ql==='clean')){
    const emptyTasks=S.tasks.filter(t=>!t.title||!t.title.trim());
    const dupTasks=(()=>{const seen=new Set();return S.tasks.filter(t=>{const key=t.title+'-'+t.project+'-'+t.due;if(seen.has(key))return true;seen.add(key);return false;});})();
    const oldDone=S.tasks.filter(t=>t.status==='done'&&t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())>30*86400000);
    const emptyContent=S.content.filter(c=>!c.body||c.body.trim().length<5);
    if(emptyTasks.length)items.unshift({title:'Remove '+emptyTasks.length+' empty tasks',desc:'Tasks with no title',icon:'!',type:'action',action:()=>{closeCommandPalette();S.tasks=S.tasks.filter(t=>t.title&&t.title.trim());save();renderTasks();toast('Removed '+emptyTasks.length+' empty tasks');}});
    if(dupTasks.length)items.unshift({title:'Found '+dupTasks.length+' potential duplicate tasks',desc:'Same title + project + due date',icon:'!',type:'info'});
    if(oldDone.length)items.unshift({title:'Archive '+oldDone.length+' old completed tasks (30+ days)',desc:'Move to archive to keep board clean',icon:'A',type:'action',action:()=>{closeCommandPalette();if(!S.archivedTasks)S.archivedTasks=[];S.archivedTasks=oldDone.concat(S.archivedTasks);S.tasks=S.tasks.filter(t=>!(t.status==='done'&&t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())>30*86400000));save();renderTasks();toast('Archived '+oldDone.length+' old tasks');}});
    if(emptyContent.length)items.unshift({title:'Remove '+emptyContent.length+' empty content items',desc:'Content with fewer than 5 characters',icon:'!',type:'action',action:()=>{closeCommandPalette();S.content=S.content.filter(c=>c.body&&c.body.trim().length>=5);save();renderContent();toast('Removed '+emptyContent.length+' empty items');}});
    if(!emptyTasks.length&&!dupTasks.length&&!oldDone.length&&!emptyContent.length)items.unshift({title:'Everything looks clean!',desc:'No empty tasks, no duplicates, no stale items',icon:'*',type:'info'});
  }
  // Random prefix
  if(ql && (ql==='random' || ql==='random:' || ql.startsWith('random:') || ql==='inspire' || ql==='surprise')){
    const rq=ql.startsWith('random:')?q.substring(7).trim().toLowerCase():'';
    const pool=[];
    if(!rq||rq==='task')S.tasks.filter(t=>t.status!=='done').forEach(t=>pool.push({title:t.title,desc:'Task | '+t.priority+' | '+(t.project||'No project'),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}}));
    if(!rq||rq==='content')S.content.forEach(c=>pool.push({title:(c.body||'').substring(0,60),desc:'Content | '+(c.theme||c.type||''),icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}}));
    if(!rq||rq==='doc')S.docs.forEach(d=>pool.push({title:d.title||'Untitled',desc:'Doc | '+countW(d.body)+'w',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}}));
    if(pool.length){for(let i=0;i<Math.min(5,pool.length);i++){const idx=Math.floor(Math.random()*pool.length);items.unshift(pool.splice(idx,1)[0]);}
    }else{items.unshift({title:'Nothing to randomize yet',desc:'Add tasks, content, or docs first',icon:'!',type:'info'});}
  }
  // What's next prefix
  if(ql && (ql==='next' || ql==='whatsnext' || ql==="what's next")){
    const today=new Date().toISOString().split('T')[0];
    const candidates=S.tasks.filter(t=>t.status!=='done'&&t.status!=='blocked').sort((a,b)=>{const pMap={p0:0,p1:1,p2:2,p3:3};const pDiff=(pMap[a.priority]||2)-(pMap[b.priority]||2);if(pDiff!==0)return pDiff;if(a.due&&b.due)return a.due.localeCompare(b.due);if(a.due)return -1;if(b.due)return 1;return 0;});
    candidates.slice(0,5).forEach((t,i)=>{
      items.unshift({title:(i===0?'Next up: ':'')+(t.title||'Untitled'),desc:t.priority.toUpperCase()+' | '+(t.due?'Due: '+relativeDate(t.due):'No date')+' | '+(t.project||'No project'),icon:i===0?'>':'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    if(!candidates.length)items.unshift({title:'Nothing pending',desc:'All tasks are done or blocked',icon:'*',type:'info'});
  }
  // Export hub prefix
  if(ql && (ql.startsWith('export:') || ql==='export' || ql==='exports')){
    items.unshift({title:'Export Tasks (Markdown)',desc:'Copy filtered tasks as grouped markdown',icon:'T',type:'action',action:()=>{closeCommandPalette();exportTasks();}});
    items.unshift({title:'Export Tasks (CSV)',desc:'Download tasks as spreadsheet CSV',icon:'T',type:'action',action:()=>{closeCommandPalette();exportTasksCSV();}});
    items.unshift({title:'Export Content (Markdown)',desc:'Copy all content as markdown',icon:'C',type:'action',action:()=>{closeCommandPalette();exportFilteredContentMD();}});
    items.unshift({title:'Export Content (HTML)',desc:'Download content as styled HTML file',icon:'C',type:'action',action:()=>{closeCommandPalette();exportContentHTML();}});
    items.unshift({title:'Export Links (Markdown)',desc:'Copy all links categorized as markdown',icon:'L',type:'action',action:()=>{closeCommandPalette();exportLinks();}});
    items.unshift({title:'Export Calendar Week',desc:'Copy this week summary as markdown',icon:'D',type:'action',action:()=>{closeCommandPalette();exportWeek();}});
    if(typeof exportCurrentSpecMD==='function')items.unshift({title:'Export Current Spec (Markdown)',desc:'Copy active living doc as markdown',icon:'S',type:'action',action:()=>{closeCommandPalette();exportCurrentSpecMD();}});
    items.unshift({title:'Export All Data (JSON)',desc:'Download full state backup as JSON file',icon:'*',type:'action',action:()=>{closeCommandPalette();const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='astra-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();toast('Full backup exported');}});
  }
  // Task templates prefix
  if(ql && (ql.startsWith('tpl:') || ql==='tpl' || ql==='templates')){
    const templates=[
      {title:'Daily standup review',priority:'p1',recurrence:'weekday'},
      {title:'Weekly planning session',priority:'p1',recurrence:'weekly'},
      {title:'Code review',priority:'p2',recurrence:''},
      {title:'Bug fix',priority:'p0',recurrence:''},
      {title:'Write documentation',priority:'p2',recurrence:''},
      {title:'Brainstorm session',priority:'p3',recurrence:''},
      {title:'Deploy to production',priority:'p0',recurrence:''},
      {title:'User testing',priority:'p1',recurrence:''},
    ];
    templates.forEach(tpl=>{
      items.unshift({title:'+ '+tpl.title,desc:tpl.priority.toUpperCase()+(tpl.recurrence?' ('+tpl.recurrence+')':''),icon:'+',type:'action',action:()=>{closeCommandPalette();S.tasks.unshift({id:Date.now(),title:tpl.title,description:'',subtasks:[],status:'todo',priority:tpl.priority,project:taskProjectFilter||'',due:new Date().toISOString().split('T')[0],recurrence:tpl.recurrence||'',created:new Date().toISOString()});save();if(currentSection==='tasks')renderTasks();toast('Created: '+tpl.title);}});
    });
  }
  // Deep search prefix — search across ALL sections
  if(ql && (ql.startsWith('search:') || ql.startsWith('find:') || ql.startsWith('s:'))){
    const sq=(ql.startsWith('search:')?q.substring(7):ql.startsWith('find:')?q.substring(5):q.substring(2)).trim().toLowerCase();
    if(sq.length>=2){
      S.tasks.forEach(t=>{if((t.title+' '+t.description+' '+(t.tags||[]).join(' ')+' '+t.project).toLowerCase().includes(sq)){items.unshift({title:esc(t.title||'Untitled'),desc:'Task | '+t.status+' | '+(t.priority||'p2').toUpperCase()+(t.project?' | '+t.project:''),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});}});
      S.content.forEach(c=>{if((c.body+' '+(c.theme||'')+' '+(c.tags||[]).join(' ')).toLowerCase().includes(sq)){items.unshift({title:esc((c.body||'').substring(0,60)),desc:'Content | '+(c.theme||c.type||'uncategorized'),icon:'C',type:'action',action:()=>{closeCommandPalette();switchSection('content',null);}});}});
      S.docs.forEach(d=>{if((d.title+' '+d.body).toLowerCase().includes(sq)){items.unshift({title:esc(d.title||'Untitled'),desc:'Doc | '+countW(d.body)+' words',icon:'W',type:'action',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});}});
      S.links.forEach(l=>{if((l.title+' '+l.url+' '+l.desc+' '+(l.tags||[]).join(' ')).toLowerCase().includes(sq)){items.unshift({title:esc(l.title||l.url),desc:'Link | '+(l.category||'uncategorized')+' | '+l.url.substring(0,40),icon:'L',type:'action',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});}});
      (S.specs||[]).forEach(sp=>{const match=(sp.title||'').toLowerCase().includes(sq)||(sp.sections||[]).some(s=>(s.title+' '+s.body).toLowerCase().includes(sq));if(match){items.unshift({title:esc(sp.title||'Untitled Spec'),desc:'Spec | '+(sp.sections||[]).length+' sections',icon:'S',type:'action',action:()=>{closeCommandPalette();switchSpec(sp.id);switchSection('specs',null);}});}});
      (S.repos||[]).forEach(r=>{if((r.name+' '+(r.desc||'')+' '+(r.techStack||[]).join(' ')+' '+(r.notes||'')).toLowerCase().includes(sq)){items.unshift({title:esc(r.name),desc:'Repo | '+(r.status||'')+(r.live?' | '+r.live.substring(0,30):''),icon:'R',type:'action',action:()=>{closeCommandPalette();switchSection('repos',null);}});}});
      if(!items.length)items.unshift({title:'No results for "'+esc(sq)+'"',desc:'Searched tasks, content, docs, links, specs, repos',icon:'!',type:'info'});
    }else{items.unshift({title:'Type 2+ characters after search:',desc:'Searches tasks, content, docs, links, specs, repos',icon:'?',type:'info'});}
  }
  // History prefix — creation timeline across all sections
  if(ql && (ql==='history' || ql.startsWith('history:') || ql==='log' || ql==='activity')){
    const days=parseInt(ql.startsWith('history:')?q.substring(8):'')||7;
    const allItems=[];
    S.tasks.forEach(t=>{if(t.created)allItems.push({title:esc(t.title||'Untitled'),type:'Task',time:t.created,icon:'T',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    S.content.forEach(c=>{if(c.created)allItems.push({title:esc((c.body||'').substring(0,50)),type:'Content',time:c.created,icon:'C',action:()=>{closeCommandPalette();switchSection('content',null);}});});
    S.docs.forEach(d=>{if(d.created||d.updated)allItems.push({title:esc(d.title||'Untitled'),type:'Doc',time:d.updated||d.created,icon:'W',action:()=>{closeCommandPalette();switchDoc(d.id);switchSection('writer',null);}});});
    S.links.forEach(l=>{if(l.created)allItems.push({title:esc(l.title||l.url),type:'Link',time:l.created,icon:'L',action:()=>{closeCommandPalette();window.open(l.url,'_blank');}});});
    const cutoff=new Date();cutoff.setDate(cutoff.getDate()-days);
    const recent=allItems.filter(i=>new Date(i.time)>=cutoff).sort((a,b)=>new Date(b.time)-new Date(a.time));
    if(recent.length){
      items.unshift({title:'Activity (last '+days+' days): '+recent.length+' items',desc:'Type history:N for custom range',icon:'H',type:'info'});
      recent.slice(0,15).forEach(r=>{items.unshift({title:r.title,desc:r.type+' | '+timeAgo(r.time),icon:r.icon,type:'action',action:r.action});});
    }else{items.unshift({title:'No activity in last '+days+' days',desc:'Type history:N for custom range',icon:'!',type:'info'});}
  }
  // Digest prefix — daily briefing
  if(ql && (ql==='digest' || ql.startsWith('digest:') || ql==='brief' || ql==='morning')){
    const today=new Date().toISOString().split('T')[0];const now=new Date();
    const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
    const dueToday=S.tasks.filter(t=>t.status!=='done'&&t.due===today);
    const inProgress=S.tasks.filter(t=>t.status==='progress');
    const upcoming=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due>today&&t.due<=new Date(now.getTime()+7*86400000).toISOString().split('T')[0]).sort((a,b)=>a.due.localeCompare(b.due));
    const todayCreated=S.tasks.filter(t=>t.created&&t.created.startsWith(today)).length;
    const todayDone=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(today)).length;
    const docsToday=S.docs.filter(d=>d.updated&&d.updated.startsWith(today));
    const totalWords=docsToday.reduce((s,d)=>s+countW(d.body),0);
    items.unshift({title:'Daily Digest — '+new Date().toLocaleDateString('en-US',{weekday:'long',month:'short',day:'numeric'}),desc:dueToday.length+' due today | '+overdue.length+' overdue | '+inProgress.length+' in progress',icon:'D',type:'info'});
    if(overdue.length)items.unshift({title:'OVERDUE: '+overdue.length+' tasks need attention',desc:overdue.slice(0,3).map(t=>t.title).join(', '),icon:'!',type:'action',action:()=>{closeCommandPalette();setTaskFilter('overdue');switchSection('tasks',null);}});
    if(dueToday.length)dueToday.slice(0,3).forEach(t=>{items.unshift({title:'Due today: '+esc(t.title),desc:(t.priority||'p2').toUpperCase()+' | '+(t.project||'No project'),icon:'T',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
    if(inProgress.length)items.unshift({title:inProgress.length+' tasks in progress',desc:inProgress.slice(0,3).map(t=>t.title).join(', '),icon:'>',type:'info'});
    items.unshift({title:'Today: +'+todayCreated+' created, '+todayDone+' completed',desc:totalWords?'Wrote '+totalWords+' words across '+docsToday.length+' docs':'No writing today yet',icon:'*',type:'info'});
    if(upcoming.length)items.unshift({title:'Upcoming (7d): '+upcoming.length+' tasks',desc:upcoming.slice(0,3).map(t=>t.title+' ('+t.due.substring(5)+')').join(', '),icon:'U',type:'info'});
  }
  // Goals prefix — daily/weekly goals tracking
  if(ql && (ql==='goals' || ql.startsWith('goals:') || ql==='goal')){
    if(!S.goals)S.goals=[];
    const today=new Date().toISOString().split('T')[0];
    const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay()+1);const ws=weekStart.toISOString().split('T')[0];
    const todayGoals=S.goals.filter(g=>g.date===today);
    const weekGoals=S.goals.filter(g=>g.date>=ws&&g.type==='weekly');
    const doneToday=todayGoals.filter(g=>g.done).length;
    items.unshift({title:'Goals: '+doneToday+'/'+todayGoals.length+' today',desc:weekGoals.length+' weekly goals set',icon:'G',type:'info'});
    items.unshift({title:'+ Add daily goal',desc:'Creates a goal for today',icon:'+',type:'action',action:()=>{closeCommandPalette();const text=prompt('Daily goal:');if(!text||!text.trim())return;if(!S.goals)S.goals=[];S.goals.push({id:Date.now(),text:text.trim(),type:'daily',date:today,done:false,created:new Date().toISOString()});save();toast('Goal added for today');}});
    items.unshift({title:'+ Add weekly goal',desc:'Creates a goal for this week',icon:'+',type:'action',action:()=>{closeCommandPalette();const text=prompt('Weekly goal:');if(!text||!text.trim())return;if(!S.goals)S.goals=[];S.goals.push({id:Date.now(),text:text.trim(),type:'weekly',date:ws,done:false,created:new Date().toISOString()});save();toast('Weekly goal added');}});
    todayGoals.forEach(g=>{items.unshift({title:(g.done?'[x] ':'[ ] ')+esc(g.text),desc:'Daily goal'+(g.done?' (completed)':''),icon:g.done?'*':'G',type:'action',action:()=>{g.done=!g.done;save();toast(g.done?'Goal completed':'Goal unchecked');cmdSearch();}});});
    weekGoals.forEach(g=>{items.unshift({title:(g.done?'[x] ':'[ ] ')+esc(g.text),desc:'Weekly goal'+(g.done?' (completed)':''),icon:g.done?'*':'G',type:'action',action:()=>{g.done=!g.done;save();toast(g.done?'Goal completed':'Goal unchecked');cmdSearch();}});});
  }
  // Streak prefix — activity streak counting
  if(ql && (ql==='streak' || ql.startsWith('streak:') || ql==='streaks')){
    const today=new Date();let streak=0;let longest=0;let current=0;
    for(let i=0;i<365;i++){
      const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];
      const hasActivity=S.tasks.some(t=>(t.created&&t.created.startsWith(ds))||(t.completedAt&&t.completedAt.startsWith(ds)))||S.content.some(c=>c.created&&c.created.startsWith(ds))||S.docs.some(doc=>(doc.updated||doc.created||'').startsWith(ds));
      if(hasActivity){current++;if(i<=streak+1)streak=current;longest=Math.max(longest,current);}else{if(i===0)streak=0;current=0;}
    }
    const weekDays=[];for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];const count=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length+S.content.filter(c=>c.created&&c.created.startsWith(ds)).length;weekDays.push({day:['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()],count});}
    const heatStr=weekDays.map(d=>d.day+':'+('|'.repeat(Math.min(d.count,10))||'-')).join(' ');
    items.unshift({title:'Current streak: '+streak+' days',desc:'Longest ever: '+longest+' days',icon:'F',type:'info'});
    items.unshift({title:'This week activity',desc:heatStr,icon:'H',type:'info'});
    items.unshift({title:'Heatmap (open)',desc:'Opens a 90-day activity heatmap popup',icon:'M',type:'action',action:()=>{closeCommandPalette();showActivityHeatmap();}});
  }
  // Heatmap prefix
  if(ql && (ql==='heatmap')){items.unshift({title:'Open Activity Heatmap',desc:'90-day contribution-style heatmap',icon:'H',type:'action',action:()=>{closeCommandPalette();showActivityHeatmap();}});}
  // Deps prefix — task dependency visualization
  if(ql && (ql==='deps' || ql.startsWith('deps:') || ql==='dependencies' || ql==='blocked')){
    const blocked=S.tasks.filter(t=>t.status==='blocked'||t.blockedBy);
    const blocking=S.tasks.filter(t=>t.status!=='done'&&blocked.some(b=>b.blockedBy&&b.blockedBy.toLowerCase().includes(t.title.toLowerCase())));
    items.unshift({title:'Dependency Overview: '+blocked.length+' blocked, '+blocking.length+' blocking',desc:'Resolve blockers to unblock downstream tasks',icon:'D',type:'info'});
    blocking.forEach(t=>{
      const blockedTasks=blocked.filter(b=>b.blockedBy&&b.blockedBy.toLowerCase().includes(t.title.toLowerCase()));
      items.unshift({title:'BLOCKING: '+esc(t.title),desc:'Blocks '+blockedTasks.length+' task'+(blockedTasks.length!==1?'s':'')+': '+blockedTasks.map(b=>b.title).join(', ').substring(0,60),icon:'!',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    blocked.forEach(t=>{
      items.unshift({title:'BLOCKED: '+esc(t.title),desc:'Blocked by: '+(t.blockedBy||'unknown'),icon:'B',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});
    });
    if(!blocked.length&&!blocking.length)items.unshift({title:'No blocked tasks',desc:'All tasks are free to work on',icon:'*',type:'info'});
  }
  // Accent color prefix
  if(ql && (ql==='accent' || ql.startsWith('accent:') || ql==='color' || ql==='theme')){
    const accents=[{name:'Mint Green',color:'#4ade80'},{name:'Cyan',color:'#22d3ee'},{name:'Purple',color:'#a855f7'},{name:'Blue',color:'#3b82f6'},{name:'Orange',color:'#f59e0b'},{name:'Pink',color:'#ec4899'},{name:'Red',color:'#ef4444'},{name:'Yellow',color:'#eab308'}];
    accents.forEach(a=>{
      items.unshift({title:a.name,desc:'Set accent color to '+a.color,icon:'<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:'+a.color+'"></span>',type:'action',action:()=>{document.documentElement.style.setProperty('--accent',a.color);S._accentColor=a.color;save();toast('Accent: '+a.name);closeCommandPalette();}});
    });
  }
  // Pomodoro stats prefix
  if(ql && (ql==='pomodoro' || ql.startsWith('pomodoro:') || ql==='pomo' || ql==='focus stats')){
    if(!S.focusSessions)S.focusSessions=[];
    const today=new Date().toISOString().split('T')[0];
    const todaySessions=S.focusSessions.filter(s=>s.date===today);
    const todayMins=todaySessions.reduce((a,s)=>a+s.minutes,0);
    const weekStart=new Date();weekStart.setDate(weekStart.getDate()-7);const ws=weekStart.toISOString().split('T')[0];
    const weekSessions=S.focusSessions.filter(s=>s.date>=ws);
    const weekMins=weekSessions.reduce((a,s)=>a+s.minutes,0);
    items.unshift({title:'Today: '+todaySessions.length+' sessions ('+todayMins+'min)',desc:'This week: '+weekSessions.length+' sessions ('+weekMins+'min)',icon:'P',type:'info'});
    items.unshift({title:'Start 25-min focus session',desc:'Classic pomodoro',icon:'+',type:'action',action:()=>{closeCommandPalette();startFocusTimer(null,25);}});
    items.unshift({title:'Start 50-min deep work',desc:'Extended focus block',icon:'+',type:'action',action:()=>{closeCommandPalette();startFocusTimer(null,50);}});
    items.unshift({title:'Start 10-min sprint',desc:'Quick burst session',icon:'+',type:'action',action:()=>{closeCommandPalette();startFocusTimer(null,10);}});
    todaySessions.slice(0,5).forEach(s=>{items.unshift({title:s.minutes+'min '+(s.task?'on: '+esc(s.task):'(no task)'),desc:s.date+' at '+(s.startedAt||'?'),icon:'*',type:'info'});});
  }
  // Collections prefix — auto-detect content groupings
  if(ql && (ql==='collections' || ql.startsWith('collections:') || ql==='groups')){
    const keywords={};
    S.content.forEach(c=>{
      const words=(c.body||'').toLowerCase().split(/\s+/).filter(w=>w.length>4);
      const counts={};words.forEach(w=>{const clean=w.replace(/[^a-z]/g,'');if(clean.length>4)counts[clean]=(counts[clean]||0)+1;});
      Object.entries(counts).filter(([,n])=>n>=2).forEach(([w])=>{if(!keywords[w])keywords[w]=[];keywords[w].push(c.id);});
    });
    const collections=Object.entries(keywords).filter(([,ids])=>ids.length>=3).sort((a,b)=>b[1].length-a[1].length).slice(0,10);
    if(collections.length){
      items.unshift({title:'Auto-detected '+collections.length+' content collections',desc:'Based on recurring keywords across items',icon:'C',type:'info'});
      collections.forEach(([kw,ids])=>{
        items.unshift({title:kw+' ('+ids.length+' items)',desc:'Recurring keyword across content items',icon:'#',type:'action',action:()=>{closeCommandPalette();document.getElementById('content-search').value=kw;renderContent();toast('Filtered: '+kw);}});
      });
    }else{items.unshift({title:'No collections detected yet',desc:'Add more content with recurring themes',icon:'!',type:'info'});}
  }
  // Scratchpad prefix
  if(ql && (ql==='scratch' || ql==='scratchpad' || ql==='pad')){
    items.unshift({title:'Open Scratchpad',desc:'Persistent floating notepad (saves across sessions)',icon:'S',type:'action',action:()=>{closeCommandPalette();toggleScratchpad();}});
    const len=(S._scratchpad||'').length;
    if(len)items.unshift({title:'Scratchpad has '+len+' chars',desc:'Content persists in localStorage',icon:'i',type:'info'});
  }
  // Review prefix — weekly review
  if(ql && (ql==='review' || ql.startsWith('review:') || ql==='weekly review')){
    const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-7);const ws=weekStart.toISOString().split('T')[0];
    const completed=S.tasks.filter(t=>t.completedAt&&t.completedAt>=ws).sort((a,b)=>b.completedAt.localeCompare(a.completedAt));
    const created=S.tasks.filter(t=>t.created&&t.created>=ws&&t.status!=='done');
    const contentAdded=S.content.filter(c=>c.created&&c.created>=ws);
    const docsEdited=S.docs.filter(d=>d.updated&&d.updated>=ws);
    const wordsWritten=docsEdited.reduce((a,d)=>a+countW(d.body),0);
    const focusMins=(S.focusSessions||[]).filter(s=>s.date>=ws).reduce((a,s)=>a+s.minutes,0);
    items.unshift({title:'Weekly Review (7 days)',desc:completed.length+' done | '+created.length+' new | '+contentAdded.length+' content | '+wordsWritten+' words | '+focusMins+'min focus',icon:'R',type:'info'});
    items.unshift({title:'Copy Review as Markdown',desc:'Copy weekly summary to clipboard',icon:'C',type:'action',action:()=>{closeCommandPalette();const md=['# Weekly Review','',`**Period:** ${ws} to ${now.toISOString().split('T')[0]}`,'',`## Completed (${completed.length})`,...completed.map(t=>'- [x] '+t.title+(t.project?' ('+t.project+')':'')),``,`## Still Active (${created.length})`,...created.map(t=>'- [ ] '+t.title+' ['+t.status+']'),``,`## Stats`,'- '+contentAdded.length+' content items added','- '+docsEdited.length+' docs edited ('+wordsWritten+' words)','- '+focusMins+' minutes focused'].join('\n');navigator.clipboard.writeText(md);toast('Weekly review copied');}});
    completed.slice(0,8).forEach(t=>{items.unshift({title:'[x] '+esc(t.title),desc:(t.project||'No project')+' | Completed '+timeAgo(t.completedAt),icon:'*',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
  }
  // Workspace stats prefix
  if(ql && (ql==='workspace' || ql.startsWith('workspace:') || ql==='ws' || ql==='stats overview')){
    const dataSize=JSON.stringify(S).length;const kb=Math.round(dataSize/1024);
    const totalTasks=S.tasks.length;const totalContent=S.content.length;const totalDocs=S.docs.length;
    const totalLinks=S.links.length;const totalSpecs=(S.specs||[]).length;const totalRepos=(S.repos||[]).length;
    const totalWords=S.docs.reduce((a,d)=>a+countW(d.body),0)+S.content.reduce((a,c)=>a+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0);
    const totalProjects=(S.projects||[]).length;
    const totalGoals=(S.goals||[]).length;const totalFocus=(S.focusSessions||[]).length;
    const totalFocusMins=(S.focusSessions||[]).reduce((a,s)=>a+s.minutes,0);
    const nodes=(S.whiteboard&&S.whiteboard.nodes||[]).length;
    const kbItems=(S.knowledgeBase||[]).length;
    items.unshift({title:'Workspace: '+kb+'KB ('+Math.round(kb/1024*100)/100+'MB)',desc:'localStorage usage',icon:'W',type:'info'});
    items.unshift({title:'Items: T:'+totalTasks+' C:'+totalContent+' D:'+totalDocs+' L:'+totalLinks+' S:'+totalSpecs+' R:'+totalRepos,desc:'P:'+totalProjects+' KB:'+kbItems+' WB:'+nodes+' Goals:'+totalGoals+' Focus:'+totalFocus,icon:'#',type:'info'});
    items.unshift({title:'Words: '+totalWords.toLocaleString()+' total',desc:S.docs.length+' docs + '+S.content.length+' content items',icon:'W',type:'info'});
    items.unshift({title:'Focus: '+totalFocusMins+' minutes ('+Math.round(totalFocusMins/60)+'h) across '+totalFocus+' sessions',desc:'Across all time',icon:'F',type:'info'});
    const lastSave=S._lastSaveTime||null;
    items.unshift({title:'Last saved: '+(lastSave?timeAgo(lastSave):'unknown'),desc:'Accent: '+(S._accentColor||'#4ade80 (default)'),icon:'i',type:'info'});
  }
  // Chart prefix — visual distributions
  if(ql && (ql==='chart' || ql.startsWith('chart:') || ql==='charts' || ql==='graph')){
    items.unshift({title:'Task Status Distribution',desc:'SVG pie chart of task statuses',icon:'P',type:'action',action:()=>{closeCommandPalette();showChart('status');}});
    items.unshift({title:'Task Priority Distribution',desc:'SVG bar chart of priorities',icon:'B',type:'action',action:()=>{closeCommandPalette();showChart('priority');}});
    items.unshift({title:'Content by Theme',desc:'SVG chart of content themes',icon:'T',type:'action',action:()=>{closeCommandPalette();showChart('theme');}});
    items.unshift({title:'Weekly Activity',desc:'SVG chart of 7-day activity',icon:'W',type:'action',action:()=>{closeCommandPalette();showChart('weekly');}});
  }
  // Plan prefix — weekly plan view
  if(ql && (ql==='plan' || ql.startsWith('plan:') || ql==='weekly plan' || ql==='week plan')){
    const today=new Date();
    for(let i=0;i<7;i++){
      const d=new Date(today);d.setDate(d.getDate()+i);const ds=d.toISOString().split('T')[0];
      const dayLabel=i===0?'Today':i===1?'Tomorrow':['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]+' '+d.getDate();
      const dayTasks=S.tasks.filter(t=>t.due===ds&&t.status!=='done');
      if(dayTasks.length){
        dayTasks.forEach(t=>{items.unshift({title:dayLabel+': '+esc(t.title),desc:(t.priority||'p2').toUpperCase()+' | '+(t.project||'No project'),icon:i===0?'>':'D',type:'action',action:()=>{closeCommandPalette();openTaskDetail(t.id);}});});
      }else{
        items.unshift({title:dayLabel+': (no tasks)',desc:'Click to add a task for '+ds,icon:'.',type:'action',action:()=>{closeCommandPalette();S.tasks.unshift({id:Date.now(),title:'',description:'',subtasks:[],status:'todo',priority:'p2',project:'',due:ds,created:new Date().toISOString()});save();switchSection('tasks',null);renderTasks();setTimeout(()=>{const i=document.querySelector('.task-title-input');if(i)i.focus();},100);}});
      }
    }
  }
  // Import bookmarks prefix
  if(ql && (ql==='import bookmarks' || ql==='bookmarks' || ql==='import links')){
    items.unshift({title:'Import Browser Bookmarks',desc:'Upload HTML bookmarks file (Chrome/Firefox export)',icon:'L',type:'action',action:()=>{closeCommandPalette();importBookmarks();}});
    items.unshift({title:'Batch Import URLs',desc:'Paste multiple URLs (one per line)',icon:'L',type:'action',action:()=>{closeCommandPalette();batchImportLinks();}});
  }
  // Burndown chart prefix
  if(ql && (ql==='burndown' || ql==='burn' || ql==='burndown chart')){
    items.unshift({title:'Task Burndown Chart (14 days)',desc:'SVG chart: tasks created vs completed per day',icon:'B',type:'action',action:()=>{closeCommandPalette();showBurndownChart();}});
    items.unshift({title:'Burndown Chart (30 days)',desc:'Extended 30-day view',icon:'B',type:'action',action:()=>{closeCommandPalette();showBurndownChart(30);}});
  }
  // Dead links checker prefix
  if(ql && (ql==='deadlinks' || ql==='dead links' || ql==='check links' || ql==='broken links' || ql==='link check')){
    items.unshift({title:'Check All Links for Broken URLs',desc:'Tests each link via HEAD request (may take a moment)',icon:'L',type:'action',action:()=>{closeCommandPalette();checkDeadLinks();}});
  }
  // Notifications prefix
  if(ql && (ql==='notifications' || ql==='notify' || ql==='alerts' || ql==='desktop alerts')){
    items.unshift({title:'Enable Desktop Notifications',desc:'Get alerts for overdue tasks and focus timer',icon:'N',type:'action',action:()=>{closeCommandPalette();enableDesktopNotifications();}});
  }
  // Timeline prefix
  if(ql && (ql==='timeline' || ql==='activity' || ql==='activity feed' || ql==='recent')){
    items.unshift({title:'Activity Timeline',desc:'Chronological feed of recent activity across all sections',icon:'T',type:'action',action:()=>{closeCommandPalette();showActivityTimeline();}});
  }
  // Backup prefix
  if(ql && (ql==='backup' || ql==='auto backup' || ql==='autobackup' || ql==='schedule backup')){
    items.unshift({title:'Download Full Backup Now',desc:'Export all data as JSON file',icon:'B',type:'action',action:()=>{closeCommandPalette();downloadBackup();}});
    items.unshift({title:'Toggle Auto-Backup (every 4h)',desc:S._autoBackup?'Currently ON - click to disable':'Currently OFF - click to enable',icon:'B',type:'action',action:()=>{closeCommandPalette();toggleAutoBackup();}});
  }
  // Restore/import prefix
  if(ql && (ql==='restore' || ql==='import' || ql==='import data' || ql==='restore backup')){
    items.unshift({title:'Import JSON Backup',desc:'Upload a previously exported backup file to restore data',icon:'B',type:'action',action:()=>{closeCommandPalette();importBackup();}});
  }
  // Export docs prefix
  if(ql && (ql==='export docs' || ql==='export all docs' || ql==='export writer' || ql==='docs export')){
    items.unshift({title:'Export All Writer Docs (Markdown)',desc:'Download all '+S.docs.length+' documents as a single .md file',icon:'D',type:'action',action:()=>{closeCommandPalette();exportAllDocs();}});
    items.unshift({title:'Export All Writer Docs (Individual)',desc:'Download each doc as separate .md file (zip)',icon:'D',type:'action',action:()=>{closeCommandPalette();exportAllDocsIndividual();}});
  }
  // Roadmap prefix
  if(ql && (ql==='roadmap' || ql==='project roadmap' || ql==='project timeline')){
    const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
    items.unshift({title:'Full Project Roadmap',desc:'Timeline view of all projects with task milestones',icon:'R',type:'action',action:()=>{closeCommandPalette();showProjectRoadmap();}});
    projects.slice(0,3).forEach(p=>{items.unshift({title:'Roadmap: '+p,desc:'Timeline for '+p+' tasks',icon:'R',type:'action',action:()=>{closeCommandPalette();showProjectRoadmap(p);}});});
  }
  // Journal prefix
  if(ql && (ql==='journal' || ql==='daily journal' || ql==='diary' || ql==='today journal')){
    const today=new Date().toISOString().split('T')[0];
    const existing=S.docs.find(d=>d.title&&d.title.startsWith('Journal '+today));
    items.unshift({title:existing?'Open Journal: '+today:'Create Journal: '+today,desc:existing?'Open existing journal entry':'Create new journal entry for today',icon:'J',type:'action',action:()=>{closeCommandPalette();openDailyJournal();}});
    items.unshift({title:'Journal Archive',desc:'View all journal entries',icon:'J',type:'action',action:()=>{closeCommandPalette();showJournalArchive();}});
  }
  // Writing stats prefix
  if(ql && (ql==='writing' || ql==='writing stats' || ql==='word streak' || ql==='writing streak')){
    items.unshift({title:'Writing Stats Dashboard',desc:'Word counts, streaks, daily output',icon:'W',type:'action',action:()=>{closeCommandPalette();showWritingStats();}});
  }
  // Cleanup prefix
  if(ql && (ql==='cleanup' || ql==='clean' || ql==='prune' || ql==='data cleanup')){
    items.unshift({title:'Data Cleanup Report',desc:'Find empty items, duplicates, orphaned data',icon:'X',type:'action',action:()=>{closeCommandPalette();showDataCleanup();}});
  }
  // Report prefix
  if(ql && (ql==='report' || ql==='monthly report' || ql==='productivity report' || ql==='month report')){
    items.unshift({title:'Monthly Productivity Report',desc:'Comprehensive report with stats, charts, and insights',icon:'R',type:'action',action:()=>{closeCommandPalette();showProductivityReport();}});
  }
  // Stickies prefix
  if(ql && (ql==='stickies' || ql==='sticky' || ql==='sticky notes' || ql==='sticky note')){
    items.unshift({title:'Add Sticky Note',desc:'Create a floating sticky note on workspace',icon:'S',type:'action',action:()=>{closeCommandPalette();addStickyNote();}});
    items.unshift({title:'Clear All Sticky Notes',desc:'Remove all sticky notes',icon:'S',type:'action',action:()=>{closeCommandPalette();clearStickyNotes();}});
  }
  // Gantt chart prefix
  if(ql && (ql==='gantt' || ql==='gantt chart' || ql==='task gantt' || ql==='task timeline')){
    items.unshift({title:'Task Gantt Chart',desc:'Horizontal timeline of tasks with due dates',icon:'G',type:'action',action:()=>{closeCommandPalette();showGanttChart();}});
  }
  // Related content prefix
  if(ql && ql.startsWith('related')){
    const searchTerm=q.substring(7).trim();
    if(searchTerm.length>=2){
      const matches=findRelatedContent(searchTerm);
      matches.slice(0,5).forEach(m=>{items.unshift({title:m.body.substring(0,60),desc:'Score: '+m.score+' | '+m.type+' | '+(m.theme||''),icon:'C',type:'action',action:()=>{closeCommandPalette();openContentModal(m.id);}});});
    }else{
      items.unshift({title:'Find Related Content',desc:'Type "related:<keyword>" to find similar content',icon:'C',type:'info'});
    }
  }
  // Reading list prefix
  if(ql && (ql==='reading' || ql==='reading list' || ql==='read later' || ql==='readlist')){
    const readLater=S.links.filter(l=>l.readLater);
    items.unshift({title:'Reading List ('+readLater.length+' links)',desc:'Show all links marked for reading later',icon:'L',type:'action',action:()=>{closeCommandPalette();showReadingList();}});
  }
  // Habits prefix
  if(ql && (ql==='habits' || ql==='habit' || ql==='habit tracker' || ql==='daily habits')){
    items.unshift({title:'Habit Tracker',desc:'Daily habit check-off grid with streaks',icon:'H',type:'action',action:()=>{closeCommandPalette();showHabitTracker();}});
    items.unshift({title:'Add New Habit',desc:'Create a new daily habit to track',icon:'H',type:'action',action:()=>{closeCommandPalette();addHabit();}});
  }
  // Table view prefix
  if(ql && (ql==='table' || ql==='task table' || ql==='spreadsheet' || ql==='grid view')){
    items.unshift({title:'Task Table View',desc:'Compact spreadsheet-like view of all tasks',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTable();}});
  }
  // Project health prefix
  if(ql && (ql==='project health' || ql==='project status' || ql==='project report' || ql==='health')){
    items.unshift({title:'Project Health Dashboard',desc:'Per-project task metrics, completion rates, velocity',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectHealth();}});
  }
  // Random content prefix
  if(ql && (ql==='random' || ql==='surprise' || ql==='random content' || ql==='resurface')){
    items.unshift({title:'Random Content',desc:'Surface a random content item for review/rediscovery',icon:'?',type:'action',action:()=>{closeCommandPalette();showRandomContent();}});
    items.unshift({title:'Random Task',desc:'Pick a random active task to work on',icon:'?',type:'action',action:()=>{closeCommandPalette();showRandomTask();}});
  }
  // Clips prefix
  if(ql && (ql==='clips' || ql==='clipboard' || ql==='clip history' || ql==='clipboard history')){
    items.unshift({title:'Clipboard History',desc:(S._clips||[]).length+' saved clips',icon:'C',type:'action',action:()=>{closeCommandPalette();showClipHistory();}});
    items.unshift({title:'Save Current Clipboard',desc:'Save what\'s on your clipboard to history',icon:'C',type:'action',action:()=>{closeCommandPalette();saveToClips();}});
  }
  // Project template prefix
  if(ql && (ql==='project template' || ql==='new project' || ql==='create project' || ql==='project preset')){
    const templates=[
      {name:'Software Project',tasks:['Set up repository','Define requirements','Design architecture','Implement MVP','Write tests','Deploy to staging','Review and QA','Deploy to production']},
      {name:'Content Campaign',tasks:['Research topic','Create outline','Write first draft','Review/edit','Design visuals','Schedule publishing','Promote on social','Analyze results']},
      {name:'Event Planning',tasks:['Define objectives','Set budget','Book venue','Create guest list','Design invitations','Coordinate vendors','Run-of-show doc','Post-event follow-up']},
      {name:'Product Launch',tasks:['Market research','Define features','Build prototype','User testing','Refine based on feedback','Marketing materials','Launch day prep','Post-launch review']},
    ];
    templates.forEach(t=>{items.unshift({title:'Template: '+t.name,desc:t.tasks.length+' tasks: '+t.tasks.slice(0,3).join(', ')+'...',icon:'P',type:'action',action:()=>{closeCommandPalette();createProjectFromTemplate(t);}});});
  }
  // Compare prefix
  if(ql && (ql==='compare' || ql==='diff' || ql==='side by side' || ql==='content compare')){
    items.unshift({title:'Compare Content Items',desc:'Pick two content items to compare side-by-side',icon:'C',type:'action',action:()=>{closeCommandPalette();startContentCompare();}});
  }
  // Time block prefix
  if(ql && (ql==='time block' || ql==='timeblock' || ql==='block time' || ql==='time blocks')){
    items.unshift({title:'Add Time Block',desc:'Block out time on calendar for focused work',icon:'T',type:'action',action:()=>{closeCommandPalette();addTimeBlock();}});
    items.unshift({title:'View Time Blocks',desc:'Show all scheduled time blocks',icon:'T',type:'action',action:()=>{closeCommandPalette();showTimeBlocks();}});
  }
  // Transform prefix
  if(ql && (ql==='transform' || ql==='text transform' || ql==='uppercase' || ql==='lowercase' || ql==='title case' || ql==='slug')){
    items.unshift({title:'UPPERCASE',desc:'Transform clipboard text to UPPERCASE',icon:'A',type:'action',action:()=>{closeCommandPalette();textTransform('upper');}});
    items.unshift({title:'lowercase',desc:'Transform clipboard text to lowercase',icon:'a',type:'action',action:()=>{closeCommandPalette();textTransform('lower');}});
    items.unshift({title:'Title Case',desc:'Transform clipboard text to Title Case',icon:'T',type:'action',action:()=>{closeCommandPalette();textTransform('title');}});
    items.unshift({title:'slug-case',desc:'Transform to URL-friendly slug',icon:'-',type:'action',action:()=>{closeCommandPalette();textTransform('slug');}});
  }
  // Archive URL prefix
  if(ql && (ql==='archive url' || ql==='wayback' || ql==='web archive' || ql==='archive')){
    items.unshift({title:'View Link on Wayback Machine',desc:'Enter a URL to view its archived version',icon:'W',type:'action',action:()=>{closeCommandPalette();archiveUrl();}});
    S.links.slice(0,3).forEach(l=>{items.unshift({title:'Archive: '+l.title.substring(0,40),desc:l.url,icon:'W',type:'action',action:()=>{closeCommandPalette();window.open('https://web.archive.org/web/'+l.url,'_blank');toast('Opened Wayback Machine');}});});
  }
  // Dashboard prefix
  if(ql && (ql==='dashboard' || ql==='home' || ql==='overview' || ql==='widgets')){
    items.unshift({title:'Home Dashboard',desc:'Overview with today\'s tasks, stats, recent activity',icon:'D',type:'action',action:()=>{closeCommandPalette();showHomeDashboard();}});
  }
  // Settings prefix
  if(ql && (ql==='settings' || ql==='preferences' || ql==='config' || ql==='options')){
    items.unshift({title:'App Settings',desc:'Configure preferences, defaults, and appearance',icon:'S',type:'action',action:()=>{closeCommandPalette();showSettings();}});
  }
  // Impact-effort matrix prefix
  if(ql && (ql==='impact' || ql==='impact effort' || ql==='effort matrix' || ql==='impact matrix')){
    items.unshift({title:'Impact-Effort Matrix',desc:'2x2 matrix: quick wins, big bets, time sinks, fill-ins',icon:'M',type:'action',action:()=>{closeCommandPalette();showImpactMatrix();}});
  }
  // Export content prefix
  if(ql && (ql==='export content' || ql==='export all content' || ql==='content export' || ql==='download content')){
    items.unshift({title:'Export All Content as Markdown',desc:'Download '+S.content.length+' items as a single .md file',icon:'C',type:'action',action:()=>{closeCommandPalette();exportAllContent();}});
    items.unshift({title:'Export All Content as JSON',desc:'Download raw content data',icon:'C',type:'action',action:()=>{closeCommandPalette();exportContentJSON();}});
  }
  // Focus stats prefix
  if(ql && (ql==='focus stats' || ql==='focus history' || ql==='pomodoro stats' || ql==='focus sessions')){
    items.unshift({title:'Focus Session Stats',desc:'Total time, streaks, weekly breakdown, session history',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusStats();}});
  }
  // Eisenhower matrix prefix
  if(ql && (ql==='eisenhower' || ql==='eisenhower matrix' || ql==='urgent important' || ql==='4 quadrants')){
    items.unshift({title:'Eisenhower Matrix',desc:'Urgent vs Important: Do First, Schedule, Delegate, Eliminate',icon:'E',type:'action',action:()=>{closeCommandPalette();showEisenhowerMatrix();}});
  }
  // Content calendar prefix
  if(ql && (ql==='content calendar' || ql==='creation calendar' || ql==='content dates' || ql==='writing calendar')){
    items.unshift({title:'Content Calendar',desc:'Calendar view showing when content was created',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentCalendar();}});
  }
  // Snippet manager prefix
  if(ql && (ql==='snippets' || ql==='snippet' || ql==='snippet manager' || ql==='text snippets')){
    items.unshift({title:'Snippet Manager',desc:'Save and reuse text snippets quickly',icon:'S',type:'action',action:()=>{closeCommandPalette();showSnippetManager();}});
  }
  // Heatmap full prefix
  if(ql && (ql==='heatmap full' || ql==='activity heatmap' || ql==='github heatmap' || ql==='365 heatmap')){
    items.unshift({title:'Activity Heatmap (365 Days)',desc:'GitHub-style grid of daily activity across all sections',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskHeatmap();}});
  }
  // Link dashboard prefix
  if(ql && (ql==='link dashboard' || ql==='link stats' || ql==='links overview' || ql==='link report')){
    items.unshift({title:'Link Dashboard',desc:'Stats: top domains, categories, read-later, pinned',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkDashboard();}});
  }
  // Dependencies prefix
  if(ql && (ql==='dependencies' || ql==='dependency graph' || ql==='blocked' || ql==='dep graph')){
    items.unshift({title:'Task Dependency Graph',desc:'Visualize blocked-by chains across tasks',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDependencyGraph();}});
  }
  // Weekly review prefix
  if(ql && (ql==='weekly review' || ql==='week review' || ql==='review week' || ql==='7 day review')){
    items.unshift({title:'Weekly Review',desc:'Comprehensive 7-day review: completed, in-progress, overdue, content',icon:'W',type:'action',action:()=>{closeCommandPalette();showWeeklyReview();}});
  }
  // Pomodoro history prefix
  if(ql && (ql==='pomo history' || ql==='pomodoro history' || ql==='focus history' || ql==='pomo stats')){
    items.unshift({title:'Pomodoro History',desc:'Session history by task, best day, avg per day',icon:'P',type:'action',action:()=>{closeCommandPalette();showPomodoroHistory();}});
  }
  // Tag cloud prefix
  if(ql && (ql==='tag cloud' || ql==='tags' || ql==='tag visualization' || ql==='word cloud')){
    items.unshift({title:'Tag Cloud',desc:'Visual cloud of all tags sized by frequency',icon:'T',type:'action',action:()=>{closeCommandPalette();showTagCloud();}});
  }
  // Priority grid prefix
  if(ql && (ql==='priority grid' || ql==='priority reassign' || ql==='reprioritize' || ql==='triage')){
    items.unshift({title:'Priority Grid',desc:'Quick-reassign priorities for all active tasks',icon:'P',type:'action',action:()=>{closeCommandPalette();showPriorityGrid();}});
  }
  // Content timeline prefix
  if(ql && (ql==='content timeline' || ql==='content history' || ql==='content feed' || ql==='creation history')){
    items.unshift({title:'Content Timeline',desc:'Chronological feed of all content items by date',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentTimeline();}});
  }
  // Velocity chart prefix
  if(ql && (ql==='velocity' || ql==='velocity chart' || ql==='task velocity' || ql==='completion rate')){
    items.unshift({title:'Task Velocity Chart',desc:'12-week line chart: created vs completed tasks',icon:'V',type:'action',action:()=>{closeCommandPalette();showVelocityChart();}});
  }
  // Quick note prefix
  if(ql && (ql==='quick note' || ql==='quick capture' || ql==='fab' || ql==='floating note')){
    items.unshift({title:'Toggle Quick Note Button',desc:'Floating action button for instant note capture',icon:'+',type:'action',action:()=>{closeCommandPalette();toggleQuickNote();}});
  }
  // Bookmarklets prefix
  if(ql && (ql==='bookmarklets' || ql==='bookmarklet' || ql==='browser capture' || ql==='capture bookmarks')){
    items.unshift({title:'Bookmarklet Generator',desc:'Create browser bookmarklets to save links/text/tasks',icon:'B',type:'action',action:()=>{closeCommandPalette();showBookmarkletGenerator();}});
  }
  // Workspace search prefix
  if(ql && (ql==='workspace search' || ql==='deep search' || ql==='search all' || ql==='global search')){
    items.unshift({title:'Workspace Search',desc:'Deep search across tasks, content, docs, and links',icon:'S',type:'action',action:()=>{closeCommandPalette();showWorkspaceSearch();}});
  }
  // Batch edit prefix
  if(ql && (ql==='batch edit' || ql==='batch tasks' || ql==='bulk edit' || ql==='mass edit')){
    items.unshift({title:'Batch Task Editor',desc:'Select and edit multiple tasks at once',icon:'B',type:'action',action:()=>{closeCommandPalette();showBatchTaskEditor();}});
  }
  // Content stats prefix
  if(ql && (ql==='content stats' || ql==='content analytics' || ql==='content dashboard' || ql==='content report')){
    items.unshift({title:'Content Stats Dashboard',desc:'Types, themes, tags, word counts, trends',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentStats();}});
  }
  // Swimlane prefix
  if(ql && (ql==='swimlane' || ql==='swimlanes' || ql==='project kanban' || ql==='project board')){
    items.unshift({title:'Swimlane View',desc:'Tasks grouped by project x status (kanban by project)',icon:'S',type:'action',action:()=>{closeCommandPalette();showSwimlaneView();}});
  }
  // Daily planner prefix
  if(ql && (ql==='daily planner' || ql==='day planner' || ql==='today plan' || ql==='schedule')){
    items.unshift({title:'Daily Planner',desc:'Today\'s time slots, tasks, overdue, and time blocks',icon:'D',type:'action',action:()=>{closeCommandPalette();showDailyPlanner();}});
  }
  // Export workspace prefix
  if(ql && (ql==='export workspace' || ql==='export all' || ql==='full export' || ql==='download workspace')){
    items.unshift({title:'Export Full Workspace',desc:'Download everything as single JSON (tasks, content, docs, links, etc.)',icon:'E',type:'action',action:()=>{closeCommandPalette();exportFullWorkspace();}});
  }
  // Quick actions prefix
  if(ql && (ql==='quick actions' || ql==='action bar' || ql==='toolbar' || ql==='quick bar')){
    items.unshift({title:'Toggle Quick Actions Bar',desc:'Floating bar with Task, Note, Journal, Dashboard, Habits',icon:'Q',type:'action',action:()=>{closeCommandPalette();toggleQuickActions();}});
  }
  // Due heatmap prefix
  if(ql && (ql==='due heatmap' || ql==='due calendar' || ql==='task load' || ql==='deadline heatmap')){
    items.unshift({title:'Due Date Heatmap',desc:'Calendar showing task load per day with color intensity',icon:'H',type:'action',action:()=>{closeCommandPalette();showDueDateHeatmap();}});
  }
  // Writing goals prefix
  if(ql && (ql==='writing goals' || ql==='word goals' || ql==='writing target' || ql==='word count goal')){
    items.unshift({title:'Writing Goals',desc:'Set and track daily/weekly word count targets',icon:'W',type:'action',action:()=>{closeCommandPalette();showWritingGoals();}});
  }
  // Project compare prefix
  if(ql && (ql==='project compare' || ql==='compare projects' || ql==='project vs' || ql==='project comparison')){
    items.unshift({title:'Project Comparison',desc:'Side-by-side stats for two projects',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectComparison();}});
  }
  // Task aging prefix
  if(ql && (ql==='task aging' || ql==='stale tasks' || ql==='old tasks' || ql==='aging report')){
    items.unshift({title:'Task Aging Report',desc:'Find stale (30d+), aging (14-30d), and fresh (<14d) tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();showTaskAging();}});
  }
  // Import links from markdown prefix
  if(ql && (ql==='import links md' || ql==='import links' || ql==='paste links' || ql==='markdown links')){
    items.unshift({title:'Import Links from Markdown',desc:'Paste markdown text to extract and import URLs',icon:'L',type:'action',action:()=>{closeCommandPalette();importLinksFromMarkdown();}});
  }
  // Ambient sounds prefix
  if(ql && (ql==='ambient' || ql==='ambient sounds' || ql==='focus sounds' || ql==='background noise')){
    items.unshift({title:'Ambient Sounds',desc:'Rain, forest, ocean, white noise for focus sessions',icon:'A',type:'action',action:()=>{closeCommandPalette();showAmbientSounds();}});
  }
  // Word frequency prefix
  if(ql && (ql==='word frequency' || ql==='word count' || ql==='top words' || ql==='word analysis')){
    items.unshift({title:'Word Frequency Analysis',desc:'Most common words across all content and docs',icon:'W',type:'action',action:()=>{closeCommandPalette();showWordFrequency();}});
  }
  // Priority board prefix
  if(ql && (ql==='priority board' || ql==='priority kanban' || ql==='priority columns' || ql==='pri board')){
    items.unshift({title:'Priority Board',desc:'Kanban board with columns by priority (P0/P1/P2/P3)',icon:'P',type:'action',action:()=>{closeCommandPalette();showPriorityBoard();}});
  }
  // WIP limits prefix
  if(ql && (ql==='wip limits' || ql==='wip config' || ql==='wip' || ql==='work in progress limits')){
    items.unshift({title:'WIP Limits Config',desc:'Set work-in-progress limits per board column',icon:'W',type:'action',action:()=>{closeCommandPalette();showWipConfig();}});
  }
  // Duplicates prefix
  if(ql && (ql==='duplicates' || ql==='find duplicates' || ql==='content duplicates' || ql==='dedup')){
    items.unshift({title:'Duplicate Content Finder',desc:'Find similar/duplicate items with 70%+ word overlap',icon:'D',type:'action',action:()=>{closeCommandPalette();showDuplicateContent();}});
  }
  // Export CSV prefix
  if(ql && (ql==='export csv' || ql==='csv export' || ql==='tasks csv' || ql==='spreadsheet export')){
    items.unshift({title:'Export Tasks as CSV',desc:'Download all tasks as comma-separated spreadsheet',icon:'E',type:'action',action:()=>{closeCommandPalette();exportTasksCSV();}});
  }
  // Inbox prefix
  if(ql && (ql==='inbox' || ql==='unsorted' || ql==='uncategorized' || ql==='no project')){
    items.unshift({title:'Inbox (Unsorted Items)',desc:'View tasks, content, links without a project/theme',icon:'I',type:'action',action:()=>{closeCommandPalette();showInbox();}});
  }
  // Session timer prefix
  if(ql && (ql==='session' || ql==='session timer' || ql==='uptime' || ql==='session time')){
    const elapsed=Date.now()-_sessionStart;const mins=Math.floor(elapsed/60000);
    items.unshift({title:'Session Time: '+Math.floor(mins/60)+'h '+mins%60+'m',desc:'Time since ASTRA was opened this session',icon:'T',type:'action',action:()=>{closeCommandPalette();showSessionTimer();}});
  }
  // Undo prefix
  if(ql && (ql==='undo' || ql==='undo last' || ql==='revert' || ql==='undo delete')){
    const last=_undoStack.length?_undoStack[_undoStack.length-1]:null;
    items.unshift({title:'Undo Last Action',desc:last?'Undo: '+last.type+' ('+new Date(last.ts).toLocaleTimeString()+')':'No actions to undo',icon:'U',type:'action',action:()=>{closeCommandPalette();globalUndo();}});
  }
  // Favorites prefix
  if(ql && (ql==='favorites' || ql==='starred' || ql==='pinned' || ql==='bookmarks')){
    const total=S.content.filter(c=>c.starred).length+S.content.filter(c=>c.pinned).length+(S.links||[]).filter(l=>l.pinned).length;
    items.unshift({title:'Favorites ('+total+' items)',desc:'Starred and pinned content and links',icon:'*',type:'action',action:()=>{closeCommandPalette();showFavorites();}});
  }
  // Due groups prefix
  if(ql && (ql==='due groups' || ql==='due grouped' || ql==='tasks by date' || ql==='task groups')){
    items.unshift({title:'Tasks by Due Date',desc:'Grouped: Overdue, Today, Tomorrow, This Week, Later, No Date',icon:'D',type:'action',action:()=>{closeCommandPalette();showTasksByDueGroup();}});
  }
  // Convert prefix
  if(ql && (ql==='convert' || ql==='content to task' || ql==='task to content' || ql==='transform item')){
    items.unshift({title:'Convert Content to Task',desc:'Pick a content item to convert to a task',icon:'C',type:'info'});
    items.unshift({title:'Convert Task to Content',desc:'Pick a task to convert to a content item',icon:'T',type:'info'});
  }
  // Deep focus prefix
  if(ql && (ql==='deep focus' || ql==='focus overlay' || ql==='distraction free' || ql==='dim')){
    items.unshift({title:'Toggle Deep Focus',desc:'Dim everything except current panel for distraction-free work',icon:'F',type:'action',action:()=>{closeCommandPalette();toggleDeepFocus();}});
  }
  // Estimation report prefix
  if(ql && (ql==='estimation' || ql==='estimate report' || ql==='time accuracy' || ql==='est vs actual')){
    items.unshift({title:'Estimation Report',desc:'Compare estimated vs actual time across tasks',icon:'E',type:'action',action:()=>{closeCommandPalette();showEstimationReport();}});
  }
  // Data tools prefix
  if(ql && (ql==='data tools' || ql==='data management' || ql==='clear data' || ql==='factory reset')){
    items.unshift({title:'Data Management',desc:'Clear individual sections, factory reset, storage info',icon:'X',type:'action',action:()=>{closeCommandPalette();showDataTools();}});
  }
  // Theme switcher prefix
  if(ql && (ql==='theme' || ql==='theme switcher' || ql==='dark theme' || ql==='color scheme')){
    items.unshift({title:'Theme Switcher',desc:'6 dark theme variants: Cosmic, Ocean, Forest, Sunset, Purple, Ember',icon:'T',type:'action',action:()=>{closeCommandPalette();showThemeSwitcher();}});
  }
  // Status email prefix
  if(ql && (ql==='status email' || ql==='status update' || ql==='weekly email' || ql==='email update')){
    items.unshift({title:'Generate Status Email',desc:'Copy weekly status update email to clipboard',icon:'E',type:'action',action:()=>{closeCommandPalette();generateStatusEmail();}});
  }
  // Morning briefing prefix
  if(ql && (ql==='morning' || ql==='morning briefing' || ql==='good morning' || ql==='daily brief')){
    items.unshift({title:'Morning Briefing',desc:'Daily overview: overdue, today tasks, in-progress, stats',icon:'M',type:'action',action:()=>{closeCommandPalette();showMorningBriefing();}});
  }
  // Shortcut cheatsheet prefix
  if(ql && (ql==='shortcuts' || ql==='shortcut cheatsheet' || ql==='keyboard' || ql==='keys' || ql==='hotkeys')){
    items.unshift({title:'Shortcut Cheatsheet',desc:'Visual keyboard shortcut reference',icon:'K',type:'action',action:()=>{closeCommandPalette();showShortcutCheatsheet();}});
  }
  // Streak tracker prefix
  if(ql && (ql==='streak' || ql==='streak tracker' || ql==='daily streak' || ql==='usage streak')){
    items.unshift({title:'Streak Tracker',desc:'Track daily usage streaks and active days',icon:'S',type:'action',action:()=>{closeCommandPalette();showStreakTracker();}});
  }
  // Content templates prefix
  if(ql && (ql==='content templates' || ql==='templates' || ql==='template' || ql==='new template')){
    items.unshift({title:'Content Templates',desc:'Meeting notes, project brief, journal, research, decision log',icon:'T',type:'action',action:()=>{closeCommandPalette();showContentTemplates();}});
  }
  // Link checker prefix
  if(ql && (ql==='link checker' || ql==='check links' || ql==='broken links' || ql==='link health')){
    items.unshift({title:'Link Health Checker',desc:'Check if saved links are still reachable',icon:'L',type:'action',action:()=>{closeCommandPalette();showBulkLinkChecker();}});
  }
  // Reading progress prefix
  if(ql && (ql==='reading' || ql==='reading progress' || ql==='read status' || ql==='unread')){
    items.unshift({title:'Reading Progress',desc:'Track read/unread/reading status of content items',icon:'R',type:'action',action:()=>{closeCommandPalette();showReadingProgress();}});
  }
  // Project timeline prefix
  if(ql && (ql==='project timeline' || ql==='timeline' || ql==='gantt' || ql==='milestones')){
    items.unshift({title:'Project Timeline',desc:'Visual timeline of project milestones and task dates',icon:'T',type:'action',action:()=>{closeCommandPalette();showProjectTimeline();}});
  }
  // Quick math
  if(ql && ql.startsWith('math:')){
    const expr=ql.substring(5).trim();const result=quickMath(expr);
    if(result!==null){
      items.unshift({title:'= '+result,desc:'Math: '+expr,icon:'#',type:'action',action:()=>{navigator.clipboard.writeText(String(result));showToast('Copied: '+result);closeCommandPalette();}});
    }
  }
  // Focus score prefix
  if(ql && (ql==='focus score' || ql==='daily score' || ql==='productivity score' || ql==='score')){
    items.unshift({title:'Daily Focus Score',desc:'Productivity grade based on tasks, content, focus time, words',icon:'S',type:'action',action:()=>{closeCommandPalette();showFocusScore();}});
  }
  // Archive browser prefix
  if(ql && (ql==='archive' || ql==='archive browser' || ql==='archived' || ql==='restore task')){
    items.unshift({title:'Archive Browser',desc:'Browse and restore archived tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();showArchiveBrowser();}});
  }
  // Content word cloud prefix
  if(ql && (ql==='word cloud' || ql==='wordcloud' || ql==='content cloud' || ql==='content words')){
    items.unshift({title:'Content Word Cloud',desc:'Visual word cloud from all content and docs',icon:'W',type:'action',action:()=>{closeCommandPalette();showContentWordCloud();}});
  }
  // Habit tracker prefix
  if(ql && (ql==='habits' || ql==='habit tracker' || ql==='daily habits' || ql==='habit')){
    items.unshift({title:'Habit Tracker',desc:'Track daily habits with streaks and history',icon:'H',type:'action',action:()=>{closeCommandPalette();showHabitTracker();}});
  }
  // Knowledge graph stats prefix
  if(ql && (ql==='knowledge graph' || ql==='wiki links' || ql==='backlinks' || ql==='graph stats')){
    items.unshift({title:'Knowledge Graph Stats',desc:'Wiki-link analysis and most referenced items',icon:'G',type:'action',action:()=>{closeCommandPalette();showKnowledgeGraphStats();}});
  }
  // Random content prefix
  if(ql && (ql==='random' || ql==='random content' || ql==='surprise' || ql==='resurface')){
    items.unshift({title:'Random Content',desc:'Resurface a random content item for review',icon:'?',type:'action',action:()=>{closeCommandPalette();showRandomContent();}});
  }
  // Clipboard history prefix
  if(ql && (ql==='clipboard' || ql==='clipboard history' || ql==='copy history' || ql==='paste history')){
    items.unshift({title:'Clipboard History',desc:'View recently copied text within ASTRA',icon:'C',type:'action',action:()=>{closeCommandPalette();showClipboardHistory();}});
  }
  // World clock prefix
  if(ql && (ql==='world clock' || ql==='time zones' || ql==='clock' || ql==='timezone')){
    items.unshift({title:'World Clock',desc:'Live clocks for 6 time zones',icon:'C',type:'action',action:()=>{closeCommandPalette();showTimeZoneClock();}});
  }
  // Content diff prefix
  if(ql && (ql==='diff' || ql==='content diff' || ql==='compare' || ql==='compare content')){
    items.unshift({title:'Content Diff Viewer',desc:'Compare two content items side by side',icon:'D',type:'action',action:()=>{closeCommandPalette();showContentDiff();}});
  }
  // Backup prefix
  if(ql && (ql==='backup' || ql==='workspace backup' || ql==='download backup' || ql==='restore backup')){
    items.unshift({title:'Workspace Backup',desc:'Download or restore full workspace backup',icon:'B',type:'action',action:()=>{closeCommandPalette();showWorkspaceBackupPanel();}});
  }
  // Burnup chart prefix
  if(ql && (ql==='burnup' || ql==='burnup chart' || ql==='task burnup' || ql==='cumulative')){
    items.unshift({title:'Task Burnup Chart',desc:'Cumulative created vs completed over 12 weeks',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBurnup();}});
  }
  // Content metrics prefix
  if(ql && (ql==='content metrics' || ql==='readability' || ql==='flesch' || ql==='vocabulary')){
    items.unshift({title:'Content Metrics',desc:'Readability score, vocab richness, sentence analysis',icon:'M',type:'action',action:()=>{closeCommandPalette();showContentMetrics();}});
  }
  // Markdown preview prefix
  if(ql && (ql==='markdown' || ql==='markdown preview' || ql==='md preview' || ql==='preview')){
    items.unshift({title:'Markdown Preview',desc:'Preview latest content as rendered markdown',icon:'M',type:'action',action:()=>{closeCommandPalette();showMarkdownPreview();}});
  }
  // Task completion heatmap prefix
  if(ql && (ql==='completion heatmap' || ql==='task heatmap' || ql==='done heatmap' || ql==='completion heat')){
    items.unshift({title:'Task Completion Heatmap',desc:'6-month heatmap of task completions',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskCompletionHeatmap();}});
  }
  // Saved searches prefix
  if(ql && (ql==='saved searches' || ql==='saved search' || ql==='search history' || ql==='my searches')){
    items.unshift({title:'Saved Searches',desc:'Save and recall frequent Cmd+K queries',icon:'S',type:'action',action:()=>{closeCommandPalette();showSavedSearches();}});
  }
  // Stale content prefix
  if(ql && (ql==='stale' || ql==='stale content' || ql==='old content' || ql==='outdated')){
    items.unshift({title:'Stale Content Finder',desc:'Content items older than 30 days',icon:'S',type:'action',action:()=>{closeCommandPalette();showStaleContent();}});
  }
  // Quick timer prefix
  if(ql && ql.startsWith('timer:')){
    const mins=parseInt(ql.substring(6).trim());
    if(mins>0&&mins<=120){
      items.unshift({title:'Start '+mins+' min Timer',desc:'Countdown timer in bottom-right corner',icon:'T',type:'action',action:()=>{closeCommandPalette();startQuickTimer(mins);}});
    }
  }
  // Project health prefix
  if(ql && (ql==='project health' || ql==='health dashboard' || ql==='project scores' || ql==='health')){
    items.unshift({title:'Project Health Dashboard',desc:'Health scores based on tasks, content, docs, overdue',icon:'H',type:'action',action:()=>{closeCommandPalette();showProjectHealthDashboard();}});
  }
  // Task matrix prefix
  if(ql && (ql==='matrix' || ql==='task matrix' || ql==='priority matrix' || ql==='quadrant')){
    items.unshift({title:'Task Priority Matrix',desc:'4-quadrant urgent/important matrix',icon:'M',type:'action',action:()=>{closeCommandPalette();showTaskMatrix();}});
  }
  // Content bookmarks prefix
  if(ql && (ql==='bookmarks' || ql==='content bookmarks' || ql==='my bookmarks' || ql==='saved content')){
    items.unshift({title:'Content Bookmarks',desc:'Quick-access bookmarked content items',icon:'B',type:'action',action:()=>{closeCommandPalette();showContentBookmarks();}});
  }
  // System status prefix
  if(ql && (ql==='system status' || ql==='system' || ql==='astra status' || ql==='status')){
    items.unshift({title:'ASTRA System Status',desc:'Tasks, content, storage, session time, theme',icon:'S',type:'action',action:()=>{closeCommandPalette();showSystemStatus();}});
  }
  // Auto tag prefix
  if(ql && (ql==='auto tag' || ql==='tag suggestions' || ql==='suggest tags' || ql==='auto tags')){
    items.unshift({title:'Auto-Tag Suggestions',desc:'Suggest tags for untagged content items',icon:'T',type:'action',action:()=>{closeCommandPalette();showAutoTagSuggestions();}});
  }
  // Sprint view prefix
  if(ql && (ql==='sprint' || ql==='sprint view' || ql==='sprints' || ql==='weekly sprint')){
    items.unshift({title:'Sprint View',desc:'Tasks grouped into weekly sprints',icon:'S',type:'action',action:()=>{closeCommandPalette();showSprintView();}});
  }
  // Color legend prefix
  if(ql && (ql==='color legend' || ql==='colors' || ql==='legend' || ql==='color guide')){
    items.unshift({title:'Color Legend',desc:'What all colors mean across ASTRA',icon:'C',type:'action',action:()=>{closeCommandPalette();showColorLegend();}});
  }
  // Daily digest prefix
  if(ql && (ql==='daily digest' || ql==='digest' || ql==='daily email' || ql==='daily summary')){
    items.unshift({title:'Daily Digest',desc:'Generate and copy comprehensive daily summary',icon:'D',type:'action',action:()=>{closeCommandPalette();generateDailyDigest();}});
  }
  // Content archive prefix
  if(ql && (ql==='content archive' || ql==='archive content' || ql==='archived content' || ql==='old content archive')){
    items.unshift({title:'Content Archive',desc:'Archive old content and restore archived items',icon:'A',type:'action',action:()=>{closeCommandPalette();showContentArchive();}});
  }
  // Changelog prefix
  if(ql && (ql==='changelog' || ql==='change log' || ql==='changes' || ql==='activity log')){
    items.unshift({title:'Workspace Changelog',desc:'View session change log',icon:'L',type:'action',action:()=>{closeCommandPalette();showChangelog();}});
  }
  // Focus config prefix
  if(ql && (ql==='focus config' || ql==='focus settings' || ql==='focus mode config' || ql==='pomodoro config')){
    items.unshift({title:'Focus Mode Config',desc:'Set duration, breaks, blocked sections',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusModeConfig();}});
  }
  // Action items prefix
  if(ql && (ql==='action items' || ql==='extract actions' || ql==='extract todos' || ql==='note to task')){
    items.unshift({title:'Extract Action Items',desc:'Find TODO/ACTION items in content and create tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();extractActionItems();}});
  }
  // Weekly planner prefix
  if(ql && (ql==='weekly planner' || ql==='week planner' || ql==='plan week' || ql==='week view planner')){
    items.unshift({title:'Weekly Planner',desc:'Week-at-a-glance with tasks in day slots',icon:'W',type:'action',action:()=>{closeCommandPalette();showWeeklyPlanner();}});
  }
  // Project switcher prefix
  if(ql && (ql==='switch project' || ql==='project switcher' || ql==='projects' || ql==='switch')){
    items.unshift({title:'Project Switcher',desc:'Quick switch between projects',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectSwitcher();}});
  }
  // Task chains prefix
  if(ql && (ql==='task chains' || ql==='dependency chains' || ql==='chains' || ql==='blocked chains')){
    items.unshift({title:'Task Dependency Chains',desc:'Visualize blocked-by task chains',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskChainsView();}});
  }
  // Theme breakdown prefix
  if(ql && (ql==='themes' || ql==='theme breakdown' || ql==='content themes' || ql==='theme chart')){
    items.unshift({title:'Content Theme Breakdown',desc:'Bar chart of content themes with counts',icon:'T',type:'action',action:()=>{closeCommandPalette();showThemeBreakdown();}});
  }
  // Multi-project dashboard prefix
  if(ql && (ql==='multi project' || ql==='all projects' || ql==='project dashboard' || ql==='multi')){
    items.unshift({title:'Multi-Project Dashboard',desc:'Summary stats across all projects',icon:'M',type:'action',action:()=>{closeCommandPalette();showMultiProjectDashboard();}});
  }
  // Export themes prefix
  if(ql && (ql==='export themes' || ql==='export by theme' || ql==='theme export' || ql==='content export themes')){
    items.unshift({title:'Export Content by Theme',desc:'Copy all content grouped by theme as markdown',icon:'E',type:'action',action:()=>{closeCommandPalette();exportContentByTheme();}});
  }
  // Global search prefix
  if(ql && (ql==='global search' || ql==='search all' || ql==='deep search' || ql==='find everything')){
    items.unshift({title:'Global Search',desc:'Dedicated search panel across all data',icon:'S',type:'action',action:()=>{closeCommandPalette();showGlobalSearch();}});
  }
  // Notification center prefix
  if(ql && (ql==='notifications' || ql==='alerts' || ql==='notification center' || ql==='warnings')){
    items.unshift({title:'Notification Center',desc:'Overdue, WIP warnings, streak, storage alerts',icon:'N',type:'action',action:()=>{closeCommandPalette();showNotificationCenter();}});
  }
  // Stats history prefix
  if(ql && (ql==='stats history' || ql==='daily stats' || ql==='growth' || ql==='workspace growth')){
    items.unshift({title:'Stats History',desc:'Daily stats tracked over 90 days with bar chart',icon:'S',type:'action',action:()=>{closeCommandPalette();showStatsHistory();}});
  }
  // Board filters prefix
  if(ql && (ql==='board filters' || ql==='kanban filters' || ql==='filter board' || ql==='board filter')){
    items.unshift({title:'Board Filters',desc:'Filter kanban by priority, project, due date',icon:'F',type:'action',action:()=>{closeCommandPalette();showKanbanFilters();}});
  }
  // Scratchpad prefix
  if(ql && (ql==='scratchpad' || ql==='scratch' || ql==='notepad' || ql==='pad')){
    items.unshift({title:'Scratchpad',desc:'Quick persistent notepad for scratch work',icon:'S',type:'action',action:()=>{closeCommandPalette();showScratchpad();}});
  }
  // Printable export prefix
  if(ql && (ql==='print export' || ql==='print' || ql==='printable' || ql==='html export')){
    items.unshift({title:'Printable Export',desc:'Download formatted HTML with tasks and content',icon:'P',type:'action',action:()=>{closeCommandPalette();printableExport();}});
  }
  // Slides export prefix
  if(ql && (ql==='slides' || ql==='presentation' || ql==='content slides' || ql==='slideshow')){
    items.unshift({title:'Content to Slides',desc:'Export content as dark-themed HTML slides',icon:'S',type:'action',action:()=>{closeCommandPalette();contentToSlides();}});
  }
  // Workload prefix
  if(ql && (ql==='workload' || ql==='task workload' || ql==='workload forecast' || ql==='load')){
    items.unshift({title:'Workload Forecast',desc:'14-day task workload with overload warnings',icon:'W',type:'action',action:()=>{closeCommandPalette();showWorkloadIndicator();}});
  }
  // Gratitude prefix
  if(ql && (ql==='gratitude' || ql==='gratitude journal' || ql==='grateful' || ql==='journal')){
    items.unshift({title:'Gratitude Journal',desc:'Daily gratitude entries with streak tracking',icon:'G',type:'action',action:()=>{closeCommandPalette();showGratitudeJournal();}});
  }
  // Task templates prefix
  if(ql && (ql==='task templates' || ql==='templates task' || ql==='template library' || ql==='new from template')){
    items.unshift({title:'Task Template Library',desc:'8 templates: bug fix, feature, research, review, etc.',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTemplateLibrary();}});
  }
  // Lifetime focus stats prefix
  if(ql && (ql==='lifetime focus' || ql==='focus lifetime' || ql==='pomo stats' || ql==='total focus')){
    items.unshift({title:'Lifetime Focus Stats',desc:'Total hours, sessions, avg/day, best day',icon:'F',type:'action',action:()=>{closeCommandPalette();showLifetimePomodoroStats();}});
  }
  // Creation calendar prefix
  if(ql && (ql==='creation calendar' || ql==='content creation' || ql==='created when' || ql==='creation cal')){
    items.unshift({title:'Creation Calendar',desc:'Month grid showing content creation dates',icon:'C',type:'action',action:()=>{closeCommandPalette();showCreationCalendar();}});
  }
  // Smart suggestions prefix
  if(ql && (ql==='suggestions' || ql==='smart suggestions' || ql==='next actions' || ql==='what to do')){
    items.unshift({title:'Smart Suggestions',desc:'AI-like suggestions based on current workspace state',icon:'S',type:'action',action:()=>{closeCommandPalette();showSmartSuggestions();}});
  }
  // Link categories prefix
  if(ql && (ql==='link categories' || ql==='link chart' || ql==='link breakdown' || ql==='link stats')){
    items.unshift({title:'Link Category Chart',desc:'Visual breakdown of link categories',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkCategoryChart();}});
  }
  // Priority distribution prefix
  if(ql && (ql==='priority distribution' || ql==='priority chart' || ql==='priority stats' || ql==='task priority')){
    items.unshift({title:'Priority Distribution',desc:'Bar chart showing P0/P1/P2/P3 distribution',icon:'P',type:'action',action:()=>{closeCommandPalette();showPriorityDistribution();}});
  }
  // Mood tracker prefix
  if(ql && (ql==='mood' || ql==='mood tracker' || ql==='how am i feeling' || ql==='feeling')){
    items.unshift({title:'Mood Tracker',desc:'Log daily mood with trend visualization',icon:'M',type:'action',action:()=>{closeCommandPalette();showMoodTracker();}});
  }
  // Repo timeline prefix
  if(ql && (ql==='repo timeline' || ql==='repo overview' || ql==='repos overview' || ql==='all repos')){
    items.unshift({title:'Repo Overview',desc:'All repos with status, URLs, and last commit',icon:'R',type:'action',action:()=>{closeCommandPalette();showRepoTimeline();}});
  }
  // Micro journal prefix
  if(ql && (ql==='micro journal' || ql==='micro' || ql==='one liner' || ql==='quick journal')){
    items.unshift({title:'Micro Journal',desc:'Quick daily one-liner journal entries',icon:'J',type:'action',action:()=>{closeCommandPalette();showMicroJournal();}});
  }
  // Completion rate prefix
  if(ql && (ql==='completion rate' || ql==='completion' || ql==='done rate' || ql==='task rate')){
    items.unshift({title:'Weekly Completion Rate',desc:'Completion rate per week with progress bars',icon:'C',type:'action',action:()=>{closeCommandPalette();showCompletionRate();}});
  }
  // Export book prefix
  if(ql && (ql==='export book' || ql==='content book' || ql==='markdown book' || ql==='book export')){
    items.unshift({title:'Export Content as Book',desc:'Download all content as structured markdown book',icon:'B',type:'action',action:()=>{closeCommandPalette();exportContentAsBook();}});
  }
  // Workspace overview prefix
  if(ql && (ql==='overview' || ql==='workspace overview' || ql==='dashboard overview' || ql==='everything')){
    items.unshift({title:'Workspace Overview',desc:'Full dashboard: tasks, content, links, docs, projects, storage',icon:'O',type:'action',action:()=>{closeCommandPalette();showWorkspaceOverview();}});
  }
  // Sentiment prefix
  if(ql && (ql==='sentiment' || ql==='content sentiment' || ql==='mood analysis' || ql==='positive negative')){
    items.unshift({title:'Content Sentiment',desc:'Keyword-based positive/neutral/negative analysis',icon:'S',type:'action',action:()=>{closeCommandPalette();showContentSentiment();}});
  }
  // Project completion prefix
  if(ql && (ql==='project completion' || ql==='completion timeline' || ql==='project progress' || ql==='project bars')){
    items.unshift({title:'Project Completion Timeline',desc:'Bar chart of completion % per project',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectCompletionTimeline();}});
  }
  // Content calendar prefix
  if(ql && (ql==='content calendar' || ql==='creation dates' || ql==='content month' || ql==='when created')){
    items.unshift({title:'Content Calendar',desc:'Month calendar showing content creation dates',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentCalendar();}});
  }
  // Velocity prefix
  if(ql && (ql==='velocity' || ql==='task velocity' || ql==='throughput' || ql==='tasks per week')){
    items.unshift({title:'Task Velocity',desc:'Completed vs created per week (8-week chart)',icon:'V',type:'action',action:()=>{closeCommandPalette();showTaskVelocity();}});
  }
  // Tag cloud prefix
  if(ql && (ql==='tag cloud' || ql==='tags visual' || ql==='all tags' || ql==='tag frequency')){
    items.unshift({title:'Tag Cloud',desc:'Visual tag cloud sized by frequency',icon:'#',type:'action',action:()=>{closeCommandPalette();showTagCloud();}});
  }
  // Due calendar prefix
  if(ql && (ql==='due calendar' || ql==='due dates' || ql==='deadline calendar' || ql==='due month')){
    items.unshift({title:'Due Date Calendar',desc:'Month calendar of task due dates',icon:'D',type:'action',action:()=>{closeCommandPalette();showDueCalendar();}});
  }
  // Productivity prefix
  if(ql && (ql==='productivity' || ql==='productivity insights' || ql==='weekly insights' || ql==='performance')){
    items.unshift({title:'Productivity Insights',desc:'Weekly trends, comparisons, and actionable tips',icon:'P',type:'action',action:()=>{closeCommandPalette();showProductivityInsights();}});
  }
  // Category breakdown prefix
  if(ql && (ql==='category breakdown' || ql==='categories' || ql==='content breakdown' || ql==='pie chart')){
    items.unshift({title:'Category Breakdown',desc:'Stacked bar chart of content categories',icon:'C',type:'action',action:()=>{closeCommandPalette();showCategoryBreakdown();}});
  }
  // Recent activity prefix
  if(ql && (ql==='recent activity' || ql==='activity feed' || ql==='activity log' || ql==='recent')){
    items.unshift({title:'Recent Activity',desc:'Unified activity feed across all sections',icon:'A',type:'action',action:()=>{closeCommandPalette();showRecentActivity();}});
  }
  // Quick note prefix
  if(ql && (ql==='quick note' || ql==='note' || ql==='jot' || ql==='capture note')){
    items.unshift({title:'Quick Note',desc:'Floating quick note (saves to content)',icon:'N',type:'action',action:()=>{closeCommandPalette();showQuickNote();}});
  }
  // Writer stats prefix
  if(ql && (ql==='writer stats' || ql==='writing stats' || ql==='doc stats' || ql==='writer analytics')){
    items.unshift({title:'Writer Statistics',desc:'Docs, words, pages, versions, rankings',icon:'W',type:'action',action:()=>{closeCommandPalette();showWriterStats();}});
  }
  // Link domains prefix
  if(ql && (ql==='link domains' || ql==='domains' || ql==='domain breakdown' || ql==='most linked')){
    items.unshift({title:'Link Domain Breakdown',desc:'Most linked domains with frequency bars',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkDomainBreakdown();}});
  }
  // Time report prefix
  if(ql && (ql==='time report' || ql==='time tracking' || ql==='time breakdown' || ql==='hours tracked')){
    items.unshift({title:'Time Tracking Report',desc:'Detailed time report by project and task',icon:'T',type:'action',action:()=>{closeCommandPalette();showTimeTrackingReport();}});
  }
  // Content timeline prefix
  if(ql && (ql==='content timeline' || ql==='creation history' || ql==='content history' || ql==='timeline')){
    items.unshift({title:'Content Timeline',desc:'Vertical timeline of content creation dates',icon:'T',type:'action',action:()=>{closeCommandPalette();showContentTimeline();}});
  }
  // Goals prefix
  if(ql && (ql==='goals' || ql==='goal tracker' || ql==='weekly goals' || ql==='monthly goals')){
    items.unshift({title:'Goal Tracker',desc:'Set and track weekly/monthly goals',icon:'G',type:'action',action:()=>{closeCommandPalette();showGoalTracker();}});
  }
  // Quick task prefix
  if(ql && (ql==='quick task' || ql==='fast task' || ql==='new task quick' || ql==='task quick')){
    items.unshift({title:'Quick Task',desc:'Floating quick task creator',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTask();}});
  }
  // Data explorer prefix
  if(ql && (ql==='data explorer' || ql==='raw data' || ql==='state data' || ql==='browse data')){
    items.unshift({title:'Data Explorer',desc:'Browse raw workspace state data',icon:'D',type:'action',action:()=>{closeCommandPalette();showDataExplorer();}});
  }
  // Project comparison prefix
  if(ql && (ql==='project comparison' || ql==='compare projects' || ql==='project compare' || ql==='side by side')){
    items.unshift({title:'Project Comparison',desc:'Side-by-side project metrics table',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectComparison();}});
  }
  // Weekly review prefix
  if(ql && (ql==='weekly review' || ql==='week review' || ql==='review' || ql==='week summary')){
    items.unshift({title:'Weekly Review',desc:'Comprehensive weekly review with copy button',icon:'R',type:'action',action:()=>{closeCommandPalette();showWeeklyReview();}});
  }
  // Achievements prefix
  if(ql && (ql==='achievements' || ql==='badges' || ql==='milestones' || ql==='gamification')){
    items.unshift({title:'Achievements',desc:'Unlockable milestones based on usage',icon:'*',type:'action',action:()=>{closeCommandPalette();showAchievements();}});
  }
  // Focus history prefix
  if(ql && (ql==='focus history' || ql==='pomodoro history' || ql==='focus sessions' || ql==='session history')){
    items.unshift({title:'Focus History',desc:'All focus/Pomodoro sessions with 14-day chart',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusHistory();}});
  }
  // Quick link prefix
  if(ql && (ql==='quick link' || ql==='save link' || ql==='fast link' || ql==='add link quick')){
    items.unshift({title:'Quick Link',desc:'Floating quick link saver',icon:'L',type:'action',action:()=>{closeCommandPalette();showQuickLink();}});
  }
  // Storage prefix
  if(ql && (ql==='storage' || ql==='storage manager' || ql==='disk usage' || ql==='localstorage')){
    items.unshift({title:'Storage Manager',desc:'Visual localStorage breakdown',icon:'S',type:'action',action:()=>{closeCommandPalette();showStorageManager();}});
  }
  // Task aging prefix
  if(ql && (ql==='task aging' || ql==='stale tasks' || ql==='old tasks' || ql==='aging report')){
    items.unshift({title:'Task Aging Report',desc:'Tasks ranked by age with stale detection',icon:'!',type:'action',action:()=>{closeCommandPalette();showTaskAging();}});
  }
  // Word frequency prefix
  if(ql && (ql==='word frequency' || ql==='top words' || ql==='word count' || ql==='frequent words')){
    items.unshift({title:'Word Frequency',desc:'Top 30 words across all content',icon:'W',type:'action',action:()=>{closeCommandPalette();showContentWordFrequency();}});
  }
  // Daily planner prefix
  if(ql && (ql==='daily planner' || ql==='today plan' || ql==='day plan' || ql==='planner')){
    items.unshift({title:'Daily Planner',desc:'Today time blocks with tasks and overdue',icon:'P',type:'action',action:()=>{closeCommandPalette();showDailyPlanner();}});
  }
  // Content length prefix
  if(ql && (ql==='content length' || ql==='length chart' || ql==='content size' || ql==='word length')){
    items.unshift({title:'Content Length Distribution',desc:'Items by word count: tiny to epic',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentLengthChart();}});
  }
  // Project notes prefix
  if(ql && (ql==='project notes' || ql==='proj notes' || ql==='notes per project' || ql==='project memo')){
    items.unshift({title:'Project Notes',desc:'Quick persistent notes per project',icon:'N',type:'action',action:()=>{closeCommandPalette();showProjectNotes();}});
  }
  // Duplicates prefix
  if(ql && (ql==='duplicates' || ql==='duplicate detector' || ql==='find dupes' || ql==='dedup')){
    items.unshift({title:'Duplicate Detector',desc:'Find duplicate content and tasks by similarity',icon:'D',type:'action',action:()=>{closeCommandPalette();showDuplicateDetector();}});
  }
  // Universal search prefix
  if(ql && (ql==='universal search' || ql==='search all' || ql==='find everything' || ql==='deep search')){
    items.unshift({title:'Universal Search',desc:'Search everything with live results',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickSearchPanel();}});
  }
  // Eisenhower prefix
  if(ql && (ql==='eisenhower' || ql==='eisenhower matrix' || ql==='urgent important' || ql==='priority matrix')){
    items.unshift({title:'Eisenhower Matrix',desc:'2x2 Urgent/Important task matrix',icon:'E',type:'action',action:()=>{closeCommandPalette();showEisenhowerMatrix();}});
  }
  // Writer progress prefix
  if(ql && (ql==='writer progress' || ql==='word targets' || ql==='writing goals' || ql==='doc progress')){
    items.unshift({title:'Writer Progress',desc:'Word count targets per doc',icon:'W',type:'action',action:()=>{closeCommandPalette();showWriterProgress();}});
  }
  // Batch ops prefix
  if(ql && (ql==='batch ops' || ql==='batch operations' || ql==='bulk operations' || ql==='mass edit')){
    items.unshift({title:'Batch Operations',desc:'Bulk tag, rename, archive operations',icon:'B',type:'action',action:()=>{closeCommandPalette();showBatchOperations();}});
  }
  // Context switcher prefix
  if(ql && (ql==='context' || ql==='workspace context' || ql==='switch context' || ql==='mode')){
    items.unshift({title:'Context Switcher',desc:'Switch workspace context: work, personal, creative',icon:'C',type:'action',action:()=>{closeCommandPalette();showContextSwitcher();}});
  }
  // Daily checklist prefix
  if(ql && (ql==='daily checklist' || ql==='checklist' || ql==='daily routine' || ql==='morning checklist')){
    items.unshift({title:'Daily Checklist',desc:'Recurring checklist that resets each morning',icon:'V',type:'action',action:()=>{closeCommandPalette();showDailyChecklist();}});
  }
  // Knowledge map prefix
  if(ql && (ql==='knowledge map' || ql==='wiki map' || ql==='link map' || ql==='backlinks map')){
    items.unshift({title:'Knowledge Map',desc:'Map of [[wiki-link]] connections',icon:'K',type:'action',action:()=>{closeCommandPalette();showKnowledgeMap();}});
  }
  // Export hub prefix
  if(ql && (ql==='export hub' || ql==='export all' || ql==='download data' || ql==='export formats')){
    items.unshift({title:'Export Hub',desc:'JSON, CSV, Markdown, HTML exports',icon:'E',type:'action',action:()=>{closeCommandPalette();showContentExportHub();}});
  }
  // Dependencies prefix
  if(ql && (ql==='dependencies' || ql==='task dependencies' || ql==='dependency graph' || ql==='blocked tasks')){
    items.unshift({title:'Task Dependencies',desc:'Visual graph of blocking/blocked tasks',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDependencyGraph();}});
  }
  // Inbox zero prefix
  if(ql && (ql==='inbox zero' || ql==='inbox' || ql==='triage' || ql==='unprocessed')){
    items.unshift({title:'Inbox Zero Triage',desc:'Find uncategorized/incomplete items',icon:'I',type:'action',action:()=>{closeCommandPalette();showInboxZero();}});
  }
  // Reading list prefix
  if(ql && (ql==='reading list' || ql==='read list' || ql==='to read' || ql==='unread links')){
    items.unshift({title:'Reading List',desc:'Track read/unread links',icon:'R',type:'action',action:()=>{closeCommandPalette();showReadingList();}});
  }
  // Project status prefix
  if(ql && (ql==='project status' || ql==='status board' || ql==='project health' || ql==='status update')){
    items.unshift({title:'Project Status Board',desc:'Status for all projects (on-track/at-risk/blocked)',icon:'S',type:'action',action:()=>{closeCommandPalette();showProjectStatusBoard();}});
  }
  // Dashboard prefix
  if(ql && (ql==='dashboard' || ql==='astra dashboard' || ql==='home' || ql==='main dashboard')){
    items.unshift({title:'ASTRA Dashboard',desc:'Stats, overdue, and quick actions',icon:'H',type:'action',action:()=>{closeCommandPalette();showCustomDashboard();}});
  }
  // Captures prefix
  if(ql && (ql==='captures' || ql==='capture summary' || ql==='quick captures' || ql==='nexus captures')){
    items.unshift({title:'Capture Summary',desc:'Quick captures by type with recent list',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCaptureSummary();}});
  }
  // Notes explorer prefix
  if(ql && (ql==='notes explorer' || ql==='browse notes' || ql==='content tree' || ql==='folder view')){
    items.unshift({title:'Notes Explorer',desc:'Tree-view content organized by category',icon:'N',type:'action',action:()=>{closeCommandPalette();showNotesExplorer();}});
  }
  // Deadlines prefix
  if(ql && (ql==='deadlines' || ql==='deadline tracker' || ql==='countdowns' || ql==='due soon')){
    items.unshift({title:'Deadline Tracker',desc:'Countdown to upcoming task deadlines',icon:'!',type:'action',action:()=>{closeCommandPalette();showDeadlineTracker();}});
  }
  // Content graph prefix
  if(ql && (ql==='content graph' || ql==='creation graph' || ql==='content trends' || ql==='30 day chart')){
    items.unshift({title:'Content Creation Graph',desc:'30-day creation trends with word counts',icon:'G',type:'action',action:()=>{closeCommandPalette();showContentGraph();}});
  }
  // Advanced search prefix
  if(ql && (ql==='advanced search' || ql==='filtered search' || ql==='search filters' || ql==='power search')){
    items.unshift({title:'Advanced Search',desc:'Search with type and date filters',icon:'S',type:'action',action:()=>{closeCommandPalette();showWorkspaceSearch();}});
  }
  // Quote prefix
  if(ql && (ql==='quote' || ql==='motivation' || ql==='inspire' || ql==='motivational')){
    items.unshift({title:'Motivational Quote',desc:'Random curated motivational quote',icon:'Q',type:'action',action:()=>{closeCommandPalette();showMotivationalQuote();}});
  }
  // Accent color prefix
  if(ql && (ql==='accent color' || ql==='theme color' || ql==='color picker' || ql==='accent')){
    items.unshift({title:'Accent Color Picker',desc:'Change ASTRA accent color (12 options)',icon:'C',type:'action',action:()=>{closeCommandPalette();showColorThemePicker();}});
  }
  // Session log prefix
  if(ql && (ql==='session log' || ql==='work log' || ql==='log session' || ql==='what i did')){
    items.unshift({title:'Session Log',desc:'Log what you worked on with timestamps',icon:'L',type:'action',action:()=>{closeCommandPalette();showSessionLog();}});
  }
  // Recent edits prefix
  if(ql && (ql==='recent edits' || ql==='last edited' || ql==='recently modified' || ql==='latest edits')){
    items.unshift({title:'Recent Edits',desc:'Most recently edited items everywhere',icon:'R',type:'action',action:()=>{closeCommandPalette();showRecentEdits();}});
  }
  // Doc outline prefix
  if(ql && (ql==='doc outline' || ql==='document outline' || ql==='headings' || ql==='doc structure')){
    items.unshift({title:'Document Outlines',desc:'Heading structure of writer docs',icon:'O',type:'action',action:()=>{closeCommandPalette();showDocOutline();}});
  }
  // Backlog prefix
  if(ql && (ql==='backlog' || ql==='backlog groomer' || ql==='unscheduled' || ql==='groom backlog')){
    items.unshift({title:'Backlog Groomer',desc:'Prioritize and schedule unassigned tasks',icon:'B',type:'action',action:()=>{closeCommandPalette();showBacklogGroomer();}});
  }
  // Focus score history prefix
  if(ql && (ql==='focus score history' || ql==='score history' || ql==='focus trend' || ql==='score trend')){
    items.unshift({title:'Focus Score History',desc:'30-day focus score trend chart',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusScoreHistory();}});
  }
  // Convert prefix
  if(ql && (ql==='convert' || ql==='quick convert' || ql==='transform' || ql==='change type')){
    items.unshift({title:'Quick Convert',desc:'Convert between content, task, link, doc',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickConvert();}});
  }
  // Workspace stats prefix
  if(ql && (ql==='workspace stats' || ql==='all stats' || ql==='statistics' || ql==='numbers')){
    items.unshift({title:'Workspace Statistics',desc:'12-metric comprehensive stats overview',icon:'S',type:'action',action:()=>{closeCommandPalette();showWorkspaceStats();}});
  }
  // Habits prefix
  if(ql && (ql==='habits' || ql==='habit tracker' || ql==='daily habits' || ql==='streaks')){
    items.unshift({title:'Habit Tracker',desc:'Track daily habits with 7-day grid and streaks',icon:'H',type:'action',action:()=>{closeCommandPalette();showHabitTracker();}});
  }
  // Suggestions prefix
  if(ql && (ql==='suggestions' || ql==='smart suggestions' || ql==='tips' || ql==='advice')){
    items.unshift({title:'Smart Suggestions',desc:'AI-powered workspace improvement suggestions',icon:'?',type:'action',action:()=>{closeCommandPalette();showSmartSuggestions();}});
  }
  // Project archive prefix
  if(ql && (ql==='project archive' || ql==='archive projects' || ql==='archived' || ql==='hide projects')){
    items.unshift({title:'Project Archive',desc:'Archive and restore completed projects',icon:'A',type:'action',action:()=>{closeCommandPalette();showProjectArchive();}});
  }
  // Sprint prefix
  if(ql && (ql==='sprint' || ql==='sprint planner' || ql==='weekly sprint' || ql==='plan week')){
    items.unshift({title:'Sprint Planner',desc:'Plan weekly sprints with task assignment',icon:'S',type:'action',action:()=>{closeCommandPalette();showSprintPlanner();}});
  }
  // Content templates prefix
  if(ql && (ql==='content templates' || ql==='templates' || ql==='template' || ql==='blog template')){
    items.unshift({title:'Content Templates',desc:'Pre-built templates for various content types',icon:'T',type:'action',action:()=>{closeCommandPalette();showContentTemplates();}});
  }
  // Workspace timeline prefix
  if(ql && (ql==='workspace timeline' || ql==='timeline' || ql==='activity timeline' || ql==='history')){
    items.unshift({title:'Workspace Timeline',desc:'Chronological timeline of all activity',icon:'T',type:'action',action:()=>{closeCommandPalette();showWorkspaceTimeline();}});
  }
  // Tag manager prefix
  if(ql && (ql==='tag manager' || ql==='manage tags' || ql==='rename tags' || ql==='tags manager')){
    items.unshift({title:'Tag Manager',desc:'Rename and delete tags across all sections',icon:'#',type:'action',action:()=>{closeCommandPalette();showTagManager();}});
  }
  // Task matrix prefix
  if(ql && (ql==='task matrix' || ql==='matrix' || ql==='project status matrix' || ql==='cross table')){
    items.unshift({title:'Task Matrix',desc:'Project x Status cross-reference table',icon:'M',type:'action',action:()=>{closeCommandPalette();showTaskMatrix();}});
  }
  // Bookmarks prefix
  if(ql && (ql==='bookmarks' || ql==='bookmark organizer' || ql==='organize bookmarks' || ql==='link categories')){
    items.unshift({title:'Bookmark Organizer',desc:'Browse links organized by category',icon:'B',type:'action',action:()=>{closeCommandPalette();showBookmarkOrganizer();}});
  }
  // Weekly goals prefix
  if(ql && (ql==='weekly goals' || ql==='goals' || ql==='week goals' || ql==='set goals')){
    items.unshift({title:'Weekly Goals',desc:'Set and track goals for this week',icon:'G',type:'action',action:()=>{closeCommandPalette();showWeeklyGoals();}});
  }
  // Content analytics prefix
  if(ql && (ql==='content analytics' || ql==='analytics' || ql==='content stats' || ql==='content report')){
    items.unshift({title:'Content Analytics',desc:'Deep analytics on themes, tags, and trends',icon:'A',type:'action',action:()=>{closeCommandPalette();showContentAnalytics();}});
  }
  // Quick bookmark prefix
  if(ql && (ql==='quick bookmark' || ql==='bookmark' || ql==='save link' || ql==='add bookmark')){
    items.unshift({title:'Quick Bookmark',desc:'Floating bookmark saver with categories',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBookmark();}});
  }
  // Heatmap prefix
  if(ql && (ql==='heatmap' || ql==='task heatmap' || ql==='completion heatmap' || ql==='github heatmap')){
    items.unshift({title:'Task Heatmap',desc:'GitHub-style completion heatmap (26 weeks)',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskCalendarHeatmap();}});
  }
  // Writer goals prefix
  if(ql && (ql==='writer goals' || ql==='writing goals' || ql==='word goals' || ql==='word count goals')){
    items.unshift({title:'Writer Goals',desc:'Daily/weekly/monthly word count targets',icon:'W',type:'action',action:()=>{closeCommandPalette();showWriterGoals();}});
  }
  // Project health prefix
  if(ql && (ql==='project health' || ql==='health dashboard' || ql==='project risk' || ql==='project status')){
    items.unshift({title:'Project Health',desc:'Health dashboard with risk assessment per project',icon:'H',type:'action',action:()=>{closeCommandPalette();showProjectHealth();}});
  }
  // Mind dump prefix
  if(ql && (ql==='mind dump' || ql==='brain dump' || ql==='dump' || ql==='brain')){
    items.unshift({title:'Mind Dump',desc:'Dump everything on your mind, sort later',icon:'D',type:'action',action:()=>{closeCommandPalette();showMindDump();}});
  }
  // Milestones prefix
  if(ql && (ql==='milestones' || ql==='project milestones' || ql==='milestone' || ql==='deadline')){
    items.unshift({title:'Project Milestones',desc:'Track milestones with due dates per project',icon:'M',type:'action',action:()=>{closeCommandPalette();showProjectMilestones();}});
  }
  // Link health prefix
  if(ql && (ql==='link health' || ql==='links health' || ql==='link report' || ql==='link score')){
    items.unshift({title:'Link Health Report',desc:'Score, duplicates, and missing titles audit',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkHealth();}});
  }
  // Journal prefix
  if(ql && (ql==='journal' || ql==='daily journal' || ql==='diary' || ql==='mood')){
    items.unshift({title:'Daily Journal',desc:'Journal with mood tracking and gratitude',icon:'J',type:'action',action:()=>{closeCommandPalette();showDailyJournal();}});
  }
  // Burndown prefix
  if(ql && (ql==='burndown' || ql==='project burndown' || ql==='burn down' || ql==='progress chart')){
    items.unshift({title:'Project Burndown',desc:'Visual burndown with status breakdown per project',icon:'B',type:'action',action:()=>{closeCommandPalette();showProjectBurndown();}});
  }
  // Quick timer prefix
  if(ql && (ql==='quick timer' || ql==='timer' || ql==='countdown' || ql==='stopwatch')){
    items.unshift({title:'Quick Timer',desc:'Floating countdown timer with preset durations',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTimer();}});
  }
  // Content duplicates prefix
  if(ql && (ql==='content duplicates' || ql==='find duplicates' || ql==='dedup content' || ql==='content dupes')){
    items.unshift({title:'Content Duplicates',desc:'Find and remove duplicate content items',icon:'D',type:'action',action:()=>{closeCommandPalette();showContentDuplicates();}});
  }
  // Priority report prefix
  if(ql && (ql==='priority report' || ql==='priority breakdown' || ql==='priority stats' || ql==='task priorities')){
    items.unshift({title:'Priority Report',desc:'Task priority breakdown with completion rates',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskPriorityReport();}});
  }
  // Embed prefix
  if(ql && (ql==='embed' || ql==='quick embed' || ql==='embeds' || ql==='save embed')){
    items.unshift({title:'Quick Embed',desc:'Save embeddable URLs for quick access',icon:'E',type:'action',action:()=>{closeCommandPalette();showQuickEmbed();}});
  }
  // Cleanup prefix
  if(ql && (ql==='cleanup' || ql==='workspace cleanup' || ql==='clean up' || ql==='tidy')){
    items.unshift({title:'Workspace Cleanup',desc:'Find stale tasks, empty content, broken links',icon:'C',type:'action',action:()=>{closeCommandPalette();showWorkspaceCleanup();}});
  }
  // Batch edit prefix
  if(ql && (ql==='batch edit' || ql==='bulk edit' || ql==='mass edit' || ql==='edit tasks')){
    items.unshift({title:'Task Batch Editor',desc:'Bulk select and edit tasks',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBatchEdit();}});
  }
  // Version compare prefix
  if(ql && (ql==='version compare' || ql==='compare versions' || ql==='doc versions' || ql==='diff')){
    items.unshift({title:'Doc Version Compare',desc:'Compare writer doc versions with word diff',icon:'V',type:'action',action:()=>{closeCommandPalette();showDocVersionCompare();}});
  }
  // Focus mode prefix
  if(ql && (ql==='focus' || ql==='focus mode' || ql==='zen focus' || ql==='deep focus')){
    items.unshift({title:'Focus Mode',desc:'Full-screen focus on top priority task',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusModePanel();}});
  }
  // Time estimates prefix
  if(ql && (ql==='time estimates' || ql==='estimates' || ql==='task time' || ql==='how long')){
    items.unshift({title:'Time Estimates',desc:'Task time breakdown by priority',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTimeEstimates();}});
  }
  // Deep search prefix
  if(ql && (ql==='deep search' || ql==='search all' || ql==='global search' || ql==='find all')){
    items.unshift({title:'Global Deep Search',desc:'Search across all workspace sections',icon:'S',type:'action',action:()=>{closeCommandPalette();showGlobalSearch();}});
  }
  // Snippets prefix
  if(ql && (ql==='snippets' || ql==='snippet library' || ql==='code snippets' || ql==='code library')){
    items.unshift({title:'Snippet Library',desc:'Code snippets with copy-to-clipboard',icon:'<',type:'action',action:()=>{closeCommandPalette();showSnippetLibrary();}});
  }
  // Daily report prefix
  if(ql && (ql==='daily report' || ql==='report' || ql==='day report' || ql==='eod report')){
    items.unshift({title:'Daily Report',desc:'Comprehensive daily report with copy',icon:'R',type:'action',action:()=>{closeCommandPalette();showDailyReport();}});
  }
  // Switch project prefix
  if(ql && (ql==='switch project' || ql==='project switcher' || ql==='switch' || ql==='projects')){
    items.unshift({title:'Project Switcher',desc:'Quick switch between projects',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectSwitcher();}});
  }
  // Pomodoro stats prefix
  if(ql && (ql==='pomodoro stats' || ql==='pomodoro' || ql==='pomo stats' || ql==='focus stats')){
    items.unshift({title:'Pomodoro Stats',desc:'Session stats with 7-day chart',icon:'P',type:'action',action:()=>{closeCommandPalette();showPomodoroStats();}});
  }
  // Content gallery prefix
  if(ql && (ql==='content gallery' || ql==='gallery' || ql==='card view' || ql==='content cards')){
    items.unshift({title:'Content Gallery',desc:'Visual card gallery of all content',icon:'G',type:'action',action:()=>{closeCommandPalette();showContentCardView();}});
  }
  // Task flow prefix
  if(ql && (ql==='task flow' || ql==='flow' || ql==='status flow' || ql==='task pipeline')){
    items.unshift({title:'Task Flow',desc:'Visual flow of tasks through statuses',icon:'F',type:'action',action:()=>{closeCommandPalette();showTaskFlow();}});
  }
  // Weekly digest prefix
  if(ql && (ql==='weekly digest' || ql==='digest' || ql==='week summary' || ql==='weekly summary')){
    items.unshift({title:'Weekly Digest',desc:'Full weekly summary with copy',icon:'W',type:'action',action:()=>{closeCommandPalette();showWeeklyDigest();}});
  }
  // Task tags prefix
  if(ql && (ql==='task tags' || ql==='task tag cloud' || ql==='tags cloud' || ql==='tag stats')){
    items.unshift({title:'Task Tag Cloud',desc:'Visual tag cloud with completion rates',icon:'#',type:'action',action:()=>{closeCommandPalette();showTaskTagCloud();}});
  }
  // Calculator prefix
  if(ql && (ql==='calculator' || ql==='calc' || ql==='calculate' || ql==='math')){
    items.unshift({title:'Quick Calculator',desc:'Floating calculator with live evaluation',icon:'=',type:'action',action:()=>{closeCommandPalette();showQuickCalculator();}});
  }
  // Markdown prefix
  if(ql && (ql==='markdown' || ql==='md preview' || ql==='markdown preview' || ql==='md editor')){
    items.unshift({title:'Markdown Preview',desc:'Live markdown editor with preview',icon:'M',type:'action',action:()=>{closeCommandPalette();showMarkdownPreview();}});
  }
  // Task dashboard prefix
  if(ql && (ql==='task dashboard' || ql==='dashboard' || ql==='task overview' || ql==='tasks dashboard')){
    items.unshift({title:'Task Dashboard',desc:'Comprehensive metrics + completion donut',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDashboard();}});
  }
  // Changelog prefix
  if(ql && (ql==='changelog' || ql==='change log' || ql==='versions' || ql==='release notes')){
    items.unshift({title:'Changelog',desc:'Version changelog with entries',icon:'V',type:'action',action:()=>{closeCommandPalette();showRepoChangelog();}});
  }
  // Reference prefix
  if(ql && (ql==='reference' || ql==='quick ref' || ql==='cheat sheet' || ql==='ref')){
    items.unshift({title:'Quick Reference',desc:'Reference cards with copy',icon:'R',type:'action',action:()=>{closeCommandPalette();showQuickReference();}});
  }
  // Activity monitor prefix
  if(ql && (ql==='activity monitor' || ql==='activity' || ql==='idle' || ql==='session')){
    items.unshift({title:'Activity Monitor',desc:'Last activity per section',icon:'A',type:'action',action:()=>{closeCommandPalette();showIdleDetector();}});
  }
  // Export prefix
  if(ql && (ql==='export' || ql==='export all' || ql==='download' || ql==='backup')){
    items.unshift({title:'Content Exporter',desc:'Export as MD, CSV, JSON, or download all',icon:'E',type:'action',action:()=>{closeCommandPalette();showContentExporter();}});
  }
  // Random task prefix
  if(ql && (ql==='random task' || ql==='random' || ql==='surprise' || ql==='pick task')){
    items.unshift({title:'Random Task',desc:'Pick a random active task to work on',icon:'?',type:'action',action:()=>{closeCommandPalette();showRandomTask();}});
  }
  // Sort content prefix
  if(ql && (ql==='sort content' || ql==='content sort' || ql==='reorder content' || ql==='organize content')){
    items.unshift({title:'Content Sorter',desc:'Sort all content permanently',icon:'S',type:'action',action:()=>{closeCommandPalette();showContentSorter();}});
  }
  // Water prefix
  if(ql && (ql==='water' || ql==='water tracker' || ql==='hydration' || ql==='drink')){
    items.unshift({title:'Water Tracker',desc:'Track daily water glasses',icon:'W',type:'action',action:()=>{closeCommandPalette();showWaterTracker();}});
  }
  // Reading queue prefix
  if(ql && (ql==='reading queue' || ql==='read later' || ql==='unread' || ql==='reading list')){
    items.unshift({title:'Reading Queue',desc:'Track unread/read links',icon:'R',type:'action',action:()=>{closeCommandPalette();showLinkReadingQueue();}});
  }
  // Completion graph prefix
  if(ql && (ql==='completion graph' || ql==='task graph' || ql==='created vs done' || ql==='velocity graph')){
    items.unshift({title:'Completion Graph',desc:'14-day created vs completed SVG chart',icon:'G',type:'action',action:()=>{closeCommandPalette();showTaskCompletionGraph();}});
  }
  // Color picker prefix
  if(ql && (ql==='color picker' || ql==='color' || ql==='colours' || ql==='hex color')){
    items.unshift({title:'Color Picker',desc:'Quick color palette with hex input',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickColor();}});
  }
  // Standup report prefix
  if(ql && (ql==='standup report' || ql==='standup' || ql==='stand up' || ql==='scrum')){
    items.unshift({title:'Standup Report',desc:'Done/In-progress/Blocked/Focus summary',icon:'S',type:'action',action:()=>{closeCommandPalette();showStandupReport();}});
  }
  // Project overview prefix
  if(ql && (ql==='project overview' || ql==='all projects' || ql==='projects grid' || ql==='overview')){
    items.unshift({title:'Project Overview',desc:'Grid overview of all projects with stats',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectOverview();}});
  }
  // Swimlanes prefix
  if(ql && (ql==='swimlanes' || ql==='swim lanes' || ql==='by project' || ql==='task lanes')){
    items.unshift({title:'Task Swimlanes',desc:'Tasks grouped by project, sorted by priority',icon:'L',type:'action',action:()=>{closeCommandPalette();showTaskSwimlanes();}});
  }
  // Decisions prefix
  if(ql && (ql==='decisions' || ql==='decision log' || ql==='decision' || ql==='why did we')){
    items.unshift({title:'Decision Log',desc:'Record decisions with context',icon:'D',type:'action',action:()=>{closeCommandPalette();showDecisionLog();}});
  }
  // Word cloud prefix
  if(ql && (ql==='word cloud' || ql==='words' || ql==='content words' || ql==='top words')){
    items.unshift({title:'Content Word Cloud',desc:'Visual word cloud from all content',icon:'W',type:'action',action:()=>{closeCommandPalette();showContentWordCloud();}});
  }
  // Clipboard prefix
  if(ql && (ql==='clipboard' || ql==='clip' || ql==='clipboard history' || ql==='paste')){
    items.unshift({title:'Clipboard History',desc:'Persistent clipboard with copy',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickClipboard();}});
  }
  // Quick todo prefix
  if(ql && (ql==='quick todo' || ql==='todo' || ql==='todo list' || ql==='checklist')){
    items.unshift({title:'Quick Todo',desc:'Floating todo list with checkboxes',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTodo();}});
  }
  // Compare content prefix
  if(ql && (ql==='compare content' || ql==='compare' || ql==='side by side' || ql==='content diff')){
    items.unshift({title:'Content Compare',desc:'Side-by-side content comparison',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentCompare();}});
  }
  // Scorecard prefix
  if(ql && (ql==='scorecard' || ql==='score' || ql==='grade' || ql==='workspace grade')){
    items.unshift({title:'Workspace Scorecard',desc:'Health grade with 7 criteria',icon:'S',type:'action',action:()=>{closeCommandPalette();showWorkspaceScorecard();}});
  }
  // Advanced search prefix
  if(ql && (ql==='advanced search' || ql==='search all' || ql==='multi search' || ql==='filter search')){
    items.unshift({title:'Advanced Search',desc:'Multi-field search with filters',icon:'S',type:'action',action:()=>{closeCommandPalette();showWorkspaceSearch();}});
  }
  // Dependencies prefix
  if(ql && (ql==='dependencies' || ql==='dependency' || ql==='blocked' || ql==='dependency graph')){
    items.unshift({title:'Task Dependencies',desc:'Visual dependency chain viewer',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDependencyGraph();}});
  }
  // Notifications prefix
  if(ql && (ql==='notifications' || ql==='alerts' || ql==='notify' || ql==='notification center')){
    items.unshift({title:'Notification Center',desc:'Overdue, due today, stale alerts',icon:'N',type:'action',action:()=>{closeCommandPalette();showNotificationCenter();}});
  }
  // Eisenhower prefix
  if(ql && (ql==='eisenhower' || ql==='matrix' || ql==='urgent important' || ql==='priority matrix')){
    items.unshift({title:'Eisenhower Matrix',desc:'Urgent vs important 2x2 grid',icon:'E',type:'action',action:()=>{closeCommandPalette();showEisenhowerMatrix();}});
  }
  // Recent activity prefix
  if(ql && (ql==='recent activity' || ql==='activity' || ql==='timeline' || ql==='history')){
    items.unshift({title:'Recent Activity',desc:'Cross-section activity timeline',icon:'R',type:'action',action:()=>{closeCommandPalette();showRecentActivity();}});
  }
  // Quick note prefix
  if(ql && (ql==='quick note' || ql==='sticky' || ql==='sticky note' || ql==='note widget')){
    items.unshift({title:'Quick Note',desc:'Floating sticky note widget',icon:'N',type:'action',action:()=>{closeCommandPalette();showQuickNote();}});
  }
  // Project timeline prefix
  if(ql && (ql==='project timeline' || ql==='gantt' || ql==='timeline projects' || ql==='project dates')){
    items.unshift({title:'Project Timeline',desc:'Gantt-style project date ranges',icon:'T',type:'action',action:()=>{closeCommandPalette();showProjectTimeline();}});
  }
  // Recurring prefix
  if(ql && (ql==='recurring' || ql==='recurrence' || ql==='recurring tasks' || ql==='repeat')){
    items.unshift({title:'Recurring Tasks',desc:'Overview of all recurring tasks',icon:'R',type:'action',action:()=>{closeCommandPalette();showTaskRecurrence();}});
  }
  // Quick link prefix
  if(ql && (ql==='quick link' || ql==='save link' || ql==='link widget' || ql==='bookmark quick')){
    items.unshift({title:'Quick Link',desc:'Floating link saver widget',icon:'L',type:'action',action:()=>{closeCommandPalette();showQuickLink();}});
  }
  // Data backup prefix
  if(ql && (ql==='data backup' || ql==='backup' || ql==='export data' || ql==='import data')){
    items.unshift({title:'Data Backup',desc:'Full export/import and snapshots',icon:'B',type:'action',action:()=>{closeCommandPalette();showDataBackup();}});
  }
  // Wall of fame prefix
  if(ql && (ql==='wall of fame' || ql==='fame' || ql==='achievements' || ql==='completed p0')){
    items.unshift({title:'Wall of Fame',desc:'Completed high-priority tasks',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWallOfFame();}});
  }
  // Content calendar prefix
  if(ql && (ql==='content calendar' || ql==='content dates' || ql==='content grid' || ql==='when content')){
    items.unshift({title:'Content Calendar',desc:'Content on monthly grid',icon:'C',type:'action',action:()=>{closeCommandPalette();showContentCalendar();}});
  }
  // Focus breakdown prefix
  if(ql && (ql==='focus breakdown' || ql==='time breakdown' || ql==='time spent' || ql==='focus time')){
    items.unshift({title:'Focus Breakdown',desc:'Time by project and priority',icon:'F',type:'action',action:()=>{closeCommandPalette();showFocusBreakdown();}});
  }
  // Link categories prefix
  if(ql && (ql==='link categories' || ql==='manage categories' || ql==='link category' || ql==='category manager')){
    items.unshift({title:'Link Categories',desc:'Rename and manage link categories',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkCategoryManager();}});
  }
  // Task aging prefix
  if(ql && (ql==='task aging' || ql==='aging' || ql==='old tasks' || ql==='stale tasks')){
    items.unshift({title:'Task Aging',desc:'Open task aging report',icon:'A',type:'action',action:()=>{closeCommandPalette();showTaskAging();}});
  }
  // Doc outline prefix
  if(ql && (ql==='doc outline' || ql==='outline' || ql==='toc' || ql==='table of contents')){
    items.unshift({title:'Document Outline',desc:'TOC from document headings',icon:'O',type:'action',action:()=>{closeCommandPalette();showDocOutline();}});
  }
  // Compare projects prefix
  if(ql && (ql==='compare projects' || ql==='project compare' || ql==='project vs' || ql==='project comparison')){
    items.unshift({title:'Project Comparison',desc:'Side-by-side project stats',icon:'V',type:'action',action:()=>{closeCommandPalette();showProjectComparison();}});
  }
  // Quick task prefix
  if(ql && (ql==='quick task' || ql==='new task widget' || ql==='task widget' || ql==='fast task')){
    items.unshift({title:'Quick Task',desc:'Floating task creator widget',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTask();}});
  }
  // Content network prefix
  if(ql && (ql==='content network' || ql==='network' || ql==='tag network' || ql==='connections')){
    items.unshift({title:'Content Network',desc:'Tag-based content connections',icon:'N',type:'action',action:()=>{closeCommandPalette();showContentNetwork();}});
  }
  // Weekly planner prefix
  if(ql && (ql==='weekly planner' || ql==='planner' || ql==='week plan' || ql==='plan week')){
    items.unshift({title:'Weekly Planner',desc:'7-day task planning grid',icon:'P',type:'action',action:()=>{closeCommandPalette();showWeeklyPlanner();}});
  }
  // Quick search prefix
  if(ql && (ql==='quick search' || ql==='search widget' || ql==='mini search' || ql==='floating search')){
    items.unshift({title:'Quick Search',desc:'Floating search widget',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickSearch();}});
  }
  // Writer stats prefix
  if(ql && (ql==='writer stats' || ql==='writing stats' || ql==='doc stats' || ql==='writing productivity')){
    items.unshift({title:'Writer Stats',desc:'Writing productivity metrics',icon:'W',type:'action',action:()=>{closeCommandPalette();showWriterStats();}});
  }
  // Velocity prefix
  if(ql && (ql==='velocity' || ql==='task velocity' || ql==='completion rate' || ql==='throughput')){
    items.unshift({title:'Task Velocity',desc:'Weekly completion trend chart',icon:'V',type:'action',action:()=>{closeCommandPalette();showTaskVelocity();}});
  }
  // Captures prefix
  if(ql && (ql==='captures' || ql==='capture dashboard' || ql==='quick captures' || ql==='captured')){
    items.unshift({title:'Captures Dashboard',desc:'All captures grouped by type',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCaptureDashboard();}});
  }
  // Theme analyzer prefix
  if(ql && (ql==='theme analyzer' || ql==='themes' || ql==='content themes' || ql==='theme breakdown')){
    items.unshift({title:'Theme Analyzer',desc:'Content theme breakdown',icon:'T',type:'action',action:()=>{closeCommandPalette();showThemeAnalyzer();}});
  }
  // Project notes prefix
  if(ql && (ql==='project notes' || ql==='project note' || ql==='notes per project' || ql==='proj notes')){
    items.unshift({title:'Project Notes',desc:'Per-project notes editor',icon:'N',type:'action',action:()=>{closeCommandPalette();showProjectNotes();}});
  }
  // Daily goals prefix
  if(ql && (ql==='daily goals' || ql==='goals' || ql==='goal tracker' || ql==='daily target')){
    items.unshift({title:'Daily Goals',desc:'Floating goal tracker widget',icon:'G',type:'action',action:()=>{closeCommandPalette();showQuickGoal();}});
  }
  // Status board prefix
  if(ql && (ql==='status board' || ql==='kanban overview' || ql==='status overview' || ql==='task status')){
    items.unshift({title:'Status Board',desc:'Kanban status counts overview',icon:'K',type:'action',action:()=>{closeCommandPalette();showStatusBoard();}});
  }
  // Word history prefix
  if(ql && (ql==='word history' || ql==='word count history' || ql==='doc growth' || ql==='word progression')){
    items.unshift({title:'Word History',desc:'Document word count chart',icon:'W',type:'action',action:()=>{closeCommandPalette();showDocWordHistory();}});
  }
  // Bookmark bar prefix
  if(ql && (ql==='bookmark bar' || ql==='bookmarks bar' || ql==='link bar' || ql==='quick links')){
    items.unshift({title:'Bookmark Bar',desc:'Floating quick-access links',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBookmarkbar();}});
  }
  // Task distribution prefix
  if(ql && (ql==='task distribution' || ql==='distribution' || ql==='task breakdown' || ql==='task chart')){
    items.unshift({title:'Task Distribution',desc:'By project, priority, status',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDistribution();}});
  }
  // Content archive prefix
  if(ql && (ql==='content archive' || ql==='archive content' || ql==='archived content' || ql==='content restore')){
    items.unshift({title:'Content Archive',desc:'Archive and restore content',icon:'A',type:'action',action:()=>{closeCommandPalette();showContentArchive();}});
  }
  // Sessions prefix
  if(ql && (ql==='sessions' || ql==='session tracker' || ql==='work session' || ql==='track session')){
    items.unshift({title:'Session Tracker',desc:'Track work sessions',icon:'S',type:'action',action:()=>{closeCommandPalette();showSessionTracker();}});
  }
  // Link explorer prefix
  if(ql && (ql==='link explorer' || ql==='explore links' || ql==='domain links' || ql==='browse links')){
    items.unshift({title:'Link Explorer',desc:'Browse links by domain',icon:'L',type:'action',action:()=>{closeCommandPalette();showLinkExplorer();}});
  }
  // Project summary prefix
  if(ql && (ql==='project summary' || ql==='summary' || ql==='executive summary' || ql==='project report')){
    items.unshift({title:'Project Summary',desc:'Executive project summary',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectSummary();}});
  }
  // Countdown prefix
  if(ql && (ql==='countdown' || ql==='count down' || ql==='deadline' || ql==='days until')){
    items.unshift({title:'Countdown',desc:'Floating date countdown widget',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCountdown();}});
  }
  // Text transform prefix
  if(ql && (ql==='text transform' || ql==='transform' || ql==='text utility' || ql==='case convert')){
    items.unshift({title:'Text Transformer',desc:'Uppercase, slug, trim, reverse',icon:'T',type:'action',action:()=>{closeCommandPalette();showTextTransformer();}});
  }
  // Link archive prefix
  if(ql && (ql==='link archive' || ql==='archive links' || ql==='archived links' || ql==='link restore')){
    items.unshift({title:'Link Archive',desc:'Archive and restore links',icon:'A',type:'action',action:()=>{closeCommandPalette();showLinkArchive();}});
  }
  // Merge docs prefix
  if(ql && (ql==='merge docs' || ql==='merge documents' || ql==='doc merge' || ql==='combine docs')){
    items.unshift({title:'Merge Documents',desc:'Merge two docs into one',icon:'M',type:'action',action:()=>{closeCommandPalette();showDocMerge();}});
  }
  // JSON viewer prefix
  if(ql && (ql==='json viewer' || ql==='json' || ql==='json format' || ql==='json pretty')){
    items.unshift({title:'JSON Viewer',desc:'Format and pretty-print JSON',icon:'J',type:'action',action:()=>{closeCommandPalette();showJsonViewer();}});
  }
  // Task templates prefix
  if(ql && (ql==='task templates' || ql==='templates' || ql==='template manager' || ql==='custom templates')){
    items.unshift({title:'Task Templates',desc:'Manage task creation templates',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTemplateManager();}});
  }
  // Workspace mood prefix
  if(ql && (ql==='workspace mood' || ql==='mood' || ql==='vibe' || ql==='workspace health')){
    items.unshift({title:'Workspace Mood',desc:'Visual mood from health metrics',icon:'M',type:'action',action:()=>{closeCommandPalette();showWorkspaceMood();}});
  }
  // Regex prefix
  if(ql && (ql==='regex' || ql==='regex tester' || ql==='pattern test' || ql==='regexp')){
    items.unshift({title:'Regex Tester',desc:'Live pattern matcher',icon:'R',type:'action',action:()=>{closeCommandPalette();showRegexTester();}});
  }
  // ICS export prefix
  if(ql && (ql==='ics export' || ql==='ics' || ql==='calendar export' || ql==='export ics')){
    items.unshift({title:'ICS Export',desc:'Download tasks as calendar file',icon:'I',type:'action',action:()=>{closeCommandPalette();showCalendarExporter();}});
  }
  // Dice prefix
  if(ql && (ql==='dice' || ql==='random' || ql==='coin flip' || ql==='decide')){
    items.unshift({title:'Random / Dice',desc:'Random number and decision maker',icon:'D',type:'action',action:()=>{closeCommandPalette();showQuickDice();}});
  }
  // Date calculator prefix
  if(ql && (ql==='date calculator' || ql==='date calc' || ql==='date math' || ql==='days between')){
    items.unshift({title:'Date Calculator',desc:'Add days, find date differences',icon:'D',type:'action',action:()=>{closeCommandPalette();showDateCalculator();}});
  }
  // Gantt prefix
  if(ql && (ql==='gantt' || ql==='gantt chart' || ql==='task gantt' || ql==='task timeline')){
    items.unshift({title:'Task Gantt',desc:'Simple task duration chart',icon:'G',type:'action',action:()=>{closeCommandPalette();showTaskGantt();}});
  }
  // Memo prefix
  if(ql && (ql==='memo' || ql==='memo pad' || ql==='notepad' || ql==='scratch pad')){
    items.unshift({title:'Quick Memo',desc:'Floating persistent memo pad',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMemo();}});
  }
  // Base64 prefix
  if(ql && (ql==='base64' || ql==='encode' || ql==='decode' || ql==='base 64')){
    items.unshift({title:'Base64 Tool',desc:'Encode and decode Base64',icon:'B',type:'action',action:()=>{closeCommandPalette();showBase64Tool();}});
  }
  // Mini kanban prefix
  if(ql && (ql==='mini kanban' || ql==='kanban mini' || ql==='quick kanban' || ql==='move tasks')){
    items.unshift({title:'Mini Kanban',desc:'Click-to-move task status board',icon:'K',type:'action',action:()=>{closeCommandPalette();showTaskKanbanMini();}});
  }
  // Clock prefix
  if(ql && (ql==='clock' || ql==='time' || ql==='watch' || ql==='current time')){
    items.unshift({title:'Clock Widget',desc:'Floating live clock',icon:'C',type:'action',action:()=>{closeCommandPalette();showClockWidget();}});
  }
  // URL encode prefix
  if(ql && (ql==='url encode' || ql==='url decode' || ql==='urlencode' || ql==='percent encode')){
    items.unshift({title:'URL Encoder',desc:'Encode and decode URLs',icon:'U',type:'action',action:()=>{closeCommandPalette();showUrlEncoder();}});
  }
  // Pareto prefix
  if(ql && (ql==='pareto' || ql==='80 20' || ql==='pareto analysis' || ql==='top projects')){
    items.unshift({title:'Pareto Analysis',desc:'80/20 task completion analysis',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskPareto();}});
  }
  // Affirmation prefix
  if(ql && (ql==='affirmation' || ql==='motivate' || ql==='motivation' || ql==='inspire')){
    items.unshift({title:'Affirmation',desc:'Random positive affirmation',icon:'*',type:'action',action:()=>{closeCommandPalette();showAffirmations();}});
  }
  // Color palette prefix
  if(ql && (ql==='color palette' || ql==='palette' || ql==='colors' || ql==='color generator')){
    items.unshift({title:'Color Palette',desc:'CSS color palette generator',icon:'C',type:'action',action:()=>{closeCommandPalette();showColorPalette();}});
  }
  // Streaks prefix
  if(ql && (ql==='streaks' || ql==='streak' || ql==='completion streak' || ql==='daily streak')){
    items.unshift({title:'Task Streaks',desc:'Daily completion streak tracker',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskStreaks();}});
  }
  // Lorem ipsum prefix
  if(ql && (ql==='lorem ipsum' || ql==='lorem' || ql==='placeholder text' || ql==='dummy text')){
    items.unshift({title:'Lorem Generator',desc:'Lorem ipsum text generator',icon:'L',type:'action',action:()=>{closeCommandPalette();showLoremGenerator();}});
  }
  if(ql && (ql==='markdown preview' || ql==='markdown' || ql==='md preview' || ql==='md editor')){
    items.unshift({title:'Markdown Preview',desc:'Live markdown editor with split preview',icon:'M',type:'action',action:()=>{closeCommandPalette();showMarkdownPreview();}});
  }
  if(ql && (ql==='task heatmap' || ql==='heatmap' || ql==='completion heatmap' || ql==='activity heatmap')){
    items.unshift({title:'Task Heatmap',desc:'GitHub-style completion heatmap',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskHeatmap();}});
  }
  if(ql && (ql==='quick timer' || ql==='timer' || ql==='stopwatch' || ql==='countdown')){
    items.unshift({title:'Quick Timer',desc:'Stopwatch and countdown timer',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTimer();}});
  }
  if(ql && (ql==='csv viewer' || ql==='csv' || ql==='csv table' || ql==='spreadsheet')){
    items.unshift({title:'CSV Viewer',desc:'Paste and view CSV data as table',icon:'C',type:'action',action:()=>{closeCommandPalette();showCsvViewer();}});
  }
  if(ql && (ql==='task bubbles' || ql==='bubble chart' || ql==='bubbles' || ql==='task chart')){
    items.unshift({title:'Task Bubble Chart',desc:'Task distribution bubble chart',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBubbleChart();}});
  }
  if(ql && (ql==='habits' || ql==='habit' || ql==='habit tracker' || ql==='daily habit')){
    items.unshift({title:'Habit Tracker',desc:'Daily habit tracker with streaks',icon:'H',type:'action',action:()=>{closeCommandPalette();showQuickHabit();}});
  }
  if(ql && (ql==='unit converter' || ql==='convert' || ql==='units' || ql==='converter')){
    items.unshift({title:'Unit Converter',desc:'Convert length, weight, temp, time, data',icon:'U',type:'action',action:()=>{closeCommandPalette();showUnitConverter();}});
  }
  if(ql && (ql==='task sunburst' || ql==='sunburst' || ql==='project sunburst' || ql==='ring chart')){
    items.unshift({title:'Task Sunburst',desc:'Sunburst chart by project and status',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskSunburst();}});
  }
  if(ql && (ql==='flashcards' || ql==='flashcard' || ql==='study cards' || ql==='flash cards')){
    items.unshift({title:'Flashcards',desc:'Study flashcard deck with flip',icon:'F',type:'action',action:()=>{closeCommandPalette();showQuickFlashcard();}});
  }
  if(ql && (ql==='diff tool' || ql==='diff' || ql==='compare text' || ql==='text diff')){
    items.unshift({title:'Text Diff Tool',desc:'Compare two texts line by line',icon:'D',type:'action',action:()=>{closeCommandPalette();showDiffTool();}});
  }
  if(ql && (ql==='task radar' || ql==='radar' || ql==='health radar' || ql==='task health')){
    items.unshift({title:'Task Health Radar',desc:'Radar chart of task health metrics',icon:'R',type:'action',action:()=>{closeCommandPalette();showTaskRadar();}});
  }
  if(ql && (ql==='journal' || ql==='daily journal' || ql==='quick journal' || ql==='diary')){
    items.unshift({title:'Quick Journal',desc:'Daily journal with timestamps',icon:'J',type:'action',action:()=>{closeCommandPalette();showQuickJournal();}});
  }
  if(ql && (ql==='password generator' || ql==='password' || ql==='pwd gen' || ql==='generate password')){
    items.unshift({title:'Password Generator',desc:'Secure random password generator',icon:'P',type:'action',action:()=>{closeCommandPalette();showPasswordGenerator();}});
  }
  if(ql && (ql==='completion trend' || ql==='task trend' || ql==='trend' || ql==='30 day trend')){
    items.unshift({title:'Completion Trend',desc:'30-day task completion trend chart',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskCompletionTrend();}});
  }
  if(ql && (ql==='quick bookmarks' || ql==='bookmarks' || ql==='bookmark manager' || ql==='saved links')){
    items.unshift({title:'Quick Bookmarks',desc:'Quick-access bookmark manager',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBookmark();}});
  }
  if(ql && (ql==='ascii art' || ql==='ascii' || ql==='text art' || ql==='block letters')){
    items.unshift({title:'ASCII Art',desc:'Convert text to ASCII block letters',icon:'A',type:'action',action:()=>{closeCommandPalette();showAsciiArt();}});
  }
  if(ql && (ql==='priority matrix' || ql==='priorities' || ql==='priority grid' || ql==='task priorities')){
    items.unshift({title:'Priority Matrix',desc:'Task priority 4-quadrant grid',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskPriorityMatrix();}});
  }
  if(ql && (ql==='code snippets' || ql==='snippets' || ql==='snippet' || ql==='code manager')){
    items.unshift({title:'Code Snippets',desc:'Save and manage code snippets',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickSnippet();}});
  }
  if(ql && (ql==='character counter' || ql==='char count' || ql==='word counter' || ql==='text stats')){
    items.unshift({title:'Character Counter',desc:'Count chars, words, sentences, read time',icon:'C',type:'action',action:()=>{closeCommandPalette();showCharCounter();}});
  }
  if(ql && (ql==='task treemap' || ql==='treemap' || ql==='tree map' || ql==='project map')){
    items.unshift({title:'Task Treemap',desc:'Treemap visualization by project',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTreemap();}});
  }
  if(ql && (ql==='polls' || ql==='poll' || ql==='quick poll' || ql==='vote')){
    items.unshift({title:'Quick Polls',desc:'Create and vote on polls',icon:'P',type:'action',action:()=>{closeCommandPalette();showQuickPoll();}});
  }
  if(ql && (ql==='hash generator' || ql==='hash' || ql==='sha256' || ql==='sha')){
    items.unshift({title:'Hash Generator',desc:'SHA-256/384/512/1 hash generator',icon:'H',type:'action',action:()=>{closeCommandPalette();showHashGenerator();}});
  }
  if(ql && (ql==='project progress' || ql==='progress' || ql==='project bars' || ql==='progress bars')){
    items.unshift({title:'Project Progress',desc:'Progress bars for all projects',icon:'P',type:'action',action:()=>{closeCommandPalette();showProjectProgress();}});
  }
  if(ql && (ql==='quick sketch' || ql==='sketch' || ql==='draw' || ql==='doodle')){
    items.unshift({title:'Quick Sketch',desc:'Mini drawing canvas',icon:'D',type:'action',action:()=>{closeCommandPalette();showQuickWhiteboard();}});
  }
  if(ql && (ql==='ip info' || ql==='ip address' || ql==='my ip' || ql==='ip lookup')){
    items.unshift({title:'IP Info',desc:'IP address and geolocation lookup',icon:'I',type:'action',action:()=>{closeCommandPalette();showIpInfo();}});
  }
  if(ql && (ql==='task funnel' || ql==='funnel' || ql==='conversion' || ql==='pipeline funnel')){
    items.unshift({title:'Task Funnel',desc:'Task pipeline funnel chart',icon:'F',type:'action',action:()=>{closeCommandPalette();showTaskFunnel();}});
  }
  if(ql && (ql==='gratitude' || ql==='grateful' || ql==='gratitude log' || ql==='thankful')){
    items.unshift({title:'Gratitude Log',desc:'Daily gratitude practice',icon:'G',type:'action',action:()=>{closeCommandPalette();showQuickGratitude();}});
  }
  if(ql && (ql==='json formatter' || ql==='json format' || ql==='format json' || ql==='json beautify')){
    items.unshift({title:'JSON Formatter',desc:'Format, minify, validate JSON',icon:'J',type:'action',action:()=>{closeCommandPalette();showJsonFormatter();}});
  }
  if(ql && (ql==='task scorecard' || ql==='scorecard' || ql==='task metrics' || ql==='task dashboard')){
    items.unshift({title:'Task Scorecard',desc:'Key task metrics dashboard',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskScorecard();}});
  }
  if(ql && (ql==='quick todos' || ql==='todos' || ql==='todo list' || ql==='checklist')){
    items.unshift({title:'Quick Todos',desc:'Lightweight checklist widget',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTodo();}});
  }
  if(ql && (ql==='cron helper' || ql==='cron' || ql==='crontab' || ql==='cron expression')){
    items.unshift({title:'Cron Helper',desc:'Cron expression builder and explainer',icon:'C',type:'action',action:()=>{closeCommandPalette();showCronHelper();}});
  }
  if(ql && (ql==='workload forecast' || ql==='workload' || ql==='forecast' || ql==='upcoming load')){
    items.unshift({title:'Workload Forecast',desc:'14-day task workload forecast',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWorkload();}});
  }
  if(ql && (ql==='sticky note' || ql==='sticky' || ql==='post-it' || ql==='note widget')){
    items.unshift({title:'Sticky Note',desc:'Draggable sticky note on screen',icon:'N',type:'action',action:()=>{closeCommandPalette();showQuickStickyNote();}});
  }
  if(ql && (ql==='emoji picker' || ql==='emoji' || ql==='emojis' || ql==='emoticon')){
    items.unshift({title:'Emoji Picker',desc:'Browse and copy emojis',icon:'E',type:'action',action:()=>{closeCommandPalette();showEmojiPicker();}});
  }
  if(ql && (ql==='time estimates' || ql==='estimates' || ql==='time est' || ql==='task time')){
    items.unshift({title:'Time Estimates',desc:'Task time estimate breakdown',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTimeEstimate();}});
  }
  if(ql && (ql==='decision matrix' || ql==='matrix' || ql==='eisenhower' || ql==='quadrant')){
    items.unshift({title:'Decision Matrix',desc:'4-quadrant decision matrix',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMatrix();}});
  }
  if(ql && (ql==='number formatter' || ql==='number format' || ql==='num format' || ql==='number convert')){
    items.unshift({title:'Number Formatter',desc:'Format numbers in many formats',icon:'N',type:'action',action:()=>{closeCommandPalette();showNumberFormatter();}});
  }
  if(ql && (ql==='weekly report' || ql==='week report' || ql==='weekly summary' || ql==='week summary')){
    items.unshift({title:'Weekly Report',desc:'Weekly task report with breakdown',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWeeklyReport();}});
  }
  if(ql && (ql==='cipher' || ql==='encrypt' || ql==='caesar' || ql==='rot13')){
    items.unshift({title:'Text Cipher',desc:'Caesar, ROT13, Atbash encryption',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCipher();}});
  }
  if(ql && (ql==='text analysis' || ql==='text stats' || ql==='word frequency' || ql==='analyze text')){
    items.unshift({title:'Text Analysis',desc:'Word/letter frequency and statistics',icon:'A',type:'action',action:()=>{closeCommandPalette();showTextStats();}});
  }
  if(ql && (ql==='task age' || ql==='age summary' || ql==='task age summary' || ql==='old tasks')){
    items.unshift({title:'Task Age Summary',desc:'Task age distribution by time buckets',icon:'A',type:'action',action:()=>{closeCommandPalette();showTaskAgeSummary();}});
  }
  if(ql && (ql==='weather' || ql==='forecast' || ql==='temperature' || ql==='current weather')){
    items.unshift({title:'Weather',desc:'Current weather from your location',icon:'W',type:'action',action:()=>{closeCommandPalette();showQuickWeather();}});
  }
  if(ql && (ql==='table generator' || ql==='table' || ql==='create table' || ql==='table builder')){
    items.unshift({title:'Table Generator',desc:'Create and export tables',icon:'T',type:'action',action:()=>{closeCommandPalette();showTableGenerator();}});
  }
  if(ql && (ql==='word cloud' || ql==='wordcloud' || ql==='tag cloud' || ql==='content cloud')){
    items.unshift({title:'Word Cloud',desc:'Word cloud from content and docs',icon:'W',type:'action',action:()=>{closeCommandPalette();showContentWordCloud();}});
  }
  if(ql && (ql==='quick kanban' || ql==='kanban widget' || ql==='mini kanban' || ql==='kanban lanes')){
    items.unshift({title:'Quick Kanban',desc:'4-lane kanban board widget',icon:'K',type:'action',action:()=>{closeCommandPalette();showQuickKanban();}});
  }
  if(ql && (ql==='color contrast' || ql==='contrast' || ql==='wcag' || ql==='accessibility')){
    items.unshift({title:'Color Contrast',desc:'WCAG color contrast checker',icon:'C',type:'action',action:()=>{closeCommandPalette();showColorContrast();}});
  }
  if(ql && (ql==='daily goals' || ql==='goals' || ql==='today goals' || ql==='day goals')){
    items.unshift({title:'Daily Goals',desc:'Daily goal tracker with progress',icon:'G',type:'action',action:()=>{closeCommandPalette();showTaskDailyGoals();}});
  }
  if(ql && (ql==='mind map' || ql==='mindmap' || ql==='brainstorm' || ql==='idea map')){
    items.unshift({title:'Mind Map',desc:'Structured mind map with branches',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMindmap();}});
  }
  if(ql && (ql==='font preview' || ql==='fonts' || ql==='font tester' || ql==='typeface')){
    items.unshift({title:'Font Preview',desc:'Preview text in 20 system fonts',icon:'F',type:'action',action:()=>{closeCommandPalette();showFontPreview();}});
  }
  if(ql && (ql==='status flow' || ql==='task flow' || ql==='flow diagram' || ql==='status diagram')){
    items.unshift({title:'Status Flow',desc:'Task status flow with counts',icon:'F',type:'action',action:()=>{closeCommandPalette();showTaskStatusFlow();}});
  }
  if(ql && (ql==='pros cons' || ql==='pros and cons' || ql==='pro con' || ql==='decision')){
    items.unshift({title:'Pros & Cons',desc:'Decision making tool',icon:'P',type:'action',action:()=>{closeCommandPalette();showQuickProsCons();}});
  }
  if(ql && (ql==='spacing guide' || ql==='spacing' || ql==='type scale' || ql==='css spacing')){
    items.unshift({title:'Spacing Guide',desc:'CSS spacing and type scale reference',icon:'S',type:'action',action:()=>{closeCommandPalette();showSpacingGuide();}});
  }
  if(ql && (ql==='milestones' || ql==='milestone' || ql==='project milestones' || ql==='timeline')){
    items.unshift({title:'Milestones',desc:'Project milestone tracker',icon:'M',type:'action',action:()=>{closeCommandPalette();showTaskMilestones();}});
  }
  if(ql && (ql==='wishlist' || ql==='wish list' || ql==='want list' || ql==='shopping list')){
    items.unshift({title:'Wishlist',desc:'Personal wishlist with priorities',icon:'W',type:'action',action:()=>{closeCommandPalette();showQuickWishlist();}});
  }
  if(ql && (ql==='box shadow' || ql==='box-shadow' || ql==='shadow generator' || ql==='css shadow')){
    items.unshift({title:'Box Shadow Generator',desc:'CSS box-shadow with live preview',icon:'B',type:'action',action:()=>{closeCommandPalette();showBoxShadowGen();}});
  }
  if(ql && (ql==='week over week' || ql==='wow' || ql==='weekly comparison' || ql==='week comparison')){
    items.unshift({title:'Week Over Week',desc:'Task completion weekly comparison',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWeekOverWeek();}});
  }
  if(ql && (ql==='reading list' || ql==='books' || ql==='book list' || ql==='to read')){
    items.unshift({title:'Reading List',desc:'Track books and articles',icon:'R',type:'action',action:()=>{closeCommandPalette();showQuickReadingList();}});
  }
  if(ql && (ql==='gradient' || ql==='gradient generator' || ql==='css gradient' || ql==='linear gradient')){
    items.unshift({title:'Gradient Generator',desc:'CSS gradient with live preview',icon:'G',type:'action',action:()=>{closeCommandPalette();showGradientGen();}});
  }
  if(ql && (ql==='completion rate' || ql==='completion' || ql==='done rate' || ql==='task rate')){
    items.unshift({title:'Completion Rate',desc:'Task completion percentage by project',icon:'%',type:'action',action:()=>{closeCommandPalette();showTaskCompletionRate();}});
  }
  if(ql && (ql==='habit streak' || ql==='streak' || ql==='habits' || ql==='daily habit')){
    items.unshift({title:'Habit Streaks',desc:'Track daily habit streaks',icon:'H',type:'action',action:()=>{closeCommandPalette();showQuickHabitStreak();}});
  }
  if(ql && (ql==='border radius' || ql==='border-radius' || ql==='radius generator' || ql==='css radius')){
    items.unshift({title:'Border Radius Generator',desc:'CSS border-radius with live preview',icon:'B',type:'action',action:()=>{closeCommandPalette();showBorderRadiusGen();}});
  }
  if(ql && (ql==='velocity' || ql==='task velocity' || ql==='throughput' || ql==='tasks per week')){
    items.unshift({title:'Task Velocity',desc:'Tasks completed per week trend',icon:'V',type:'action',action:()=>{closeCommandPalette();showTaskVelocity();}});
  }
  if(ql && (ql==='affirmation' || ql==='motivational' || ql==='daily affirmation' || ql==='inspire')){
    items.unshift({title:'Affirmation',desc:'Daily motivational affirmation',icon:'A',type:'action',action:()=>{closeCommandPalette();showQuickAffirmation();}});
  }
  if(ql && (ql==='flexbox' || ql==='flex generator' || ql==='css flex' || ql==='flex layout')){
    items.unshift({title:'Flexbox Generator',desc:'CSS flexbox layout with live preview',icon:'F',type:'action',action:()=>{closeCommandPalette();showFlexboxGen();}});
  }
  if(ql && (ql==='burndown' || ql==='task burndown' || ql==='burn down' || ql==='burndown chart')){
    items.unshift({title:'Task Burndown',desc:'Burndown chart of remaining tasks',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBurndown();}});
  }
  if(ql && (ql==='countdown' || ql==='count down' || ql==='timer countdown' || ql==='event timer')){
    items.unshift({title:'Countdown',desc:'Countdown timer to target date',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCountdown();}});
  }
  if(ql && (ql==='grid' || ql==='css grid' || ql==='grid generator' || ql==='grid layout')){
    items.unshift({title:'CSS Grid Generator',desc:'Grid layout with live preview',icon:'G',type:'action',action:()=>{closeCommandPalette();showGridGen();}});
  }
  if(ql && (ql==='distribution' || ql==='task distribution' || ql==='task breakdown' || ql==='status breakdown')){
    items.unshift({title:'Task Distribution',desc:'Tasks by status and priority',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDistribution();}});
  }
  if(ql && (ql==='dice' || ql==='dice roller' || ql==='roll dice' || ql==='d20')){
    items.unshift({title:'Dice Roller',desc:'Roll d4-d20 dice',icon:'D',type:'action',action:()=>{closeCommandPalette();showQuickDice();}});
  }
  if(ql && (ql==='animation' || ql==='css animation' || ql==='keyframes' || ql==='animation presets')){
    items.unshift({title:'Animation Presets',desc:'CSS animation library',icon:'A',type:'action',action:()=>{closeCommandPalette();showAnimationGen();}});
  }
  if(ql && (ql==='gantt' || ql==='gantt chart' || ql==='task timeline' || ql==='task gantt')){
    items.unshift({title:'Task Gantt',desc:'Gantt chart timeline view',icon:'G',type:'action',action:()=>{closeCommandPalette();showTaskGantt();}});
  }
  if(ql && (ql==='coin flip' || ql==='coin' || ql==='flip coin' || ql==='heads tails')){
    items.unshift({title:'Coin Flip',desc:'Quick coin flip with stats',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCoinFlip();}});
  }
  if(ql && (ql==='transition' || ql==='css transition' || ql==='transition generator' || ql==='hover effect')){
    items.unshift({title:'Transition Generator',desc:'CSS transition with live preview',icon:'T',type:'action',action:()=>{closeCommandPalette();showTransitionGen();}});
  }
  if(ql && (ql==='overdue' || ql==='overdue tasks' || ql==='overdue summary' || ql==='late tasks')){
    items.unshift({title:'Overdue Summary',desc:'Overdue tasks grouped by age',icon:'!',type:'action',action:()=>{closeCommandPalette();showTaskOverdueSummary();}});
  }
  if(ql && (ql==='roulette' || ql==='spin wheel' || ql==='random picker' || ql==='decision wheel')){
    items.unshift({title:'Roulette',desc:'Decision roulette spinner',icon:'R',type:'action',action:()=>{closeCommandPalette();showQuickRoulette();}});
  }
  if(ql && (ql==='media query' || ql==='media queries' || ql==='responsive' || ql==='breakpoints')){
    items.unshift({title:'Media Query Presets',desc:'CSS media query library',icon:'M',type:'action',action:()=>{closeCommandPalette();showMediaQueryGen();}});
  }
  if(ql && (ql==='created vs done' || ql==='created done' || ql==='tasks created' || ql==='task throughput')){
    items.unshift({title:'Created vs Done',desc:'Task creation vs completion chart',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskCreatedVsDone();}});
  }
  if(ql && (ql==='vote' || ql==='voting' || ql==='poll vote' || ql==='quick vote')){
    items.unshift({title:'Quick Vote',desc:'Voting and polling tool',icon:'V',type:'action',action:()=>{closeCommandPalette();showQuickVote();}});
  }
  if(ql && (ql==='clamp' || ql==='fluid type' || ql==='fluid typography' || ql==='css clamp')){
    items.unshift({title:'Clamp Generator',desc:'CSS clamp() fluid typography',icon:'C',type:'action',action:()=>{closeCommandPalette();showClampGen();}});
  }
  if(ql && (ql==='project heatmap' || ql==='proj heatmap' || ql==='status heatmap' || ql==='project matrix')){
    items.unshift({title:'Project Heatmap',desc:'Project x status heatmap grid',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskProjectHeatmap();}});
  }
  if(ql && (ql==='bingo' || ql==='dev bingo' || ql==='developer bingo' || ql==='bingo card')){
    items.unshift({title:'Dev Bingo',desc:'Developer bingo card game',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBingo();}});
  }
  if(ql && (ql==='filter' || ql==='css filter' || ql==='filter generator' || ql==='image filter')){
    items.unshift({title:'CSS Filter Generator',desc:'Filter effects with live preview',icon:'F',type:'action',action:()=>{closeCommandPalette();showFilterGen();}});
  }
  if(ql && (ql==='project timeline' || ql==='proj timeline' || ql==='completion timeline' || ql==='done timeline')){
    items.unshift({title:'Project Timeline',desc:'Project completion history',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskProjectTimeline();}});
  }
  if(ql && (ql==='spin wheel' || ql==='spin' || ql==='wheel spinner' || ql==='lucky wheel')){
    items.unshift({title:'Spin Wheel',desc:'Spin the wheel decision maker',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickSpinWheel();}});
  }
  if(ql && (ql==='text shadow' || ql==='text-shadow' || ql==='css text shadow' || ql==='shadow text')){
    items.unshift({title:'Text Shadow Generator',desc:'CSS text-shadow with live preview',icon:'T',type:'action',action:()=>{closeCommandPalette();showTextShadowGen();}});
  }
  if(ql && (ql==='streak calendar' || ql==='streak' || ql==='contribution graph' || ql==='task streak')){
    items.unshift({title:'Streak Calendar',desc:'GitHub-style task completion calendar',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskStreakCalendar();}});
  }
  if(ql && (ql==='tarot' || ql==='tarot card' || ql==='card draw' || ql==='daily card')){
    items.unshift({title:'Tarot Draw',desc:'Daily tarot card draw',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTarot();}});
  }
  if(ql && (ql==='css variables' || ql==='css vars' || ql==='theme variables' || ql==='variable themes')){
    items.unshift({title:'CSS Variable Themes',desc:'Dark theme variable presets',icon:'V',type:'action',action:()=>{closeCommandPalette();showVariableGen();}});
  }
  if(ql && (ql==='cycle time' || ql==='cycle' || ql==='lead time' || ql==='task cycle')){
    items.unshift({title:'Cycle Time',desc:'Task cycle time analysis',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskCycleTime();}});
  }
  if(ql && (ql==='motivation' || ql==='quote' || ql==='motivational quote' || ql==='inspire me')){
    items.unshift({title:'Motivation',desc:'Motivational quotes',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMotivation();}});
  }
  if(ql && (ql==='clip-path' || ql==='clip path' || ql==='css shape' || ql==='shape presets')){
    items.unshift({title:'Clip-Path Presets',desc:'CSS clip-path shape library',icon:'C',type:'action',action:()=>{closeCommandPalette();showClipPathGen();}});
  }
  if(ql && (ql==='pareto' || ql==='pareto chart' || ql==='80/20' || ql==='task pareto')){
    items.unshift({title:'Pareto Chart',desc:'Task Pareto analysis by project',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskParetoChart();}});
  }
  if(ql && (ql==='breathwork' || ql==='breathing' || ql==='breath' || ql==='box breathing')){
    items.unshift({title:'Breathwork',desc:'Guided breathing exercises',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBreathwork();}});
  }
  if(ql && (ql==='aspect ratio' || ql==='ratio' || ql==='aspect calculator' || ql==='ratio calc')){
    items.unshift({title:'Aspect Ratio',desc:'Calculator and common ratios',icon:'A',type:'action',action:()=>{closeCommandPalette();showAspectRatioCalc();}});
  }
  if(ql && (ql==='due date analysis' || ql==='due analysis' || ql==='due dates' || ql==='deadline analysis')){
    items.unshift({title:'Due Date Analysis',desc:'Task timeline by due date',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDueDateAnalysis();}});
  }
  if(ql && (ql==='meditation' || ql==='meditate' || ql==='meditation timer' || ql==='mindfulness')){
    items.unshift({title:'Meditation Timer',desc:'Timed meditation sessions',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMeditationTimer();}});
  }
  if(ql && (ql==='svg icons' || ql==='icons' || ql==='icon browser' || ql==='svg browser')){
    items.unshift({title:'SVG Icons',desc:'Icon browser with copy',icon:'I',type:'action',action:()=>{closeCommandPalette();showSvgIconBrowser();}});
  }
  if(ql && (ql==='estimate accuracy' || ql==='estimate' || ql==='accuracy' || ql==='est accuracy')){
    items.unshift({title:'Estimate Accuracy',desc:'Estimate vs actual analysis',icon:'E',type:'action',action:()=>{closeCommandPalette();showTaskEstimateAccuracy();}});
  }
  if(ql && (ql==='ambient' || ql==='ambient sound' || ql==='white noise' || ql==='noise')){
    items.unshift({title:'Ambient Sound',desc:'Focus noise generator',icon:'A',type:'action',action:()=>{closeCommandPalette();showQuickAmbientSound();}});
  }
  if(ql && (ql==='regex' || ql==='regex tester' || ql==='regexp' || ql==='regular expression')){
    items.unshift({title:'Regex Tester',desc:'Live regex pattern matching',icon:'R',type:'action',action:()=>{closeCommandPalette();showRegexTester();}});
  }
  if(ql && (ql==='sla' || ql==='sla tracker' || ql==='compliance' || ql==='task sla')){
    items.unshift({title:'SLA Tracker',desc:'Task SLA compliance',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskSLATracker();}});
  }
  if(ql && (ql==='focus score' || ql==='focus' || ql==='daily score' || ql==='productivity score')){
    items.unshift({title:'Focus Score',desc:'Daily productivity focus score',icon:'F',type:'action',action:()=>{closeCommandPalette();showQuickFocusScore();}});
  }
  if(ql && (ql==='base64' || ql==='base 64' || ql==='encode decode' || ql==='b64')){
    items.unshift({title:'Base64 Tool',desc:'Encode and decode base64',icon:'B',type:'action',action:()=>{closeCommandPalette();showBase64Tool();}});
  }
  if(ql && (ql==='productivity' || ql==='productivity dashboard' || ql==='weekly stats' || ql==='dashboard')){
    items.unshift({title:'Productivity Dashboard',desc:'Weekly productivity overview',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskProductivityDashboard();}});
  }
  if(ql && (ql==='stopwatch' || ql==='stop watch' || ql==='lap timer' || ql==='chrono')){
    items.unshift({title:'Stopwatch',desc:'Stopwatch with laps',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickStopwatch();}});
  }
  if(ql && (ql==='url encode' || ql==='url decode' || ql==='urlencode' || ql==='percent encode')){
    items.unshift({title:'URL Encode/Decode',desc:'URL encoding tool',icon:'U',type:'action',action:()=>{closeCommandPalette();showUrlEncoder();}});
  }
  if(ql && (ql==='workspace' || ql==='workspace summary' || ql==='data overview' || ql==='item counts')){
    items.unshift({title:'Workspace Summary',desc:'Full workspace overview',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWorkspaceSummary();}});
  }
  if(ql && (ql==='metronome' || ql==='bpm' || ql==='tempo' || ql==='beat')){
    items.unshift({title:'Metronome',desc:'Audio metronome with BPM control',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMetronome();}});
  }
  if(ql && (ql==='html entities' || ql==='entities' || ql==='html entity' || ql==='special characters')){
    items.unshift({title:'HTML Entities',desc:'Entity reference with copy',icon:'H',type:'action',action:()=>{closeCommandPalette();showHtmlEntityRef();}});
  }
  if(ql && (ql==='weekly digest' || ql==='digest' || ql==='week digest' || ql==='week review')){
    items.unshift({title:'Weekly Digest',desc:'Weekly task completion summary',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWeeklyDigest();}});
  }
  if(ql && (ql==='color blend' || ql==='blend' || ql==='color mix' || ql==='interpolate')){
    items.unshift({title:'Color Blend',desc:'Color interpolation tool',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickColorBlend();}});
  }
  if(ql && (ql==='world clock' || ql==='timezone' || ql==='time zone' || ql==='clock')){
    items.unshift({title:'World Clock',desc:'Timezone comparison',icon:'W',type:'action',action:()=>{closeCommandPalette();showTimezoneConverter();}});
  }
  if(ql && (ql==='tag cloud' || ql==='tags' || ql==='cloud' || ql==='word cloud tags')){
    items.unshift({title:'Tag Cloud',desc:'Visual tag frequency cloud',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTagCloud();}});
  }
  if(ql && (ql==='ruler' || ql==='screen ruler' || ql==='pixel ruler' || ql==='measure')){
    items.unshift({title:'Screen Ruler',desc:'Pixel ruler overlay',icon:'R',type:'action',action:()=>{closeCommandPalette();showQuickScreenRuler();}});
  }
  if(ql && (ql==='jwt' || ql==='jwt decoder' || ql==='json web token' || ql==='token decode')){
    items.unshift({title:'JWT Decoder',desc:'Decode and inspect JWT tokens',icon:'J',type:'action',action:()=>{closeCommandPalette();showJwtDecoder();}});
  }
  if(ql && (ql==='cumulative flow' || ql==='cfd' || ql==='cumulative' || ql==='flow diagram')){
    items.unshift({title:'Cumulative Flow',desc:'CFD for task status over time',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskCumulativeFlow();}});
  }
  if(ql && (ql==='typing test' || ql==='typing' || ql==='wpm' || ql==='typing speed')){
    items.unshift({title:'Typing Test',desc:'Typing speed test with WPM',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTypingTest();}});
  }
  if(ql && (ql==='qr code' || ql==='qr' || ql==='qr generator' || ql==='barcode')){
    items.unshift({title:'QR Code Generator',desc:'Generate QR codes from text or URLs',icon:'Q',type:'action',action:()=>{closeCommandPalette();showQrGenerator();}});
  }
  if(ql && (ql==='wip history' || ql==='wip' || ql==='work in progress' || ql==='wip chart')){
    items.unshift({title:'WIP History',desc:'Work in progress over 12 weeks',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWIPHistory();}});
  }
  if(ql && (ql==='eye break' || ql==='eye' || ql==='eye rest' || ql==='20 20 20')){
    items.unshift({title:'Eye Break',desc:'Guided eye break exercises',icon:'E',type:'action',action:()=>{closeCommandPalette();showQuickEyeBreak();}});
  }
  if(ql && (ql==='curl' || ql==='curl generator' || ql==='curl command' || ql==='http request')){
    items.unshift({title:'cURL Generator',desc:'Build cURL commands visually',icon:'C',type:'action',action:()=>{closeCommandPalette();showCurlGenerator();}});
  }
  if(ql && (ql==='task age' || ql==='age distribution' || ql==='task aging' || ql==='stale tasks')){
    items.unshift({title:'Task Age Distribution',desc:'How old are your open tasks',icon:'A',type:'action',action:()=>{closeCommandPalette();showTaskAgeDistribution();}});
  }
  if(ql && (ql==='white noise' || ql==='noise' || ql==='pink noise' || ql==='brown noise')){
    items.unshift({title:'White Noise',desc:'White/pink/brown noise generator',icon:'W',type:'action',action:()=>{closeCommandPalette();showQuickWhiteNoise();}});
  }
  if(ql && (ql==='fetch' || ql==='fetch api' || ql==='fetch generator' || ql==='api code')){
    items.unshift({title:'Fetch API Generator',desc:'Generate fetch() code snippets',icon:'F',type:'action',action:()=>{closeCommandPalette();showFetchGenerator();}});
  }
  if(ql && (ql==='priority history' || ql==='priority chart' || ql==='priority breakdown' || ql==='prio history')){
    items.unshift({title:'Priority History',desc:'Priority distribution over 8 weeks',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskPriorityHistory();}});
  }
  if(ql && (ql==='stretch' || ql==='stretching' || ql==='desk stretch' || ql==='body break')){
    items.unshift({title:'Desk Stretch',desc:'Guided stretching exercises',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickStretch();}});
  }
  if(ql && (ql==='console log' || ql==='console' || ql==='console.log' || ql==='log templates')){
    items.unshift({title:'Console.log Templates',desc:'10 useful logging patterns',icon:'C',type:'action',action:()=>{closeCommandPalette();showConsoleLogGen();}});
  }
  if(ql && (ql==='flow efficiency' || ql==='flow' || ql==='efficiency' || ql==='throughput')){
    items.unshift({title:'Flow Efficiency',desc:'Task flow metrics dashboard',icon:'F',type:'action',action:()=>{closeCommandPalette();showTaskFlowEfficiency();}});
  }
  if(ql && (ql==='gratitude' || ql==='grateful' || ql==='gratitude journal' || ql==='thankful')){
    items.unshift({title:'Gratitude Journal',desc:'Daily gratitude entries with streak',icon:'G',type:'action',action:()=>{closeCommandPalette();showQuickGratitude();}});
  }
  if(ql && (ql==='http status' || ql==='status code' || ql==='http codes' || ql==='status')){
    items.unshift({title:'HTTP Status Codes',desc:'Complete HTTP status code reference',icon:'H',type:'action',action:()=>{closeCommandPalette();showHttpStatusRef();}});
  }
  if(ql && (ql==='recurrence' || ql==='recurring' || ql==='recurring tasks' || ql==='repeat tasks')){
    items.unshift({title:'Recurrence Summary',desc:'Overview of recurring task patterns',icon:'R',type:'action',action:()=>{closeCommandPalette();showTaskRecurrenceSummary();}});
  }
  if(ql && (ql==='journal' || ql==='journal prompt' || ql==='writing prompt' || ql==='daily journal')){
    items.unshift({title:'Journal Prompt',desc:'Daily journal with writing prompts',icon:'J',type:'action',action:()=>{closeCommandPalette();showQuickJournalPrompt();}});
  }
  if(ql && (ql==='env file' || ql==='env' || ql==='.env' || ql==='dotenv')){
    items.unshift({title:'.env Generator',desc:'Build .env files with comments',icon:'E',type:'action',action:()=>{closeCommandPalette();showEnvFileGen();}});
  }
  if(ql && (ql==='blocked graph' || ql==='blocked' || ql==='dependency graph' || ql==='blockers')){
    items.unshift({title:'Blocked Graph',desc:'Task dependency blockers visualization',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBlockedGraph();}});
  }
  if(ql && (ql==='hydration' || ql==='water' || ql==='drink water' || ql==='cups')){
    items.unshift({title:'Hydration Tracker',desc:'Track daily water intake',icon:'H',type:'action',action:()=>{closeCommandPalette();showQuickHydration();}});
  }
  if(ql && (ql==='dockerfile' || ql==='docker' || ql==='container' || ql==='docker template')){
    items.unshift({title:'Dockerfile Generator',desc:'Dockerfile templates for 6 stacks',icon:'D',type:'action',action:()=>{closeCommandPalette();showDockerfileGen();}});
  }
  if(ql && (ql==='completion funnel' || ql==='funnel' || ql==='task funnel' || ql==='conversion')){
    items.unshift({title:'Completion Funnel',desc:'Task pipeline funnel visualization',icon:'F',type:'action',action:()=>{closeCommandPalette();showTaskCompletionFunnel();}});
  }
  if(ql && (ql==='screen break' || ql==='break' || ql==='take a break' || ql==='full break')){
    items.unshift({title:'Screen Break',desc:'Full-screen 5-minute break timer',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickScreenBreak();}});
  }
  if(ql && (ql==='gitignore' || ql==='.gitignore' || ql==='git ignore' || ql==='ignore file')){
    items.unshift({title:'.gitignore Generator',desc:'Generate .gitignore with preset combos',icon:'G',type:'action',action:()=>{closeCommandPalette();showGitignoreGen();}});
  }
  if(ql && (ql==='project balance' || ql==='balance' || ql==='workload' || ql==='project workload')){
    items.unshift({title:'Project Balance',desc:'Task distribution across projects',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskProjectBalance();}});
  }
  if(ql && (ql==='daily review' || ql==='review' || ql==='end of day' || ql==='day review')){
    items.unshift({title:'Daily Review',desc:'End-of-day review and reflection',icon:'D',type:'action',action:()=>{closeCommandPalette();showQuickDailyReview();}});
  }
  if(ql && (ql==='readme' || ql==='readme.md' || ql==='readme generator' || ql==='project readme')){
    items.unshift({title:'README Generator',desc:'Generate README.md with form fields',icon:'R',type:'action',action:()=>{closeCommandPalette();showReadmeGen();}});
  }
  if(ql && (ql==='status timeline' || ql==='timeline' || ql==='status area' || ql==='stacked area')){
    items.unshift({title:'Status Timeline',desc:'14-day stacked area chart of task status',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskStatusTimeline();}});
  }
  if(ql && (ql==='mood' || ql==='mood tracker' || ql==='mood log' || ql==='how am i feeling')){
    items.unshift({title:'Mood Tracker',desc:'Track daily mood with 7-day trend',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMoodTracker();}});
  }
  if(ql && (ql==='package.json' || ql==='package' || ql==='npm init' || ql==='pkg json')){
    items.unshift({title:'package.json Generator',desc:'Build package.json with form fields',icon:'P',type:'action',action:()=>{closeCommandPalette();showPackageJsonGen();}});
  }
  if(ql && (ql==='weekly goals' || ql==='goals' || ql==='week goals' || ql==='weekly plan')){
    items.unshift({title:'Weekly Goals',desc:'Set and track weekly goals',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWeeklyGoals();}});
  }
  if(ql && (ql==='sleep' || ql==='sleep log' || ql==='sleep tracker' || ql==='hours slept')){
    items.unshift({title:'Sleep Log',desc:'Track sleep hours with weekly chart',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickSleepLog();}});
  }
  if(ql && (ql==='tsconfig' || ql==='typescript config' || ql==='ts config' || ql==='typescript')){
    items.unshift({title:'tsconfig.json Generator',desc:'TypeScript config presets',icon:'T',type:'action',action:()=>{closeCommandPalette();showTsConfigGen();}});
  }
  if(ql && (ql==='weekday heatmap' || ql==='heatmap' || ql==='completion heatmap' || ql==='when do i work')){
    items.unshift({title:'Completion Heatmap',desc:'When do you complete tasks (day x hour)',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskWeekdayHeatmap();}});
  }
  if(ql && (ql==='energy' || ql==='energy level' || ql==='energy tracker' || ql==='energy check')){
    items.unshift({title:'Energy Level',desc:'Track energy throughout the day',icon:'E',type:'action',action:()=>{closeCommandPalette();showQuickEnergyLevel();}});
  }
  if(ql && (ql==='eslint' || ql==='eslint config' || ql==='linter' || ql==='lint config')){
    items.unshift({title:'ESLint Config',desc:'ESLint configuration presets',icon:'E',type:'action',action:()=>{closeCommandPalette();showEslintConfigGen();}});
  }
  if(ql && (ql==='monthly report' || ql==='monthly' || ql==='month report' || ql==='month summary')){
    items.unshift({title:'Monthly Report',desc:'This month task completion report',icon:'M',type:'action',action:()=>{closeCommandPalette();showTaskMonthlyReport();}});
  }
  if(ql && (ql==='bookmarks' || ql==='bookmark' || ql==='quick links' || ql==='saved urls')){
    items.unshift({title:'Quick Bookmarks',desc:'Save and manage quick bookmarks',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBookmark();}});
  }
  if(ql && (ql==='prettier' || ql==='prettierrc' || ql==='prettier config' || ql==='code format')){
    items.unshift({title:'Prettier Config',desc:'Generate .prettierrc with toggles',icon:'P',type:'action',action:()=>{closeCommandPalette();showPrettierConfigGen();}});
  }
  if(ql && (ql==='eisenhower' || ql==='eisenhower matrix' || ql==='urgent important' || ql==='priority matrix')){
    items.unshift({title:'Eisenhower Matrix',desc:'Classify tasks by urgency and importance',icon:'E',type:'action',action:()=>{closeCommandPalette();showTaskEisenhowerMatrix();}});
  }
  if(ql && (ql==='idea' || ql==='ideas' || ql==='quick idea' || ql==='brain dump')){
    items.unshift({title:'Quick Ideas',desc:'Capture and save ideas fast',icon:'I',type:'action',action:()=>{closeCommandPalette();showQuickIdea();}});
  }
  if(ql && (ql==='vercel.json' || ql==='vercel' || ql==='vercel config' || ql==='deploy config')){
    items.unshift({title:'vercel.json Generator',desc:'Vercel deployment config presets',icon:'V',type:'action',action:()=>{closeCommandPalette();showVercelJsonGen();}});
  }
  if(ql && (ql==='quarterly review' || ql==='quarterly' || ql==='quarter' || ql==='q1 review')){
    items.unshift({title:'Quarterly Review',desc:'Quarter task performance review',icon:'Q',type:'action',action:()=>{closeCommandPalette();showTaskQuarterlyReview();}});
  }
  if(ql && (ql==='binaural' || ql==='focus music' || ql==='binaural beats' || ql==='focus tones')){
    items.unshift({title:'Binaural Focus',desc:'Binaural beat focus tones',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickFocusMusic();}});
  }
  if(ql && (ql==='nginx' || ql==='nginx config' || ql==='reverse proxy' || ql==='server config')){
    items.unshift({title:'nginx Config',desc:'nginx server configuration presets',icon:'N',type:'action',action:()=>{closeCommandPalette();showNginxConfigGen();}});
  }
  if(ql && (ql==='velocity trend' || ql==='velocity' || ql==='speed trend' || ql==='completion velocity')){
    items.unshift({title:'Velocity Trend',desc:'Task completion velocity over 10 weeks',icon:'V',type:'action',action:()=>{closeCommandPalette();showTaskVelocityTrend();}});
  }
  if(ql && (ql==='abc' || ql==='abc priority' || ql==='abc method' || ql==='priority list')){
    items.unshift({title:'ABC Prioritizer',desc:'Categorize items by A/B/C priority',icon:'A',type:'action',action:()=>{closeCommandPalette();showQuickAbcPrioritizer();}});
  }
  if(ql && (ql==='docker compose' || ql==='compose' || ql==='docker-compose' || ql==='compose yaml')){
    items.unshift({title:'Docker Compose',desc:'Docker Compose templates for common stacks',icon:'D',type:'action',action:()=>{closeCommandPalette();showDockerComposeGen();}});
  }
  if(ql && (ql==='creation trend' || ql==='created vs done' || ql==='task trend' || ql==='creation rate')){
    items.unshift({title:'Creation Trend',desc:'Task creation vs completion (21 days)',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskCreationTrend();}});
  }
  if(ql && (ql==='decision log' || ql==='decisions' || ql==='decision tracker' || ql==='log decision')){
    items.unshift({title:'Decision Log',desc:'Track and review decisions made',icon:'D',type:'action',action:()=>{closeCommandPalette();showQuickDecisionLog();}});
  }
  if(ql && (ql==='github actions' || ql==='actions' || ql==='ci cd' || ql==='workflow')){
    items.unshift({title:'GitHub Actions',desc:'CI/CD workflow templates',icon:'G',type:'action',action:()=>{closeCommandPalette();showGithubActionsGen();}});
  }
  if(ql && (ql==='done vs created' || ql==='done vs' || ql==='project completion' || ql==='project stats')){
    items.unshift({title:'Done vs Created',desc:'Completion rate by project',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDoneVsCreated();}});
  }
  if(ql && (ql==='win streak' || ql==='wins' || ql==='daily wins' || ql==='celebrate')){
    items.unshift({title:'Win Streak',desc:'Track daily wins with streak counter',icon:'W',type:'action',action:()=>{closeCommandPalette();showQuickWinStreak();}});
  }
  if(ql && (ql==='license' || ql==='license file' || ql==='mit license' || ql==='open source license')){
    items.unshift({title:'LICENSE Generator',desc:'Generate LICENSE files (MIT, Apache, ISC, Unlicense)',icon:'L',type:'action',action:()=>{closeCommandPalette();showLicenseGen();}});
  }
  if(ql && (ql==='blocked time' || ql==='blocked analysis' || ql==='time blocked' || ql==='stuck tasks')){
    items.unshift({title:'Blocked Time',desc:'How long tasks have been blocked',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBlockedTime();}});
  }
  if(ql && (ql==='reading log' || ql==='books' || ql==='reading' || ql==='book tracker')){
    items.unshift({title:'Reading Log',desc:'Track books you are reading',icon:'R',type:'action',action:()=>{closeCommandPalette();showQuickReadingLog();}});
  }
  if(ql && (ql==='cron' || ql==='cron job' || ql==='crontab' || ql==='schedule')){
    items.unshift({title:'Cron Generator',desc:'Build cron expressions visually',icon:'C',type:'action',action:()=>{closeCommandPalette();showCronJobGen();}});
  }
  if(ql && (ql==='sprint' || ql==='sprint board' || ql==='sprint planning' || ql==='scrum')){
    items.unshift({title:'Sprint Board',desc:'2-week sprint with task tracking',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskSprintBoard();}});
  }
  if(ql && (ql==='morning routine' || ql==='morning' || ql==='routine' || ql==='morning checklist')){
    items.unshift({title:'Morning Routine',desc:'Daily morning checklist with streak',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMorningRoutine();}});
  }
  if(ql && (ql==='makefile' || ql==='make' || ql==='makefile generator' || ql==='build system')){
    items.unshift({title:'Makefile Generator',desc:'Generate Makefiles for C, Node, Python, Docker, Go',icon:'M',type:'action',action:()=>{closeCommandPalette();showMakefileGen();}});
  }
  if(ql && (ql==='overdue chart' || ql==='overdue' || ql==='overdue distribution' || ql==='late tasks')){
    items.unshift({title:'Overdue Chart',desc:'Distribution of overdue tasks by time',icon:'O',type:'action',action:()=>{closeCommandPalette();showTaskOverdueChart();}});
  }
  if(ql && (ql==='water intake' || ql==='water' || ql==='hydration tracker' || ql==='drink water')){
    items.unshift({title:'Water Intake',desc:'Track daily water glasses',icon:'W',type:'action',action:()=>{closeCommandPalette();showQuickWaterIntake();}});
  }
  if(ql && (ql==='webpack' || ql==='webpack config' || ql==='bundler' || ql==='webpack generator')){
    items.unshift({title:'Webpack Config',desc:'Generate webpack.config.js for React, TS, Node, Library',icon:'W',type:'action',action:()=>{closeCommandPalette();showWebpackConfigGen();}});
  }
  if(ql && (ql==='tag cloud' || ql==='tags' || ql==='word cloud' || ql==='tag visualization')){
    items.unshift({title:'Tag Cloud',desc:'Visual tag cloud from tasks and content',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTagCloud();}});
  }
  if(ql && (ql==='affirmation' || ql==='motivate' || ql==='motivation' || ql==='daily affirmation')){
    items.unshift({title:'Daily Affirmation',desc:'Random motivational affirmation',icon:'A',type:'action',action:()=>{closeCommandPalette();showQuickAffirmation();}});
  }
  if(ql && (ql==='babel' || ql==='babelrc' || ql==='babel config' || ql==='transpiler')){
    items.unshift({title:'Babel Config',desc:'Generate .babelrc for React, TS, Node',icon:'B',type:'action',action:()=>{closeCommandPalette();showBabelConfigGen();}});
  }
  if(ql && (ql==='completion rate' || ql==='completion' || ql==='done rate' || ql==='progress rate')){
    items.unshift({title:'Completion Rate',desc:'Donut chart of task completion',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskCompletionRate();}});
  }
  if(ql && (ql==='box breathing' || ql==='box breath' || ql==='breathing box' || ql==='square breathing')){
    items.unshift({title:'Box Breathing',desc:'4-4-4-4 box breathing exercise',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBreathingBox();}});
  }
  if(ql && (ql==='editorconfig' || ql==='editor config' || ql==='indent' || ql==='code style')){
    items.unshift({title:'EditorConfig',desc:'Generate .editorconfig for consistent code style',icon:'E',type:'action',action:()=>{closeCommandPalette();showEditorConfigGen();}});
  }
  if(ql && (ql==='due date calendar' || ql==='due calendar' || ql==='due dates' || ql==='deadline calendar')){
    items.unshift({title:'Due Date Calendar',desc:'Mini calendar showing task due dates',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDueDateCalendar();}});
  }
  if(ql && (ql==='focus timer' || ql==='pomodoro timer' || ql==='timer widget' || ql==='work timer')){
    items.unshift({title:'Focus Timer',desc:'25/5 Pomodoro timer widget',icon:'F',type:'action',action:()=>{closeCommandPalette();showQuickFocusTimer();}});
  }
  if(ql && (ql==='jest' || ql==='jest config' || ql==='testing config' || ql==='test setup')){
    items.unshift({title:'Jest Config',desc:'Generate jest.config.js for JS, TS, React, Next',icon:'J',type:'action',action:()=>{closeCommandPalette();showJestConfigGen();}});
  }
  if(ql && (ql==='workload' || ql==='workload balance' || ql==='project balance' || ql==='task distribution')){
    items.unshift({title:'Workload Balance',desc:'Task distribution by project with priorities',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWorkloadBalance();}});
  }
  if(ql && (ql==='daily quote' || ql==='quote' || ql==='quote of the day' || ql==='inspiration')){
    items.unshift({title:'Daily Quote',desc:'Programming quote of the day',icon:'Q',type:'action',action:()=>{closeCommandPalette();showQuickDailyQuote();}});
  }
  if(ql && (ql==='tailwind' || ql==='tailwind config' || ql==='tailwindcss' || ql==='tw config')){
    items.unshift({title:'Tailwind Config',desc:'Generate tailwind.config.js presets',icon:'T',type:'action',action:()=>{closeCommandPalette();showTailwindConfigGen();}});
  }
  if(ql && (ql==='burndown' || ql==='burn down' || ql==='burndown chart' || ql==='task burndown')){
    items.unshift({title:'Burndown Chart',desc:'14-day task burndown trend',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBurndown();}});
  }
  if(ql && (ql==='habit tracker' || ql==='habits' || ql==='habit' || ql==='daily habits')){
    items.unshift({title:'Habit Tracker',desc:'Track daily habits with 7-day grid',icon:'H',type:'action',action:()=>{closeCommandPalette();showQuickHabitTracker();}});
  }
  if(ql && (ql==='postcss' || ql==='postcss config' || ql==='css plugins' || ql==='postcss generator')){
    items.unshift({title:'PostCSS Config',desc:'Generate postcss.config.js with plugin presets',icon:'P',type:'action',action:()=>{closeCommandPalette();showPostcssConfigGen();}});
  }
  if(ql && (ql==='stale tasks' || ql==='stale' || ql==='old tasks' || ql==='abandoned tasks')){
    items.unshift({title:'Stale Tasks',desc:'Tasks older than 7 days still open',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskStaleItems();}});
  }
  if(ql && (ql==='color picker' || ql==='color' || ql==='colors' || ql==='colour picker')){
    items.unshift({title:'Color Picker',desc:'Pick colors with palettes and format conversion',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickColorPicker();}});
  }
  if(ql && (ql==='vite' || ql==='vite config' || ql==='vite.config' || ql==='vite setup')){
    items.unshift({title:'Vite Config',desc:'Generate vite.config.js for React, Vue, Svelte, Library',icon:'V',type:'action',action:()=>{closeCommandPalette();showViteConfigGen();}});
  }
  if(ql && (ql==='priority matrix' || ql==='urgency matrix' || ql==='important urgent' || ql==='task matrix')){
    items.unshift({title:'Priority Matrix',desc:'Urgent/important 2x2 task matrix',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskPriorityMatrix();}});
  }
  if(ql && (ql==='stopwatch' || ql==='lap timer' || ql==='stop watch' || ql==='elapsed time')){
    items.unshift({title:'Stopwatch',desc:'Stopwatch with lap tracking',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickStopwatch();}});
  }
  if(ql && (ql==='rollup' || ql==='rollup config' || ql==='rollup.config' || ql==='rollup bundler')){
    items.unshift({title:'Rollup Config',desc:'Generate rollup.config.js for ESM, UMD, TypeScript',icon:'R',type:'action',action:()=>{closeCommandPalette();showRollupConfigGen();}});
  }
  if(ql && (ql==='estimate accuracy' || ql==='estimate' || ql==='time accuracy' || ql==='estimation')){
    items.unshift({title:'Estimate Accuracy',desc:'Compare estimates vs actual time tracked',icon:'E',type:'action',action:()=>{closeCommandPalette();showTaskTimeEstimateAccuracy();}});
  }
  if(ql && (ql==='countdown' || ql==='countdown timer' || ql==='count down' || ql==='timer countdown')){
    items.unshift({title:'Countdown Timer',desc:'Countdown timer with preset durations',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCountdownTimer();}});
  }
  if(ql && (ql==='swc' || ql==='swc config' || ql==='swcrc' || ql==='swc compiler')){
    items.unshift({title:'SWC Config',desc:'Generate .swcrc for React, TS, Next, Node',icon:'S',type:'action',action:()=>{closeCommandPalette();showSwcConfigGen();}});
  }
  if(ql && (ql==='dependencies' || ql==='dependency list' || ql==='blocked by' || ql==='task deps')){
    items.unshift({title:'Task Dependencies',desc:'View blocked tasks and their blockers',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDependencyList();}});
  }
  if(ql && (ql==='dice' || ql==='dice roller' || ql==='roll dice' || ql==='d20')){
    items.unshift({title:'Dice Roller',desc:'Roll d4, d6, d8, d10, d12, d20, d100',icon:'D',type:'action',action:()=>{closeCommandPalette();showQuickDiceRoller();}});
  }
  if(ql && (ql==='sql schema' || ql==='sql' || ql==='create table' || ql==='database schema')){
    items.unshift({title:'SQL Schema',desc:'Generate SQL CREATE TABLE statements',icon:'S',type:'action',action:()=>{closeCommandPalette();showSqlSchemaGen();}});
  }
  if(ql && (ql==='project timeline' || ql==='timeline' || ql==='project progress' || ql==='project status')){
    items.unshift({title:'Project Timeline',desc:'Progress bars for all projects',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskProjectTimeline();}});
  }
  if(ql && (ql==='coin flip' || ql==='coin' || ql==='flip coin' || ql==='heads tails')){
    items.unshift({title:'Coin Flip',desc:'Random coin flip with history',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCoinFlip();}});
  }
  if(ql && (ql==='prisma' || ql==='prisma schema' || ql==='orm schema' || ql==='prisma model')){
    items.unshift({title:'Prisma Schema',desc:'Generate Prisma models for auth, blog, e-commerce',icon:'P',type:'action',action:()=>{closeCommandPalette();showPrismaSchemaGen();}});
  }
  if(ql && (ql==='weekly review' || ql==='week review' || ql==='week summary' || ql==='weekly summary')){
    items.unshift({title:'Weekly Review',desc:'7-day task activity summary',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWeeklyReview();}});
  }
  if(ql && (ql==='random number' || ql==='random' || ql==='rng' || ql==='number generator')){
    items.unshift({title:'Random Number',desc:'Random number in custom range',icon:'R',type:'action',action:()=>{closeCommandPalette();showQuickRandomNumber();}});
  }
  if(ql && (ql==='mongoose' || ql==='mongo schema' || ql==='mongodb' || ql==='mongoose model')){
    items.unshift({title:'Mongoose Schema',desc:'Generate Mongoose models for User, Blog, Product',icon:'M',type:'action',action:()=>{closeCommandPalette();showMongoSchemaGen();}});
  }
  if(ql && (ql==='status pie' || ql==='pie chart' || ql==='task pie' || ql==='status chart')){
    items.unshift({title:'Status Pie Chart',desc:'Pie chart of task statuses',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskStatusPie();}});
  }
  if(ql && (ql==='password strength' || ql==='password' || ql==='password check' || ql==='pwd strength')){
    items.unshift({title:'Password Strength',desc:'Check password strength with criteria',icon:'P',type:'action',action:()=>{closeCommandPalette();showQuickPasswordStrength();}});
  }
  if(ql && (ql==='kubernetes' || ql==='k8s' || ql==='kube yaml' || ql==='k8s config')){
    items.unshift({title:'Kubernetes YAML',desc:'Generate K8s Deployment, Service, Ingress, Config',icon:'K',type:'action',action:()=>{closeCommandPalette();showKubernetesYamlGen();}});
  }
  if(ql && (ql==='creation heatmap' || ql==='heatmap' || ql==='task heatmap' || ql==='activity heatmap')){
    items.unshift({title:'Creation Heatmap',desc:'GitHub-style task creation heatmap',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskCreationHeatmap();}});
  }
  if(ql && (ql==='world clock' || ql==='time zones' || ql==='timezone' || ql==='clocks')){
    items.unshift({title:'World Clock',desc:'Live clocks for 8 time zones',icon:'W',type:'action',action:()=>{closeCommandPalette();showQuickWorldClock();}});
  }
  if(ql && (ql==='terraform' || ql==='tf' || ql==='infrastructure' || ql==='iac')){
    items.unshift({title:'Terraform Config',desc:'Generate Terraform for AWS EC2, S3, Variables',icon:'T',type:'action',action:()=>{closeCommandPalette();showTerraformGen();}});
  }
  if(ql && (ql==='lead time' || ql==='cycle time' || ql==='task time' || ql==='time to complete')){
    items.unshift({title:'Lead Time',desc:'Time from creation to completion per task',icon:'L',type:'action',action:()=>{closeCommandPalette();showTaskLeadTime();}});
  }
  if(ql && (ql==='metronome' || ql==='beat' || ql==='tempo' || ql==='bpm')){
    items.unshift({title:'Metronome',desc:'Audio metronome with BPM control',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMetronome();}});
  }
  if(ql && (ql==='api endpoint' || ql==='rest api' || ql==='api generator' || ql==='express api')){
    items.unshift({title:'API Endpoint Gen',desc:'Generate REST API routes for Express, Next, Fastify',icon:'A',type:'action',action:()=>{closeCommandPalette();showApiEndpointGen();}});
  }
  if(ql && (ql==='cycle time' || ql==='cycle distribution' || ql==='completion time' || ql==='how long tasks take')){
    items.unshift({title:'Cycle Time Distribution',desc:'How long tasks take from creation to done',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskCycleTimeDistribution();}});
  }
  if(ql && (ql==='tip calculator' || ql==='tip' || ql==='calculate tip' || ql==='tip calc')){
    items.unshift({title:'Tip Calculator',desc:'Calculate tip with bill split',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTipCalculator();}});
  }
  if(ql && (ql==='graphql' || ql==='gql' || ql==='graphql schema' || ql==='gql schema')){
    items.unshift({title:'GraphQL Schema',desc:'Generate GraphQL types and resolvers',icon:'G',type:'action',action:()=>{closeCommandPalette();showGraphqlSchemaGen();}});
  }
  if(ql && (ql==='throughput' || ql==='weekly throughput' || ql==='task throughput' || ql==='velocity chart')){
    items.unshift({title:'Throughput Chart',desc:'Weekly completed vs created tasks',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskThroughput();}});
  }
  if(ql && (ql==='text diff' || ql==='diff' || ql==='compare text' || ql==='text compare')){
    items.unshift({title:'Text Diff',desc:'Compare two texts side by side',icon:'D',type:'action',action:()=>{closeCommandPalette();showQuickTextDiff();}});
  }
  if(ql && (ql==='socket.io' || ql==='socketio' || ql==='websocket' || ql==='realtime')){
    items.unshift({title:'Socket.IO Boilerplate',desc:'Server, React client, chat room templates',icon:'S',type:'action',action:()=>{closeCommandPalette();showSocketIoBoilerplate();}});
  }
  if(ql && (ql==='project radar' || ql==='radar chart' || ql==='radar' || ql==='project metrics')){
    items.unshift({title:'Project Radar',desc:'Multi-project radar comparison chart',icon:'R',type:'action',action:()=>{closeCommandPalette();showTaskProjectRadar();}});
  }
  if(ql && (ql==='markdown preview' || ql==='md preview' || ql==='markdown' || ql==='preview markdown')){
    items.unshift({title:'Markdown Preview',desc:'Live side-by-side markdown renderer',icon:'M',type:'action',action:()=>{closeCommandPalette();showQuickMarkdownPreview();}});
  }
  if(ql && (ql==='jwt' || ql==='jwt decode' || ql==='jwt decoder' || ql==='token decode')){
    items.unshift({title:'JWT Decoder',desc:'Decode and inspect JWT tokens',icon:'J',type:'action',action:()=>{closeCommandPalette();showJwtDecoder();}});
  }
  if(ql && (ql==='task dashboard' || ql==='dashboard' || ql==='task summary' || ql==='overview')){
    items.unshift({title:'Task Dashboard',desc:'Full task metrics summary',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskSummaryDashboard();}});
  }
  if(ql && (ql==='ascii art' || ql==='ascii' || ql==='text art' || ql==='art')){
    items.unshift({title:'ASCII Art',desc:'Copy fun ASCII art characters',icon:'A',type:'action',action:()=>{closeCommandPalette();showQuickAsciiArt();}});
  }
  if(ql && (ql==='redis' || ql==='redis commands' || ql==='redis ref' || ql==='cache commands')){
    items.unshift({title:'Redis Reference',desc:'Redis command cheatsheet by category',icon:'R',type:'action',action:()=>{closeCommandPalette();showRedisCommandRef();}});
  }
  if(ql && (ql==='progress gauge' || ql==='gauge' || ql==='overall progress' || ql==='progress ring')){
    items.unshift({title:'Progress Gauge',desc:'Circular gauge of overall task completion',icon:'G',type:'action',action:()=>{closeCommandPalette();showTaskProgressGauge();}});
  }
  if(ql && (ql==='lorem ipsum' || ql==='lorem' || ql==='placeholder text' || ql==='dummy text')){
    items.unshift({title:'Lorem Ipsum',desc:'Generate placeholder text paragraphs',icon:'L',type:'action',action:()=>{closeCommandPalette();showQuickLoremIpsum();}});
  }
  if(ql && (ql==='git commands' || ql==='git ref' || ql==='git cheatsheet' || ql==='git reference')){
    items.unshift({title:'Git Reference',desc:'Git command cheatsheet by category',icon:'G',type:'action',action:()=>{closeCommandPalette();showGitCommandRef();}});
  }
  if(ql && (ql==='age histogram' || ql==='task age' || ql==='age distribution' || ql==='how old tasks')){
    items.unshift({title:'Age Histogram',desc:'Distribution of open task ages',icon:'A',type:'action',action:()=>{closeCommandPalette();showTaskAgeHistogram();}});
  }
  if(ql && (ql==='char counter' || ql==='character count' || ql==='word count' || ql==='text counter')){
    items.unshift({title:'Character Counter',desc:'Count chars, words, lines, sentences',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCharCounter();}});
  }
  if(ql && (ql==='npm' || ql==='npm commands' || ql==='npm ref' || ql==='npm scripts')){
    items.unshift({title:'npm Reference',desc:'npm command cheatsheet by category',icon:'N',type:'action',action:()=>{closeCommandPalette();showNpmScriptsRef();}});
  }
  if(ql && (ql==='flow board' || ql==='kanban' || ql==='flow' || ql==='mini board')){
    items.unshift({title:'Flow Board',desc:'Mini kanban board overview',icon:'F',type:'action',action:()=>{closeCommandPalette();showTaskFlowBoard();}});
  }
  if(ql && (ql==='emoji' || ql==='emoji picker' || ql==='emojis' || ql==='emoticon')){
    items.unshift({title:'Emoji Picker',desc:'Pick and copy emojis by category',icon:'E',type:'action',action:()=>{closeCommandPalette();showQuickEmojiPicker();}});
  }
  if(ql && (ql==='yarn' || ql==='yarn commands' || ql==='yarn ref' || ql==='yarn reference')){
    items.unshift({title:'Yarn Reference',desc:'Yarn command cheatsheet by category',icon:'Y',type:'action',action:()=>{closeCommandPalette();showYarnCommandRef();}});
  }
  if(ql && (ql==='velocity' || ql==='velocity trend' || ql==='completion speed' || ql==='task velocity')){
    items.unshift({title:'Velocity Trend',desc:'Task completion velocity over 8 weeks',icon:'V',type:'action',action:()=>{closeCommandPalette();showTaskVelocityTrend();}});
  }
  if(ql && (ql==='unit converter' || ql==='convert' || ql==='units' || ql==='conversion')){
    items.unshift({title:'Unit Converter',desc:'Convert length, weight, temperature',icon:'U',type:'action',action:()=>{closeCommandPalette();showQuickUnitConverter();}});
  }
  if(ql && (ql==='pnpm' || ql==='pnpm commands' || ql==='pnpm ref' || ql==='pnpm reference')){
    items.unshift({title:'pnpm Reference',desc:'pnpm command cheatsheet by category',icon:'P',type:'action',action:()=>{closeCommandPalette();showPnpmCommandRef();}});
  }
  if(ql && (ql==='blocked report' || ql==='blocked' || ql==='at risk' || ql==='risk report')){
    items.unshift({title:'Blocked Report',desc:'Blocked, overdue, and stale task report',icon:'B',type:'action',action:()=>{closeCommandPalette();showTaskBlockedReport();}});
  }
  if(ql && (ql==='bmi' || ql==='bmi calculator' || ql==='body mass' || ql==='bmi calc')){
    items.unshift({title:'BMI Calculator',desc:'Calculate body mass index',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBmiCalc();}});
  }
  if(ql && (ql==='deno' || ql==='deno commands' || ql==='deno ref' || ql==='deno reference')){
    items.unshift({title:'Deno Reference',desc:'Deno command cheatsheet by category',icon:'D',type:'action',action:()=>{closeCommandPalette();showDenoCommandRef();}});
  }
  if(ql && (ql==='completion calendar' || ql==='completion heatmap' || ql==='done calendar' || ql==='done heatmap')){
    items.unshift({title:'Completion Calendar',desc:'90-day task completion heatmap',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskCompletionCalendar();}});
  }
  if(ql && (ql==='percentage' || ql==='percent' || ql==='percentage calc' || ql==='pct calculator')){
    items.unshift({title:'Percentage Calculator',desc:'Calculate percentages quickly',icon:'%',type:'action',action:()=>{closeCommandPalette();showQuickPercentageCalc();}});
  }
  if(ql && (ql==='bun' || ql==='bun commands' || ql==='bun ref' || ql==='bun reference')){
    items.unshift({title:'Bun Reference',desc:'Bun command cheatsheet by category',icon:'B',type:'action',action:()=>{closeCommandPalette();showBunCommandRef();}});
  }
  if(ql && (ql==='effort' || ql==='effort distribution' || ql==='estimate chart' || ql==='task effort')){
    items.unshift({title:'Effort Distribution',desc:'Task estimate breakdown by duration',icon:'E',type:'action',action:()=>{closeCommandPalette();showTaskEffortDistribution();}});
  }
  if(ql && (ql==='time zones' || ql==='timezone' || ql==='world clock' || ql==='time zone converter')){
    items.unshift({title:'Time Zones',desc:'Current time in major cities',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickTimeZoneConverter();}});
  }
  if(ql && (ql==='curl' || ql==='curl commands' || ql==='curl ref' || ql==='curl reference')){
    items.unshift({title:'curl Reference',desc:'curl command cheatsheet by category',icon:'C',type:'action',action:()=>{closeCommandPalette();showCurlCommandRef();}});
  }
  if(ql && (ql==='project breakdown' || ql==='project stats' || ql==='project tasks' || ql==='breakdown by project')){
    items.unshift({title:'Project Breakdown',desc:'Task progress breakdown by project',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskProjectBreakdown();}});
  }
  if(ql && (ql==='date diff' || ql==='date difference' || ql==='days between' || ql==='date calc')){
    items.unshift({title:'Date Difference',desc:'Calculate days between two dates',icon:'D',type:'action',action:()=>{closeCommandPalette();showQuickDateDiff();}});
  }
  if(ql && (ql==='ssh' || ql==='ssh commands' || ql==='ssh ref' || ql==='ssh reference')){
    items.unshift({title:'SSH Reference',desc:'SSH command cheatsheet by category',icon:'S',type:'action',action:()=>{closeCommandPalette();showSshCommandRef();}});
  }
  if(ql && (ql==='recurring' || ql==='recurrence' || ql==='recurring tasks' || ql==='repeating tasks')){
    items.unshift({title:'Recurring Tasks',desc:'Overview of all recurring tasks',icon:'R',type:'action',action:()=>{closeCommandPalette();showTaskRecurrenceOverview();}});
  }
  if(ql && (ql==='base converter' || ql==='base convert' || ql==='hex to decimal' || ql==='binary convert')){
    items.unshift({title:'Base Converter',desc:'Convert between decimal, hex, binary, octal',icon:'#',type:'action',action:()=>{closeCommandPalette();showQuickBaseConverter();}});
  }
  if(ql && (ql==='aws' || ql==='aws cli' || ql==='aws commands' || ql==='aws reference')){
    items.unshift({title:'AWS CLI Reference',desc:'AWS CLI cheatsheet by service',icon:'A',type:'action',action:()=>{closeCommandPalette();showAwsCliRef();}});
  }
  if(ql && (ql==='created vs done' || ql==='created done' || ql==='task flow' || ql==='inflow outflow')){
    items.unshift({title:'Created vs Done',desc:'Monthly task creation vs completion chart',icon:'C',type:'action',action:()=>{closeCommandPalette();showTaskCreatedVsDone();}});
  }
  if(ql && (ql==='color converter' || ql==='color convert' || ql==='hex to rgb' || ql==='rgb to hex')){
    items.unshift({title:'Color Converter',desc:'Convert between HEX, RGB, HSL',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickColorConverter();}});
  }
  if(ql && (ql==='vercel' || ql==='vercel cli' || ql==='vercel commands' || ql==='vercel ref')){
    items.unshift({title:'Vercel CLI Reference',desc:'Vercel CLI cheatsheet by category',icon:'V',type:'action',action:()=>{closeCommandPalette();showVercelCliRef();}});
  }
  if(ql && (ql==='wip age' || ql==='wip report' || ql==='in progress age' || ql==='work in progress')){
    items.unshift({title:'WIP Age Report',desc:'Age of in-progress tasks',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWipAge();}});
  }
  if(ql && (ql==='string encoder' || ql==='base64' || ql==='url encode' || ql==='encode decode')){
    items.unshift({title:'String Encoder',desc:'Base64, URL, HTML encode/decode',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickStringEncoder();}});
  }
  if(ql && (ql==='gh cli' || ql==='github cli' || ql==='gh commands' || ql==='gh reference')){
    items.unshift({title:'GitHub CLI Reference',desc:'gh CLI cheatsheet by category',icon:'G',type:'action',action:()=>{closeCommandPalette();showGhCliRef();}});
  }
  if(ql && (ql==='priority distribution' || ql==='priority pie' || ql==='priority chart' || ql==='priority breakdown')){
    items.unshift({title:'Priority Distribution',desc:'Open tasks by priority pie chart',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskPriorityTrend();}});
  }
  if(ql && (ql==='ip lookup' || ql==='ip address' || ql==='my ip' || ql==='whats my ip')){
    items.unshift({title:'IP Lookup',desc:'Your current IP and location info',icon:'I',type:'action',action:()=>{closeCommandPalette();showQuickIpLookup();}});
  }
  if(ql && (ql==='fly' || ql==='fly cli' || ql==='fly.io' || ql==='flyctl')){
    items.unshift({title:'Fly.io CLI Reference',desc:'Fly.io CLI cheatsheet by category',icon:'F',type:'action',action:()=>{closeCommandPalette();showFlyCliRef();}});
  }
  if(ql && (ql==='due soon' || ql==='due today' || ql==='upcoming due' || ql==='deadlines')){
    items.unshift({title:'Due Soon',desc:'Tasks grouped by urgency',icon:'D',type:'action',action:()=>{closeCommandPalette();showTaskDueSoonList();}});
  }
  if(ql && (ql==='json formatter' || ql==='json format' || ql==='json pretty' || ql==='format json')){
    items.unshift({title:'JSON Formatter',desc:'Pretty print and minify JSON',icon:'J',type:'action',action:()=>{closeCommandPalette();showQuickJsonFormatter();}});
  }
  if(ql && (ql==='netlify' || ql==='netlify cli' || ql==='netlify commands' || ql==='netlify ref')){
    items.unshift({title:'Netlify CLI Reference',desc:'Netlify CLI cheatsheet by category',icon:'N',type:'action',action:()=>{closeCommandPalette();showNetlifyCliRef();}});
  }
  if(ql && (ql==='weekly pattern' || ql==='day of week' || ql==='productive day' || ql==='weekly chart')){
    items.unshift({title:'Weekly Pattern',desc:'Task completion by day of week',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWeeklyPattern();}});
  }
  if(ql && (ql==='csv to table' || ql==='csv' || ql==='csv viewer' || ql==='csv render')){
    items.unshift({title:'CSV to Table',desc:'Render CSV data as a formatted table',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickCsvToTable();}});
  }
  if(ql && (ql==='supabase' || ql==='supabase cli' || ql==='supabase commands' || ql==='supabase ref')){
    items.unshift({title:'Supabase CLI Reference',desc:'Supabase CLI cheatsheet by category',icon:'S',type:'action',action:()=>{closeCommandPalette();showSupabaseCliRef();}});
  }
  if(ql && (ql==='sla report' || ql==='sla' || ql==='on time' || ql==='delivery rate')){
    items.unshift({title:'SLA Report',desc:'On-time task delivery rate gauge',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskSlaReport();}});
  }
  if(ql && (ql==='regex tester' || ql==='regex' || ql==='regexp' || ql==='regular expression')){
    items.unshift({title:'Regex Tester',desc:'Test regular expressions with live matches',icon:'R',type:'action',action:()=>{closeCommandPalette();showQuickRegexTester();}});
  }
  if(ql && (ql==='railway' || ql==='railway cli' || ql==='railway commands' || ql==='railway ref')){
    items.unshift({title:'Railway CLI Reference',desc:'Railway CLI cheatsheet by category',icon:'R',type:'action',action:()=>{closeCommandPalette();showRailwayCliRef();}});
  }
  if(ql && (ql==='streak' || ql==='completion streak' || ql==='task streak' || ql==='daily streak')){
    items.unshift({title:'Completion Streak',desc:'Task completion streak and active days',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskCompletionStreak();}});
  }
  if(ql && (ql==='qr code' || ql==='qr' || ql==='qr generator' || ql==='generate qr')){
    items.unshift({title:'QR Code Generator',desc:'Generate QR codes from text or URLs',icon:'Q',type:'action',action:()=>{closeCommandPalette();showQuickQrGen();}});
  }
  if(ql && (ql==='claude code' || ql==='claude cli' || ql==='claude ref' || ql==='claude reference')){
    items.unshift({title:'Claude Code Reference',desc:'Claude Code CLI commands and tips',icon:'C',type:'action',action:()=>{closeCommandPalette();showClaudeCodeRef();}});
  }
  if(ql && (ql==='status overview' || ql==='status chart' || ql==='status bar' || ql==='status breakdown')){
    items.unshift({title:'Status Overview',desc:'Task distribution by status',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskStatusTimeline();}});
  }
  if(ql && (ql==='hash' || ql==='sha' || ql==='hash generator' || ql==='sha256')){
    items.unshift({title:'Hash Generator',desc:'Generate SHA-1/256/384/512 hashes',icon:'H',type:'action',action:()=>{closeCommandPalette();showQuickHashGenerator();}});
  }
  if(ql && (ql==='pip' || ql==='pip commands' || ql==='python pip' || ql==='pip ref')){
    items.unshift({title:'Python/pip Reference',desc:'pip and poetry cheatsheet',icon:'P',type:'action',action:()=>{closeCommandPalette();showPythonPipRef();}});
  }
  if(ql && (ql==='daily goal' || ql==='daily target' || ql==='task goal' || ql==='goal tracker')){
    items.unshift({title:'Daily Goal',desc:'Daily task completion goal with gauge',icon:'G',type:'action',action:()=>{closeCommandPalette();showTaskDailyGoal();}});
  }
  if(ql && (ql==='uuid' || ql==='uuid generator' || ql==='generate uuid' || ql==='guid')){
    items.unshift({title:'UUID Generator',desc:'Generate and copy UUIDs',icon:'U',type:'action',action:()=>{closeCommandPalette();showQuickUuidGenerator();}});
  }
  if(ql && (ql==='cargo' || ql==='rust' || ql==='cargo commands' || ql==='cargo ref')){
    items.unshift({title:'Cargo/Rust Reference',desc:'Cargo and Rust CLI cheatsheet',icon:'R',type:'action',action:()=>{closeCommandPalette();showCargoRef();}});
  }
  if(ql && (ql==='weekly report' || ql==='week report' || ql==='week summary' || ql==='this week')){
    items.unshift({title:'Weekly Report',desc:'This week task summary with stats',icon:'W',type:'action',action:()=>{closeCommandPalette();showTaskWeeklyReport();}});
  }
  if(ql && (ql==='cron builder' || ql==='cron' || ql==='crontab' || ql==='cron expression')){
    items.unshift({title:'Cron Builder',desc:'Build cron expressions with presets',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCronBuilder();}});
  }
  if(ql && (ql==='go' || ql==='golang' || ql==='go commands' || ql==='go ref')){
    items.unshift({title:'Go Reference',desc:'Go CLI cheatsheet by category',icon:'G',type:'action',action:()=>{closeCommandPalette();showGoModRef();}});
  }
  if(ql && (ql==='archive stats' || ql==='archive' || ql==='archived tasks' || ql==='archive count')){
    items.unshift({title:'Archive Stats',desc:'Archive and active task statistics',icon:'A',type:'action',action:()=>{closeCommandPalette();showTaskArchiveStats();}});
  }
  if(ql && (ql==='markdown table' || ql==='md table' || ql==='table generator' || ql==='generate table')){
    items.unshift({title:'Markdown Table Generator',desc:'Generate markdown tables quickly',icon:'T',type:'action',action:()=>{closeCommandPalette();showQuickMarkdownTable();}});
  }
  if(ql && (ql==='composer' || ql==='php' || ql==='composer commands' || ql==='composer ref')){
    items.unshift({title:'Composer/PHP Reference',desc:'Composer, Bundler, Rails cheatsheet',icon:'P',type:'action',action:()=>{closeCommandPalette();showComposerRef();}});
  }
  if(ql && (ql==='milestones' || ql==='achievements' || ql==='task milestones' || ql==='badges')){
    items.unshift({title:'Milestones',desc:'Task completion milestone progress',icon:'M',type:'action',action:()=>{closeCommandPalette();showTaskMilestones();}});
  }
  if(ql && (ql==='placeholder image' || ql==='placeholder' || ql==='placeholder img' || ql==='dummy image')){
    items.unshift({title:'Placeholder Image',desc:'Generate placeholder image URLs',icon:'I',type:'action',action:()=>{closeCommandPalette();showQuickPlaceholderImage();}});
  }
  if(ql && (ql==='ruby' || ql==='rails' || ql==='ruby commands' || ql==='gem')){
    items.unshift({title:'Ruby/Rails Reference',desc:'Ruby, Gem, Rails cheatsheet',icon:'R',type:'action',action:()=>{closeCommandPalette();showRubyGemsRef();}});
  }
  if(ql && (ql==='focus score' || ql==='focus' || ql==='productivity score' || ql==='focus gauge')){
    items.unshift({title:'Focus Score',desc:'Personal focus and workload score',icon:'F',type:'action',action:()=>{closeCommandPalette();showTaskFocusScore();}});
  }
  if(ql && (ql==='slug' || ql==='slugify' || ql==='url slug' || ql==='camelcase')){
    items.unshift({title:'Slug Generator',desc:'Generate URL slugs and camelCase',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickSlugGenerator();}});
  }
  if(ql && (ql==='gradle' || ql==='gradle commands' || ql==='gradle ref' || ql==='gradlew')){
    items.unshift({title:'Gradle Reference',desc:'Gradle build tool cheatsheet',icon:'G',type:'action',action:()=>{closeCommandPalette();showGradleRef();}});
  }
  if(ql && (ql==='scope creep' || ql==='scope' || ql==='creep analysis' || ql==='project scope')){
    items.unshift({title:'Scope Creep Analysis',desc:'How much scope was added per project',icon:'S',type:'action',action:()=>{closeCommandPalette();showTaskScopeCreep();}});
  }
  if(ql && (ql==='aspect ratio' || ql==='ratio' || ql==='aspect' || ql==='resolution')){
    items.unshift({title:'Aspect Ratio',desc:'Calculate aspect ratios and resolutions',icon:'A',type:'action',action:()=>{closeCommandPalette();showQuickAspectRatio();}});
  }
  if(ql && (ql==='maven' || ql==='mvn' || ql==='maven commands' || ql==='maven ref')){
    items.unshift({title:'Maven Reference',desc:'Maven lifecycle and commands cheatsheet',icon:'M',type:'action',action:()=>{closeCommandPalette();showMavenRef();}});
  }
  if(ql && (ql==='tag breakdown' || ql==='tags' || ql==='tag stats' || ql==='tag usage')){
    items.unshift({title:'Tag Breakdown',desc:'Content tag usage distribution',icon:'T',type:'action',action:()=>{closeCommandPalette();showTaskTagBreakdown();}});
  }
  if(ql && (ql==='shadow' || ql==='box shadow' || ql==='shadow generator' || ql==='css shadow')){
    items.unshift({title:'Shadow Generator',desc:'CSS box-shadow presets with preview',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickShadowGenerator();}});
  }
  if(ql && (ql==='nuget' || ql==='dotnet' || ql==='.net' || ql==='nuget ref')){
    items.unshift({title:'.NET/NuGet Reference',desc:'dotnet CLI and NuGet cheatsheet',icon:'N',type:'action',action:()=>{closeCommandPalette();showNugetRef();}});
  }
  if(ql && (ql==='productivity' || ql==='productivity index' || ql==='output ratio' || ql==='done ratio')){
    items.unshift({title:'Productivity Index',desc:'Done/created ratio by time period',icon:'P',type:'action',action:()=>{closeCommandPalette();showTaskProductivityIndex();}});
  }
  if(ql && (ql==='gradient' || ql==='css gradient' || ql==='gradient generator' || ql==='linear gradient')){
    items.unshift({title:'Gradient Generator',desc:'CSS gradient presets with preview',icon:'G',type:'action',action:()=>{closeCommandPalette();showQuickGradientGenerator();}});
  }
  if(ql && (ql==='helm' || ql==='helm commands' || ql==='helm chart' || ql==='helm ref')){
    items.unshift({title:'Helm Reference',desc:'Helm chart management cheatsheet',icon:'H',type:'action',action:()=>{closeCommandPalette();showHelmRef();}});
  }
  if(ql && (ql==='health dashboard' || ql==='health' || ql==='system health' || ql==='dashboard health')){
    items.unshift({title:'Health Dashboard',desc:'System-wide health metrics',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskHealthDashboard();}});
  }
  if(ql && (ql==='font pairing' || ql==='fonts' || ql==='font pair' || ql==='typography')){
    items.unshift({title:'Font Pairings',desc:'Curated font pairing suggestions',icon:'F',type:'action',action:()=>{closeCommandPalette();showQuickFontPairing();}});
  }
  if(ql && (ql==='kubectl' || ql==='kubernetes' || ql==='k8s' || ql==='kubectl ref')){
    items.unshift({title:'kubectl Reference',desc:'kubectl commands cheatsheet',icon:'K',type:'action',action:()=>{closeCommandPalette();showKubectlRef();}});
  }
  if(ql && (ql==='net flow' || ql==='task flow' || ql==='inflow outflow chart' || ql==='backlog flow')){
    items.unshift({title:'Net Flow',desc:'Weekly task creation vs completion flow',icon:'N',type:'action',action:()=>{closeCommandPalette();showTaskNetFlow();}});
  }
  if(ql && (ql==='border radius' || ql==='border' || ql==='rounded corners' || ql==='css radius')){
    items.unshift({title:'Border Radius',desc:'CSS border-radius presets with preview',icon:'B',type:'action',action:()=>{closeCommandPalette();showQuickBorderRadius();}});
  }
  if(ql && (ql==='ansible' || ql==='ansible commands' || ql==='ansible playbook' || ql==='ansible ref')){
    items.unshift({title:'Ansible Reference',desc:'Ansible playbook and ad-hoc cheatsheet',icon:'A',type:'action',action:()=>{closeCommandPalette();showAnsibleRef();}});
  }
  if(ql && (ql==='abandoned' || ql==='abandoned tasks' || ql==='stale report' || ql==='forgotten tasks')){
    items.unshift({title:'Abandoned Tasks',desc:'Tasks untouched for 14+ days',icon:'A',type:'action',action:()=>{closeCommandPalette();showTaskAbandonedReport();}});
  }
  if(ql && (ql==='flexbox' || ql==='flex' || ql==='css flex' || ql==='flex helper')){
    items.unshift({title:'Flexbox Helper',desc:'Common flexbox layout patterns',icon:'F',type:'action',action:()=>{closeCommandPalette();showQuickFlexboxHelper();}});
  }
  if(ql && (ql==='nginx' || ql==='nginx config' || ql==='nginx commands' || ql==='nginx ref')){
    items.unshift({title:'nginx Reference',desc:'nginx config and management cheatsheet',icon:'N',type:'action',action:()=>{closeCommandPalette();showNginxRef();}});
  }
  if(ql && (ql==='estimate accuracy' || ql==='estimation' || ql==='accuracy' || ql==='time estimate')){
    items.unshift({title:'Estimate Accuracy',desc:'How accurate are your time estimates',icon:'E',type:'action',action:()=>{closeCommandPalette();showTaskEstimateAccuracy2();}});
  }
  if(ql && (ql==='css grid' || ql==='grid' || ql==='grid helper' || ql==='grid layout')){
    items.unshift({title:'CSS Grid Helper',desc:'Common CSS grid layout patterns',icon:'G',type:'action',action:()=>{closeCommandPalette();showQuickGridHelper();}});
  }
  if(ql && (ql==='terraform' || ql==='terraform cli' || ql==='tf' || ql==='iac')){
    items.unshift({title:'Terraform Reference',desc:'Terraform CLI and IaC cheatsheet',icon:'T',type:'action',action:()=>{closeCommandPalette();showTerraformRef();}});
  }
  if(ql && (ql==='day heatmap' || ql==='day of week' || ql==='weekly heatmap' || ql==='dow')){
    items.unshift({title:'Day-of-Week Heatmap',desc:'Tasks by day of week',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskDayOfWeekHeatmap();}});
  }
  if(ql && (ql==='lorem ipsum' || ql==='lorem' || ql==='placeholder text' || ql==='ipsum')){
    items.unshift({title:'Lorem Ipsum Generator',desc:'Generate placeholder text',icon:'L',type:'action',action:()=>{closeCommandPalette();showQuickLoremGenerator();}});
  }
  if(ql && (ql==='pulumi' || ql==='pulumi cli' || ql==='pulumi ref' || ql==='iac pulumi')){
    items.unshift({title:'Pulumi Reference',desc:'Pulumi IaC CLI cheatsheet',icon:'P',type:'action',action:()=>{closeCommandPalette();showPulumiRef();}});
  }
  if(ql && (ql==='creation hour' || ql==='hour chart' || ql==='task hour' || ql==='when create')){
    items.unshift({title:'Task Creation by Hour',desc:'When do you create tasks',icon:'H',type:'action',action:()=>{closeCommandPalette();showTaskCreationHourChart();}});
  }
  if(ql && (ql==='password' || ql==='password gen' || ql==='pw gen' || ql==='generate password')){
    items.unshift({title:'Password Generator',desc:'Generate secure random passwords',icon:'P',type:'action',action:()=>{closeCommandPalette();showQuickPasswordGenerator();}});
  }
  if(ql && (ql==='vagrant' || ql==='vagrant cli' || ql==='vagrant ref' || ql==='vm vagrant')){
    items.unshift({title:'Vagrant Reference',desc:'Vagrant VM management cheatsheet',icon:'V',type:'action',action:()=>{closeCommandPalette();showVagrantRef();}});
  }
  if(ql && (ql==='completion rate' || ql==='weekly rate' || ql==='done rate' || ql==='task rate')){
    items.unshift({title:'Weekly Completion Rate',desc:'Created vs completed per week',icon:'R',type:'action',action:()=>{closeCommandPalette();showTaskCompletionRate();}});
  }
  if(ql && (ql==='countdown' || ql==='countdown timer' || ql==='timer countdown' || ql==='count down')){
    items.unshift({title:'Countdown Timer',desc:'Quick countdown timer widget',icon:'C',type:'action',action:()=>{closeCommandPalette();showQuickCountdownTimer();}});
  }
  if(ql && (ql==='packer' || ql==='packer cli' || ql==='packer ref' || ql==='hashicorp packer')){
    items.unshift({title:'Packer Reference',desc:'Packer image builder cheatsheet',icon:'P',type:'action',action:()=>{closeCommandPalette();showPackerRef();}});
  }
  if(ql && (ql==='overdue history' || ql==='overdue' || ql==='late tasks' || ql==='overdue report')){
    items.unshift({title:'Overdue History',desc:'Overdue and late-completed tasks',icon:'O',type:'action',action:()=>{closeCommandPalette();showTaskOverdueHistory();}});
  }
  if(ql && (ql==='stopwatch' || ql==='stop watch' || ql==='lap timer' || ql==='sw')){
    items.unshift({title:'Stopwatch',desc:'Stopwatch with lap times',icon:'S',type:'action',action:()=>{closeCommandPalette();showQuickStopwatch();}});
  }
  return items.slice(0, 20);
}
function importBookmarks(){
  const input=document.createElement('input');input.type='file';input.accept='.html,.htm';
  input.onchange=e=>{const f=e.target.files[0];if(!f)return;const reader=new FileReader();
    reader.onload=ev=>{
      const html=ev.target.result;const parser=new DOMParser();const doc=parser.parseFromString(html,'text/html');
      const links=doc.querySelectorAll('a[href]');let count=0;
      links.forEach(a=>{
        const url=a.href;const title=a.textContent.trim()||url;
        if(!url.startsWith('http'))return;
        if(S.links.some(l=>l.url===url))return;
        let category='imported';
        const parent=a.closest('dl');if(parent){const h3=parent.previousElementSibling;if(h3&&h3.tagName==='H3')category=h3.textContent.trim().toLowerCase().substring(0,30);}
        S.links.push({id:Date.now()+count,title:title.substring(0,120),url,category,desc:'',tags:['imported'],created:new Date().toISOString()});
        count++;
      });
      save();renderLinks();toast('Imported '+count+' bookmarks ('+links.length+' total, dupes skipped)');
    };reader.readAsText(f);
  };input.click();
}
function showActivityTimeline(){
  let panel=document.getElementById('timeline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  const events=[];
  S.tasks.forEach(t=>{if(t.created)events.push({date:t.created,type:'task',action:'created',title:t.title,icon:'T',color:'var(--accent-cyan)'});if(t.completedAt)events.push({date:t.completedAt,type:'task',action:'completed',title:t.title,icon:'T',color:'var(--green)'});});
  S.content.forEach(c=>{if(c.created)events.push({date:c.created,type:'content',action:'added',title:(c.body||'').substring(0,60),icon:'C',color:'var(--yellow)'});});
  S.docs.forEach(d=>{if(d.created)events.push({date:d.created,type:'doc',action:'created',title:d.title,icon:'D',color:'var(--accent)'});if(d.updated&&d.updated!==d.created)events.push({date:d.updated,type:'doc',action:'updated',title:d.title,icon:'D',color:'var(--accent)'});});
  S.links.forEach(l=>{if(l.created)events.push({date:l.created,type:'link',action:'saved',title:l.title||l.url,icon:'L',color:'#a78bfa'});});
  (S.focusSessions||[]).forEach(f=>{events.push({date:f.date+'T12:00:00',type:'focus',action:f.minutes+'min session',title:f.task||'Focus',icon:'F',color:'var(--orange)'});});
  events.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const recent=events.slice(0,50);
  let lastDay='';
  const html=recent.map(e=>{
    const ds=(e.date||'').split('T')[0];
    let dayHeader='';
    if(ds!==lastDay){dayHeader=`<div style="padding:8px 0 4px;font-size:10px;font-weight:600;color:var(--accent);font-family:var(--mono);border-bottom:1px solid var(--border);margin-top:8px">${ds}</div>`;lastDay=ds;}
    const time=e.date.includes('T')?new Date(e.date).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}):'';
    return dayHeader+`<div style="display:flex;gap:8px;padding:4px 0;align-items:flex-start"><span style="min-width:14px;height:14px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:${e.color};background:${e.color}15;border-radius:3px;font-family:var(--mono)">${e.icon}</span><div style="flex:1;font-size:10px"><span style="color:var(--text-muted)">${e.action}</span> <span style="color:var(--text-primary)">${esc((e.title||'').substring(0,70))}</span></div><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono);white-space:nowrap">${time}</span></div>`;
  }).join('');
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Activity Timeline (${recent.length} events)</span><button onclick="document.getElementById('timeline-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${html||'<div style="padding:20px;text-align:center;color:var(--text-muted)">No activity yet</div>'}`;
  document.body.appendChild(panel);
}
function downloadBackup(){
  const data=JSON.stringify(S,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='saturno-hub-backup-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();URL.revokeObjectURL(url);
  S._lastBackup=new Date().toISOString();save();
  toast('Backup downloaded');
}
function toggleAutoBackup(){
  S._autoBackup=!S._autoBackup;save();
  if(S._autoBackup){scheduleAutoBackup();toast('Auto-backup enabled (every 4 hours)');}
  else{if(window._autoBackupTimer)clearInterval(window._autoBackupTimer);toast('Auto-backup disabled');}
}
function scheduleAutoBackup(){
  if(window._autoBackupTimer)clearInterval(window._autoBackupTimer);
  if(!S._autoBackup)return;
  window._autoBackupTimer=setInterval(function(){
    const lastB=S._lastBackup?new Date(S._lastBackup).getTime():0;
    if(Date.now()-lastB>=4*60*60*1000){downloadBackup();}
  },30*60*1000);
}
function importBackup(){
  const input=document.createElement('input');input.type='file';input.accept='.json';
  input.onchange=e=>{const f=e.target.files[0];if(!f)return;
    const reader=new FileReader();reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.tasks&&!data.content&&!data.docs){toast('Invalid backup file');return;}
        if(!confirm('This will MERGE backup data with current data. Continue?\\n\\nBackup contains: '+(data.tasks||[]).length+' tasks, '+(data.content||[]).length+' content, '+(data.docs||[]).length+' docs, '+(data.links||[]).length+' links'))return;
        const existingIds=new Set(S.tasks.map(t=>t.id));
        (data.tasks||[]).forEach(t=>{if(!existingIds.has(t.id))S.tasks.push(t);});
        const existingContentIds=new Set(S.content.map(c=>c.id));
        (data.content||[]).forEach(c=>{if(!existingContentIds.has(c.id))S.content.push(c);});
        const existingDocIds=new Set(S.docs.map(d=>d.id));
        (data.docs||[]).forEach(d=>{if(!existingDocIds.has(d.id))S.docs.push(d);});
        const existingLinkIds=new Set(S.links.map(l=>l.id));
        (data.links||[]).forEach(l=>{if(!existingLinkIds.has(l.id))S.links.push(l);});
        if(data.focusSessions&&!S.focusSessions)S.focusSessions=data.focusSessions;
        if(data.goals&&!S.goals)S.goals=data.goals;
        save();renderAll();toast('Backup merged successfully');
      }catch(err){toast('Error parsing backup: '+err.message);}
    };reader.readAsText(f);
  };input.click();
}
function renderAll(){renderContent();renderTasks();renderCalendar();renderWriter();renderSpecs();renderLinks();}
function exportAllDocs(){
  if(!S.docs.length){toast('No writer documents');return;}
  let md='# Writer Documents Export\\n# '+new Date().toISOString().split('T')[0]+'\\n\\n';
  S.docs.forEach(d=>{md+='---\\n\\n## '+esc(d.title||'Untitled')+'\\n\\n';md+=(d.body||'').replace(/<[^>]+>/g,' ').replace(/\\s+/g,' ').trim()+'\\n\\n';});
  const blob=new Blob([md],{type:'text/markdown'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='all-docs-'+new Date().toISOString().split('T')[0]+'.md';
  a.click();toast('Exported '+S.docs.length+' documents');
}
function exportAllDocsIndividual(){
  if(!S.docs.length){toast('No writer documents');return;}
  S.docs.forEach((d,i)=>{
    const text=(d.body||'').replace(/<[^>]+>/g,' ').replace(/\\s+/g,' ').trim();
    const md='# '+(d.title||'Untitled')+'\\n\\n'+text;
    const blob=new Blob([md],{type:'text/markdown'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=(d.title||'doc-'+i).replace(/[^a-z0-9]/gi,'-').toLowerCase()+'.md';
    setTimeout(()=>{a.click();},i*200);
  });
  toast('Downloading '+S.docs.length+' files...');
}
function openDailyJournal(){
  const today=new Date().toISOString().split('T')[0];
  const label=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  let doc=S.docs.find(d=>d.title&&d.title.startsWith('Journal '+today));
  if(!doc){
    doc={id:Date.now(),title:'Journal '+today,body:'<h2>'+label+'</h2><p></p><h3>Priorities</h3><p></p><h3>Notes</h3><p></p><h3>Reflections</h3><p></p>',created:new Date().toISOString(),updated:new Date().toISOString(),tags:['journal']};
    S.docs.unshift(doc);save();
  }
  switchSection('writer',null);
  setTimeout(()=>{const sel=document.getElementById('writer-doc-select');if(sel){sel.value=doc.id;loadDoc(doc.id);}},100);
  toast('Journal: '+today);
}
function showJournalArchive(){
  const entries=S.docs.filter(d=>d.title&&d.title.startsWith('Journal ')).sort((a,b)=>(b.title||'').localeCompare(a.title||''));
  let panel=document.getElementById('journal-archive-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='journal-archive-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:60vh;overflow-y:auto';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Journal Archive (${entries.length})</span><button onclick="document.getElementById('journal-archive-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`+
    (entries.length?entries.map(d=>{const wc=(d.body||'').replace(/<[^>]+>/g,' ').trim().split(/\s+/).filter(x=>x.length).length;return`<div onclick="document.getElementById('journal-archive-panel').remove();switchSection('writer',null);setTimeout(()=>{const sel=document.getElementById('writer-doc-select');if(sel){sel.value=${d.id};loadDoc(${d.id});}},100)" style="padding:6px 8px;cursor:pointer;border-left:3px solid var(--accent);margin-bottom:4px;border-radius:0 4px 4px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><div style="font-size:11px;color:var(--text-primary)">${esc(d.title)}</div><div style="font-size:9px;color:var(--text-muted)">${wc} words</div></div>`;}).join(''):'<div style="padding:20px;text-align:center;color:var(--text-muted)">No journal entries yet. Type "journal" in Cmd+K to start.</div>');
  document.body.appendChild(panel);
}
function showWritingStats(){
  let panel=document.getElementById('writing-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writing-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const totalWords=S.docs.reduce((sum,d)=>{const text=(d.body||'').replace(/<[^>]+>/g,' ');return sum+text.trim().split(/\s+/).filter(x=>x.length).length;},0);
  const totalContent=S.content.reduce((sum,c)=>sum+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);
  const docsByDate={};
  S.docs.forEach(d=>{const ds=(d.updated||d.created||'').split('T')[0];if(ds){if(!docsByDate[ds])docsByDate[ds]=0;docsByDate[ds]++;}});
  // writing streak
  let streak=0;let checkDate=new Date();
  for(let i=0;i<365;i++){const ds=checkDate.toISOString().split('T')[0];if(docsByDate[ds]||S.content.some(c=>c.created&&c.created.startsWith(ds))){streak++;}else if(i>0)break;checkDate.setDate(checkDate.getDate()-1);}
  // daily word chart (last 7 days)
  const dailyWords=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];const wc=S.docs.filter(doc=>(doc.updated||doc.created||'').startsWith(ds)).reduce((sum,doc)=>{const text=(doc.body||'').replace(/<[^>]+>/g,' ');return sum+text.trim().split(/\s+/).filter(x=>x.length).length;},0)+S.content.filter(c=>c.created&&c.created.startsWith(ds)).reduce((sum,c)=>sum+(c.body||'').trim().split(/\s+/).filter(x=>x.length).length,0);dailyWords.push({date:ds,words:wc});}
  const maxW=Math.max(1,...dailyWords.map(d=>d.words));
  const bars=dailyWords.map(d=>`<div style="display:flex;flex-direction:column;align-items:center;gap:2px;flex:1"><div style="width:100%;height:60px;display:flex;align-items:flex-end"><div style="width:100%;height:${Math.max(2,d.words/maxW*60)}px;background:var(--accent);border-radius:2px 2px 0 0"></div></div><span style="font-size:7px;color:var(--text-muted)">${d.date.substring(8)}</span><span style="font-size:7px;color:var(--accent-cyan)">${d.words>0?d.words:''}</span></div>`).join('');
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Writing Stats</span><button onclick="document.getElementById('writing-stats-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px"><div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:18px;font-weight:700;color:var(--accent)">${totalWords.toLocaleString()}</div><div style="font-size:9px;color:var(--text-muted)">Doc Words</div></div><div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:18px;font-weight:700;color:var(--accent-cyan)">${totalContent.toLocaleString()}</div><div style="font-size:9px;color:var(--text-muted)">Content Words</div></div><div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:18px;font-weight:700;color:var(--green)">${streak}</div><div style="font-size:9px;color:var(--text-muted)">Day Streak</div></div></div><div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Last 7 Days</div><div style="display:flex;gap:4px">${bars}</div></div><div style="font-size:10px;color:var(--text-muted)">${S.docs.length} documents | ${S.content.length} content items | ${(totalWords+totalContent).toLocaleString()} total words</div>`;
  document.body.appendChild(panel);
}
function showDataCleanup(){
  let panel=document.getElementById('cleanup-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='cleanup-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  const issues=[];
  // Empty tasks
  const emptyTasks=S.tasks.filter(t=>!t.title||!t.title.trim());
  if(emptyTasks.length)issues.push({type:'warning',msg:emptyTasks.length+' tasks with empty titles',action:'Remove empty tasks',fn:()=>{S.tasks=S.tasks.filter(t=>t.title&&t.title.trim());save();renderTasks();showDataCleanup();toast('Removed '+emptyTasks.length+' empty tasks');}});
  // Empty content
  const emptyContent=S.content.filter(c=>!c.body||!c.body.trim());
  if(emptyContent.length)issues.push({type:'warning',msg:emptyContent.length+' content items with empty body',action:'Remove empty content',fn:()=>{S.content=S.content.filter(c=>c.body&&c.body.trim());save();renderContent();showDataCleanup();toast('Removed '+emptyContent.length+' empty content');}});
  // Duplicate content
  const seenBodies=new Set();const dupeContent=[];
  S.content.forEach(c=>{const key=(c.body||'').trim().substring(0,100);if(seenBodies.has(key))dupeContent.push(c);else seenBodies.add(key);});
  if(dupeContent.length)issues.push({type:'info',msg:dupeContent.length+' potential duplicate content items',action:'Remove duplicates (keep first)',fn:()=>{const seen=new Set();S.content=S.content.filter(c=>{const key=(c.body||'').trim().substring(0,100);if(seen.has(key))return false;seen.add(key);return true;});save();renderContent();showDataCleanup();toast('Removed '+dupeContent.length+' duplicates');}});
  // Duplicate links
  const seenUrls=new Set();const dupeLinks=[];
  S.links.forEach(l=>{if(seenUrls.has(l.url))dupeLinks.push(l);else seenUrls.add(l.url);});
  if(dupeLinks.length)issues.push({type:'info',msg:dupeLinks.length+' duplicate links (same URL)',action:'Remove duplicate links',fn:()=>{const seen=new Set();S.links=S.links.filter(l=>{if(seen.has(l.url))return false;seen.add(l.url);return true;});save();renderLinks();showDataCleanup();toast('Removed '+dupeLinks.length+' duplicate links');}});
  // Tasks without project
  const noProject=S.tasks.filter(t=>!t.project&&t.status!=='done');
  if(noProject.length>5)issues.push({type:'info',msg:noProject.length+' active tasks without a project'});
  // Old done tasks
  const oldDone=S.tasks.filter(t=>{if(t.status!=='done'||!t.completedAt)return false;return(Date.now()-new Date(t.completedAt).getTime())>30*86400000;});
  if(oldDone.length>10)issues.push({type:'info',msg:oldDone.length+' completed tasks older than 30 days',action:'Archive old completed tasks',fn:()=>{archiveCompletedTasks();}});
  // localStorage size
  const storageSize=JSON.stringify(S).length;
  issues.push({type:storageSize>4000000?'warning':'info',msg:'Storage: '+(storageSize/1024).toFixed(0)+'KB / 5MB ('+Math.round(storageSize/5000000*100)+'% used)'});
  const clr={warning:'var(--orange)',info:'var(--text-muted)',error:'var(--red)'};
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Data Cleanup</span><button onclick="document.getElementById('cleanup-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`+(issues.length?issues.map(i=>`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:4px;margin-bottom:4px;border-left:3px solid ${clr[i.type]}"><div style="flex:1;font-size:10px;color:var(--text-primary)">${esc(i.msg)}</div>${i.action?`<button onclick="document.getElementById('cleanup-panel').remove();(${i.fn.toString()})()" class="btn btn-sm btn-ghost" style="font-size:8px;white-space:nowrap">${i.action}</button>`:''}</div>`).join('')+'<div style="margin-top:12px;text-align:center;font-size:9px;color:var(--text-muted)">'+issues.length+' issues found</div>':'<div style="padding:20px;text-align:center;color:var(--accent)">No issues found. Data is clean.</div>');
  document.body.appendChild(panel);
}
function showProductivityReport(){
  let panel=document.getElementById('report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const monthStart=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const mTasks=S.tasks.filter(t=>t.created&&t.created>=monthStart);
  const mDone=S.tasks.filter(t=>t.completedAt&&t.completedAt>=monthStart);
  const mContent=S.content.filter(c=>c.created&&c.created>=monthStart);
  const mDocs=S.docs.filter(d=>(d.updated||d.created||'')>=monthStart);
  const mLinks=S.links.filter(l=>l.created&&l.created>=monthStart);
  const mFocus=(S.focusSessions||[]).filter(f=>f.date&&f.date>=monthStart);
  const focusMins=mFocus.reduce((a,f)=>a+(f.minutes||0),0);
  const totalWords=mDocs.reduce((s,d)=>(d.body||'').replace(/<[^>]+>/g,' ').trim().split(/\s+/).filter(x=>x.length).length+s,0);
  const contentWords=mContent.reduce((s,c)=>(c.body||'').trim().split(/\s+/).filter(x=>x.length).length+s,0);
  // project breakdown
  const byProject={};mDone.forEach(t=>{const p=t.project||'No Project';byProject[p]=(byProject[p]||0)+1;});
  const projectRows=Object.entries(byProject).sort((a,b)=>b[1]-a[1]).map(([p,c])=>`<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:10px"><span style="color:var(--text-primary)">${esc(p)}</span><span style="color:var(--accent);font-family:var(--mono)">${c} done</span></div>`).join('');
  // priority breakdown
  const byPriority={p0:0,p1:0,p2:0,p3:0};mDone.forEach(t=>byPriority[t.priority||'p2']++);
  const completionRate=mTasks.length?Math.round(mDone.length/mTasks.length*100):0;
  let md=`# Productivity Report: ${monthName}\n\n## Summary\n- Tasks created: ${mTasks.length}\n- Tasks completed: ${mDone.length} (${completionRate}% completion rate)\n- Content added: ${mContent.length} items (${contentWords.toLocaleString()} words)\n- Documents edited: ${mDocs.length} (${totalWords.toLocaleString()} words)\n- Links saved: ${mLinks.length}\n- Focus sessions: ${mFocus.length} (${formatTimeSpent(focusMins)})\n\n## By Project\n${Object.entries(byProject).map(([p,c])=>'- '+p+': '+c+' completed').join('\n')}\n\n## By Priority\n- P0: ${byPriority.p0} | P1: ${byPriority.p1} | P2: ${byPriority.p2} | P3: ${byPriority.p3}`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Productivity Report: ${monthName}</span><div style="display:flex;gap:6px"><button onclick="navigator.clipboard.writeText(\`${md.replace(/`/g,'\\`')}\`);toast('Copied as Markdown')" class="btn btn-sm btn-ghost" style="font-size:9px">Copy MD</button><button onclick="document.getElementById('report-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px"><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--accent)">${mDone.length}</div><div style="font-size:9px;color:var(--text-muted)">Completed</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--accent-cyan)">${(totalWords+contentWords).toLocaleString()}</div><div style="font-size:9px;color:var(--text-muted)">Words</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--green)">${formatTimeSpent(focusMins)}</div><div style="font-size:9px;color:var(--text-muted)">Focus Time</div></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px"><div><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">By Project</div>${projectRows||'<div style="font-size:9px;color:var(--text-muted)">No completions</div>'}</div><div><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">By Priority</div><div style="font-size:10px;display:flex;flex-direction:column;gap:2px"><span style="color:var(--red)">P0 Critical: ${byPriority.p0}</span><span style="color:var(--orange)">P1 High: ${byPriority.p1}</span><span style="color:var(--accent-cyan)">P2 Medium: ${byPriority.p2}</span><span style="color:var(--text-muted)">P3 Low: ${byPriority.p3}</span></div></div></div><div style="margin-bottom:12px;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:10px;font-weight:600;margin-bottom:4px;color:var(--text-primary)">Completion Rate</div><div style="width:100%;height:8px;background:var(--border);border-radius:4px"><div style="width:${completionRate}%;height:100%;background:${completionRate>=70?'var(--green)':completionRate>=40?'var(--yellow)':'var(--red)'};border-radius:4px;transition:width 0.3s"></div></div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">${completionRate}% (${mDone.length}/${mTasks.length})</div></div><div style="font-size:9px;color:var(--text-muted)">${mContent.length} content items | ${mLinks.length} links | ${mFocus.length} focus sessions</div>`;
  document.body.appendChild(panel);
}
function addStickyNote(){
  const colors=['#fef08a','#bbf7d0','#bfdbfe','#fecaca','#e9d5ff','#fed7aa'];
  const color=colors[Math.floor(Math.random()*colors.length)];
  if(!S._stickies)S._stickies=[];
  const id=Date.now();
  const x=100+Math.random()*200;const y=100+Math.random()*200;
  S._stickies.push({id,text:'',color,x,y});save();
  renderStickyNotes();
}
function renderStickyNotes(){
  document.querySelectorAll('.sticky-note-float').forEach(el=>el.remove());
  (S._stickies||[]).forEach(s=>{
    const el=document.createElement('div');el.className='sticky-note-float';el.dataset.id=s.id;
    el.style.cssText=`position:fixed;left:${s.x}px;top:${s.y}px;width:160px;min-height:100px;background:${s.color};border-radius:4px;padding:8px;z-index:900;box-shadow:0 4px 16px rgba(0,0,0,0.3);cursor:move;display:flex;flex-direction:column;font-family:var(--font)`;
    el.innerHTML=`<div style="display:flex;justify-content:flex-end;gap:4px;margin-bottom:4px"><button onclick="removeStickyNote(${s.id})" style="background:none;border:none;color:#666;cursor:pointer;font-size:12px;padding:0;line-height:1">&times;</button></div><textarea oninput="updateStickyNote(${s.id},this.value)" style="flex:1;background:transparent;border:none;color:#333;font-size:10px;resize:none;outline:none;font-family:inherit;line-height:1.4">${esc(s.text||'')}</textarea>`;
    let isDragging=false,offsetX,offsetY;
    el.addEventListener('mousedown',e=>{if(e.target.tagName==='TEXTAREA'||e.target.tagName==='BUTTON')return;isDragging=true;offsetX=e.clientX-el.offsetLeft;offsetY=e.clientY-el.offsetTop;e.preventDefault();});
    document.addEventListener('mousemove',e=>{if(!isDragging)return;el.style.left=(e.clientX-offsetX)+'px';el.style.top=(e.clientY-offsetY)+'px';});
    document.addEventListener('mouseup',()=>{if(isDragging){isDragging=false;const st=S._stickies.find(x=>x.id===s.id);if(st){st.x=parseInt(el.style.left);st.y=parseInt(el.style.top);save();}}});
    document.body.appendChild(el);
  });
}
function updateStickyNote(id,text){const s=(S._stickies||[]).find(x=>x.id===id);if(s){s.text=text;save();}}
function removeStickyNote(id){S._stickies=(S._stickies||[]).filter(x=>x.id!==id);save();const el=document.querySelector(`.sticky-note-float[data-id="${id}"]`);if(el)el.remove();}
function clearStickyNotes(){if(!S._stickies||!S._stickies.length){toast('No sticky notes');return;}S._stickies=[];save();document.querySelectorAll('.sticky-note-float').forEach(el=>el.remove());toast('Cleared');}
function showGanttChart(){
  let panel=document.getElementById('gantt-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='gantt-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=S.tasks.filter(t=>t.due&&t.status!=='done').sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  if(!tasks.length){panel.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-muted)">No active tasks with due dates</div><button onclick="this.parentElement.remove()" class="btn btn-sm btn-ghost" style="display:block;margin:0 auto">Close</button>';document.body.appendChild(panel);return;}
  const today=new Date();const todayStr=today.toISOString().split('T')[0];
  const minDate=new Date(Math.min(today.getTime(),...tasks.map(t=>new Date(t.due+'T12:00:00').getTime())));
  const maxDate=new Date(Math.max(today.getTime()+14*86400000,...tasks.map(t=>new Date(t.due+'T12:00:00').getTime()+86400000)));
  const totalDays=Math.max(7,Math.ceil((maxDate-minDate)/86400000));
  const w=Math.max(500,totalDays*20);const rowH=24;const h=tasks.length*rowH+40;const pad=120;
  let svg=`<svg width="${w+pad}" height="${h}" viewBox="0 0 ${w+pad} ${h}" style="font-family:var(--mono)">`;
  // grid
  for(let i=0;i<=totalDays;i+=7){const x=pad+i*(w/totalDays);const d=new Date(minDate);d.setDate(d.getDate()+i);svg+=`<line x1="${x}" y1="20" x2="${x}" y2="${h}" stroke="#222" stroke-width="0.5"/><text x="${x}" y="14" fill="#666" font-size="8">${d.toISOString().split('T')[0].substring(5)}</text>`;}
  // today line
  const todayX=pad+((today-minDate)/86400000)*(w/totalDays);svg+=`<line x1="${todayX}" y1="20" x2="${todayX}" y2="${h}" stroke="var(--accent)" stroke-width="1" stroke-dasharray="3,3"/>`;
  // bars
  tasks.forEach((t,i)=>{
    const dueDate=new Date(t.due+'T12:00:00');
    const created=t.created?new Date(t.created):new Date(dueDate.getTime()-7*86400000);
    const startX=pad+Math.max(0,(created-minDate)/86400000)*(w/totalDays);
    const endX=pad+((dueDate-minDate)/86400000)*(w/totalDays);
    const barW=Math.max(8,endX-startX);
    const y=22+i*rowH;
    const pClr=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
    const isOverdue=t.due<todayStr;
    svg+=`<text x="${pad-4}" y="${y+12}" fill="${isOverdue?'#ef4444':'#888'}" font-size="8" text-anchor="end">${esc((t.title||'').substring(0,16))}</text>`;
    svg+=`<rect x="${startX}" y="${y}" width="${barW}" height="${rowH-4}" fill="${pClr}" rx="3" opacity="${isOverdue?'0.6':'0.8'}"><title>${esc(t.title)}: ${t.due} (${t.priority||'p2'})</title></rect>`;
    svg+=`<text x="${startX+4}" y="${y+12}" fill="#fff" font-size="7" opacity="0.9">${t.due.substring(5)}</text>`;
  });
  svg+=`</svg>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Gantt Chart (${tasks.length} tasks)</span><button onclick="document.getElementById('gantt-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="overflow-x:auto">${svg}</div>`;
  document.body.appendChild(panel);
}
function findRelatedContent(keyword){
  const kw=keyword.toLowerCase();
  return S.content.map(c=>{const body=(c.body||'').toLowerCase();const tags=(c.tags||[]).join(' ').toLowerCase();const theme=(c.theme||'').toLowerCase();let score=0;if(body.includes(kw))score+=3;if(tags.includes(kw))score+=5;if(theme.includes(kw))score+=4;const words=kw.split(/\s+/);words.forEach(w=>{if(w.length>3&&body.includes(w))score++;});return{...c,score};}).filter(c=>c.score>0).sort((a,b)=>b.score-a.score).slice(0,10);
}
function showReadingList(){
  let panel=document.getElementById('reading-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='reading-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  const readLater=S.links.filter(l=>l.readLater);
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Reading List (${readLater.length})</span><button onclick="document.getElementById('reading-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`+(readLater.length?readLater.map(l=>`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;border-bottom:1px solid var(--border)"><div style="flex:1"><a href="${escA(l.url)}" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none" onclick="event.stopPropagation()">${esc(l.title||l.url)}</a><div style="font-size:9px;color:var(--text-muted)">${esc(l.category||'')}${l.created?' | '+timeAgo(l.created):''}</div></div><button onclick="markLinkRead(${l.id});document.getElementById('reading-panel').remove();showReadingList()" class="btn btn-sm btn-ghost" style="font-size:8px">Done</button></div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--text-muted)">No links in reading list. Pin links or mark as read-later.</div>');
  document.body.appendChild(panel);
}
function markLinkRead(id){const l=S.links.find(x=>x.id===id);if(l){l.readLater=false;save();toast('Marked as read');}}
function showHabitTracker(){
  if(!S._habits)S._habits=[];
  let panel=document.getElementById('habit-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='habit-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:75vh;overflow-y:auto';
  const today=new Date();const days=[];
  for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);days.push(d.toISOString().split('T')[0]);}
  const dayLabels=days.map(d=>{const dt=new Date(d+'T12:00:00');return dt.toLocaleDateString('en-US',{weekday:'short'}).substring(0,2);});
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Habit Tracker</span><div style="display:flex;gap:6px"><button onclick="addHabit()" class="btn btn-sm btn-ghost" style="font-size:9px">+ Habit</button><button onclick="document.getElementById('habit-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  // Header row
  h+=`<div style="display:grid;grid-template-columns:1fr repeat(7,32px) 40px;gap:2px;align-items:center;margin-bottom:4px"><div style="font-size:9px;color:var(--text-muted)">Habit</div>${dayLabels.map(d=>`<div style="font-size:8px;color:var(--text-muted);text-align:center">${d}</div>`).join('')}<div style="font-size:8px;color:var(--text-muted);text-align:center">Streak</div></div>`;
  S._habits.forEach((habit,hi)=>{
    if(!habit.checks)habit.checks={};
    let streak=0;const checkDate=new Date(today);
    for(let i=0;i<365;i++){const ds=checkDate.toISOString().split('T')[0];if(habit.checks[ds])streak++;else if(i>0)break;checkDate.setDate(checkDate.getDate()-1);}
    h+=`<div style="display:grid;grid-template-columns:1fr repeat(7,32px) 40px;gap:2px;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)"><div style="font-size:10px;color:var(--text-primary);display:flex;align-items:center;gap:4px"><span>${esc(habit.name)}</span><span onclick="removeHabit(${hi})" style="cursor:pointer;font-size:8px;color:var(--red);opacity:0.4" title="Remove">x</span></div>${days.map(d=>{const checked=habit.checks[d];return`<div onclick="toggleHabitDay(${hi},'${d}')" style="width:28px;height:28px;border-radius:4px;background:${checked?'var(--accent)':'var(--bg-surface)'};border:1px solid ${checked?'var(--accent)':'var(--border)'};cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s">${checked?'<span style="color:#fff;font-size:10px;font-weight:700">v</span>':''}</div>`;}).join('')}<div style="text-align:center;font-size:11px;font-weight:600;color:${streak>=7?'var(--accent)':streak>=3?'var(--accent-cyan)':'var(--text-muted)'}">${streak}d</div></div>`;
  });
  if(!S._habits.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No habits yet. Click "+ Habit" to add one.</div>';
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function addHabit(){if(!S._habits)S._habits=[];const name=prompt('Habit name:');if(!name||!name.trim())return;S._habits.push({name:name.trim(),checks:{}});save();showHabitTracker();}
function removeHabit(idx){if(!confirm('Remove this habit?'))return;S._habits.splice(idx,1);save();showHabitTracker();}
function toggleHabitDay(idx,day){if(!S._habits||!S._habits[idx])return;if(!S._habits[idx].checks)S._habits[idx].checks={};if(S._habits[idx].checks[day])delete S._habits[idx].checks[day];else S._habits[idx].checks[day]=true;save();showHabitTracker();}
function showTaskTable(){
  let panel=document.getElementById('task-table-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-table-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:80vh;overflow:auto';
  const tasks=S.tasks.filter(t=>t.status!=='done').sort((a,b)=>{const pMap={p0:0,p1:1,p2:2,p3:3};return(pMap[a.priority]||2)-(pMap[b.priority]||2);});
  const pClr={p0:'var(--red)',p1:'var(--orange)',p2:'var(--accent-cyan)',p3:'var(--text-muted)'};
  const sClr={todo:'#3b82f6',progress:'#f59e0b',blocked:'#ef4444'};
  const today=new Date().toISOString().split('T')[0];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Table (${tasks.length} active)</span><button onclick="document.getElementById('task-table-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<table style="width:100%;border-collapse:collapse;font-size:10px"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:4px 6px;color:var(--text-muted);font-weight:600">Title</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:50px">Pri</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:60px">Status</th><th style="text-align:left;padding:4px;color:var(--text-muted);font-weight:600;width:80px">Project</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:70px">Due</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:50px">Est</th><th style="padding:4px;color:var(--text-muted);font-weight:600;width:50px">Time</th></tr></thead><tbody>`;
  tasks.forEach(t=>{
    const isOverdue=t.due&&t.due<today;
    h+=`<tr onclick="document.getElementById('task-table-panel').remove();openTaskDetail(${t.id})" style="border-bottom:1px solid var(--border);cursor:pointer" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><td style="padding:4px 6px;color:var(--text-primary);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'Untitled')}</td><td style="padding:4px;text-align:center;color:${pClr[t.priority]||pClr.p2};font-weight:600">${(t.priority||'p2').toUpperCase()}</td><td style="padding:4px;text-align:center;color:${sClr[t.status]||'#888'}">${t.status}</td><td style="padding:4px;font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.project||'')}</td><td style="padding:4px;text-align:center;font-family:var(--mono);font-size:9px;color:${isOverdue?'var(--red)':t.due===today?'var(--accent)':'var(--text-muted)'}">${t.due?t.due.substring(5):''}</td><td style="padding:4px;text-align:center;font-size:9px;color:var(--accent-cyan)">${t.estimate||''}</td><td style="padding:4px;text-align:center;font-size:9px;color:var(--text-muted)">${t.timeSpent?formatTimeSpent(t.timeSpent):''}</td></tr>`;
  });
  h+=`</tbody></table>`;
  if(!tasks.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted)">No active tasks</div>';
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function showProjectHealth(){
  let panel=document.getElementById('proj-health-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-health-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:75vh;overflow-y:auto';
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  const today=new Date().toISOString().split('T')[0];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Project Health Dashboard</span><button onclick="document.getElementById('proj-health-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  projects.forEach(p=>{
    const tasks=S.tasks.filter(t=>t.project===p);
    const active=tasks.filter(t=>t.status!=='done');
    const done=tasks.filter(t=>t.status==='done');
    const overdue=active.filter(t=>t.due&&t.due<today);
    const blocked=active.filter(t=>t.status==='blocked');
    const pct=tasks.length?Math.round(done.length/tasks.length*100):0;
    const velocity7d=done.filter(t=>t.completedAt&&(Date.now()-new Date(t.completedAt).getTime())<7*86400000).length;
    const healthScore=Math.min(100,Math.max(0,pct-overdue.length*10-blocked.length*5+velocity7d*5));
    const healthColor=healthScore>=70?'var(--green)':healthScore>=40?'var(--yellow)':'var(--red)';
    const healthLabel=healthScore>=70?'Healthy':healthScore>=40?'At Risk':'Critical';
    h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:8px;border-left:4px solid ${healthColor}"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:12px;font-weight:600;color:var(--text-primary)">${esc(p)}</span><span style="font-size:9px;padding:2px 6px;border-radius:10px;background:${healthColor}20;color:${healthColor}">${healthLabel} (${healthScore})</span></div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:6px"><div style="text-align:center"><div style="font-size:14px;font-weight:600;color:var(--accent)">${done.length}</div><div style="font-size:8px;color:var(--text-muted)">Done</div></div><div style="text-align:center"><div style="font-size:14px;font-weight:600;color:var(--accent-cyan)">${active.length}</div><div style="font-size:8px;color:var(--text-muted)">Active</div></div><div style="text-align:center"><div style="font-size:14px;font-weight:600;color:var(--red)">${overdue.length}</div><div style="font-size:8px;color:var(--text-muted)">Overdue</div></div><div style="text-align:center"><div style="font-size:14px;font-weight:600;color:var(--yellow)">${velocity7d}</div><div style="font-size:8px;color:var(--text-muted)">7d Vel.</div></div></div><div style="width:100%;height:6px;background:var(--border);border-radius:3px"><div style="width:${pct}%;height:100%;background:${healthColor};border-radius:3px"></div></div><div style="font-size:8px;color:var(--text-muted);margin-top:2px">${pct}% complete (${done.length}/${tasks.length})</div></div>`;
  });
  if(!projects.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted)">No projects with tasks</div>';
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function showRandomContent(){
  if(!S.content.length){toast('No content to show');return;}
  const c=S.content[Math.floor(Math.random()*S.content.length)];
  openContentModal(c.id);toast('Random item: '+(c.body||'').substring(0,40));
}
function showRandomTask(){
  const active=S.tasks.filter(t=>t.status!=='done');
  if(!active.length){toast('No active tasks');return;}
  const t=active[Math.floor(Math.random()*active.length)];
  openTaskDetail(t.id);toast('Random: '+t.title);
}
function saveToClips(){
  navigator.clipboard.readText().then(text=>{
    if(!text||!text.trim()){toast('Clipboard is empty');return;}
    if(!S._clips)S._clips=[];
    S._clips.unshift({text:text.trim(),saved:new Date().toISOString()});
    if(S._clips.length>50)S._clips.length=50;
    save();toast('Saved to clips');
  }).catch(()=>toast('Could not read clipboard (permission needed)'));
}
function showClipHistory(){
  if(!S._clips||!S._clips.length){toast('No clips saved. Use "clips" to save clipboard.');return;}
  let panel=document.getElementById('clips-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='clips-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Clipboard History (${S._clips.length})</span><div style="display:flex;gap:6px"><button onclick="S._clips=[];save();document.getElementById('clips-panel').remove();toast('Cleared')" class="btn btn-sm btn-ghost" style="font-size:8px">Clear All</button><button onclick="document.getElementById('clips-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`+
    S._clips.map((c,i)=>`<div style="padding:6px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:flex-start"><div style="flex:1;font-size:10px;color:var(--text-primary);word-break:break-word;white-space:pre-wrap;max-height:60px;overflow:hidden">${esc(c.text.substring(0,200))}</div><div style="display:flex;flex-direction:column;gap:2px;flex-shrink:0"><button onclick="navigator.clipboard.writeText(S._clips[${i}].text);toast('Copied')" class="btn btn-sm btn-ghost" style="font-size:8px;padding:1px 4px">Copy</button><span style="font-size:7px;color:var(--text-muted)">${timeAgo(c.saved)}</span></div></div>`).join('');
  document.body.appendChild(panel);
}
function createProjectFromTemplate(tmpl){
  const name=prompt('Project name:',tmpl.name);if(!name||!name.trim())return;
  const pName=name.trim();
  const now=new Date();
  tmpl.tasks.forEach((title,i)=>{
    const due=new Date(now);due.setDate(due.getDate()+i*2+1);
    S.tasks.unshift({id:Date.now()+i,title,description:'',subtasks:[],status:'todo',priority:i<2?'p1':'p2',project:pName,due:due.toISOString().split('T')[0],created:now.toISOString()});
  });
  save();renderTasks();toast('Created '+tmpl.tasks.length+' tasks for "'+pName+'"');
}
function startContentCompare(){
  const id1=prompt('Enter first content ID (from URL or card):');
  if(!id1)return;
  const id2=prompt('Enter second content ID to compare:');
  if(!id2)return;
  const c1=S.content.find(c=>c.id===parseInt(id1));
  const c2=S.content.find(c=>c.id===parseInt(id2));
  if(!c1||!c2){toast('Content not found. Use valid IDs.');return;}
  let panel=document.getElementById('compare-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:80vh;overflow-y:auto';
  const wc1=(c1.body||'').trim().split(/\s+/).filter(x=>x.length).length;
  const wc2=(c2.body||'').trim().split(/\s+/).filter(x=>x.length).length;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Content Compare</span><button onclick="document.getElementById('compare-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div style="background:var(--bg-surface);border-radius:var(--radius);padding:12px;overflow-y:auto;max-height:50vh"><div style="font-size:9px;color:var(--accent);margin-bottom:4px">Item A (${wc1} words) | ${c1.type||''} | ${timeAgo(c1.created||'')}</div><div style="font-size:10px;color:var(--text-primary);white-space:pre-wrap;line-height:1.5">${esc(c1.body||'')}</div></div><div style="background:var(--bg-surface);border-radius:var(--radius);padding:12px;overflow-y:auto;max-height:50vh"><div style="font-size:9px;color:var(--accent-cyan);margin-bottom:4px">Item B (${wc2} words) | ${c2.type||''} | ${timeAgo(c2.created||'')}</div><div style="font-size:10px;color:var(--text-primary);white-space:pre-wrap;line-height:1.5">${esc(c2.body||'')}</div></div></div><div style="margin-top:8px;font-size:9px;color:var(--text-muted)">Word count diff: ${Math.abs(wc1-wc2)} words | ${wc1>wc2?'A is longer':'B is longer'}</div>`;
  document.body.appendChild(panel);
}
function addTimeBlock(){
  const title=prompt('Time block label (e.g. "Deep work", "Meeting"):');if(!title||!title.trim())return;
  const date=prompt('Date (YYYY-MM-DD):',new Date().toISOString().split('T')[0]);if(!date)return;
  const start=prompt('Start time (e.g. "09:00"):','09:00');if(!start)return;
  const end=prompt('End time (e.g. "11:00"):','11:00');if(!end)return;
  if(!S._timeBlocks)S._timeBlocks=[];
  S._timeBlocks.push({id:Date.now(),title:title.trim(),date,start,end,color:'var(--accent)'});
  save();toast('Time block added: '+title.trim()+' on '+date);
}
function showTimeBlocks(){
  if(!S._timeBlocks||!S._timeBlocks.length){toast('No time blocks. Use "time block" to add one.');return;}
  let panel=document.getElementById('timeblock-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='timeblock-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:70vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const blocks=(S._timeBlocks||[]).sort((a,b)=>(a.date+a.start).localeCompare(b.date+b.start));
  const upcoming=blocks.filter(b=>b.date>=today);
  const past=blocks.filter(b=>b.date<today);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Time Blocks (${blocks.length})</span><div style="display:flex;gap:6px"><button onclick="addTimeBlock();document.getElementById('timeblock-panel').remove()" class="btn btn-sm btn-ghost" style="font-size:9px">+ Add</button><button onclick="document.getElementById('timeblock-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  if(upcoming.length){h+='<div style="font-size:9px;font-weight:600;color:var(--accent);margin-bottom:4px;text-transform:uppercase">Upcoming</div>';}
  upcoming.forEach(b=>{
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;border-left:3px solid var(--accent);margin-bottom:4px;border-radius:0 4px 4px 0"><div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(b.title)}</div><div style="font-size:9px;color:var(--text-muted)">${b.date} | ${b.start} - ${b.end}</div></div><button onclick="S._timeBlocks=S._timeBlocks.filter(x=>x.id!==${b.id});save();document.getElementById('timeblock-panel').remove();showTimeBlocks()" class="btn btn-sm btn-ghost" style="font-size:8px;color:var(--red)">x</button></div>`;
  });
  if(past.length){h+=`<div style="font-size:9px;font-weight:600;color:var(--text-muted);margin-top:8px;margin-bottom:4px;text-transform:uppercase">Past (${past.length})</div>`;
  past.slice(0,5).forEach(b=>{h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 8px;border-left:3px solid var(--border);margin-bottom:2px;opacity:0.5"><div style="flex:1;font-size:10px;color:var(--text-muted)">${esc(b.title)} - ${b.date} ${b.start}-${b.end}</div></div>`;});}
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function textTransform(type){
  navigator.clipboard.readText().then(text=>{
    if(!text){toast('Clipboard empty');return;}
    let result;
    if(type==='upper')result=text.toUpperCase();
    else if(type==='lower')result=text.toLowerCase();
    else if(type==='title')result=text.replace(/\w\S*/g,t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase());
    else if(type==='slug')result=text.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
    else result=text;
    navigator.clipboard.writeText(result);
    toast('Transformed and copied to clipboard: '+result.substring(0,40)+(result.length>40?'...':''));
  }).catch(()=>toast('Could not read clipboard'));
}
function archiveUrl(){
  const url=prompt('Enter URL to view on Wayback Machine:');
  if(!url||!url.trim())return;
  window.open('https://web.archive.org/web/'+url.trim(),'_blank');
  toast('Opened Wayback Machine');
}
function showHomeDashboard(){
  let panel=document.getElementById('dashboard-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='dashboard-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  const inProgress=S.tasks.filter(t=>t.status==='progress');
  const doneToday=S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(today));
  const recentContent=S.content.filter(c=>c.created&&c.created.startsWith(today));
  const recentDocs=S.docs.filter(d=>(d.updated||d.created||'').startsWith(today));
  const focusToday=(S.focusSessions||[]).filter(f=>f.date===today);
  const focusMins=focusToday.reduce((a,f)=>a+(f.minutes||0),0);
  const streak=(()=>{let s=0;const cd=new Date();for(let i=0;i<365;i++){const ds=cd.toISOString().split('T')[0];if(S.tasks.some(t=>(t.completedAt&&t.completedAt.startsWith(ds))||(t.created&&t.created.startsWith(ds)))||S.content.some(c=>c.created&&c.created.startsWith(ds)))s++;else if(i>0)break;cd.setDate(cd.getDate()-1);}return s;})();
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:15px;font-weight:700;color:var(--text-primary)">Good ${new Date().getHours()<12?'morning':new Date().getHours()<18?'afternoon':'evening'}.</span><button onclick="document.getElementById('dashboard-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  // Stats row
  h+=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px"><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:${overdue.length?'var(--red)':'var(--accent)'}">${todayTasks.length}</div><div style="font-size:8px;color:var(--text-muted)">Due Today</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--green)">${doneToday.length}</div><div style="font-size:8px;color:var(--text-muted)">Done Today</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--accent-cyan)">${focusMins?formatTimeSpent(focusMins):'0m'}</div><div style="font-size:8px;color:var(--text-muted)">Focus</div></div><div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:var(--radius)"><div style="font-size:20px;font-weight:700;color:var(--yellow)">${streak}</div><div style="font-size:8px;color:var(--text-muted)">Day Streak</div></div></div>`;
  // Overdue
  if(overdue.length){h+=`<div style="font-size:10px;font-weight:600;color:var(--red);margin-bottom:4px;text-transform:uppercase">Overdue (${overdue.length})</div>`;overdue.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('dashboard-panel').remove();openTaskDetail(${t.id})" style="font-size:10px;padding:3px 8px;cursor:pointer;border-left:2px solid var(--red);margin-bottom:2px;color:var(--text-primary)">${esc(t.title)} <span style="color:var(--text-muted);font-size:8px">${relativeDate(t.due)}</span></div>`;});}
  // Today
  if(todayTasks.length){h+=`<div style="font-size:10px;font-weight:600;color:var(--accent);margin-top:8px;margin-bottom:4px;text-transform:uppercase">Today (${todayTasks.length})</div>`;todayTasks.forEach(t=>{h+=`<div onclick="document.getElementById('dashboard-panel').remove();openTaskDetail(${t.id})" style="font-size:10px;padding:3px 8px;cursor:pointer;border-left:2px solid var(--accent);margin-bottom:2px;color:var(--text-primary)">${esc(t.title)} <span style="color:var(--text-muted);font-size:8px">${t.priority||'p2'}</span></div>`;});}
  // In progress
  if(inProgress.length){h+=`<div style="font-size:10px;font-weight:600;color:var(--yellow);margin-top:8px;margin-bottom:4px;text-transform:uppercase">In Progress (${inProgress.length})</div>`;inProgress.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('dashboard-panel').remove();openTaskDetail(${t.id})" style="font-size:10px;padding:3px 8px;cursor:pointer;border-left:2px solid var(--yellow);margin-bottom:2px;color:var(--text-primary)">${esc(t.title)}</div>`;});}
  // Quick actions
  h+=`<div style="display:flex;gap:6px;margin-top:16px;flex-wrap:wrap"><button onclick="document.getElementById('dashboard-panel').remove();openDailyJournal()" class="btn btn-sm btn-ghost" style="font-size:9px">Journal</button><button onclick="document.getElementById('dashboard-panel').remove();showHabitTracker()" class="btn btn-sm btn-ghost" style="font-size:9px">Habits</button><button onclick="document.getElementById('dashboard-panel').remove();showActivityTimeline()" class="btn btn-sm btn-ghost" style="font-size:9px">Timeline</button><button onclick="document.getElementById('dashboard-panel').remove();showBurndownChart()" class="btn btn-sm btn-ghost" style="font-size:9px">Burndown</button></div>`;
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function showSettings(){
  let panel=document.getElementById('settings-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='settings-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:75vh;overflow-y:auto';
  if(!S._settings)S._settings={};
  const s=S._settings;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Settings</span><button onclick="document.getElementById('settings-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>
  <div style="display:flex;flex-direction:column;gap:12px">
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Compact Content View</span><button onclick="contentCompact=!contentCompact;this.textContent=contentCompact?'ON':'OFF';this.style.color=contentCompact?'var(--accent)':'var(--text-muted)';renderContent()" class="btn btn-sm btn-ghost" style="font-size:9px;color:${typeof contentCompact!=='undefined'&&contentCompact?'var(--accent)':'var(--text-muted)'}">${typeof contentCompact!=='undefined'&&contentCompact?'ON':'OFF'}</button></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Auto-Backup</span><button onclick="toggleAutoBackup();this.textContent=S._autoBackup?'ON':'OFF';this.style.color=S._autoBackup?'var(--accent)':'var(--text-muted)'" class="btn btn-sm btn-ghost" style="font-size:9px;color:${S._autoBackup?'var(--accent)':'var(--text-muted)'}">${S._autoBackup?'ON':'OFF'}</button></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Desktop Notifications</span><button onclick="enableDesktopNotifications()" class="btn btn-sm btn-ghost" style="font-size:9px;color:${S._notificationsEnabled?'var(--accent)':'var(--text-muted)'}">${S._notificationsEnabled?'ON':'OFF'}</button></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Accent Color</span><div style="display:flex;gap:3px">${['#4ade80','#06b6d4','#8b5cf6','#3b82f6','#f59e0b','#ec4899','#ef4444','#eab308'].map(c=>`<div onclick="document.documentElement.style.setProperty('--accent','${c}');S._accentColor='${c}';save()" style="width:16px;height:16px;border-radius:50%;background:${c};cursor:pointer;border:2px solid ${S._accentColor===c?'white':'transparent'}"></div>`).join('')}</div></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Default Task View</span><select onchange="S._settings.defaultTaskView=this.value;save()" style="font-size:9px;padding:2px 6px;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-primary);border-radius:4px"><option value="list" ${(s.defaultTaskView||'list')==='list'?'selected':''}>List</option><option value="board" ${s.defaultTaskView==='board'?'selected':''}>Board</option><option value="eisenhower" ${s.defaultTaskView==='eisenhower'?'selected':''}>Eisenhower</option></select></div>
  <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-primary)">Default Calendar View</span><select onchange="S._settings.defaultCalView=this.value;save()" style="font-size:9px;padding:2px 6px;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-primary);border-radius:4px"><option value="month" ${(s.defaultCalView||'month')==='month'?'selected':''}>Month</option><option value="week" ${s.defaultCalView==='week'?'selected':''}>Week</option><option value="agenda" ${s.defaultCalView==='agenda'?'selected':''}>Agenda</option></select></div>
  <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px"><div style="font-size:9px;color:var(--text-muted)">Storage: ${(JSON.stringify(S).length/1024).toFixed(0)}KB / 5MB</div><div style="font-size:9px;color:var(--text-muted)">${S.tasks.length} tasks | ${S.content.length} content | ${S.docs.length} docs | ${S.links.length} links</div></div>
  </div>`;
  document.body.appendChild(panel);
}
function showImpactMatrix(){
  let panel=document.getElementById('impact-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='impact-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  // Classify: high impact = p0/p1, low impact = p2/p3
  // high effort = has estimate >1h or no estimate but has many subtasks, low effort = short estimate or few subtasks
  const classify=t=>{
    const highImpact=t.priority==='p0'||t.priority==='p1';
    const est=t.estimate||'';const stCount=(t.subtasks||[]).length;
    const highEffort=est.includes('h')&&parseInt(est)>=2||stCount>=4||(!est&&!stCount);
    return{impact:highImpact?'high':'low',effort:highEffort?'high':'low'};
  };
  const quads={hh:[],hl:[],lh:[],ll:[]};
  active.forEach(t=>{const c=classify(t);const key=(c.impact==='high'?'h':'l')+(c.effort==='high'?'h':'l');quads[key].push(t);});
  const quadInfo=[
    {key:'hl',name:'Quick Wins',desc:'High Impact, Low Effort',color:'var(--green)',emoji:''},
    {key:'hh',name:'Big Bets',desc:'High Impact, High Effort',color:'var(--accent-cyan)',emoji:''},
    {key:'ll',name:'Fill-Ins',desc:'Low Impact, Low Effort',color:'var(--text-muted)',emoji:''},
    {key:'lh',name:'Time Sinks',desc:'Low Impact, High Effort',color:'var(--orange)',emoji:''},
  ];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Impact-Effort Matrix</span><button onclick="document.getElementById('impact-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">`;
  quadInfo.forEach(qi=>{
    h+=`<div style="background:var(--bg-surface);border-radius:var(--radius);padding:10px;border-top:3px solid ${qi.color}"><div style="font-size:10px;font-weight:600;color:${qi.color};margin-bottom:2px">${qi.name} (${quads[qi.key].length})</div><div style="font-size:8px;color:var(--text-muted);margin-bottom:6px">${qi.desc}</div>`;
    quads[qi.key].slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('impact-panel').remove();openTaskDetail(${t.id})" style="font-size:9px;padding:3px 6px;cursor:pointer;border-left:2px solid ${qi.color};margin-bottom:2px;color:var(--text-primary)">${esc(t.title||'').substring(0,40)}</div>`;});
    if(quads[qi.key].length>5)h+=`<div style="font-size:8px;color:var(--text-muted);padding:2px 6px">+${quads[qi.key].length-5} more</div>`;
    h+=`</div>`;
  });
  h+=`</div><div style="margin-top:10px;font-size:8px;color:var(--text-muted)">Classification: Priority P0/P1 = High Impact. Estimate >= 2h or 4+ subtasks = High Effort.</div>`;
  panel.innerHTML=h;
  document.body.appendChild(panel);
}
function exportAllContent(){
  if(!S.content.length){toast('No content');return;}
  let md='# Content Export\\n# '+new Date().toISOString().split('T')[0]+'\\n# '+S.content.length+' items\\n\\n';
  const byTheme={};S.content.forEach(c=>{const t=c.theme||'Unthemed';if(!byTheme[t])byTheme[t]=[];byTheme[t].push(c);});
  Object.keys(byTheme).sort().forEach(theme=>{
    md+='---\\n\\n## '+theme+' ('+byTheme[theme].length+')\\n\\n';
    byTheme[theme].forEach(c=>{md+='### '+(c.type||'note')+' | '+(c.created?new Date(c.created).toLocaleDateString():'')+'\\n\\n'+c.body+'\\n\\n';});
  });
  const blob=new Blob([md],{type:'text/markdown'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='content-export-'+new Date().toISOString().split('T')[0]+'.md';
  a.click();toast('Exported '+S.content.length+' items');
}
function exportContentJSON(){
  const data=JSON.stringify(S.content,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='content-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();toast('Exported '+S.content.length+' items as JSON');
}
function showFocusStats(){
  let panel=document.getElementById('focus-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='focus-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const sessions=(S.focusSessions||[]).slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  const totalMin=sessions.reduce((s,x)=>s+(x.duration||0),0);
  const totalSessions=sessions.length;
  const today=new Date().toISOString().split('T')[0];
  const todaySessions=sessions.filter(s=>s.date===today);
  const todayMin=todaySessions.reduce((s,x)=>s+(x.duration||0),0);
  const thisWeek=new Date();thisWeek.setDate(thisWeek.getDate()-7);const weekStr=thisWeek.toISOString().split('T')[0];
  const weekSessions=sessions.filter(s=>s.date>=weekStr);
  const weekMin=weekSessions.reduce((s,x)=>s+(x.duration||0),0);
  const avgPerSession=totalSessions?Math.round(totalMin/totalSessions):0;
  let streak=0;const d=new Date();
  for(let i=0;i<365;i++){const ds=d.toISOString().split('T')[0];if(sessions.some(s=>s.date===ds)){streak++;}else if(i>0){break;}d.setDate(d.getDate()-1);}
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:20px;font-weight:700;color:var(--accent)">${Math.round(totalMin/60)}h ${totalMin%60}m</div><div style="font-size:9px;color:var(--text-muted)">Total Focus Time</div></div>`;
  h+=`<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:20px;font-weight:700;color:var(--accent)">${totalSessions}</div><div style="font-size:9px;color:var(--text-muted)">Total Sessions</div></div>`;
  h+=`<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:20px;font-weight:700;color:var(--accent)">${avgPerSession}m</div><div style="font-size:9px;color:var(--text-muted)">Avg per Session</div></div>`;
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:600;color:#f59e0b">${todayMin}m</div><div style="font-size:8px;color:var(--text-muted)">Today</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:600;color:#3b82f6">${weekMin}m</div><div style="font-size:8px;color:var(--text-muted)">This Week</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:600;color:#8b5cf6">${streak}d</div><div style="font-size:8px;color:var(--text-muted)">Streak</div></div>`;
  h+='</div>';
  const days=[];for(let i=6;i>=0;i--){const dd=new Date();dd.setDate(dd.getDate()-i);days.push(dd.toISOString().split('T')[0]);}
  const dayMins=days.map(d=>sessions.filter(s=>s.date===d).reduce((s,x)=>s+(x.duration||0),0));
  const maxMin=Math.max(...dayMins,1);
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Last 7 Days</div>';
  h+='<div style="display:flex;align-items:flex-end;gap:4px;height:80px;margin-bottom:16px">';
  days.forEach((d,i)=>{const pct=dayMins[i]/maxMin*100;h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px"><div style="width:100%;height:${Math.max(pct,3)}%;background:var(--accent);border-radius:3px 3px 0 0;min-height:2px"></div><span style="font-size:7px;color:var(--text-muted)">${d.substring(8)}</span></div>`;});
  h+='</div>';
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Recent Sessions</div>';
  sessions.slice(0,15).forEach(s=>{
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 6px;font-size:10px;border-left:2px solid var(--accent);margin:2px 0"><span style="color:var(--text-muted);font-family:var(--mono);min-width:65px">${s.date||'?'}</span><span style="color:var(--accent);min-width:30px">${s.duration||0}m</span><span style="color:var(--text-primary);flex:1">${esc(s.taskName||s.task||'Untitled')}</span></div>`;
  });
  if(!sessions.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No focus sessions yet. Start one from task detail!</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Focus Session Stats</span><button onclick="document.getElementById('focus-stats-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showEisenhowerMatrix(){
  let panel=document.getElementById('eisenhower-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='eisenhower-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  const today=new Date().toISOString().split('T')[0];
  const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+3);const soonStr=tomorrow.toISOString().split('T')[0];
  function isUrgent(t){return t.due&&t.due<=soonStr;}
  function isImportant(t){return t.priority==='p0'||t.priority==='p1';}
  const q1=active.filter(t=>isUrgent(t)&&isImportant(t));
  const q2=active.filter(t=>!isUrgent(t)&&isImportant(t));
  const q3=active.filter(t=>isUrgent(t)&&!isImportant(t));
  const q4=active.filter(t=>!isUrgent(t)&&!isImportant(t));
  function renderQ(tasks,label,color,advice){
    let h=`<div style="padding:4px 8px;font-size:10px;font-weight:600;color:${color};margin-bottom:4px">${label} (${tasks.length})</div>`;
    h+=`<div style="font-size:8px;color:var(--text-muted);padding:0 8px 6px;font-style:italic">${advice}</div>`;
    tasks.slice(0,8).forEach(t=>{
      const overdue=t.due&&t.due<today;
      h+=`<div onclick="document.getElementById('eisenhower-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;display:flex;align-items:center;gap:6px;border-left:2px solid ${color}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="flex:1">${esc(t.title||'Untitled')}</span>${t.due?`<span style="font-size:8px;font-family:var(--mono);color:${overdue?'var(--red)':'var(--text-muted)'}">${t.due.substring(5)}</span>`:''}<span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'}">${t.priority||'p2'}</span></div>`;
    });
    if(tasks.length>8)h+=`<div style="padding:3px 8px;font-size:8px;color:var(--text-muted)">+${tasks.length-8} more</div>`;
    if(!tasks.length)h+=`<div style="padding:8px;font-size:9px;color:var(--text-muted);text-align:center">None</div>`;
    return h;
  }
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Eisenhower Matrix</span><button onclick="document.getElementById('eisenhower-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="font-size:9px;color:var(--text-muted);margin-bottom:8px">Urgent = due within 3 days | Important = P0 or P1</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div style="background:var(--bg-surface);border-radius:8px;padding:8px;border:1px solid rgba(239,68,68,0.3)">${renderQ(q1,'DO FIRST','#ef4444','Urgent + Important: Do immediately')}</div><div style="background:var(--bg-surface);border-radius:8px;padding:8px;border:1px solid rgba(59,130,246,0.3)">${renderQ(q2,'SCHEDULE','#3b82f6','Important but not urgent: Plan ahead')}</div><div style="background:var(--bg-surface);border-radius:8px;padding:8px;border:1px solid rgba(245,158,11,0.3)">${renderQ(q3,'DELEGATE','#f59e0b','Urgent but not important: Batch or delegate')}</div><div style="background:var(--bg-surface);border-radius:8px;padding:8px;border:1px solid rgba(107,114,128,0.3)">${renderQ(q4,'ELIMINATE','#6b7280','Not urgent or important: Drop or defer')}</div></div>`;
  document.body.appendChild(panel);
}
function showContentCalendar(){
  let panel=document.getElementById('content-cal-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-cal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const byDate={};
  S.content.forEach(c=>{
    if(!c.createdAt)return;
    const d=c.createdAt.split('T')[0];
    if(!byDate[d])byDate[d]=[];
    byDate[d].push(c);
  });
  (S.docs||[]).forEach(d=>{
    const dt=(d.updatedAt||d.createdAt||'').split('T')[0];
    if(dt&&!byDate[dt])byDate[dt]=[];
    if(dt)byDate[dt].push({body:d.title||'Doc',type:'doc',theme:'writer'});
  });
  const todayStr=now.toISOString().split('T')[0];
  let h='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;margin-bottom:4px">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div style="text-align:center;font-size:9px;color:var(--text-muted);padding:4px 0;font-weight:600">${d}</div>`;});
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px">';
  for(let i=0;i<firstDay;i++){h+='<div style="padding:4px;min-height:60px;background:var(--bg-surface);border-radius:4px;opacity:0.3"></div>';}
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const items=byDate[ds]||[];
    const isToday=ds===todayStr;
    h+=`<div style="padding:3px;min-height:60px;background:var(--bg-surface);border-radius:4px;${isToday?'border:1px solid var(--accent);':''}"><div style="font-size:9px;font-weight:600;color:${isToday?'var(--accent)':'var(--text-muted)'};">${d}</div>`;
    items.slice(0,3).forEach(c=>{
      const typeColor=c.theme==='writer'?'var(--accent)':c.type==='idea'?'#f59e0b':c.type==='quote'?'#8b5cf6':c.type==='code'?'#06b6d4':'#3b82f6';
      h+=`<div style="font-size:7px;color:${typeColor};padding:1px 3px;background:${typeColor}15;border-radius:2px;margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc((c.body||'').substring(0,20))}</div>`;
    });
    if(items.length>3)h+=`<div style="font-size:7px;color:var(--text-muted);padding:1px 3px">+${items.length-3}</div>`;
    h+='</div>';
  }
  h+='</div>';
  const totalThisMonth=Object.keys(byDate).filter(d=>d.startsWith(`${year}-${String(month+1).padStart(2,'0')}`)).reduce((s,d)=>s+byDate[d].length,0);
  const activeDays=Object.keys(byDate).filter(d=>d.startsWith(`${year}-${String(month+1).padStart(2,'0')}`)).length;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Content Calendar - ${monthName}</span><button onclick="document.getElementById('content-cal-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;gap:12px;margin-bottom:12px;font-size:10px"><span style="color:var(--text-muted)">${totalThisMonth} items this month</span><span style="color:var(--text-muted)">${activeDays} active days</span></div>${h}`;
  document.body.appendChild(panel);
}
function showSnippetManager(){
  if(!S._snippets)S._snippets=[];
  let panel=document.getElementById('snippet-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='snippet-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="margin-bottom:12px"><input id="snip-name" placeholder="Snippet name..." style="width:48%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;margin-right:2%"><button onclick="addSnippet()" style="padding:6px 12px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:11px;font-weight:600;cursor:pointer">Add</button></div>';
  h+='<textarea id="snip-text" placeholder="Snippet text..." style="width:100%;height:60px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;font-family:var(--mono);resize:vertical;margin-bottom:12px;box-sizing:border-box"></textarea>';
  if(S._snippets.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Saved Snippets ('+S._snippets.length+')</div>';
    S._snippets.forEach((s,i)=>{
      h+=`<div style="padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px;border-left:2px solid var(--accent)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:10px;font-weight:600;color:var(--text-primary)">${esc(s.name)}</span><div style="display:flex;gap:4px"><button onclick="navigator.clipboard.writeText(S._snippets[${i}].text);toast('Copied!')" style="padding:2px 6px;background:var(--accent);border:none;border-radius:3px;color:#000;font-size:8px;cursor:pointer">Copy</button><button onclick="S._snippets.splice(${i},1);save();showSnippetManager()" style="padding:2px 6px;background:var(--red);border:none;border-radius:3px;color:#fff;font-size:8px;cursor:pointer">Del</button></div></div><div style="font-size:9px;color:var(--text-muted);font-family:var(--mono);white-space:pre-wrap;max-height:60px;overflow-y:auto">${esc(s.text.substring(0,200))}</div></div>`;
    });
  }else{
    h+='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:10px">No snippets yet. Add your first reusable text snippet above.</div>';
  }
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Snippet Manager</span><button onclick="document.getElementById('snippet-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function addSnippet(){
  const nameEl=document.getElementById('snip-name');const textEl=document.getElementById('snip-text');
  if(!nameEl||!textEl)return;
  const name=nameEl.value.trim();const text=textEl.value.trim();
  if(!name||!text){toast('Name and text required');return;}
  if(!S._snippets)S._snippets=[];
  S._snippets.unshift({name,text,createdAt:new Date().toISOString()});
  save();showSnippetManager();toast('Snippet saved');
}
function showTaskHeatmap(){
  let panel=document.getElementById('heatmap-full-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='heatmap-full-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:80vh;overflow-y:auto';
  const today=new Date();const days=[];
  for(let i=364;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);days.push(d.toISOString().split('T')[0]);}
  const activity={};
  S.tasks.forEach(t=>{
    if(t.createdAt){const d=t.createdAt.split('T')[0];activity[d]=(activity[d]||0)+1;}
    if(t.completedAt){const d=t.completedAt.split('T')[0];activity[d]=(activity[d]||0)+2;}
    if(t.status==='done'&&t.due){activity[t.due]=(activity[t.due]||0)+1;}
  });
  S.content.forEach(c=>{if(c.createdAt){const d=c.createdAt.split('T')[0];activity[d]=(activity[d]||0)+1;}});
  (S.focusSessions||[]).forEach(f=>{if(f.date){activity[f.date]=(activity[f.date]||0)+1;}});
  const maxAct=Math.max(...Object.values(activity),1);
  function getColor(count){
    if(!count)return'var(--bg-surface)';
    const intensity=count/maxAct;
    if(intensity>0.75)return'#22c55e';
    if(intensity>0.5)return'#16a34a';
    if(intensity>0.25)return'#15803d';
    return'#166534';
  }
  const weeks=Math.ceil(days.length/7);
  let h='<div style="display:flex;gap:1px;overflow-x:auto">';
  const startDow=new Date(days[0]).getDay();
  let dayIdx=0;
  for(let w=0;w<53;w++){
    h+='<div style="display:flex;flex-direction:column;gap:1px">';
    for(let d=0;d<7;d++){
      if(w===0&&d<startDow){h+='<div style="width:10px;height:10px"></div>';continue;}
      if(dayIdx>=days.length){h+='<div style="width:10px;height:10px"></div>';continue;}
      const ds=days[dayIdx];const count=activity[ds]||0;
      h+=`<div title="${ds}: ${count} activities" style="width:10px;height:10px;border-radius:2px;background:${getColor(count)}" onmouseenter="this.style.outline='1px solid var(--text-primary)'" onmouseleave="this.style.outline='none'"></div>`;
      dayIdx++;
    }
    h+='</div>';
  }
  h+='</div>';
  const monthLabels=[];let prevMonth='';
  days.forEach((d,i)=>{const m=d.substring(0,7);if(m!==prevMonth){monthLabels.push({idx:Math.floor(i/7),label:new Date(d).toLocaleDateString('en-US',{month:'short'})});prevMonth=m;}});
  let monthBar='<div style="display:flex;gap:1px;margin-bottom:4px;padding-left:0">';
  let lastIdx=-1;
  monthLabels.forEach(m=>{const gap=(m.idx-lastIdx-1)*11;if(gap>0)monthBar+=`<span style="width:${gap}px"></span>`;monthBar+=`<span style="font-size:8px;color:var(--text-muted)">${m.label}</span>`;lastIdx=m.idx;});
  monthBar+='</div>';
  const totalAct=Object.values(activity).reduce((s,v)=>s+v,0);
  const activeDays=Object.keys(activity).length;
  let streak=0;const dd=new Date();
  for(let i=0;i<365;i++){const ds=dd.toISOString().split('T')[0];if(activity[ds]){streak++;}else if(i>0){break;}dd.setDate(dd.getDate()-1);}
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Activity Heatmap (365 Days)</span><button onclick="document.getElementById('heatmap-full-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;gap:16px;margin-bottom:12px;font-size:10px"><span style="color:var(--text-muted)">${totalAct} total activities</span><span style="color:var(--text-muted)">${activeDays} active days</span><span style="color:var(--accent)">${streak}d streak</span></div>${monthBar}<div style="overflow-x:auto;padding:4px 0">${h}</div><div style="display:flex;align-items:center;gap:4px;margin-top:8px;font-size:8px;color:var(--text-muted)">Less <div style="width:10px;height:10px;border-radius:2px;background:var(--bg-surface)"></div><div style="width:10px;height:10px;border-radius:2px;background:#166534"></div><div style="width:10px;height:10px;border-radius:2px;background:#15803d"></div><div style="width:10px;height:10px;border-radius:2px;background:#16a34a"></div><div style="width:10px;height:10px;border-radius:2px;background:#22c55e"></div> More</div>`;
  document.body.appendChild(panel);
}
function showLinkDashboard(){
  let panel=document.getElementById('link-dash-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='link-dash-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const links=S.links||[];
  const total=links.length;
  const pinned=links.filter(l=>l.pinned).length;
  const readLater=links.filter(l=>l.readLater).length;
  const read=links.filter(l=>l.isRead).length;
  const cats={};links.forEach(l=>{const c=l.category||'Uncategorized';cats[c]=(cats[c]||0)+1;});
  const domains={};links.forEach(l=>{try{const u=new URL(l.url);domains[u.hostname]=(domains[u.hostname]||0)+1;}catch(e){}});
  const topDomains=Object.entries(domains).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const thisWeek=new Date();thisWeek.setDate(thisWeek.getDate()-7);const weekStr=thisWeek.toISOString().split('T')[0];
  const recentLinks=links.filter(l=>l.createdAt&&l.createdAt.split('T')[0]>=weekStr).length;
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:var(--accent)">${total}</div><div style="font-size:8px;color:var(--text-muted)">Total Links</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#f59e0b">${readLater}</div><div style="font-size:8px;color:var(--text-muted)">Read Later</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#22c55e">${recentLinks}</div><div style="font-size:8px;color:var(--text-muted)">This Week</div></div>`;
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">By Category</div>';
  Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([c,n])=>{
    const pct=Math.round(n/total*100);
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:9px"><span style="color:var(--text-primary);flex:1">${esc(c)}</span><span style="color:var(--accent)">${n}</span><div style="width:40px;height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px"></div></div></div>`;
  });
  h+='</div>';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Top Domains</div>';
  topDomains.forEach(([d,n])=>{
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:9px"><span style="color:var(--text-primary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(d)}</span><span style="color:var(--accent)">${n}</span></div>`;
  });
  h+='</div></div>';
  h+=`<div style="display:flex;gap:8px;font-size:9px;color:var(--text-muted)"><span>Pinned: ${pinned}</span><span>Read: ${read}</span></div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Link Dashboard</span><button onclick="document.getElementById('link-dash-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showTaskDependencyGraph(){
  let panel=document.getElementById('dep-graph-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='dep-graph-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  const blocked=active.filter(t=>t.blockedBy);
  const blockers=active.filter(t=>t.blocking&&t.blocking.length);
  const chains=[];
  blocked.forEach(t=>{
    const chain=[t];
    let current=t;let depth=0;
    while(current.blockedBy&&depth<10){
      const blocker=S.tasks.find(x=>x.id===current.blockedBy||x.title===current.blockedBy);
      if(blocker){chain.unshift(blocker);current=blocker;depth++;}else break;
    }
    if(chain.length>1)chains.push(chain);
  });
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:var(--accent)">${active.length}</div><div style="font-size:8px;color:var(--text-muted)">Active Tasks</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#ef4444">${blocked.length}</div><div style="font-size:8px;color:var(--text-muted)">Blocked</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#f59e0b">${chains.length}</div><div style="font-size:8px;color:var(--text-muted)">Dep Chains</div></div>`;
  h+='</div>';
  if(chains.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Dependency Chains</div>';
    chains.forEach((chain,ci)=>{
      h+=`<div style="margin-bottom:10px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
      chain.forEach((t,i)=>{
        const isLast=i===chain.length-1;
        const statusColor=t.status==='in-progress'?'#3b82f6':t.status==='done'?'#22c55e':'var(--text-muted)';
        h+=`<div onclick="document.getElementById('dep-graph-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:3px 6px;cursor:pointer;border-left:2px solid ${statusColor}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="font-size:9px;color:${statusColor}">${t.status==='done'?'DONE':t.status==='in-progress'?'WIP':'TODO'}</span><span style="font-size:10px;color:var(--text-primary);flex:1">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'}">${t.priority||'p2'}</span></div>`;
        if(!isLast)h+=`<div style="padding-left:12px;font-size:8px;color:var(--text-muted)">blocks &#8595;</div>`;
      });
      h+='</div>';
    });
  }
  if(blocked.length&&!chains.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Blocked Tasks</div>';
    blocked.forEach(t=>{
      h+=`<div onclick="document.getElementById('dep-graph-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:4px 6px;cursor:pointer;border-left:2px solid #ef4444;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="font-size:10px;color:var(--text-primary);flex:1">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted)">blocked by: ${esc(String(t.blockedBy))}</span></div>`;
    });
  }
  if(!blocked.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No task dependencies found. Add blocked-by in task detail to create chains.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Dependency Graph</span><button onclick="document.getElementById('dep-graph-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showWeeklyReview(){
  let panel=document.getElementById('weekly-review-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='weekly-review-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
  const weekStr=weekAgo.toISOString().split('T')[0];const todayStr=now.toISOString().split('T')[0];
  const completed=S.tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.split('T')[0]>=weekStr);
  const created=S.tasks.filter(t=>t.createdAt&&t.createdAt.split('T')[0]>=weekStr);
  const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<todayStr);
  const inProgress=S.tasks.filter(t=>t.status==='in-progress');
  const contentCreated=S.content.filter(c=>c.createdAt&&c.createdAt.split('T')[0]>=weekStr);
  const docsEdited=(S.docs||[]).filter(d=>(d.updatedAt||'').split('T')[0]>=weekStr);
  const focusMin=(S.focusSessions||[]).filter(f=>f.date>=weekStr).reduce((s,x)=>s+(x.duration||0),0);
  const linksAdded=(S.links||[]).filter(l=>l.createdAt&&l.createdAt.split('T')[0]>=weekStr).length;
  const totalWords=contentCreated.reduce((s,c)=>s+((c.body||'').split(/\s+/).length),0);
  let md='# Weekly Review - '+todayStr+'\\n\\n';
  md+='## Stats\\n';
  md+=`- Completed: ${completed.length} tasks\\n`;
  md+=`- Created: ${created.length} tasks\\n`;
  md+=`- Overdue: ${overdue.length} tasks\\n`;
  md+=`- In Progress: ${inProgress.length} tasks\\n`;
  md+=`- Content Created: ${contentCreated.length} (${totalWords} words)\\n`;
  md+=`- Docs Edited: ${docsEdited.length}\\n`;
  md+=`- Focus Time: ${focusMin}min\\n`;
  md+=`- Links Added: ${linksAdded}\\n\\n`;
  md+='## Completed\\n';
  completed.forEach(t=>{md+=`- [x] ${t.title}${t.project?' ('+t.project+')':''}\\n`;});
  md+='\\n## In Progress\\n';
  inProgress.forEach(t=>{md+=`- [ ] ${t.title}${t.project?' ('+t.project+')':''}\\n`;});
  md+='\\n## Overdue\\n';
  overdue.forEach(t=>{md+=`- [ ] ${t.title} (due ${t.due})\\n`;});
  let h='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#22c55e">${completed.length}</div><div style="font-size:8px;color:var(--text-muted)">Completed</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#3b82f6">${created.length}</div><div style="font-size:8px;color:var(--text-muted)">Created</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${focusMin}m</div><div style="font-size:8px;color:var(--text-muted)">Focus</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#ef4444">${overdue.length}</div><div style="font-size:8px;color:var(--text-muted)">Overdue</div></div>`;
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">Completed This Week</div>';
  completed.slice(0,10).forEach(t=>{h+=`<div style="font-size:9px;color:var(--text-primary);padding:2px 0;border-left:2px solid #22c55e;padding-left:6px;margin:2px 0">${esc(t.title||'Untitled')}</div>`;});
  if(!completed.length)h+='<div style="font-size:9px;color:var(--text-muted)">No tasks completed</div>';
  h+='</div>';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">Still In Progress</div>';
  inProgress.slice(0,10).forEach(t=>{h+=`<div style="font-size:9px;color:var(--text-primary);padding:2px 0;border-left:2px solid #3b82f6;padding-left:6px;margin:2px 0">${esc(t.title||'Untitled')}</div>`;});
  if(!inProgress.length)h+='<div style="font-size:9px;color:var(--text-muted)">Nothing in progress</div>';
  h+='</div></div>';
  h+=`<div style="display:flex;gap:8px;font-size:9px;margin-bottom:8px"><span style="color:var(--text-muted)">Content: ${contentCreated.length} items (${totalWords} words)</span><span style="color:var(--text-muted)">Docs: ${docsEdited.length}</span><span style="color:var(--text-muted)">Links: ${linksAdded}</span></div>`;
  h+=`<button onclick="navigator.clipboard.writeText(\`${md.replace(/`/g,"'")}\`);toast('Review copied as markdown')" style="padding:6px 12px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer">Copy as Markdown</button>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Weekly Review</span><button onclick="document.getElementById('weekly-review-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showPomodoroHistory(){
  let panel=document.getElementById('pomo-hist-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='pomo-hist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const sessions=(S.focusSessions||[]).slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  const totalMin=sessions.reduce((s,x)=>s+(x.duration||0),0);
  const totalSessions=sessions.length;
  const byTask={};sessions.forEach(s=>{const n=s.taskName||s.task||'Untitled';if(!byTask[n])byTask[n]=0;byTask[n]+=(s.duration||0);});
  const topTasks=Object.entries(byTask).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const byDate={};sessions.forEach(s=>{if(!s.date)return;if(!byDate[s.date])byDate[s.date]=0;byDate[s.date]+=(s.duration||0);});
  const bestDay=Object.entries(byDate).sort((a,b)=>b[1]-a[1])[0];
  const avgPerDay=Object.keys(byDate).length?Math.round(totalMin/Object.keys(byDate).length):0;
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${totalSessions}</div><div style="font-size:8px;color:var(--text-muted)">Sessions</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${avgPerDay}m</div><div style="font-size:8px;color:var(--text-muted)">Avg/Day</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#22c55e">${bestDay?bestDay[1]+'m':'-'}</div><div style="font-size:8px;color:var(--text-muted)">Best Day${bestDay?' ('+bestDay[0].substring(5)+')':''}</div></div>`;
  h+='</div>';
  if(topTasks.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Most Focused Tasks</div>';
    topTasks.forEach(([name,mins])=>{
      const pct=Math.round(mins/totalMin*100);
      h+=`<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:9px"><span style="color:var(--text-primary);flex:1">${esc(name)}</span><span style="color:var(--accent)">${mins}m</span><div style="width:60px;height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px"></div></div></div>`;
    });
  }
  if(!sessions.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No Pomodoro sessions yet</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Pomodoro History</span><button onclick="document.getElementById('pomo-hist-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showTagCloud(){
  let panel=document.getElementById('tag-cloud-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='tag-cloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const tagCounts={};
  S.content.forEach(c=>{(c.tags||[]).forEach(t=>{tagCounts[t]=(tagCounts[t]||0)+1;});});
  S.tasks.forEach(t=>{(t.tags||[]).forEach(tg=>{tagCounts[tg]=(tagCounts[tg]||0)+1;});});
  const sorted=Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]);
  const maxCount=sorted.length?sorted[0][1]:1;
  const colors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316','#14b8a6','#a855f7'];
  let h='<div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:center;padding:12px">';
  sorted.forEach(([tag,count],i)=>{
    const scale=0.7+(count/maxCount)*1.3;
    const size=Math.round(9*scale);
    const color=colors[i%colors.length];
    h+=`<span onclick="document.getElementById('tag-cloud-panel').remove();switchSection('content');setTimeout(()=>{const si=document.getElementById('content-search');if(si){si.value='#'+\`${tag.replace(/'/g,"")}\`;si.dispatchEvent(new Event('input'));}},100)" style="font-size:${size}px;color:${color};cursor:pointer;padding:2px 6px;background:${color}15;border-radius:4px;transition:transform 0.2s" onmouseenter="this.style.transform='scale(1.15)'" onmouseleave="this.style.transform='scale(1)'" title="${count} items">${esc(tag)}<sup style="font-size:7px;color:var(--text-muted)">${count}</sup></span>`;
  });
  h+='</div>';
  if(!sorted.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No tags found. Add tags to content and tasks to see a cloud.</div>';
  const themes={};S.content.forEach(c=>{if(c.theme)themes[c.theme]=(themes[c.theme]||0)+1;});
  const themesSorted=Object.entries(themes).sort((a,b)=>b[1]-a[1]).slice(0,10);
  if(themesSorted.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin:12px 0 6px">Content Themes</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:4px">';
    themesSorted.forEach(([theme,count],i)=>{h+=`<span style="font-size:9px;color:${colors[i%colors.length]};padding:2px 8px;background:${colors[i%colors.length]}15;border-radius:10px">${esc(theme)} (${count})</span>`;});
    h+='</div>';
  }
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Tag Cloud (${sorted.length} tags)</span><button onclick="document.getElementById('tag-cloud-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showPriorityGrid(){
  let panel=document.getElementById('priority-grid-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='priority-grid-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  const priorities=['p0','p1','p2','p3'];
  const pLabels={p0:'Critical',p1:'High',p2:'Medium',p3:'Low'};
  const pColors={p0:'#ef4444',p1:'#f97316',p2:'#3b82f6',p3:'#6b7280'};
  let h='';
  priorities.forEach(pri=>{
    const tasks=active.filter(t=>(t.priority||'p2')===pri);
    h+=`<div style="margin-bottom:12px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="width:8px;height:8px;border-radius:2px;background:${pColors[pri]}"></span><span style="font-size:11px;font-weight:600;color:${pColors[pri]}">${pLabels[pri]} (${tasks.length})</span></div>`;
    if(tasks.length){
      tasks.forEach(t=>{
        h+=`<div style="display:flex;align-items:center;gap:6px;padding:4px 8px;margin:2px 0;border-left:2px solid ${pColors[pri]};font-size:10px" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="flex:1;color:var(--text-primary);cursor:pointer" onclick="document.getElementById('priority-grid-panel').remove();openTaskDetail(${t.id})">${esc(t.title||'Untitled')}</span>`;
        priorities.forEach(np=>{
          if(np===pri)return;
          h+=`<button onclick="var tk=S.tasks.find(x=>x.id===${t.id});if(tk){tk.priority='${np}';save();showPriorityGrid();}" style="padding:1px 4px;background:${pColors[np]}30;border:1px solid ${pColors[np]}50;border-radius:3px;color:${pColors[np]};font-size:7px;cursor:pointer" title="Move to ${pLabels[np]}">${np.toUpperCase()}</button>`;
        });
        h+='</div>';
      });
    }else{
      h+='<div style="font-size:9px;color:var(--text-muted);padding:4px 8px">No tasks</div>';
    }
    h+='</div>';
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Priority Grid (Quick Reassign)</span><button onclick="document.getElementById('priority-grid-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="font-size:9px;color:var(--text-muted);margin-bottom:8px">Click priority buttons to quickly reassign task priority</div>${h}`;
  document.body.appendChild(panel);
}
function showContentTimeline(){
  let panel=document.getElementById('content-tl-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-tl-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const items=S.content.slice().sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
  const byDay={};
  items.forEach(c=>{
    const d=(c.createdAt||'').split('T')[0]||'Unknown';
    if(!byDay[d])byDay[d]=[];
    byDay[d].push(c);
  });
  const typeColors={idea:'#f59e0b',quote:'#8b5cf6',code:'#06b6d4',insight:'#3b82f6',todo:'#ef4444',book:'#ec4899',research:'#22c55e',thought:'#14b8a6'};
  let h='';
  Object.keys(byDay).sort().reverse().slice(0,30).forEach(day=>{
    const d=new Date(day);
    const label=day==='Unknown'?'No Date':d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    h+=`<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--text-secondary);padding-bottom:4px;border-bottom:1px solid var(--border)">${label} (${byDay[day].length} items)</div>`;
    byDay[day].forEach(c=>{
      const color=typeColors[c.type]||'var(--text-muted)';
      const time=(c.createdAt||'').split('T')[1]||'';
      const timeStr=time?time.substring(0,5):'';
      const words=(c.body||'').split(/\s+/).length;
      h+=`<div onclick="document.getElementById('content-tl-panel').remove();openContentModal(${c.id})" style="display:flex;align-items:flex-start;gap:8px;padding:4px 6px;cursor:pointer;border-left:2px solid ${color};margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><div style="min-width:32px;font-size:8px;color:var(--text-muted);font-family:var(--mono)">${timeStr}</div><div style="flex:1"><div style="font-size:10px;color:var(--text-primary)">${esc((c.body||'').substring(0,80))}</div><div style="display:flex;gap:6px;font-size:8px;color:var(--text-muted);margin-top:2px"><span style="color:${color}">${c.type||'note'}</span>${c.theme?`<span>${esc(c.theme)}</span>`:''}<span>${words}w</span></div></div></div>`;
    });
    h+='</div>';
  });
  if(!items.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No content items yet</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Content Timeline (${items.length} items)</span><button onclick="document.getElementById('content-tl-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showVelocityChart(){
  let panel=document.getElementById('velocity-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='velocity-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:75vh;overflow-y:auto';
  const weeks=[];const now=new Date();
  for(let w=11;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-w*7-now.getDay());
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);
    const startStr=weekStart.toISOString().split('T')[0];
    const endStr=weekEnd.toISOString().split('T')[0];
    const completed=S.tasks.filter(t=>t.completedAt&&t.completedAt.split('T')[0]>=startStr&&t.completedAt.split('T')[0]<=endStr).length;
    const created=S.tasks.filter(t=>t.createdAt&&t.createdAt.split('T')[0]>=startStr&&t.createdAt.split('T')[0]<=endStr).length;
    weeks.push({label:weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'}),completed,created});
  }
  const maxVal=Math.max(...weeks.map(w=>Math.max(w.completed,w.created)),1);
  const W=480;const H=180;const pad=30;const gw=W-pad*2;const gh=H-pad*2;
  let svg=`<svg viewBox="0 0 ${W} ${H}" style="width:100%;height:auto">`;
  for(let i=0;i<=4;i++){
    const y=pad+gh-gh*(i/4);const val=Math.round(maxVal*(i/4));
    svg+=`<line x1="${pad}" y1="${y}" x2="${W-pad}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;
    svg+=`<text x="${pad-4}" y="${y+3}" font-size="8" fill="var(--text-muted)" text-anchor="end">${val}</text>`;
  }
  let completedPath='';let createdPath='';
  weeks.forEach((w,i)=>{
    const x=pad+i*(gw/(weeks.length-1));
    const yC=pad+gh-gh*(w.completed/maxVal);
    const yR=pad+gh-gh*(w.created/maxVal);
    completedPath+=(i===0?'M':'L')+x+','+yC;
    createdPath+=(i===0?'M':'L')+x+','+yR;
    if(i%2===0)svg+=`<text x="${x}" y="${H-5}" font-size="7" fill="var(--text-muted)" text-anchor="middle">${w.label}</text>`;
  });
  svg+=`<path d="${createdPath}" fill="none" stroke="#3b82f6" stroke-width="2" opacity="0.7"/>`;
  svg+=`<path d="${completedPath}" fill="none" stroke="#22c55e" stroke-width="2"/>`;
  weeks.forEach((w,i)=>{
    const x=pad+i*(gw/(weeks.length-1));
    const yC=pad+gh-gh*(w.completed/maxVal);
    const yR=pad+gh-gh*(w.created/maxVal);
    svg+=`<circle cx="${x}" cy="${yC}" r="3" fill="#22c55e"/>`;
    svg+=`<circle cx="${x}" cy="${yR}" r="3" fill="#3b82f6"/>`;
  });
  svg+='</svg>';
  const totalCompleted=weeks.reduce((s,w)=>s+w.completed,0);
  const totalCreated=weeks.reduce((s,w)=>s+w.created,0);
  const avgVelocity=Math.round(totalCompleted/weeks.length*10)/10;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Velocity (12 Weeks)</span><button onclick="document.getElementById('velocity-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;gap:12px;margin-bottom:8px;font-size:10px"><span style="color:#22c55e">Completed: ${totalCompleted}</span><span style="color:#3b82f6">Created: ${totalCreated}</span><span style="color:var(--accent)">Avg: ${avgVelocity}/wk</span></div><div style="display:flex;gap:8px;margin-bottom:8px;font-size:8px"><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:3px;background:#22c55e;border-radius:1px"></span>Completed</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:3px;background:#3b82f6;border-radius:1px"></span>Created</span></div>${svg}`;
  document.body.appendChild(panel);
}
function toggleQuickNote(){
  let btn=document.getElementById('quick-note-fab');
  if(btn){btn.remove();return;}
  btn=document.createElement('div');btn.id='quick-note-fab';
  btn.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1400;display:flex;flex-direction:column;align-items:flex-end;gap:8px';
  btn.innerHTML=`<div id="quick-note-area" style="display:none;width:280px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:10px;box-shadow:0 8px 32px rgba(0,0,0,0.5)"><textarea id="quick-note-text" placeholder="Quick note..." style="width:100%;height:60px;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;resize:vertical;box-sizing:border-box;margin-bottom:6px"></textarea><div style="display:flex;gap:4px"><select id="quick-note-type" style="flex:1;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:10px"><option value="idea">Idea</option><option value="thought">Thought</option><option value="quote">Quote</option><option value="todo">Todo</option><option value="insight">Insight</option></select><button onclick="saveQuickNote()" style="padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer">Save</button></div></div><button onclick="const a=document.getElementById('quick-note-area');a.style.display=a.style.display==='none'?'block':'none';if(a.style.display==='block')document.getElementById('quick-note-text').focus()" style="width:40px;height:40px;border-radius:50%;background:var(--accent);border:none;color:#000;font-size:18px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-weight:700">+</button>`;
  document.body.appendChild(btn);
}
function saveQuickNote(){
  const text=document.getElementById('quick-note-text');
  const type=document.getElementById('quick-note-type');
  if(!text||!text.value.trim()){toast('Enter some text');return;}
  const id=Date.now();
  S.content.unshift({id,body:text.value.trim(),type:type.value,theme:'quick-capture',tags:['quick-note'],createdAt:new Date().toISOString(),pinned:false});
  save();text.value='';toast('Quick note saved!');
  const area=document.getElementById('quick-note-area');if(area)area.style.display='none';
}
function showBookmarkletGenerator(){
  let panel=document.getElementById('bookmarklet-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='bookmarklet-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const bookmarklets=[
    {name:'Save Page as Link',desc:'Save current page URL + title to ASTRA links',code:"javascript:void(function(){var t=document.title,u=window.location.href;var d=JSON.parse(localStorage.getItem('astra-state')||'{}');if(!d.links)d.links=[];d.links.unshift({id:Date.now(),title:t,url:u,category:'saved',createdAt:new Date().toISOString()});localStorage.setItem('astra-state',JSON.stringify(d));alert('Saved: '+t)}())"},
    {name:'Capture Selection',desc:'Save highlighted text to ASTRA content',code:"javascript:void(function(){var s=window.getSelection().toString();if(!s){alert('Select some text first');return}var d=JSON.parse(localStorage.getItem('astra-state')||'{}');if(!d.content)d.content=[];d.content.unshift({id:Date.now(),body:s,type:'quote',theme:'web-capture',tags:['bookmarklet'],source:window.location.href,createdAt:new Date().toISOString()});localStorage.setItem('astra-state',JSON.stringify(d));alert('Captured '+s.length+' chars')}())"},
    {name:'Quick Task',desc:'Create a task from current page',code:"javascript:void(function(){var t=prompt('Task title:',document.title);if(!t)return;var d=JSON.parse(localStorage.getItem('astra-state')||'{}');if(!d.tasks)d.tasks=[];d.tasks.unshift({id:Date.now(),title:t,status:'todo',priority:'p2',createdAt:new Date().toISOString()});localStorage.setItem('astra-state',JSON.stringify(d));alert('Task created: '+t)}())"},
  ];
  let h='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Drag these links to your bookmarks bar, or right-click and "Add to Bookmarks"</div>';
  bookmarklets.forEach(b=>{
    h+=`<div style="padding:10px;background:var(--bg-surface);border-radius:6px;margin-bottom:8px;border-left:2px solid var(--accent)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><a href="${b.code}" style="font-size:11px;font-weight:600;color:var(--accent);text-decoration:none;cursor:move" onclick="event.preventDefault();toast('Drag to bookmarks bar!')">${esc(b.name)}</a><button onclick="navigator.clipboard.writeText(\`${b.code.replace(/`/g,"'")}\`);toast('Bookmarklet code copied!')" style="padding:2px 8px;background:var(--accent);border:none;border-radius:3px;color:#000;font-size:8px;cursor:pointer">Copy</button></div><div style="font-size:9px;color:var(--text-muted)">${b.desc}</div></div>`;
  });
  h+='<div style="font-size:9px;color:var(--text-muted);margin-top:8px;font-style:italic">Note: Bookmarklets work on the same domain. For cross-domain, use the Nexus Capture extension.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Bookmarklet Generator</span><button onclick="document.getElementById('bookmarklet-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showWorkspaceSearch(initialQuery){
  let panel=document.getElementById('ws-search-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ws-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:85vh;overflow-y:auto';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Workspace Search</span><button onclick="document.getElementById('ws-search-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><input id="ws-search-input" placeholder="Search everything..." value="${initialQuery||''}" style="width:100%;padding:8px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;margin-bottom:10px;box-sizing:border-box" autofocus><div id="ws-search-results" style="font-size:10px"></div>`;
  document.body.appendChild(panel);
  const input=document.getElementById('ws-search-input');
  input.addEventListener('input',()=>runWorkspaceSearch(input.value));
  if(initialQuery)runWorkspaceSearch(initialQuery);
  input.focus();
}
function runWorkspaceSearch(q){
  const results=document.getElementById('ws-search-results');if(!results)return;
  if(!q||q.length<2){results.innerHTML='<div style="color:var(--text-muted);padding:12px;text-align:center">Type at least 2 characters...</div>';return;}
  const ql=q.toLowerCase();const matches=[];
  S.tasks.forEach(t=>{
    const score=((t.title||'').toLowerCase().includes(ql)?3:0)+((t.description||'').toLowerCase().includes(ql)?2:0)+((t.project||'').toLowerCase().includes(ql)?1:0);
    if(score>0)matches.push({section:'Tasks',title:t.title||'Untitled',preview:(t.description||'').substring(0,80),score,action:`openTaskDetail(${t.id})`,color:'#06b6d4',status:t.status,pri:t.priority});
  });
  S.content.forEach(c=>{
    const score=((c.body||'').toLowerCase().includes(ql)?3:0)+((c.tags||[]).join(' ').toLowerCase().includes(ql)?2:0)+((c.theme||'').toLowerCase().includes(ql)?1:0);
    if(score>0)matches.push({section:'Content',title:(c.body||'').substring(0,60),preview:c.type+' | '+(c.theme||''),score,action:`openContentModal(${c.id})`,color:'#f59e0b'});
  });
  (S.docs||[]).forEach(d=>{
    const score=((d.title||'').toLowerCase().includes(ql)?3:0)+((d.body||'').toLowerCase().includes(ql)?2:0);
    if(score>0)matches.push({section:'Writer',title:d.title||'Untitled',preview:(d.body||'').substring(0,80),score,action:`switchSection('writer');setTimeout(()=>{const i=S.docs.findIndex(x=>x.id===${d.id});if(i>=0){writerDocIdx=i;renderWriterDoc();}},100)`,color:'var(--accent)'});
  });
  (S.links||[]).forEach(l=>{
    const score=((l.title||'').toLowerCase().includes(ql)?3:0)+((l.url||'').toLowerCase().includes(ql)?2:0)+((l.category||'').toLowerCase().includes(ql)?1:0);
    if(score>0)matches.push({section:'Links',title:l.title||l.url,preview:l.url,score,action:`window.open('${(l.url||'').replace(/'/g,"\\'")}','_blank')`,color:'#8b5cf6'});
  });
  matches.sort((a,b)=>b.score-a.score);
  let h=`<div style="color:var(--text-muted);padding:4px 0;margin-bottom:6px">${matches.length} results for "${esc(q)}"</div>`;
  const sections={};matches.slice(0,30).forEach(m=>{if(!sections[m.section])sections[m.section]=[];sections[m.section].push(m);});
  Object.entries(sections).forEach(([sec,items])=>{
    h+=`<div style="font-size:10px;font-weight:600;color:var(--text-secondary);padding:6px 0 4px;border-bottom:1px solid var(--border)">${sec} (${items.length})</div>`;
    items.forEach(m=>{
      h+=`<div onclick="document.getElementById('ws-search-panel').remove();${m.action}" style="padding:5px 8px;cursor:pointer;display:flex;align-items:center;gap:8px;border-left:2px solid ${m.color}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><div style="flex:1"><div style="font-size:10px;color:var(--text-primary)">${esc(m.title)}</div>${m.preview?`<div style="font-size:8px;color:var(--text-muted)">${esc(m.preview)}</div>`:''}</div>${m.status?`<span style="font-size:7px;color:var(--text-muted)">${m.status}</span>`:''}</div>`;
    });
  });
  if(!matches.length)h='<div style="color:var(--text-muted);padding:20px;text-align:center">No results found</div>';
  results.innerHTML=h;
}
function showBatchTaskEditor(){
  let panel=document.getElementById('batch-edit-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='batch-edit-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  let h='<div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap"><label style="font-size:10px;color:var(--text-secondary);display:flex;align-items:center;gap:4px"><input type="checkbox" id="batch-select-all" onchange="document.querySelectorAll(\'.batch-task-cb\').forEach(cb=>cb.checked=this.checked)"> Select All</label><select id="batch-action" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:10px"><option value="">Action...</option><option value="priority">Set Priority</option><option value="status">Set Status</option><option value="project">Set Project</option><option value="due">Set Due Date</option></select><select id="batch-value" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:10px"><option value="">Value...</option><option value="p0">P0 Critical</option><option value="p1">P1 High</option><option value="p2">P2 Medium</option><option value="p3">P3 Low</option><option value="todo">Status: Todo</option><option value="in-progress">Status: In Progress</option><option value="done">Status: Done</option></select><button onclick="applyBatchEdit()" style="padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer">Apply</button></div>';
  active.forEach(t=>{
    const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':t.priority==='p2'?'#3b82f6':'#6b7280';
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:4px 6px;font-size:10px;border-left:2px solid ${priColor}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><input type="checkbox" class="batch-task-cb" value="${t.id}"><span style="flex:1;color:var(--text-primary)">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${priColor}">${(t.priority||'p2').toUpperCase()}</span><span style="font-size:8px;color:var(--text-muted)">${t.status}</span></div>`;
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Batch Task Editor (${active.length} active)</span><button onclick="document.getElementById('batch-edit-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function applyBatchEdit(){
  const action=document.getElementById('batch-action');
  const value=document.getElementById('batch-value');
  if(!action||!value||!action.value||!value.value){toast('Select action and value');return;}
  const checked=document.querySelectorAll('.batch-task-cb:checked');
  if(!checked.length){toast('Select tasks first');return;}
  let count=0;
  checked.forEach(cb=>{
    const t=S.tasks.find(x=>x.id===parseInt(cb.value));
    if(!t)return;
    if(action.value==='priority')t.priority=value.value;
    else if(action.value==='status'){t.status=value.value;if(value.value==='done')t.completedAt=new Date().toISOString();}
    else if(action.value==='project')t.project=value.value;
    count++;
  });
  save();toast('Updated '+count+' tasks');showBatchTaskEditor();
}
function showContentStats(){
  let panel=document.getElementById('content-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const items=S.content||[];
  const totalWords=items.reduce((s,c)=>s+((c.body||'').split(/\s+/).length),0);
  const totalChars=items.reduce((s,c)=>s+(c.body||'').length,0);
  const types={};items.forEach(c=>{const t=c.type||'note';types[t]=(types[t]||0)+1;});
  const themes={};items.forEach(c=>{if(c.theme)themes[c.theme]=(themes[c.theme]||0)+1;});
  const tags={};items.forEach(c=>{(c.tags||[]).forEach(t=>{tags[t]=(tags[t]||0)+1;});});
  const pinned=items.filter(c=>c.pinned).length;
  const starred=items.filter(c=>c.starred).length;
  const avgWords=items.length?Math.round(totalWords/items.length):0;
  const thisWeek=new Date();thisWeek.setDate(thisWeek.getDate()-7);const weekStr=thisWeek.toISOString().split('T')[0];
  const recentCount=items.filter(c=>c.createdAt&&c.createdAt.split('T')[0]>=weekStr).length;
  const topTypes=Object.entries(types).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const topThemes=Object.entries(themes).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const topTags=Object.entries(tags).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const typeColors={idea:'#f59e0b',quote:'#8b5cf6',code:'#06b6d4',insight:'#3b82f6',todo:'#ef4444',book:'#ec4899',research:'#22c55e',thought:'#14b8a6',note:'#6b7280'};
  let h='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${items.length}</div><div style="font-size:7px;color:var(--text-muted)">Items</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#3b82f6">${(totalWords/1000).toFixed(1)}k</div><div style="font-size:7px;color:var(--text-muted)">Words</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${avgWords}</div><div style="font-size:7px;color:var(--text-muted)">Avg Words</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#22c55e">${recentCount}</div><div style="font-size:7px;color:var(--text-muted)">This Week</div></div>`;
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">By Type</div>';
  topTypes.forEach(([t,n])=>{
    const pct=Math.round(n/items.length*100);const color=typeColors[t]||'var(--text-muted)';
    h+=`<div style="display:flex;align-items:center;gap:4px;padding:2px 0;font-size:9px"><span style="width:6px;height:6px;border-radius:50%;background:${color}"></span><span style="flex:1;color:var(--text-primary)">${esc(t)}</span><span style="color:var(--text-muted)">${n} (${pct}%)</span></div>`;
  });
  h+='</div>';
  h+='<div><div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">By Theme</div>';
  topThemes.forEach(([t,n])=>{h+=`<div style="font-size:9px;color:var(--text-primary);padding:2px 0">${esc(t)} <span style="color:var(--text-muted)">(${n})</span></div>`;});
  if(!topThemes.length)h+='<div style="font-size:9px;color:var(--text-muted)">No themes</div>';
  h+='</div></div>';
  if(topTags.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">Top Tags</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
    topTags.forEach(([t,n])=>{h+=`<span style="font-size:8px;color:var(--accent);padding:2px 6px;background:var(--accent)15;border-radius:8px">${esc(t)} (${n})</span>`;});
    h+='</div>';
  }
  h+=`<div style="font-size:9px;color:var(--text-muted)">Pinned: ${pinned} | Starred: ${starred} | ${(totalChars/1024).toFixed(1)}KB total</div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Content Stats Dashboard</span><button onclick="document.getElementById('content-stats-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showSwimlaneView(){
  let panel=document.getElementById('swimlane-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='swimlane-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow-y:auto';
  const projects=[...new Set(S.tasks.map(t=>t.project||'No Project'))].sort();
  const statuses=['todo','in-progress','done'];
  const statusLabels={todo:'Todo','in-progress':'In Progress',done:'Done'};
  const statusColors={todo:'var(--text-muted)','in-progress':'#3b82f6',done:'#22c55e'};
  let h='<div style="overflow-x:auto">';
  h+='<table style="width:100%;border-collapse:collapse;font-size:10px">';
  h+='<thead><tr><th style="text-align:left;padding:6px;color:var(--text-muted);font-size:9px;border-bottom:1px solid var(--border);min-width:100px">Project</th>';
  statuses.forEach(s=>{h+=`<th style="text-align:center;padding:6px;color:${statusColors[s]};font-size:9px;border-bottom:1px solid var(--border);min-width:150px">${statusLabels[s]}</th>`;});
  h+='</tr></thead><tbody>';
  projects.forEach(proj=>{
    const projTasks=S.tasks.filter(t=>(t.project||'No Project')===proj);
    h+=`<tr><td style="padding:8px;vertical-align:top;border-bottom:1px solid var(--border)"><div style="font-weight:600;color:var(--text-primary)">${esc(proj)}</div><div style="font-size:8px;color:var(--text-muted)">${projTasks.length} tasks</div></td>`;
    statuses.forEach(s=>{
      const tasks=projTasks.filter(t=>t.status===s);
      h+='<td style="padding:4px;vertical-align:top;border-bottom:1px solid var(--border)">';
      tasks.slice(0,8).forEach(t=>{
        const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-muted)';
        h+=`<div onclick="document.getElementById('swimlane-panel').remove();openTaskDetail(${t.id})" style="padding:3px 6px;margin:2px 0;background:var(--bg-surface);border-radius:4px;cursor:pointer;border-left:2px solid ${priColor}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='var(--bg-surface)'"><div style="font-size:9px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div></div>`;
      });
      if(tasks.length>8)h+=`<div style="font-size:8px;color:var(--text-muted);padding:2px 6px">+${tasks.length-8} more</div>`;
      if(!tasks.length)h+='<div style="font-size:8px;color:var(--text-muted);padding:4px;text-align:center">-</div>';
      h+='</td>';
    });
    h+='</tr>';
  });
  h+='</tbody></table></div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Swimlane View (${projects.length} projects)</span><button onclick="document.getElementById('swimlane-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showDailyPlanner(){
  let panel=document.getElementById('daily-plan-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='daily-plan-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:85vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const todayLabel=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
  const timeBlocks=(S._timeBlocks||[]).filter(b=>b.date===today);
  const hours=['06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00'];
  const nowHour=new Date().getHours();
  let h=`<div style="font-size:11px;color:var(--text-secondary);margin-bottom:12px">${todayLabel}</div>`;
  if(overdue.length){
    h+=`<div style="font-size:10px;font-weight:600;color:#ef4444;margin-bottom:4px">Overdue (${overdue.length})</div>`;
    overdue.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('daily-plan-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid #ef4444;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title)} <span style="color:#ef4444;font-size:8px">(${t.due})</span></div>`;});
    h+='<div style="height:8px"></div>';
  }
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Daily Schedule</div>';
  hours.forEach(hour=>{
    const hourNum=parseInt(hour);
    const isCurrent=hourNum===nowHour;
    const block=timeBlocks.find(b=>b.start&&parseInt(b.start)===hourNum);
    h+=`<div style="display:flex;align-items:stretch;gap:8px;min-height:28px;${isCurrent?'background:var(--accent)08;border-left:2px solid var(--accent);':''};padding:2px 0"><span style="min-width:40px;font-size:9px;color:${isCurrent?'var(--accent)':'var(--text-muted)'};font-family:var(--mono);padding-top:4px">${hour}</span><div style="flex:1;border-bottom:1px solid var(--border);padding:2px 4px;font-size:9px">`;
    if(block)h+=`<span style="padding:1px 6px;background:var(--accent)20;border-radius:3px;color:var(--accent)">${esc(block.title)}</span>`;
    h+='</div></div>';
  });
  h+='<div style="margin-top:12px;font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">Today\'s Tasks ('+todayTasks.length+')</div>';
  todayTasks.forEach(t=>{
    const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'#3b82f6';
    h+=`<div onclick="document.getElementById('daily-plan-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid ${priColor};margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title||'Untitled')} <span style="font-size:8px;color:${priColor}">${(t.priority||'p2').toUpperCase()}</span></div>`;
  });
  if(!todayTasks.length)h+='<div style="font-size:9px;color:var(--text-muted);padding:4px 8px">No tasks due today</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Daily Planner</span><button onclick="document.getElementById('daily-plan-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function exportFullWorkspace(){
  const data={
    tasks:S.tasks,content:S.content,docs:S.docs,links:S.links,
    projects:S.projects,specs:S.specs,repos:S.repos,
    focusSessions:S.focusSessions,goals:S.goals,
    habits:S._habits,snippets:S._snippets,stickies:S._stickies,
    timeBlocks:S._timeBlocks,clips:S._clips,
    exportedAt:new Date().toISOString(),version:'astra-full-export-v1'
  };
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='astra-workspace-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();
  const sizeKB=(json.length/1024).toFixed(1);
  toast('Exported full workspace ('+sizeKB+'KB)');
}
function toggleQuickActions(){
  let bar=document.getElementById('quick-actions-bar');
  if(bar){bar.remove();return;}
  bar=document.createElement('div');bar.id='quick-actions-bar';
  bar.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:1400;display:flex;gap:6px;padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5)';
  const actions=[
    {label:'Task',icon:'+',fn:'addTask()'},
    {label:'Note',icon:'N',fn:'toggleQuickNote()'},
    {label:'Journal',icon:'J',fn:'openDailyJournal()'},
    {label:'Dashboard',icon:'D',fn:'showHomeDashboard()'},
    {label:'Habits',icon:'H',fn:'showHabitTracker()'},
    {label:'Timer',icon:'F',fn:'document.getElementById(\"focus-start\")?document.getElementById(\"focus-start\").click():toast(\"Open context panel first\")'},
    {label:'Cmd+K',icon:'K',fn:'openCommandPalette()'},
    {label:'Close',icon:'X',fn:'document.getElementById(\"quick-actions-bar\").remove()'},
  ];
  actions.forEach(a=>{
    bar.innerHTML+=`<button onclick="${a.fn}" style="padding:6px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:9px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;min-width:40px" onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)'"><span style="font-size:14px;font-weight:600;color:var(--accent)">${a.icon}</span><span>${a.label}</span></button>`;
  });
  document.body.appendChild(bar);
}
function showDueDateHeatmap(){
  let panel=document.getElementById('due-heat-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='due-heat-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const todayStr=now.toISOString().split('T')[0];
  const byDate={};
  S.tasks.filter(t=>t.due&&t.status!=='done').forEach(t=>{
    if(!byDate[t.due])byDate[t.due]=[];
    byDate[t.due].push(t);
  });
  let h='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;margin-bottom:4px">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div style="text-align:center;font-size:9px;color:var(--text-muted);padding:4px 0;font-weight:600">${d}</div>`;});
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px">';
  for(let i=0;i<firstDay;i++){h+='<div style="min-height:50px"></div>';}
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const tasks=byDate[ds]||[];
    const count=tasks.length;
    const isToday=ds===todayStr;
    const isPast=ds<todayStr;
    let bg='var(--bg-surface)';
    if(count>=4)bg='#ef444440';
    else if(count>=3)bg='#f9731640';
    else if(count>=2)bg='#f59e0b30';
    else if(count>=1)bg='#22c55e20';
    h+=`<div style="min-height:50px;padding:3px;border-radius:4px;background:${bg};${isToday?'border:1px solid var(--accent);':''}cursor:pointer" onclick="if(${count}>0){const t=S.tasks.filter(x=>x.due==='${ds}'&&x.status!=='done');if(t.length)openTaskDetail(t[0].id)}" title="${count} tasks due"><div style="font-size:9px;font-weight:600;color:${isToday?'var(--accent)':isPast?'var(--text-muted)':'var(--text-primary)'}">${d}</div>`;
    if(count){h+=`<div style="font-size:8px;font-weight:600;color:${count>=3?'#ef4444':count>=2?'#f59e0b':'var(--accent)'}">${count} task${count>1?'s':''}</div>`;}
    tasks.slice(0,2).forEach(t=>{
      const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-muted)';
      h+=`<div style="font-size:7px;color:${priColor};overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'').substring(0,15)}</div>`;
    });
    h+='</div>';
  }
  h+='</div>';
  const heaviestDay=Object.entries(byDate).sort((a,b)=>b[1].length-a[1].length)[0];
  const totalDue=Object.values(byDate).reduce((s,v)=>s+v.length,0);
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Due Date Heatmap - ${monthName}</span><button onclick="document.getElementById('due-heat-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;gap:12px;margin-bottom:8px;font-size:10px"><span style="color:var(--text-muted)">${totalDue} tasks due this month</span>${heaviestDay?`<span style="color:#ef4444">Peak: ${heaviestDay[0].substring(5)} (${heaviestDay[1].length})</span>`:''}</div><div style="display:flex;gap:4px;margin-bottom:8px;font-size:8px;color:var(--text-muted)"><span style="display:flex;align-items:center;gap:2px"><span style="width:10px;height:10px;border-radius:2px;background:#22c55e20"></span>1</span><span style="display:flex;align-items:center;gap:2px"><span style="width:10px;height:10px;border-radius:2px;background:#f59e0b30"></span>2</span><span style="display:flex;align-items:center;gap:2px"><span style="width:10px;height:10px;border-radius:2px;background:#f9731640"></span>3</span><span style="display:flex;align-items:center;gap:2px"><span style="width:10px;height:10px;border-radius:2px;background:#ef444440"></span>4+</span></div>${h}`;
  document.body.appendChild(panel);
}
function showWritingGoals(){
  let panel=document.getElementById('writing-goals-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writing-goals-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:75vh;overflow-y:auto';
  if(!S._writingGoals)S._writingGoals={daily:500,weekly:3000};
  const today=new Date().toISOString().split('T')[0];
  const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);const weekStr=weekAgo.toISOString().split('T')[0];
  let todayWords=0;let weekWords=0;
  S.content.forEach(c=>{
    if(!c.createdAt)return;
    const d=c.createdAt.split('T')[0];
    const w=(c.body||'').split(/\s+/).length;
    if(d===today)todayWords+=w;
    if(d>=weekStr)weekWords+=w;
  });
  (S.docs||[]).forEach(d=>{
    const dt=(d.updatedAt||d.createdAt||'').split('T')[0];
    const w=(d.body||'').split(/\s+/).length;
    if(dt===today)todayWords+=w;
    if(dt>=weekStr)weekWords+=w;
  });
  const dailyPct=Math.min(100,Math.round(todayWords/S._writingGoals.daily*100));
  const weeklyPct=Math.min(100,Math.round(weekWords/S._writingGoals.weekly*100));
  let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Daily Goal</div><div style="font-size:20px;font-weight:700;color:${dailyPct>=100?'#22c55e':'var(--accent)'}">${todayWords}</div><div style="font-size:9px;color:var(--text-muted)">/ ${S._writingGoals.daily} words</div><div style="width:100%;height:6px;background:var(--bg-elevated);border-radius:3px;margin-top:6px;overflow:hidden"><div style="width:${dailyPct}%;height:100%;background:${dailyPct>=100?'#22c55e':dailyPct>=50?'var(--accent)':'#f59e0b'};border-radius:3px;transition:width 0.3s"></div></div><div style="font-size:8px;color:var(--text-muted);margin-top:2px">${dailyPct}%</div></div>`;
  h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Weekly Goal</div><div style="font-size:20px;font-weight:700;color:${weeklyPct>=100?'#22c55e':'#3b82f6'}">${weekWords}</div><div style="font-size:9px;color:var(--text-muted)">/ ${S._writingGoals.weekly} words</div><div style="width:100%;height:6px;background:var(--bg-elevated);border-radius:3px;margin-top:6px;overflow:hidden"><div style="width:${weeklyPct}%;height:100%;background:${weeklyPct>=100?'#22c55e':weeklyPct>=50?'#3b82f6':'#f59e0b'};border-radius:3px;transition:width 0.3s"></div></div><div style="font-size:8px;color:var(--text-muted);margin-top:2px">${weeklyPct}%</div></div>`;
  h+='</div>';
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Set Goals</div>';
  h+=`<div style="display:flex;gap:8px;margin-bottom:12px"><div style="flex:1"><label style="font-size:9px;color:var(--text-muted)">Daily Words</label><input id="wg-daily" type="number" value="${S._writingGoals.daily}" style="width:100%;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;box-sizing:border-box"></div><div style="flex:1"><label style="font-size:9px;color:var(--text-muted)">Weekly Words</label><input id="wg-weekly" type="number" value="${S._writingGoals.weekly}" style="width:100%;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;box-sizing:border-box"></div><button onclick="S._writingGoals={daily:parseInt(document.getElementById('wg-daily').value)||500,weekly:parseInt(document.getElementById('wg-weekly').value)||3000};save();toast('Goals updated');showWritingGoals()" style="padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer;align-self:flex-end">Save</button></div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Writing Goals</span><button onclick="document.getElementById('writing-goals-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showProjectComparison(){
  let panel=document.getElementById('proj-compare-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=[...new Set(S.tasks.map(t=>t.project).filter(Boolean))].sort();
  if(projects.length<2){panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Project Comparison</span><button onclick="document.getElementById('proj-compare-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">Need at least 2 projects to compare</div>`;document.body.appendChild(panel);return;}
  function getStats(proj){
    const tasks=S.tasks.filter(t=>t.project===proj);
    const done=tasks.filter(t=>t.status==='done').length;
    const active=tasks.filter(t=>t.status!=='done').length;
    const today=new Date().toISOString().split('T')[0];
    const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today).length;
    const content=S.content.filter(c=>c.theme===proj||c.project===proj).length;
    const docs=(S.docs||[]).filter(d=>d.project===proj).length;
    const links=(S.links||[]).filter(l=>l.project===proj).length;
    const totalWords=tasks.reduce((s,t)=>s+((t.description||'').split(/\s+/).length),0);
    const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);const weekStr=weekAgo.toISOString().split('T')[0];
    const velocity=tasks.filter(t=>t.completedAt&&t.completedAt.split('T')[0]>=weekStr).length;
    return{total:tasks.length,done,active,overdue,content,docs,links,velocity,pct:tasks.length?Math.round(done/tasks.length*100):0};
  }
  let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  projects.slice(0,2).forEach((proj,i)=>{
    const s=getStats(proj);
    const healthScore=Math.min(100,Math.max(0,s.pct-(s.overdue*10)+(s.velocity*5)));
    const healthColor=healthScore>=70?'#22c55e':healthScore>=40?'#f59e0b':'#ef4444';
    h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:12px;font-weight:600;color:var(--text-primary);margin-bottom:8px;border-bottom:2px solid ${i===0?'#3b82f6':'#8b5cf6'};padding-bottom:4px">${esc(proj)}</div>`;
    h+=`<div style="font-size:9px;display:grid;gap:4px">`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Tasks</span><span style="color:var(--text-primary)">${s.total}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Done</span><span style="color:#22c55e">${s.done} (${s.pct}%)</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Active</span><span style="color:#3b82f6">${s.active}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Overdue</span><span style="color:#ef4444">${s.overdue}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">7d Velocity</span><span style="color:var(--accent)">${s.velocity}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Content</span><span>${s.content}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Docs</span><span>${s.docs}</span></div>`;
    h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Links</span><span>${s.links}</span></div>`;
    h+=`<div style="margin-top:4px;display:flex;justify-content:space-between"><span style="color:var(--text-muted)">Health</span><span style="color:${healthColor};font-weight:600">${healthScore}</span></div>`;
    h+=`</div></div>`;
  });
  h+='</div>';
  if(projects.length>2){h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:8px">Showing first 2 of ${projects.length} projects</div>`;}
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Project Comparison</span><button onclick="document.getElementById('proj-compare-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showTaskAging(){
  let panel=document.getElementById('task-aging-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-aging-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  const active=S.tasks.filter(t=>t.status!=='done').map(t=>{
    const created=t.createdAt?new Date(t.createdAt):now;
    const ageDays=Math.floor((now-created)/(1000*60*60*24));
    return{...t,ageDays};
  }).sort((a,b)=>b.ageDays-a.ageDays);
  const stale=active.filter(t=>t.ageDays>30);
  const aging=active.filter(t=>t.ageDays>14&&t.ageDays<=30);
  const fresh=active.filter(t=>t.ageDays<=14);
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#ef4444">${stale.length}</div><div style="font-size:8px;color:var(--text-muted)">Stale (30+ days)</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#f59e0b">${aging.length}</div><div style="font-size:8px;color:var(--text-muted)">Aging (14-30)</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#22c55e">${fresh.length}</div><div style="font-size:8px;color:var(--text-muted)">Fresh (<14)</div></div>`;
  h+='</div>';
  function renderGroup(tasks,label,color){
    if(!tasks.length)return'';
    let r=`<div style="font-size:10px;font-weight:600;color:${color};margin-bottom:4px">${label}</div>`;
    tasks.slice(0,12).forEach(t=>{
      r+=`<div onclick="document.getElementById('task-aging-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:3px 6px;cursor:pointer;border-left:2px solid ${color};margin:2px 0;font-size:10px" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="min-width:30px;font-size:8px;color:${color};font-weight:600">${t.ageDays}d</span><span style="flex:1;color:var(--text-primary)">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted)">${t.status}</span></div>`;
    });
    if(tasks.length>12)r+=`<div style="font-size:8px;color:var(--text-muted);padding:2px 6px">+${tasks.length-12} more</div>`;
    return r+'<div style="height:8px"></div>';
  }
  h+=renderGroup(stale,'Stale Tasks (30+ days old)','#ef4444');
  h+=renderGroup(aging,'Aging Tasks (14-30 days)','#f59e0b');
  h+=renderGroup(fresh,'Fresh Tasks (<14 days)','#22c55e');
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Aging Report</span><button onclick="document.getElementById('task-aging-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function importLinksFromMarkdown(){
  const text=prompt('Paste markdown with URLs (e.g. [title](url) or raw URLs):');
  if(!text)return;
  const linkRegex=/\[([^\]]+)\]\(([^)]+)\)/g;
  const urlRegex=/https?:\/\/[^\s<>"']+/g;
  const found=[];let m;
  while((m=linkRegex.exec(text))!==null){found.push({title:m[1],url:m[2]});}
  const rawUrls=text.match(urlRegex)||[];
  rawUrls.forEach(u=>{if(!found.some(f=>f.url===u))found.push({title:u.replace(/https?:\/\//,'').substring(0,40),url:u});});
  if(!found.length){toast('No URLs found in text');return;}
  const existing=new Set((S.links||[]).map(l=>l.url));
  let added=0;
  found.forEach(f=>{
    if(existing.has(f.url))return;
    S.links.unshift({id:Date.now()+added,title:f.title,url:f.url,category:'imported',createdAt:new Date().toISOString()});
    added++;
  });
  save();renderLinks();
  toast('Imported '+added+' links ('+(found.length-added)+' duplicates skipped)');
}
function showAmbientSounds(){
  let panel=document.getElementById('ambient-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ambient-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const sounds=[
    {name:'Rain',emoji:'R',desc:'Gentle rain for deep focus'},
    {name:'Coffee Shop',emoji:'C',desc:'Ambient cafe background'},
    {name:'Forest',emoji:'F',desc:'Birds and gentle wind'},
    {name:'Ocean',emoji:'O',desc:'Calm ocean waves'},
    {name:'White Noise',emoji:'W',desc:'Steady white noise'},
    {name:'Silent',emoji:'S',desc:'No ambient sound'},
  ];
  let h='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Select ambient sound for focus sessions. Uses Web Audio API tone generator.</div>';
  const current=S._ambientSound||'Silent';
  sounds.forEach(s=>{
    const isActive=current===s.name;
    h+=`<div onclick="setAmbientSound('${s.name}')" style="display:flex;align-items:center;gap:10px;padding:8px 10px;cursor:pointer;border-radius:6px;margin:2px 0;border:1px solid ${isActive?'var(--accent)':'transparent'};background:${isActive?'var(--accent)10':'transparent'}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='${isActive?'var(--accent)10':'transparent'}'"><span style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--bg-surface);border-radius:6px;font-size:14px;font-weight:600;color:var(--accent)">${s.emoji}</span><div style="flex:1"><div style="font-size:11px;font-weight:600;color:var(--text-primary)">${s.name}</div><div style="font-size:9px;color:var(--text-muted)">${s.desc}</div></div>${isActive?'<span style="font-size:10px;color:var(--accent);font-weight:600">Active</span>':''}</div>`;
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Ambient Sounds</span><button onclick="document.getElementById('ambient-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function setAmbientSound(name){
  S._ambientSound=name;save();
  if(window._ambientOsc){try{window._ambientOsc.stop();}catch(e){}window._ambientOsc=null;}
  if(name==='Silent'){toast('Ambient sound off');showAmbientSounds();return;}
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    gain.gain.value=0.02;
    const freqs={Rain:200,['Coffee Shop']:300,Forest:150,Ocean:100,['White Noise']:0};
    if(name==='White Noise'){
      const bufferSize=2*ctx.sampleRate;const buffer=ctx.createBuffer(1,bufferSize,ctx.sampleRate);
      const data=buffer.getChannelData(0);for(let i=0;i<bufferSize;i++)data[i]=Math.random()*2-1;
      const src=ctx.createBufferSource();src.buffer=buffer;src.loop=true;src.connect(gain);gain.connect(ctx.destination);src.start();
      window._ambientOsc=src;
    }else{
      osc.type='sine';osc.frequency.value=freqs[name]||200;
      osc.connect(gain);gain.connect(ctx.destination);osc.start();
      window._ambientOsc=osc;
    }
    toast('Playing: '+name);
  }catch(e){toast('Audio not available');}
  showAmbientSounds();
}
function showWordFrequency(){
  let panel=document.getElementById('word-freq-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='word-freq-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:75vh;overflow-y:auto';
  const stopWords=new Set(['the','a','an','and','or','but','in','on','at','to','for','of','with','by','from','is','it','as','was','are','be','has','had','have','this','that','these','those','not','no','so','if','then','than','can','will','would','could','should','do','does','did','just','more','some','any','all','each','every','both','few','many','most','other','such','only','very','also','into','over','after','before','between','under','about','up','out','its','he','she','they','we','you','my','your','his','her','our','their','i','me','us','them','what','which','who','when','where','how','why']);
  const wordCounts={};
  S.content.forEach(c=>{
    (c.body||'').toLowerCase().split(/\s+/).forEach(w=>{
      const clean=w.replace(/[^a-z0-9]/g,'');
      if(clean.length>2&&!stopWords.has(clean))wordCounts[clean]=(wordCounts[clean]||0)+1;
    });
  });
  (S.docs||[]).forEach(d=>{
    (d.body||'').toLowerCase().split(/\s+/).forEach(w=>{
      const clean=w.replace(/[^a-z0-9]/g,'');
      if(clean.length>2&&!stopWords.has(clean))wordCounts[clean]=(wordCounts[clean]||0)+1;
    });
  });
  const sorted=Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]).slice(0,50);
  const maxCount=sorted.length?sorted[0][1]:1;
  let h='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">';
  sorted.slice(0,30).forEach(([word,count])=>{
    const size=Math.round(8+count/maxCount*14);
    const opacity=0.5+count/maxCount*0.5;
    h+=`<span style="font-size:${size}px;color:var(--accent);opacity:${opacity};padding:2px 4px" title="${count} occurrences">${esc(word)}</span>`;
  });
  h+='</div>';
  h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Top 50 Words</div>';
  sorted.forEach(([word,count],i)=>{
    const pct=Math.round(count/maxCount*100);
    h+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:9px"><span style="min-width:16px;color:var(--text-muted)">${i+1}.</span><span style="flex:1;color:var(--text-primary)">${esc(word)}</span><span style="color:var(--accent)">${count}</span><div style="width:60px;height:3px;background:var(--bg-surface);border-radius:1px;overflow:hidden"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:1px"></div></div></div>`;
  });
  if(!sorted.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No content to analyze</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Word Frequency Analysis</span><button onclick="document.getElementById('word-freq-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showPriorityBoard(){
  let panel=document.getElementById('pri-board-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='pri-board-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  const active=S.tasks.filter(t=>t.status!=='done');
  const priorities=[{key:'p0',label:'Critical',color:'#ef4444'},{key:'p1',label:'High',color:'#f97316'},{key:'p2',label:'Medium',color:'#3b82f6'},{key:'p3',label:'Low',color:'#6b7280'}];
  let h='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
  priorities.forEach(pri=>{
    const tasks=active.filter(t=>(t.priority||'p2')===pri.key);
    h+=`<div style="background:var(--bg-surface);border-radius:8px;padding:8px;border-top:3px solid ${pri.color}"><div style="font-size:10px;font-weight:600;color:${pri.color};margin-bottom:6px;text-align:center">${pri.label} (${tasks.length})</div>`;
    tasks.slice(0,12).forEach(t=>{
      const today=new Date().toISOString().split('T')[0];
      const overdue=t.due&&t.due<today;
      h+=`<div onclick="document.getElementById('pri-board-panel').remove();openTaskDetail(${t.id})" style="padding:4px 6px;margin:3px 0;background:var(--bg-elevated);border-radius:4px;cursor:pointer;border-left:2px solid ${t.status==='in-progress'?'#3b82f6':'var(--border)'}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='var(--bg-elevated)'"><div style="font-size:9px;color:var(--text-primary)">${esc(t.title||'Untitled')}</div><div style="display:flex;gap:4px;font-size:7px;color:var(--text-muted);margin-top:2px">${t.status==='in-progress'?'<span style="color:#3b82f6">WIP</span>':''}${t.due?`<span style="color:${overdue?'#ef4444':'var(--text-muted)'}">${t.due.substring(5)}</span>`:''}</div></div>`;
    });
    if(tasks.length>12)h+=`<div style="font-size:8px;color:var(--text-muted);text-align:center;padding:4px">+${tasks.length-12} more</div>`;
    if(!tasks.length)h+='<div style="font-size:8px;color:var(--text-muted);text-align:center;padding:8px">No tasks</div>';
    h+='</div>';
  });
  h+='</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Priority Board (${active.length} active)</span><button onclick="document.getElementById('pri-board-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showWipConfig(){
  let panel=document.getElementById('wip-config-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='wip-config-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  if(!S._wipLimits)S._wipLimits={todo:0,'in-progress':5,done:0};
  const statuses=['todo','in-progress','done'];
  const statusLabels={todo:'To Do','in-progress':'In Progress',done:'Done'};
  const counts={};statuses.forEach(s=>{counts[s]=S.tasks.filter(t=>t.status===s).length;});
  let h='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Set WIP limits per column. 0 = unlimited. Board column turns red when over limit.</div>';
  statuses.forEach(s=>{
    const limit=S._wipLimits[s]||0;
    const count=counts[s];
    const over=limit>0&&count>limit;
    h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)"><span style="flex:1;font-size:11px;font-weight:600;color:var(--text-primary)">${statusLabels[s]}</span><span style="font-size:10px;color:${over?'#ef4444':'var(--text-muted)'}">${count} tasks</span><input type="number" min="0" value="${limit}" onchange="S._wipLimits['${s}']=parseInt(this.value)||0;save();showWipConfig()" style="width:50px;padding:4px 6px;background:var(--bg-surface);border:1px solid ${over?'#ef4444':'var(--border)'};border-radius:4px;color:var(--text-primary);font-size:11px;text-align:center">${over?'<span style="font-size:8px;color:#ef4444;font-weight:600">OVER</span>':''}</div>`;
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">WIP Limits</span><button onclick="document.getElementById('wip-config-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showDuplicateContent(){
  let panel=document.getElementById('dup-content-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='dup-content-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const items=S.content||[];
  const dupes=[];
  const checked=new Set();
  items.forEach((a,i)=>{
    if(checked.has(a.id)||!a.body)return;
    const aWords=a.body.toLowerCase().split(/\s+/).slice(0,20).join(' ');
    const matches=[];
    items.forEach((b,j)=>{
      if(j<=i||checked.has(b.id)||!b.body)return;
      const bWords=b.body.toLowerCase().split(/\s+/).slice(0,20).join(' ');
      if(aWords===bWords){matches.push(b);checked.add(b.id);}
      else{
        const aSet=new Set(aWords.split(' '));const bSet=new Set(bWords.split(' '));
        let overlap=0;aSet.forEach(w=>{if(bSet.has(w))overlap++;});
        const similarity=overlap/Math.max(aSet.size,bSet.size);
        if(similarity>0.7){matches.push({...b,similarity:Math.round(similarity*100)});checked.add(b.id);}
      }
    });
    if(matches.length){dupes.push({original:a,matches});}
  });
  let h=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">${dupes.length} duplicate groups found across ${items.length} content items</div>`;
  dupes.slice(0,15).forEach(group=>{
    h+=`<div style="padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:6px;border-left:2px solid #f59e0b"><div style="font-size:10px;color:var(--text-primary);margin-bottom:4px">${esc((group.original.body||'').substring(0,80))}</div><div style="font-size:8px;color:var(--text-muted);margin-bottom:4px">Original (ID: ${group.original.id})</div>`;
    group.matches.forEach(m=>{
      h+=`<div style="display:flex;align-items:center;gap:6px;padding:2px 6px;margin:2px 0"><span style="flex:1;font-size:9px;color:var(--text-muted)">${esc((m.body||'').substring(0,60))} ${m.similarity?'('+m.similarity+'% match)':''}</span><button onclick="S.content=S.content.filter(c=>c.id!==${m.id});save();showDuplicateContent()" style="padding:2px 6px;background:#ef4444;border:none;border-radius:3px;color:#fff;font-size:7px;cursor:pointer">Remove</button></div>`;
    });
    h+='</div>';
  });
  if(!dupes.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No duplicates found!</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Duplicate Content Finder</span><button onclick="document.getElementById('dup-content-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function exportTasksCSV(){
  const rows=[['ID','Title','Status','Priority','Project','Due','Estimate','Created','Description']];
  S.tasks.forEach(t=>{
    rows.push([t.id,'"'+(t.title||'').replace(/"/g,'""')+'"',t.status||'todo',t.priority||'p2','"'+(t.project||'')+'"',t.due||'',t.estimate||'',t.createdAt||'','"'+(t.description||'').replace(/"/g,'""').substring(0,200)+'"']);
  });
  const csv=rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='astra-tasks-'+new Date().toISOString().split('T')[0]+'.csv';
  a.click();
  toast('Exported '+S.tasks.length+' tasks as CSV');
}
function showInbox(){
  let panel=document.getElementById('inbox-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='inbox-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const unsortedTasks=S.tasks.filter(t=>!t.project&&t.status!=='done');
  const unsortedContent=S.content.filter(c=>!c.theme&&!c.project);
  const unsortedLinks=(S.links||[]).filter(l=>!l.category||l.category==='Uncategorized');
  const unsortedDocs=(S.docs||[]).filter(d=>!d.project);
  const total=unsortedTasks.length+unsortedContent.length+unsortedLinks.length+unsortedDocs.length;
  let h='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#06b6d4">${unsortedTasks.length}</div><div style="font-size:7px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${unsortedContent.length}</div><div style="font-size:7px;color:var(--text-muted)">Content</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#8b5cf6">${unsortedLinks.length}</div><div style="font-size:7px;color:var(--text-muted)">Links</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${unsortedDocs.length}</div><div style="font-size:7px;color:var(--text-muted)">Docs</div></div>`;
  h+='</div>';
  if(unsortedTasks.length){
    h+='<div style="font-size:10px;font-weight:600;color:#06b6d4;margin-bottom:4px">Unsorted Tasks</div>';
    unsortedTasks.slice(0,10).forEach(t=>{
      h+=`<div onclick="document.getElementById('inbox-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #06b6d4;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title||'Untitled')}</div>`;
    });
    h+='<div style="height:8px"></div>';
  }
  if(unsortedContent.length){
    h+='<div style="font-size:10px;font-weight:600;color:#f59e0b;margin-bottom:4px">Unsorted Content</div>';
    unsortedContent.slice(0,10).forEach(c=>{
      h+=`<div onclick="document.getElementById('inbox-panel').remove();openContentModal(${c.id})" style="padding:3px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #f59e0b;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc((c.body||'').substring(0,60))}</div>`;
    });
    h+='<div style="height:8px"></div>';
  }
  if(unsortedLinks.length){
    h+='<div style="font-size:10px;font-weight:600;color:#8b5cf6;margin-bottom:4px">Uncategorized Links</div>';
    unsortedLinks.slice(0,10).forEach(l=>{
      h+=`<div onclick="window.open('${(l.url||'').replace(/'/g,"\\'")}','_blank')" style="padding:3px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #8b5cf6;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(l.title||l.url||'Untitled')}</div>`;
    });
  }
  if(!total)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">Inbox empty! Everything is categorized.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Inbox (${total} unsorted)</span><button onclick="document.getElementById('inbox-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
var _sessionStart=Date.now();
function showSessionTimer(){
  const elapsed=Date.now()-_sessionStart;
  const mins=Math.floor(elapsed/60000);
  const hrs=Math.floor(mins/60);
  const m=mins%60;
  toast('Session time: '+(hrs?hrs+'h ':'')+(m)+'m');
}
var _undoStack=[];
function pushUndo(type,data){_undoStack.push({type,data,ts:Date.now()});if(_undoStack.length>50)_undoStack.shift();}
function globalUndo(){
  if(!_undoStack.length){toast('Nothing to undo');return;}
  const action=_undoStack.pop();
  if(action.type==='deleteTask'){S.tasks.push(action.data);save();renderTasks();toast('Task restored: '+action.data.title);}
  else if(action.type==='deleteContent'){S.content.push(action.data);save();renderContent();toast('Content restored');}
  else if(action.type==='deleteLink'){S.links.push(action.data);save();renderLinks();toast('Link restored: '+action.data.title);}
  else if(action.type==='statusChange'){const t=S.tasks.find(x=>x.id===action.data.id);if(t){t.status=action.data.oldStatus;save();renderTasks();toast('Status reverted');}}
  else{toast('Undo: '+action.type);}
}
function showFavorites(){
  let panel=document.getElementById('favorites-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='favorites-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const starredContent=S.content.filter(c=>c.starred);
  const pinnedContent=S.content.filter(c=>c.pinned&&!c.starred);
  const pinnedLinks=(S.links||[]).filter(l=>l.pinned);
  const total=starredContent.length+pinnedContent.length+pinnedLinks.length;
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">${starredContent.length}</div><div style="font-size:7px;color:var(--text-muted)">Starred</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${pinnedContent.length}</div><div style="font-size:7px;color:var(--text-muted)">Pinned Content</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#8b5cf6">${pinnedLinks.length}</div><div style="font-size:7px;color:var(--text-muted)">Pinned Links</div></div>`;
  h+='</div>';
  if(starredContent.length){
    h+='<div style="font-size:10px;font-weight:600;color:#f59e0b;margin-bottom:4px">Starred Content</div>';
    starredContent.forEach(c=>{
      h+=`<div onclick="document.getElementById('favorites-panel').remove();openContentModal(${c.id})" style="padding:4px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #f59e0b;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc((c.body||'').substring(0,70))}<span style="font-size:8px;color:var(--text-muted)"> ${c.type||''}</span></div>`;
    });
    h+='<div style="height:8px"></div>';
  }
  if(pinnedContent.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--accent);margin-bottom:4px">Pinned Content</div>';
    pinnedContent.slice(0,10).forEach(c=>{
      h+=`<div onclick="document.getElementById('favorites-panel').remove();openContentModal(${c.id})" style="padding:4px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid var(--accent);margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc((c.body||'').substring(0,70))}</div>`;
    });
    h+='<div style="height:8px"></div>';
  }
  if(pinnedLinks.length){
    h+='<div style="font-size:10px;font-weight:600;color:#8b5cf6;margin-bottom:4px">Pinned Links</div>';
    pinnedLinks.forEach(l=>{
      h+=`<div onclick="window.open('${(l.url||'').replace(/'/g,"\\'")}','_blank')" style="padding:4px 8px;font-size:10px;color:var(--text-primary);cursor:pointer;border-left:2px solid #8b5cf6;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(l.title||l.url)}</div>`;
    });
  }
  if(!total)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No favorites yet. Star or pin items to see them here.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Favorites (${total} items)</span><button onclick="document.getElementById('favorites-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showTasksByDueGroup(){
  let panel=document.getElementById('due-group-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='due-group-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);const tmrStr=tomorrow.toISOString().split('T')[0];
  const weekEnd=new Date();weekEnd.setDate(weekEnd.getDate()+7);const weekStr=weekEnd.toISOString().split('T')[0];
  const active=S.tasks.filter(t=>t.status!=='done');
  const overdue=active.filter(t=>t.due&&t.due<today);
  const todayTasks=active.filter(t=>t.due===today);
  const tomorrowTasks=active.filter(t=>t.due===tmrStr);
  const thisWeek=active.filter(t=>t.due&&t.due>tmrStr&&t.due<=weekStr);
  const later=active.filter(t=>t.due&&t.due>weekStr);
  const noDate=active.filter(t=>!t.due);
  function renderGroup(tasks,label,color){
    if(!tasks.length)return'';
    let h=`<div style="font-size:10px;font-weight:600;color:${color};margin-bottom:4px;padding-top:8px">${label} (${tasks.length})</div>`;
    tasks.forEach(t=>{
      const priColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-muted)';
      h+=`<div onclick="document.getElementById('due-group-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:3px 8px;cursor:pointer;border-left:2px solid ${color};margin:2px 0;font-size:10px" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="flex:1;color:var(--text-primary)">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:${priColor}">${(t.priority||'p2').toUpperCase()}</span>${t.due?`<span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">${t.due.substring(5)}</span>`:''}</div>`;
    });
    return h;
  }
  let h=renderGroup(overdue,'Overdue','#ef4444');
  h+=renderGroup(todayTasks,'Today','var(--accent)');
  h+=renderGroup(tomorrowTasks,'Tomorrow','#3b82f6');
  h+=renderGroup(thisWeek,'This Week','#8b5cf6');
  h+=renderGroup(later,'Later','#6b7280');
  h+=renderGroup(noDate,'No Due Date','var(--text-muted)');
  if(!active.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No active tasks</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Tasks by Due Date (${active.length})</span><button onclick="document.getElementById('due-group-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function quickConvertContentToTask(contentId){
  const c=S.content.find(x=>x.id===contentId);if(!c)return;
  const id=Date.now();
  S.tasks.unshift({id,title:(c.body||'').substring(0,80),description:c.body||'',status:'todo',priority:'p2',createdAt:new Date().toISOString(),project:c.theme||''});
  save();renderTasks();toast('Content converted to task');
}
function quickConvertTaskToContent(taskId){
  const t=S.tasks.find(x=>x.id===taskId);if(!t)return;
  const id=Date.now();
  S.content.unshift({id,body:(t.title||'')+(t.description?'\n\n'+t.description:''),type:'thought',theme:t.project||'',tags:['from-task'],createdAt:new Date().toISOString()});
  save();renderContent();toast('Task converted to content');
}
function toggleDeepFocus(){
  let overlay=document.getElementById('deep-focus-overlay');
  if(overlay){overlay.remove();document.body.style.overflow='';toast('Deep focus off');return;}
  overlay=document.createElement('div');overlay.id='deep-focus-overlay';
  overlay.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;background:rgba(0,0,0,0.85);pointer-events:none';
  overlay.innerHTML=`<div style="position:absolute;top:10px;right:10px;pointer-events:auto;padding:4px 10px;background:var(--accent);border-radius:4px;color:#000;font-size:10px;font-weight:600;cursor:pointer" onclick="document.getElementById('deep-focus-overlay').remove();document.body.style.overflow='';toast('Deep focus off')">Exit Focus</div>`;
  document.body.appendChild(overlay);
  const primary=document.getElementById('primary-panel');
  if(primary)primary.style.position='relative';
  toast('Deep focus ON - overlay dimming enabled');
}
function showEstimationReport(){
  let panel=document.getElementById('est-report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='est-report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const withEst=S.tasks.filter(t=>t.estimate&&t.timeSpent);
  const withEstOnly=S.tasks.filter(t=>t.estimate);
  function parseMinutes(est){
    if(!est)return 0;
    const h=est.match(/(\d+)h/);const m=est.match(/(\d+)m/);
    return(h?parseInt(h[1])*60:0)+(m?parseInt(m[1]):0)||(parseInt(est)||0);
  }
  let totalEstMin=0;let totalActMin=0;
  withEst.forEach(t=>{totalEstMin+=parseMinutes(t.estimate);totalActMin+=(t.timeSpent||0);});
  const accuracy=totalEstMin?Math.round(totalActMin/totalEstMin*100):0;
  let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--accent)">${withEstOnly.length}</div><div style="font-size:8px;color:var(--text-muted)">With Estimates</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#3b82f6">${withEst.length}</div><div style="font-size:8px;color:var(--text-muted)">With Both</div></div>`;
  h+=`<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:${accuracy>120?'#ef4444':accuracy>=80?'#22c55e':'#f59e0b'}">${accuracy}%</div><div style="font-size:8px;color:var(--text-muted)">Accuracy</div></div>`;
  h+='</div>';
  if(withEst.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Tasks with Both Estimate + Actual</div>';
    withEst.forEach(t=>{
      const estMin=parseMinutes(t.estimate);
      const ratio=estMin?Math.round((t.timeSpent||0)/estMin*100):0;
      const color=ratio>150?'#ef4444':ratio>=80?'#22c55e':'#f59e0b';
      h+=`<div onclick="document.getElementById('est-report-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:6px;padding:4px 8px;cursor:pointer;border-left:2px solid ${color};margin:2px 0;font-size:10px" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="flex:1;color:var(--text-primary)">${esc(t.title||'Untitled')}</span><span style="font-size:8px;color:var(--text-muted)">Est: ${t.estimate}</span><span style="font-size:8px;color:var(--text-muted)">Act: ${t.timeSpent}m</span><span style="font-size:8px;font-weight:600;color:${color}">${ratio}%</span></div>`;
    });
  }
  if(!withEst.length&&!withEstOnly.length)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No tasks with estimates yet. Add estimates in task detail.</div>';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Estimation Report</span><button onclick="document.getElementById('est-report-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showDataTools(){
  let panel=document.getElementById('data-tools-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='data-tools-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const sections=[
    {key:'tasks',label:'Tasks',count:S.tasks.length},
    {key:'content',label:'Content',count:S.content.length},
    {key:'docs',label:'Writer Docs',count:(S.docs||[]).length},
    {key:'links',label:'Links',count:(S.links||[]).length},
    {key:'focusSessions',label:'Focus Sessions',count:(S.focusSessions||[]).length},
    {key:'_habits',label:'Habits',count:(S._habits||[]).length},
    {key:'_snippets',label:'Snippets',count:(S._snippets||[]).length},
    {key:'_stickies',label:'Sticky Notes',count:(S._stickies||[]).length},
    {key:'_timeBlocks',label:'Time Blocks',count:(S._timeBlocks||[]).length},
    {key:'_clips',label:'Clipboard History',count:(S._clips||[]).length},
  ];
  const totalSize=(JSON.stringify(S).length/1024).toFixed(1);
  let h=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Total storage: ${totalSize}KB. Clear individual sections below.</div>`;
  sections.forEach(s=>{
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)"><span style="flex:1;font-size:10px;color:var(--text-primary)">${s.label}</span><span style="font-size:10px;color:var(--accent)">${s.count}</span><button onclick="if(confirm('Clear all ${s.label.toLowerCase()}? This cannot be undone.')){S.${s.key}=[];save();showDataTools();toast('${s.label} cleared')}" style="padding:2px 8px;background:#ef4444;border:none;border-radius:3px;color:#fff;font-size:8px;cursor:pointer">Clear</button></div>`;
  });
  h+=`<div style="margin-top:12px"><button onclick="if(confirm('Reset ALL data? This will clear everything!')){localStorage.removeItem('astra-state');location.reload()}" style="padding:6px 12px;background:#ef4444;border:none;border-radius:4px;color:#fff;font-size:10px;font-weight:600;cursor:pointer;width:100%">Factory Reset</button></div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Data Management</span><button onclick="document.getElementById('data-tools-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showThemeSwitcher(){
  let panel=document.getElementById('theme-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='theme-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const themes=[
    {name:'Cosmic (Default)',bg:'#050508',surface:'#0a0a0f',elevated:'#0f0f17',accent:'#4ade80',border:'#1a1a2e'},
    {name:'Ocean Depths',bg:'#030a12',surface:'#061420',elevated:'#0a1e2e',accent:'#06b6d4',border:'#0e2940'},
    {name:'Forest Night',bg:'#050a05',surface:'#0a140a',elevated:'#0f1e0f',accent:'#22c55e',border:'#1a2e1a'},
    {name:'Sunset',bg:'#0a0505',surface:'#140a08',elevated:'#1e0f0c',accent:'#f97316',border:'#2e1a14'},
    {name:'Royal Purple',bg:'#080510',surface:'#0e0a18',elevated:'#140f22',accent:'#a855f7',border:'#221a36'},
    {name:'Ember',bg:'#0a0404',surface:'#140808',elevated:'#1e0c0c',accent:'#ef4444',border:'#2e1414'},
  ];
  const current=S._theme||'Cosmic (Default)';
  let h='';
  themes.forEach(t=>{
    const isActive=current===t.name;
    h+=`<div onclick="applyTheme('${t.name}','${t.bg}','${t.surface}','${t.elevated}','${t.accent}','${t.border}')" style="display:flex;align-items:center;gap:10px;padding:10px;cursor:pointer;border-radius:6px;margin:2px 0;border:1px solid ${isActive?t.accent:'transparent'}" onmouseenter="this.style.background='${t.surface}'" onmouseleave="this.style.background='transparent'"><div style="display:flex;gap:2px"><span style="width:12px;height:12px;border-radius:3px;background:${t.bg}"></span><span style="width:12px;height:12px;border-radius:3px;background:${t.surface}"></span><span style="width:12px;height:12px;border-radius:3px;background:${t.accent}"></span></div><div style="flex:1"><div style="font-size:11px;font-weight:600;color:var(--text-primary)">${t.name}</div></div>${isActive?'<span style="font-size:10px;color:var(--accent);font-weight:600">Active</span>':''}</div>`;
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Theme Switcher</span><button onclick="document.getElementById('theme-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function applyTheme(name,bg,surface,elevated,accent,border){
  document.documentElement.style.setProperty('--bg-base',bg);
  document.documentElement.style.setProperty('--bg-surface',surface);
  document.documentElement.style.setProperty('--bg-elevated',elevated);
  document.documentElement.style.setProperty('--accent',accent);
  document.documentElement.style.setProperty('--border',border);
  S._theme=name;save();toast('Theme: '+name);showThemeSwitcher();
}
function generateStatusEmail(){
  const today=new Date().toISOString().split('T')[0];
  const weekAgo=new Date();weekAgo.setDate(weekAgo.getDate()-7);const weekStr=weekAgo.toISOString().split('T')[0];
  const completed=S.tasks.filter(t=>t.completedAt&&t.completedAt.split('T')[0]>=weekStr);
  const inProgress=S.tasks.filter(t=>t.status==='in-progress');
  const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
  const upNext=S.tasks.filter(t=>t.status==='todo'&&t.due&&t.due>=today&&t.due<=new Date(Date.now()+7*86400000).toISOString().split('T')[0]).sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  let email='Subject: Status Update - '+today+'\n\n';
  email+='Hi,\n\nHere is my weekly status update.\n\n';
  email+='COMPLETED ('+completed.length+'):\n';
  completed.forEach(t=>{email+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});
  email+='\nIN PROGRESS ('+inProgress.length+'):\n';
  inProgress.forEach(t=>{email+='- '+t.title+(t.project?' ['+t.project+']':'')+'\n';});
  if(overdue.length){email+='\nBLOCKERS/OVERDUE ('+overdue.length+'):\n';overdue.forEach(t=>{email+='- '+t.title+' (due '+t.due+')\n';});}
  email+='\nUP NEXT:\n';
  upNext.slice(0,5).forEach(t=>{email+='- '+t.title+' (due '+t.due+')\n';});
  email+='\nBest regards';
  navigator.clipboard.writeText(email);
  toast('Status email copied to clipboard');
}
function showMorningBriefing(){
  let panel=document.getElementById('morning-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='morning-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:85vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const todayLabel=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  const hour=new Date().getHours();
  const greeting=hour<12?'Good morning':hour<17?'Good afternoon':'Good evening';
  const todayTasks=S.tasks.filter(t=>t.due===today&&t.status!=='done');
  const overdue=S.tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
  const inProgress=S.tasks.filter(t=>t.status==='in-progress');
  const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);const yStr=yesterday.toISOString().split('T')[0];
  const doneYesterday=S.tasks.filter(t=>t.completedAt&&t.completedAt.split('T')[0]===yStr);
  const focusToday=(S.focusSessions||[]).filter(f=>f.date===today);
  const focusMin=focusToday.reduce((s,x)=>s+(x.duration||0),0);
  const todayContent=S.content.filter(c=>c.createdAt&&c.createdAt.split('T')[0]===today);
  const todayWords=todayContent.reduce((s,c)=>s+((c.body||'').split(/\s+/).length),0);
  let h=`<div style="font-size:12px;color:var(--accent);margin-bottom:4px;font-weight:600">${greeting}!</div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:16px">${todayLabel}</div>`;
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px">';
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:14px;font-weight:700;color:var(--accent)">${todayTasks.length}</div><div style="font-size:7px;color:var(--text-muted)">Due Today</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:14px;font-weight:700;color:#ef4444">${overdue.length}</div><div style="font-size:7px;color:var(--text-muted)">Overdue</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:14px;font-weight:700;color:#3b82f6">${inProgress.length}</div><div style="font-size:7px;color:var(--text-muted)">In Progress</div></div>`;
  h+=`<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:14px;font-weight:700;color:#22c55e">${doneYesterday.length}</div><div style="font-size:7px;color:var(--text-muted)">Done Y-day</div></div>`;
  h+='</div>';
  if(overdue.length){
    h+='<div style="font-size:10px;font-weight:600;color:#ef4444;margin-bottom:4px">Overdue Tasks</div>';
    overdue.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('morning-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid #ef4444;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title)} <span style="color:#ef4444">${t.due}</span></div>`;});
    h+='<div style="height:8px"></div>';
  }
  if(todayTasks.length){
    h+='<div style="font-size:10px;font-weight:600;color:var(--accent);margin-bottom:4px">Today\'s Tasks</div>';
    todayTasks.forEach(t=>{const pc=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-muted)';h+=`<div onclick="document.getElementById('morning-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid ${pc};margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title)} <span style="color:${pc};font-size:8px">${(t.priority||'p2').toUpperCase()}</span></div>`;});
    h+='<div style="height:8px"></div>';
  }
  if(inProgress.length){
    h+='<div style="font-size:10px;font-weight:600;color:#3b82f6;margin-bottom:4px">In Progress</div>';
    inProgress.slice(0,5).forEach(t=>{h+=`<div onclick="document.getElementById('morning-panel').remove();openTaskDetail(${t.id})" style="padding:3px 8px;font-size:9px;color:var(--text-primary);cursor:pointer;border-left:2px solid #3b82f6;margin:2px 0" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">${esc(t.title)}</div>`;});
  }
  h+=`<div style="margin-top:8px;display:flex;gap:8px;font-size:9px;color:var(--text-muted)"><span>Focus today: ${focusMin}m</span><span>Words today: ${todayWords}</span><span>Content: ${todayContent.length} items</span></div>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Morning Briefing</span><button onclick="document.getElementById('morning-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showShortcutCheatsheet(){
  let panel=document.getElementById('shortcut-cheat-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='shortcut-cheat-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const groups=[
    {name:'Navigation',shortcuts:[
      ['Cmd+K','Command Palette'],['Cmd+1-9','Switch to section 1-9'],
      ['Cmd+B / Cmd+E','Toggle sidebar'],['Cmd+\\\\','Toggle context panel'],
    ]},
    {name:'Tasks',shortcuts:[
      ['Cmd+Shift+T','New task from anywhere'],['Cmd+Shift+N','New task'],
      ['Cmd+Shift+D','Today view'],
    ]},
    {name:'Writer',shortcuts:[
      ['Cmd+Shift+W','Open Zen Writer'],['Cmd+S','Save all'],
      ['Cmd+Shift+F','Toggle focus mode'],
    ]},
    {name:'Quick Actions',shortcuts:[
      ['Cmd+Shift+E','Export current section'],
      ['Type "task: title"','Quick-create task in Cmd+K'],
      ['Type "note: text"','Quick-save note in Cmd+K'],
    ]},
  ];
  let h='';
  groups.forEach(g=>{
    h+=`<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--accent);margin-bottom:4px">${g.name}</div>`;
    g.shortcuts.forEach(([key,desc])=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:3px 0;font-size:10px"><kbd style="padding:2px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;font-family:var(--mono);font-size:9px;color:var(--accent);min-width:100px;text-align:center">${key}</kbd><span style="color:var(--text-primary)">${desc}</span></div>`;
    });
    h+='</div>';
  });
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Keyboard Shortcuts</span><button onclick="document.getElementById('shortcut-cheat-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>${h}`;
  document.body.appendChild(panel);
}
function showStreakTracker(){
  const now=new Date();const today=now.toISOString().split('T')[0];
  if(!S._streakData)S._streakData={lastActive:'',currentStreak:0,longestStreak:0,history:[]};
  const sd=S._streakData;
  if(sd.lastActive!==today){
    const yesterday=new Date(now);yesterday.setDate(yesterday.getDate()-1);
    const yStr=yesterday.toISOString().split('T')[0];
    if(sd.lastActive===yStr){sd.currentStreak++;} else if(sd.lastActive&&sd.lastActive!==today){sd.currentStreak=1;} else if(!sd.lastActive){sd.currentStreak=1;}
    sd.lastActive=today;if(sd.currentStreak>sd.longestStreak)sd.longestStreak=sd.currentStreak;
    if(!sd.history.includes(today))sd.history.push(today);
    if(sd.history.length>365)sd.history=sd.history.slice(-365);
    save();
  }
  const tasks=S.tasks||[];const content=S.content||[];
  const todayTasks=tasks.filter(t=>t.created&&t.created.startsWith(today)).length;
  const todayContent=content.filter(c=>c.created&&c.created.startsWith(today)).length;
  const totalDays=sd.history.length;
  const panel=document.createElement('div');panel.id='streak-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Streak Tracker</span><button onclick="document.getElementById('streak-tracker-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:var(--accent)">${sd.currentStreak}</div><div style="font-size:10px;color:var(--text-muted)">Current Streak</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:#f59e0b">${sd.longestStreak}</div><div style="font-size:10px;color:var(--text-muted)">Longest Streak</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:#8b5cf6">${totalDays}</div><div style="font-size:10px;color:var(--text-muted)">Total Active Days</div></div>`;
  h+=`</div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Today's Activity</div>`;
  h+=`<div style="display:flex;gap:16px"><span style="font-size:12px;color:var(--text-secondary)">Tasks created: <span style="color:var(--accent)">${todayTasks}</span></span>`;
  h+=`<span style="font-size:12px;color:var(--text-secondary)">Content added: <span style="color:var(--accent)">${todayContent}</span></span></div></div>`;
  const last30=[];for(let i=29;i>=0;i--){const d=new Date(now);d.setDate(d.getDate()-i);last30.push(d.toISOString().split('T')[0]);}
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Last 30 Days</div>`;
  h+=`<div style="display:flex;flex-wrap:wrap;gap:3px">`;
  last30.forEach(day=>{
    const active=sd.history.includes(day);
    h+=`<div title="${day}" style="width:14px;height:14px;border-radius:2px;background:${active?'var(--accent)':'var(--bg-base)'};opacity:${active?1:0.3}"></div>`;
  });
  h+=`</div></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentTemplates(){
  const templates=[
    {name:'Meeting Notes',body:'## Meeting: [Topic]\\n\\n**Date:** '+new Date().toLocaleDateString()+'\\n**Attendees:** \\n\\n### Agenda\\n1. \\n\\n### Discussion\\n\\n### Action Items\\n- [ ] \\n\\n### Next Steps\\n',theme:'meeting'},
    {name:'Project Brief',body:'## Project: [Name]\\n\\n**Objective:** \\n**Timeline:** \\n**Owner:** \\n\\n### Background\\n\\n### Requirements\\n1. \\n\\n### Success Criteria\\n- \\n\\n### Risks\\n- ',theme:'project'},
    {name:'Weekly Review',body:'## Week of '+new Date().toLocaleDateString()+'\\n\\n### Completed\\n- \\n\\n### In Progress\\n- \\n\\n### Blockers\\n- \\n\\n### Next Week Goals\\n1. \\n\\n### Reflection\\n',theme:'review'},
    {name:'Research Note',body:'## Research: [Topic]\\n\\n**Source:** \\n**Date:** '+new Date().toLocaleDateString()+'\\n\\n### Key Findings\\n1. \\n\\n### Quotes\\n> \\n\\n### My Analysis\\n\\n### Follow-up Questions\\n- ',theme:'research'},
    {name:'Decision Log',body:'## Decision: [Title]\\n\\n**Date:** '+new Date().toLocaleDateString()+'\\n**Status:** Decided / Pending\\n\\n### Context\\n\\n### Options Considered\\n1. **Option A:** \\n2. **Option B:** \\n\\n### Decision\\n\\n### Rationale\\n\\n### Impact\\n',theme:'decision'},
    {name:'Daily Journal',body:'## '+new Date().toLocaleDateString()+'\\n\\n### Gratitude\\n- \\n\\n### Top 3 Priorities\\n1. \\n2. \\n3. \\n\\n### Notes\\n\\n### End of Day Review\\n- What went well: \\n- What to improve: ',theme:'journal'},
  ];
  const panel=document.createElement('div');panel.id='content-templates-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Templates</span><button onclick="document.getElementById('content-templates-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:8px">`;
  templates.forEach((t,i)=>{
    h+=`<div onclick="applyContentTemplate(${i})" style="background:var(--bg-surface);padding:12px;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">`;
    h+=`<div style="font-size:12px;font-weight:600;color:var(--text-primary)">${t.name}</div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:4px">${t.body.replace(/\\n/g,' ').substring(0,80)}...</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  window._contentTemplates=templates;
}
function applyContentTemplate(idx){
  const templates=window._contentTemplates;if(!templates||!templates[idx])return;
  const t=templates[idx];
  const id='c_'+Date.now();
  const item={id,body:t.body.replace(/\\n/g,'\n'),theme:t.theme,tags:[t.theme,'template'],created:new Date().toISOString(),pinned:false,starred:false};
  if(!S.content)S.content=[];S.content.unshift(item);save();
  const p=document.getElementById('content-templates-panel');if(p)p.remove();
  switchSection('content');renderContent();
  showToast('Created from template: '+t.name);
}
function showBulkLinkChecker(){
  const links=S.links||[];
  if(!links.length){showToast('No links to check');return;}
  const panel=document.createElement('div');panel.id='link-checker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Link Health Checker</span><button onclick="document.getElementById('link-checker-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Checking ${links.length} links... (CORS may affect results)</div>`;
  h+=`<div id="link-check-results" style="display:grid;gap:6px">`;
  links.forEach(l=>{
    h+=`<div id="lc-${l.id}" style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<div style="width:10px;height:10px;border-radius:50%;background:#888;flex-shrink:0" id="lc-dot-${l.id}"></div>`;
    h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(l.title||l.url)}</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(l.url)}</div></div>`;
    h+=`<span style="font-size:9px;color:var(--text-muted)" id="lc-status-${l.id}">checking...</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  let ok=0,fail=0,unknown=0;
  links.forEach((l,i)=>{
    setTimeout(()=>{
      fetch(l.url,{method:'HEAD',mode:'no-cors',signal:AbortSignal.timeout(5000)}).then(()=>{
        const dot=document.getElementById('lc-dot-'+l.id);const st=document.getElementById('lc-status-'+l.id);
        if(dot)dot.style.background='#4ade80';if(st){st.textContent='reachable';st.style.color='#4ade80';}
        ok++;
      }).catch(()=>{
        const dot=document.getElementById('lc-dot-'+l.id);const st=document.getElementById('lc-status-'+l.id);
        if(dot)dot.style.background='#888';if(st){st.textContent='unknown';st.style.color='#888';}
        unknown++;
      });
    },i*200);
  });
}
function showReadingProgress(){
  const content=S.content||[];
  const statuses={unread:0,reading:0,done:0};
  content.forEach(c=>{const s=c._readStatus||'unread';statuses[s]=(statuses[s]||0)+1;});
  const total=content.length||1;
  const panel=document.createElement('div');panel.id='reading-progress-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Reading Progress</span><button onclick="document.getElementById('reading-progress-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#f59e0b">${statuses.unread}</div><div style="font-size:10px;color:var(--text-muted)">Unread</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#3b82f6">${statuses.reading}</div><div style="font-size:10px;color:var(--text-muted)">Reading</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--accent)">${statuses.done}</div><div style="font-size:10px;color:var(--text-muted)">Done</div></div>`;
  h+=`</div>`;
  const pctDone=Math.round((statuses.done/total)*100);
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:12px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">${pctDone}% completed</div>`;
  h+=`<div style="height:8px;background:var(--bg-base);border-radius:4px;overflow:hidden"><div style="height:100%;width:${pctDone}%;background:var(--accent);border-radius:4px;transition:width 0.3s"></div></div></div>`;
  const unread=content.filter(c=>!c._readStatus||c._readStatus==='unread').slice(0,10);
  if(unread.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Unread Items (${statuses.unread})</div>`;
    h+=`<div style="display:grid;gap:4px">`;
    unread.forEach(c=>{
      const preview=(c.body||'').substring(0,60);
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview||'(empty)')}</div></div>`;
      h+=`<button onclick="setReadStatus('${c.id}','reading')" style="font-size:9px;padding:2px 6px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:#3b82f6;cursor:pointer">Reading</button>`;
      h+=`<button onclick="setReadStatus('${c.id}','done')" style="font-size:9px;padding:2px 6px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer">Done</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function setReadStatus(id,status){
  const c=(S.content||[]).find(x=>x.id===id);if(!c)return;
  c._readStatus=status;save();
  const p=document.getElementById('reading-progress-panel');if(p)p.remove();
  showReadingProgress();
}
function showProjectTimeline(){
  const projects=S.projects||[];const tasks=S.tasks||[];
  const panel=document.createElement('div');panel.id='project-timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Project Timeline</span><button onclick="document.getElementById('project-timeline-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316'];
  projects.forEach((p,pi)=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    if(!pTasks.length)return;
    const dates=pTasks.filter(t=>t.due).map(t=>new Date(t.due).getTime()).filter(d=>!isNaN(d));
    const created=pTasks.filter(t=>t.created).map(t=>new Date(t.created).getTime()).filter(d=>!isNaN(d));
    const allDates=[...dates,...created].filter(d=>d>0);
    if(!allDates.length)return;
    const minD=Math.min(...allDates);const maxD=Math.max(...allDates);
    const rangeD=maxD-minD||86400000;
    const color=colors[pi%colors.length];
    const done=pTasks.filter(t=>t.status==='done').length;
    const pct=Math.round((done/pTasks.length)*100);
    h+=`<div style="margin-bottom:16px;background:var(--bg-surface);padding:12px;border-radius:8px;border-left:3px solid ${color}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">`;
    h+=`<span style="font-size:12px;font-weight:600;color:${color}">${esc(p.name)}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${done}/${pTasks.length} done (${pct}%)</span></div>`;
    h+=`<div style="position:relative;height:20px;background:var(--bg-base);border-radius:4px;overflow:hidden;margin-bottom:6px">`;
    pTasks.forEach(t=>{
      const d=t.due?new Date(t.due).getTime():(t.created?new Date(t.created).getTime():0);
      if(!d)return;
      const pos=Math.round(((d-minD)/rangeD)*100);
      const isDone=t.status==='done';
      h+=`<div title="${esc(t.title)}" style="position:absolute;left:${pos}%;top:3px;width:14px;height:14px;border-radius:50%;background:${isDone?color:'transparent'};border:2px solid ${color};transform:translateX(-50%);cursor:pointer;opacity:${isDone?1:0.6}"></div>`;
    });
    h+=`</div>`;
    h+=`<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted)"><span>${new Date(minD).toLocaleDateString()}</span><span>${new Date(maxD).toLocaleDateString()}</span></div>`;
    h+=`</div>`;
  });
  if(!h.includes('border-left'))h+=`<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:20px">No projects with dated tasks found</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function quickMath(expr){
  try{
    const sanitized=expr.replace(/[^0-9+\-*/.()% ]/g,'');
    if(!sanitized.trim())return null;
    const result=new Function('return '+sanitized)();
    if(typeof result==='number'&&isFinite(result))return result;
    return null;
  }catch(e){return null;}
}
function showFocusScore(){
  const now=new Date();const today=now.toISOString().split('T')[0];
  const tasks=S.tasks||[];const content=S.content||[];
  const todayDone=tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(today)).length;
  const todayCreated=content.filter(c=>c.created&&c.created.startsWith(today)).length;
  const focusSessions=(S._focusSessions||[]).filter(f=>f.date&&f.date.startsWith(today));
  const focusMins=focusSessions.reduce((a,f)=>a+(f.duration||0),0);
  const todayWords=content.filter(c=>c.created&&c.created.startsWith(today)).reduce((a,c)=>a+((c.body||'').split(/\s+/).filter(w=>w).length),0);
  let score=0;
  score+=Math.min(todayDone*15,45);
  score+=Math.min(todayCreated*10,30);
  score+=Math.min(Math.floor(focusMins/5),25);
  score+=Math.min(Math.floor(todayWords/100)*5,20);
  score=Math.min(score,100);
  const grade=score>=90?'A+':score>=80?'A':score>=70?'B':score>=60?'C':score>=40?'D':'F';
  const gradeColor=score>=80?'#4ade80':score>=60?'#f59e0b':'#ef4444';
  const panel=document.createElement('div');panel.id='focus-score-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:24px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Daily Focus Score</span><button onclick="document.getElementById('focus-score-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="text-align:center;margin-bottom:20px"><div style="font-size:64px;font-weight:800;color:${gradeColor}">${score}</div><div style="font-size:20px;font-weight:700;color:${gradeColor};margin-top:-8px">Grade: ${grade}</div></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${todayDone}</div><div style="font-size:9px;color:var(--text-muted)">Tasks Done (+15ea, max 45)</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#3b82f6">${todayCreated}</div><div style="font-size:9px;color:var(--text-muted)">Content Created (+10ea, max 30)</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">${focusMins}m</div><div style="font-size:9px;color:var(--text-muted)">Focus Time (+5/5min, max 25)</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#8b5cf6">${todayWords}</div><div style="font-size:9px;color:var(--text-muted)">Words Written (+5/100w, max 20)</div></div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showArchiveBrowser(){
  const archived=S._archivedTasks||[];
  const panel=document.createElement('div');panel.id='archive-browser-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Archive Browser (${archived.length} tasks)</span><button onclick="document.getElementById('archive-browser-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!archived.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No archived tasks. Use "Archive Done" in the task toolbar to archive completed tasks.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    archived.slice(0,50).forEach(t=>{
      const date=t.created?new Date(t.created).toLocaleDateString():'';
      const pColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;border-left:3px solid ${pColor}">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.title)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${t.priority||'p3'} | ${date}</div></div>`;
      h+=`<button onclick="restoreArchivedTask('${t.id}')" style="font-size:9px;padding:3px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer">Restore</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function restoreArchivedTask(id){
  const archived=S._archivedTasks||[];const idx=archived.findIndex(t=>t.id===id);
  if(idx===-1)return;
  const task=archived.splice(idx,1)[0];task.status='todo';
  if(!S.tasks)S.tasks=[];S.tasks.unshift(task);save();
  const p=document.getElementById('archive-browser-panel');if(p)p.remove();
  showArchiveBrowser();showToast('Task restored: '+task.title);
}
function showContentWordCloud(){
  const content=S.content||[];const docs=(S.writerDocs||[]);
  let allText='';
  content.forEach(c=>{allText+=' '+(c.body||'');});
  docs.forEach(d=>{allText+=' '+(d.body||'');});
  const stops=new Set(['the','a','an','and','or','but','in','on','at','to','for','of','is','it','that','this','was','are','be','has','had','have','with','as','by','from','not','will','can','would','could','should','all','their','there','been','its','my','your','our','they','them','we','he','she','you','i','do','did','so','if','no','up','out','one','about','what','which','when','how','who','more','than','just','also','into','over','such','after','then','any','only','these','some','other','new','like','very','may','most','even']);
  const words=allText.toLowerCase().replace(/[^a-z\s]/g,' ').split(/\s+/).filter(w=>w.length>2&&!stops.has(w));
  const freq={};words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,60);
  if(!sorted.length){showToast('No content to analyze');return;}
  const maxFreq=sorted[0][1];
  const cloudColors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316','#a855f7','#22d3ee'];
  const panel=document.createElement('div');panel.id='content-wordcloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Word Cloud (${sorted.length} words)</span><button onclick="document.getElementById('content-wordcloud-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;padding:16px;background:var(--bg-surface);border-radius:8px;margin-bottom:12px">`;
  sorted.forEach(([word,count],i)=>{
    const size=Math.max(10,Math.round((count/maxFreq)*32));
    const color=cloudColors[i%cloudColors.length];
    h+=`<span title="${count} occurrences" style="font-size:${size}px;color:${color};padding:2px 4px;cursor:default;line-height:1.3">${word}</span>`;
  });
  h+=`</div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center">${words.length} total words analyzed from ${content.length} content items + ${docs.length} docs</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showHabitTracker(){
  if(!S._habits)S._habits=[];
  const habits=S._habits;
  const today=new Date().toISOString().split('T')[0];
  const panel=document.createElement('div');panel.id='habit-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Habit Tracker</span><div><button onclick="addHabit()" style="font-size:10px;padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600;margin-right:8px">+ Habit</button><button onclick="document.getElementById('habit-tracker-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  if(!habits.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No habits yet. Click "+ Habit" to start tracking.</div>`;
  } else {
    h+=`<div style="display:grid;gap:8px">`;
    habits.forEach((hab,i)=>{
      const checkedToday=hab.history&&hab.history.includes(today);
      let streak=0;
      if(hab.history&&hab.history.length){
        const sorted=[...hab.history].sort().reverse();
        const d=new Date();
        for(let j=0;j<sorted.length;j++){
          const expected=new Date(d);expected.setDate(expected.getDate()-j);
          const eStr=expected.toISOString().split('T')[0];
          if(sorted[j]===eStr)streak++;else break;
        }
      }
      h+=`<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${checkedToday?'var(--accent)':'var(--border)'}">`;
      h+=`<button onclick="toggleHabitDay(${i})" style="width:24px;height:24px;border-radius:4px;border:2px solid ${checkedToday?'var(--accent)':'var(--border)'};background:${checkedToday?'var(--accent)':'transparent'};cursor:pointer;display:flex;align-items:center;justify-content:center;color:#000;font-size:14px;font-weight:700">${checkedToday?'v':''}</button>`;
      h+=`<div style="flex:1"><div style="font-size:12px;font-weight:600;color:var(--text-primary)">${esc(hab.name)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${streak} day streak | ${(hab.history||[]).length} total</div></div>`;
      h+=`<button onclick="deleteHabit(${i})" style="font-size:14px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  const last7=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);last7.push(d.toISOString().split('T')[0]);}
  if(habits.length){
    h+=`<div style="margin-top:12px;background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Last 7 Days</div>`;
    h+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center">`;
    last7.forEach(d=>{
      const dayName=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(d).getDay()];
      const completed=habits.filter(hab=>(hab.history||[]).includes(d)).length;
      const pct=Math.round((completed/habits.length)*100);
      const color=pct>=80?'var(--accent)':pct>=50?'#f59e0b':pct>0?'#ef4444':'var(--bg-base)';
      h+=`<div><div style="font-size:8px;color:var(--text-muted)">${dayName}</div><div style="width:20px;height:20px;border-radius:4px;background:${color};margin:2px auto;opacity:${pct>0?1:0.3}"></div><div style="font-size:8px;color:var(--text-muted)">${completed}/${habits.length}</div></div>`;
    });
    h+=`</div></div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function addHabit(){
  const name=prompt('Habit name:');if(!name||!name.trim())return;
  if(!S._habits)S._habits=[];
  S._habits.push({name:name.trim(),history:[],created:new Date().toISOString()});
  save();const p=document.getElementById('habit-tracker-panel');if(p)p.remove();showHabitTracker();
}
function toggleHabitDay(idx){
  const hab=S._habits[idx];if(!hab)return;
  if(!hab.history)hab.history=[];
  const today=new Date().toISOString().split('T')[0];
  const i=hab.history.indexOf(today);
  if(i>=0)hab.history.splice(i,1);else hab.history.push(today);
  save();const p=document.getElementById('habit-tracker-panel');if(p)p.remove();showHabitTracker();
}
function deleteHabit(idx){
  if(!confirm('Delete this habit?'))return;
  S._habits.splice(idx,1);save();
  const p=document.getElementById('habit-tracker-panel');if(p)p.remove();showHabitTracker();
}
function showKnowledgeGraphStats(){
  const specs=[];(S.projects||[]).forEach(p=>{(p.specs||[]).forEach(s=>{specs.push(s);});});
  let totalLinks=0;const linkMap={};
  specs.forEach(s=>{
    (s.sections||[]).forEach(sec=>{
      const matches=(sec.body||'').match(/\[\[([^\]]+)\]\]/g)||[];
      totalLinks+=matches.length;
      matches.forEach(m=>{const name=m.replace(/[\[\]]/g,'');linkMap[name]=(linkMap[name]||0)+1;});
    });
  });
  const content=S.content||[];
  content.forEach(c=>{
    const matches=(c.body||'').match(/\[\[([^\]]+)\]\]/g)||[];
    totalLinks+=matches.length;
    matches.forEach(m=>{const name=m.replace(/[\[\]]/g,'');linkMap[name]=(linkMap[name]||0)+1;});
  });
  const topLinks=Object.entries(linkMap).sort((a,b)=>b[1]-a[1]).slice(0,15);
  const panel=document.createElement('div');panel.id='kg-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Knowledge Graph Stats</span><button onclick="document.getElementById('kg-stats-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--accent)">${totalLinks}</div><div style="font-size:10px;color:var(--text-muted)">Wiki-Links</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#3b82f6">${Object.keys(linkMap).length}</div><div style="font-size:10px;color:var(--text-muted)">Unique Targets</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#8b5cf6">${specs.length}</div><div style="font-size:10px;color:var(--text-muted)">Living Docs</div></div>`;
  h+=`</div>`;
  if(topLinks.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Most Referenced</div>`;
    h+=`<div style="display:grid;gap:4px">`;
    const max=topLinks[0][1];
    topLinks.forEach(([name,count])=>{
      const pct=Math.round((count/max)*100);
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary)">${esc(name)}</div>`;
      h+=`<div style="height:3px;background:var(--bg-base);border-radius:2px;margin-top:3px"><div style="height:100%;width:${pct}%;background:var(--accent);border-radius:2px"></div></div></div>`;
      h+=`<span style="font-size:10px;color:var(--text-muted);flex-shrink:0">${count}</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showRandomContent(){
  const content=S.content||[];
  if(!content.length){showToast('No content to pick from');return;}
  const item=content[Math.floor(Math.random()*content.length)];
  const words=(item.body||'').split(/\s+/).filter(w=>w).length;
  const date=item.created?new Date(item.created).toLocaleDateString():'Unknown';
  const panel=document.createElement('div');panel.id='random-content-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Random Content</span><div><button onclick="document.getElementById('random-content-panel').remove();showRandomContent()" style="font-size:10px;padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600;margin-right:8px">Shuffle</button><button onclick="document.getElementById('random-content-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  h+=`<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">`;
  if(item.theme)h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-surface);border-radius:10px;color:var(--accent)">${esc(item.theme)}</span>`;
  h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-surface);border-radius:10px;color:var(--text-muted)">${date}</span>`;
  h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-surface);border-radius:10px;color:var(--text-muted)">${words} words</span>`;
  (item.tags||[]).forEach(t=>{h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-surface);border-radius:10px;color:#8b5cf6">${esc(t)}</span>`;});
  h+=`</div>`;
  h+=`<div style="background:var(--bg-surface);padding:16px;border-radius:8px;font-size:12px;color:var(--text-secondary);line-height:1.7;white-space:pre-wrap;max-height:400px;overflow-y:auto">${esc(item.body||'(empty)')}</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
var _clipboardHistory=[];
function trackClipboard(text,source){
  if(!text||!text.trim())return;
  _clipboardHistory.unshift({text:text.substring(0,500),source:source||'copy',ts:Date.now()});
  if(_clipboardHistory.length>50)_clipboardHistory.length=50;
}
function showClipboardHistory(){
  const panel=document.createElement('div');panel.id='clipboard-history-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Clipboard History (${_clipboardHistory.length})</span><button onclick="document.getElementById('clipboard-history-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!_clipboardHistory.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No clipboard history yet. Copy text within ASTRA to track it here.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    _clipboardHistory.forEach((item,i)=>{
      const ago=Math.round((Date.now()-item.ts)/60000);
      const timeStr=ago<1?'Just now':ago<60?ago+'m ago':Math.round(ago/60)+'h ago';
      h+=`<div style="padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s" onclick="navigator.clipboard.writeText(_clipboardHistory[${i}].text);showToast('Copied')" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">`;
      h+=`<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:9px;color:var(--accent)">${item.source}</span><span style="font-size:9px;color:var(--text-muted)">${timeStr}</span></div>`;
      h+=`<div style="font-size:11px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(item.text)}</div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTimeZoneClock(){
  const zones=[
    {name:'Local',tz:Intl.DateTimeFormat().resolvedOptions().timeZone},
    {name:'New York',tz:'America/New_York'},
    {name:'London',tz:'Europe/London'},
    {name:'Tokyo',tz:'Asia/Tokyo'},
    {name:'Sydney',tz:'Australia/Sydney'},
    {name:'Dubai',tz:'Asia/Dubai'},
  ];
  const panel=document.createElement('div');panel.id='timezone-clock-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw';
  function updateClocks(){
    const now=new Date();
    let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">World Clock</span><button onclick="clearInterval(window._tzInterval);document.getElementById('timezone-clock-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
    h+=`<div style="display:grid;gap:8px">`;
    zones.forEach(z=>{
      const time=now.toLocaleTimeString('en-US',{timeZone:z.tz,hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const date=now.toLocaleDateString('en-US',{timeZone:z.tz,weekday:'short',month:'short',day:'numeric'});
      const hour=parseInt(now.toLocaleTimeString('en-US',{timeZone:z.tz,hour:'numeric',hour12:false}));
      const isNight=hour<6||hour>=21;
      h+=`<div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg-surface);border-radius:8px">`;
      h+=`<div style="width:8px;height:8px;border-radius:50%;background:${isNight?'#6366f1':'#f59e0b'};flex-shrink:0"></div>`;
      h+=`<div style="flex:1"><div style="font-size:11px;font-weight:600;color:var(--text-primary)">${z.name}</div><div style="font-size:9px;color:var(--text-muted)">${date}</div></div>`;
      h+=`<div style="font-size:16px;font-weight:700;color:var(--accent);font-family:monospace">${time}</div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
    panel.innerHTML=h;
  }
  updateClocks();
  window._tzInterval=setInterval(updateClocks,1000);
  document.body.appendChild(panel);
}
function showContentDiff(){
  const content=S.content||[];
  if(content.length<2){showToast('Need at least 2 content items to compare');return;}
  const panel=document.createElement('div');panel.id='content-diff-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Diff Viewer</span><button onclick="document.getElementById('content-diff-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">`;
  h+=`<div><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">Left</label><select id="diff-left" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px">`;
  content.slice(0,30).forEach((c,i)=>{
    const preview=(c.body||'').substring(0,40).replace(/\n/g,' ');
    h+=`<option value="${i}">${esc(preview||'(empty)')}</option>`;
  });
  h+=`</select></div>`;
  h+=`<div><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">Right</label><select id="diff-right" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px">`;
  content.slice(0,30).forEach((c,i)=>{
    const preview=(c.body||'').substring(0,40).replace(/\n/g,' ');
    h+=`<option value="${i}" ${i===1?'selected':''}>${esc(preview||'(empty)')}</option>`;
  });
  h+=`</select></div></div>`;
  h+=`<button onclick="runContentDiff()" style="width:100%;padding:8px;background:var(--accent);border:none;border-radius:4px;color:#000;font-weight:600;cursor:pointer;font-size:11px;margin-bottom:12px">Compare</button>`;
  h+=`<div id="diff-result" style="font-size:11px;color:var(--text-secondary)"></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function runContentDiff(){
  const content=S.content||[];
  const leftIdx=parseInt(document.getElementById('diff-left').value);
  const rightIdx=parseInt(document.getElementById('diff-right').value);
  const left=(content[leftIdx]&&content[leftIdx].body)||'';
  const right=(content[rightIdx]&&content[rightIdx].body)||'';
  const leftLines=left.split('\n');const rightLines=right.split('\n');
  let html='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  html+='<div style="background:var(--bg-surface);padding:10px;border-radius:6px;max-height:300px;overflow-y:auto">';
  leftLines.forEach(line=>{
    const inRight=rightLines.includes(line);
    html+=`<div style="font-size:10px;padding:2px 4px;color:${inRight?'var(--text-secondary)':'#ef4444'};background:${inRight?'transparent':'rgba(239,68,68,0.1)'};border-radius:2px;font-family:monospace;white-space:pre-wrap">${esc(line)||'&nbsp;'}</div>`;
  });
  html+='</div>';
  html+='<div style="background:var(--bg-surface);padding:10px;border-radius:6px;max-height:300px;overflow-y:auto">';
  rightLines.forEach(line=>{
    const inLeft=leftLines.includes(line);
    html+=`<div style="font-size:10px;padding:2px 4px;color:${inLeft?'var(--text-secondary)':'#4ade80'};background:${inLeft?'transparent':'rgba(74,222,128,0.1)'};border-radius:2px;font-family:monospace;white-space:pre-wrap">${esc(line)||'&nbsp;'}</div>`;
  });
  html+='</div></div>';
  const leftWords=new Set(left.toLowerCase().split(/\s+/));const rightWords=new Set(right.toLowerCase().split(/\s+/));
  const shared=[...leftWords].filter(w=>rightWords.has(w)).length;
  const total=new Set([...leftWords,...rightWords]).size||1;
  const similarity=Math.round((shared/total)*100);
  html+=`<div style="margin-top:8px;font-size:10px;color:var(--text-muted);text-align:center">Similarity: ${similarity}% | Red = only in left | Green = only in right</div>`;
  document.getElementById('diff-result').innerHTML=html;
}
function downloadWorkspaceBackup(){
  const data=JSON.parse(JSON.stringify(S));
  data._backupDate=new Date().toISOString();
  data._version='astra-backup-v1';
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='astra-backup-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();URL.revokeObjectURL(url);
  showToast('Workspace backup downloaded');
}
function uploadWorkspaceBackup(){
  const input=document.createElement('input');input.type='file';input.accept='.json';
  input.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data._version||data._version!=='astra-backup-v1'){
          if(!confirm('This does not look like an ASTRA backup. Import anyway?'))return;
        }
        if(!confirm('This will REPLACE all current data. Are you sure?'))return;
        delete data._backupDate;delete data._version;
        Object.assign(S,data);save();location.reload();
      }catch(err){showToast('Invalid JSON file');}
    };
    reader.readAsText(f);
  };
  input.click();
}
function showWorkspaceBackupPanel(){
  const panel=document.createElement('div');panel.id='backup-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const size=new Blob([JSON.stringify(S)]).size;
  const sizeKB=Math.round(size/1024);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Workspace Backup</span><button onclick="document.getElementById('backup-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:16px">Current workspace: ${sizeKB} KB</div>`;
  h+=`<div style="display:grid;gap:10px">`;
  h+=`<button onclick="document.getElementById('backup-panel').remove();downloadWorkspaceBackup()" style="padding:12px;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:600;cursor:pointer;font-size:12px">Download Backup (.json)</button>`;
  h+=`<button onclick="document.getElementById('backup-panel').remove();uploadWorkspaceBackup()" style="padding:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-weight:600;cursor:pointer;font-size:12px">Restore from Backup</button>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskBurnup(){
  const tasks=S.tasks||[];
  const weeks=12;const now=new Date();
  const weekData=[];
  for(let w=weeks-1;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-w*7);
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+7);
    const wStr=weekStart.toISOString().split('T')[0];
    const created=tasks.filter(t=>t.created&&t.created>=wStr&&t.created<weekEnd.toISOString().split('T')[0]).length;
    const completed=tasks.filter(t=>t.status==='done'&&t.created&&t.created<=weekEnd.toISOString().split('T')[0]).length;
    weekData.push({label:weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'}),created,completed});
  }
  let cumCreated=0,cumCompleted=0;
  weekData.forEach(w=>{cumCreated+=w.created;w.cumCreated=cumCreated;cumCompleted+=w.completed;w.cumCompleted=cumCompleted;});
  const maxVal=Math.max(cumCreated,cumCompleted,1);
  const panel=document.createElement('div');panel.id='burnup-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Burnup Chart (12 weeks)</span><button onclick="document.getElementById('burnup-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const svgW=600,svgH=200,pad=40;
  h+=`<svg viewBox="0 0 ${svgW} ${svgH+30}" style="width:100%;background:var(--bg-surface);border-radius:8px;padding:8px">`;
  for(let i=0;i<=4;i++){
    const y=pad+(svgH-pad*2)*(1-i/4);
    const val=Math.round(maxVal*i/4);
    h+=`<line x1="${pad}" y1="${y}" x2="${svgW-10}" y2="${y}" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>`;
    h+=`<text x="${pad-5}" y="${y+4}" text-anchor="end" fill="rgba(255,255,255,0.3)" font-size="9">${val}</text>`;
  }
  let createdPath='',completedPath='';
  weekData.forEach((w,i)=>{
    const x=pad+i*((svgW-pad-10)/(weeks-1));
    const yC=pad+(svgH-pad*2)*(1-w.cumCreated/maxVal);
    const yD=pad+(svgH-pad*2)*(1-w.cumCompleted/maxVal);
    createdPath+=(i===0?'M':'L')+x+','+yC;
    completedPath+=(i===0?'M':'L')+x+','+yD;
    if(i%2===0)h+=`<text x="${x}" y="${svgH+15}" text-anchor="middle" fill="rgba(255,255,255,0.3)" font-size="8">${w.label}</text>`;
  });
  h+=`<path d="${createdPath}" fill="none" stroke="#3b82f6" stroke-width="2"/>`;
  h+=`<path d="${completedPath}" fill="none" stroke="#4ade80" stroke-width="2"/>`;
  weekData.forEach((w,i)=>{
    const x=pad+i*((svgW-pad-10)/(weeks-1));
    const yC=pad+(svgH-pad*2)*(1-w.cumCreated/maxVal);
    const yD=pad+(svgH-pad*2)*(1-w.cumCompleted/maxVal);
    h+=`<circle cx="${x}" cy="${yC}" r="3" fill="#3b82f6"/>`;
    h+=`<circle cx="${x}" cy="${yD}" r="3" fill="#4ade80"/>`;
  });
  h+=`</svg>`;
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:10px">`;
  h+=`<span style="color:#3b82f6">Created (${cumCreated})</span>`;
  h+=`<span style="color:#4ade80">Completed (${cumCompleted})</span>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentMetrics(){
  const content=S.content||[];const docs=S.writerDocs||[];
  let allText='';
  content.forEach(c=>{allText+=' '+(c.body||'');});
  docs.forEach(d=>{allText+=' '+(d.body||'');});
  const words=allText.split(/\s+/).filter(w=>w);
  const sentences=allText.split(/[.!?]+/).filter(s=>s.trim());
  const uniqueWords=new Set(words.map(w=>w.toLowerCase()));
  const avgSentLen=sentences.length?Math.round(words.length/sentences.length):0;
  const syllableCount=w=>{w=w.toLowerCase();if(w.length<=3)return 1;w=w.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/,'');w=w.replace(/^y/,'');const m=w.match(/[aeiouy]{1,2}/g);return m?m.length:1;};
  const totalSyllables=words.reduce((a,w)=>a+syllableCount(w),0);
  const fleschKincaid=sentences.length?Math.round(206.835-1.015*(words.length/sentences.length)-84.6*(totalSyllables/words.length)):0;
  const readability=fleschKincaid>=60?'Easy':fleschKincaid>=30?'Moderate':'Difficult';
  const readColor=fleschKincaid>=60?'#4ade80':fleschKincaid>=30?'#f59e0b':'#ef4444';
  const vocabRichness=words.length?Math.round((uniqueWords.size/words.length)*100):0;
  const panel=document.createElement('div');panel.id='content-metrics-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Metrics</span><button onclick="document.getElementById('content-metrics-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--accent)">${words.length.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted)">Total Words</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#3b82f6">${uniqueWords.size.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted)">Unique Words</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:${readColor}">${fleschKincaid}</div><div style="font-size:10px;color:var(--text-muted)">Flesch-Kincaid (${readability})</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#8b5cf6">${avgSentLen}</div><div style="font-size:10px;color:var(--text-muted)">Avg Sentence Length</div></div>`;
  h+=`</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#f59e0b">${vocabRichness}%</div><div style="font-size:9px;color:var(--text-muted)">Vocab Richness</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#ec4899">${sentences.length}</div><div style="font-size:9px;color:var(--text-muted)">Sentences</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#06b6d4">${content.length+docs.length}</div><div style="font-size:9px;color:var(--text-muted)">Total Items</div></div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMarkdownPreview(text){
  if(!text){
    const content=S.content||[];
    if(!content.length){showToast('No content to preview');return;}
    text=content[0].body||'';
  }
  let html=esc(text);
  html=html.replace(/^### (.+)$/gm,'<h3 style="color:var(--text-primary);margin:12px 0 6px">$1</h3>');
  html=html.replace(/^## (.+)$/gm,'<h2 style="color:var(--text-primary);margin:16px 0 8px;font-size:16px">$1</h2>');
  html=html.replace(/^# (.+)$/gm,'<h1 style="color:var(--text-primary);margin:20px 0 10px;font-size:20px">$1</h1>');
  html=html.replace(/\*\*(.+?)\*\*/g,'<strong style="color:var(--text-primary)">$1</strong>');
  html=html.replace(/\*(.+?)\*/g,'<em>$1</em>');
  html=html.replace(/`(.+?)`/g,'<code style="background:var(--bg-base);padding:1px 4px;border-radius:3px;font-size:11px">$1</code>');
  html=html.replace(/^- (.+)$/gm,'<li style="margin:2px 0;margin-left:16px">$1</li>');
  html=html.replace(/^\d+\. (.+)$/gm,'<li style="margin:2px 0;margin-left:16px;list-style-type:decimal">$1</li>');
  html=html.replace(/^&gt; (.+)$/gm,'<blockquote style="border-left:3px solid var(--accent);padding-left:12px;margin:8px 0;color:var(--text-muted);font-style:italic">$1</blockquote>');
  html=html.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid var(--border);margin:12px 0">');
  html=html.replace(/\n/g,'<br>');
  const panel=document.createElement('div');panel.id='md-preview-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h2=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Markdown Preview</span><button onclick="document.getElementById('md-preview-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h2+=`<div style="background:var(--bg-surface);padding:16px;border-radius:8px;font-size:12px;color:var(--text-secondary);line-height:1.8">${html}</div>`;
  panel.innerHTML=h2;document.body.appendChild(panel);
}
function showTaskCompletionHeatmap(){
  const tasks=S.tasks||[];
  const now=new Date();
  const dayMap={};
  tasks.forEach(t=>{
    if(t.status==='done'&&t.created){
      const day=t.created.split('T')[0];dayMap[day]=(dayMap[day]||0)+1;
    }
  });
  const panel=document.createElement('div');panel.id='task-completion-heatmap';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Completion Heatmap (6 months)</span><button onclick="document.getElementById('task-completion-heatmap').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const weeks=26;
  h+=`<div style="display:flex;gap:2px;flex-wrap:nowrap;overflow-x:auto;padding:4px">`;
  for(let w=weeks-1;w>=0;w--){
    h+=`<div style="display:flex;flex-direction:column;gap:2px">`;
    for(let d=0;d<7;d++){
      const date=new Date(now);date.setDate(date.getDate()-(w*7+6-d));
      const dateStr=date.toISOString().split('T')[0];
      const count=dayMap[dateStr]||0;
      const color=count===0?'rgba(255,255,255,0.05)':count===1?'#1a4731':count===2?'#166534':count>=3?'#4ade80':'#86efac';
      h+=`<div title="${dateStr}: ${count} completed" style="width:10px;height:10px;border-radius:2px;background:${color}"></div>`;
    }
    h+=`</div>`;
  }
  h+=`</div>`;
  const totalDone=Object.values(dayMap).reduce((a,b)=>a+b,0);
  const activeDays=Object.keys(dayMap).length;
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:12px;font-size:10px;color:var(--text-muted)">`;
  h+=`<span>Total completed: <span style="color:var(--accent)">${totalDone}</span></span>`;
  h+=`<span>Active days: <span style="color:var(--accent)">${activeDays}</span></span>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showSavedSearches(){
  if(!S._savedSearches)S._savedSearches=[];
  const searches=S._savedSearches;
  const panel=document.createElement('div');panel.id='saved-searches-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Saved Searches (${searches.length})</span><div><button onclick="addSavedSearch()" style="font-size:10px;padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600;margin-right:8px">+ Save</button><button onclick="document.getElementById('saved-searches-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  if(!searches.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No saved searches. Click "+ Save" to add a search query.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    searches.forEach((s,i)=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'" onclick="document.getElementById('saved-searches-panel').remove();openCommandPalette();setTimeout(()=>{const inp=document.getElementById('cmd-input');if(inp){inp.value='${esc(s.query)}';inp.dispatchEvent(new Event('input'));}},100)">`;
      h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary)">${esc(s.query)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${s.created?new Date(s.created).toLocaleDateString():''}</div></div>`;
      h+=`<button onclick="event.stopPropagation();deleteSavedSearch(${i})" style="font-size:14px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function addSavedSearch(){
  const query=prompt('Search query to save:');if(!query||!query.trim())return;
  if(!S._savedSearches)S._savedSearches=[];
  S._savedSearches.push({query:query.trim(),created:new Date().toISOString()});
  save();const p=document.getElementById('saved-searches-panel');if(p)p.remove();showSavedSearches();
}
function deleteSavedSearch(idx){
  S._savedSearches.splice(idx,1);save();
  const p=document.getElementById('saved-searches-panel');if(p)p.remove();showSavedSearches();
}
function showStaleContent(){
  const content=S.content||[];const now=Date.now();const threshold=30*86400000;
  const stale=content.filter(c=>{
    const created=c.created?new Date(c.created).getTime():0;
    return created>0&&(now-created)>threshold;
  }).sort((a,b)=>new Date(a.created)-new Date(b.created));
  const panel=document.createElement('div');panel.id='stale-content-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Stale Content (${stale.length} items, 30+ days old)</span><button onclick="document.getElementById('stale-content-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!stale.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No stale content found. All content is less than 30 days old.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    stale.slice(0,30).forEach(c=>{
      const age=Math.round((now-new Date(c.created).getTime())/86400000);
      const preview=(c.body||'').substring(0,60);
      const ageColor=age>90?'#ef4444':age>60?'#f59e0b':'#f97316';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;border-left:3px solid ${ageColor}">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview||'(empty)')}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${c.theme||'no theme'} | ${(c.tags||[]).join(', ')||'no tags'}</div></div>`;
      h+=`<span style="font-size:10px;font-weight:600;color:${ageColor};flex-shrink:0">${age}d</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
var _quickTimerInterval=null;
function startQuickTimer(mins){
  if(_quickTimerInterval)clearInterval(_quickTimerInterval);
  const endTime=Date.now()+mins*60000;
  let existing=document.getElementById('quick-timer-bar');
  if(!existing){
    existing=document.createElement('div');existing.id='quick-timer-bar';
    existing.style.cssText='position:fixed;bottom:60px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--accent);border-radius:8px;padding:8px 14px;box-shadow:0 4px 16px rgba(0,0,0,0.5);display:flex;align-items:center;gap:10px';
    document.body.appendChild(existing);
  }
  function update(){
    const remaining=Math.max(0,endTime-Date.now());
    const m=Math.floor(remaining/60000);const s=Math.floor((remaining%60000)/1000);
    existing.innerHTML=`<span style="font-size:16px;font-weight:700;color:var(--accent);font-family:monospace">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span><button onclick="clearInterval(_quickTimerInterval);document.getElementById('quick-timer-bar').remove()" style="font-size:12px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
    if(remaining<=0){
      clearInterval(_quickTimerInterval);
      existing.style.borderColor='#ef4444';
      existing.innerHTML=`<span style="font-size:14px;font-weight:700;color:#ef4444">Time's up!</span><button onclick="document.getElementById('quick-timer-bar').remove()" style="font-size:12px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
      try{new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ==').play();}catch(e){}
    }
  }
  update();_quickTimerInterval=setInterval(update,1000);
  showToast('Timer started: '+mins+' minutes');
}
function showProjectHealthDashboard(){
  const projects=S.projects||[];const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const panel=document.createElement('div');panel.id='project-health-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Project Health Dashboard</span><button onclick="document.getElementById('project-health-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:10px">`;
  projects.forEach(p=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    const pContent=content.filter(c=>(c.tags||[]).some(tag=>tag.toLowerCase()===p.name.toLowerCase()));
    const pLinks=links.filter(l=>l.project===p.name||l.category===p.name);
    const done=pTasks.filter(t=>t.status==='done').length;
    const overdue=pTasks.filter(t=>t.due&&new Date(t.due)<new Date()&&t.status!=='done').length;
    const total=pTasks.length||1;
    const completionRate=Math.round((done/total)*100);
    const specs=(p.specs||[]).length;
    let healthScore=50;
    healthScore+=Math.min(completionRate/2,25);
    healthScore-=overdue*5;
    healthScore+=Math.min(pContent.length*2,10);
    healthScore+=Math.min(specs*3,15);
    healthScore=Math.max(0,Math.min(100,healthScore));
    const healthColor=healthScore>=75?'#4ade80':healthScore>=50?'#f59e0b':'#ef4444';
    const healthLabel=healthScore>=75?'Healthy':healthScore>=50?'At Risk':'Critical';
    h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;border-left:3px solid ${healthColor}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">`;
    h+=`<span style="font-size:12px;font-weight:600;color:var(--text-primary)">${esc(p.name)}</span>`;
    h+=`<span style="font-size:11px;font-weight:700;color:${healthColor}">${healthScore}% ${healthLabel}</span></div>`;
    h+=`<div style="height:6px;background:var(--bg-base);border-radius:3px;margin-bottom:8px"><div style="height:100%;width:${healthScore}%;background:${healthColor};border-radius:3px;transition:width 0.3s"></div></div>`;
    h+=`<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:10px;color:var(--text-muted)">`;
    h+=`<span>Tasks: ${done}/${pTasks.length}</span>`;
    if(overdue)h+=`<span style="color:#ef4444">Overdue: ${overdue}</span>`;
    h+=`<span>Content: ${pContent.length}</span>`;
    h+=`<span>Docs: ${specs}</span>`;
    h+=`<span>Links: ${pLinks.length}</span>`;
    h+=`</div></div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskMatrix(){
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();const threeDays=3*86400000;
  const quadrants={
    doFirst:[],schedule:[],delegate:[],eliminate:[]
  };
  tasks.forEach(t=>{
    const urgent=t.due&&(new Date(t.due).getTime()-now.getTime())<threeDays;
    const important=t.priority==='p0'||t.priority==='p1';
    if(urgent&&important)quadrants.doFirst.push(t);
    else if(!urgent&&important)quadrants.schedule.push(t);
    else if(urgent&&!important)quadrants.delegate.push(t);
    else quadrants.eliminate.push(t);
  });
  const panel=document.createElement('div');panel.id='task-matrix-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Priority Matrix</span><button onclick="document.getElementById('task-matrix-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const quads=[
    {key:'doFirst',name:'Do First',color:'#ef4444',desc:'Urgent + Important'},
    {key:'schedule',name:'Schedule',color:'#3b82f6',desc:'Important, Not Urgent'},
    {key:'delegate',name:'Delegate',color:'#f59e0b',desc:'Urgent, Not Important'},
    {key:'eliminate',name:'Eliminate',color:'#6b7280',desc:'Not Urgent, Not Important'},
  ];
  h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">`;
  quads.forEach(q=>{
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;border-top:3px solid ${q.color};min-height:100px">`;
    h+=`<div style="font-size:11px;font-weight:700;color:${q.color};margin-bottom:2px">${q.name} (${quadrants[q.key].length})</div>`;
    h+=`<div style="font-size:8px;color:var(--text-muted);margin-bottom:8px">${q.desc}</div>`;
    quadrants[q.key].slice(0,5).forEach(t=>{
      h+=`<div style="font-size:10px;color:var(--text-secondary);padding:3px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.title)}</div>`;
    });
    if(quadrants[q.key].length>5)h+=`<div style="font-size:9px;color:var(--text-muted)">+${quadrants[q.key].length-5} more</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentBookmarks(){
  if(!S._contentBookmarks)S._contentBookmarks=[];
  const bookmarks=S._contentBookmarks;
  const content=S.content||[];
  const panel=document.createElement('div');panel.id='content-bookmarks-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Bookmarks (${bookmarks.length})</span><button onclick="document.getElementById('content-bookmarks-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!bookmarks.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No bookmarks yet. Star or pin content items to bookmark them.</div>`;
    const recent=content.slice(0,10);
    if(recent.length){
      h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin:12px 0 8px">Quick Bookmark:</div>`;
      h+=`<div style="display:grid;gap:4px">`;
      recent.forEach(c=>{
        const preview=(c.body||'').substring(0,50);
        h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:4px">`;
        h+=`<div style="flex:1;font-size:10px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview)}</div>`;
        h+=`<button onclick="addContentBookmark('${c.id}')" style="font-size:9px;padding:2px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer">Bookmark</button>`;
        h+=`</div>`;
      });
      h+=`</div>`;
    }
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    bookmarks.forEach((bId,i)=>{
      const item=content.find(c=>c.id===bId);
      if(!item)return;
      const preview=(item.body||'').substring(0,60);
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer;border:1px solid transparent;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview||'(empty)')}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${item.theme||''} | ${(item.tags||[]).slice(0,3).join(', ')}</div></div>`;
      h+=`<button onclick="removeContentBookmark(${i})" style="font-size:14px;background:none;border:none;color:var(--text-muted);cursor:pointer">&times;</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function addContentBookmark(id){
  if(!S._contentBookmarks)S._contentBookmarks=[];
  if(!S._contentBookmarks.includes(id)){S._contentBookmarks.push(id);save();}
  const p=document.getElementById('content-bookmarks-panel');if(p)p.remove();showContentBookmarks();
}
function removeContentBookmark(idx){
  S._contentBookmarks.splice(idx,1);save();
  const p=document.getElementById('content-bookmarks-panel');if(p)p.remove();showContentBookmarks();
}
function showSystemStatus(){
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];const docs=S.writerDocs||[];const projects=S.projects||[];
  const storageSize=new Blob([JSON.stringify(S)]).size;
  const sizeKB=Math.round(storageSize/1024);
  const sizeMB=(storageSize/1048576).toFixed(2);
  const sections=['tasks','calendar','writer','livingDocs','content','links','whiteboard','repos','pipeline'];
  const panel=document.createElement('div');panel.id='system-status-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const elapsed=Date.now()-(_sessionStart||Date.now());const sessionMins=Math.floor(elapsed/60000);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">ASTRA System Status</span><button onclick="document.getElementById('system-status-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${tasks.length}</div><div style="font-size:9px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#3b82f6">${content.length}</div><div style="font-size:9px;color:var(--text-muted)">Content Items</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">${links.length}</div><div style="font-size:9px;color:var(--text-muted)">Links</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#8b5cf6">${docs.length}</div><div style="font-size:9px;color:var(--text-muted)">Writer Docs</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#ec4899">${projects.length}</div><div style="font-size:9px;color:var(--text-muted)">Projects</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#06b6d4">${sessionMins}m</div><div style="font-size:9px;color:var(--text-muted)">Session Time</div></div>`;
  h+=`</div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:12px">`;
  h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Storage</div>`;
  h+=`<div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:var(--text-muted)">localStorage</span><span style="color:var(--accent)">${sizeKB} KB (${sizeMB} MB)</span></div>`;
  const maxStorage=5120;const pct=Math.min(Math.round((sizeKB/maxStorage)*100),100);
  h+=`<div style="height:6px;background:var(--bg-base);border-radius:3px;margin-top:6px"><div style="height:100%;width:${pct}%;background:${pct>80?'#ef4444':pct>50?'#f59e0b':'var(--accent)'};border-radius:3px"></div></div>`;
  h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:4px">${pct}% of ~5MB localStorage limit</div>`;
  h+=`</div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px">`;
  h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Theme: ${S._theme||'Cosmic (default)'}</div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted)">Version: ASTRA Command Center v2.0</div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showAutoTagSuggestions(){
  const content=S.content||[];
  const existingTags={};
  content.forEach(c=>{(c.tags||[]).forEach(t=>{existingTags[t]=(existingTags[t]||0)+1;});});
  const topTags=Object.entries(existingTags).sort((a,b)=>b[1]-a[1]).slice(0,20);
  const untagged=content.filter(c=>!(c.tags&&c.tags.length));
  const panel=document.createElement('div');panel.id='auto-tag-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Auto-Tag Suggestions</span><button onclick="document.getElementById('auto-tag-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${Object.keys(existingTags).length}</div><div style="font-size:9px;color:var(--text-muted)">Unique Tags</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">${untagged.length}</div><div style="font-size:9px;color:var(--text-muted)">Untagged Items</div></div>`;
  h+=`</div>`;
  if(topTags.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Popular Tags</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">`;
    topTags.forEach(([tag,count])=>{
      h+=`<span style="font-size:10px;padding:3px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;color:var(--accent)">${esc(tag)} (${count})</span>`;
    });
    h+=`</div>`;
  }
  if(untagged.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Untagged Items (click to suggest)</div>`;
    h+=`<div style="display:grid;gap:4px">`;
    untagged.slice(0,10).forEach(c=>{
      const words=(c.body||'').toLowerCase().split(/\s+/).filter(w=>w.length>3);
      const suggestions=[];
      topTags.forEach(([tag])=>{if(words.some(w=>w.includes(tag.toLowerCase())))suggestions.push(tag);});
      if(c.theme&&!suggestions.includes(c.theme))suggestions.push(c.theme);
      const preview=(c.body||'').substring(0,50);
      h+=`<div style="padding:6px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="font-size:10px;color:var(--text-secondary);margin-bottom:4px">${esc(preview)}</div>`;
      if(suggestions.length){
        h+=`<div style="display:flex;gap:4px;flex-wrap:wrap">`;
        suggestions.slice(0,3).forEach(s=>{
          h+=`<button onclick="applyAutoTag('${c.id}','${esc(s)}')" style="font-size:9px;padding:1px 6px;background:var(--bg-base);border:1px solid var(--accent);border-radius:8px;color:var(--accent);cursor:pointer">+${esc(s)}</button>`;
        });
        h+=`</div>`;
      } else {
        h+=`<div style="font-size:9px;color:var(--text-muted)">No suggestions available</div>`;
      }
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function applyAutoTag(id,tag){
  const c=(S.content||[]).find(x=>x.id===id);if(!c)return;
  if(!c.tags)c.tags=[];
  if(!c.tags.includes(tag)){c.tags.push(tag);save();showToast('Tagged: '+tag);}
  const p=document.getElementById('auto-tag-panel');if(p)p.remove();showAutoTagSuggestions();
}
function showSprintView(){
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();
  const sprints=[];
  for(let i=0;i<4;i++){
    const start=new Date(now);start.setDate(start.getDate()+i*7);
    const end=new Date(start);end.setDate(end.getDate()+7);
    const startStr=start.toISOString().split('T')[0];
    const endStr=end.toISOString().split('T')[0];
    const sprintTasks=tasks.filter(t=>{
      if(!t.due)return i===3;
      return t.due>=startStr&&t.due<endStr;
    });
    sprints.push({
      name:i===0?'This Week':i===1?'Next Week':i===2?'Week '+3:'Backlog',
      start:startStr,end:endStr,tasks:sprintTasks
    });
  }
  const panel=document.createElement('div');panel.id='sprint-view-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Sprint View</span><button onclick="document.getElementById('sprint-view-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const colors=['#4ade80','#3b82f6','#f59e0b','#6b7280'];
  sprints.forEach((sp,si)=>{
    h+=`<div style="margin-bottom:12px;background:var(--bg-surface);padding:12px;border-radius:8px;border-left:3px solid ${colors[si]}">`;
    h+=`<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-size:12px;font-weight:600;color:${colors[si]}">${sp.name}</span><span style="font-size:10px;color:var(--text-muted)">${sp.tasks.length} tasks</span></div>`;
    if(!sp.tasks.length){
      h+=`<div style="font-size:10px;color:var(--text-muted);padding:4px 0">No tasks scheduled</div>`;
    } else {
      sp.tasks.slice(0,8).forEach(t=>{
        const pColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
        h+=`<div style="display:flex;align-items:center;gap:6px;padding:3px 0">`;
        h+=`<div style="width:6px;height:6px;border-radius:50%;background:${pColor};flex-shrink:0"></div>`;
        h+=`<span style="font-size:10px;color:var(--text-secondary);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.title)}</span>`;
        if(t.due)h+=`<span style="font-size:9px;color:var(--text-muted);flex-shrink:0">${t.due.substring(5)}</span>`;
        h+=`</div>`;
      });
      if(sp.tasks.length>8)h+=`<div style="font-size:9px;color:var(--text-muted);padding-top:4px">+${sp.tasks.length-8} more</div>`;
    }
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showColorLegend(){
  const legends=[
    {category:'Priority',items:[
      {color:'#ef4444',label:'P0 - Critical'},
      {color:'#f59e0b',label:'P1 - High'},
      {color:'#3b82f6',label:'P2 - Medium'},
      {color:'#6b7280',label:'P3 - Low'},
    ]},
    {category:'Task Status',items:[
      {color:'#f59e0b',label:'Todo'},
      {color:'#3b82f6',label:'In Progress'},
      {color:'#4ade80',label:'Done'},
    ]},
    {category:'Calendar',items:[
      {color:'var(--accent)',label:'Today'},
      {color:'#ef4444',label:'Overdue task'},
      {color:'#3b82f6',label:'Future task'},
    ]},
    {category:'Links',items:[
      {color:'#4ade80',label:'Pinned link'},
      {color:'#f59e0b',label:'Read later'},
      {color:'var(--text-muted)',label:'Regular link'},
    ]},
    {category:'Content',items:[
      {color:'#f59e0b',label:'Starred item'},
      {color:'#4ade80',label:'Pinned item'},
      {color:'#8b5cf6',label:'Tag pill'},
    ]},
    {category:'Health',items:[
      {color:'#4ade80',label:'Healthy (75%+)'},
      {color:'#f59e0b',label:'At Risk (50-74%)'},
      {color:'#ef4444',label:'Critical (<50%)'},
    ]},
  ];
  const panel=document.createElement('div');panel.id='color-legend-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Color Legend</span><button onclick="document.getElementById('color-legend-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">`;
  legends.forEach(leg=>{
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px">`;
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">${leg.category}</div>`;
    leg.items.forEach(item=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:2px 0"><div style="width:12px;height:12px;border-radius:3px;background:${item.color};flex-shrink:0"></div><span style="font-size:10px;color:var(--text-secondary)">${item.label}</span></div>`;
    });
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function generateDailyDigest(){
  const now=new Date();const today=now.toISOString().split('T')[0];
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const todayTasks=tasks.filter(t=>t.created&&t.created.startsWith(today));
  const completedToday=tasks.filter(t=>t.status==='done'&&t.created&&t.created.startsWith(today));
  const overdue=tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  const todayContent=content.filter(c=>c.created&&c.created.startsWith(today));
  const todayLinks=links.filter(l=>l.created&&l.created.startsWith(today));
  let digest=`ASTRA Daily Digest - ${now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}\n${'='.repeat(60)}\n\n`;
  digest+=`OVERVIEW\n--------\n`;
  digest+=`Tasks created: ${todayTasks.length}\n`;
  digest+=`Tasks completed: ${completedToday.length}\n`;
  digest+=`Content added: ${todayContent.length}\n`;
  digest+=`Links saved: ${todayLinks.length}\n`;
  digest+=`Overdue tasks: ${overdue.length}\n\n`;
  if(completedToday.length){
    digest+=`COMPLETED TODAY\n---------------\n`;
    completedToday.forEach(t=>{digest+=`[DONE] ${t.title}\n`;});
    digest+=`\n`;
  }
  if(overdue.length){
    digest+=`OVERDUE\n-------\n`;
    overdue.slice(0,10).forEach(t=>{digest+=`[!] ${t.title} (due ${t.due})\n`;});
    digest+=`\n`;
  }
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  if(inProgress.length){
    digest+=`IN PROGRESS\n-----------\n`;
    inProgress.forEach(t=>{digest+=`[-] ${t.title}\n`;});
    digest+=`\n`;
  }
  if(todayContent.length){
    digest+=`NEW CONTENT\n-----------\n`;
    todayContent.forEach(c=>{digest+=`- ${(c.body||'').substring(0,60)}\n`;});
    digest+=`\n`;
  }
  digest+=`\nGenerated by ASTRA Command Center\n`;
  navigator.clipboard.writeText(digest);showToast('Daily digest copied to clipboard');
}
function showContentArchive(){
  if(!S._contentArchive)S._contentArchive=[];
  const archived=S._contentArchive;
  const panel=document.createElement('div');panel.id='content-archive-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Archive (${archived.length})</span><div><button onclick="archiveOldContent()" style="font-size:10px;padding:4px 10px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600;margin-right:8px">Archive 30d+</button><button onclick="document.getElementById('content-archive-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  if(!archived.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No archived content. Click "Archive 30d+" to archive old items.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    archived.slice(0,30).forEach((c,i)=>{
      const preview=(c.body||'').substring(0,60);
      const date=c.created?new Date(c.created).toLocaleDateString():'';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(preview||'(empty)')}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${c.theme||''} | ${date}</div></div>`;
      h+=`<button onclick="restoreArchivedContent(${i})" style="font-size:9px;padding:3px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer">Restore</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function archiveOldContent(){
  const now=Date.now();const threshold=30*86400000;
  if(!S._contentArchive)S._contentArchive=[];
  const toArchive=(S.content||[]).filter(c=>{
    const created=c.created?new Date(c.created).getTime():0;
    return created>0&&(now-created)>threshold;
  });
  if(!toArchive.length){showToast('No content older than 30 days');return;}
  if(!confirm('Archive '+toArchive.length+' items older than 30 days?'))return;
  toArchive.forEach(c=>{
    S._contentArchive.push(c);
    S.content=S.content.filter(x=>x.id!==c.id);
  });
  save();const p=document.getElementById('content-archive-panel');if(p)p.remove();showContentArchive();
  showToast('Archived '+toArchive.length+' items');
}
function restoreArchivedContent(idx){
  if(!S._contentArchive)return;
  const item=S._contentArchive.splice(idx,1)[0];
  if(!S.content)S.content=[];S.content.unshift(item);save();
  const p=document.getElementById('content-archive-panel');if(p)p.remove();showContentArchive();
  showToast('Content restored');
}
var _changelog=[];
function logChange(action,section,detail){
  _changelog.unshift({action,section,detail:detail||'',ts:Date.now()});
  if(_changelog.length>100)_changelog.length=100;
}
function showChangelog(){
  const panel=document.createElement('div');panel.id='changelog-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Workspace Changelog (${_changelog.length})</span><button onclick="document.getElementById('changelog-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!_changelog.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No changes logged this session.</div>`;
  } else {
    h+=`<div style="display:grid;gap:4px">`;
    _changelog.slice(0,50).forEach(entry=>{
      const ago=Math.round((Date.now()-entry.ts)/60000);
      const timeStr=ago<1?'Just now':ago<60?ago+'m ago':Math.round(ago/60)+'h ago';
      const actionColor=entry.action==='create'?'#4ade80':entry.action==='delete'?'#ef4444':entry.action==='update'?'#3b82f6':'#f59e0b';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:4px;border-left:2px solid ${actionColor}">`;
      h+=`<span style="font-size:9px;font-weight:600;color:${actionColor};width:40px;flex-shrink:0">${entry.action}</span>`;
      h+=`<span style="font-size:10px;color:var(--text-secondary);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(entry.section)}: ${esc(entry.detail)}</span>`;
      h+=`<span style="font-size:9px;color:var(--text-muted);flex-shrink:0">${timeStr}</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showFocusModeConfig(){
  if(!S._focusConfig)S._focusConfig={blockedSections:[],duration:25,breakDuration:5};
  const fc=S._focusConfig;
  const allSections=['tasks','calendar','writer','livingDocs','content','links','whiteboard','repos','pipeline'];
  const panel=document.createElement('div');panel.id='focus-config-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Focus Mode Config</span><button onclick="document.getElementById('focus-config-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Focus Duration (minutes)</div>`;
  h+=`<div style="display:flex;gap:8px">`;
  [15,25,45,60].forEach(m=>{
    const selected=fc.duration===m;
    h+=`<button onclick="S._focusConfig.duration=${m};save();document.getElementById('focus-config-panel').remove();showFocusModeConfig()" style="padding:6px 14px;border-radius:6px;border:1px solid ${selected?'var(--accent)':'var(--border)'};background:${selected?'var(--accent)':'var(--bg-surface)'};color:${selected?'#000':'var(--text-secondary)'};cursor:pointer;font-size:11px;font-weight:${selected?'700':'400'}">${m}m</button>`;
  });
  h+=`</div></div>`;
  h+=`<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Break Duration (minutes)</div>`;
  h+=`<div style="display:flex;gap:8px">`;
  [3,5,10,15].forEach(m=>{
    const selected=fc.breakDuration===m;
    h+=`<button onclick="S._focusConfig.breakDuration=${m};save();document.getElementById('focus-config-panel').remove();showFocusModeConfig()" style="padding:6px 14px;border-radius:6px;border:1px solid ${selected?'var(--accent)':'var(--border)'};background:${selected?'var(--accent)':'var(--bg-surface)'};color:${selected?'#000':'var(--text-secondary)'};cursor:pointer;font-size:11px;font-weight:${selected?'700':'400'}">${m}m</button>`;
  });
  h+=`</div></div>`;
  h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Block sections during focus (click to toggle)</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">`;
  allSections.forEach(sec=>{
    const blocked=(fc.blockedSections||[]).includes(sec);
    h+=`<button onclick="toggleFocusBlock('${sec}')" style="padding:6px;border-radius:6px;border:1px solid ${blocked?'#ef4444':'var(--border)'};background:${blocked?'rgba(239,68,68,0.1)':'var(--bg-surface)'};color:${blocked?'#ef4444':'var(--text-secondary)'};cursor:pointer;font-size:10px">${blocked?'X ':''}${sec}</button>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function toggleFocusBlock(sec){
  if(!S._focusConfig)S._focusConfig={blockedSections:[],duration:25,breakDuration:5};
  if(!S._focusConfig.blockedSections)S._focusConfig.blockedSections=[];
  const idx=S._focusConfig.blockedSections.indexOf(sec);
  if(idx>=0)S._focusConfig.blockedSections.splice(idx,1);
  else S._focusConfig.blockedSections.push(sec);
  save();const p=document.getElementById('focus-config-panel');if(p)p.remove();showFocusModeConfig();
}
function extractActionItems(){
  const content=S.content||[];
  const actionPatterns=[/^[-*]\s*\[[ x]\]\s*(.+)$/gm,/^TODO:\s*(.+)$/gim,/^ACTION:\s*(.+)$/gim,/^[-*]\s*(.+)$/gm];
  const found=[];
  content.forEach(c=>{
    const text=c.body||'';
    const lines=text.split('\n');
    lines.forEach(line=>{
      const trimmed=line.trim();
      if(trimmed.match(/^[-*]\s*\[[ ]\]\s*.+/)){
        const title=trimmed.replace(/^[-*]\s*\[[ ]\]\s*/,'');
        found.push({title,source:c.id,preview:(c.body||'').substring(0,40)});
      } else if(trimmed.match(/^(TODO|ACTION):\s*.+/i)){
        const title=trimmed.replace(/^(TODO|ACTION):\s*/i,'');
        found.push({title,source:c.id,preview:(c.body||'').substring(0,40)});
      }
    });
  });
  const panel=document.createElement('div');panel.id='action-items-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Action Items Found (${found.length})</span><button onclick="document.getElementById('action-items-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Scans content for TODO:, ACTION:, and unchecked [ ] items</div>`;
  if(!found.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No action items found in content. Use "- [ ] task", "TODO: task", or "ACTION: task" format.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    found.slice(0,20).forEach((item,i)=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
      h+=`<div style="flex:1;min-width:0"><div style="font-size:11px;color:var(--text-primary)">${esc(item.title)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">From: ${esc(item.preview)}...</div></div>`;
      h+=`<button onclick="createTaskFromAction('${esc(item.title.replace(/'/g,"\\'"))}')" style="font-size:9px;padding:3px 8px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer;font-weight:600">Create Task</button>`;
      h+=`</div>`;
    });
    h+=`</div>`;
    if(found.length>1){
      h+=`<button onclick="createAllActionTasks()" style="width:100%;margin-top:12px;padding:10px;background:var(--bg-surface);border:1px solid var(--accent);border-radius:6px;color:var(--accent);cursor:pointer;font-size:11px;font-weight:600">Create All ${found.length} Tasks</button>`;
    }
  }
  panel.innerHTML=h;document.body.appendChild(panel);
  window._extractedActions=found;
}
function createTaskFromAction(title){
  if(!S.tasks)S.tasks=[];
  S.tasks.unshift({id:'t_'+Date.now(),title,status:'todo',priority:'p2',project:'',due:'',created:new Date().toISOString(),description:'Extracted from content',subtasks:[]});
  save();showToast('Task created: '+title.substring(0,40));
}
function createAllActionTasks(){
  const actions=window._extractedActions||[];
  if(!actions.length)return;
  if(!confirm('Create '+actions.length+' tasks?'))return;
  actions.forEach((item,i)=>{
    setTimeout(()=>{
      if(!S.tasks)S.tasks=[];
      S.tasks.unshift({id:'t_'+(Date.now()+i),title:item.title,status:'todo',priority:'p2',project:'',due:'',created:new Date().toISOString(),description:'Extracted from content',subtasks:[]});
    },i*10);
  });
  setTimeout(()=>{save();showToast('Created '+actions.length+' tasks');const p=document.getElementById('action-items-panel');if(p)p.remove();},actions.length*10+100);
}
function showWeeklyPlanner(){
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();const dayOfWeek=now.getDay();
  const monday=new Date(now);monday.setDate(monday.getDate()-(dayOfWeek===0?6:dayOfWeek-1));
  const days=[];
  for(let i=0;i<7;i++){
    const d=new Date(monday);d.setDate(d.getDate()+i);
    const dateStr=d.toISOString().split('T')[0];
    const dayTasks=tasks.filter(t=>t.due===dateStr);
    days.push({date:d,dateStr,name:d.toLocaleDateString('en-US',{weekday:'short'}),dayNum:d.getDate(),tasks:dayTasks,isToday:dateStr===now.toISOString().split('T')[0]});
  }
  const unscheduled=tasks.filter(t=>!t.due).slice(0,10);
  const panel=document.createElement('div');panel.id='weekly-planner-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:750px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Weekly Planner</span><button onclick="document.getElementById('weekly-planner-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:12px">`;
  days.forEach(day=>{
    h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;min-height:120px;border:${day.isToday?'1px solid var(--accent)':'1px solid transparent'}">`;
    h+=`<div style="font-size:10px;font-weight:600;color:${day.isToday?'var(--accent)':'var(--text-primary)'};margin-bottom:6px">${day.name} ${day.dayNum}</div>`;
    if(!day.tasks.length){
      h+=`<div style="font-size:9px;color:var(--text-muted);opacity:0.5">No tasks</div>`;
    } else {
      day.tasks.slice(0,4).forEach(t=>{
        const pColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
        h+=`<div style="font-size:9px;color:var(--text-secondary);padding:2px 4px;margin-bottom:2px;background:var(--bg-base);border-radius:3px;border-left:2px solid ${pColor};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.title)}</div>`;
      });
      if(day.tasks.length>4)h+=`<div style="font-size:8px;color:var(--text-muted)">+${day.tasks.length-4} more</div>`;
    }
    h+=`</div>`;
  });
  h+=`</div>`;
  if(unscheduled.length){
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Unscheduled (${unscheduled.length})</div>`;
    h+=`<div style="display:flex;flex-wrap:wrap;gap:4px">`;
    unscheduled.forEach(t=>{
      h+=`<span style="font-size:9px;padding:2px 8px;background:var(--bg-base);border:1px solid var(--border);border-radius:10px;color:var(--text-secondary)">${esc(t.title.substring(0,30))}</span>`;
    });
    h+=`</div></div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectSwitcher(){
  const projects=S.projects||[];
  const panel=document.createElement('div');panel.id='project-switcher-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=S.tasks||[];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Switch Project</span><button onclick="document.getElementById('project-switcher-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:6px">`;
  projects.forEach(p=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    const done=pTasks.filter(t=>t.status==='done').length;
    const active=pTasks.filter(t=>t.status!=='done').length;
    const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
    const color=colors[projects.indexOf(p)%colors.length];
    h+=`<div onclick="document.getElementById('project-switcher-panel').remove();switchSection('tasks');setTimeout(()=>{const sel=document.querySelector('.task-project-filter');if(sel){sel.value='${esc(p.name)}';sel.dispatchEvent(new Event('change'));}},100)" style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-surface);border-radius:8px;cursor:pointer;border:1px solid transparent;border-left:3px solid ${color};transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent';this.style.borderLeftColor='${color}'">`;
    h+=`<div style="flex:1"><div style="font-size:12px;font-weight:600;color:var(--text-primary)">${esc(p.name)}</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted)">${active} active | ${done} done</div></div>`;
    h+=`<span style="font-size:10px;color:${color};font-weight:600">${pTasks.length}</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskChainsView(){
  const tasks=S.tasks||[];
  const blockedTasks=tasks.filter(t=>t.blockedBy&&t.blockedBy.length);
  const chains=[];
  blockedTasks.forEach(t=>{
    const chain=[t];
    let current=t;
    while(current.blockedBy&&current.blockedBy.length){
      const blocker=tasks.find(x=>x.id===current.blockedBy[0]);
      if(!blocker||chain.includes(blocker))break;
      chain.unshift(blocker);current=blocker;
    }
    if(chain.length>1)chains.push(chain);
  });
  const panel=document.createElement('div');panel.id='task-chains-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Dependency Chains (${chains.length})</span><button onclick="document.getElementById('task-chains-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${blockedTasks.length}</div><div style="font-size:9px;color:var(--text-muted)">Blocked Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">${chains.length}</div><div style="font-size:9px;color:var(--text-muted)">Chains</div></div>`;
  h+=`</div>`;
  if(!chains.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">No dependency chains found. Use the "B" (blocked-by) field in task details to create dependencies.</div>`;
  } else {
    chains.forEach((chain,ci)=>{
      h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;margin-bottom:8px"><div style="font-size:10px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Chain ${ci+1} (${chain.length} tasks)</div>`;
      h+=`<div style="display:flex;align-items:center;flex-wrap:wrap;gap:4px">`;
      chain.forEach((t,ti)=>{
        const sColor=t.status==='done'?'#4ade80':t.status==='in-progress'?'#3b82f6':'#f59e0b';
        h+=`<span style="font-size:10px;padding:3px 8px;background:var(--bg-base);border:1px solid ${sColor};border-radius:4px;color:${sColor}">${esc(t.title.substring(0,25))}</span>`;
        if(ti<chain.length-1)h+=`<span style="color:var(--text-muted);font-size:12px">&rarr;</span>`;
      });
      h+=`</div></div>`;
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showThemeBreakdown(){
  const content=S.content||[];
  const themeMap={};
  content.forEach(c=>{const t=c.theme||'untagged';themeMap[t]=(themeMap[t]||0)+1;});
  const sorted=Object.entries(themeMap).sort((a,b)=>b[1]-a[1]);
  const total=content.length||1;
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316','#a855f7','#22d3ee','#84cc16','#e879f9'];
  const panel=document.createElement('div');panel.id='theme-breakdown-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Themes (${sorted.length})</span><button onclick="document.getElementById('theme-breakdown-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;gap:4px;height:24px;border-radius:6px;overflow:hidden;margin-bottom:16px">`;
  sorted.forEach(([theme,count],i)=>{
    const pct=Math.max(2,(count/total)*100);
    h+=`<div title="${theme}: ${count}" style="width:${pct}%;background:${colors[i%colors.length]};min-width:4px"></div>`;
  });
  h+=`</div>`;
  h+=`<div style="display:grid;gap:6px">`;
  sorted.forEach(([theme,count],i)=>{
    const pct=Math.round((count/total)*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<div style="width:12px;height:12px;border-radius:3px;background:${colors[i%colors.length]};flex-shrink:0"></div>`;
    h+=`<div style="flex:1"><div style="font-size:11px;color:var(--text-primary)">${esc(theme)}</div></div>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${count} (${pct}%)</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMultiProjectDashboard(){
  const projects=S.projects||[];const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const panel=document.createElement('div');panel.id='multi-project-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  const totalTasks=tasks.length;const totalDone=tasks.filter(t=>t.status==='done').length;
  const totalOverdue=tasks.filter(t=>t.due&&new Date(t.due)<new Date()&&t.status!=='done').length;
  const totalContent=content.length;const totalLinks=links.length;
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Multi-Project Dashboard</span><button onclick="document.getElementById('multi-project-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:var(--accent)">${totalTasks}</div><div style="font-size:8px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#4ade80">${totalDone}</div><div style="font-size:8px;color:var(--text-muted)">Done</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#ef4444">${totalOverdue}</div><div style="font-size:8px;color:var(--text-muted)">Overdue</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#3b82f6">${totalContent}</div><div style="font-size:8px;color:var(--text-muted)">Content</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:#f59e0b">${totalLinks}</div><div style="font-size:8px;color:var(--text-muted)">Links</div></div>`;
  h+=`</div>`;
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
  h+=`<div style="display:grid;gap:8px">`;
  projects.forEach((p,pi)=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    const done=pTasks.filter(t=>t.status==='done').length;
    const overdue=pTasks.filter(t=>t.due&&new Date(t.due)<new Date()&&t.status!=='done').length;
    const pct=pTasks.length?Math.round((done/pTasks.length)*100):0;
    const color=colors[pi%colors.length];
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;border-left:3px solid ${color}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
    h+=`<span style="font-size:12px;font-weight:600;color:${color}">${esc(p.name)}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${done}/${pTasks.length} (${pct}%)</span></div>`;
    h+=`<div style="height:5px;background:var(--bg-base);border-radius:3px"><div style="height:100%;width:${pct}%;background:${color};border-radius:3px"></div></div>`;
    if(overdue)h+=`<div style="font-size:9px;color:#ef4444;margin-top:4px">${overdue} overdue</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function exportContentByTheme(){
  const content=S.content||[];
  const themeMap={};
  content.forEach(c=>{const t=c.theme||'untagged';if(!themeMap[t])themeMap[t]=[];themeMap[t].push(c);});
  let md='# Content Export by Theme\n\n';
  md+='Generated: '+new Date().toLocaleString()+'\n\n';
  Object.entries(themeMap).sort((a,b)=>b[1].length-a[1].length).forEach(([theme,items])=>{
    md+=`## ${theme} (${items.length} items)\n\n`;
    items.forEach(c=>{
      const date=c.created?new Date(c.created).toLocaleDateString():'';
      const body=(c.body||'').substring(0,200);
      md+=`### ${date}\n${body}\n\n---\n\n`;
    });
  });
  navigator.clipboard.writeText(md);showToast('Content by theme copied to clipboard ('+content.length+' items)');
}
function showGlobalSearch(initialQuery){
  const panel=document.createElement('div');panel.id='global-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Global Search</span><button onclick="document.getElementById('global-search-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<input id="global-search-input" type="text" value="${initialQuery||''}" placeholder="Search everything..." style="width:100%;padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;margin-bottom:12px;box-sizing:border-box" oninput="runGlobalSearch(this.value)">`;
  h+=`<div id="global-search-results" style="display:grid;gap:4px"></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('global-search-input').focus();
  if(initialQuery)runGlobalSearch(initialQuery);
}
function runGlobalSearch(query){
  const q=query.toLowerCase().trim();const results=document.getElementById('global-search-results');
  if(!results)return;
  if(!q){results.innerHTML='<div style="font-size:11px;color:var(--text-muted);text-align:center;padding:16px">Type to search across all sections</div>';return;}
  const found=[];
  (S.tasks||[]).forEach(t=>{
    if((t.title||'').toLowerCase().includes(q)||(t.description||'').toLowerCase().includes(q)){
      found.push({type:'Task',title:t.title,detail:t.status+' | '+(t.priority||''),color:'#4ade80'});
    }
  });
  (S.content||[]).forEach(c=>{
    if((c.body||'').toLowerCase().includes(q)){
      found.push({type:'Content',title:(c.body||'').substring(0,60),detail:c.theme||'',color:'#3b82f6'});
    }
  });
  (S.links||[]).forEach(l=>{
    if((l.title||'').toLowerCase().includes(q)||(l.url||'').toLowerCase().includes(q)){
      found.push({type:'Link',title:l.title||l.url,detail:l.category||'',color:'#f59e0b'});
    }
  });
  (S.writerDocs||[]).forEach(d=>{
    if((d.title||'').toLowerCase().includes(q)||(d.body||'').toLowerCase().includes(q)){
      found.push({type:'Doc',title:d.title||'Untitled',detail:(d.body||'').split(/\s+/).length+' words',color:'#8b5cf6'});
    }
  });
  let html='';
  if(!found.length){
    html='<div style="font-size:11px;color:var(--text-muted);text-align:center;padding:16px">No results for "'+esc(query)+'"</div>';
  } else {
    html=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">${found.length} results</div>`;
    found.slice(0,20).forEach(r=>{
      html+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:4px;border-left:2px solid ${r.color}">`;
      html+=`<span style="font-size:8px;font-weight:600;color:${r.color};width:40px;flex-shrink:0">${r.type}</span>`;
      html+=`<div style="flex:1;min-width:0"><div style="font-size:10px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(r.title)}</div>`;
      html+=`<div style="font-size:8px;color:var(--text-muted)">${esc(r.detail)}</div></div>`;
      html+=`</div>`;
    });
  }
  results.innerHTML=html;
}
function showNotificationCenter(){
  const notifications=[];const tasks=S.tasks||[];const now=new Date();const today=now.toISOString().split('T')[0];
  const overdue=tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  overdue.forEach(t=>{notifications.push({type:'overdue',icon:'!',color:'#ef4444',title:'Overdue: '+t.title,detail:'Due '+t.due});});
  const dueToday=tasks.filter(t=>t.due===today&&t.status!=='done');
  dueToday.forEach(t=>{notifications.push({type:'today',icon:'T',color:'#f59e0b',title:'Due today: '+t.title,detail:t.priority||''});});
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  if(inProgress.length>5)notifications.push({type:'wip',icon:'W',color:'#3b82f6',title:'WIP Warning',detail:inProgress.length+' tasks in progress (recommend <5)'});
  const sd=S._streakData||{};
  if(sd.currentStreak>=7)notifications.push({type:'streak',icon:'S',color:'#4ade80',title:'Streak: '+sd.currentStreak+' days!',detail:'Keep it going!'});
  const storageSize=new Blob([JSON.stringify(S)]).size;
  if(storageSize>4*1024*1024)notifications.push({type:'storage',icon:'D',color:'#f97316',title:'Storage Warning',detail:Math.round(storageSize/1024)+'KB used (approaching 5MB limit)'});
  const panel=document.createElement('div');panel.id='notification-center-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Notifications (${notifications.length})</span><button onclick="document.getElementById('notification-center-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(!notifications.length){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">All clear! No notifications.</div>`;
  } else {
    h+=`<div style="display:grid;gap:6px">`;
    notifications.forEach(n=>{
      h+=`<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${n.color}">`;
      h+=`<div style="width:28px;height:28px;border-radius:50%;background:${n.color}20;display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:12px;font-weight:700;color:${n.color}">${n.icon}</span></div>`;
      h+=`<div style="flex:1"><div style="font-size:11px;font-weight:600;color:var(--text-primary)">${esc(n.title)}</div>`;
      h+=`<div style="font-size:9px;color:var(--text-muted)">${esc(n.detail)}</div></div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function trackDailyStats(){
  if(!S._dailyStats)S._dailyStats=[];
  const today=new Date().toISOString().split('T')[0];
  const existing=S._dailyStats.find(d=>d.date===today);
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const stats={
    date:today,
    tasks:tasks.length,
    done:tasks.filter(t=>t.status==='done').length,
    content:content.length,
    links:links.length,
    words:content.reduce((a,c)=>a+((c.body||'').split(/\s+/).filter(w=>w).length),0),
    storage:Math.round(new Blob([JSON.stringify(S)]).size/1024)
  };
  if(existing){Object.assign(existing,stats);}
  else{S._dailyStats.push(stats);if(S._dailyStats.length>90)S._dailyStats=S._dailyStats.slice(-90);}
  save();
}
function showStatsHistory(){
  trackDailyStats();
  const stats=S._dailyStats||[];
  const panel=document.createElement('div');panel.id='stats-history-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Stats History (${stats.length} days)</span><button onclick="document.getElementById('stats-history-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  if(stats.length<2){
    h+=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:12px">Not enough history yet. Check back tomorrow!</div>`;
  } else {
    const recent=stats.slice(-14);
    const maxTasks=Math.max(...recent.map(s=>s.tasks),1);
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Task Growth (last ${recent.length} days)</div>`;
    h+=`<div style="display:flex;align-items:end;gap:4px;height:100px;margin-bottom:16px;padding:4px;background:var(--bg-surface);border-radius:8px">`;
    recent.forEach(s=>{
      const height=Math.round((s.tasks/maxTasks)*80);
      const doneHeight=Math.round((s.done/maxTasks)*80);
      h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end" title="${s.date}: ${s.tasks} tasks, ${s.done} done">`;
      h+=`<div style="width:100%;height:${height}px;background:var(--accent);border-radius:2px 2px 0 0;position:relative">`;
      h+=`<div style="position:absolute;bottom:0;width:100%;height:${doneHeight}px;background:#1a4731;border-radius:0 0 2px 2px"></div>`;
      h+=`</div></div>`;
    });
    h+=`</div>`;
    h+=`<div style="display:grid;gap:4px">`;
    stats.slice(-7).reverse().forEach(s=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:4px;font-size:10px">`;
      h+=`<span style="color:var(--text-muted);width:65px;flex-shrink:0">${s.date.substring(5)}</span>`;
      h+=`<span style="color:var(--accent)">Tasks: ${s.tasks}</span>`;
      h+=`<span style="color:#4ade80">Done: ${s.done}</span>`;
      h+=`<span style="color:#3b82f6">Content: ${s.content}</span>`;
      h+=`<span style="color:#f59e0b">Links: ${s.links}</span>`;
      h+=`<span style="color:var(--text-muted)">${s.storage}KB</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showKanbanFilters(){
  const projects=S.projects||[];
  const panel=document.createElement('div');panel.id='kanban-filters-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  if(!S._kanbanFilters)S._kanbanFilters={priority:'all',project:'all',dueSoon:false};
  const kf=S._kanbanFilters;
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Board Filters</span><button onclick="document.getElementById('kanban-filters-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Priority</div>`;
  h+=`<div style="display:flex;gap:6px;flex-wrap:wrap">`;
  ['all','p0','p1','p2','p3'].forEach(p=>{
    const selected=kf.priority===p;
    const color=p==='p0'?'#ef4444':p==='p1'?'#f59e0b':p==='p2'?'#3b82f6':p==='p3'?'#6b7280':'var(--accent)';
    h+=`<button onclick="S._kanbanFilters.priority='${p}';save();document.getElementById('kanban-filters-panel').remove();showKanbanFilters()" style="padding:4px 12px;border-radius:4px;border:1px solid ${selected?color:'var(--border)'};background:${selected?color+'20':'var(--bg-surface)'};color:${selected?color:'var(--text-muted)'};cursor:pointer;font-size:10px;font-weight:${selected?'600':'400'}">${p==='all'?'All':p.toUpperCase()}</button>`;
  });
  h+=`</div></div>`;
  h+=`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Project</div>`;
  h+=`<select onchange="S._kanbanFilters.project=this.value;save()" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px">`;
  h+=`<option value="all" ${kf.project==='all'?'selected':''}>All Projects</option>`;
  projects.forEach(p=>{h+=`<option value="${esc(p.name)}" ${kf.project===p.name?'selected':''}>${esc(p.name)}</option>`;});
  h+=`</select></div>`;
  h+=`<div style="margin-bottom:16px"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ${kf.dueSoon?'checked':''} onchange="S._kanbanFilters.dueSoon=this.checked;save()"><span style="font-size:11px;color:var(--text-secondary)">Show only due within 7 days</span></label></div>`;
  h+=`<button onclick="S._kanbanFilters={priority:'all',project:'all',dueSoon:false};save();document.getElementById('kanban-filters-panel').remove();renderTasks()" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);cursor:pointer;font-size:11px">Reset Filters</button>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showScratchpad(){
  if(!S._scratchpad)S._scratchpad='';
  const panel=document.createElement('div');panel.id='scratchpad-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Scratchpad</span><div><button onclick="navigator.clipboard.writeText(document.getElementById('scratchpad-textarea').value);showToast('Copied')" style="font-size:10px;padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);cursor:pointer;margin-right:8px">Copy</button><button onclick="document.getElementById('scratchpad-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div></div>`;
  h+=`<textarea id="scratchpad-textarea" style="width:100%;height:300px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;padding:12px;resize:vertical;font-family:monospace;line-height:1.6;box-sizing:border-box" oninput="S._scratchpad=this.value;save()" placeholder="Quick notes, scratch work, temporary ideas...">${esc(S._scratchpad)}</textarea>`;
  h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:6px;text-align:right">${S._scratchpad.split(/\s+/).filter(w=>w).length} words | Auto-saved</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('scratchpad-textarea').focus();
}
function printableExport(){
  const tasks=S.tasks||[];const content=S.content||[];
  let html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>ASTRA Export</title>';
  html+='<style>body{font-family:system-ui;max-width:800px;margin:0 auto;padding:20px;color:#222}h1{border-bottom:2px solid #333}h2{color:#444;margin-top:24px}table{width:100%;border-collapse:collapse;margin:12px 0}th,td{border:1px solid #ddd;padding:6px 10px;text-align:left;font-size:12px}th{background:#f5f5f5;font-weight:600}.done{text-decoration:line-through;color:#999}.p0{color:#dc2626}.p1{color:#d97706}.p2{color:#2563eb}.overdue{color:#dc2626;font-weight:600}@media print{body{font-size:11px}}</style>';
  html+='</head><body>';
  html+=`<h1>ASTRA Command Center Export</h1><p>Generated: ${new Date().toLocaleString()}</p>`;
  html+='<h2>Tasks ('+tasks.length+')</h2><table><tr><th>Title</th><th>Status</th><th>Priority</th><th>Due</th></tr>';
  tasks.slice(0,50).forEach(t=>{
    const isDone=t.status==='done';
    const isOverdue=t.due&&new Date(t.due)<new Date()&&!isDone;
    html+=`<tr class="${isDone?'done':''}"><td>${esc(t.title)}</td><td>${t.status}</td><td class="${t.priority||''}">${(t.priority||'p3').toUpperCase()}</td><td class="${isOverdue?'overdue':''}">${t.due||'-'}</td></tr>`;
  });
  html+='</table>';
  html+='<h2>Content ('+content.length+')</h2>';
  content.slice(0,20).forEach(c=>{
    html+=`<div style="border-left:3px solid #4ade80;padding:8px 12px;margin:8px 0;background:#f9f9f9"><p style="font-size:11px;color:#666">${c.theme||''} | ${c.created?new Date(c.created).toLocaleDateString():''}</p><p>${esc((c.body||'').substring(0,300))}</p></div>`;
  });
  html+='</body></html>';
  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='astra-export-'+new Date().toISOString().split('T')[0]+'.html';
  a.click();URL.revokeObjectURL(url);
  showToast('Printable HTML exported');
}
function contentToSlides(){
  const content=S.content||[];
  if(!content.length){showToast('No content to convert');return;}
  let html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>ASTRA Slides</title>';
  html+='<style>*{margin:0;padding:0;box-sizing:border-box}body{background:#0a0a0a;color:#e5e5e5;font-family:system-ui}';
  html+='.slide{width:100vw;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:60px;text-align:center;page-break-after:always}';
  html+='.slide h2{font-size:36px;margin-bottom:20px;color:#4ade80}.slide p{font-size:18px;line-height:1.8;max-width:700px;color:#a3a3a3}';
  html+='.slide-num{position:fixed;bottom:20px;right:20px;font-size:12px;color:#555}';
  html+='.title-slide{background:linear-gradient(135deg,#050508,#0a1628)}.title-slide h1{font-size:48px;color:#4ade80;margin-bottom:16px}.title-slide p{font-size:20px}';
  html+='@media print{.slide{page-break-after:always}}</style></head><body>';
  html+=`<div class="slide title-slide"><h1>ASTRA Content</h1><p>${new Date().toLocaleDateString()} | ${content.length} items</p></div>`;
  content.slice(0,20).forEach((c,i)=>{
    const body=(c.body||'').substring(0,500);
    const theme=c.theme||'';
    html+=`<div class="slide"><h2>${esc(theme||'Note '+(i+1))}</h2><p>${esc(body)}</p></div>`;
  });
  html+='</body></html>';
  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='astra-slides-'+new Date().toISOString().split('T')[0]+'.html';
  a.click();URL.revokeObjectURL(url);
  showToast('Slides exported ('+Math.min(content.length,20)+' slides)');
}
function showWorkloadIndicator(){
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();const today=now.toISOString().split('T')[0];
  const days=[];
  for(let i=0;i<14;i++){
    const d=new Date(now);d.setDate(d.getDate()+i);
    const dateStr=d.toISOString().split('T')[0];
    const dayTasks=tasks.filter(t=>t.due===dateStr);
    days.push({date:d,dateStr,name:d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),count:dayTasks.length,isToday:dateStr===today});
  }
  const maxLoad=Math.max(...days.map(d=>d.count),1);
  const panel=document.createElement('div');panel.id='workload-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Workload Forecast (14 days)</span><button onclick="document.getElementById('workload-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;align-items:end;gap:6px;height:120px;padding:4px;background:var(--bg-surface);border-radius:8px;margin-bottom:12px">`;
  days.forEach(day=>{
    const height=day.count?Math.max(20,Math.round((day.count/maxLoad)*100)):4;
    const color=day.count>=4?'#ef4444':day.count>=2?'#f59e0b':day.count>=1?'#4ade80':'rgba(255,255,255,0.05)';
    h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end" title="${day.name}: ${day.count} tasks">`;
    h+=`<div style="font-size:8px;color:var(--text-muted);margin-bottom:2px">${day.count||''}</div>`;
    h+=`<div style="width:100%;height:${height}px;background:${color};border-radius:3px 3px 0 0;border:${day.isToday?'2px solid var(--accent)':'none'}"></div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  h+=`<div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:center">`;
  days.forEach(day=>{
    h+=`<span style="font-size:7px;color:${day.isToday?'var(--accent)':'var(--text-muted)'};width:${100/14}%;text-align:center">${day.name.split(',')[0].split(' ')[0]}</span>`;
  });
  h+=`</div>`;
  const overloaded=days.filter(d=>d.count>=4);
  if(overloaded.length){
    h+=`<div style="margin-top:12px;padding:8px;background:rgba(239,68,68,0.1);border:1px solid #ef4444;border-radius:6px;font-size:10px;color:#ef4444">Warning: ${overloaded.length} day(s) with 4+ tasks. Consider redistributing.</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMiniDatePicker(taskId){
  const task=(S.tasks||[]).find(t=>t.id===taskId);
  if(!task)return;
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const panel=document.createElement('div');panel.id='mini-datepicker';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1600;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:12px;font-weight:600;color:var(--text-primary)">${monthName}</span><button onclick="document.getElementById('mini-datepicker').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">&times;</button></div>`;
  h+=`<div style="font-size:10px;color:var(--text-primary);margin-bottom:4px">Set due date for: ${esc(task.title.substring(0,30))}</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:8px">`;
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d=>{h+=`<div style="text-align:center;font-size:9px;color:var(--text-muted);padding:2px">${d}</div>`;});
  for(let i=0;i<firstDay;i++)h+=`<div></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=d===now.getDate();
    const isSelected=task.due===dateStr;
    h+=`<button onclick="setTaskDueDate('${taskId}','${dateStr}')" style="padding:6px;text-align:center;font-size:10px;border-radius:4px;border:${isSelected?'1px solid var(--accent)':isToday?'1px solid var(--text-muted)':'1px solid transparent'};background:${isSelected?'var(--accent)':'var(--bg-surface)'};color:${isSelected?'#000':'var(--text-primary)'};cursor:pointer">${d}</button>`;
  }
  h+=`</div>`;
  h+=`<div style="display:flex;gap:6px;margin-top:10px">`;
  h+=`<button onclick="setTaskDueDate('${taskId}','')" style="flex:1;padding:6px;font-size:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-muted);cursor:pointer">Clear</button>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function setTaskDueDate(taskId,dateStr){
  const task=(S.tasks||[]).find(t=>t.id===taskId);if(!task)return;
  task.due=dateStr;save();
  document.getElementById('mini-datepicker').remove();
  showToast(dateStr?'Due date set: '+dateStr:'Due date cleared');
}
function showGratitudeJournal(){
  if(!S._gratitude)S._gratitude=[];
  const today=new Date().toISOString().split('T')[0];
  const panel=document.createElement('div');panel.id='gratitude-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Gratitude Journal</span><button onclick="document.getElementById('gratitude-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  const todayEntry=S._gratitude.find(g=>g.date===today);
  h+=`<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:6px">${new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})}</div>`;
  h+=`<textarea id="gratitude-input" style="width:100%;height:80px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;padding:10px;resize:none;box-sizing:border-box" placeholder="What are you grateful for today?">${todayEntry?esc(todayEntry.text):''}</textarea>`;
  h+=`<button onclick="saveGratitude()" style="margin-top:6px;padding:6px 16px;background:var(--accent);border:none;border-radius:4px;color:#000;font-weight:600;cursor:pointer;font-size:11px">Save</button></div>`;
  const recent=S._gratitude.filter(g=>g.date!==today).slice(0,10);
  if(recent.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Recent Entries (${S._gratitude.length} total)</div>`;
    h+=`<div style="display:grid;gap:6px">`;
    recent.forEach(g=>{
      h+=`<div style="padding:8px;background:var(--bg-surface);border-radius:6px;border-left:2px solid var(--accent)">`;
      h+=`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">${new Date(g.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</div>`;
      h+=`<div style="font-size:11px;color:var(--text-secondary);line-height:1.5">${esc(g.text)}</div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">Streak: ${calcGratitudeStreak()} days</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function saveGratitude(){
  const input=document.getElementById('gratitude-input');if(!input)return;
  const text=input.value.trim();if(!text)return;
  const today=new Date().toISOString().split('T')[0];
  if(!S._gratitude)S._gratitude=[];
  const existing=S._gratitude.findIndex(g=>g.date===today);
  if(existing>=0){S._gratitude[existing].text=text;}
  else{S._gratitude.unshift({date:today,text});}
  if(S._gratitude.length>365)S._gratitude=S._gratitude.slice(0,365);
  save();showToast('Gratitude saved');
}
function calcGratitudeStreak(){
  const entries=S._gratitude||[];if(!entries.length)return 0;
  const dates=entries.map(g=>g.date).sort().reverse();
  let streak=0;const now=new Date();
  for(let i=0;i<dates.length;i++){
    const expected=new Date(now);expected.setDate(expected.getDate()-i);
    if(dates[i]===expected.toISOString().split('T')[0])streak++;else break;
  }
  return streak;
}
function showTaskTemplateLibrary(){
  const templates=[
    {name:'Bug Fix',title:'Fix: ',priority:'p1',desc:'Steps to reproduce:\\n1. \\n\\nExpected:\\n\\nActual:\\n'},
    {name:'Feature Request',title:'Feature: ',priority:'p2',desc:'As a user, I want to...\\n\\nAcceptance criteria:\\n- [ ] \\n'},
    {name:'Research',title:'Research: ',priority:'p2',desc:'Questions to answer:\\n1. \\n\\nSources:\\n- \\n\\nFindings:\\n'},
    {name:'Meeting Follow-up',title:'Follow-up: ',priority:'p1',desc:'Meeting: \\nDate: '+new Date().toLocaleDateString()+'\\n\\nAction items:\\n- [ ] \\n'},
    {name:'Content Creation',title:'Create: ',priority:'p2',desc:'Topic: \\nAudience: \\nFormat: \\n\\nOutline:\\n1. \\n'},
    {name:'Code Review',title:'Review: ',priority:'p1',desc:'PR/Branch: \\n\\nChecklist:\\n- [ ] Tests pass\\n- [ ] No security issues\\n- [ ] Code is readable\\n'},
    {name:'Weekly Goal',title:'Week Goal: ',priority:'p1',desc:'Target: \\nDeadline: Friday\\n\\nMilestones:\\n- [ ] Mon: \\n- [ ] Wed: \\n- [ ] Fri: \\n'},
    {name:'Learning',title:'Learn: ',priority:'p3',desc:'Resource: \\nTime: \\n\\nNotes:\\n\\nKey takeaways:\\n1. \\n'},
  ];
  const panel=document.createElement('div');panel.id='task-template-lib-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Task Templates (${templates.length})</span><button onclick="document.getElementById('task-template-lib-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">`;
  templates.forEach((t,i)=>{
    const pColor=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
    h+=`<div onclick="createFromTaskTemplate(${i})" style="padding:12px;background:var(--bg-surface);border-radius:8px;cursor:pointer;border:1px solid transparent;border-left:3px solid ${pColor};transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent';this.style.borderLeftColor='${pColor}'">`;
    h+=`<div style="font-size:12px;font-weight:600;color:var(--text-primary)">${t.name}</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:4px">${t.desc.replace(/\\n/g,' ').substring(0,50)}...</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  window._taskTemplates=templates;
}
function createFromTaskTemplate(idx){
  const templates=window._taskTemplates;if(!templates||!templates[idx])return;
  const t=templates[idx];
  const title=prompt('Task title:',t.title);if(!title)return;
  if(!S.tasks)S.tasks=[];
  S.tasks.unshift({id:'t_'+Date.now(),title,status:'todo',priority:t.priority,project:'',due:'',created:new Date().toISOString(),description:t.desc.replace(/\\n/g,'\n'),subtasks:[]});
  save();const p=document.getElementById('task-template-lib-panel');if(p)p.remove();
  switchSection('tasks');renderTasks();showToast('Task created from template: '+t.name);
}
function showLifetimePomodoroStats(){
  const sessions=S._focusSessions||[];
  const totalMins=sessions.reduce((a,s)=>a+(s.duration||0),0);
  const totalSessions=sessions.length;
  const avgPerSession=totalSessions?Math.round(totalMins/totalSessions):0;
  const dayMap={};
  sessions.forEach(s=>{if(s.date){const d=s.date.split('T')[0];dayMap[d]=(dayMap[d]||0)+(s.duration||0);}});
  const activeDays=Object.keys(dayMap).length;
  const bestDay=Object.entries(dayMap).sort((a,b)=>b[1]-a[1])[0];
  const avgPerDay=activeDays?Math.round(totalMins/activeDays):0;
  const panel=document.createElement('div');panel.id='lifetime-pomo-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Lifetime Focus Stats</span><button onclick="document.getElementById('lifetime-pomo-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:var(--accent)">${Math.round(totalMins/60)}h</div><div style="font-size:9px;color:var(--text-muted)">Total Focus Time</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:#3b82f6">${totalSessions}</div><div style="font-size:9px;color:var(--text-muted)">Sessions</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:28px;font-weight:700;color:#f59e0b">${activeDays}</div><div style="font-size:9px;color:var(--text-muted)">Active Days</div></div>`;
  h+=`</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:16px;font-weight:600;color:#8b5cf6">${avgPerSession}m</div><div style="font-size:8px;color:var(--text-muted)">Avg/Session</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:16px;font-weight:600;color:#ec4899">${avgPerDay}m</div><div style="font-size:8px;color:var(--text-muted)">Avg/Day</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:16px;font-weight:600;color:#06b6d4">${bestDay?bestDay[1]+'m':'-'}</div><div style="font-size:8px;color:var(--text-muted)">Best Day</div></div>`;
  h+=`</div>`;
  if(bestDay)h+=`<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:8px">Best day: ${bestDay[0]}</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showCreationCalendar(){
  const content=S.content||[];const now=new Date();
  const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const dayMap={};
  content.forEach(c=>{
    if(c.created){
      const d=c.created.split('T')[0];
      const parts=d.split('-');if(parseInt(parts[0])===year&&parseInt(parts[1])-1===month){
        const day=parseInt(parts[2]);dayMap[day]=(dayMap[day]||0)+1;
      }
    }
  });
  const panel=document.createElement('div');panel.id='creation-calendar-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Creation Calendar</span><button onclick="document.getElementById('creation-calendar-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="text-align:center;font-size:12px;font-weight:600;color:var(--accent);margin-bottom:12px">${monthName}</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px">`;
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d=>{h+=`<div style="text-align:center;font-size:9px;color:var(--text-muted);padding:4px">${d}</div>`;});
  for(let i=0;i<firstDay;i++)h+=`<div></div>`;
  const maxCount=Math.max(...Object.values(dayMap),1);
  for(let d=1;d<=daysInMonth;d++){
    const count=dayMap[d]||0;
    const isToday=d===now.getDate();
    const intensity=count?Math.max(0.2,(count/maxCount)):0;
    h+=`<div title="Day ${d}: ${count} items" style="text-align:center;padding:8px 4px;border-radius:4px;font-size:10px;color:${isToday?'var(--accent)':'var(--text-primary)'};background:${count?'rgba(74,222,128,'+intensity+')':'var(--bg-surface)'};border:${isToday?'1px solid var(--accent)':'1px solid transparent'};font-weight:${isToday?'700':'400'}">${d}${count?'<div style="font-size:7px;color:var(--text-muted)">'+count+'</div>':''}</div>`;
  }
  h+=`</div>`;
  const totalThisMonth=Object.values(dayMap).reduce((a,b)=>a+b,0);
  h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:12px">${totalThisMonth} items created this month</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showSmartSuggestions(){
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const now=new Date();const today=now.toISOString().split('T')[0];
  const suggestions=[];
  const overdue=tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  if(overdue.length)suggestions.push({icon:'!',color:'#ef4444',text:`You have ${overdue.length} overdue tasks. Review and reschedule them.`,action:'Cmd+K > due groups'});
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  if(inProgress.length>5)suggestions.push({icon:'W',color:'#f59e0b',text:`${inProgress.length} tasks in progress. Consider completing some before starting new ones.`,action:'Focus on finishing'});
  if(inProgress.length===0&&tasks.filter(t=>t.status==='todo').length>0)suggestions.push({icon:'G',color:'#4ade80',text:'No tasks in progress. Start working on your highest priority todo.',action:'Move a task to in-progress'});
  const untagged=content.filter(c=>!(c.tags&&c.tags.length));
  if(untagged.length>5)suggestions.push({icon:'T',color:'#8b5cf6',text:`${untagged.length} content items lack tags. Tag them for better organization.`,action:'Cmd+K > auto tag'});
  const unreadLinks=links.filter(l=>l.category==='read-later');
  if(unreadLinks.length>10)suggestions.push({icon:'R',color:'#3b82f6',text:`${unreadLinks.length} links in "read later". Set aside time to review them.`,action:'Switch to Links section'});
  const sd=S._streakData||{};
  if(sd.lastActive!==today)suggestions.push({icon:'S',color:'#f59e0b',text:'You haven\'t logged activity today. Open any feature to start your streak!',action:'Track your streak'});
  if(!suggestions.length)suggestions.push({icon:'v',color:'#4ade80',text:'Everything looks great! Keep up the good work.',action:'No action needed'});
  const panel=document.createElement('div');panel.id='smart-suggestions-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Smart Suggestions (${suggestions.length})</span><button onclick="document.getElementById('smart-suggestions-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:8px">`;
  suggestions.forEach(s=>{
    h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${s.color}">`;
    h+=`<div style="display:flex;align-items:start;gap:10px"><div style="width:24px;height:24px;border-radius:50%;background:${s.color}20;display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-size:11px;font-weight:700;color:${s.color}">${s.icon}</span></div>`;
    h+=`<div><div style="font-size:11px;color:var(--text-primary);line-height:1.5">${esc(s.text)}</div>`;
    h+=`<div style="font-size:9px;color:var(--accent);margin-top:4px">${esc(s.action)}</div></div></div></div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showLinkCategoryChart(){
  const links=S.links||[];
  const catMap={};links.forEach(l=>{const c=l.category||'uncategorized';catMap[c]=(catMap[c]||0)+1;});
  const sorted=Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const total=links.length||1;
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316'];
  const panel=document.createElement('div');panel.id='link-category-chart';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Link Categories (${sorted.length})</span><button onclick="document.getElementById('link-category-chart').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;gap:3px;height:20px;border-radius:6px;overflow:hidden;margin-bottom:16px">`;
  sorted.forEach(([cat,count],i)=>{
    const pct=Math.max(3,(count/total)*100);
    h+=`<div title="${cat}: ${count}" style="width:${pct}%;background:${colors[i%colors.length]};min-width:4px"></div>`;
  });
  h+=`</div>`;
  h+=`<div style="display:grid;gap:6px">`;
  sorted.forEach(([cat,count],i)=>{
    const pct=Math.round((count/total)*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<div style="width:10px;height:10px;border-radius:3px;background:${colors[i%colors.length]};flex-shrink:0"></div>`;
    h+=`<span style="flex:1;font-size:11px;color:var(--text-primary)">${esc(cat)}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${count} (${pct}%)</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showPriorityDistribution(){
  const tasks=S.tasks||[];
  const pMap={p0:0,p1:0,p2:0,p3:0};
  tasks.forEach(t=>{const p=t.priority||'p3';pMap[p]=(pMap[p]||0)+1;});
  const total=tasks.length||1;
  const items=[
    {key:'p0',name:'P0 Critical',color:'#ef4444',count:pMap.p0},
    {key:'p1',name:'P1 High',color:'#f59e0b',count:pMap.p1},
    {key:'p2',name:'P2 Medium',color:'#3b82f6',count:pMap.p2},
    {key:'p3',name:'P3 Low',color:'#6b7280',count:pMap.p3},
  ];
  const panel=document.createElement('div');panel.id='priority-dist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Priority Distribution</span><button onclick="document.getElementById('priority-dist-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;gap:3px;height:24px;border-radius:6px;overflow:hidden;margin-bottom:16px">`;
  items.forEach(item=>{
    const pct=Math.max(2,(item.count/total)*100);
    h+=`<div style="width:${pct}%;background:${item.color};min-width:4px"></div>`;
  });
  h+=`</div>`;
  h+=`<div style="display:grid;gap:8px">`;
  items.forEach(item=>{
    const pct=Math.round((item.count/total)*100);
    h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<div style="width:14px;height:14px;border-radius:4px;background:${item.color};flex-shrink:0"></div>`;
    h+=`<span style="flex:1;font-size:12px;color:var(--text-primary)">${item.name}</span>`;
    h+=`<span style="font-size:14px;font-weight:700;color:${item.color}">${item.count}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${pct}%</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMoodTracker(){
  if(!S._moods)S._moods=[];
  const today=new Date().toISOString().split('T')[0];
  const moods=[
    {emoji:'Great',value:5,color:'#4ade80'},
    {emoji:'Good',value:4,color:'#22d3ee'},
    {emoji:'Okay',value:3,color:'#f59e0b'},
    {emoji:'Low',value:2,color:'#f97316'},
    {emoji:'Bad',value:1,color:'#ef4444'},
  ];
  const todayMood=S._moods.find(m=>m.date===today);
  const panel=document.createElement('div');panel.id='mood-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Mood Tracker</span><button onclick="document.getElementById('mood-tracker-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="font-size:11px;color:var(--accent);margin-bottom:12px">How are you feeling today?</div>`;
  h+=`<div style="display:flex;gap:8px;justify-content:center;margin-bottom:20px">`;
  moods.forEach(m=>{
    const selected=todayMood&&todayMood.value===m.value;
    h+=`<button onclick="logMood(${m.value})" style="padding:10px 14px;border-radius:8px;border:2px solid ${selected?m.color:'var(--border)'};background:${selected?m.color+'20':'var(--bg-surface)'};color:${m.color};cursor:pointer;font-size:11px;font-weight:${selected?'700':'400'};min-width:55px">${m.emoji}</button>`;
  });
  h+=`</div>`;
  const recent=S._moods.slice(0,14);
  if(recent.length){
    h+=`<div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Last 14 Days</div>`;
    h+=`<div style="display:flex;align-items:end;gap:4px;height:60px;margin-bottom:8px">`;
    recent.reverse().forEach(m=>{
      const mood=moods.find(x=>x.value===m.value)||moods[2];
      const height=m.value*12;
      h+=`<div title="${m.date}: ${mood.emoji}" style="flex:1;height:${height}px;background:${mood.color};border-radius:3px 3px 0 0;min-width:4px"></div>`;
    });
    h+=`</div>`;
    const avg=S._moods.reduce((a,m)=>a+m.value,0)/S._moods.length;
    const avgMood=moods.find(m=>m.value===Math.round(avg))||moods[2];
    h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center">Average: <span style="color:${avgMood.color}">${avgMood.emoji}</span> (${avg.toFixed(1)}/5) | ${S._moods.length} entries</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function logMood(value){
  if(!S._moods)S._moods=[];
  const today=new Date().toISOString().split('T')[0];
  const existing=S._moods.findIndex(m=>m.date===today);
  if(existing>=0){S._moods[existing].value=value;}
  else{S._moods.unshift({date:today,value});}
  if(S._moods.length>365)S._moods=S._moods.slice(0,365);
  save();const p=document.getElementById('mood-tracker-panel');if(p)p.remove();showMoodTracker();showToast('Mood logged');
}
function showRepoTimeline(){
  const repos=S.repos||[];
  if(!repos.length){showToast('No repos configured');return;}
  const panel=document.createElement('div');panel.id='repo-timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const colors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#8b5cf6'];
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Repo Overview (${repos.length})</span><button onclick="document.getElementById('repo-timeline-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:8px">`;
  repos.forEach((r,i)=>{
    const color=colors[i%colors.length];
    const statusColor=r.status==='active'?'#4ade80':r.status==='complete'?'#3b82f6':'#6b7280';
    h+=`<div style="padding:12px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${color}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
    h+=`<span style="font-size:12px;font-weight:600;color:${color}">${esc(r.name)}</span>`;
    h+=`<span style="font-size:9px;padding:2px 8px;border-radius:10px;background:${statusColor}20;color:${statusColor}">${r.status||'unknown'}</span></div>`;
    if(r.live)h+=`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">${esc(r.live)}</div>`;
    if(r.url)h+=`<div style="font-size:9px;color:var(--text-muted)">${esc(r.url)}</div>`;
    if(r.lastCommit)h+=`<div style="font-size:9px;color:var(--accent);margin-top:4px">Last commit: ${esc(r.lastCommit)}</div>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:12px">${repos.filter(r=>r.status==='active').length} active | ${repos.filter(r=>r.status==='complete').length} complete</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMicroJournal(){
  if(!S._microJournal)S._microJournal=[];
  const today=new Date().toISOString().split('T')[0];
  const panel=document.createElement('div');panel.id='micro-journal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Micro Journal</span><button onclick="document.getElementById('micro-journal-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:flex;gap:6px;margin-bottom:16px"><input id="micro-journal-input" type="text" placeholder="One-liner for today..." style="flex:1;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px" onkeydown="if(event.key==='Enter')saveMicroJournal()">`;
  h+=`<button onclick="saveMicroJournal()" style="padding:8px 14px;background:var(--accent);border:none;border-radius:6px;color:#000;font-weight:600;cursor:pointer;font-size:11px">Save</button></div>`;
  const entries=S._microJournal.slice(0,30);
  if(entries.length){
    h+=`<div style="display:grid;gap:4px">`;
    entries.forEach(e=>{
      const dayName=new Date(e.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:4px;border-left:2px solid var(--accent)">`;
      h+=`<span style="font-size:9px;color:var(--text-muted);width:55px;flex-shrink:0">${dayName}</span>`;
      h+=`<span style="font-size:11px;color:var(--text-secondary)">${esc(e.text)}</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }
  h+=`<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:8px">${S._microJournal.length} total entries</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('micro-journal-input').focus();
}
function saveMicroJournal(){
  const input=document.getElementById('micro-journal-input');if(!input)return;
  const text=input.value.trim();if(!text)return;
  if(!S._microJournal)S._microJournal=[];
  S._microJournal.unshift({date:new Date().toISOString().split('T')[0],text,ts:Date.now()});
  if(S._microJournal.length>365)S._microJournal=S._microJournal.slice(0,365);
  save();const p=document.getElementById('micro-journal-panel');if(p)p.remove();showMicroJournal();showToast('Journal entry saved');
}
function showCompletionRate(){
  const tasks=S.tasks||[];const now=new Date();
  const weeks=[];
  for(let w=7;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-w*7);
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+7);
    const wStart=weekStart.toISOString().split('T')[0];
    const wEnd=weekEnd.toISOString().split('T')[0];
    const created=tasks.filter(t=>t.created&&t.created>=wStart&&t.created<wEnd).length;
    const completed=tasks.filter(t=>t.status==='done'&&t.created&&t.created>=wStart&&t.created<wEnd).length;
    const rate=created?Math.round((completed/created)*100):0;
    weeks.push({label:weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'}),created,completed,rate});
  }
  const panel=document.createElement('div');panel.id='completion-rate-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Weekly Completion Rate</span><button onclick="document.getElementById('completion-rate-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;gap:6px">`;
  weeks.forEach(w=>{
    const rateColor=w.rate>=75?'#4ade80':w.rate>=50?'#f59e0b':'#ef4444';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px">`;
    h+=`<span style="font-size:10px;color:var(--text-muted);width:55px;flex-shrink:0">${w.label}</span>`;
    h+=`<div style="flex:1;height:8px;background:var(--bg-base);border-radius:4px"><div style="height:100%;width:${w.rate}%;background:${rateColor};border-radius:4px"></div></div>`;
    h+=`<span style="font-size:11px;font-weight:600;color:${rateColor};width:40px;text-align:right">${w.rate}%</span>`;
    h+=`<span style="font-size:9px;color:var(--text-muted);width:50px;text-align:right">${w.completed}/${w.created}</span>`;
    h+=`</div>`;
  });
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function exportContentAsBook(){
  const content=S.content||[];const docs=S.writerDocs||[];
  let md='# ASTRA Content Collection\n\n';
  md+='*Exported: '+new Date().toLocaleString()+'*\n\n---\n\n';
  md+='## Table of Contents\n\n';
  const themes=new Set();content.forEach(c=>{if(c.theme)themes.add(c.theme);});
  let chapNum=1;
  themes.forEach(t=>{md+=`${chapNum}. ${t}\n`;chapNum++;});
  if(docs.length)md+=`${chapNum}. Writer Documents\n`;
  md+='\n---\n\n';
  chapNum=1;
  themes.forEach(theme=>{
    md+=`## Chapter ${chapNum}: ${theme}\n\n`;
    const items=content.filter(c=>c.theme===theme);
    items.forEach(c=>{
      const date=c.created?new Date(c.created).toLocaleDateString():'';
      md+=`### ${date}\n\n${c.body||''}\n\n---\n\n`;
    });
    chapNum++;
  });
  const unthemed=content.filter(c=>!c.theme);
  if(unthemed.length){
    md+=`## Miscellaneous\n\n`;
    unthemed.forEach(c=>{md+=`${c.body||''}\n\n---\n\n`;});
  }
  if(docs.length){
    md+=`## Writer Documents\n\n`;
    docs.forEach(d=>{md+=`### ${d.title||'Untitled'}\n\n${d.body||''}\n\n---\n\n`;});
  }
  const blob=new Blob([md],{type:'text/markdown'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download='astra-content-book-'+new Date().toISOString().split('T')[0]+'.md';
  a.click();URL.revokeObjectURL(url);
  showToast('Content book exported ('+content.length+' items, '+docs.length+' docs)');
}
function showWorkspaceOverview(){
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];const docs=S.writerDocs||[];const projects=S.projects||[];const repos=S.repos||[];
  const now=new Date();const today=now.toISOString().split('T')[0];
  const storageKB=Math.round(new Blob([JSON.stringify(S)]).size/1024);
  const done=tasks.filter(t=>t.status==='done').length;
  const overdue=tasks.filter(t=>t.due&&t.due<today&&t.status!=='done').length;
  const inProg=tasks.filter(t=>t.status==='in-progress').length;
  const totalWords=content.reduce((a,c)=>a+((c.body||'').split(/\s+/).filter(w=>w).length),0)+docs.reduce((a,d)=>a+((d.body||'').split(/\s+/).filter(w=>w).length),0);
  const panel=document.createElement('div');panel.id='workspace-overview-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:95vw;max-height:85vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Workspace Overview</span><button onclick="document.getElementById('workspace-overview-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:var(--accent)">${tasks.length}</div><div style="font-size:8px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#3b82f6">${content.length}</div><div style="font-size:8px;color:var(--text-muted)">Content</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#f59e0b">${links.length}</div><div style="font-size:8px;color:var(--text-muted)">Links</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#8b5cf6">${docs.length}</div><div style="font-size:8px;color:var(--text-muted)">Docs</div></div>`;
  h+=`</div>`;
  h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Tasks</div>`;
  h+=`<div style="font-size:10px;color:var(--text-secondary)">Done: <span style="color:#4ade80">${done}</span> | In Progress: <span style="color:#3b82f6">${inProg}</span> | Overdue: <span style="color:#ef4444">${overdue}</span></div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">Writing</div>`;
  h+=`<div style="font-size:10px;color:var(--text-secondary)">Total words: <span style="color:var(--accent)">${totalWords.toLocaleString()}</span></div></div>`;
  h+=`</div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:14px;font-weight:600;color:#ec4899">${projects.length}</div><div style="font-size:8px;color:var(--text-muted)">Projects</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:14px;font-weight:600;color:#06b6d4">${repos.length}</div><div style="font-size:8px;color:var(--text-muted)">Repos</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:8px;border-radius:6px;text-align:center"><div style="font-size:14px;font-weight:600;color:#f97316">${storageKB}KB</div><div style="font-size:8px;color:var(--text-muted)">Storage</div></div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentSentiment(){
  const content=S.content||[];
  const positive=['great','good','excellent','amazing','wonderful','happy','love','awesome','fantastic','beautiful','perfect','success','win','best','excited','grateful','brilliant','incredible','outstanding'];
  const negative=['bad','terrible','awful','horrible','sad','angry','frustrated','hate','worst','fail','problem','issue','bug','broken','stuck','difficult','painful','disappointing','annoying'];
  let posCount=0,negCount=0,neutralCount=0;
  const results=[];
  content.forEach(c=>{
    const words=(c.body||'').toLowerCase().split(/\s+/);
    let pos=0,neg=0;
    words.forEach(w=>{
      if(positive.some(p=>w.includes(p)))pos++;
      if(negative.some(n=>w.includes(n)))neg++;
    });
    const sentiment=pos>neg?'positive':neg>pos?'negative':'neutral';
    if(sentiment==='positive')posCount++;
    else if(sentiment==='negative')negCount++;
    else neutralCount++;
    results.push({body:(c.body||'').substring(0,50),sentiment,pos,neg});
  });
  const panel=document.createElement('div');panel.id='sentiment-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-size:14px;font-weight:600;color:var(--text-primary)">Content Sentiment</span><button onclick="document.getElementById('sentiment-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div>`;
  h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${posCount}</div><div style="font-size:9px;color:var(--text-muted)">Positive</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#6b7280">${neutralCount}</div><div style="font-size:9px;color:var(--text-muted)">Neutral</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#ef4444">${negCount}</div><div style="font-size:9px;color:var(--text-muted)">Negative</div></div>`;
  h+=`</div>`;
  const total=content.length||1;
  h+=`<div style="display:flex;gap:2px;height:16px;border-radius:4px;overflow:hidden;margin-bottom:12px">`;
  h+=`<div style="width:${(posCount/total)*100}%;background:#4ade80"></div>`;
  h+=`<div style="width:${(neutralCount/total)*100}%;background:#6b7280"></div>`;
  h+=`<div style="width:${(negCount/total)*100}%;background:#ef4444"></div>`;
  h+=`</div>`;
  h+=`<div style="font-size:9px;color:var(--text-muted);text-align:center">Keyword-based analysis of ${content.length} items (approximate)</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectCompletionTimeline(){
  let panel=document.getElementById('proj-timeline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=(S.projects||[]);
  const tasks=(S.tasks||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Project Completion Timeline</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!projects.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No projects found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const w=620,barH=32,gap=8,top=30;
  const svgH=top+projects.length*(barH+gap)+20;
  h+=`<svg width="100%" viewBox="0 0 ${w} ${svgH}" style="display:block">`;
  h+=`<text x="${w/2}" y="18" text-anchor="middle" fill="var(--text-muted)" font-size="11">Completion %</text>`;
  const labels=['0%','25%','50%','75%','100%'];
  labels.forEach((l,i)=>{const x=80+i*(w-100)/4;h+=`<text x="${x}" y="${top-4}" fill="var(--text-muted)" font-size="9" text-anchor="middle">${l}</text>`;h+=`<line x1="${x}" y1="${top}" x2="${x}" y2="${svgH-10}" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="3,3"/>`;});
  projects.forEach((p,i)=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id||t.project===p.name);
    const done=pTasks.filter(t=>t.status==='done').length;
    const pct=pTasks.length?Math.round(done/pTasks.length*100):0;
    const y=top+i*(barH+gap);
    const maxW=w-100;
    const barW=maxW*pct/100;
    const color=pct>=75?'#4ade80':pct>=50?'#facc15':pct>=25?'#fb923c':'#f87171';
    h+=`<text x="75" y="${y+barH/2+4}" text-anchor="end" fill="var(--text-secondary)" font-size="10">${(p.name||'Untitled').substring(0,12)}</text>`;
    h+=`<rect x="80" y="${y}" width="${maxW}" height="${barH}" rx="4" fill="var(--bg-surface)"/>`;
    if(barW>0)h+=`<rect x="80" y="${y}" width="${barW}" height="${barH}" rx="4" fill="${color}" opacity="0.8"/>`;
    h+=`<text x="${80+maxW/2}" y="${y+barH/2+4}" text-anchor="middle" fill="var(--text-primary)" font-size="11" font-weight="600">${pct}% (${done}/${pTasks.length})</text>`;
  });
  h+=`</svg>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentCalendar(){
  let panel=document.getElementById('content-cal-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-cal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleString('default',{month:'long',year:'numeric'});
  const dayMap={};
  content.forEach(c=>{
    if(!c.createdAt)return;
    const d=new Date(c.createdAt);
    if(d.getFullYear()===year&&d.getMonth()===month){
      const day=d.getDate();
      if(!dayMap[day])dayMap[day]=[];
      dayMap[day].push(c);
    }
  });
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Calendar - '+monthName+'</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:8px">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div style="text-align:center;font-size:10px;color:var(--text-muted);padding:4px">${d}</div>`;});
  h+='</div><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px">';
  for(let i=0;i<firstDay;i++)h+='<div></div>';
  for(let d=1;d<=daysInMonth;d++){
    const isToday=d===now.getDate();
    const items=dayMap[d]||[];
    const bg=items.length>0?'rgba(74,222,128,0.15)':'var(--bg-surface)';
    const border=isToday?'border:1px solid var(--accent)':'border:1px solid transparent';
    h+=`<div style="min-height:50px;${border};background:${bg};border-radius:4px;padding:3px;position:relative">`;
    h+=`<div style="font-size:10px;color:${isToday?'var(--accent)':'var(--text-muted)'};font-weight:${isToday?'700':'400'}">${d}</div>`;
    if(items.length>0)h+=`<div style="font-size:9px;color:var(--accent);margin-top:2px">${items.length} item${items.length>1?'s':''}</div>`;
    items.slice(0,2).forEach(c=>{h+=`<div style="font-size:8px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.title||'').substring(0,15)}</div>`;});
    h+='</div>';
  }
  h+='</div>';
  const totalItems=content.filter(c=>{if(!c.createdAt)return false;const d=new Date(c.createdAt);return d.getFullYear()===year&&d.getMonth()===month;}).length;
  const activeDays=Object.keys(dayMap).length;
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">${totalItems} items created across ${activeDays} days this month</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskVelocity(){
  let panel=document.getElementById('velocity-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='velocity-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const weeks=8;
  const now=new Date();
  const weekData=[];
  for(let w=weeks-1;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-w*7-weekStart.getDay());weekStart.setHours(0,0,0,0);
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+7);
    const done=tasks.filter(t=>{
      if(t.status!=='done'||!t.completedAt)return false;
      const d=new Date(t.completedAt);return d>=weekStart&&d<weekEnd;
    }).length;
    const created=tasks.filter(t=>{
      if(!t.createdAt)return false;
      const d=new Date(t.createdAt);return d>=weekStart&&d<weekEnd;
    }).length;
    const label=weekStart.toLocaleDateString('en',{month:'short',day:'numeric'});
    weekData.push({label,done,created});
  }
  const maxVal=Math.max(...weekData.map(w=>Math.max(w.done,w.created)),1);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Task Velocity (8 Weeks)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:4px;margin-bottom:8px"><span style="font-size:10px;color:#4ade80">■ Completed</span><span style="font-size:10px;color:#60a5fa">■ Created</span></div>';
  const svgW=600,svgH=200,padL=40,padB=30,padT=10;
  const chartW=svgW-padL-10,chartH=svgH-padT-padB;
  const barW=chartW/weeks/2-4;
  h+=`<svg width="100%" viewBox="0 0 ${svgW} ${svgH}" style="display:block">`;
  for(let i=0;i<=4;i++){
    const y=padT+chartH-i*(chartH/4);
    const val=Math.round(maxVal*i/4);
    h+=`<line x1="${padL}" y1="${y}" x2="${svgW-10}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;
    h+=`<text x="${padL-5}" y="${y+3}" text-anchor="end" fill="var(--text-muted)" font-size="9">${val}</text>`;
  }
  weekData.forEach((w,i)=>{
    const x=padL+i*(chartW/weeks)+chartW/weeks/2;
    const doneH=maxVal?w.done/maxVal*chartH:0;
    const createdH=maxVal?w.created/maxVal*chartH:0;
    h+=`<rect x="${x-barW-1}" y="${padT+chartH-doneH}" width="${barW}" height="${doneH}" rx="2" fill="#4ade80" opacity="0.8"/>`;
    h+=`<rect x="${x+1}" y="${padT+chartH-createdH}" width="${barW}" height="${createdH}" rx="2" fill="#60a5fa" opacity="0.8"/>`;
    if(w.done>0)h+=`<text x="${x-barW/2-1}" y="${padT+chartH-doneH-3}" text-anchor="middle" fill="#4ade80" font-size="9">${w.done}</text>`;
    if(w.created>0)h+=`<text x="${x+barW/2+1}" y="${padT+chartH-createdH-3}" text-anchor="middle" fill="#60a5fa" font-size="9">${w.created}</text>`;
    h+=`<text x="${x}" y="${svgH-5}" text-anchor="middle" fill="var(--text-muted)" font-size="8">${w.label}</text>`;
  });
  h+=`</svg>`;
  const avgDone=weekData.reduce((s,w)=>s+w.done,0)/weeks;
  const avgCreated=weekData.reduce((s,w)=>s+w.created,0)/weeks;
  h+=`<div style="display:flex;gap:20px;justify-content:center;margin-top:12px">`;
  h+=`<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:#4ade80">${avgDone.toFixed(1)}</div><div style="font-size:10px;color:var(--text-muted)">Avg completed/week</div></div>`;
  h+=`<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:#60a5fa">${avgCreated.toFixed(1)}</div><div style="font-size:10px;color:var(--text-muted)">Avg created/week</div></div>`;
  h+=`<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:${avgDone>=avgCreated?'#4ade80':'#f87171'}">${avgDone>=avgCreated?'+':'-'}${Math.abs(avgDone-avgCreated).toFixed(1)}</div><div style="font-size:10px;color:var(--text-muted)">Net velocity</div></div>`;
  h+=`</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTagCloud(){
  let panel=document.getElementById('tag-cloud-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='tag-cloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tagCount={};
  (S.content||[]).forEach(c=>{(c.tags||[]).forEach(t=>{tagCount[t]=(tagCount[t]||0)+1;});});
  (S.tasks||[]).forEach(t=>{(t.tags||[]).forEach(tg=>{tagCount[tg]=(tagCount[tg]||0)+1;});});
  (S.links||[]).forEach(l=>{(l.tags||[]).forEach(t=>{tagCount[t]=(tagCount[t]||0)+1;});});
  const tags=Object.entries(tagCount).sort((a,b)=>b[1]-a[1]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Tag Cloud ('+tags.length+' tags)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!tags.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No tags found across content, tasks, or links</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const maxCount=tags[0][1];
  const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#f87171','#a78bfa','#34d399','#f472b6','#38bdf8','#fbbf24'];
  h+='<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:20px">';
  tags.forEach(([tag,count],i)=>{
    const size=12+Math.round((count/maxCount)*24);
    const color=colors[i%colors.length];
    const opacity=0.5+count/maxCount*0.5;
    h+=`<span style="font-size:${size}px;color:${color};opacity:${opacity};cursor:default;padding:2px 6px;transition:opacity 0.2s" title="${count} items">${esc(tag)}</span>`;
  });
  h+='</div>';
  h+='<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Top 10 tags:</div>';
  tags.slice(0,10).forEach(([tag,count])=>{
    const pct=Math.round(count/maxCount*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><div style="width:80px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(tag)}</div><div style="flex:1;height:12px;background:var(--bg-surface);border-radius:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:6px"></div></div><div style="font-size:10px;color:var(--text-muted);width:30px">${count}</div></div>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDueCalendar(){
  let panel=document.getElementById('due-cal-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='due-cal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&t.due);
  const now=new Date();const year=now.getFullYear();const month=now.getMonth();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const monthName=now.toLocaleString('default',{month:'long',year:'numeric'});
  const dayMap={};
  tasks.forEach(t=>{
    const d=new Date(t.due);
    if(d.getFullYear()===year&&d.getMonth()===month){
      const day=d.getDate();
      if(!dayMap[day])dayMap[day]=[];
      dayMap[day].push(t);
    }
  });
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Due Date Calendar - '+monthName+'</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:8px">';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{h+=`<div style="text-align:center;font-size:10px;color:var(--text-muted);padding:4px">${d}</div>`;});
  h+='</div><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px">';
  for(let i=0;i<firstDay;i++)h+='<div></div>';
  const today=now.getDate();
  for(let d=1;d<=daysInMonth;d++){
    const isToday=d===today;
    const items=dayMap[d]||[];
    const isOverdue=d<today&&items.length>0;
    const bg=isOverdue?'rgba(248,113,113,0.15)':items.length>0?'rgba(74,222,128,0.15)':'var(--bg-surface)';
    const border=isToday?'border:1px solid var(--accent)':'border:1px solid transparent';
    h+=`<div style="min-height:50px;${border};background:${bg};border-radius:4px;padding:3px">`;
    h+=`<div style="font-size:10px;color:${isToday?'var(--accent)':isOverdue?'#f87171':'var(--text-muted)'};font-weight:${isToday?'700':'400'}">${d}</div>`;
    if(items.length>0)h+=`<div style="font-size:9px;color:${isOverdue?'#f87171':'var(--accent)'}">${items.length} task${items.length>1?'s':''}</div>`;
    items.slice(0,2).forEach(t=>{
      const pColor=t.priority==='p0'?'#f87171':t.priority==='p1'?'#fb923c':t.priority==='p2'?'#60a5fa':'#6b7280';
      h+=`<div style="font-size:8px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap"><span style="color:${pColor}">●</span> ${esc(t.title||'').substring(0,14)}</div>`;
    });
    h+='</div>';
  }
  h+='</div>';
  const overdue=tasks.filter(t=>{const d=new Date(t.due);return d<now;}).length;
  const upcoming=tasks.filter(t=>{const d=new Date(t.due);const week=new Date(now);week.setDate(week.getDate()+7);return d>=now&&d<=week;}).length;
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:12px;font-size:10px;color:var(--text-muted)"><span style="color:#f87171">${overdue} overdue</span><span style="color:#facc15">${upcoming} due this week</span><span>${tasks.length} total open with dates</span></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProductivityInsights(){
  let panel=document.getElementById('productivity-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='productivity-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const content=(S.content||[]);const links=(S.links||[]);
  const now=new Date();
  const weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
  const twoWeeksAgo=new Date(now);twoWeeksAgo.setDate(twoWeeksAgo.getDate()-14);
  const thisWeekDone=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=weekAgo).length;
  const lastWeekDone=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=twoWeeksAgo&&new Date(t.completedAt)<weekAgo).length;
  const thisWeekContent=content.filter(c=>c.createdAt&&new Date(c.createdAt)>=weekAgo).length;
  const lastWeekContent=content.filter(c=>c.createdAt&&new Date(c.createdAt)>=twoWeeksAgo&&new Date(c.createdAt)<weekAgo).length;
  const thisWeekLinks=links.filter(l=>l.createdAt&&new Date(l.createdAt)>=weekAgo).length;
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now).length;
  const wip=tasks.filter(t=>t.status==='in-progress').length;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Productivity Insights</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const taskTrend=thisWeekDone>lastWeekDone?'up':thisWeekDone<lastWeekDone?'down':'flat';
  const contentTrend=thisWeekContent>lastWeekContent?'up':thisWeekContent<lastWeekContent?'down':'flat';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${thisWeekDone}</div><div style="font-size:10px;color:var(--text-muted)">Tasks done this week</div><div style="font-size:10px;color:${taskTrend==='up'?'#4ade80':taskTrend==='down'?'#f87171':'var(--text-muted)'}">${taskTrend==='up'?'^ Up':'v Down'} from ${lastWeekDone} last week</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#60a5fa">${thisWeekContent}</div><div style="font-size:10px;color:var(--text-muted)">Content created this week</div><div style="font-size:10px;color:${contentTrend==='up'?'#4ade80':contentTrend==='down'?'#f87171':'var(--text-muted)'}">${contentTrend==='up'?'^ Up':'v Down'} from ${lastWeekContent} last week</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#facc15">${thisWeekLinks}</div><div style="font-size:10px;color:var(--text-muted)">Links saved this week</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:${overdue>0?'#f87171':'#4ade80'}">${overdue}</div><div style="font-size:10px;color:var(--text-muted)">Overdue tasks</div></div>`;
  h+='</div>';
  h+='<div style="border-top:1px solid var(--border);padding-top:12px"><div style="font-size:12px;font-weight:600;color:var(--text-primary);margin-bottom:8px">Insights</div>';
  const insights=[];
  if(overdue>3)insights.push({icon:'!',color:'#f87171',text:`You have ${overdue} overdue tasks. Consider triaging: close outdated ones or reschedule.`});
  if(wip>5)insights.push({icon:'!',color:'#fb923c',text:`${wip} tasks in-progress simultaneously. Focus on finishing before starting new.`});
  if(thisWeekDone>lastWeekDone*1.5&&lastWeekDone>0)insights.push({icon:'+',color:'#4ade80',text:`Great momentum! Task completion up ${Math.round((thisWeekDone/lastWeekDone-1)*100)}% vs last week.`});
  if(thisWeekDone===0)insights.push({icon:'?',color:'#facc15',text:'No tasks completed this week yet. Try breaking large tasks into smaller ones.'});
  if(thisWeekContent>0&&thisWeekDone>0)insights.push({icon:'+',color:'#4ade80',text:'Balanced week: creating content AND completing tasks. Keep it up.'});
  if(tasks.filter(t=>t.status==='todo').length>20)insights.push({icon:'!',color:'#fb923c',text:`${tasks.filter(t=>t.status==='todo').length} tasks in backlog. Consider archiving or prioritizing.`});
  if(!insights.length)insights.push({icon:'+',color:'var(--text-muted)',text:'Looking good. Keep building consistently.'});
  insights.forEach(ins=>{
    h+=`<div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:8px;padding:8px;background:var(--bg-surface);border-radius:6px"><span style="color:${ins.color};font-weight:700;font-size:14px;min-width:16px">${ins.icon}</span><span style="font-size:11px;color:var(--text-secondary)">${ins.text}</span></div>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showCategoryBreakdown(){
  let panel=document.getElementById('cat-breakdown-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='cat-breakdown-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const catCount={};
  content.forEach(c=>{const cat=c.theme||c.category||'Uncategorized';catCount[cat]=(catCount[cat]||0)+1;});
  const cats=Object.entries(catCount).sort((a,b)=>b[1]-a[1]);
  const total=content.length||1;
  const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#f87171','#a78bfa','#34d399','#f472b6','#38bdf8','#fbbf24','#818cf8','#2dd4bf'];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Category Breakdown</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!cats.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No content found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  // Horizontal stacked bar
  h+='<div style="display:flex;height:32px;border-radius:8px;overflow:hidden;margin-bottom:16px">';
  cats.forEach(([cat,count],i)=>{
    const pct=count/total*100;
    if(pct<2)return;
    h+=`<div style="width:${pct}%;background:${colors[i%colors.length]};display:flex;align-items:center;justify-content:center" title="${cat}: ${count} (${pct.toFixed(1)}%)">`;
    if(pct>8)h+=`<span style="font-size:9px;color:#000;font-weight:600">${pct.toFixed(0)}%</span>`;
    h+='</div>';
  });
  h+='</div>';
  // Legend list
  cats.forEach(([cat,count],i)=>{
    const pct=(count/total*100).toFixed(1);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">`;
    h+=`<div style="width:12px;height:12px;border-radius:3px;background:${colors[i%colors.length]};flex-shrink:0"></div>`;
    h+=`<div style="flex:1;font-size:11px;color:var(--text-secondary)">${esc(cat)}</div>`;
    h+=`<div style="font-size:11px;color:var(--text-muted)">${count} (${pct}%)</div>`;
    h+=`</div>`;
  });
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">${content.length} total items across ${cats.length} categories</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showRecentActivity(){
  let panel=document.getElementById('activity-feed-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='activity-feed-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const activities=[];
  (S.tasks||[]).forEach(t=>{
    if(t.createdAt)activities.push({type:'task',action:'created',title:t.title||'Untitled',date:t.createdAt,color:'#60a5fa'});
    if(t.completedAt)activities.push({type:'task',action:'completed',title:t.title||'Untitled',date:t.completedAt,color:'#4ade80'});
  });
  (S.content||[]).forEach(c=>{
    if(c.createdAt)activities.push({type:'content',action:'added',title:c.title||'Untitled',date:c.createdAt,color:'#a78bfa'});
    if(c.updatedAt&&c.updatedAt!==c.createdAt)activities.push({type:'content',action:'updated',title:c.title||'Untitled',date:c.updatedAt,color:'#818cf8'});
  });
  (S.links||[]).forEach(l=>{
    if(l.createdAt)activities.push({type:'link',action:'saved',title:l.title||l.url||'Untitled',date:l.createdAt,color:'#38bdf8'});
  });
  (S.writerDocs||[]).forEach(d=>{
    if(d.updatedAt)activities.push({type:'doc',action:'edited',title:d.title||'Untitled',date:d.updatedAt,color:'#fbbf24'});
  });
  activities.sort((a,b)=>new Date(b.date)-new Date(a.date));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Recent Activity</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!activities.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No activity recorded yet</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const shown=activities.slice(0,50);
  let lastDate='';
  shown.forEach(a=>{
    const d=new Date(a.date);
    const dateStr=d.toLocaleDateString('en',{month:'short',day:'numeric'});
    if(dateStr!==lastDate){
      h+=`<div style="font-size:10px;color:var(--text-muted);margin:12px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--border)">${dateStr}</div>`;
      lastDate=dateStr;
    }
    const time=d.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit'});
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 0">`;
    h+=`<div style="width:6px;height:6px;border-radius:50%;background:${a.color};flex-shrink:0"></div>`;
    h+=`<div style="font-size:11px;color:var(--text-secondary);flex:1"><span style="color:${a.color}">${a.type}</span> ${a.action}: <span style="color:var(--text-primary)">${esc(a.title).substring(0,40)}</span></div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted)">${time}</div>`;
    h+=`</div>`;
  });
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">Showing ${shown.length} of ${activities.length} activities</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickNote(){
  let panel=document.getElementById('quick-note-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-note-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-weight:700;font-size:13px;color:var(--text-primary)">Quick Note</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<textarea id="quick-note-text" style="width:100%;height:100px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;resize:vertical;font-family:inherit" placeholder="Type a quick note..."></textarea>';
  h+='<div style="display:flex;gap:8px;margin-top:8px">';
  h+='<input id="quick-note-tags" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:11px" placeholder="Tags (comma-separated)">';
  h+=`<button onclick="(function(){const text=document.getElementById('quick-note-text').value.trim();if(!text)return;if(!S.content)S.content=[];const title=text.substring(0,50);const tags=document.getElementById('quick-note-tags').value.split(',').map(t=>t.trim()).filter(Boolean);S.content.unshift({id:'c_'+Date.now(),title:title,body:text,tags:tags,theme:'Quick Note',createdAt:new Date().toISOString(),pinned:false});save();document.getElementById('quick-note-panel').remove();if(typeof renderContent==='function')renderContent();})()" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer">Save</button>`;
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const ta=document.getElementById('quick-note-text');if(ta)ta.focus();},100);
}
function showWriterStats(){
  let panel=document.getElementById('writer-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writer-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const docs=(S.writerDocs||[]);
  const totalWords=docs.reduce((s,d)=>{const w=(d.content||'').trim().split(/\s+/).filter(Boolean).length;return s+w;},0);
  const totalChars=docs.reduce((s,d)=>s+(d.content||'').length,0);
  const avgWords=docs.length?Math.round(totalWords/docs.length):0;
  const longest=docs.reduce((max,d)=>{const w=(d.content||'').trim().split(/\s+/).filter(Boolean).length;return w>max.words?{title:d.title,words:w}:max;},{title:'',words:0});
  const versions=docs.reduce((s,d)=>s+(d.versions||[]).length,0);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Writer Statistics</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${docs.length}</div><div style="font-size:10px;color:var(--text-muted)">Documents</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#60a5fa">${totalWords.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted)">Total Words</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#facc15">${avgWords}</div><div style="font-size:10px;color:var(--text-muted)">Avg Words/Doc</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#a78bfa">${totalChars.toLocaleString()}</div><div style="font-size:10px;color:var(--text-muted)">Total Characters</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#f472b6">${versions}</div><div style="font-size:10px;color:var(--text-muted)">Saved Versions</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#38bdf8">${Math.ceil(totalWords/250)}</div><div style="font-size:10px;color:var(--text-muted)">Est. Pages</div></div>`;
  h+='</div>';
  if(longest.words>0){
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:6px;margin-bottom:12px;font-size:11px;color:var(--text-secondary)">Longest doc: <span style="color:var(--text-primary);font-weight:600">${esc(longest.title||'Untitled')}</span> (${longest.words.toLocaleString()} words)</div>`;
  }
  if(docs.length){
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Documents by word count:</div>';
    const sorted=[...docs].map(d=>({title:d.title||'Untitled',words:(d.content||'').trim().split(/\s+/).filter(Boolean).length})).sort((a,b)=>b.words-a.words).slice(0,10);
    const maxW=sorted[0]?.words||1;
    sorted.forEach(d=>{
      const pct=Math.round(d.words/maxW*100);
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px"><div style="width:100px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(d.title)}</div><div style="flex:1;height:10px;background:var(--bg-surface);border-radius:5px;overflow:hidden"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:5px"></div></div><div style="font-size:9px;color:var(--text-muted);width:40px">${d.words}</div></div>`;
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showLinkDomainBreakdown(){
  let panel=document.getElementById('link-domain-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='link-domain-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const links=(S.links||[]);
  const domainCount={};
  links.forEach(l=>{
    try{const u=new URL(l.url||'');domainCount[u.hostname]=(domainCount[u.hostname]||0)+1;}catch(e){}
  });
  const domains=Object.entries(domainCount).sort((a,b)=>b[1]-a[1]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Link Domain Breakdown</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!domains.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No links with valid URLs found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${links.length} links across ${domains.length} domains</div>`;
  const maxC=domains[0][1];
  const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#f87171','#a78bfa','#34d399','#f472b6','#38bdf8','#fbbf24'];
  domains.slice(0,20).forEach(([domain,count],i)=>{
    const pct=Math.round(count/maxC*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">`;
    h+=`<div style="width:130px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(domain)}</div>`;
    h+=`<div style="flex:1;height:14px;background:var(--bg-surface);border-radius:7px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[i%colors.length]};border-radius:7px"></div></div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted);width:30px">${count}</div>`;
    h+=`</div>`;
  });
  if(domains.length>20)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px">...and ${domains.length-20} more domains</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTimeTrackingReport(){
  let panel=document.getElementById('time-report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='time-report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const tracked=tasks.filter(t=>t.timeTracked&&t.timeTracked>0);
  const totalSec=tracked.reduce((s,t)=>s+t.timeTracked,0);
  const projectTime={};
  tracked.forEach(t=>{
    const proj=t.project||t.projectId||'No Project';
    projectTime[proj]=(projectTime[proj]||0)+t.timeTracked;
  });
  const projects=Object.entries(projectTime).sort((a,b)=>b[1]-a[1]);
  function fmtTime(sec){if(sec<60)return sec+'s';if(sec<3600)return Math.floor(sec/60)+'m '+sec%60+'s';return Math.floor(sec/3600)+'h '+Math.floor(sec%3600/60)+'m';}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Time Tracking Report</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#4ade80">${fmtTime(totalSec)}</div><div style="font-size:10px;color:var(--text-muted)">Total Tracked</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#60a5fa">${tracked.length}</div><div style="font-size:10px;color:var(--text-muted)">Tasks Tracked</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:700;color:#facc15">${tracked.length?fmtTime(Math.round(totalSec/tracked.length)):'0'}</div><div style="font-size:10px;color:var(--text-muted)">Avg per Task</div></div>`;
  h+='</div>';
  if(projects.length){
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Time by Project:</div>';
    const maxT=projects[0][1];
    const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#a78bfa'];
    projects.forEach(([proj,sec],i)=>{
      const pct=Math.round(sec/maxT*100);
      const projName=(S.projects||[]).find(p=>p.id===proj)?.name||proj;
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px"><div style="width:100px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(projName)}</div><div style="flex:1;height:14px;background:var(--bg-surface);border-radius:7px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[i%colors.length]};border-radius:7px"></div></div><div style="font-size:10px;color:var(--text-muted);width:50px">${fmtTime(sec)}</div></div>`;
    });
  }
  if(tracked.length){
    h+='<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px;font-size:11px;color:var(--text-muted);margin-bottom:6px">Top 10 by Time:</div>';
    const top10=[...tracked].sort((a,b)=>b.timeTracked-a.timeTracked).slice(0,10);
    top10.forEach(t=>{
      h+=`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:11px"><span style="color:var(--text-secondary)">${esc(t.title||'Untitled').substring(0,35)}</span><span style="color:#4ade80;font-weight:600">${fmtTime(t.timeTracked)}</span></div>`;
    });
  }
  if(!tracked.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No time tracking data. Use the timer on tasks to start tracking.</div>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentTimeline(){
  let panel=document.getElementById('content-tl-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-tl-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=[...(S.content||[])].filter(c=>c.createdAt).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Timeline</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!content.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No dated content found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  let lastDate='';
  content.slice(0,50).forEach(c=>{
    const d=new Date(c.createdAt);
    const dateStr=d.toLocaleDateString('en',{month:'short',day:'numeric',year:'numeric'});
    if(dateStr!==lastDate){
      h+=`<div style="font-size:10px;color:var(--accent);font-weight:600;margin:16px 0 8px;padding-left:20px;position:relative"><div style="position:absolute;left:6px;top:4px;width:6px;height:6px;border-radius:50%;background:var(--accent)"></div>${dateStr}</div>`;
      lastDate=dateStr;
    }
    const time=d.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit'});
    const words=(c.body||'').trim().split(/\s+/).filter(Boolean).length;
    const theme=c.theme||c.category||'';
    h+=`<div style="margin-left:8px;padding:8px 8px 8px 20px;border-left:2px solid var(--border);position:relative">`;
    h+=`<div style="position:absolute;left:-5px;top:12px;width:8px;height:8px;border-radius:50%;background:var(--bg-elevated);border:2px solid var(--border)"></div>`;
    h+=`<div style="font-size:12px;color:var(--text-primary);font-weight:500">${esc(c.title||'Untitled')}</div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:2px">${time}`;
    if(words>0)h+=` | ${words} words`;
    if(theme)h+=` | ${esc(theme)}`;
    h+=`</div>`;
    if(c.body){
      const preview=c.body.substring(0,100).replace(/\n/g,' ');
      h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:4px;line-height:1.4;opacity:0.7">${esc(preview)}${c.body.length>100?'...':''}</div>`;
    }
    h+=`</div>`;
  });
  if(content.length>50)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:12px">Showing 50 of ${content.length} items</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showGoalTracker(){
  let panel=document.getElementById('goal-tracker-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='goal-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._goals)S._goals=[];
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Goal Tracker</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="display:flex;gap:8px;margin-bottom:16px">';
    h+='<input id="goal-title-input" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px" placeholder="Goal title...">';
    h+='<select id="goal-type-select" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:11px"><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select>';
    h+='<input id="goal-target-input" type="number" min="1" value="5" style="width:60px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px">';
    h+=`<button onclick="(function(){const t=document.getElementById('goal-title-input').value.trim();if(!t)return;const type=document.getElementById('goal-type-select').value;const target=parseInt(document.getElementById('goal-target-input').value)||5;S._goals.push({id:'g_'+Date.now(),title:t,type:type,target:target,current:0,createdAt:new Date().toISOString()});save();showGoalTracker();})()" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px 12px;font-size:11px;font-weight:600;cursor:pointer">Add</button>`;
    h+='</div>';
    if(!S._goals.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No goals set. Add a goal above.</div>';}
    S._goals.forEach(g=>{
      const pct=g.target?Math.min(100,Math.round(g.current/g.target*100)):0;
      const color=pct>=100?'#4ade80':pct>=60?'#facc15':'#60a5fa';
      h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:8px">`;
      h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
      h+=`<div><span style="font-size:12px;color:var(--text-primary);font-weight:500">${esc(g.title)}</span><span style="font-size:9px;color:var(--text-muted);margin-left:8px">${g.type}</span></div>`;
      h+=`<div style="display:flex;gap:4px">`;
      h+=`<button onclick="(function(){const g=S._goals.find(x=>x.id==='${g.id}');if(g&&g.current<g.target){g.current++;save();showGoalTracker();}})()" style="background:var(--accent);color:#000;border:none;border-radius:4px;padding:2px 8px;font-size:10px;cursor:pointer;font-weight:600">+1</button>`;
      h+=`<button onclick="(function(){S._goals=S._goals.filter(x=>x.id!=='${g.id}');save();showGoalTracker();})()" style="background:none;border:1px solid var(--border);color:var(--text-muted);border-radius:4px;padding:2px 6px;font-size:10px;cursor:pointer">X</button>`;
      h+=`</div></div>`;
      h+=`<div style="height:10px;background:var(--bg-elevated);border-radius:5px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${color};border-radius:5px;transition:width 0.3s"></div></div>`;
      h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:4px">${g.current} / ${g.target} (${pct}%)${pct>=100?' - COMPLETED':''}</div>`;
      h+=`</div>`;
    });
    panel.innerHTML=h;
  }
  render();
  document.body.appendChild(panel);
}
function showQuickTask(){
  let panel=document.getElementById('quick-task-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-task-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-weight:700;font-size:13px;color:var(--text-primary)">Quick Task</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<input id="quick-task-title" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;margin-bottom:8px" placeholder="Task title...">';
  h+='<div style="display:flex;gap:8px;margin-bottom:8px">';
  h+='<select id="quick-task-priority" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px"><option value="p2">P2 Normal</option><option value="p0">P0 Critical</option><option value="p1">P1 High</option><option value="p3">P3 Low</option></select>';
  h+='<input id="quick-task-due" type="date" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px">';
  h+='</div>';
  h+=`<button onclick="(function(){const title=document.getElementById('quick-task-title').value.trim();if(!title)return;if(!S.tasks)S.tasks=[];const priority=document.getElementById('quick-task-priority').value;const due=document.getElementById('quick-task-due').value;S.tasks.push({id:'t_'+Date.now(),title:title,description:'',status:'todo',priority:priority,due:due||'',project:'',projectId:'',subtasks:[],tags:[],createdAt:new Date().toISOString(),timeTracked:0});save();document.getElementById('quick-task-panel').remove();if(typeof renderTasks==='function')renderTasks();})()" style="width:100%;background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px;font-size:12px;font-weight:600;cursor:pointer">Create Task</button>`;
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const inp=document.getElementById('quick-task-title');if(inp)inp.focus();},100);
}
function showDataExplorer(){
  let panel=document.getElementById('data-explorer-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='data-explorer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const keys=['tasks','content','links','projects','writerDocs','specs','repos','_goals','_habits','_moods','_microJournal','_gratitude','_savedSearches','_bookmarks','_changelog'];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Data Explorer</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Browse workspace state data. Click a section to expand.</div>';
  keys.forEach(key=>{
    const val=S[key];
    if(!val)return;
    const isArr=Array.isArray(val);
    const count=isArr?val.length:Object.keys(val).length;
    const sizeStr=JSON.stringify(val).length;
    const sizeKB=(sizeStr/1024).toFixed(1);
    h+=`<div style="margin-bottom:4px">`;
    h+=`<div onclick="const el=document.getElementById('de-${key}');el.style.display=el.style.display==='none'?'block':'none'" style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer">`;
    h+=`<span style="font-size:12px;color:var(--text-primary);font-weight:500">${key}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${count} items | ${sizeKB} KB</span>`;
    h+=`</div>`;
    h+=`<div id="de-${key}" style="display:none;padding:8px;margin-left:12px;border-left:2px solid var(--border)">`;
    if(isArr){
      val.slice(0,5).forEach((item,i)=>{
        const preview=JSON.stringify(item).substring(0,200);
        h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;font-family:monospace;word-break:break-all">[${i}] ${esc(preview)}${preview.length>=200?'...':''}</div>`;
      });
      if(val.length>5)h+=`<div style="font-size:10px;color:var(--text-muted);font-style:italic">...and ${val.length-5} more items</div>`;
    } else {
      const preview=JSON.stringify(val).substring(0,400);
      h+=`<div style="font-size:10px;color:var(--text-muted);font-family:monospace;word-break:break-all">${esc(preview)}${preview.length>=400?'...':''}</div>`;
    }
    h+=`</div></div>`;
  });
  const totalSize=(JSON.stringify(S).length/1024).toFixed(1);
  h+=`<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);text-align:center;font-size:10px;color:var(--text-muted)">Total state: ${totalSize} KB</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectComparison(){
  let panel=document.getElementById('proj-compare-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:750px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=(S.projects||[]);
  const tasks=(S.tasks||[]);
  const content=(S.content||[]);
  const specs=(S.specs||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Project Comparison</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(projects.length<2){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">Need at least 2 projects to compare</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">';
  h+='<tr><th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);color:var(--text-muted)">Metric</th>';
  projects.forEach(p=>{h+=`<th style="text-align:center;padding:8px;border-bottom:1px solid var(--border);color:var(--accent)">${esc((p.name||'Untitled').substring(0,15))}</th>`;});
  h+='</tr>';
  const metrics=[
    {name:'Total Tasks',fn:p=>tasks.filter(t=>t.projectId===p.id||t.project===p.name).length},
    {name:'Done',fn:p=>tasks.filter(t=>(t.projectId===p.id||t.project===p.name)&&t.status==='done').length},
    {name:'In Progress',fn:p=>tasks.filter(t=>(t.projectId===p.id||t.project===p.name)&&t.status==='in-progress').length},
    {name:'Overdue',fn:p=>tasks.filter(t=>(t.projectId===p.id||t.project===p.name)&&t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length},
    {name:'Content Items',fn:p=>content.filter(c=>c.project===p.name||c.projectId===p.id).length},
    {name:'Specs',fn:p=>specs.filter(s=>s.projectId===p.id).length},
    {name:'Completion %',fn:p=>{const pt=tasks.filter(t=>t.projectId===p.id||t.project===p.name);const d=pt.filter(t=>t.status==='done').length;return pt.length?(Math.round(d/pt.length*100)+'%'):'N/A';}},
  ];
  metrics.forEach(m=>{
    h+=`<tr><td style="padding:6px 8px;border-bottom:1px solid var(--border);color:var(--text-secondary)">${m.name}</td>`;
    const vals=projects.map(p=>m.fn(p));
    const max=Math.max(...vals.map(v=>typeof v==='number'?v:0));
    projects.forEach((p,i)=>{
      const v=vals[i];
      const isMax=typeof v==='number'&&v===max&&max>0;
      h+=`<td style="text-align:center;padding:6px 8px;border-bottom:1px solid var(--border);color:${isMax?'#4ade80':'var(--text-primary)'};font-weight:${isMax?'700':'400'}">${v}</td>`;
    });
    h+='</tr>';
  });
  h+='</table></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWeeklyReview(){
  let panel=document.getElementById('weekly-review-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='weekly-review-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  const weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
  const tasks=(S.tasks||[]);const content=(S.content||[]);const links=(S.links||[]);const docs=(S.writerDocs||[]);
  const doneThisWeek=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=weekAgo);
  const createdThisWeek=tasks.filter(t=>t.createdAt&&new Date(t.createdAt)>=weekAgo);
  const contentThisWeek=content.filter(c=>c.createdAt&&new Date(c.createdAt)>=weekAgo);
  const linksThisWeek=links.filter(l=>l.createdAt&&new Date(l.createdAt)>=weekAgo);
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now);
  const docsEdited=docs.filter(d=>d.updatedAt&&new Date(d.updatedAt)>=weekAgo);
  let review=`WEEKLY REVIEW - ${weekAgo.toLocaleDateString()} to ${now.toLocaleDateString()}\n`;
  review+=`${'='.repeat(50)}\n\n`;
  review+=`TASKS\n`;
  review+=`- Completed: ${doneThisWeek.length}\n`;
  review+=`- Created: ${createdThisWeek.length}\n`;
  review+=`- Overdue: ${overdue.length}\n`;
  if(doneThisWeek.length){review+=`\nCompleted tasks:\n`;doneThisWeek.forEach(t=>{review+=`  [x] ${t.title}\n`;});}
  review+=`\nCONTENT\n`;
  review+=`- Items created: ${contentThisWeek.length}\n`;
  review+=`- Links saved: ${linksThisWeek.length}\n`;
  review+=`- Docs edited: ${docsEdited.length}\n`;
  const wordsWritten=contentThisWeek.reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0);
  review+=`- Words written: ${wordsWritten}\n`;
  review+=`\nNEXT WEEK\n`;
  const upcoming=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)>=now&&new Date(t.due)<=new Date(now.getTime()+7*86400000));
  review+=`- Due next week: ${upcoming.length}\n`;
  if(upcoming.length){upcoming.forEach(t=>{review+=`  [ ] ${t.title} (due ${t.due})\n`;});}
  if(overdue.length){review+=`\nOVERDUE (needs attention):\n`;overdue.slice(0,10).forEach(t=>{review+=`  [!] ${t.title} (due ${t.due})\n`;});}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Weekly Review</div><div style="display:flex;gap:8px"><button onclick="navigator.clipboard.writeText(document.getElementById(\'weekly-review-text\').textContent)" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 12px;font-size:11px;font-weight:600;cursor:pointer">Copy</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div></div>';
  h+=`<pre id="weekly-review-text" style="font-size:11px;color:var(--text-secondary);white-space:pre-wrap;line-height:1.6;background:var(--bg-surface);padding:16px;border-radius:8px;max-height:60vh;overflow-y:auto">${esc(review)}</pre>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showAchievements(){
  let panel=document.getElementById('achievements-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='achievements-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const content=(S.content||[]);const links=(S.links||[]);const docs=(S.writerDocs||[]);
  const doneTasks=tasks.filter(t=>t.status==='done').length;
  const totalWords=content.reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0)+docs.reduce((s,d)=>s+(d.content||'').trim().split(/\s+/).filter(Boolean).length,0);
  const achievements=[
    {id:'first_task',title:'First Steps',desc:'Complete your first task',check:doneTasks>=1,icon:'*'},
    {id:'task_10',title:'Getting Organized',desc:'Complete 10 tasks',check:doneTasks>=10,icon:'*'},
    {id:'task_50',title:'Task Machine',desc:'Complete 50 tasks',check:doneTasks>=50,icon:'*'},
    {id:'task_100',title:'Centurion',desc:'Complete 100 tasks',check:doneTasks>=100,icon:'*'},
    {id:'content_5',title:'Content Creator',desc:'Create 5 content items',check:content.length>=5,icon:'+'},
    {id:'content_25',title:'Prolific Writer',desc:'Create 25 content items',check:content.length>=25,icon:'+'},
    {id:'words_1k',title:'Wordsmith',desc:'Write 1,000 words total',check:totalWords>=1000,icon:'W'},
    {id:'words_10k',title:'Author',desc:'Write 10,000 words total',check:totalWords>=10000,icon:'W'},
    {id:'words_50k',title:'NaNoWriMo',desc:'Write 50,000 words total',check:totalWords>=50000,icon:'W'},
    {id:'links_10',title:'Researcher',desc:'Save 10 links',check:links.length>=10,icon:'L'},
    {id:'links_50',title:'Link Hoarder',desc:'Save 50 links',check:links.length>=50,icon:'L'},
    {id:'docs_3',title:'Documenter',desc:'Create 3 writer docs',check:docs.length>=3,icon:'D'},
    {id:'docs_10',title:'Novelist',desc:'Create 10 writer docs',check:docs.length>=10,icon:'D'},
    {id:'projects_3',title:'Multi-Tasker',desc:'Have 3 projects',check:(S.projects||[]).length>=3,icon:'P'},
    {id:'streak_7',title:'Week Warrior',desc:'7-day usage streak',check:(S._streak||0)>=7,icon:'F'},
    {id:'streak_30',title:'Monthly Champion',desc:'30-day usage streak',check:(S._streak||0)>=30,icon:'F'},
  ];
  const unlocked=achievements.filter(a=>a.check).length;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Achievements</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="text-align:center;margin-bottom:16px"><span style="font-size:28px;font-weight:700;color:#4ade80">${unlocked}</span><span style="font-size:14px;color:var(--text-muted)"> / ${achievements.length} unlocked</span></div>`;
  h+=`<div style="height:8px;background:var(--bg-surface);border-radius:4px;margin-bottom:16px;overflow:hidden"><div style="height:100%;width:${Math.round(unlocked/achievements.length*100)}%;background:#4ade80;border-radius:4px"></div></div>`;
  achievements.forEach(a=>{
    h+=`<div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg-surface);border-radius:8px;margin-bottom:6px;opacity:${a.check?'1':'0.4'}">`;
    h+=`<div style="width:36px;height:36px;border-radius:50%;background:${a.check?'#4ade80':'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:${a.check?'#000':'var(--text-muted)'}">${a.check?a.icon:'?'}</div>`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary);font-weight:600">${a.title}</div><div style="font-size:10px;color:var(--text-muted)">${a.desc}</div></div>`;
    if(a.check)h+=`<div style="font-size:10px;color:#4ade80;font-weight:600">UNLOCKED</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showFocusHistory(){
  let panel=document.getElementById('focus-hist-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='focus-hist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const sessions=(S._focusSessions||[]);
  const totalMin=sessions.reduce((s,f)=>s+(f.duration||0),0);
  const totalSessions=sessions.length;
  const avgMin=totalSessions?Math.round(totalMin/totalSessions):0;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Focus Session History</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${totalSessions}</div><div style="font-size:10px;color:var(--text-muted)">Total Sessions</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#60a5fa">${totalMin}m</div><div style="font-size:10px;color:var(--text-muted)">Total Focus Time</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:#facc15">${avgMin}m</div><div style="font-size:10px;color:var(--text-muted)">Avg Session</div></div>`;
  h+='</div>';
  if(!sessions.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No focus sessions recorded yet. Start a Pomodoro timer to begin tracking.</div>';
  } else {
    const last14=[];
    const now=new Date();
    for(let i=13;i>=0;i--){
      const d=new Date(now);d.setDate(d.getDate()-i);
      const dateStr=d.toISOString().split('T')[0];
      const dayMins=sessions.filter(s=>s.date&&s.date.startsWith(dateStr)).reduce((sum,s)=>sum+(s.duration||0),0);
      last14.push({label:d.toLocaleDateString('en',{month:'short',day:'numeric'}),mins:dayMins});
    }
    const maxMins=Math.max(...last14.map(d=>d.mins),1);
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Last 14 days:</div>';
    h+='<div style="display:flex;align-items:flex-end;gap:4px;height:100px;margin-bottom:8px">';
    last14.forEach(d=>{
      const h2=d.mins?Math.max(4,d.mins/maxMins*90):2;
      const color=d.mins>0?'#4ade80':'var(--border)';
      h+=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px"><div style="font-size:8px;color:var(--text-muted)">${d.mins||''}</div><div style="width:100%;height:${h2}px;background:${color};border-radius:3px"></div><div style="font-size:7px;color:var(--text-muted)">${d.label.split(' ')[1]}</div></div>`;
    });
    h+='</div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-top:12px;margin-bottom:6px">Recent sessions:</div>';
    sessions.slice(-10).reverse().forEach(s=>{
      const d=s.date?new Date(s.date).toLocaleDateString('en',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'Unknown';
      h+=`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:11px;border-bottom:1px solid var(--border)"><span style="color:var(--text-secondary)">${d}</span><span style="color:#4ade80;font-weight:600">${s.duration||0}m</span></div>`;
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickLink(){
  let panel=document.getElementById('quick-link-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-link-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-weight:700;font-size:13px;color:var(--text-primary)">Quick Link</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<input id="quick-link-url" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;margin-bottom:8px" placeholder="URL...">';
  h+='<input id="quick-link-title" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px;margin-bottom:8px" placeholder="Title (optional)">';
  h+='<div style="display:flex;gap:8px">';
  h+='<select id="quick-link-cat" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px"><option value="">Category</option><option value="reference">Reference</option><option value="tool">Tool</option><option value="inspiration">Inspiration</option><option value="learning">Learning</option><option value="resource">Resource</option></select>';
  h+=`<button onclick="(function(){const url=document.getElementById('quick-link-url').value.trim();if(!url)return;if(!S.links)S.links=[];const title=document.getElementById('quick-link-title').value.trim()||url;const cat=document.getElementById('quick-link-cat').value;S.links.unshift({id:'l_'+Date.now(),url:url,title:title,category:cat,tags:[],createdAt:new Date().toISOString(),pinned:false});save();document.getElementById('quick-link-panel').remove();if(typeof renderLinks==='function')renderLinks();})()" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer">Save</button>`;
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const inp=document.getElementById('quick-link-url');if(inp)inp.focus();},100);
}
function showStorageManager(){
  let panel=document.getElementById('storage-mgr-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='storage-mgr-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const sections=[
    {key:'tasks',label:'Tasks'},
    {key:'content',label:'Content'},
    {key:'links',label:'Links'},
    {key:'projects',label:'Projects'},
    {key:'writerDocs',label:'Writer Docs'},
    {key:'specs',label:'Living Docs'},
    {key:'repos',label:'Repos'},
    {key:'_goals',label:'Goals'},
    {key:'_habits',label:'Habits'},
    {key:'_moods',label:'Moods'},
    {key:'_microJournal',label:'Micro Journal'},
    {key:'_gratitude',label:'Gratitude'},
    {key:'_focusSessions',label:'Focus Sessions'},
    {key:'_savedSearches',label:'Saved Searches'},
    {key:'_changelog',label:'Changelog'},
    {key:'_dailyStats',label:'Daily Stats'},
  ];
  const sizes=sections.map(s=>{
    const val=S[s.key];
    const size=val?JSON.stringify(val).length:0;
    return {...s,size,count:Array.isArray(val)?val.length:0};
  }).sort((a,b)=>b.size-a.size);
  const totalSize=JSON.stringify(S).length;
  const totalKB=(totalSize/1024).toFixed(1);
  const maxLS=5*1024*1024;
  const usagePct=Math.round(totalSize/maxLS*100);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Storage Manager</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const barColor=usagePct>80?'#f87171':usagePct>50?'#facc15':'#4ade80';
  h+=`<div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-bottom:4px"><span>${totalKB} KB used</span><span>${(maxLS/1024).toFixed(0)} KB limit (5MB)</span></div>`;
  h+=`<div style="height:16px;background:var(--bg-surface);border-radius:8px;overflow:hidden"><div style="height:100%;width:${usagePct}%;background:${barColor};border-radius:8px;transition:width 0.3s"></div></div>`;
  h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:4px">${usagePct}% used</div></div>`;
  const maxSize=sizes[0]?.size||1;
  sizes.forEach(s=>{
    if(s.size===0)return;
    const pct=Math.round(s.size/maxSize*100);
    const sizeKB=(s.size/1024).toFixed(1);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px">`;
    h+=`<div style="width:90px;font-size:10px;color:var(--text-secondary);text-align:right">${s.label}</div>`;
    h+=`<div style="flex:1;height:12px;background:var(--bg-surface);border-radius:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${barColor};border-radius:6px"></div></div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);width:70px">${sizeKB}KB (${s.count})</div>`;
    h+=`</div>`;
  });
  h+=`<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted)">Tip: Archive old tasks and content to free up space. Use cloud sync to backup before cleanup.</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskAging(){
  let panel=document.getElementById('task-aging-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-aging-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&t.createdAt);
  const now=new Date();
  const aged=tasks.map(t=>{
    const created=new Date(t.createdAt);
    const days=Math.floor((now-created)/(1000*60*60*24));
    return {...t,ageDays:days};
  }).sort((a,b)=>b.ageDays-a.ageDays);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Task Aging Report</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const brackets=[
    {label:'Fresh (0-3 days)',min:0,max:3,color:'#4ade80'},
    {label:'Normal (4-7 days)',min:4,max:7,color:'#60a5fa'},
    {label:'Aging (8-14 days)',min:8,max:14,color:'#facc15'},
    {label:'Stale (15-30 days)',min:15,max:30,color:'#fb923c'},
    {label:'Ancient (30+ days)',min:31,max:9999,color:'#f87171'},
  ];
  h+='<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">';
  brackets.forEach(b=>{
    const count=aged.filter(t=>t.ageDays>=b.min&&t.ageDays<=b.max).length;
    h+=`<div style="background:var(--bg-surface);padding:8px 12px;border-radius:6px;text-align:center;border-left:3px solid ${b.color}"><div style="font-size:16px;font-weight:700;color:${b.color}">${count}</div><div style="font-size:9px;color:var(--text-muted)">${b.label}</div></div>`;
  });
  h+='</div>';
  if(!aged.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No open tasks found</div>';}
  aged.slice(0,20).forEach(t=>{
    const color=t.ageDays>30?'#f87171':t.ageDays>14?'#fb923c':t.ageDays>7?'#facc15':t.ageDays>3?'#60a5fa':'#4ade80';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">`;
    h+=`<div style="min-width:45px;font-size:11px;font-weight:700;color:${color}">${t.ageDays}d</div>`;
    h+=`<div style="flex:1;font-size:11px;color:var(--text-secondary)">${esc(t.title||'Untitled').substring(0,40)}</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted)">${t.status}</div>`;
    h+=`</div>`;
  });
  if(aged.length>20)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px">Showing 20 of ${aged.length} open tasks</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentWordFrequency(){
  let panel=document.getElementById('word-freq-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='word-freq-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const stopWords=new Set(['the','be','to','of','and','a','in','that','have','i','it','for','not','on','with','he','as','you','do','at','this','but','his','by','from','they','we','her','she','or','an','will','my','one','all','would','there','their','what','so','up','out','if','about','who','get','which','go','me','when','make','can','like','time','no','just','him','know','take','people','into','year','your','good','some','could','them','see','other','than','then','now','look','only','come','its','over','think','also','back','after','use','two','how','our','work','first','well','way','even','new','want','because','any','these','give','day','most','us']);
  const wordCount={};
  content.forEach(c=>{
    const text=((c.body||'')+' '+(c.title||'')).toLowerCase().replace(/[^a-z\s]/g,'');
    text.split(/\s+/).forEach(w=>{
      if(w.length>2&&!stopWords.has(w))wordCount[w]=(wordCount[w]||0)+1;
    });
  });
  const words=Object.entries(wordCount).sort((a,b)=>b[1]-a[1]).slice(0,30);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Word Frequency (Top 30)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!words.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No content with enough text to analyze</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const maxC=words[0][1];
  const colors=['#4ade80','#60a5fa','#facc15','#fb923c','#a78bfa','#34d399'];
  words.forEach(([word,count],i)=>{
    const pct=Math.round(count/maxC*100);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px">`;
    h+=`<div style="width:80px;font-size:11px;color:var(--text-secondary);text-align:right;font-family:monospace">${word}</div>`;
    h+=`<div style="flex:1;height:12px;background:var(--bg-surface);border-radius:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[i%colors.length]};border-radius:6px"></div></div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);width:30px">${count}</div>`;
    h+=`</div>`;
  });
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">${Object.keys(wordCount).length} unique words across ${content.length} items (common words excluded)</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDailyPlanner(){
  let panel=document.getElementById('daily-planner-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='daily-planner-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  const todayStr=now.toISOString().split('T')[0];
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const todayTasks=tasks.filter(t=>t.due&&t.due.startsWith(todayStr));
  const overdue=tasks.filter(t=>t.due&&t.due<todayStr);
  const noDue=tasks.filter(t=>!t.due).slice(0,5);
  const dateDisplay=now.toLocaleDateString('en',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Daily Planner</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:12px;color:var(--accent);margin-bottom:16px">${dateDisplay}</div>`;
  const blocks=[
    {name:'Morning (6am-12pm)',icon:'M',tasks:todayTasks.filter((_,i)=>i<Math.ceil(todayTasks.length/3)),color:'#facc15'},
    {name:'Afternoon (12pm-6pm)',icon:'A',tasks:todayTasks.filter((_,i)=>i>=Math.ceil(todayTasks.length/3)&&i<Math.ceil(todayTasks.length*2/3)),color:'#fb923c'},
    {name:'Evening (6pm-12am)',icon:'E',tasks:todayTasks.filter((_,i)=>i>=Math.ceil(todayTasks.length*2/3)),color:'#a78bfa'},
  ];
  blocks.forEach(b=>{
    h+=`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:${b.color};margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)">${b.name}</div>`;
    if(b.tasks.length===0)h+=`<div style="font-size:10px;color:var(--text-muted);padding:8px;font-style:italic">No tasks scheduled</div>`;
    b.tasks.forEach(t=>{
      const pColor=t.priority==='p0'?'#f87171':t.priority==='p1'?'#fb923c':t.priority==='p2'?'#60a5fa':'#6b7280';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px"><span style="color:${pColor};font-size:8px">●</span><span style="font-size:11px;color:var(--text-primary)">${esc(t.title||'').substring(0,40)}</span><span style="font-size:9px;color:var(--text-muted);margin-left:auto">${t.priority||''}</span></div>`;
    });
    h+=`</div>`;
  });
  if(overdue.length){
    h+=`<div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border)"><div style="font-size:11px;font-weight:600;color:#f87171;margin-bottom:6px">Overdue (${overdue.length})</div>`;
    overdue.slice(0,5).forEach(t=>{
      h+=`<div style="font-size:11px;color:var(--text-secondary);padding:4px 0">[!] ${esc(t.title||'').substring(0,35)} (due ${t.due})</div>`;
    });
    if(overdue.length>5)h+=`<div style="font-size:10px;color:var(--text-muted)">...and ${overdue.length-5} more</div>`;
    h+=`</div>`;
  }
  if(noDue.length){
    h+=`<div style="margin-top:8px;padding-top:12px;border-top:1px solid var(--border)"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px">Unscheduled (top 5)</div>`;
    noDue.forEach(t=>{h+=`<div style="font-size:11px;color:var(--text-muted);padding:4px 0">[ ] ${esc(t.title||'').substring(0,40)}</div>`;});
    h+=`</div>`;
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentLengthChart(){
  let panel=document.getElementById('content-length-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-length-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const buckets=[
    {label:'Tiny (<50 words)',min:0,max:49,color:'#60a5fa',items:[]},
    {label:'Short (50-200)',min:50,max:200,color:'#4ade80',items:[]},
    {label:'Medium (200-500)',min:200,max:500,color:'#facc15',items:[]},
    {label:'Long (500-1000)',min:500,max:1000,color:'#fb923c',items:[]},
    {label:'Epic (1000+)',min:1000,max:999999,color:'#f87171',items:[]},
  ];
  content.forEach(c=>{
    const words=(c.body||'').trim().split(/\s+/).filter(Boolean).length;
    const bucket=buckets.find(b=>words>=b.min&&words<=b.max);
    if(bucket)bucket.items.push(c);
  });
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Length Distribution</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!content.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No content found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const maxCount=Math.max(...buckets.map(b=>b.items.length),1);
  buckets.forEach(b=>{
    const pct=Math.round(b.items.length/maxCount*100);
    h+=`<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px"><span style="color:var(--text-secondary)">${b.label}</span><span style="color:${b.color};font-weight:600">${b.items.length}</span></div>`;
    h+=`<div style="height:20px;background:var(--bg-surface);border-radius:10px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${b.color};border-radius:10px;opacity:0.8"></div></div></div>`;
  });
  const totalWords=content.reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0);
  const avgWords=content.length?Math.round(totalWords/content.length):0;
  h+=`<div style="margin-top:16px;display:flex;gap:16px;justify-content:center;font-size:10px;color:var(--text-muted)"><span>Total: ${content.length} items</span><span>Avg: ${avgWords} words</span><span>Total: ${totalWords.toLocaleString()} words</span></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectNotes(){
  let panel=document.getElementById('proj-notes-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-notes-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._projectNotes)S._projectNotes={};
  const projects=(S.projects||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Project Notes</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!projects.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No projects found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  projects.forEach(p=>{
    const noteKey=p.id;
    const note=S._projectNotes[noteKey]||'';
    h+=`<div style="margin-bottom:12px"><div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:4px">${esc(p.name||'Untitled')}</div>`;
    h+=`<textarea data-proj-note="${noteKey}" style="width:100%;height:60px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:11px;resize:vertical;font-family:inherit" placeholder="Notes for ${esc(p.name||'')}...">${esc(note)}</textarea></div>`;
  });
  h+=`<button onclick="(function(){document.querySelectorAll('[data-proj-note]').forEach(ta=>{const key=ta.getAttribute('data-proj-note');S._projectNotes[key]=ta.value;});save();document.getElementById('proj-notes-panel').querySelector('button:last-child').textContent='Saved!';setTimeout(()=>{const btn=document.getElementById('proj-notes-panel');if(btn)btn.querySelector('button:last-child').textContent='Save All Notes';},1500);})()" style="width:100%;background:var(--accent);color:#000;border:none;border-radius:6px;padding:10px;font-size:12px;font-weight:600;cursor:pointer">Save All Notes</button>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDuplicateDetector(){
  let panel=document.getElementById('dupe-detect-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='dupe-detect-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  function similar(a,b){const al=a.toLowerCase();const bl=b.toLowerCase();if(al===bl)return 1;const longer=al.length>bl.length?al:bl;const shorter=al.length>bl.length?bl:al;if(longer.length===0)return 1;let matches=0;for(let i=0;i<shorter.length;i++){if(longer.includes(shorter[i]))matches++;}return matches/longer.length;}
  const content=(S.content||[]);
  const tasks=(S.tasks||[]);
  const dupes=[];
  for(let i=0;i<content.length;i++){
    for(let j=i+1;j<content.length;j++){
      const score=similar(content[i].title||'',content[j].title||'');
      if(score>0.8&&(content[i].title||'').length>3){
        dupes.push({type:'content',a:content[i],b:content[j],score});
      }
    }
  }
  for(let i=0;i<tasks.length;i++){
    for(let j=i+1;j<tasks.length;j++){
      const score=similar(tasks[i].title||'',tasks[j].title||'');
      if(score>0.8&&(tasks[i].title||'').length>3){
        dupes.push({type:'task',a:tasks[i],b:tasks[j],score});
      }
    }
  }
  dupes.sort((a,b)=>b.score-a.score);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Duplicate Detector</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Scanned ${content.length} content items and ${tasks.length} tasks. Found ${dupes.length} potential duplicates.</div>`;
  if(!dupes.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No duplicates found. Your data is clean!</div>';}
  dupes.slice(0,20).forEach(d=>{
    const pct=Math.round(d.score*100);
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;margin-bottom:8px;border-left:3px solid ${pct>95?'#f87171':'#facc15'}">`;
    h+=`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">${d.type.toUpperCase()} | ${pct}% similar</div>`;
    h+=`<div style="font-size:11px;color:var(--text-primary);margin-bottom:2px">A: ${esc((d.a.title||'').substring(0,50))}</div>`;
    h+=`<div style="font-size:11px;color:var(--text-secondary)">B: ${esc((d.b.title||'').substring(0,50))}</div>`;
    h+=`</div>`;
  });
  if(dupes.length>20)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px">Showing 20 of ${dupes.length} potential duplicates</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickSearchPanel(){
  let panel=document.getElementById('quick-search-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Universal Search</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<input id="univ-search-input" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:13px;margin-bottom:12px" placeholder="Search everything..." oninput="universalSearch(this.value)">';
  h+='<div id="univ-search-results" style="max-height:50vh;overflow-y:auto"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const inp=document.getElementById('univ-search-input');if(inp)inp.focus();},100);
}
function universalSearch(q){
  const results=document.getElementById('univ-search-results');if(!results)return;
  if(!q||q.length<2){results.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">Type at least 2 characters to search</div>';return;}
  const ql=q.toLowerCase();
  const items=[];
  (S.tasks||[]).forEach(t=>{if((t.title||'').toLowerCase().includes(ql)||(t.description||'').toLowerCase().includes(ql))items.push({type:'Task',title:t.title,sub:t.status+' | '+(t.priority||''),color:'#60a5fa'});});
  (S.content||[]).forEach(c=>{if((c.title||'').toLowerCase().includes(ql)||(c.body||'').toLowerCase().includes(ql))items.push({type:'Content',title:c.title,sub:(c.theme||'')+(c.body?(' | '+c.body.substring(0,60)):''),color:'#a78bfa'});});
  (S.links||[]).forEach(l=>{if((l.title||'').toLowerCase().includes(ql)||(l.url||'').toLowerCase().includes(ql))items.push({type:'Link',title:l.title||l.url,sub:l.category||l.url||'',color:'#38bdf8'});});
  (S.writerDocs||[]).forEach(d=>{if((d.title||'').toLowerCase().includes(ql)||(d.content||'').toLowerCase().includes(ql))items.push({type:'Doc',title:d.title,sub:(d.content||'').substring(0,60),color:'#fbbf24'});});
  (S.projects||[]).forEach(p=>{if((p.name||'').toLowerCase().includes(ql)||(p.description||'').toLowerCase().includes(ql))items.push({type:'Project',title:p.name,sub:p.description||'',color:'#4ade80'});});
  let h='';
  if(!items.length)h='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">No results found</div>';
  items.slice(0,30).forEach(item=>{
    h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid var(--border)">`;
    h+=`<div style="background:${item.color};color:#000;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;min-width:50px;text-align:center">${item.type}</div>`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary)">${esc((item.title||'').substring(0,50))}</div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted)">${esc((item.sub||'').substring(0,60))}</div></div>`;
    h+=`</div>`;
  });
  if(items.length>30)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:8px">${items.length} results (showing 30)</div>`;
  results.innerHTML=h;
}
function showEisenhowerMatrix(){
  let panel=document.getElementById('eisenhower-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='eisenhower-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();
  const weekFromNow=new Date(now.getTime()+7*86400000);
  const urgent=t=>t.due&&new Date(t.due)<=weekFromNow;
  const important=t=>t.priority==='p0'||t.priority==='p1';
  const q1=tasks.filter(t=>urgent(t)&&important(t));
  const q2=tasks.filter(t=>!urgent(t)&&important(t));
  const q3=tasks.filter(t=>urgent(t)&&!important(t));
  const q4=tasks.filter(t=>!urgent(t)&&!important(t));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Eisenhower Matrix</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-bottom:8px">Urgent = due within 7 days | Important = P0 or P1</div>';
  const quads=[
    {title:'DO FIRST',sub:'Urgent + Important',tasks:q1,color:'#f87171',bg:'rgba(248,113,113,0.1)'},
    {title:'SCHEDULE',sub:'Not Urgent + Important',tasks:q2,color:'#60a5fa',bg:'rgba(96,165,250,0.1)'},
    {title:'DELEGATE',sub:'Urgent + Not Important',tasks:q3,color:'#facc15',bg:'rgba(250,204,21,0.1)'},
    {title:'ELIMINATE',sub:'Not Urgent + Not Important',tasks:q4,color:'#6b7280',bg:'rgba(107,114,128,0.1)'},
  ];
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  quads.forEach(q=>{
    h+=`<div style="background:${q.bg};border:1px solid ${q.color}30;border-radius:8px;padding:12px;min-height:120px">`;
    h+=`<div style="font-size:11px;font-weight:700;color:${q.color};margin-bottom:2px">${q.title} (${q.tasks.length})</div>`;
    h+=`<div style="font-size:9px;color:var(--text-muted);margin-bottom:8px">${q.sub}</div>`;
    q.tasks.slice(0,6).forEach(t=>{
      h+=`<div style="font-size:10px;color:var(--text-secondary);padding:3px 0;border-bottom:1px solid ${q.color}15">${esc(t.title||'').substring(0,30)}${t.due?' ('+t.due+')':''}</div>`;
    });
    if(q.tasks.length>6)h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:4px">+${q.tasks.length-6} more</div>`;
    if(!q.tasks.length)h+=`<div style="font-size:10px;color:var(--text-muted);font-style:italic">Empty</div>`;
    h+=`</div>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWriterProgress(){
  let panel=document.getElementById('writer-prog-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writer-prog-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._writerTargets)S._writerTargets={};
  const docs=(S.writerDocs||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Writer Progress Tracker</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!docs.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No writer docs found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  const totalTarget=Object.values(S._writerTargets).reduce((s,v)=>s+v,0);
  const totalWords=docs.reduce((s,d)=>s+(d.content||'').trim().split(/\s+/).filter(Boolean).length,0);
  if(totalTarget>0){
    const pct=Math.min(100,Math.round(totalWords/totalTarget*100));
    h+=`<div style="margin-bottom:16px;text-align:center"><span style="font-size:28px;font-weight:700;color:#4ade80">${totalWords.toLocaleString()}</span><span style="font-size:14px;color:var(--text-muted)"> / ${totalTarget.toLocaleString()} words</span></div>`;
    h+=`<div style="height:12px;background:var(--bg-surface);border-radius:6px;overflow:hidden;margin-bottom:16px"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:6px"></div></div>`;
  }
  docs.forEach(d=>{
    const words=(d.content||'').trim().split(/\s+/).filter(Boolean).length;
    const target=S._writerTargets[d.id]||0;
    const pct=target?Math.min(100,Math.round(words/target*100)):0;
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;margin-bottom:6px">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">`;
    h+=`<span style="font-size:12px;color:var(--text-primary);font-weight:500">${esc(d.title||'Untitled')}</span>`;
    h+=`<span style="font-size:10px;color:var(--text-muted)">${words} words</span>`;
    h+=`</div>`;
    h+=`<div style="display:flex;align-items:center;gap:8px">`;
    h+=`<div style="flex:1;height:8px;background:var(--bg-elevated);border-radius:4px;overflow:hidden"><div style="height:100%;width:${target?pct:0}%;background:${pct>=100?'#4ade80':'#60a5fa'};border-radius:4px"></div></div>`;
    h+=`<input type="number" value="${target||''}" placeholder="Target" style="width:70px;background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px 6px;font-size:10px" onchange="S._writerTargets['${d.id}']=parseInt(this.value)||0;save();showWriterProgress();">`;
    h+=`</div>`;
    if(target)h+=`<div style="font-size:9px;color:${pct>=100?'#4ade80':'var(--text-muted)'};margin-top:3px">${pct}%${pct>=100?' - TARGET REACHED':''}</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showBatchOperations(){
  let panel=document.getElementById('batch-ops-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='batch-ops-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const tasks=(S.tasks||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Batch Operations</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:16px">Perform bulk operations across your workspace. Use with caution.</div>';
  // Content operations
  h+='<div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:8px">Content Operations</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">';
  h+=`<button onclick="(function(){const tag=prompt('Tag to add to ALL content items:');if(!tag)return;(S.content||[]).forEach(c=>{if(!c.tags)c.tags=[];if(!c.tags.includes(tag))c.tags.push(tag);});save();alert('Tagged '+S.content.length+' items with: '+tag);})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Tag All Content</button>`;
  h+=`<button onclick="(function(){const tag=prompt('Tag to REMOVE from all content:');if(!tag)return;let count=0;(S.content||[]).forEach(c=>{if(c.tags){const idx=c.tags.indexOf(tag);if(idx>-1){c.tags.splice(idx,1);count++;}}});save();alert('Removed tag from '+count+' items');})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Remove Tag</button>`;
  h+=`<button onclick="(function(){const old=prompt('Old theme/category:');if(!old)return;const nw=prompt('New theme/category:');if(!nw)return;let count=0;(S.content||[]).forEach(c=>{if(c.theme===old){c.theme=nw;count++;}if(c.category===old){c.category=nw;count++;}});save();alert('Renamed '+count+' items from '+old+' to '+nw);})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Rename Category</button>`;
  h+='</div>';
  // Task operations
  h+='<div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:8px">Task Operations</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">';
  h+=`<button onclick="(function(){const count=S.tasks?S.tasks.filter(t=>t.status==='done').length:0;if(!count){alert('No done tasks to archive');return;}if(!confirm('Archive '+count+' completed tasks?'))return;S._archivedTasks=(S._archivedTasks||[]).concat(S.tasks.filter(t=>t.status==='done'));S.tasks=S.tasks.filter(t=>t.status!=='done');save();alert('Archived '+count+' tasks');showBatchOperations();})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Archive Done Tasks</button>`;
  h+=`<button onclick="(function(){const proj=prompt('Project name to assign ALL unassigned tasks:');if(!proj)return;let count=0;(S.tasks||[]).forEach(t=>{if(!t.project&&!t.projectId){t.project=proj;count++;}});save();alert('Assigned '+count+' tasks to '+proj);})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Assign Unassigned</button>`;
  h+=`<button onclick="(function(){let count=0;(S.tasks||[]).forEach(t=>{if(t.status!=='done'&&t.due&&new Date(t.due)<new Date()){const nd=new Date();nd.setDate(nd.getDate()+7);t.due=nd.toISOString().split('T')[0];count++;}});save();alert('Rescheduled '+count+' overdue tasks to next week');})()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;cursor:pointer">Reschedule Overdue</button>`;
  h+='</div>';
  h+=`<div style="font-size:10px;color:var(--text-muted);padding-top:8px;border-top:1px solid var(--border)">Stats: ${content.length} content items, ${tasks.length} tasks (${tasks.filter(t=>t.status==='done').length} done)</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContextSwitcher(){
  let panel=document.getElementById('ctx-switch-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ctx-switch-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._workContext)S._workContext='all';
  const contexts=[
    {id:'all',name:'All',desc:'Show everything',icon:'*',color:'#4ade80'},
    {id:'work',name:'Work',desc:'Work-related tasks and content only',icon:'W',color:'#60a5fa'},
    {id:'personal',name:'Personal',desc:'Personal items and goals',icon:'P',color:'#a78bfa'},
    {id:'creative',name:'Creative',desc:'Writing, content creation, ideas',icon:'C',color:'#facc15'},
    {id:'urgent',name:'Urgent',desc:'Only P0/P1 tasks and overdue',icon:'!',color:'#f87171'},
  ];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Workspace Context</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Current: <span style="color:var(--accent);font-weight:600">${contexts.find(c=>c.id===S._workContext)?.name||'All'}</span></div>`;
  contexts.forEach(c=>{
    const active=S._workContext===c.id;
    h+=`<div onclick="S._workContext='${c.id}';save();showContextSwitcher();" style="display:flex;align-items:center;gap:12px;padding:12px;background:${active?c.color+'20':'var(--bg-surface)'};border:1px solid ${active?c.color:'transparent'};border-radius:8px;margin-bottom:6px;cursor:pointer">`;
    h+=`<div style="width:36px;height:36px;border-radius:50%;background:${active?c.color:'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:${active?'#000':'var(--text-muted)'}">${c.icon}</div>`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary);font-weight:600">${c.name}</div><div style="font-size:10px;color:var(--text-muted)">${c.desc}</div></div>`;
    if(active)h+=`<div style="font-size:10px;color:${c.color};font-weight:600">ACTIVE</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDailyChecklist(){
  let panel=document.getElementById('daily-check-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='daily-check-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._dailyChecklist)S._dailyChecklist={items:[],lastReset:''};
  const today=new Date().toISOString().split('T')[0];
  if(S._dailyChecklist.lastReset!==today){S._dailyChecklist.items.forEach(i=>i.done=false);S._dailyChecklist.lastReset=today;save();}
  function render(){
    const items=S._dailyChecklist.items;
    const done=items.filter(i=>i.done).length;
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Daily Checklist</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">${today} | ${done}/${items.length} complete</div>`;
    if(items.length){
      const pct=Math.round(done/items.length*100);
      h+=`<div style="height:8px;background:var(--bg-surface);border-radius:4px;margin-bottom:16px;overflow:hidden"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:4px"></div></div>`;
    }
    items.forEach((item,i)=>{
      h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid var(--border)">`;
      h+=`<input type="checkbox" ${item.done?'checked':''} onchange="S._dailyChecklist.items[${i}].done=this.checked;save();showDailyChecklist();" style="cursor:pointer;width:16px;height:16px">`;
      h+=`<span style="flex:1;font-size:12px;color:${item.done?'var(--text-muted)':'var(--text-primary)'};${item.done?'text-decoration:line-through':''}">${esc(item.title)}</span>`;
      h+=`<button onclick="S._dailyChecklist.items.splice(${i},1);save();showDailyChecklist();" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px">x</button>`;
      h+=`</div>`;
    });
    h+='<div style="display:flex;gap:8px;margin-top:12px">';
    h+=`<input id="daily-check-input" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px" placeholder="Add recurring item..." onkeydown="if(event.key==='Enter'){const v=this.value.trim();if(v){S._dailyChecklist.items.push({title:v,done:false});save();showDailyChecklist();}}">`;
    h+=`<button onclick="const inp=document.getElementById('daily-check-input');const v=inp.value.trim();if(v){S._dailyChecklist.items.push({title:v,done:false});save();showDailyChecklist();}" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px 12px;font-size:11px;font-weight:600;cursor:pointer">Add</button>`;
    h+='</div>';
    h+=`<div style="font-size:9px;color:var(--text-muted);margin-top:8px;text-align:center">Items reset daily. Check marks clear each morning.</div>`;
    panel.innerHTML=h;
  }
  render();
  document.body.appendChild(panel);
}
function showKnowledgeMap(){
  let panel=document.getElementById('knowledge-map-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='knowledge-map-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const linkMap={};
  const wikiPattern=/\[\[([^\]]+)\]\]/g;
  content.forEach(c=>{
    const body=(c.body||'')+(c.title||'');
    let match;
    while((match=wikiPattern.exec(body))!==null){
      const target=match[1].toLowerCase();
      if(!linkMap[c.title])linkMap[c.title]=[];
      linkMap[c.title].push(target);
    }
  });
  const entries=Object.entries(linkMap).filter(([_,refs])=>refs.length>0).sort((a,b)=>b[1].length-a[1].length);
  const allTargets={};
  entries.forEach(([src,refs])=>{refs.forEach(r=>{allTargets[r]=(allTargets[r]||0)+1;});});
  const topTargets=Object.entries(allTargets).sort((a,b)=>b[1]-a[1]).slice(0,15);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Knowledge Map</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${entries.length} items with [[wiki-links]] | ${Object.keys(allTargets).length} unique targets</div>`;
  if(topTargets.length){
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Most referenced:</div>';
    const maxRef=topTargets[0]?topTargets[0][1]:1;
    topTargets.forEach(([target,count])=>{
      const pct=Math.round(count/maxRef*100);
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px"><div style="width:100px;font-size:10px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(target)}</div><div style="flex:1;height:10px;background:var(--bg-surface);border-radius:5px;overflow:hidden"><div style="height:100%;width:${pct}%;background:#4ade80;border-radius:5px"></div></div><div style="font-size:9px;color:var(--text-muted);width:25px">${count}</div></div>`;
    });
  }
  if(entries.length){
    h+='<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);margin-bottom:6px">Items with outgoing links:</div>';
    entries.slice(0,15).forEach(([src,refs])=>{
      h+=`<div style="padding:6px 0;border-bottom:1px solid var(--border)"><div style="font-size:11px;color:var(--text-primary);font-weight:500">${esc(src).substring(0,40)}</div>`;
      h+=`<div style="font-size:9px;color:var(--accent);margin-top:2px">Links to: ${refs.map(r=>esc(r)).join(', ')}</div></div>`;
    });
  }
  if(!entries.length&&!topTargets.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No [[wiki-links]] found in content. Use [[Page Name]] syntax to link items.</div>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentExportHub(){
  let panel=document.getElementById('export-hub-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='export-hub-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Export Hub</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:16px">Export your workspace data in various formats.</div>';
  const exports=[
    {label:'Full Backup (JSON)',desc:'Complete workspace state for backup/restore',action:function(){const data=JSON.stringify(S,null,2);const blob=new Blob([data],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='astra-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(url);}},
    {label:'Tasks (CSV)',desc:'Export tasks as CSV spreadsheet',action:function(){let csv='Title,Status,Priority,Due,Project,Created\\n';(S.tasks||[]).forEach(t=>{csv+='"'+((t.title||'').replace(/"/g,'""'))+'","'+(t.status||'')+'","'+(t.priority||'')+'","'+(t.due||'')+'","'+(t.project||'')+'","'+(t.createdAt||'')+'"\\n';});navigator.clipboard.writeText(csv);alert('Tasks CSV copied to clipboard ('+S.tasks.length+' rows)');}},
    {label:'Content (Markdown)',desc:'Export all content as markdown',action:function(){let md='# ASTRA Content Export\\n\\n';(S.content||[]).forEach(c=>{md+='## '+((c.title||'Untitled'))+'\\n';if(c.theme)md+='*Theme: '+c.theme+'*\\n\\n';md+=(c.body||'')+('\\n\\n---\\n\\n');});navigator.clipboard.writeText(md);alert('Content markdown copied to clipboard');}},
    {label:'Links (Markdown)',desc:'Export all links as categorized markdown',action:function(){let md='# ASTRA Links Export\\n\\n';const cats={};(S.links||[]).forEach(l=>{const cat=l.category||'Uncategorized';if(!cats[cat])cats[cat]=[];cats[cat].push(l);});Object.entries(cats).forEach(([cat,links])=>{md+='## '+cat+'\\n\\n';links.forEach(l=>{md+='- ['+((l.title||l.url)||'')+']('+((l.url)||'')+')\\n';});md+='\\n';});navigator.clipboard.writeText(md);alert('Links markdown copied to clipboard');}},
    {label:'Writer Docs (Markdown)',desc:'Export all writer documents',action:function(){let md='';(S.writerDocs||[]).forEach(d=>{md+='# '+(d.title||'Untitled')+'\\n\\n'+(d.content||'')+'\\n\\n---\\n\\n';});navigator.clipboard.writeText(md);alert('Writer docs copied to clipboard ('+((S.writerDocs||[]).length)+' docs)');}},
    {label:'Everything (HTML)',desc:'Full workspace as printable HTML page',action:function(){if(typeof printableExport==='function')printableExport();else alert('Printable export not available');}},
  ];
  exports.forEach(ex=>{
    h+=`<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-surface);border-radius:8px;margin-bottom:6px;cursor:pointer" onclick="(${ex.action.toString()})()">`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary);font-weight:500">${ex.label}</div><div style="font-size:10px;color:var(--text-muted)">${ex.desc}</div></div>`;
    h+=`<div style="font-size:18px;color:var(--accent)">></div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskDependencyGraph(){
  let panel=document.getElementById('task-dep-graph-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-dep-graph-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const withDeps=tasks.filter(t=>t.blockedBy&&t.blockedBy.length>0);
  const blocking=tasks.filter(t=>{return tasks.some(t2=>t2.blockedBy&&t2.blockedBy.includes(t.id));});
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Task Dependencies</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${withDeps.length} blocked tasks | ${blocking.length} blocking tasks</div>`;
  if(!withDeps.length&&!blocking.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No task dependencies found. Use the "B" button in task detail to set blocked-by relationships.</div>';
  }
  blocking.forEach(t=>{
    const dependents=tasks.filter(t2=>t2.blockedBy&&t2.blockedBy.includes(t.id));
    const statusColor=t.status==='done'?'#4ade80':t.status==='in-progress'?'#facc15':'#60a5fa';
    h+=`<div style="margin-bottom:12px">`;
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:8px;border-left:3px solid ${statusColor}">`;
    h+=`<div style="font-size:12px;color:var(--text-primary);font-weight:600;flex:1">${esc(t.title||'').substring(0,35)}</div>`;
    h+=`<div style="font-size:9px;color:${statusColor}">${t.status}</div>`;
    h+=`</div>`;
    dependents.forEach(dep=>{
      const depColor=dep.status==='done'?'#4ade80':dep.status==='in-progress'?'#facc15':'#f87171';
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px 6px 28px;border-left:1px dashed var(--border);margin-left:12px">`;
      h+=`<span style="color:var(--text-muted);font-size:10px">blocks ></span>`;
      h+=`<span style="font-size:11px;color:var(--text-secondary)">${esc(dep.title||'').substring(0,30)}</span>`;
      h+=`<span style="font-size:9px;color:${depColor};margin-left:auto">${dep.status}</span>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showInboxZero(){
  let panel=document.getElementById('inbox-zero-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='inbox-zero-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const unprocessed=[];
  (S.tasks||[]).filter(t=>t.status==='todo'&&!t.priority).forEach(t=>unprocessed.push({type:'task',item:t,issue:'No priority set'}));
  (S.tasks||[]).filter(t=>t.status==='todo'&&!t.due).forEach(t=>unprocessed.push({type:'task',item:t,issue:'No due date'}));
  (S.tasks||[]).filter(t=>t.status==='todo'&&!t.project&&!t.projectId).forEach(t=>unprocessed.push({type:'task',item:t,issue:'No project assigned'}));
  (S.content||[]).filter(c=>!c.tags||c.tags.length===0).forEach(c=>unprocessed.push({type:'content',item:c,issue:'No tags'}));
  (S.content||[]).filter(c=>!c.theme&&!c.category).forEach(c=>unprocessed.push({type:'content',item:c,issue:'No category/theme'}));
  (S.links||[]).filter(l=>!l.category).forEach(l=>unprocessed.push({type:'link',item:l,issue:'No category'}));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Inbox Zero Triage</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${unprocessed.length} items need attention</div>`;
  if(!unprocessed.length){
    h+='<div style="text-align:center;padding:40px"><div style="font-size:24px;color:#4ade80;margin-bottom:8px">Inbox Zero!</div><div style="font-size:11px;color:var(--text-muted)">All items are categorized and processed.</div></div>';
  }
  const grouped={task:[],content:[],link:[]};
  unprocessed.forEach(u=>{if(grouped[u.type])grouped[u.type].push(u);});
  ['task','content','link'].forEach(type=>{
    const items=grouped[type];
    if(!items.length)return;
    const colors={task:'#60a5fa',content:'#a78bfa',link:'#38bdf8'};
    h+=`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:${colors[type]};margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)">${type.charAt(0).toUpperCase()+type.slice(1)}s (${items.length})</div>`;
    items.slice(0,10).forEach(u=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px">`;
      h+=`<span style="color:var(--text-secondary);flex:1">${esc((u.item.title||u.item.url||'').substring(0,35))}</span>`;
      h+=`<span style="font-size:9px;color:#f87171">${u.issue}</span>`;
      h+=`</div>`;
    });
    if(items.length>10)h+=`<div style="font-size:10px;color:var(--text-muted)">+${items.length-10} more</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showReadingList(){
  let panel=document.getElementById('reading-list-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='reading-list-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._readingList)S._readingList={};
  const links=(S.links||[]).filter(l=>l.category==='learning'||l.category==='reference'||l.category==='reading');
  const allLinks=[...(S.links||[])];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Reading List</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const readCount=allLinks.filter(l=>S._readingList[l.id]).length;
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${readCount} read / ${allLinks.length} total links</div>`;
  const unread=allLinks.filter(l=>!S._readingList[l.id]);
  const read=allLinks.filter(l=>S._readingList[l.id]);
  if(unread.length){
    h+='<div style="font-size:11px;color:var(--accent);font-weight:600;margin-bottom:6px">Unread</div>';
    unread.slice(0,20).forEach(l=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid var(--border)">`;
      h+=`<input type="checkbox" onchange="S._readingList['${l.id}']=this.checked;save();showReadingList();" style="cursor:pointer">`;
      h+=`<a href="${esc(l.url||'')}" target="_blank" style="flex:1;font-size:11px;color:var(--text-primary);text-decoration:none">${esc((l.title||l.url||'').substring(0,45))}</a>`;
      h+=`<span style="font-size:9px;color:var(--text-muted)">${l.category||''}</span>`;
      h+=`</div>`;
    });
    if(unread.length>20)h+=`<div style="font-size:10px;color:var(--text-muted);margin-top:4px">+${unread.length-20} more</div>`;
  }
  if(read.length){
    h+=`<div style="font-size:11px;color:var(--text-muted);font-weight:600;margin:12px 0 6px;padding-top:8px;border-top:1px solid var(--border)">Read (${read.length})</div>`;
    read.slice(0,10).forEach(l=>{
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:4px 0;opacity:0.5">`;
      h+=`<input type="checkbox" checked onchange="delete S._readingList['${l.id}'];save();showReadingList();" style="cursor:pointer">`;
      h+=`<span style="font-size:11px;color:var(--text-muted);text-decoration:line-through">${esc((l.title||l.url||'').substring(0,40))}</span>`;
      h+=`</div>`;
    });
  }
  if(!allLinks.length)h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No links saved yet</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectStatusBoard(){
  let panel=document.getElementById('proj-status-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='proj-status-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._projectStatus)S._projectStatus={};
  const projects=(S.projects||[]);
  const statuses=['on-track','at-risk','blocked','completed','paused'];
  const statusColors={'on-track':'#4ade80','at-risk':'#facc15','blocked':'#f87171','completed':'#60a5fa','paused':'#6b7280'};
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Project Status Board</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!projects.length){h+='<div style="color:var(--text-muted);text-align:center;padding:40px">No projects found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  projects.forEach(p=>{
    const status=S._projectStatus[p.id]||'on-track';
    const tasks=(S.tasks||[]).filter(t=>t.projectId===p.id||t.project===p.name);
    const done=tasks.filter(t=>t.status==='done').length;
    const pct=tasks.length?Math.round(done/tasks.length*100):0;
    h+=`<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:8px;border-left:3px solid ${statusColors[status]}">`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">`;
    h+=`<span style="font-size:13px;color:var(--text-primary);font-weight:600">${esc(p.name||'Untitled')}</span>`;
    h+=`<select onchange="S._projectStatus['${p.id}']=this.value;save();showProjectStatusBoard();" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px 6px;font-size:10px">`;
    statuses.forEach(s=>{h+=`<option value="${s}" ${s===status?'selected':''}>${s}</option>`;});
    h+=`</select></div>`;
    h+=`<div style="height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden;margin-bottom:4px"><div style="height:100%;width:${pct}%;background:${statusColors[status]};border-radius:3px"></div></div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted)">${done}/${tasks.length} tasks (${pct}%)</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showCustomDashboard(){
  let panel=document.getElementById('custom-dash-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='custom-dash-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const content=(S.content||[]);const links=(S.links||[]);const docs=(S.writerDocs||[]);
  const now=new Date();const todayStr=now.toISOString().split('T')[0];
  const doneTasks=tasks.filter(t=>t.status==='done').length;
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now).length;
  const todayDue=tasks.filter(t=>t.status!=='done'&&t.due&&t.due.startsWith(todayStr)).length;
  const wip=tasks.filter(t=>t.status==='in-progress').length;
  const totalWords=content.reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0)+docs.reduce((s,d)=>s+(d.content||'').trim().split(/\s+/).filter(Boolean).length,0);
  const storageKB=(JSON.stringify(S).length/1024).toFixed(1);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">ASTRA Dashboard</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  // Stats row
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#4ade80">${tasks.length}</div><div style="font-size:9px;color:var(--text-muted)">Tasks</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#a78bfa">${content.length}</div><div style="font-size:9px;color:var(--text-muted)">Content</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#38bdf8">${links.length}</div><div style="font-size:9px;color:var(--text-muted)">Links</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:22px;font-weight:700;color:#fbbf24">${docs.length}</div><div style="font-size:9px;color:var(--text-muted)">Docs</div></div>`;
  h+='</div>';
  // Quick info
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">';
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:10px;color:var(--text-muted)">Today</div><div style="font-size:12px;color:var(--text-primary)">${todayDue} due | ${wip} in progress</div></div>`;
  h+=`<div style="background:${overdue>0?'rgba(248,113,113,0.1)':'var(--bg-surface)'};padding:10px;border-radius:8px"><div style="font-size:10px;color:var(--text-muted)">Overdue</div><div style="font-size:12px;color:${overdue>0?'#f87171':'var(--text-primary)'}">${overdue} tasks need attention</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:10px;color:var(--text-muted)">Total Words</div><div style="font-size:12px;color:var(--text-primary)">${totalWords.toLocaleString()}</div></div>`;
  h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px"><div style="font-size:10px;color:var(--text-muted)">Storage</div><div style="font-size:12px;color:var(--text-primary)">${storageKB} KB</div></div>`;
  h+='</div>';
  // Quick actions
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Quick Actions</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
  const actions=[
    ['New Task','showQuickTask()'],['New Note','showQuickNote()'],['New Link','showQuickLink()'],
    ['Daily Planner','showDailyPlanner()'],['Weekly Review','showWeeklyReview()'],['Focus Timer','startQuickTimer()'],
  ];
  actions.forEach(([label,fn])=>{
    h+=`<button onclick="${fn}" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:10px;cursor:pointer">${label}</button>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickCaptureSummary(){
  let panel=document.getElementById('capture-sum-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='capture-sum-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const captures=(S._captures||[]);
  const typeCounts={};
  captures.forEach(c=>{const t=c.type||'general';typeCounts[t]=(typeCounts[t]||0)+1;});
  const types=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Capture Summary</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${captures.length} total captures</div>`;
  if(!captures.length){
    h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No captures yet. Use Quick Capture (Cmd+Shift+C) or the Nexus extension to capture items.</div>';
  }
  const colors={idea:'#facc15',quote:'#a78bfa',code:'#4ade80',insight:'#60a5fa',todo:'#f87171',book:'#fb923c',research:'#38bdf8',thought:'#f472b6',general:'#6b7280'};
  if(types.length){
    const maxC=types[0][1];
    types.forEach(([type,count])=>{
      const pct=Math.round(count/maxC*100);
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px"><div style="width:70px;font-size:10px;color:var(--text-secondary);text-align:right">${type}</div><div style="flex:1;height:14px;background:var(--bg-surface);border-radius:7px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[type]||'#6b7280'};border-radius:7px"></div></div><div style="font-size:10px;color:var(--text-muted);width:25px">${count}</div></div>`;
    });
  }
  if(captures.length){
    h+='<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);margin-bottom:6px">Recent captures:</div>';
    captures.slice(0,10).forEach(c=>{
      const d=c.createdAt?new Date(c.createdAt).toLocaleDateString('en',{month:'short',day:'numeric'}):'';
      h+=`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:10px;border-bottom:1px solid var(--border)"><span style="color:var(--text-secondary);flex:1">${esc((c.text||c.title||'').substring(0,50))}</span><span style="color:${colors[c.type]||'#6b7280'}">${c.type||'general'}</span><span style="color:var(--text-muted);margin-left:8px">${d}</span></div>`;
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showNotesExplorer(){
  let panel=document.getElementById('notes-explorer-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='notes-explorer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const categories={};
  content.forEach(c=>{const cat=c.theme||c.category||'Uncategorized';if(!categories[cat])categories[cat]=[];categories[cat].push(c);});
  const cats=Object.entries(categories).sort((a,b)=>a[0].localeCompare(b[0]));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Notes Explorer</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+=`<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${content.length} items in ${cats.length} categories</div>`;
  if(!cats.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No content found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  cats.forEach(([cat,items])=>{
    h+=`<div style="margin-bottom:4px"><div onclick="const el=document.getElementById('ne-${cat.replace(/[^a-zA-Z0-9]/g,'')}');el.style.display=el.style.display==='none'?'block':'none'" style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-surface);border-radius:6px;cursor:pointer"><span style="font-size:12px;color:var(--accent);font-weight:500">${esc(cat)}</span><span style="font-size:10px;color:var(--text-muted)">${items.length}</span></div>`;
    h+=`<div id="ne-${cat.replace(/[^a-zA-Z0-9]/g,'')}" style="display:none;padding:4px 0 4px 16px;border-left:2px solid var(--border);margin-left:8px">`;
    items.forEach(c=>{
      const words=(c.body||'').trim().split(/\s+/).filter(Boolean).length;
      h+=`<div style="padding:4px 0;font-size:11px;border-bottom:1px solid var(--border)"><span style="color:var(--text-primary)">${esc((c.title||'Untitled').substring(0,35))}</span><span style="color:var(--text-muted);margin-left:8px;font-size:9px">${words}w</span></div>`;
    });
    h+=`</div></div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDeadlineTracker(){
  let panel=document.getElementById('deadline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='deadline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&t.due).sort((a,b)=>new Date(a.due)-new Date(b.due));
  const now=new Date();
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Deadline Tracker</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!tasks.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No tasks with due dates found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  tasks.forEach(t=>{
    const due=new Date(t.due);
    const diffMs=due-now;
    const diffDays=Math.ceil(diffMs/(1000*60*60*24));
    const isOverdue=diffDays<0;
    const isToday=diffDays===0;
    const isUrgent=diffDays>0&&diffDays<=3;
    const color=isOverdue?'#f87171':isToday?'#facc15':isUrgent?'#fb923c':diffDays<=7?'#60a5fa':'#4ade80';
    let countdown='';
    if(isOverdue)countdown=Math.abs(diffDays)+' days overdue';
    else if(isToday)countdown='TODAY';
    else if(diffDays===1)countdown='Tomorrow';
    else countdown=diffDays+' days';
    h+=`<div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg-surface);border-radius:8px;margin-bottom:6px;border-left:3px solid ${color}">`;
    h+=`<div style="min-width:60px;text-align:center"><div style="font-size:16px;font-weight:700;color:${color}">${isOverdue?'-'+Math.abs(diffDays):diffDays}</div><div style="font-size:8px;color:var(--text-muted)">${isOverdue?'overdue':'days left'}</div></div>`;
    h+=`<div style="flex:1"><div style="font-size:12px;color:var(--text-primary);font-weight:500">${esc(t.title||'').substring(0,35)}</div><div style="font-size:10px;color:var(--text-muted)">${t.due} | ${t.priority||'no priority'}</div></div>`;
    h+=`<div style="font-size:9px;color:${color};font-weight:600">${countdown}</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentGraph(){
  let panel=document.getElementById('content-graph-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-graph-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const days=30;
  const now=new Date();
  const dayData=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date(now);d.setDate(d.getDate()-i);
    const dateStr=d.toISOString().split('T')[0];
    const count=content.filter(c=>c.createdAt&&c.createdAt.startsWith(dateStr)).length;
    const words=content.filter(c=>c.createdAt&&c.createdAt.startsWith(dateStr)).reduce((s,c)=>s+(c.body||'').trim().split(/\s+/).filter(Boolean).length,0);
    dayData.push({label:d.toLocaleDateString('en',{month:'short',day:'numeric'}),count,words,date:dateStr});
  }
  const maxCount=Math.max(...dayData.map(d=>d.count),1);
  const maxWords=Math.max(...dayData.map(d=>d.words),1);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Content Creation (30 Days)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:12px;margin-bottom:8px"><span style="font-size:10px;color:#4ade80">Items created</span><span style="font-size:10px;color:#60a5fa">Words written</span></div>';
  const svgW=600,svgH=160,padL=35,padB=25,padT=10;
  const chartW=svgW-padL-10,chartH=svgH-padT-padB;
  h+=`<svg width="100%" viewBox="0 0 ${svgW} ${svgH}" style="display:block">`;
  for(let i=0;i<=3;i++){const y=padT+chartH-i*(chartH/3);h+=`<line x1="${padL}" y1="${y}" x2="${svgW-10}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;h+=`<text x="${padL-3}" y="${y+3}" text-anchor="end" fill="var(--text-muted)" font-size="8">${Math.round(maxCount*i/3)}</text>`;}
  // Items line
  let itemsPath='';
  dayData.forEach((d,i)=>{
    const x=padL+i*(chartW/(days-1));
    const y=padT+chartH-d.count/maxCount*chartH;
    itemsPath+=(i===0?'M':'L')+x+','+y;
    if(d.count>0)h+=`<circle cx="${x}" cy="${y}" r="2" fill="#4ade80"/>`;
  });
  h+=`<path d="${itemsPath}" fill="none" stroke="#4ade80" stroke-width="1.5" opacity="0.8"/>`;
  // Words line (normalized)
  let wordsPath='';
  dayData.forEach((d,i)=>{
    const x=padL+i*(chartW/(days-1));
    const y=padT+chartH-d.words/maxWords*chartH;
    wordsPath+=(i===0?'M':'L')+x+','+y;
  });
  h+=`<path d="${wordsPath}" fill="none" stroke="#60a5fa" stroke-width="1" stroke-dasharray="4,2" opacity="0.6"/>`;
  // X axis labels (every 5 days)
  dayData.forEach((d,i)=>{if(i%5===0){const x=padL+i*(chartW/(days-1));h+=`<text x="${x}" y="${svgH-3}" text-anchor="middle" fill="var(--text-muted)" font-size="7">${d.label}</text>`;}});
  h+=`</svg>`;
  const totalItems=dayData.reduce((s,d)=>s+d.count,0);
  const totalWords=dayData.reduce((s,d)=>s+d.words,0);
  const activeDays=dayData.filter(d=>d.count>0).length;
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:10px;color:var(--text-muted)"><span>${totalItems} items</span><span>${totalWords.toLocaleString()} words</span><span>${activeDays} active days</span></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWorkspaceSearch(){
  let panel=document.getElementById('ws-search-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ws-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Advanced Search</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<input id="adv-search-q" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:13px;margin-bottom:8px" placeholder="Search query...">';
  h+='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
  h+='<select id="adv-search-type" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px"><option value="all">All Types</option><option value="task">Tasks</option><option value="content">Content</option><option value="link">Links</option><option value="doc">Docs</option></select>';
  h+='<select id="adv-search-date" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px"><option value="all">Any Time</option><option value="today">Today</option><option value="week">This Week</option><option value="month">This Month</option></select>';
  h+=`<button onclick="advancedSearch()" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer">Search</button>`;
  h+='</div>';
  h+='<div id="adv-search-results"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const inp=document.getElementById('adv-search-q');if(inp){inp.focus();inp.addEventListener('keydown',e=>{if(e.key==='Enter')advancedSearch();});}},100);
}
function advancedSearch(){
  const q=(document.getElementById('adv-search-q')?.value||'').toLowerCase();
  const type=document.getElementById('adv-search-type')?.value||'all';
  const dateRange=document.getElementById('adv-search-date')?.value||'all';
  const results=document.getElementById('adv-search-results');if(!results)return;
  if(!q){results.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">Enter a search query</div>';return;}
  const now=new Date();
  const dateFilter=d=>{
    if(dateRange==='all'||!d)return true;
    const date=new Date(d);
    if(dateRange==='today')return date.toDateString()===now.toDateString();
    if(dateRange==='week'){const w=new Date(now);w.setDate(w.getDate()-7);return date>=w;}
    if(dateRange==='month'){const m=new Date(now);m.setMonth(m.getMonth()-1);return date>=m;}
    return true;
  };
  const items=[];
  if(type==='all'||type==='task')(S.tasks||[]).forEach(t=>{if(((t.title||'').toLowerCase().includes(q)||(t.description||'').toLowerCase().includes(q))&&dateFilter(t.createdAt))items.push({type:'Task',title:t.title,sub:t.status+' | '+t.priority,date:t.createdAt,color:'#60a5fa'});});
  if(type==='all'||type==='content')(S.content||[]).forEach(c=>{if(((c.title||'').toLowerCase().includes(q)||(c.body||'').toLowerCase().includes(q))&&dateFilter(c.createdAt))items.push({type:'Content',title:c.title,sub:c.theme||'',date:c.createdAt,color:'#a78bfa'});});
  if(type==='all'||type==='link')(S.links||[]).forEach(l=>{if(((l.title||'').toLowerCase().includes(q)||(l.url||'').toLowerCase().includes(q))&&dateFilter(l.createdAt))items.push({type:'Link',title:l.title||l.url,sub:l.category||'',date:l.createdAt,color:'#38bdf8'});});
  if(type==='all'||type==='doc')(S.writerDocs||[]).forEach(d=>{if(((d.title||'').toLowerCase().includes(q)||(d.content||'').toLowerCase().includes(q))&&dateFilter(d.updatedAt))items.push({type:'Doc',title:d.title,sub:'',date:d.updatedAt,color:'#fbbf24'});});
  let h='';
  if(!items.length)h='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">No results found</div>';
  h+=`<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">${items.length} results</div>`;
  items.slice(0,30).forEach(item=>{
    const d=item.date?new Date(item.date).toLocaleDateString('en',{month:'short',day:'numeric'}):'';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid var(--border)"><div style="background:${item.color};color:#000;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;min-width:50px;text-align:center">${item.type}</div><div style="flex:1"><div style="font-size:12px;color:var(--text-primary)">${esc((item.title||'').substring(0,45))}</div><div style="font-size:10px;color:var(--text-muted)">${esc(item.sub||'')}</div></div><div style="font-size:9px;color:var(--text-muted)">${d}</div></div>`;
  });
  results.innerHTML=h;
}
function showMotivationalQuote(){
  const quotes=[
    {text:'The only way to do great work is to love what you do.',author:'Steve Jobs'},
    {text:'Start where you are. Use what you have. Do what you can.',author:'Arthur Ashe'},
    {text:'Success is not final, failure is not fatal: it is the courage to continue that counts.',author:'Winston Churchill'},
    {text:'The best time to plant a tree was 20 years ago. The second best time is now.',author:'Chinese Proverb'},
    {text:'Done is better than perfect.',author:'Sheryl Sandberg'},
    {text:'Ships are safe in harbor, but that is not what ships are built for.',author:'John A. Shedd'},
    {text:'The secret of getting ahead is getting started.',author:'Mark Twain'},
    {text:'What you do today can improve all your tomorrows.',author:'Ralph Marston'},
    {text:'It does not matter how slowly you go as long as you do not stop.',author:'Confucius'},
    {text:'Excellence is not a destination but a continuously moving target.',author:'Unknown'},
    {text:'Build things that last. Ship things that matter.',author:'Gabo'},
    {text:'The code you write today is the tool you use tomorrow.',author:'Unknown'},
    {text:'Complexity is the enemy of execution.',author:'Tony Robbins'},
    {text:'Make it work, make it right, make it fast.',author:'Kent Beck'},
    {text:'Focus is saying no to the hundred other good ideas.',author:'Steve Jobs'},
  ];
  const q=quotes[Math.floor(Math.random()*quotes.length)];
  let panel=document.getElementById('quote-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quote-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:40px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;text-align:center';
  let h='<button onclick="this.parentElement.remove()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button>';
  h+=`<div style="font-size:18px;color:var(--text-primary);line-height:1.6;font-style:italic;margin-bottom:16px">"${q.text}"</div>`;
  h+=`<div style="font-size:12px;color:var(--accent)">- ${q.author}</div>`;
  h+=`<button onclick="showMotivationalQuote()" style="margin-top:20px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px 16px;font-size:11px;cursor:pointer">Another Quote</button>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showColorThemePicker(){
  let panel=document.getElementById('theme-picker-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='theme-picker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  const accents=[
    {name:'Mint Green',color:'#4ade80'},
    {name:'Cyan',color:'#22d3ee'},
    {name:'Blue',color:'#60a5fa'},
    {name:'Purple',color:'#a78bfa'},
    {name:'Pink',color:'#f472b6'},
    {name:'Orange',color:'#fb923c'},
    {name:'Yellow',color:'#facc15'},
    {name:'Red',color:'#f87171'},
    {name:'Teal',color:'#2dd4bf'},
    {name:'Lime',color:'#a3e635'},
    {name:'Indigo',color:'#818cf8'},
    {name:'Rose',color:'#fb7185'},
  ];
  const current=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#4ade80';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Accent Color</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">';
  accents.forEach(a=>{
    const active=current===a.color;
    h+=`<div onclick="document.documentElement.style.setProperty('--accent','${a.color}');S._accentColor='${a.color}';save();showColorThemePicker();" style="text-align:center;padding:12px 8px;background:var(--bg-surface);border:2px solid ${active?a.color:'transparent'};border-radius:8px;cursor:pointer">`;
    h+=`<div style="width:32px;height:32px;border-radius:50%;background:${a.color};margin:0 auto 6px"></div>`;
    h+=`<div style="font-size:10px;color:var(--text-secondary)">${a.name}</div>`;
    h+=`</div>`;
  });
  h+='</div>';
  h+=`<div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">Current: ${current}</div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showSessionLog(){
  let panel=document.getElementById('session-log-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='session-log-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._sessionLog)S._sessionLog=[];
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Session Log</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="display:flex;gap:8px;margin-bottom:12px">';
    h+='<input id="session-log-input" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:12px" placeholder="What did you work on?" onkeydown="if(event.key===\'Enter\'){const v=this.value.trim();if(v){S._sessionLog.unshift({text:v,time:new Date().toISOString()});save();showSessionLog();}}">';
    h+='<button onclick="const inp=document.getElementById(\'session-log-input\');const v=inp.value.trim();if(v){S._sessionLog.unshift({text:v,time:new Date().toISOString()});save();showSessionLog();}" style="background:var(--accent);color:#000;border:none;border-radius:6px;padding:8px 12px;font-size:11px;font-weight:600;cursor:pointer">Log</button>';
    h+='</div>';
    if(!S._sessionLog.length)h+='<div style="color:var(--text-muted);text-align:center;padding:20px;font-size:11px">No session logs yet. Start logging what you work on.</div>';
    let lastDate='';
    S._sessionLog.slice(0,30).forEach((entry,i)=>{
      const d=new Date(entry.time);
      const dateStr=d.toLocaleDateString('en',{month:'short',day:'numeric'});
      if(dateStr!==lastDate){h+=`<div style="font-size:10px;color:var(--accent);margin:12px 0 6px;font-weight:600">${dateStr}</div>`;lastDate=dateStr;}
      const time=d.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit'});
      h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)"><span style="font-size:9px;color:var(--text-muted);min-width:50px">${time}</span><span style="font-size:11px;color:var(--text-secondary);flex:1">${esc(entry.text)}</span><button onclick="S._sessionLog.splice(${i},1);save();showSessionLog();" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">x</button></div>`;
    });
    if(S._sessionLog.length>30)h+=`<div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px">Showing 30 of ${S._sessionLog.length} entries</div>`;
    h+=`<button onclick="if(confirm('Clear all session logs?')){S._sessionLog=[];save();showSessionLog();}" style="display:block;margin:12px auto 0;background:none;border:1px solid var(--border);color:var(--text-muted);border-radius:6px;padding:6px 16px;font-size:10px;cursor:pointer">Clear All</button>`;
    panel.innerHTML=h;
  }
  render();
  document.body.appendChild(panel);
}
function showRecentEdits(){
  let panel=document.getElementById('recent-edits-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='recent-edits-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const items=[];
  (S.content||[]).forEach(c=>{if(c.updatedAt)items.push({type:'Content',title:c.title,date:c.updatedAt,color:'#a78bfa'});else if(c.createdAt)items.push({type:'Content',title:c.title,date:c.createdAt,color:'#a78bfa'});});
  (S.tasks||[]).forEach(t=>{if(t.completedAt)items.push({type:'Task',title:t.title,date:t.completedAt,color:'#60a5fa'});else if(t.createdAt)items.push({type:'Task',title:t.title,date:t.createdAt,color:'#60a5fa'});});
  (S.writerDocs||[]).forEach(d=>{if(d.updatedAt)items.push({type:'Doc',title:d.title,date:d.updatedAt,color:'#fbbf24'});});
  (S.links||[]).forEach(l=>{if(l.createdAt)items.push({type:'Link',title:l.title||l.url,date:l.createdAt,color:'#38bdf8'});});
  items.sort((a,b)=>new Date(b.date)-new Date(a.date));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Recent Edits</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!items.length)h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No recent edits found</div>';
  items.slice(0,30).forEach(item=>{
    const d=new Date(item.date);
    const ago=Math.floor((Date.now()-d)/(1000*60));
    let agoStr;
    if(ago<60)agoStr=ago+'m ago';else if(ago<1440)agoStr=Math.floor(ago/60)+'h ago';else agoStr=Math.floor(ago/1440)+'d ago';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)"><div style="background:${item.color};color:#000;font-size:8px;font-weight:700;padding:2px 5px;border-radius:3px;min-width:45px;text-align:center">${item.type}</div><div style="flex:1;font-size:11px;color:var(--text-primary)">${esc((item.title||'Untitled').substring(0,40))}</div><div style="font-size:9px;color:var(--text-muted)">${agoStr}</div></div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDocOutline(){
  let panel=document.getElementById('doc-outline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='doc-outline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const docs=(S.writerDocs||[]);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Document Outlines</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!docs.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No writer docs found</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  docs.forEach(d=>{
    const headings=[];
    (d.content||'').split('\n').forEach(line=>{
      const m=line.match(/^(#{1,3})\s+(.+)/);
      if(m)headings.push({level:m[1].length,text:m[2]});
    });
    h+=`<div style="margin-bottom:12px"><div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:4px">${esc(d.title||'Untitled')}</div>`;
    if(!headings.length){h+=`<div style="font-size:10px;color:var(--text-muted);padding-left:12px">No headings found (use # syntax)</div>`;}
    headings.forEach(heading=>{
      const indent=(heading.level-1)*16;
      h+=`<div style="font-size:11px;color:var(--text-secondary);padding:2px 0 2px ${indent+12}px">${'#'.repeat(heading.level)} ${esc(heading.text)}</div>`;
    });
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showBacklogGroomer(){
  let panel=document.getElementById('backlog-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='backlog-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const backlog=(S.tasks||[]).filter(t=>t.status==='todo'&&!t.due);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Backlog Groomer (${backlog.length})</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!backlog.length){h+='<div style="color:var(--text-muted);text-align:center;padding:30px">No unscheduled TODO tasks. Your backlog is clean!</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Tasks without due dates. Set priority and schedule them.</div>';
  backlog.forEach(t=>{
    const age=t.createdAt?Math.floor((Date.now()-new Date(t.createdAt))/(1000*60*60*24)):0;
    const ageColor=age>14?'#f87171':age>7?'#facc15':'#4ade80';
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px">`;
    h+=`<div style="min-width:30px;text-align:center;font-size:10px;color:${ageColor};font-weight:600">${age}d</div>`;
    h+=`<div style="flex:1;font-size:11px;color:var(--text-primary)">${esc(t.title||'').substring(0,35)}</div>`;
    h+=`<select onchange="const task=(S.tasks||[]).find(x=>x.id==='${t.id}');if(task){task.priority=this.value;save();}" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:2px;font-size:9px"><option value="" ${!t.priority?'selected':''}>-</option><option value="p0" ${t.priority==='p0'?'selected':''}>P0</option><option value="p1" ${t.priority==='p1'?'selected':''}>P1</option><option value="p2" ${t.priority==='p2'?'selected':''}>P2</option><option value="p3" ${t.priority==='p3'?'selected':''}>P3</option></select>`;
    h+=`<input type="date" value="${t.due||''}" onchange="const task=(S.tasks||[]).find(x=>x.id==='${t.id}');if(task){task.due=this.value;save();}" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:2px;font-size:9px;width:100px">`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showFocusScoreHistory(){
  let panel=document.getElementById('focus-score-hist-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='focus-score-hist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const stats=(S._dailyStats||[]);
  const days=30;const now=new Date();
  const dayScores=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date(now);d.setDate(d.getDate()-i);
    const dateStr=d.toISOString().split('T')[0];
    const stat=stats.find(s=>s.date===dateStr);
    let score=0;
    if(stat){score=Math.min(100,((stat.tasksDone||0)*10)+((stat.contentCreated||0)*15)+((stat.focusMinutes||0)*0.5)+((stat.wordsWritten||0)*0.01));}
    dayScores.push({label:d.toLocaleDateString('en',{month:'short',day:'numeric'}),score:Math.round(score),date:dateStr});
  }
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Focus Score Trend (30 Days)</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const avg=dayScores.reduce((s,d)=>s+d.score,0)/days;
  h+=`<div style="text-align:center;margin-bottom:12px"><span style="font-size:28px;font-weight:700;color:${avg>=70?'#4ade80':avg>=40?'#facc15':'#f87171'}">${avg.toFixed(0)}</span><span style="font-size:12px;color:var(--text-muted)"> avg score</span></div>`;
  const svgW=560,svgH=140,padL=30,padB=20,padT=10;
  const chartW=svgW-padL-10,chartH=svgH-padT-padB;
  h+=`<svg width="100%" viewBox="0 0 ${svgW} ${svgH}" style="display:block">`;
  for(let i=0;i<=4;i++){const y=padT+chartH-i*(chartH/4);h+=`<line x1="${padL}" y1="${y}" x2="${svgW-10}" y2="${y}" stroke="var(--border)" stroke-width="0.5"/>`;h+=`<text x="${padL-3}" y="${y+3}" text-anchor="end" fill="var(--text-muted)" font-size="8">${i*25}</text>`;}
  let path='';
  dayScores.forEach((d,i)=>{
    const x=padL+i*(chartW/(days-1));
    const y=padT+chartH-d.score/100*chartH;
    path+=(i===0?'M':'L')+x+','+y;
    const color=d.score>=70?'#4ade80':d.score>=40?'#facc15':'#f87171';
    if(d.score>0)h+=`<circle cx="${x}" cy="${y}" r="2.5" fill="${color}"/>`;
  });
  h+=`<path d="${path}" fill="none" stroke="#4ade80" stroke-width="1.5" opacity="0.7"/>`;
  dayScores.forEach((d,i)=>{if(i%5===0){const x=padL+i*(chartW/(days-1));h+=`<text x="${x}" y="${svgH-3}" text-anchor="middle" fill="var(--text-muted)" font-size="7">${d.label}</text>`;}});
  h+=`</svg>`;
  const activeDays=dayScores.filter(d=>d.score>0).length;
  const bestDay=dayScores.reduce((max,d)=>d.score>max.score?d:max,{score:0,label:'-'});
  h+=`<div style="display:flex;gap:16px;justify-content:center;margin-top:8px;font-size:10px;color:var(--text-muted)"><span>${activeDays} active days</span><span>Best: ${bestDay.score} (${bestDay.label})</span></div>`;
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickConvert(){
  let panel=document.getElementById('quick-convert-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-convert-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Quick Convert</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:16px">Convert items between types. Original item is preserved.</div>';
  const conversions=[
    {from:'Content',to:'Task',desc:'Create task from content title',action:function(){const items=(S.content||[]);if(!items.length){alert('No content items');return;}const titles=items.map(c=>c.title||'Untitled').slice(0,20);const pick=prompt('Enter content title to convert to task:\\n'+titles.join('\\n'));if(!pick)return;const item=items.find(c=>(c.title||'').toLowerCase().includes(pick.toLowerCase()));if(!item){alert('Not found');return;}if(!S.tasks)S.tasks=[];S.tasks.push({id:'t_'+Date.now(),title:item.title||'',description:item.body||'',status:'todo',priority:'p2',due:'',tags:item.tags||[],createdAt:new Date().toISOString(),timeTracked:0});save();alert('Task created from: '+item.title);}},
    {from:'Task',to:'Content',desc:'Save task as content note',action:function(){const tasks=(S.tasks||[]).filter(t=>t.status==='done');if(!tasks.length){alert('No done tasks');return;}const titles=tasks.map(t=>t.title||'Untitled').slice(0,20);const pick=prompt('Enter done task title to save as content:\\n'+titles.join('\\n'));if(!pick)return;const task=tasks.find(t=>(t.title||'').toLowerCase().includes(pick.toLowerCase()));if(!task){alert('Not found');return;}if(!S.content)S.content=[];S.content.unshift({id:'c_'+Date.now(),title:task.title,body:(task.description||'')+'\\n\\nConverted from task. Priority: '+(task.priority||'none'),tags:task.tags||[],theme:'From Task',createdAt:new Date().toISOString()});save();alert('Content created from: '+task.title);}},
    {from:'Link',to:'Content',desc:'Save link as content reference',action:function(){const links=(S.links||[]);if(!links.length){alert('No links');return;}const pick=prompt('Enter link title/URL to save as content:');if(!pick)return;const link=links.find(l=>(l.title||'').toLowerCase().includes(pick.toLowerCase())||(l.url||'').toLowerCase().includes(pick.toLowerCase()));if(!link){alert('Not found');return;}if(!S.content)S.content=[];S.content.unshift({id:'c_'+Date.now(),title:link.title||link.url,body:'URL: '+(link.url||'')+'\\nCategory: '+(link.category||'')+'\\n\\nConverted from link.',tags:link.tags||[],theme:'Reference',createdAt:new Date().toISOString()});save();alert('Content created from link: '+(link.title||link.url));}},
    {from:'Content',to:'Writer Doc',desc:'Create writer doc from content',action:function(){const items=(S.content||[]).filter(c=>(c.body||'').length>50);if(!items.length){alert('No content items with enough text');return;}const pick=prompt('Enter content title to create writer doc:');if(!pick)return;const item=items.find(c=>(c.title||'').toLowerCase().includes(pick.toLowerCase()));if(!item){alert('Not found');return;}if(!S.writerDocs)S.writerDocs=[];S.writerDocs.push({id:'wd_'+Date.now(),title:item.title||'Untitled',content:item.body||'',versions:[],updatedAt:new Date().toISOString()});save();alert('Writer doc created from: '+item.title);}},
  ];
  conversions.forEach(c=>{
    h+=`<div onclick="(${c.action.toString()})()" style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-surface);border-radius:8px;margin-bottom:6px;cursor:pointer">`;
    h+=`<div style="font-size:11px;color:#60a5fa;font-weight:600;min-width:60px">${c.from}</div>`;
    h+=`<div style="color:var(--accent);font-size:14px">></div>`;
    h+=`<div style="font-size:11px;color:#4ade80;font-weight:600;min-width:60px">${c.to}</div>`;
    h+=`<div style="font-size:10px;color:var(--text-muted);flex:1">${c.desc}</div>`;
    h+=`</div>`;
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWorkspaceStats(){
  let panel=document.getElementById('ws-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='ws-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const t=(S.tasks||[]);const c=(S.content||[]);const l=(S.links||[]);const d=(S.writerDocs||[]);const p=(S.projects||[]);
  const totalWords=c.reduce((s,i)=>s+(i.body||'').trim().split(/\s+/).filter(Boolean).length,0)+d.reduce((s,i)=>s+(i.content||'').trim().split(/\s+/).filter(Boolean).length,0);
  const stateSize=JSON.stringify(S).length;
  const allTags=new Set();
  c.forEach(i=>(i.tags||[]).forEach(tg=>allTags.add(tg)));
  t.forEach(i=>(i.tags||[]).forEach(tg=>allTags.add(tg)));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:700;font-size:16px;color:var(--text-primary)">Workspace Statistics</div><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  const stats=[
    {label:'Total Tasks',value:t.length,color:'#60a5fa'},
    {label:'Done Tasks',value:t.filter(i=>i.status==='done').length,color:'#4ade80'},
    {label:'In Progress',value:t.filter(i=>i.status==='in-progress').length,color:'#facc15'},
    {label:'Content Items',value:c.length,color:'#a78bfa'},
    {label:'Links',value:l.length,color:'#38bdf8'},
    {label:'Writer Docs',value:d.length,color:'#fbbf24'},
    {label:'Projects',value:p.length,color:'#f472b6'},
    {label:'Total Words',value:totalWords.toLocaleString(),color:'#34d399'},
    {label:'Unique Tags',value:allTags.size,color:'#fb923c'},
    {label:'Storage',value:(stateSize/1024).toFixed(1)+'KB',color:'#818cf8'},
    {label:'Est. Pages',value:Math.ceil(totalWords/250),color:'#2dd4bf'},
    {label:'Completion %',value:t.length?(Math.round(t.filter(i=>i.status==='done').length/t.length*100)+'%'):'N/A',color:'#f87171'},
  ];
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">';
  stats.forEach(s=>{
    h+=`<div style="background:var(--bg-surface);padding:10px;border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:${s.color}">${s.value}</div><div style="font-size:9px;color:var(--text-muted)">${s.label}</div></div>`;
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showHabitTracker(){
  let panel=document.getElementById('habit-tracker-panel');if(panel)panel.remove();
  if(!S._habits)S._habits=[];
  panel=document.createElement('div');panel.id='habit-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const days7=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days7.push(d.toISOString().split('T')[0]);}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Habit Tracker</h3><div><button onclick="(function(){const n=prompt(\'Habit name:\');if(!n)return;S._habits.push({id:Date.now(),name:n,log:{}});save();showHabitTracker();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;margin-right:8px;font-size:11px">+ Habit</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  if(S._habits.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No habits yet. Add one to start tracking daily.</div>';}
  else{
    h+='<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;font-size:11px;color:var(--text-muted);border-bottom:1px solid var(--border)">Habit</th>';
    days7.forEach(d=>{h+='<th style="padding:6px;font-size:10px;color:var(--text-muted);text-align:center;border-bottom:1px solid var(--border)">'+d.slice(5)+'</th>';});
    h+='<th style="padding:6px;font-size:10px;color:var(--text-muted);text-align:center;border-bottom:1px solid var(--border)">Streak</th><th style="padding:6px;font-size:10px;border-bottom:1px solid var(--border)"></th></tr></thead><tbody>';
    S._habits.forEach(hab=>{
      h+='<tr><td style="padding:6px;font-size:12px">'+esc(hab.name)+'</td>';
      let streak=0;const sorted=Object.keys(hab.log||{}).filter(k=>hab.log[k]).sort().reverse();
      if(sorted.length>0){const t=new Date();for(let i=0;i<365;i++){const dd=new Date(t);dd.setDate(dd.getDate()-i);const dk=dd.toISOString().split('T')[0];if(hab.log&&hab.log[dk])streak++;else break;}}
      days7.forEach(d=>{
        const done=hab.log&&hab.log[d];
        h+='<td style="text-align:center;padding:6px"><button onclick="(function(){const h=S._habits.find(x=>x.id==='+hab.id+');if(!h)return;if(!h.log)h.log={};h.log[\''+d+'\']=!h.log[\''+d+'\'];save();showHabitTracker();})()" style="width:24px;height:24px;border-radius:4px;border:1px solid '+(done?'var(--accent)':'var(--border)')+';background:'+(done?'var(--accent)':'transparent')+';color:'+(done?'#000':'var(--text-muted)')+';cursor:pointer;font-size:10px">'+(done?'V':'')+'</button></td>';
      });
      h+='<td style="text-align:center;padding:6px;font-size:12px;color:var(--accent)">'+streak+'d</td>';
      h+='<td style="padding:6px"><button onclick="(function(){if(!confirm(\'Delete habit?\'))return;S._habits=S._habits.filter(x=>x.id!=='+hab.id+');save();showHabitTracker();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">X</button></td></tr>';
    });
    h+='</tbody></table>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showSmartSuggestions(){
  let panel=document.getElementById('smart-suggestions-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='smart-suggestions-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const suggestions=[];
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];const docs=(S.writerDocs||[]);
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<new Date());
  if(overdue.length>0)suggestions.push({icon:'!',text:'You have '+overdue.length+' overdue task'+(overdue.length>1?'s':'')+'. Consider rescheduling or completing them.',action:'tasks'});
  const noDesc=tasks.filter(t=>t.status!=='done'&&(!t.description||t.description.trim()===''));
  if(noDesc.length>3)suggestions.push({icon:'D',text:noDesc.length+' active tasks have no description. Adding context helps future you.',action:'tasks'});
  const noDue=tasks.filter(t=>t.status!=='done'&&!t.due);
  if(noDue.length>5)suggestions.push({icon:'C',text:noDue.length+' tasks have no due date. Schedule them for better planning.',action:'tasks'});
  const uncat=links.filter(l=>!l.category||l.category==='uncategorized');
  if(uncat.length>3)suggestions.push({icon:'L',text:uncat.length+' links are uncategorized. Organize for easier retrieval.',action:'links'});
  const shortContent=content.filter(c=>(c.body||'').split(/\s+/).length<20);
  if(shortContent.length>3)suggestions.push({icon:'W',text:shortContent.length+' content items are very short (<20 words). Consider expanding.',action:'content'});
  const emptyDocs=docs.filter(d=>!d.content||d.content.trim().length<50);
  if(emptyDocs.length>0)suggestions.push({icon:'E',text:emptyDocs.length+' writer doc'+(emptyDocs.length>1?'s are':' is')+' nearly empty. Start writing!',action:'writer'});
  const highPri=tasks.filter(t=>t.status!=='done'&&(t.priority==='p0'||t.priority==='p1'));
  if(highPri.length>5)suggestions.push({icon:'P',text:'You have '+highPri.length+' high-priority tasks. Focus on reducing this number.',action:'tasks'});
  const stale=tasks.filter(t=>{if(t.status==='done')return false;const age=(Date.now()-new Date(t.created||t.id).getTime())/(1000*60*60*24);return age>30;});
  if(stale.length>0)suggestions.push({icon:'S',text:stale.length+' tasks are older than 30 days. Review and archive if no longer relevant.',action:'tasks'});
  if(suggestions.length===0)suggestions.push({icon:'V',text:'Everything looks good! Your workspace is well-organized.',action:null});
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Smart Suggestions</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  suggestions.forEach(s=>{
    h+='<div style="display:flex;gap:12px;align-items:flex-start;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:'+(s.action?'pointer':'default')+'" '+(s.action?'onclick="this.parentElement.remove();switchSection(\''+s.action+'\')"':'')+'>';
    h+='<div style="width:28px;height:28px;border-radius:50%;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;flex-shrink:0">'+s.icon+'</div>';
    h+='<div style="font-size:12px;line-height:1.5;color:var(--text-primary)">'+esc(s.text)+'</div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectArchive(){
  let panel=document.getElementById('project-archive-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='project-archive-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._archivedProjects)S._archivedProjects=[];
  const projects=S.projects||[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Project Archive</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Archive completed projects to reduce clutter. Archived projects are hidden from main views but data is preserved.</div>';
  h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Active Projects</h4>';
  if(projects.length===0){h+='<div style="color:var(--text-muted);font-size:11px;padding:8px 0">No active projects.</div>';}
  else{projects.forEach(p=>{
    const taskCount=(S.tasks||[]).filter(t=>t.projectId===p.id).length;
    const doneCount=(S.tasks||[]).filter(t=>t.projectId===p.id&&t.status==='done').length;
    h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px">';
    h+='<div><div style="font-size:12px;font-weight:600">'+esc(p.name)+'</div><div style="font-size:10px;color:var(--text-muted)">'+taskCount+' tasks ('+doneCount+' done)</div></div>';
    h+='<button onclick="(function(){if(!confirm(\'Archive project: '+esc(p.name).replace(/'/g,"\\'")+'?\'))return;if(!S._archivedProjects)S._archivedProjects=[];S._archivedProjects.push(S.projects.find(x=>x.id===\''+p.id+'\'));S.projects=S.projects.filter(x=>x.id!==\''+p.id+'\');save();showProjectArchive();})()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:10px">Archive</button>';
    h+='</div>';
  });}
  h+='<h4 style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">Archived Projects ('+S._archivedProjects.length+')</h4>';
  if(S._archivedProjects.length===0){h+='<div style="color:var(--text-muted);font-size:11px;padding:8px 0">No archived projects.</div>';}
  else{S._archivedProjects.forEach(p=>{
    h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;opacity:0.6">';
    h+='<div style="font-size:12px">'+esc(p.name)+'</div>';
    h+='<button onclick="(function(){S.projects.push(S._archivedProjects.find(x=>x.id===\''+p.id+'\'));S._archivedProjects=S._archivedProjects.filter(x=>x.id!==\''+p.id+'\');save();showProjectArchive();})()" style="background:none;border:1px solid var(--accent);color:var(--accent);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:10px">Restore</button>';
    h+='</div>';
  });}
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showSprintPlanner(){
  let panel=document.getElementById('sprint-planner-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='sprint-planner-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._sprints)S._sprints=[];
  const tasks=S.tasks||[];
  const today=new Date();const weekEnd=new Date(today);weekEnd.setDate(today.getDate()+(7-today.getDay()));
  const activeSprint=S._sprints.find(s=>s.active);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Sprint Planner</h3><div>';
  if(!activeSprint)h+='<button onclick="(function(){const name=prompt(\'Sprint name:\',\'Sprint \'+(S._sprints.length+1));if(!name)return;S._sprints.push({id:Date.now(),name:name,active:true,taskIds:[],startDate:new Date().toISOString(),endDate:new Date(Date.now()+7*24*60*60*1000).toISOString()});save();showSprintPlanner();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">New Sprint</button>';
  h+='<button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  if(activeSprint){
    const sprintTasks=tasks.filter(t=>activeSprint.taskIds.includes(t.id));
    const done=sprintTasks.filter(t=>t.status==='done').length;
    const pct=sprintTasks.length>0?Math.round(done/sprintTasks.length*100):0;
    h+='<div style="padding:12px;border:1px solid var(--accent);border-radius:8px;margin-bottom:16px">';
    h+='<div style="display:flex;justify-content:space-between;margin-bottom:8px"><strong style="font-size:13px">'+esc(activeSprint.name)+'</strong><span style="font-size:11px;color:var(--text-muted)">'+done+'/'+sprintTasks.length+' done ('+pct+'%)</span></div>';
    h+='<div style="height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden;margin-bottom:12px"><div style="height:100%;background:var(--accent);width:'+pct+'%;border-radius:3px"></div></div>';
    sprintTasks.forEach(t=>{
      const color=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':t.priority==='p2'?'#3b82f6':'#6b7280';
      h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid var(--border);font-size:11px">';
      h+='<span style="'+(t.status==='done'?'text-decoration:line-through;color:var(--text-muted)':'')+'"><span style="color:'+color+';margin-right:6px">'+esc(t.priority||'p3').toUpperCase()+'</span>'+esc(t.title)+'</span>';
      h+='<button onclick="(function(){activeSprint.taskIds=activeSprint.taskIds.filter(id=>id!==\''+t.id+'\');save();showSprintPlanner();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px">remove</button></div>';
    });
    h+='<div style="margin-top:8px"><button onclick="(function(){const s=S._sprints.find(x=>x.active);if(s){s.active=false;}save();showSprintPlanner();})()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:10px">End Sprint</button></div></div>';
    h+='<h4 style="margin:12px 0 8px;font-size:12px;color:var(--text-muted)">Add Tasks to Sprint</h4>';
    const available=tasks.filter(t=>t.status!=='done'&&!activeSprint.taskIds.includes(t.id)).slice(0,20);
    available.forEach(t=>{
      h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid var(--border);font-size:11px">';
      h+='<span>'+esc(t.title)+'</span>';
      h+='<button onclick="(function(){const s=S._sprints.find(x=>x.active);if(s)s.taskIds.push(\''+t.id+'\');save();showSprintPlanner();})()" style="background:var(--accent);color:#000;border:none;padding:2px 8px;border-radius:3px;cursor:pointer;font-size:10px">Add</button></div>';
    });
  }else{
    if(S._sprints.length>0){
      h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Past Sprints</h4>';
      S._sprints.slice().reverse().forEach(s=>{
        const st=tasks.filter(t=>s.taskIds.includes(t.id));
        const d=st.filter(t=>t.status==='done').length;
        h+='<div style="padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;opacity:0.7"><div style="font-size:12px;font-weight:600">'+esc(s.name)+'</div><div style="font-size:10px;color:var(--text-muted)">'+d+'/'+st.length+' completed</div></div>';
      });
    }else{
      h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No sprints yet. Create one to plan your week.</div>';
    }
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentTemplates(){
  let panel=document.getElementById('content-templates-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-templates-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._contentTemplates)S._contentTemplates=[
    {id:1,name:'Blog Post',body:'# Title\n\n## Introduction\n\n## Main Points\n\n### Point 1\n\n### Point 2\n\n### Point 3\n\n## Conclusion\n\n## Call to Action'},
    {id:2,name:'Meeting Notes',body:'## Meeting: [Topic]\n**Date:** [date]\n**Attendees:** \n\n## Agenda\n1. \n2. \n3. \n\n## Notes\n\n## Action Items\n- [ ] \n- [ ] \n\n## Next Steps'},
    {id:3,name:'Project Brief',body:'# Project: [Name]\n\n## Objective\n\n## Scope\n\n## Timeline\n- Start: \n- End: \n\n## Key Deliverables\n1. \n2. \n3. \n\n## Success Criteria\n\n## Risks'},
    {id:4,name:'Weekly Review',body:'# Week of [date]\n\n## Wins\n- \n\n## Challenges\n- \n\n## Lessons Learned\n- \n\n## Next Week Focus\n1. \n2. \n3. '},
    {id:5,name:'Quick Note',body:'## Note\n\n'},
  ];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Content Templates</h3><div><button onclick="(function(){const n=prompt(\'Template name:\');if(!n)return;const b=prompt(\'Template body (markdown):\');if(!b)return;S._contentTemplates.push({id:Date.now(),name:n,body:b});save();showContentTemplates();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">+ Template</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  S._contentTemplates.forEach(tmpl=>{
    h+='<div style="padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong style="font-size:13px">'+esc(tmpl.name)+'</strong><div>';
    h+='<button onclick="(function(){const body=S._contentTemplates.find(t=>t.id==='+tmpl.id+').body;const title=prompt(\'Content title:\',\''+esc(tmpl.name).replace(/'/g,"\\'")+'\');if(!title)return;if(!S.content)S.content=[];S.content.unshift({id:\'c_\'+Date.now(),title:title,body:body,tags:[],theme:\'general\',created:new Date().toISOString()});save();showContentTemplates();showNotification(\'Content created from template\');})()" style="background:var(--accent);color:#000;border:none;padding:3px 8px;border-radius:3px;cursor:pointer;font-size:10px;margin-right:4px">Use</button>';
    h+='<button onclick="(function(){if(!confirm(\'Delete template?\'))return;S._contentTemplates=S._contentTemplates.filter(t=>t.id!=='+tmpl.id+');save();showContentTemplates();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">X</button></div></div>';
    h+='<pre style="font-size:10px;color:var(--text-muted);margin:0;white-space:pre-wrap;max-height:80px;overflow:hidden">'+esc(tmpl.body)+'</pre></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWorkspaceTimeline(){
  let panel=document.getElementById('workspace-timeline-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='workspace-timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const events=[];
  (S.tasks||[]).forEach(t=>{events.push({date:t.created||new Date(parseInt(t.id.replace(/\D/g,''))||Date.now()).toISOString(),type:'task',title:'Task: '+t.title,status:t.status});});
  (S.content||[]).forEach(c=>{events.push({date:c.created||new Date().toISOString(),type:'content',title:'Content: '+c.title,status:'created'});});
  (S.links||[]).forEach(l=>{events.push({date:l.created||new Date().toISOString(),type:'link',title:'Link: '+(l.title||l.url),status:'saved'});});
  (S.writerDocs||[]).forEach(d=>{events.push({date:d.modified||d.created||new Date().toISOString(),type:'doc',title:'Doc: '+d.title,status:'written'});});
  events.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const typeColors={task:'#4ade80',content:'#22d3ee',link:'#f97316',doc:'#a78bfa'};
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Workspace Timeline</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px;display:flex;gap:12px">';
  Object.entries(typeColors).forEach(([t,c])=>{h+='<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+c+';margin-right:4px"></span>'+t+'</span>';});
  h+='</div>';
  const shown=events.slice(0,50);
  let lastDate='';
  shown.forEach(ev=>{
    const d=ev.date?ev.date.split('T')[0]:'unknown';
    if(d!==lastDate){lastDate=d;h+='<div style="font-size:10px;color:var(--text-muted);padding:8px 0 4px;border-top:1px solid var(--border);margin-top:8px">'+d+'</div>';}
    const col=typeColors[ev.type]||'var(--text-muted)';
    h+='<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px">';
    h+='<div style="width:8px;height:8px;border-radius:50%;background:'+col+';flex-shrink:0"></div>';
    h+='<span style="color:var(--text-primary)">'+esc(ev.title)+'</span>';
    h+='<span style="color:var(--text-muted);font-size:9px;margin-left:auto">'+esc(ev.status)+'</span></div>';
  });
  if(events.length>50)h+='<div style="color:var(--text-muted);font-size:10px;text-align:center;padding:12px 0">Showing 50 of '+events.length+' events</div>';
  if(events.length===0)h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No events yet. Start creating tasks, content, and docs.</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTagManager(){
  let panel=document.getElementById('tag-manager-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='tag-manager-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tagMap={};
  (S.tasks||[]).forEach(t=>{(t.tags||[]).forEach(tag=>{if(!tagMap[tag])tagMap[tag]={count:0,sections:new Set()};tagMap[tag].count++;tagMap[tag].sections.add('tasks');});});
  (S.content||[]).forEach(c=>{(c.tags||[]).forEach(tag=>{if(!tagMap[tag])tagMap[tag]={count:0,sections:new Set()};tagMap[tag].count++;tagMap[tag].sections.add('content');});});
  (S.links||[]).forEach(l=>{(l.tags||[]).forEach(tag=>{if(!tagMap[tag])tagMap[tag]={count:0,sections:new Set()};tagMap[tag].count++;tagMap[tag].sections.add('links');});});
  const sorted=Object.entries(tagMap).sort((a,b)=>b[1].count-a[1].count);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Tag Manager</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+sorted.length+' unique tags across your workspace. Click rename to update everywhere.</div>';
  if(sorted.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No tags found. Start tagging your items.</div>';}
  sorted.forEach(([tag,info])=>{
    h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid var(--border)">';
    h+='<div><span style="font-size:12px;font-weight:600">'+esc(tag)+'</span><span style="font-size:10px;color:var(--text-muted);margin-left:8px">'+info.count+' items in '+Array.from(info.sections).join(', ')+'</span></div>';
    h+='<div style="display:flex;gap:4px">';
    h+='<button onclick="(function(){const nw=prompt(\'Rename tag \\\''+esc(tag).replace(/'/g,"\\'")+'\\\' to:\');if(!nw||nw===\''+esc(tag).replace(/'/g,"\\'")+'\')return;(S.tasks||[]).forEach(t=>{if(t.tags)t.tags=t.tags.map(x=>x===\''+esc(tag).replace(/'/g,"\\'")+'\' ?nw:x)});(S.content||[]).forEach(c=>{if(c.tags)c.tags=c.tags.map(x=>x===\''+esc(tag).replace(/'/g,"\\'")+'\' ?nw:x)});(S.links||[]).forEach(l=>{if(l.tags)l.tags=l.tags.map(x=>x===\''+esc(tag).replace(/'/g,"\\'")+'\' ?nw:x)});save();showTagManager();})()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:2px 8px;border-radius:3px;cursor:pointer;font-size:10px">Rename</button>';
    h+='<button onclick="(function(){if(!confirm(\'Delete tag \\\''+esc(tag).replace(/'/g,"\\'")+'\\\' from all '+info.count+' items?\'))return;(S.tasks||[]).forEach(t=>{if(t.tags)t.tags=t.tags.filter(x=>x!==\''+esc(tag).replace(/'/g,"\\'")+'\')});(S.content||[]).forEach(c=>{if(c.tags)c.tags=c.tags.filter(x=>x!==\''+esc(tag).replace(/'/g,"\\'")+'\')});(S.links||[]).forEach(l=>{if(l.tags)l.tags=l.tags.filter(x=>x!==\''+esc(tag).replace(/'/g,"\\'")+'\')});save();showTagManager();})()" style="background:none;border:1px solid #ef4444;color:#ef4444;padding:2px 8px;border-radius:3px;cursor:pointer;font-size:10px">Delete</button></div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskMatrix(){
  let panel=document.getElementById('task-matrix-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-matrix-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const projects=S.projects||[];
  const statuses=['todo','in-progress','review','blocked'];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Matrix (Project x Status)</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:8px;font-size:11px;color:var(--text-muted);border-bottom:1px solid var(--border)">Project</th>';
  statuses.forEach(s=>{h+='<th style="padding:8px;font-size:11px;color:var(--text-muted);text-align:center;border-bottom:1px solid var(--border)">'+esc(s)+'</th>';});
  h+='<th style="padding:8px;font-size:11px;color:var(--text-muted);text-align:center;border-bottom:1px solid var(--border)">Total</th></tr></thead><tbody>';
  const projList=[...projects,{id:null,name:'No Project'}];
  projList.forEach(p=>{
    const pTasks=tasks.filter(t=>p.id?(t.projectId===p.id):(! t.projectId));
    if(pTasks.length===0)return;
    h+='<tr><td style="padding:8px;font-size:12px;font-weight:600;border-bottom:1px solid var(--border)">'+esc(p.name)+'</td>';
    statuses.forEach(s=>{
      const c=pTasks.filter(t=>t.status===s).length;
      const bg=c>0?(s==='blocked'?'rgba(239,68,68,0.15)':s==='in-progress'?'rgba(74,222,128,0.15)':'transparent'):'transparent';
      h+='<td style="padding:8px;text-align:center;font-size:12px;border-bottom:1px solid var(--border);background:'+bg+'">'+(c||'-')+'</td>';
    });
    h+='<td style="padding:8px;text-align:center;font-size:12px;font-weight:600;border-bottom:1px solid var(--border);color:var(--accent)">'+pTasks.length+'</td></tr>';
  });
  const totals=statuses.map(s=>tasks.filter(t=>t.status===s).length);
  h+='<tr style="background:var(--bg-surface)"><td style="padding:8px;font-size:11px;font-weight:600">TOTAL</td>';
  totals.forEach(t=>{h+='<td style="padding:8px;text-align:center;font-size:12px;font-weight:600">'+t+'</td>';});
  h+='<td style="padding:8px;text-align:center;font-size:12px;font-weight:bold;color:var(--accent)">'+tasks.length+'</td></tr>';
  h+='</tbody></table>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showBookmarkOrganizer(){
  let panel=document.getElementById('bookmark-organizer-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='bookmark-organizer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const links=S.links||[];
  const categories={};
  links.forEach(l=>{const c=l.category||'uncategorized';if(!categories[c])categories[c]=[];categories[c].push(l);});
  const sorted=Object.entries(categories).sort((a,b)=>b[1].length-a[1].length);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Bookmark Organizer</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+links.length+' bookmarks in '+sorted.length+' categories. Click category to expand.</div>';
  sorted.forEach(([cat,items])=>{
    const id='bm-cat-'+cat.replace(/\W/g,'');
    h+='<div style="border:1px solid var(--border);border-radius:8px;margin-bottom:8px;overflow:hidden">';
    h+='<div onclick="const c=document.getElementById(\''+id+'\');c.style.display=c.style.display===\'none\'?\'block\':\'none\'" style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;cursor:pointer;background:var(--bg-surface)">';
    h+='<span style="font-size:12px;font-weight:600">'+esc(cat)+'</span><span style="font-size:10px;color:var(--text-muted)">'+items.length+' links</span></div>';
    h+='<div id="'+id+'" style="display:none;padding:8px 12px">';
    items.forEach(l=>{
      let domain='';try{domain=new URL(l.url).hostname.replace('www.','');}catch(e){}
      h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border);font-size:11px">';
      h+='<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%"><a href="'+esc(l.url)+'" target="_blank" style="color:var(--accent);text-decoration:none">'+esc(l.title||domain||l.url)+'</a></div>';
      h+='<span style="color:var(--text-muted);font-size:9px">'+esc(domain)+'</span></div>';
    });
    h+='</div></div>';
  });
  if(links.length===0)h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No bookmarks saved yet.</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWeeklyGoals(){
  let panel=document.getElementById('weekly-goals-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='weekly-goals-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._weeklyGoals)S._weeklyGoals=[];
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());
  const weekKey=weekStart.toISOString().split('T')[0];
  let current=S._weeklyGoals.find(w=>w.week===weekKey);
  if(!current){current={week:weekKey,goals:[]};S._weeklyGoals.push(current);}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Weekly Goals</h3><div><button onclick="(function(){const g=prompt(\'New goal:\');if(!g)return;const w=S._weeklyGoals.find(x=>x.week===\''+weekKey+'\');if(w)w.goals.push({id:Date.now(),text:g,done:false});save();showWeeklyGoals();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">+ Goal</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Week of '+weekKey+'</div>';
  const done=current.goals.filter(g=>g.done).length;
  const pct=current.goals.length>0?Math.round(done/current.goals.length*100):0;
  if(current.goals.length>0){
    h+='<div style="height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden;margin-bottom:16px"><div style="height:100%;background:var(--accent);width:'+pct+'%;border-radius:3px;transition:width 0.3s"></div></div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;text-align:right">'+done+'/'+current.goals.length+' completed ('+pct+'%)</div>';
  }
  current.goals.forEach(g=>{
    h+='<div style="display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px'+(g.done?';opacity:0.6':'')+'">';
    h+='<button onclick="(function(){const w=S._weeklyGoals.find(x=>x.week===\''+weekKey+'\');if(w){const g=w.goals.find(x=>x.id==='+g.id+');if(g)g.done=!g.done;}save();showWeeklyGoals();})()" style="width:22px;height:22px;border-radius:50%;border:2px solid '+(g.done?'var(--accent)':'var(--border)')+';background:'+(g.done?'var(--accent)':'transparent')+';cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#000;font-size:10px">'+(g.done?'V':'')+'</button>';
    h+='<span style="font-size:12px;flex:1;'+(g.done?'text-decoration:line-through;color:var(--text-muted)':'')+'">'+esc(g.text)+'</span>';
    h+='<button onclick="(function(){const w=S._weeklyGoals.find(x=>x.week===\''+weekKey+'\');if(w)w.goals=w.goals.filter(x=>x.id!=='+g.id+');save();showWeeklyGoals();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">X</button></div>';
  });
  if(current.goals.length===0)h+='<div style="color:var(--text-muted);text-align:center;padding:30px 0">No goals set for this week. Add some!</div>';
  // Past weeks
  const past=S._weeklyGoals.filter(w=>w.week!==weekKey&&w.goals.length>0).sort((a,b)=>b.week.localeCompare(a.week)).slice(0,4);
  if(past.length>0){
    h+='<h4 style="margin:20px 0 8px;font-size:12px;color:var(--text-muted)">Previous Weeks</h4>';
    past.forEach(w=>{const d=w.goals.filter(g=>g.done).length;h+='<div style="padding:8px;border:1px solid var(--border);border-radius:6px;margin-bottom:4px;font-size:11px;display:flex;justify-content:space-between"><span>'+w.week+'</span><span style="color:var(--accent)">'+d+'/'+w.goals.length+'</span></div>';});
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentAnalytics(){
  let panel=document.getElementById('content-analytics-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-analytics-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=S.content||[];
  const totalWords=content.reduce((s,c)=>{return s+(c.body||'').split(/\s+/).filter(w=>w).length;},0);
  const totalItems=content.length;
  const avgWords=totalItems>0?Math.round(totalWords/totalItems):0;
  const themes={};content.forEach(c=>{const t=c.theme||'general';themes[t]=(themes[t]||0)+1;});
  const tags={};content.forEach(c=>{(c.tags||[]).forEach(t=>{tags[t]=(tags[t]||0)+1;});});
  const monthMap={};content.forEach(c=>{const d=(c.created||'').substring(0,7);if(d)monthMap[d]=(monthMap[d]||0)+1;});
  const months=Object.entries(monthMap).sort((a,b)=>a[0].localeCompare(b[0]));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Content Analytics</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:var(--accent)">'+totalItems+'</div><div style="font-size:10px;color:var(--text-muted)">Total Items</div></div>';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:var(--accent)">'+totalWords.toLocaleString()+'</div><div style="font-size:10px;color:var(--text-muted)">Total Words</div></div>';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:var(--accent)">'+avgWords+'</div><div style="font-size:10px;color:var(--text-muted)">Avg Words/Item</div></div></div>';
  // Theme breakdown
  const thSorted=Object.entries(themes).sort((a,b)=>b[1]-a[1]);
  if(thSorted.length>0){
    h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">By Theme</h4>';
    const maxTh=thSorted[0][1];
    thSorted.forEach(([t,c])=>{
      const pct=Math.round(c/maxTh*100);
      h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:11px;width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(t)+'</span><div style="flex:1;height:14px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:var(--accent);width:'+pct+'%;border-radius:3px"></div></div><span style="font-size:10px;color:var(--text-muted);width:30px;text-align:right">'+c+'</span></div>';
    });
  }
  // Top tags
  const tagSorted=Object.entries(tags).sort((a,b)=>b[1]-a[1]).slice(0,10);
  if(tagSorted.length>0){
    h+='<h4 style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">Top Tags</h4>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
    tagSorted.forEach(([t,c])=>{h+='<span style="padding:3px 8px;background:var(--bg-surface);border-radius:12px;font-size:10px;color:var(--accent)">'+esc(t)+' ('+c+')</span>';});
    h+='</div>';
  }
  // Monthly trend
  if(months.length>0){
    h+='<h4 style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">Monthly Creation</h4>';
    const maxM=Math.max(...months.map(m=>m[1]));
    months.slice(-12).forEach(([m,c])=>{
      const pct=Math.round(c/maxM*100);
      h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px"><span style="font-size:10px;width:60px;color:var(--text-muted)">'+m+'</span><div style="flex:1;height:12px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:var(--accent);width:'+pct+'%"></div></div><span style="font-size:10px;color:var(--text-muted);width:25px;text-align:right">'+c+'</span></div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickBookmark(){
  let panel=document.getElementById('quick-bookmark-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-bookmark-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:var(--accent);font-size:13px">Quick Bookmark</h4><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<input id="qb-url" placeholder="URL" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:8px;box-sizing:border-box">';
  h+='<input id="qb-title" placeholder="Title (optional)" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:8px;box-sizing:border-box">';
  h+='<select id="qb-cat" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:8px">';
  const cats=[...new Set((S.links||[]).map(l=>l.category||'uncategorized'))];
  cats.forEach(c=>{h+='<option value="'+esc(c)+'">'+esc(c)+'</option>';});
  h+='<option value="__new">+ New Category</option></select>';
  h+='<button onclick="(function(){const url=document.getElementById(\'qb-url\').value.trim();if(!url)return;let title=document.getElementById(\'qb-title\').value.trim();const sel=document.getElementById(\'qb-cat\');let cat=sel.value;if(cat===\'__new\'){cat=prompt(\'Category name:\');if(!cat)return;}if(!title){try{title=new URL(url).hostname.replace(\'www.\',\'\');}catch(e){title=url;}}if(!S.links)S.links=[];S.links.unshift({id:\'l_\'+Date.now(),url:url,title:title,category:cat,tags:[],created:new Date().toISOString()});save();document.getElementById(\'quick-bookmark-panel\').remove();if(typeof showNotification===\'function\')showNotification(\'Bookmark saved!\');})()" style="width:100%;padding:8px;background:var(--accent);color:#000;border:none;border-radius:4px;cursor:pointer;font-weight:600;font-size:12px">Save Bookmark</button>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const u=document.getElementById('qb-url');if(u)u.focus();},100);
}
function showTaskCalendarHeatmap(){
  let panel=document.getElementById('task-heatmap-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-heatmap-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:80vh;overflow-y:auto';
  const tasks=S.tasks||[];
  const dayMap={};
  tasks.forEach(t=>{
    if(t.status==='done'&&t.completedAt){const d=t.completedAt.split('T')[0];dayMap[d]=(dayMap[d]||0)+1;}
    else if(t.status==='done'&&t.created){const d=(typeof t.created==='string'?t.created:'').split('T')[0];if(d)dayMap[d]=(dayMap[d]||0)+1;}
  });
  const today=new Date();
  const weeks=26;const totalDays=weeks*7;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Completion Heatmap</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Last '+weeks+' weeks of task completions (GitHub-style)</div>';
  h+='<div style="display:flex;gap:2px;flex-wrap:wrap">';
  for(let w=weeks-1;w>=0;w--){
    h+='<div style="display:flex;flex-direction:column;gap:2px">';
    for(let d=0;d<7;d++){
      const date=new Date(today);date.setDate(today.getDate()-w*7-((today.getDay()+7-d)%7));
      const dk=date.toISOString().split('T')[0];
      const count=dayMap[dk]||0;
      const intensity=count===0?'var(--bg-surface)':count<=1?'rgba(74,222,128,0.2)':count<=3?'rgba(74,222,128,0.4)':count<=5?'rgba(74,222,128,0.6)':'rgba(74,222,128,0.9)';
      h+='<div title="'+dk+': '+count+' tasks" style="width:12px;height:12px;border-radius:2px;background:'+intensity+'"></div>';
    }
    h+='</div>';
  }
  h+='</div>';
  const totalDone=Object.values(dayMap).reduce((s,v)=>s+v,0);
  const activeDays=Object.keys(dayMap).length;
  h+='<div style="display:flex;gap:20px;margin-top:12px;font-size:11px;color:var(--text-muted)">';
  h+='<span>Total completed: <strong style="color:var(--accent)">'+totalDone+'</strong></span>';
  h+='<span>Active days: <strong style="color:var(--accent)">'+activeDays+'</strong></span>';
  h+='<span>Avg/active day: <strong style="color:var(--accent)">'+(activeDays>0?(totalDone/activeDays).toFixed(1):'0')+'</strong></span></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWriterGoals(){
  let panel=document.getElementById('writer-goals-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='writer-goals-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._writerGoals)S._writerGoals={daily:500,weekly:3000,monthly:12000};
  const docs=S.writerDocs||[];
  const totalWords=docs.reduce((s,d)=>(s+(d.content||'').split(/\s+/).filter(w=>w).length),0);
  const todayKey=new Date().toISOString().split('T')[0];
  const todayWords=(S._dailyWordCounts||{})[todayKey]||0;
  const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  let weekWords=0;for(let i=0;i<7;i++){const d=new Date(weekStart);d.setDate(weekStart.getDate()+i);const k=d.toISOString().split('T')[0];weekWords+=(S._dailyWordCounts||{})[k]||0;}
  const monthKey=new Date().toISOString().substring(0,7);
  let monthWords=0;Object.entries(S._dailyWordCounts||{}).forEach(([k,v])=>{if(k.startsWith(monthKey))monthWords+=v;});
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Writer Goals</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  const goals=[
    {label:'Daily',current:todayWords,target:S._writerGoals.daily,key:'daily'},
    {label:'Weekly',current:weekWords,target:S._writerGoals.weekly,key:'weekly'},
    {label:'Monthly',current:monthWords,target:S._writerGoals.monthly,key:'monthly'}
  ];
  goals.forEach(g=>{
    const pct=Math.min(100,Math.round(g.current/g.target*100));
    const color=pct>=100?'#4ade80':pct>=50?'#f97316':'#ef4444';
    h+='<div style="padding:14px;border:1px solid var(--border);border-radius:8px;margin-bottom:10px">';
    h+='<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;font-weight:600">'+g.label+' Goal</span><span style="font-size:11px;color:var(--text-muted)">'+g.current.toLocaleString()+' / '+g.target.toLocaleString()+' words</span></div>';
    h+='<div style="height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden;margin-bottom:6px"><div style="height:100%;background:'+color+';width:'+pct+'%;border-radius:4px;transition:width 0.3s"></div></div>';
    h+='<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted)"><span>'+pct+'%</span>';
    h+='<input type="number" value="'+g.target+'" onchange="S._writerGoals.'+g.key+'=parseInt(this.value)||0;save();showWriterGoals();" style="width:80px;padding:2px 4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:10px;text-align:right"></div></div>';
  });
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;margin-top:8px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">All-Time Stats</div>';
  h+='<div style="font-size:12px">Total words across '+docs.length+' docs: <strong style="color:var(--accent)">'+totalWords.toLocaleString()+'</strong></div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectHealth(){
  let panel=document.getElementById('project-health-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='project-health-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=S.projects||[];
  const tasks=S.tasks||[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Project Health Dashboard</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  if(projects.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No projects found.</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  projects.forEach(p=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id);
    const total=pTasks.length;const done=pTasks.filter(t=>t.status==='done').length;
    const inProg=pTasks.filter(t=>t.status==='in-progress').length;
    const blocked=pTasks.filter(t=>t.status==='blocked').length;
    const overdue=pTasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length;
    const pct=total>0?Math.round(done/total*100):0;
    let health='healthy';let healthColor='#4ade80';
    if(overdue>2||blocked>2){health='at risk';healthColor='#f97316';}
    if(overdue>5||blocked>5||(total>0&&pct<10)){health='critical';healthColor='#ef4444';}
    if(total===0){health='empty';healthColor='#6b7280';}
    h+='<div style="padding:14px;border:1px solid var(--border);border-radius:8px;margin-bottom:10px">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600">'+esc(p.name)+'</span><span style="padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;background:'+healthColor+'22;color:'+healthColor+'">'+health.toUpperCase()+'</span></div>';
    if(total>0){
      h+='<div style="height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden;margin-bottom:8px"><div style="height:100%;background:var(--accent);width:'+pct+'%;border-radius:3px"></div></div>';
      h+='<div style="display:flex;gap:16px;font-size:10px;color:var(--text-muted)">';
      h+='<span>Done: <strong style="color:var(--accent)">'+done+'</strong></span>';
      h+='<span>In Progress: <strong>'+inProg+'</strong></span>';
      h+='<span>Blocked: <strong style="color:#ef4444">'+blocked+'</strong></span>';
      h+='<span>Overdue: <strong style="color:#f97316">'+overdue+'</strong></span>';
      h+='<span>Total: <strong>'+total+'</strong></span></div>';
    }else{h+='<div style="font-size:10px;color:var(--text-muted)">No tasks assigned</div>';}
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMindDump(){
  let panel=document.getElementById('mind-dump-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='mind-dump-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._mindDumps)S._mindDumps=[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Mind Dump</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Dump everything on your mind. Sort later.</div>';
  h+='<textarea id="mind-dump-input" placeholder="Just type... no structure needed. Hit Save when done." style="width:100%;height:120px;padding:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:12px;font-family:inherit;resize:vertical;box-sizing:border-box;margin-bottom:8px"></textarea>';
  h+='<div style="display:flex;gap:6px;margin-bottom:16px">';
  h+='<button onclick="(function(){const t=document.getElementById(\'mind-dump-input\').value.trim();if(!t)return;S._mindDumps.unshift({id:Date.now(),text:t,date:new Date().toISOString(),processed:false});save();showMindDump();})()" style="background:var(--accent);color:#000;border:none;padding:6px 14px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600">Save Dump</button>';
  h+='<button onclick="(function(){const t=document.getElementById(\'mind-dump-input\').value.trim();if(!t)return;const lines=t.split(\'\\n\').filter(l=>l.trim());lines.forEach(l=>{if(!S.tasks)S.tasks=[];S.tasks.push({id:\'t_\'+Date.now()+Math.random().toString(36).substr(2,4),title:l.trim(),status:\'todo\',priority:\'p2\',projectId:null,tags:[],created:new Date().toISOString()});});save();showMindDump();if(typeof showNotification===\'function\')showNotification(lines.length+\' tasks created\');})()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:6px 14px;border-radius:4px;cursor:pointer;font-size:11px">Lines to Tasks</button></div>';
  if(S._mindDumps.length>0){
    h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Previous Dumps ('+S._mindDumps.length+')</h4>';
    S._mindDumps.slice(0,15).forEach(d=>{
      const ago=Math.round((Date.now()-new Date(d.date).getTime())/(1000*60*60));
      const timeStr=ago<1?'just now':ago<24?ago+'h ago':Math.round(ago/24)+'d ago';
      h+='<div style="padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px'+(d.processed?';opacity:0.5':'')+'">';
      h+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:10px;color:var(--text-muted)">'+timeStr+'</span><div>';
      h+='<button onclick="(function(){const d=S._mindDumps.find(x=>x.id==='+d.id+');if(d)d.processed=!d.processed;save();showMindDump();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px">'+(d.processed?'Unprocess':'Processed')+'</button>';
      h+='<button onclick="(function(){S._mindDumps=S._mindDumps.filter(x=>x.id!=='+d.id+');save();showMindDump();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px">X</button></div></div>';
      h+='<div style="font-size:11px;white-space:pre-wrap;line-height:1.5">'+esc(d.text.substring(0,300))+(d.text.length>300?'...':'')+'</div></div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const i=document.getElementById('mind-dump-input');if(i)i.focus();},100);
}
function showProjectMilestones(){
  let panel=document.getElementById('project-milestones-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='project-milestones-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._milestones)S._milestones=[];
  const projects=S.projects||[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Project Milestones</h3><div><button onclick="(function(){const pName=prompt(\'Project (or leave blank for global):\');const title=prompt(\'Milestone title:\');if(!title)return;const due=prompt(\'Due date (YYYY-MM-DD):\');S._milestones.push({id:Date.now(),title:title,project:pName||\'Global\',due:due||null,done:false,created:new Date().toISOString()});save();showProjectMilestones();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">+ Milestone</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  const grouped={};
  S._milestones.forEach(m=>{const p=m.project||'Global';if(!grouped[p])grouped[p]=[];grouped[p].push(m);});
  if(Object.keys(grouped).length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No milestones set. Add your first milestone.</div>';}
  Object.entries(grouped).forEach(([proj,milestones])=>{
    h+='<h4 style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">'+esc(proj)+'</h4>';
    milestones.sort((a,b)=>(a.due||'9999').localeCompare(b.due||'9999')).forEach(m=>{
      const isOverdue=m.due&&!m.done&&new Date(m.due)<new Date();
      h+='<div style="display:flex;align-items:center;gap:10px;padding:10px;border:1px solid '+(isOverdue?'#ef4444':'var(--border)')+';border-radius:8px;margin-bottom:6px'+(m.done?';opacity:0.5':'')+'">';
      h+='<button onclick="(function(){const m=S._milestones.find(x=>x.id==='+m.id+');if(m)m.done=!m.done;save();showProjectMilestones();})()" style="width:20px;height:20px;border-radius:4px;border:2px solid '+(m.done?'var(--accent)':'var(--border)')+';background:'+(m.done?'var(--accent)':'transparent')+';cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#000;font-size:9px">'+(m.done?'V':'')+'</button>';
      h+='<div style="flex:1"><div style="font-size:12px;'+(m.done?'text-decoration:line-through':'')+'">'+(isOverdue?'<span style="color:#ef4444;font-size:9px;margin-right:4px">OVERDUE</span>':'')+esc(m.title)+'</div>';
      if(m.due)h+='<div style="font-size:10px;color:var(--text-muted)">Due: '+m.due+'</div>';
      h+='</div>';
      h+='<button onclick="(function(){S._milestones=S._milestones.filter(x=>x.id!=='+m.id+');save();showProjectMilestones();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">X</button></div>';
    });
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showLinkHealth(){
  let panel=document.getElementById('link-health-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='link-health-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const links=S.links||[];
  const domainCount={};const catCount={};let noTitle=0;let noCat=0;let dupes=0;
  const urlSet=new Set();
  links.forEach(l=>{
    try{const d=new URL(l.url).hostname.replace('www.','');domainCount[d]=(domainCount[d]||0)+1;}catch(e){}
    const c=l.category||'uncategorized';catCount[c]=(catCount[c]||0)+1;
    if(!l.title||l.title.trim()==='')noTitle++;
    if(!l.category||l.category==='uncategorized')noCat++;
    if(urlSet.has(l.url))dupes++;urlSet.add(l.url);
  });
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Link Health Report</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  let score=100;
  if(noTitle>0)score-=Math.min(20,noTitle*2);
  if(noCat>0)score-=Math.min(20,noCat*2);
  if(dupes>0)score-=Math.min(20,dupes*5);
  score=Math.max(0,score);
  const scoreColor=score>=80?'#4ade80':score>=50?'#f97316':'#ef4444';
  h+='<div style="text-align:center;padding:16px;margin-bottom:16px"><div style="font-size:40px;font-weight:bold;color:'+scoreColor+'">'+score+'</div><div style="font-size:11px;color:var(--text-muted)">Link Health Score / 100</div></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px">';
  h+='<div style="padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:bold">'+links.length+'</div><div style="font-size:10px;color:var(--text-muted)">Total Links</div></div>';
  h+='<div style="padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:bold">'+Object.keys(domainCount).length+'</div><div style="font-size:10px;color:var(--text-muted)">Unique Domains</div></div>';
  h+='<div style="padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:bold;color:'+(noTitle>0?'#f97316':'var(--accent)')+'">'+noTitle+'</div><div style="font-size:10px;color:var(--text-muted)">Missing Titles</div></div>';
  h+='<div style="padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:bold;color:'+(dupes>0?'#ef4444':'var(--accent)')+'">'+dupes+'</div><div style="font-size:10px;color:var(--text-muted)">Duplicates</div></div></div>';
  h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Issues</h4>';
  const issues=[];
  if(noTitle>0)issues.push({icon:'!',text:noTitle+' links have no title. Add titles for better searchability.',severity:'warn'});
  if(noCat>0)issues.push({icon:'C',text:noCat+' links are uncategorized. Organize them into categories.',severity:'warn'});
  if(dupes>0)issues.push({icon:'D',text:dupes+' duplicate URLs detected. Consider removing duplicates.',severity:'error'});
  if(issues.length===0)issues.push({icon:'V',text:'All links look healthy!',severity:'ok'});
  issues.forEach(i=>{
    const col=i.severity==='error'?'#ef4444':i.severity==='warn'?'#f97316':'var(--accent)';
    h+='<div style="padding:8px;border-left:3px solid '+col+';background:var(--bg-surface);border-radius:0 6px 6px 0;margin-bottom:6px;font-size:11px">'+esc(i.text)+'</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDailyJournal(){
  let panel=document.getElementById('daily-journal-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='daily-journal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._journal)S._journal=[];
  const todayKey=new Date().toISOString().split('T')[0];
  let todayEntry=S._journal.find(j=>j.date===todayKey);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Daily Journal</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">'+todayKey+'</div>';
  h+='<div style="margin-bottom:12px"><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">How are you feeling? (1-5)</label>';
  h+='<div style="display:flex;gap:6px">';
  for(let i=1;i<=5;i++){
    const selected=todayEntry&&todayEntry.mood===i;
    h+='<button onclick="(function(){let e=S._journal.find(j=>j.date===\''+todayKey+'\');if(!e){e={date:\''+todayKey+'\',mood:0,text:\'\',gratitude:\'\'};S._journal.unshift(e);}e.mood='+i+';save();showDailyJournal();})()" style="width:32px;height:32px;border-radius:50%;border:2px solid '+(selected?'var(--accent)':'var(--border)')+';background:'+(selected?'var(--accent)':'transparent')+';color:'+(selected?'#000':'var(--text-primary)')+';cursor:pointer;font-size:12px;font-weight:bold">'+i+'</button>';
  }
  h+='</div></div>';
  h+='<div style="margin-bottom:12px"><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">What happened today?</label>';
  h+='<textarea id="journal-text" style="width:100%;height:100px;padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;font-family:inherit;resize:vertical;box-sizing:border-box">'+(todayEntry?esc(todayEntry.text):'')+'</textarea></div>';
  h+='<div style="margin-bottom:12px"><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">Gratitude (what went well?)</label>';
  h+='<textarea id="journal-gratitude" style="width:100%;height:60px;padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;font-family:inherit;resize:vertical;box-sizing:border-box">'+(todayEntry?esc(todayEntry.gratitude||''):'')+'</textarea></div>';
  h+='<button onclick="(function(){let e=S._journal.find(j=>j.date===\''+todayKey+'\');if(!e){e={date:\''+todayKey+'\',mood:0,text:\'\',gratitude:\'\'};S._journal.unshift(e);}e.text=document.getElementById(\'journal-text\').value;e.gratitude=document.getElementById(\'journal-gratitude\').value;save();if(typeof showNotification===\'function\')showNotification(\'Journal saved\');})()" style="background:var(--accent);color:#000;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;margin-bottom:16px">Save Entry</button>';
  const past=S._journal.filter(j=>j.date!==todayKey).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);
  if(past.length>0){
    h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Previous Entries</h4>';
    past.forEach(j=>{
      const moodColors=['','#ef4444','#f97316','#eab308','#22d3ee','#4ade80'];
      h+='<div style="padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px">';
      h+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:11px;color:var(--text-muted)">'+j.date+'</span>'+(j.mood?'<span style="font-size:11px;color:'+(moodColors[j.mood]||'var(--text-muted)')+'">Mood: '+j.mood+'/5</span>':'')+'</div>';
      if(j.text)h+='<div style="font-size:11px;line-height:1.4">'+esc(j.text.substring(0,150))+(j.text.length>150?'...':'')+'</div>';
      h+='</div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectBurndown(){
  let panel=document.getElementById('project-burndown-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='project-burndown-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=S.projects||[];const tasks=S.tasks||[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Project Burndown</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  if(projects.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No projects found.</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  projects.forEach(p=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id);
    const total=pTasks.length;const done=pTasks.filter(t=>t.status==='done').length;
    const remaining=total-done;
    const pct=total>0?Math.round(done/total*100):0;
    // Simple burndown: show stacked bars
    h+='<div style="padding:14px;border:1px solid var(--border);border-radius:8px;margin-bottom:10px">';
    h+='<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-size:13px;font-weight:600">'+esc(p.name)+'</span><span style="font-size:11px;color:var(--accent)">'+pct+'%</span></div>';
    h+='<div style="display:flex;height:24px;border-radius:4px;overflow:hidden;margin-bottom:8px">';
    if(done>0)h+='<div style="background:var(--accent);width:'+(done/total*100)+'%;display:flex;align-items:center;justify-content:center;font-size:9px;color:#000;font-weight:bold">'+done+'</div>';
    const inProg=pTasks.filter(t=>t.status==='in-progress').length;
    if(inProg>0)h+='<div style="background:#f97316;width:'+(inProg/total*100)+'%;display:flex;align-items:center;justify-content:center;font-size:9px;color:#000;font-weight:bold">'+inProg+'</div>';
    const todo=pTasks.filter(t=>t.status==='todo').length;
    if(todo>0)h+='<div style="background:var(--bg-surface);width:'+(todo/total*100)+'%;display:flex;align-items:center;justify-content:center;font-size:9px;color:var(--text-muted)">'+todo+'</div>';
    const other=remaining-inProg-todo;
    if(other>0)h+='<div style="background:var(--bg-surface);width:'+(other/total*100)+'%"></div>';
    h+='</div>';
    h+='<div style="display:flex;gap:12px;font-size:10px;color:var(--text-muted)">';
    h+='<span><span style="display:inline-block;width:8px;height:8px;background:var(--accent);border-radius:2px;margin-right:4px"></span>Done ('+done+')</span>';
    h+='<span><span style="display:inline-block;width:8px;height:8px;background:#f97316;border-radius:2px;margin-right:4px"></span>In Progress ('+inProg+')</span>';
    h+='<span><span style="display:inline-block;width:8px;height:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:2px;margin-right:4px"></span>Todo ('+todo+')</span></div>';
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickTimer(){
  let panel=document.getElementById('quick-timer-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-timer-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  const presets=[5,10,15,25,45,60];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:var(--accent);font-size:13px">Quick Timer</h4><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<div id="qt-display" style="text-align:center;font-size:36px;font-weight:bold;color:var(--text-primary);margin-bottom:12px;font-variant-numeric:tabular-nums">00:00</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;justify-content:center">';
  presets.forEach(m=>{
    h+='<button onclick="(function(){window._qtMinutes='+m+';window._qtSeconds='+m+'*60;document.getElementById(\'qt-display\').textContent=String('+m+').padStart(2,\'0\')+\':00\';})()" style="padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);cursor:pointer;font-size:11px">'+m+'m</button>';
  });
  h+='</div>';
  h+='<div style="display:flex;gap:6px;justify-content:center">';
  h+='<button onclick="(function(){if(window._qtInterval)return;if(!window._qtSeconds)window._qtSeconds=25*60;window._qtInterval=setInterval(function(){window._qtSeconds--;if(window._qtSeconds<=0){clearInterval(window._qtInterval);window._qtInterval=null;document.getElementById(\'qt-display\').textContent=\'DONE\';document.getElementById(\'qt-display\').style.color=\'var(--accent)\';return;}const m=Math.floor(window._qtSeconds/60);const s=window._qtSeconds%60;document.getElementById(\'qt-display\').textContent=String(m).padStart(2,\'0\')+\':\'+String(s).padStart(2,\'0\');},1000);})()" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600">Start</button>';
  h+='<button onclick="(function(){if(window._qtInterval){clearInterval(window._qtInterval);window._qtInterval=null;}})()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:11px">Pause</button>';
  h+='<button onclick="(function(){if(window._qtInterval){clearInterval(window._qtInterval);window._qtInterval=null;}window._qtSeconds=0;document.getElementById(\'qt-display\').textContent=\'00:00\';document.getElementById(\'qt-display\').style.color=\'var(--text-primary)\';})()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:11px">Reset</button></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentDuplicates(){
  let panel=document.getElementById('content-dupes-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-dupes-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=S.content||[];
  const dupes=[];
  for(let i=0;i<content.length;i++){
    for(let j=i+1;j<content.length;j++){
      const a=content[i].title.toLowerCase().trim();
      const b=content[j].title.toLowerCase().trim();
      if(a===b||(a.length>5&&b.length>5&&(a.includes(b)||b.includes(a)))){
        dupes.push({a:content[i],b:content[j],reason:'similar title'});
      }else{
        const bodyA=(content[i].body||'').substring(0,200).toLowerCase();
        const bodyB=(content[j].body||'').substring(0,200).toLowerCase();
        if(bodyA.length>50&&bodyB.length>50&&bodyA===bodyB){
          dupes.push({a:content[i],b:content[j],reason:'identical body'});
        }
      }
    }
  }
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Content Duplicate Finder</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Scanned '+content.length+' items. Found '+dupes.length+' potential duplicates.</div>';
  if(dupes.length===0){h+='<div style="color:var(--accent);text-align:center;padding:30px 0">No duplicates found. Your content is clean!</div>';}
  dupes.forEach(d=>{
    h+='<div style="padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px">';
    h+='<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase">'+esc(d.reason)+'</div>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    [d.a,d.b].forEach(item=>{
      h+='<div style="padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:11px;font-weight:600;margin-bottom:4px">'+esc(item.title)+'</div>';
      h+='<div style="font-size:10px;color:var(--text-muted)">'+((item.body||'').split(/\s+/).filter(w=>w).length)+' words</div>';
      h+='<button onclick="(function(){if(!confirm(\'Delete: '+esc(item.title).replace(/'/g,"\\'")+' ?\'))return;S.content=S.content.filter(c=>c.id!==\''+item.id+'\');save();showContentDuplicates();})()" style="background:none;border:1px solid #ef4444;color:#ef4444;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:9px;margin-top:4px">Delete</button></div>';
    });
    h+='</div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskPriorityReport(){
  let panel=document.getElementById('priority-report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='priority-report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=S.tasks||[];
  const active=tasks.filter(t=>t.status!=='done');
  const done=tasks.filter(t=>t.status==='done');
  const priorities=['p0','p1','p2','p3'];
  const colors={'p0':'#ef4444','p1':'#f97316','p2':'#3b82f6','p3':'#6b7280'};
  const labels={'p0':'Critical','p1':'High','p2':'Medium','p3':'Low'};
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Priority Report</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  // Active by priority
  h+='<h4 style="margin:0 0 10px;font-size:12px;color:var(--text-muted)">Active Tasks by Priority</h4>';
  const maxCount=Math.max(...priorities.map(p=>active.filter(t=>(t.priority||'p3')===p).length),1);
  priorities.forEach(p=>{
    const count=active.filter(t=>(t.priority||'p3')===p).length;
    const pct=Math.round(count/maxCount*100);
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    h+='<span style="font-size:11px;width:70px;color:'+colors[p]+';font-weight:600">'+labels[p]+'</span>';
    h+='<div style="flex:1;height:20px;background:var(--bg-surface);border-radius:4px;overflow:hidden"><div style="height:100%;background:'+colors[p]+';width:'+pct+'%;border-radius:4px;display:flex;align-items:center;padding-left:6px;font-size:10px;color:#fff;font-weight:bold">'+(count>0?count:'')+'</div></div>';
    h+='<span style="font-size:11px;color:var(--text-muted);width:30px;text-align:right">'+count+'</span></div>';
  });
  // Completion rate by priority
  h+='<h4 style="margin:16px 0 10px;font-size:12px;color:var(--text-muted)">Completion Rate by Priority</h4>';
  priorities.forEach(p=>{
    const all=tasks.filter(t=>(t.priority||'p3')===p).length;
    const completed=done.filter(t=>(t.priority||'p3')===p).length;
    const rate=all>0?Math.round(completed/all*100):0;
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    h+='<span style="font-size:11px;width:70px;color:'+colors[p]+'">'+labels[p]+'</span>';
    h+='<div style="flex:1;height:14px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:'+colors[p]+';width:'+rate+'%;opacity:0.7"></div></div>';
    h+='<span style="font-size:10px;color:var(--text-muted);width:40px;text-align:right">'+rate+'%</span></div>';
  });
  // Summary
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;margin-top:16px;display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:11px">';
  h+='<div>Total tasks: <strong>'+tasks.length+'</strong></div>';
  h+='<div>Active: <strong>'+active.length+'</strong></div>';
  h+='<div>Completed: <strong>'+done.length+'</strong></div>';
  h+='<div>Completion: <strong style="color:var(--accent)">'+(tasks.length>0?Math.round(done.length/tasks.length*100):0)+'%</strong></div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickEmbed(){
  let panel=document.getElementById('quick-embed-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-embed-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._embeds)S._embeds=[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Quick Embed</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Save embeddable URLs (YouTube, tweets, Figma, etc.) for quick access.</div>';
  h+='<input id="qe-url" placeholder="Paste URL (YouTube, Twitter, Figma...)" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:8px;box-sizing:border-box">';
  h+='<input id="qe-label" placeholder="Label (optional)" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:8px;box-sizing:border-box">';
  h+='<button onclick="(function(){const url=document.getElementById(\'qe-url\').value.trim();if(!url)return;const label=document.getElementById(\'qe-label\').value.trim()||url;S._embeds.unshift({id:Date.now(),url:url,label:label,created:new Date().toISOString()});save();showQuickEmbed();})()" style="background:var(--accent);color:#000;border:none;padding:6px 14px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;margin-bottom:16px">Save Embed</button>';
  if(S._embeds.length>0){
    h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Saved Embeds ('+S._embeds.length+')</h4>';
    S._embeds.forEach(e=>{
      let type='link';
      if(e.url.includes('youtube.com')||e.url.includes('youtu.be'))type='youtube';
      else if(e.url.includes('twitter.com')||e.url.includes('x.com'))type='tweet';
      else if(e.url.includes('figma.com'))type='figma';
      else if(e.url.includes('github.com'))type='github';
      h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid var(--border);border-radius:6px;margin-bottom:4px">';
      h+='<div><span style="font-size:9px;color:var(--accent);text-transform:uppercase;margin-right:6px">'+type+'</span><a href="'+esc(e.url)+'" target="_blank" style="font-size:11px;color:var(--text-primary);text-decoration:none">'+esc(e.label)+'</a></div>';
      h+='<button onclick="(function(){S._embeds=S._embeds.filter(x=>x.id!=='+e.id+');save();showQuickEmbed();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">X</button></div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWorkspaceCleanup(){
  let panel=document.getElementById('workspace-cleanup-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='workspace-cleanup-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];const docs=S.writerDocs||[];
  const issues=[];
  // Stale tasks
  const staleTasks=tasks.filter(t=>{if(t.status==='done')return false;const created=t.created?new Date(t.created):new Date();return(Date.now()-created.getTime())>(60*24*60*60*1000);});
  if(staleTasks.length>0)issues.push({type:'warning',text:staleTasks.length+' tasks older than 60 days and not done',action:'Archive stale tasks',fn:'(function(){S.tasks.forEach(t=>{const created=t.created?new Date(t.created):new Date();if(t.status!=="done"&&(Date.now()-created.getTime())>(60*24*60*60*1000))t.status="done";});save();showWorkspaceCleanup();})()'});
  // Empty content
  const emptyContent=content.filter(c=>!c.body||c.body.trim().length<10);
  if(emptyContent.length>0)issues.push({type:'info',text:emptyContent.length+' content items with nearly empty body',action:'Delete empty content',fn:'(function(){S.content=S.content.filter(c=>c.body&&c.body.trim().length>=10);save();showWorkspaceCleanup();})()'});
  // Untitled items
  const untitled=content.filter(c=>!c.title||c.title.trim()==='Untitled'||c.title.trim()==='');
  if(untitled.length>0)issues.push({type:'info',text:untitled.length+' content items with no title',action:null,fn:null});
  // Empty docs
  const emptyDocs=docs.filter(d=>!d.content||d.content.trim().length<20);
  if(emptyDocs.length>0)issues.push({type:'info',text:emptyDocs.length+' writer docs with nearly empty content',action:'Delete empty docs',fn:'(function(){S.writerDocs=S.writerDocs.filter(d=>d.content&&d.content.trim().length>=20);save();showWorkspaceCleanup();})()'});
  // Broken links (no URL)
  const brokenLinks=links.filter(l=>!l.url||l.url.trim()==='');
  if(brokenLinks.length>0)issues.push({type:'error',text:brokenLinks.length+' links with no URL',action:'Delete broken links',fn:'(function(){S.links=S.links.filter(l=>l.url&&l.url.trim()!=="");save();showWorkspaceCleanup();})()'});
  // Storage usage
  const storageBytes=JSON.stringify(S).length;
  const storageMB=(storageBytes/(1024*1024)).toFixed(2);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Workspace Cleanup</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;margin-bottom:16px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Storage: '+storageMB+' MB</div><div style="height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden"><div style="height:100%;background:var(--accent);width:'+Math.min(100,storageBytes/5000000*100)+'%"></div></div></div>';
  if(issues.length===0){h+='<div style="color:var(--accent);text-align:center;padding:30px 0">Workspace is clean! No issues found.</div>';}
  issues.forEach(i=>{
    const col=i.type==='error'?'#ef4444':i.type==='warning'?'#f97316':'var(--accent)';
    h+='<div style="padding:10px;border-left:3px solid '+col+';background:var(--bg-surface);border-radius:0 8px 8px 0;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">';
    h+='<span style="font-size:11px">'+esc(i.text)+'</span>';
    if(i.action)h+='<button onclick="'+i.fn+'" style="background:none;border:1px solid '+col+';color:'+col+';padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px;white-space:nowrap;margin-left:8px">'+esc(i.action)+'</button>';
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskBatchEdit(){
  let panel=document.getElementById('task-batch-edit-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-batch-edit-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Batch Editor</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">'+tasks.length+' active tasks. Use checkboxes to select, then apply bulk actions.</div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">';
  h+='<button onclick="(function(){const checked=document.querySelectorAll(\'.tbe-cb:checked\');const ids=Array.from(checked).map(c=>c.dataset.id);if(!ids.length)return;ids.forEach(id=>{const t=S.tasks.find(x=>x.id===id);if(t)t.priority=\'p0\';});save();showTaskBatchEdit();})()" style="padding:4px 8px;background:none;border:1px solid #ef4444;color:#ef4444;border-radius:4px;cursor:pointer;font-size:10px">Set P0</button>';
  h+='<button onclick="(function(){const checked=document.querySelectorAll(\'.tbe-cb:checked\');const ids=Array.from(checked).map(c=>c.dataset.id);if(!ids.length)return;ids.forEach(id=>{const t=S.tasks.find(x=>x.id===id);if(t)t.priority=\'p1\';});save();showTaskBatchEdit();})()" style="padding:4px 8px;background:none;border:1px solid #f97316;color:#f97316;border-radius:4px;cursor:pointer;font-size:10px">Set P1</button>';
  h+='<button onclick="(function(){const checked=document.querySelectorAll(\'.tbe-cb:checked\');const ids=Array.from(checked).map(c=>c.dataset.id);if(!ids.length)return;ids.forEach(id=>{const t=S.tasks.find(x=>x.id===id);if(t)t.status=\'done\';});save();showTaskBatchEdit();})()" style="padding:4px 8px;background:none;border:1px solid var(--accent);color:var(--accent);border-radius:4px;cursor:pointer;font-size:10px">Mark Done</button>';
  h+='<button onclick="(function(){const checked=document.querySelectorAll(\'.tbe-cb:checked\');const ids=Array.from(checked).map(c=>c.dataset.id);if(!ids.length||!confirm(\'Delete \'+ids.length+\' tasks?\'))return;S.tasks=S.tasks.filter(t=>!ids.includes(t.id));save();showTaskBatchEdit();})()" style="padding:4px 8px;background:none;border:1px solid #ef4444;color:#ef4444;border-radius:4px;cursor:pointer;font-size:10px">Delete</button>';
  h+='<button onclick="document.querySelectorAll(\'.tbe-cb\').forEach(c=>c.checked=!c.checked)" style="padding:4px 8px;background:none;border:1px solid var(--border);color:var(--text-muted);border-radius:4px;cursor:pointer;font-size:10px">Toggle All</button></div>';
  tasks.slice(0,40).forEach(t=>{
    const color=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':t.priority==='p2'?'#3b82f6':'#6b7280';
    h+='<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">';
    h+='<input type="checkbox" class="tbe-cb" data-id="'+t.id+'" style="accent-color:var(--accent)">';
    h+='<span style="color:'+color+';font-size:10px;width:25px">'+esc((t.priority||'p3').toUpperCase())+'</span>';
    h+='<span style="font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(t.title)+'</span>';
    h+='<span style="font-size:9px;color:var(--text-muted)">'+esc(t.status)+'</span></div>';
  });
  if(tasks.length>40)h+='<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:8px 0">Showing 40 of '+tasks.length+'</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDocVersionCompare(){
  let panel=document.getElementById('doc-version-compare-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='doc-version-compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow-y:auto';
  const docs=S.writerDocs||[];
  const docsWithVersions=docs.filter(d=>d.versions&&d.versions.length>0);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Doc Version Compare</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  if(docsWithVersions.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No documents with version history found.</div>';panel.innerHTML=h;document.body.appendChild(panel);return;}
  docsWithVersions.forEach(doc=>{
    const currentWords=(doc.content||'').split(/\s+/).filter(w=>w).length;
    h+='<div style="padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:10px">';
    h+='<div style="font-size:13px;font-weight:600;margin-bottom:8px">'+esc(doc.title)+' <span style="color:var(--text-muted);font-weight:400;font-size:11px">('+currentWords+' words, '+doc.versions.length+' versions)</span></div>';
    doc.versions.slice(-5).reverse().forEach((v,i)=>{
      const vWords=(v.content||'').split(/\s+/).filter(w=>w).length;
      const diff=currentWords-vWords;
      const diffStr=diff>0?'+'+diff:diff<0?''+diff:'0';
      const diffColor=diff>0?'#4ade80':diff<0?'#ef4444':'var(--text-muted)';
      h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid var(--border);font-size:11px">';
      h+='<span style="color:var(--text-muted)">v'+(doc.versions.length-i)+'</span>';
      h+='<span>'+vWords+' words</span>';
      h+='<span style="color:'+diffColor+'">'+diffStr+' vs current</span>';
      h+='<span style="color:var(--text-muted);font-size:9px">'+(v.date||'').split('T')[0]+'</span></div>';
    });
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showFocusModePanel(){
  let panel=document.getElementById('focus-mode-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='focus-mode-panel';
  panel.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;z-index:2000;background:#050508;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&(t.priority==='p0'||t.priority==='p1'));
  const topTask=tasks[0];
  let h='<div style="text-align:center;max-width:500px">';
  h+='<div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:3px;margin-bottom:24px">Focus Mode</div>';
  if(topTask){
    const color=topTask.priority==='p0'?'#ef4444':'#f97316';
    h+='<div style="font-size:10px;color:'+color+';margin-bottom:8px">'+esc(topTask.priority.toUpperCase())+' PRIORITY</div>';
    h+='<div style="font-size:24px;font-weight:bold;color:var(--text-primary);margin-bottom:12px;line-height:1.4">'+esc(topTask.title)+'</div>';
    if(topTask.description)h+='<div style="font-size:13px;color:var(--text-muted);margin-bottom:24px;line-height:1.6">'+esc(topTask.description.substring(0,200))+'</div>';
    if(topTask.subtasks&&topTask.subtasks.length>0){
      const done=topTask.subtasks.filter(s=>s.done).length;
      h+='<div style="margin-bottom:16px"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Subtasks: '+done+'/'+topTask.subtasks.length+'</div>';
      h+='<div style="height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="height:100%;background:var(--accent);width:'+(topTask.subtasks.length>0?done/topTask.subtasks.length*100:0)+'%"></div></div></div>';
    }
    h+='<div style="display:flex;gap:8px;justify-content:center;margin-bottom:24px">';
    h+='<button onclick="(function(){const t=S.tasks.find(x=>x.id===\''+topTask.id+'\');if(t)t.status=\'done\';save();showFocusModePanel();})()" style="background:var(--accent);color:#000;border:none;padding:8px 20px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Complete</button>';
    h+='<button onclick="(function(){const t=S.tasks.find(x=>x.id===\''+topTask.id+'\');if(t)t.status=\'in-progress\';save();showFocusModePanel();})()" style="background:none;border:1px solid var(--border);color:var(--text-primary);padding:8px 20px;border-radius:6px;cursor:pointer;font-size:12px">Start</button></div>';
    if(tasks.length>1){
      h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">Up next ('+Math.min(tasks.length-1,5)+' more):</div>';
      tasks.slice(1,6).forEach(t=>{
        h+='<div style="font-size:11px;color:var(--text-muted);padding:4px 0">'+esc(t.priority.toUpperCase())+' - '+esc(t.title)+'</div>';
      });
    }
  }else{
    h+='<div style="font-size:20px;color:var(--accent);margin-bottom:12px">All clear!</div>';
    h+='<div style="font-size:13px;color:var(--text-muted)">No P0 or P1 tasks remaining. Nice work!</div>';
  }
  h+='<div style="margin-top:32px"><button onclick="document.getElementById(\'focus-mode-panel\').remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:8px 20px;border-radius:6px;cursor:pointer;font-size:11px">Exit Focus Mode (Esc)</button></div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  const handler=e=>{if(e.key==='Escape'){document.getElementById('focus-mode-panel')?.remove();document.removeEventListener('keydown',handler);}};
  document.addEventListener('keydown',handler);
}
function showTaskTimeEstimates(){
  let panel=document.getElementById('time-estimates-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='time-estimates-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  let totalMinutes=0;
  tasks.forEach(t=>{
    if(t.estimate){
      const m=t.estimate.match(/(\d+)\s*(h|m)/i);
      if(m){totalMinutes+=m[2].toLowerCase()==='h'?parseInt(m[1])*60:parseInt(m[1]);}
    }
  });
  const withEst=tasks.filter(t=>t.estimate);
  const withoutEst=tasks.filter(t=>!t.estimate);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Time Estimates</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:var(--accent)">'+Math.floor(totalMinutes/60)+'h '+totalMinutes%60+'m</div><div style="font-size:10px;color:var(--text-muted)">Total Estimated</div></div>';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:var(--accent)">'+withEst.length+'</div><div style="font-size:10px;color:var(--text-muted)">With Estimates</div></div>';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:'+(withoutEst.length>0?'#f97316':'var(--accent)')+'">'+withoutEst.length+'</div><div style="font-size:10px;color:var(--text-muted)">No Estimate</div></div></div>';
  // By priority
  const priorities=['p0','p1','p2','p3'];
  const pColors={'p0':'#ef4444','p1':'#f97316','p2':'#3b82f6','p3':'#6b7280'};
  h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Estimated Time by Priority</h4>';
  priorities.forEach(p=>{
    let mins=0;
    tasks.filter(t=>(t.priority||'p3')===p&&t.estimate).forEach(t=>{
      const m=t.estimate.match(/(\d+)\s*(h|m)/i);
      if(m)mins+=m[2].toLowerCase()==='h'?parseInt(m[1])*60:parseInt(m[1]);
    });
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
    h+='<span style="font-size:11px;width:30px;color:'+pColors[p]+';font-weight:600">'+p.toUpperCase()+'</span>';
    h+='<div style="flex:1;height:16px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:'+pColors[p]+';width:'+(totalMinutes>0?mins/totalMinutes*100:0)+'%"></div></div>';
    h+='<span style="font-size:10px;color:var(--text-muted);width:50px;text-align:right">'+Math.floor(mins/60)+'h '+mins%60+'m</span></div>';
  });
  // Tasks without estimates
  if(withoutEst.length>0){
    h+='<h4 style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">Tasks Missing Estimates</h4>';
    withoutEst.slice(0,10).forEach(t=>{
      h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border);font-size:11px"><span>'+esc(t.title)+'</span>';
      h+='<input placeholder="e.g. 30m, 2h" onchange="(function(v){const t=S.tasks.find(x=>x.id===\''+t.id+'\');if(t)t.estimate=v;save();})(this.value)" style="width:80px;padding:2px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:10px;text-align:right"></div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showGlobalSearch(){
  let panel=document.getElementById('global-search-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='global-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Global Deep Search</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<input id="gs-input" placeholder="Search across everything..." style="width:100%;padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:13px;margin-bottom:12px;box-sizing:border-box" oninput="(function(q){const r=document.getElementById(\'gs-results\');if(!q){r.innerHTML=\'\';return;}q=q.toLowerCase();const results=[];(S.tasks||[]).forEach(t=>{if((t.title||\'\').toLowerCase().includes(q)||(t.description||\'\').toLowerCase().includes(q))results.push({type:\'task\',title:t.title,preview:t.description||\'Status: \'+t.status,section:\'tasks\'});});(S.content||[]).forEach(c=>{if((c.title||\'\').toLowerCase().includes(q)||(c.body||\'\').toLowerCase().includes(q))results.push({type:\'content\',title:c.title,preview:(c.body||\'\').substring(0,100),section:\'content\'});});(S.links||[]).forEach(l=>{if((l.title||\'\').toLowerCase().includes(q)||(l.url||\'\').toLowerCase().includes(q))results.push({type:\'link\',title:l.title||l.url,preview:l.url,section:\'links\'});});(S.writerDocs||[]).forEach(d=>{if((d.title||\'\').toLowerCase().includes(q)||(d.content||\'\').toLowerCase().includes(q))results.push({type:\'doc\',title:d.title,preview:(d.content||\'\').substring(0,100),section:\'writer\'});});const typeColors={task:\'#4ade80\',content:\'#22d3ee\',link:\'#f97316\',doc:\'#a78bfa\'};let html=\'<div style=\"font-size:10px;color:var(--text-muted);margin-bottom:8px\">\'+results.length+\' results</div>\';results.slice(0,20).forEach(item=>{html+=\'<div onclick=\"document.getElementById(\\\\\'global-search-panel\\\\\').remove();switchSection(\\\\\'\'+item.section+\'\\\\\')\" style=\"padding:8px;border-bottom:1px solid var(--border);cursor:pointer\"><div style=\"display:flex;align-items:center;gap:6px\"><span style=\"font-size:9px;color:\'+typeColors[item.type]+\';text-transform:uppercase\">\'+item.type+\'</span><span style=\"font-size:12px\">\'+item.title+\'</span></div><div style=\"font-size:10px;color:var(--text-muted);margin-top:2px\">\'+item.preview+\'</div></div>\';});r.innerHTML=html;})(this.value)">';
  h+='<div id="gs-results"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const i=document.getElementById('gs-input');if(i)i.focus();},100);
}
function showSnippetLibrary(){
  let panel=document.getElementById('snippet-library-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='snippet-library-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._snippets)S._snippets=[
    {id:1,title:'CSS Flexbox Center',lang:'css',code:'display: flex;\nalign-items: center;\njustify-content: center;'},
    {id:2,title:'Fetch JSON',lang:'js',code:'const res = await fetch(url);\nconst data = await res.json();\nreturn data;'},
    {id:3,title:'Array Unique',lang:'js',code:'const unique = [...new Set(arr)];'},
    {id:4,title:'Date Format',lang:'js',code:'new Date().toISOString().split("T")[0]'},
  ];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Snippet Library</h3><div><button onclick="(function(){const title=prompt(\'Snippet title:\');if(!title)return;const lang=prompt(\'Language (js, css, html, py):\',\'js\');const code=prompt(\'Code:\');if(!code)return;S._snippets.push({id:Date.now(),title:title,lang:lang||\'js\',code:code});save();showSnippetLibrary();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">+ Snippet</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  S._snippets.forEach(s=>{
    h+='<div style="padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
    h+='<div><strong style="font-size:12px">'+esc(s.title)+'</strong><span style="font-size:9px;color:var(--accent);margin-left:8px;text-transform:uppercase">'+esc(s.lang)+'</span></div>';
    h+='<div><button onclick="(function(){navigator.clipboard.writeText(S._snippets.find(x=>x.id==='+s.id+').code);if(typeof showNotification===\'function\')showNotification(\'Copied!\');})()" style="background:none;border:1px solid var(--accent);color:var(--accent);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:9px;margin-right:4px">Copy</button>';
    h+='<button onclick="(function(){S._snippets=S._snippets.filter(x=>x.id!=='+s.id+');save();showSnippetLibrary();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">X</button></div></div>';
    h+='<pre style="font-size:11px;color:var(--text-primary);background:var(--bg-surface);padding:8px;border-radius:4px;margin:0;white-space:pre-wrap;font-family:monospace;line-height:1.5;overflow:auto;max-height:120px">'+esc(s.code)+'</pre></div>';
  });
  if(S._snippets.length===0)h+='<div style="color:var(--text-muted);text-align:center;padding:30px 0">No snippets saved yet.</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDailyReport(){
  let panel=document.getElementById('daily-report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='daily-report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  const todayTasks=tasks.filter(t=>t.due===today||((t.created||'').startsWith(today)));
  const doneTasks=tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.startsWith(today));
  const todayContent=content.filter(c=>(c.created||'').startsWith(today));
  const todayLinks=links.filter(l=>(l.created||'').startsWith(today));
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
  const totalActive=tasks.filter(t=>t.status!=='done').length;
  let report='# Daily Report - '+today+'\n\n';
  report+='## Summary\n';
  report+='- Tasks completed today: '+doneTasks.length+'\n';
  report+='- Content created today: '+todayContent.length+'\n';
  report+='- Links saved today: '+todayLinks.length+'\n';
  report+='- Active tasks: '+totalActive+'\n';
  report+='- Overdue tasks: '+overdue.length+'\n\n';
  if(doneTasks.length>0){report+='## Completed Today\n';doneTasks.forEach(t=>{report+='- [x] '+t.title+'\n';});report+='\n';}
  if(overdue.length>0){report+='## Overdue\n';overdue.slice(0,10).forEach(t=>{report+='- [ ] '+t.title+' (due: '+t.due+')\n';});report+='\n';}
  const upcoming=tasks.filter(t=>t.status!=='done'&&t.due&&t.due>today&&t.due<=new Date(Date.now()+3*24*60*60*1000).toISOString().split('T')[0]);
  if(upcoming.length>0){report+='## Upcoming (3 days)\n';upcoming.forEach(t=>{report+='- '+t.title+' ('+t.due+')\n';});report+='\n';}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Daily Report</h3><div><button onclick="(function(){navigator.clipboard.writeText(document.getElementById(\'daily-report-text\').textContent);if(typeof showNotification===\'function\')showNotification(\'Report copied!\');})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">Copy</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  h+='<pre id="daily-report-text" style="font-size:11px;color:var(--text-primary);background:var(--bg-surface);padding:16px;border-radius:8px;white-space:pre-wrap;font-family:inherit;line-height:1.6;max-height:60vh;overflow-y:auto">'+esc(report)+'</pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectSwitcher(){
  let panel=document.getElementById('project-switcher-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='project-switcher-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=S.projects||[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Quick Project Switcher</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  if(projects.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:30px 0">No projects found.</div>';}
  projects.forEach(p=>{
    const taskCount=(S.tasks||[]).filter(t=>t.projectId===p.id&&t.status!=='done').length;
    const doneCount=(S.tasks||[]).filter(t=>t.projectId===p.id&&t.status==='done').length;
    const contentCount=(S.content||[]).filter(c=>c.projectId===p.id).length;
    h+='<div onclick="document.getElementById(\'project-switcher-panel\').remove();if(typeof openProject===\'function\')openProject(\''+p.id+'\');else switchSection(\'tasks\')" style="padding:14px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:border-color 0.2s" onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">';
    h+='<div style="font-size:13px;font-weight:600;margin-bottom:4px">'+esc(p.name)+'</div>';
    h+='<div style="display:flex;gap:12px;font-size:10px;color:var(--text-muted)">';
    h+='<span>Active: '+taskCount+'</span><span>Done: '+doneCount+'</span><span>Content: '+contentCount+'</span></div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showPomodoroStats(){
  let panel=document.getElementById('pomodoro-stats-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='pomodoro-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._pomodoroLog)S._pomodoroLog=[];
  const logs=S._pomodoroLog;
  const today=new Date().toISOString().split('T')[0];
  const todayLogs=logs.filter(l=>l.date&&l.date.startsWith(today));
  const weekStart=new Date();weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const weekKey=weekStart.toISOString().split('T')[0];
  const weekLogs=logs.filter(l=>l.date&&l.date>=weekKey);
  const totalPomos=logs.length;
  const totalMinutes=logs.reduce((s,l)=>s+(l.duration||25),0);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Pomodoro Stats</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:var(--accent)">'+todayLogs.length+'</div><div style="font-size:10px;color:var(--text-muted)">Today</div></div>';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:var(--accent)">'+weekLogs.length+'</div><div style="font-size:10px;color:var(--text-muted)">This Week</div></div>';
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:20px;font-weight:bold;color:var(--accent)">'+Math.floor(totalMinutes/60)+'h</div><div style="font-size:10px;color:var(--text-muted)">All Time</div></div></div>';
  // 7-day chart
  h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Last 7 Days</h4>';
  const days7=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days7.push(d.toISOString().split('T')[0]);}
  const maxDay=Math.max(...days7.map(d=>logs.filter(l=>l.date&&l.date.startsWith(d)).length),1);
  h+='<div style="display:flex;align-items:flex-end;gap:4px;height:80px;margin-bottom:4px">';
  days7.forEach(d=>{
    const count=logs.filter(l=>l.date&&l.date.startsWith(d)).length;
    const pct=count/maxDay*100;
    h+='<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px"><div style="width:100%;background:var(--accent);border-radius:3px 3px 0 0;height:'+Math.max(2,pct)+'%;opacity:'+(count>0?1:0.2)+'"></div></div>';
  });
  h+='</div><div style="display:flex;gap:4px">';
  days7.forEach(d=>{h+='<div style="flex:1;text-align:center;font-size:8px;color:var(--text-muted)">'+d.slice(5)+'</div>';});
  h+='</div>';
  // Recent sessions
  if(logs.length>0){
    h+='<h4 style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">Recent Sessions</h4>';
    logs.slice(0,8).forEach(l=>{
      h+='<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:11px"><span>'+(l.task||'Untitled session')+'</span><span style="color:var(--text-muted)">'+(l.duration||25)+'min - '+(l.date||'').split('T')[0]+'</span></div>';
    });
  }
  h+='<div style="margin-top:12px"><button onclick="(function(){const task=prompt(\'What did you work on?\');S._pomodoroLog.unshift({date:new Date().toISOString(),duration:25,task:task||\'Focus session\'});save();showPomodoroStats();})()" style="background:var(--accent);color:#000;border:none;padding:6px 14px;border-radius:4px;cursor:pointer;font-size:11px">Log Pomodoro</button></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentCardView(){
  let panel=document.getElementById('content-card-view-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-card-view-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:900px;width:95vw;max-height:85vh;overflow-y:auto';
  const content=S.content||[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Content Card Gallery</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">';
  content.slice(0,30).forEach(c=>{
    const words=(c.body||'').split(/\s+/).filter(w=>w).length;
    const preview=(c.body||'').substring(0,120);
    const themeColors={'general':'#4ade80','business':'#3b82f6','creative':'#a78bfa','personal':'#f97316','technical':'#22d3ee'};
    const color=themeColors[c.theme]||'var(--text-muted)';
    h+='<div style="padding:14px;border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;gap:8px;border-top:3px solid '+color+'">';
    h+='<div style="font-size:12px;font-weight:600">'+esc(c.title)+'</div>';
    if(preview)h+='<div style="font-size:10px;color:var(--text-muted);line-height:1.5;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden">'+esc(preview)+'</div>';
    h+='<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted);margin-top:auto">';
    h+='<span>'+words+' words</span>';
    if(c.theme)h+='<span style="color:'+color+'">'+esc(c.theme)+'</span>';
    h+='</div>';
    if(c.tags&&c.tags.length>0){
      h+='<div style="display:flex;flex-wrap:wrap;gap:3px">';
      c.tags.slice(0,3).forEach(t=>{h+='<span style="padding:1px 6px;background:var(--bg-surface);border-radius:8px;font-size:8px;color:var(--accent)">'+esc(t)+'</span>';});
      h+='</div>';
    }
    h+='</div>';
  });
  h+='</div>';
  if(content.length>30)h+='<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:12px 0">Showing 30 of '+content.length+'</div>';
  if(content.length===0)h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No content items yet.</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskFlow(){
  let panel=document.getElementById('task-flow-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-flow-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow-y:auto';
  const tasks=S.tasks||[];
  const statuses=['todo','in-progress','review','blocked','done'];
  const statusColors={'todo':'#6b7280','in-progress':'#4ade80','review':'#22d3ee','blocked':'#ef4444','done':'#4ade80'};
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Flow</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Visual flow of tasks through statuses. Width = task count.</div>';
  // Sankey-like horizontal flow
  const counts=statuses.map(s=>tasks.filter(t=>t.status===s).length);
  const maxCount=Math.max(...counts,1);
  h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:16px">';
  statuses.forEach((s,i)=>{
    const count=counts[i];
    const width=Math.max(60,count/maxCount*200);
    h+='<div style="display:flex;flex-direction:column;align-items:center;gap:4px">';
    h+='<div style="width:'+width+'px;height:40px;background:'+statusColors[s]+';border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;color:#000;opacity:0.8">'+count+'</div>';
    h+='<div style="font-size:9px;color:var(--text-muted);text-transform:uppercase">'+s+'</div></div>';
    if(i<statuses.length-1)h+='<div style="font-size:16px;color:var(--text-muted)">-></div>';
  });
  h+='</div>';
  // Top movers
  const inProg=tasks.filter(t=>t.status==='in-progress').slice(0,5);
  if(inProg.length>0){
    h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Currently In Progress</h4>';
    inProg.forEach(t=>{
      const color=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':'var(--text-primary)';
      h+='<div style="padding:6px 8px;border-bottom:1px solid var(--border);font-size:11px;color:'+color+'">'+esc(t.title)+'</div>';
    });
  }
  const blocked=tasks.filter(t=>t.status==='blocked').slice(0,5);
  if(blocked.length>0){
    h+='<h4 style="margin:12px 0 8px;font-size:12px;color:#ef4444">Blocked</h4>';
    blocked.forEach(t=>{
      h+='<div style="padding:6px 8px;border-bottom:1px solid var(--border);font-size:11px;color:#ef4444">'+esc(t.title)+'</div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWeeklyDigest(){
  let panel=document.getElementById('weekly-digest-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='weekly-digest-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay());
  const weekKey=weekStart.toISOString().split('T')[0];
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];const docs=S.writerDocs||[];
  const weekTasks=tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt>=weekKey);
  const weekContent=content.filter(c=>c.created&&c.created>=weekKey);
  const weekLinks=links.filter(l=>l.created&&l.created>=weekKey);
  const weekWords=weekContent.reduce((s,c)=>s+(c.body||'').split(/\s+/).filter(w=>w).length,0);
  const active=tasks.filter(t=>t.status!=='done').length;
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&t.due<now.toISOString().split('T')[0]).length;
  let digest='# Weekly Digest - Week of '+weekKey+'\n\n';
  digest+='## Highlights\n';
  digest+='- Tasks completed: '+weekTasks.length+'\n';
  digest+='- Content created: '+weekContent.length+' ('+weekWords+' words)\n';
  digest+='- Links saved: '+weekLinks.length+'\n';
  digest+='- Active tasks remaining: '+active+'\n';
  digest+='- Overdue tasks: '+overdue+'\n\n';
  if(weekTasks.length>0){digest+='## Completed Tasks\n';weekTasks.forEach(t=>{digest+='- '+t.title+(t.projectId?' ['+((S.projects||[]).find(p=>p.id===t.projectId)||{}).name+']':'')+(t.priority?' ('+t.priority+')':'')+'\n';});digest+='\n';}
  if(weekContent.length>0){digest+='## New Content\n';weekContent.forEach(c=>{digest+='- '+c.title+' ('+((c.body||'').split(/\s+/).filter(w=>w).length)+' words)\n';});digest+='\n';}
  const p0p1=tasks.filter(t=>t.status!=='done'&&(t.priority==='p0'||t.priority==='p1'));
  if(p0p1.length>0){digest+='## Priority Focus Next Week\n';p0p1.forEach(t=>{digest+='- ['+t.priority.toUpperCase()+'] '+t.title+'\n';});digest+='\n';}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Weekly Digest</h3><div><button onclick="(function(){navigator.clipboard.writeText(document.getElementById(\'weekly-digest-text\').textContent);if(typeof showNotification===\'function\')showNotification(\'Digest copied!\');})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">Copy</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  h+='<pre id="weekly-digest-text" style="font-size:11px;color:var(--text-primary);background:var(--bg-surface);padding:16px;border-radius:8px;white-space:pre-wrap;font-family:inherit;line-height:1.6;max-height:60vh;overflow-y:auto">'+esc(digest)+'</pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskTagCloud(){
  let panel=document.getElementById('task-tag-cloud-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-tag-cloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=S.tasks||[];
  const tagMap={};
  tasks.forEach(t=>{(t.tags||[]).forEach(tag=>{if(!tagMap[tag])tagMap[tag]={total:0,done:0,active:0};tagMap[tag].total++;if(t.status==='done')tagMap[tag].done++;else tagMap[tag].active++;});});
  const sorted=Object.entries(tagMap).sort((a,b)=>b[1].total-a[1].total);
  const maxCount=sorted.length>0?sorted[0][1].total:1;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Tag Cloud</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  if(sorted.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No tags found on tasks.</div>';}
  else{
    h+='<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:16px">';
    sorted.forEach(([tag,info])=>{
      const size=Math.max(11,Math.min(28,11+info.total/maxCount*17));
      const opacity=0.4+info.total/maxCount*0.6;
      h+='<span onclick="this.parentElement.parentElement.remove();switchSection(\'tasks\')" style="font-size:'+size+'px;color:var(--accent);opacity:'+opacity+';cursor:pointer;padding:4px" title="'+info.total+' tasks ('+info.active+' active, '+info.done+' done)">'+esc(tag)+'</span>';
    });
    h+='</div>';
    h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Tag Details</h4>';
    sorted.slice(0,15).forEach(([tag,info])=>{
      const pct=info.total>0?Math.round(info.done/info.total*100):0;
      h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:11px;width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(tag)+'</span>';
      h+='<div style="flex:1;height:12px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:var(--accent);width:'+pct+'%"></div></div>';
      h+='<span style="font-size:10px;color:var(--text-muted);width:60px;text-align:right">'+info.done+'/'+info.total+'</span></div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickCalculator(){
  let panel=document.getElementById('quick-calc-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-calc-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:var(--accent);font-size:13px">Quick Calculator</h4><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<div id="calc-display" style="padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;font-size:16px;color:var(--text-primary);text-align:right;margin-bottom:8px;min-height:20px;font-family:monospace">0</div>';
  h+='<input id="calc-input" placeholder="Type expression (e.g. 2+2, 100*0.15)" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:8px;box-sizing:border-box;font-family:monospace" oninput="(function(v){try{if(!v){document.getElementById(\'calc-display\').textContent=\'0\';return;}const r=Function(\'return \'+v)();document.getElementById(\'calc-display\').textContent=r;}catch(e){document.getElementById(\'calc-display\').textContent=\'...\';}})(this.value)">';
  h+='<div style="display:flex;gap:4px;margin-bottom:8px">';
  h+='<button onclick="(function(){const v=document.getElementById(\'calc-display\').textContent;navigator.clipboard.writeText(v);if(typeof showNotification===\'function\')showNotification(\'Copied: \'+v);})()" style="flex:1;padding:6px;background:var(--accent);color:#000;border:none;border-radius:4px;cursor:pointer;font-size:10px">Copy Result</button>';
  h+='<button onclick="document.getElementById(\'calc-input\').value=\'\';document.getElementById(\'calc-display\').textContent=\'0\'" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-muted);border-radius:4px;cursor:pointer;font-size:10px">Clear</button></div>';
  h+='<div style="font-size:9px;color:var(--text-muted)">Supports: +, -, *, /, %, Math.sqrt(), Math.PI</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const i=document.getElementById('calc-input');if(i)i.focus();},100);
}
function showMarkdownPreview(){
  let panel=document.getElementById('md-preview-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='md-preview-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow:hidden;display:flex;flex-direction:column';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:var(--accent)">Markdown Preview</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1;overflow:hidden">';
  h+='<div style="display:flex;flex-direction:column"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Markdown</div><textarea id="md-input" style="flex:1;padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px;font-family:monospace;resize:none;box-sizing:border-box" oninput="(function(v){const p=document.getElementById(\'md-output\');let h=v.replace(/^### (.*$)/gm,\'<h3>$1</h3>\').replace(/^## (.*$)/gm,\'<h2 style=color:var(--accent)>$1</h2>\').replace(/^# (.*$)/gm,\'<h1 style=color:var(--accent)>$1</h1>\').replace(/\\*\\*(.*?)\\*\\*/g,\'<strong>$1</strong>\').replace(/\\*(.*?)\\*/g,\'<em>$1</em>\').replace(/`(.*?)`/g,\'<code style=background:var(--bg-surface);padding:2px\\ 4px;border-radius:3px>$1</code>\').replace(/^- (.*$)/gm,\'<div style=padding-left:16px>- $1</div>\').replace(/^\\d+\\. (.*$)/gm,\'<div style=padding-left:16px>$1</div>\').replace(/\\n/g,\'<br>\');p.innerHTML=h;})(this.value)">## Hello World\n\nThis is **bold** and *italic* text.\n\n### Features\n- Item one\n- Item two\n- Item three\n\n`inline code` works too.</textarea></div>';
  h+='<div style="display:flex;flex-direction:column"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Preview</div><div id="md-output" style="flex:1;padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;overflow-y:auto;font-size:12px;line-height:1.6;color:var(--text-primary)"></div></div>';
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  // Trigger initial render
  const inp=document.getElementById('md-input');if(inp)inp.dispatchEvent(new Event('input'));
}
function showTaskDashboard(){
  let panel=document.getElementById('task-dashboard-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-dashboard-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:750px;width:95vw;max-height:85vh;overflow-y:auto';
  const tasks=S.tasks||[];
  const total=tasks.length;const done=tasks.filter(t=>t.status==='done').length;
  const active=total-done;
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length;
  const today=new Date().toISOString().split('T')[0];
  const dueToday=tasks.filter(t=>t.status!=='done'&&t.due===today).length;
  const p0=tasks.filter(t=>t.status!=='done'&&t.priority==='p0').length;
  const p1=tasks.filter(t=>t.status!=='done'&&t.priority==='p1').length;
  const inProg=tasks.filter(t=>t.status==='in-progress').length;
  const blocked=tasks.filter(t=>t.status==='blocked').length;
  const completionRate=total>0?Math.round(done/total*100):0;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Dashboard</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  // Key metrics grid
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px">';
  const metrics=[
    {val:active,label:'Active',color:'var(--accent)'},
    {val:done,label:'Done',color:'#4ade80'},
    {val:overdue,label:'Overdue',color:overdue>0?'#ef4444':'var(--accent)'},
    {val:dueToday,label:'Due Today',color:dueToday>0?'#f97316':'var(--accent)'},
    {val:p0,label:'P0 Critical',color:p0>0?'#ef4444':'var(--accent)'},
    {val:p1,label:'P1 High',color:p1>0?'#f97316':'var(--accent)'},
    {val:inProg,label:'In Progress',color:'#22d3ee'},
    {val:blocked,label:'Blocked',color:blocked>0?'#ef4444':'var(--accent)'},
  ];
  metrics.forEach(m=>{
    h+='<div style="padding:10px;background:var(--bg-surface);border-radius:8px;text-align:center"><div style="font-size:18px;font-weight:bold;color:'+m.color+'">'+m.val+'</div><div style="font-size:9px;color:var(--text-muted)">'+m.label+'</div></div>';
  });
  h+='</div>';
  // Completion donut (simple)
  h+='<div style="display:flex;align-items:center;gap:16px;padding:12px;background:var(--bg-surface);border-radius:8px;margin-bottom:16px">';
  h+='<div style="width:60px;height:60px;border-radius:50%;background:conic-gradient(var(--accent) '+completionRate+'%,var(--bg-elevated) '+completionRate+'%);display:flex;align-items:center;justify-content:center"><div style="width:44px;height:44px;border-radius:50%;background:var(--bg-surface);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;color:var(--accent)">'+completionRate+'%</div></div>';
  h+='<div><div style="font-size:12px;font-weight:600">Completion Rate</div><div style="font-size:10px;color:var(--text-muted)">'+done+' of '+total+' tasks completed</div></div></div>';
  // Recent completions
  const recentDone=tasks.filter(t=>t.status==='done'&&t.completedAt).sort((a,b)=>b.completedAt.localeCompare(a.completedAt)).slice(0,5);
  if(recentDone.length>0){
    h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Recently Completed</h4>';
    recentDone.forEach(t=>{
      h+='<div style="padding:4px 0;border-bottom:1px solid var(--border);font-size:11px;display:flex;justify-content:space-between"><span style="color:var(--text-muted);text-decoration:line-through">'+esc(t.title)+'</span><span style="font-size:9px;color:var(--text-muted)">'+(t.completedAt||'').split('T')[0]+'</span></div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showRepoChangelog(){
  let panel=document.getElementById('repo-changelog-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='repo-changelog-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._changelog)S._changelog=[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Changelog</h3><div><button onclick="(function(){const ver=prompt(\'Version (e.g. v1.2.0):\');if(!ver)return;const changes=prompt(\'Changes (comma-separated):\');if(!changes)return;S._changelog.unshift({id:Date.now(),version:ver,changes:changes.split(\',\').map(c=>c.trim()),date:new Date().toISOString()});save();showRepoChangelog();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">+ Entry</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  if(S._changelog.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No changelog entries yet. Add one!</div>';}
  S._changelog.forEach(entry=>{
    h+='<div style="padding:12px;border-left:3px solid var(--accent);margin-bottom:12px">';
    h+='<div style="display:flex;justify-content:space-between;margin-bottom:6px"><strong style="font-size:14px;color:var(--accent)">'+esc(entry.version)+'</strong><span style="font-size:10px;color:var(--text-muted)">'+(entry.date||'').split('T')[0]+'</span></div>';
    h+='<ul style="margin:0;padding-left:16px;list-style:disc">';
    (entry.changes||[]).forEach(c=>{h+='<li style="font-size:11px;color:var(--text-primary);margin-bottom:4px">'+esc(c)+'</li>';});
    h+='</ul>';
    h+='<button onclick="(function(){S._changelog=S._changelog.filter(x=>x.id!=='+entry.id+');save();showRepoChangelog();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px;margin-top:4px">Delete</button></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickReference(){
  let panel=document.getElementById('quick-ref-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-ref-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._quickRefs)S._quickRefs=[
    {id:1,title:'Project URLs',content:'ASTRA: astra-command-center-sigma.vercel.app\nBonus: saturno-bonus-omega.vercel.app\nTitan: titan-forge-ten.vercel.app\nValentine: de-aqui-a-saturno-jet.vercel.app'},
    {id:2,title:'Git Commands',content:'git add . && git commit -m "msg" && git push\ngit status\ngit log --oneline -5\ngit diff'},
    {id:3,title:'Keyboard Shortcuts',content:'Cmd+K: Command palette\nCmd+S: Save\nCmd+B: Toggle sidebar\nCmd+1-9: Switch sections\nCmd+Shift+F: Focus mode'},
  ];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Quick Reference</h3><div><button onclick="(function(){const t=prompt(\'Reference title:\');if(!t)return;const c=prompt(\'Content:\');if(!c)return;S._quickRefs.push({id:Date.now(),title:t,content:c});save();showQuickReference();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">+ Ref</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  S._quickRefs.forEach(r=>{
    h+='<div style="padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><strong style="font-size:12px">'+esc(r.title)+'</strong><div>';
    h+='<button onclick="(function(){navigator.clipboard.writeText(S._quickRefs.find(x=>x.id==='+r.id+').content);if(typeof showNotification===\'function\')showNotification(\'Copied!\');})()" style="background:none;border:1px solid var(--accent);color:var(--accent);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:9px;margin-right:4px">Copy</button>';
    h+='<button onclick="(function(){S._quickRefs=S._quickRefs.filter(x=>x.id!=='+r.id+');save();showQuickReference();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">X</button></div></div>';
    h+='<pre style="font-size:11px;color:var(--text-primary);background:var(--bg-surface);padding:8px;border-radius:4px;margin:0;white-space:pre-wrap;font-family:monospace;line-height:1.5">'+esc(r.content)+'</pre></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showIdleDetector(){
  let panel=document.getElementById('idle-detector-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='idle-detector-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=Date.now();
  const sections={tasks:{data:S.tasks||[],field:'created'},content:{data:S.content||[],field:'created'},links:{data:S.links||[],field:'created'},writer:{data:S.writerDocs||[],field:'modified'}};
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Activity Monitor</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Last activity per section and overall freshness.</div>';
  Object.entries(sections).forEach(([name,info])=>{
    let latest=null;
    info.data.forEach(item=>{
      const d=item[info.field]||item.created||'';
      if(d&&(!latest||d>latest))latest=d;
    });
    const hours=latest?Math.round((now-new Date(latest).getTime())/(1000*60*60)):null;
    const status=hours===null?'No data':hours<1?'Active now':hours<24?hours+'h ago':Math.round(hours/24)+'d ago';
    const color=hours===null?'#6b7280':hours<24?'#4ade80':hours<72?'#f97316':'#ef4444';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px">';
    h+='<div><div style="font-size:12px;font-weight:600;text-transform:capitalize">'+name+'</div><div style="font-size:10px;color:var(--text-muted)">'+info.data.length+' items</div></div>';
    h+='<span style="padding:3px 8px;border-radius:10px;font-size:10px;background:'+color+'22;color:'+color+'">'+status+'</span></div>';
  });
  // Session info
  h+='<div style="padding:12px;background:var(--bg-surface);border-radius:8px;margin-top:12px">';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">Session Info</div>';
  h+='<div style="font-size:11px">localStorage size: <strong style="color:var(--accent)">'+(JSON.stringify(S).length/1024).toFixed(0)+' KB</strong></div>';
  h+='<div style="font-size:11px">Current time: <strong>'+new Date().toISOString()+'</strong></div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentExporter(){
  let panel=document.getElementById('content-exporter-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-exporter-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Content Exporter</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  const formats=[
    {name:'All Content as Markdown',fn:'(function(){const md=(S.content||[]).map(c=>\"## \"+c.title+\"\\n\\n\"+c.body).join(\"\\n\\n---\\n\\n\");navigator.clipboard.writeText(md);if(typeof showNotification===\"function\")showNotification(\"Content exported as markdown!\");})()'},
    {name:'All Tasks as CSV',fn:'(function(){const rows=[\"Title,Status,Priority,Due,Project\"];(S.tasks||[]).forEach(t=>{const p=(S.projects||[]).find(x=>x.id===t.projectId);rows.push(\"\\\"\"+(t.title||\"\")+\"\\\",\"+(t.status||\"\")+\",\"+(t.priority||\"\")+\",\"+(t.due||\"\")+\",\\\"\"+(p?p.name:\"\")+\"\\\"\");});navigator.clipboard.writeText(rows.join(\"\\n\"));if(typeof showNotification===\"function\")showNotification(\"Tasks exported as CSV!\");})()'},
    {name:'All Links as JSON',fn:'(function(){navigator.clipboard.writeText(JSON.stringify(S.links||[],null,2));if(typeof showNotification===\"function\")showNotification(\"Links exported as JSON!\");})()'},
    {name:'Writer Docs as Markdown',fn:'(function(){const md=(S.writerDocs||[]).map(d=>\"# \"+d.title+\"\\n\\n\"+(d.content||\"\")).join(\"\\n\\n---\\n\\n\");navigator.clipboard.writeText(md);if(typeof showNotification===\"function\")showNotification(\"Docs exported as markdown!\");})()'},
    {name:'Full Workspace JSON',fn:'(function(){const blob=new Blob([JSON.stringify(S,null,2)],{type:\"application/json\"});const url=URL.createObjectURL(blob);const a=document.createElement(\"a\");a.href=url;a.download=\"astra-workspace-\"+new Date().toISOString().split(\"T\")[0]+\".json\";a.click();URL.revokeObjectURL(url);})()'},
  ];
  formats.forEach(f=>{
    h+='<button onclick="'+f.fn+'" style="display:block;width:100%;padding:12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);cursor:pointer;font-size:12px;text-align:left;margin-bottom:8px;transition:border-color 0.2s" onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">'+esc(f.name)+'</button>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showRandomTask(){
  let panel=document.getElementById('random-task-panel');if(panel)panel.remove();
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  if(tasks.length===0){if(typeof showNotification==='function')showNotification('No active tasks!');return;}
  const task=tasks[Math.floor(Math.random()*tasks.length)];
  panel=document.createElement('div');panel.id='random-task-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:30px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;text-align:center';
  const color=task.priority==='p0'?'#ef4444':task.priority==='p1'?'#f97316':task.priority==='p2'?'#3b82f6':'#6b7280';
  let h='<div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px">Random Task Picker</div>';
  h+='<div style="font-size:10px;color:'+color+';margin-bottom:8px">'+esc((task.priority||'p3').toUpperCase())+' PRIORITY</div>';
  h+='<div style="font-size:20px;font-weight:bold;color:var(--text-primary);margin-bottom:12px;line-height:1.4">'+esc(task.title)+'</div>';
  if(task.description)h+='<div style="font-size:12px;color:var(--text-muted);margin-bottom:16px;line-height:1.5">'+esc(task.description.substring(0,200))+'</div>';
  h+='<div style="display:flex;gap:8px;justify-content:center">';
  h+='<button onclick="showRandomTask()" style="background:var(--accent);color:#000;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">Another One</button>';
  h+='<button onclick="(function(){const t=S.tasks.find(x=>x.id===\''+task.id+'\');if(t)t.status=\'in-progress\';save();document.getElementById(\'random-task-panel\').remove();if(typeof showNotification===\'function\')showNotification(\'Task started!\');})()" style="background:none;border:1px solid var(--border);color:var(--text-primary);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:11px">Start This</button>';
  h+='<button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:11px">Close</button></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentSorter(){
  let panel=document.getElementById('content-sorter-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-sorter-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Content Sorter</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Sort all content items permanently. Current order will be overwritten.</div>';
  const sorts=[
    {name:'Newest First',fn:'(function(){S.content.sort((a,b)=>(b.created||"").localeCompare(a.created||""));save();showContentSorter();if(typeof showNotification==="function")showNotification("Sorted by newest");})()'},
    {name:'Oldest First',fn:'(function(){S.content.sort((a,b)=>(a.created||"").localeCompare(b.created||""));save();showContentSorter();if(typeof showNotification==="function")showNotification("Sorted by oldest");})()'},
    {name:'Alphabetical (A-Z)',fn:'(function(){S.content.sort((a,b)=>(a.title||"").localeCompare(b.title||""));save();showContentSorter();if(typeof showNotification==="function")showNotification("Sorted A-Z");})()'},
    {name:'Longest First',fn:'(function(){S.content.sort((a,b)=>((b.body||"").length)-((a.body||"").length));save();showContentSorter();if(typeof showNotification==="function")showNotification("Sorted by length");})()'},
    {name:'By Theme',fn:'(function(){S.content.sort((a,b)=>(a.theme||"zzz").localeCompare(b.theme||"zzz"));save();showContentSorter();if(typeof showNotification==="function")showNotification("Sorted by theme");})()'},
    {name:'Pinned First',fn:'(function(){S.content.sort((a,b)=>(b.pinned?1:0)-(a.pinned?1:0));save();showContentSorter();if(typeof showNotification==="function")showNotification("Pinned items first");})()'},
  ];
  sorts.forEach(s=>{
    h+='<button onclick="'+s.fn+'" style="display:block;width:100%;padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);cursor:pointer;font-size:12px;text-align:left;margin-bottom:6px;transition:border-color 0.2s" onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">'+esc(s.name)+'</button>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWaterTracker(){
  let panel=document.getElementById('water-tracker-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='water-tracker-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:250px';
  if(!S._waterLog)S._waterLog={};
  const todayKey=new Date().toISOString().split('T')[0];
  const glasses=S._waterLog[todayKey]||0;
  const goal=8;
  const pct=Math.min(100,Math.round(glasses/goal*100));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:var(--accent);font-size:13px">Water Tracker</h4><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<div style="text-align:center;margin-bottom:12px"><div style="font-size:32px;font-weight:bold;color:var(--accent)">'+glasses+'</div><div style="font-size:10px;color:var(--text-muted)">of '+goal+' glasses</div></div>';
  h+='<div style="height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden;margin-bottom:12px"><div style="height:100%;background:var(--accent);width:'+pct+'%;border-radius:4px;transition:width 0.3s"></div></div>';
  h+='<div style="display:flex;gap:6px;justify-content:center">';
  h+='<button onclick="(function(){const k=new Date().toISOString().split(\'T\')[0];S._waterLog[k]=(S._waterLog[k]||0)+1;save();showWaterTracker();})()" style="flex:1;padding:8px;background:var(--accent);color:#000;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600">+ Glass</button>';
  h+='<button onclick="(function(){const k=new Date().toISOString().split(\'T\')[0];S._waterLog[k]=Math.max(0,(S._waterLog[k]||0)-1);save();showWaterTracker();})()" style="padding:8px;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-muted);border-radius:4px;cursor:pointer;font-size:11px">-</button></div>';
  if(glasses>=goal)h+='<div style="text-align:center;font-size:10px;color:var(--accent);margin-top:8px;font-weight:600">Goal reached! Stay hydrated!</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showLinkReadingQueue(){
  let panel=document.getElementById('link-queue-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='link-queue-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const links=S.links||[];
  const unread=links.filter(l=>!l.read);
  const read=links.filter(l=>l.read);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Reading Queue</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:flex;gap:12px;margin-bottom:12px;font-size:11px;color:var(--text-muted)"><span>Unread: <strong style="color:var(--accent)">'+unread.length+'</strong></span><span>Read: <strong>'+read.length+'</strong></span><span>Total: <strong>'+links.length+'</strong></span></div>';
  h+='<h4 style="margin:0 0 8px;font-size:12px;color:var(--text-muted)">Unread ('+unread.length+')</h4>';
  if(unread.length===0)h+='<div style="color:var(--text-muted);font-size:11px;padding:8px 0">All caught up!</div>';
  unread.slice(0,20).forEach(l=>{
    let domain='';try{domain=new URL(l.url).hostname.replace('www.','');}catch(e){}
    h+='<div style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--border);border-radius:6px;margin-bottom:4px">';
    h+='<button onclick="(function(){const l=S.links.find(x=>x.id===\''+l.id+'\');if(l)l.read=true;save();showLinkReadingQueue();})()" style="width:20px;height:20px;border-radius:50%;border:2px solid var(--border);background:transparent;cursor:pointer;flex-shrink:0"></button>';
    h+='<div style="flex:1;overflow:hidden"><a href="'+esc(l.url)+'" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(l.title||domain||l.url)+'</a>';
    h+='<div style="font-size:9px;color:var(--text-muted)">'+esc(domain)+'</div></div></div>';
  });
  if(read.length>0){
    h+='<h4 style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">Read ('+read.length+')</h4>';
    read.slice(0,10).forEach(l=>{
      h+='<div style="display:flex;align-items:center;gap:8px;padding:6px;opacity:0.5;font-size:11px">';
      h+='<span style="color:var(--accent);font-size:10px">V</span>';
      h+='<span>'+esc(l.title||l.url)+'</span></div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskCompletionGraph(){
  let panel=document.getElementById('task-completion-graph-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-completion-graph-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=S.tasks||[];
  const days14=[];for(let i=13;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days14.push(d.toISOString().split('T')[0]);}
  const created=days14.map(d=>tasks.filter(t=>t.created&&t.created.startsWith(d)).length);
  const done=days14.map(d=>tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.startsWith(d)).length);
  const maxVal=Math.max(...created,...done,1);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Completion Graph</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px;display:flex;gap:12px"><span><span style="display:inline-block;width:8px;height:8px;background:#3b82f6;border-radius:2px;margin-right:4px"></span>Created</span><span><span style="display:inline-block;width:8px;height:8px;background:var(--accent);border-radius:2px;margin-right:4px"></span>Completed</span></div>';
  // SVG chart
  const w=600;const ch=180;const padding=30;const barW=(w-padding*2)/14/2-2;
  h+='<svg viewBox="0 0 '+w+' '+(ch+30)+'" style="width:100%;height:auto">';
  // Grid lines
  for(let i=0;i<=4;i++){const y=padding+i*(ch-padding)/4;h+='<line x1="'+padding+'" y1="'+y+'" x2="'+(w-10)+'" y2="'+y+'" stroke="rgba(255,255,255,0.05)" />';}
  days14.forEach((d,i)=>{
    const x=padding+i*(w-padding*2)/14;
    const cH=created[i]/maxVal*(ch-padding);
    const dH=done[i]/maxVal*(ch-padding);
    h+='<rect x="'+x+'" y="'+(ch-cH)+'" width="'+barW+'" height="'+Math.max(1,cH)+'" fill="#3b82f6" rx="2" />';
    h+='<rect x="'+(x+barW+2)+'" y="'+(ch-dH)+'" width="'+barW+'" height="'+Math.max(1,dH)+'" fill="#4ade80" rx="2" />';
    if(i%2===0)h+='<text x="'+(x+barW)+'" y="'+(ch+16)+'" text-anchor="middle" fill="rgba(255,255,255,0.3)" font-size="9">'+d.slice(5)+'</text>';
  });
  h+='</svg>';
  const total14Created=created.reduce((s,v)=>s+v,0);
  const total14Done=done.reduce((s,v)=>s+v,0);
  h+='<div style="display:flex;gap:20px;margin-top:8px;font-size:11px;color:var(--text-muted)">';
  h+='<span>14-day created: <strong style="color:#3b82f6">'+total14Created+'</strong></span>';
  h+='<span>14-day done: <strong style="color:var(--accent)">'+total14Done+'</strong></span>';
  h+='<span>Net: <strong style="color:'+(total14Done>=total14Created?'var(--accent)':'#ef4444')+'">'+(total14Done-total14Created)+'</strong></span></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickColor(){
  let panel=document.getElementById('quick-color-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-color-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  const colors=['#ef4444','#f97316','#eab308','#22c55e','#4ade80','#14b8a6','#06b6d4','#22d3ee','#3b82f6','#6366f1','#8b5cf6','#a78bfa','#d946ef','#ec4899','#f43f5e','#ffffff','#6b7280','#000000'];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:var(--accent);font-size:13px">Color Picker</h4><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<div id="qc-preview" style="height:40px;border-radius:6px;background:#4ade80;margin-bottom:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-family:monospace;color:#000">#4ade80</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin-bottom:8px">';
  colors.forEach(c=>{
    h+='<button onclick="(function(){document.getElementById(\'qc-preview\').style.background=\''+c+'\';document.getElementById(\'qc-preview\').textContent=\''+c+'\';document.getElementById(\'qc-hex\').value=\''+c+'\';navigator.clipboard.writeText(\''+c+'\');})()" style="width:100%;aspect-ratio:1;border-radius:4px;background:'+c+';border:1px solid var(--border);cursor:pointer"></button>';
  });
  h+='</div>';
  h+='<input id="qc-hex" placeholder="#hex" value="#4ade80" oninput="document.getElementById(\'qc-preview\').style.background=this.value;document.getElementById(\'qc-preview\').textContent=this.value" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;font-family:monospace;box-sizing:border-box;margin-bottom:6px">';
  h+='<button onclick="(function(){navigator.clipboard.writeText(document.getElementById(\'qc-hex\').value);if(typeof showNotification===\'function\')showNotification(\'Color copied!\');})()" style="width:100%;padding:6px;background:var(--accent);color:#000;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600">Copy Color</button>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showStandupReport(){
  let panel=document.getElementById('standup-report-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='standup-report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  const yesterday=new Date(Date.now()-86400000).toISOString().split('T')[0];
  const tasks=S.tasks||[];
  const done=tasks.filter(t=>t.status==='done'&&t.completedAt&&(t.completedAt.startsWith(today)||t.completedAt.startsWith(yesterday)));
  const inProg=tasks.filter(t=>t.status==='in-progress');
  const blocked=tasks.filter(t=>t.status==='blocked');
  let report='# Standup - '+today+'\n\n';
  report+='## Done (yesterday/today)\n';
  if(done.length>0)done.forEach(t=>{report+='- '+t.title+'\n';});
  else report+='- (nothing completed recently)\n';
  report+='\n## In Progress\n';
  if(inProg.length>0)inProg.forEach(t=>{report+='- '+t.title+(t.priority?' ('+t.priority.toUpperCase()+')':'')+'\n';});
  else report+='- (nothing in progress)\n';
  report+='\n## Blocked\n';
  if(blocked.length>0)blocked.forEach(t=>{report+='- '+t.title+'\n';});
  else report+='- (no blockers)\n';
  report+='\n## Focus Today\n';
  const p0=tasks.filter(t=>t.status!=='done'&&t.priority==='p0').slice(0,3);
  if(p0.length>0)p0.forEach(t=>{report+='- [P0] '+t.title+'\n';});
  else{const next=tasks.filter(t=>t.status!=='done').slice(0,3);next.forEach(t=>{report+='- '+t.title+'\n';});}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Standup Report</h3><div><button onclick="(function(){navigator.clipboard.writeText(document.getElementById(\'standup-text\').textContent);if(typeof showNotification===\'function\')showNotification(\'Standup copied!\');})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">Copy</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  h+='<pre id="standup-text" style="font-size:11px;color:var(--text-primary);background:var(--bg-surface);padding:16px;border-radius:8px;white-space:pre-wrap;font-family:inherit;line-height:1.6">'+esc(report)+'</pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectOverview(){
  let panel=document.getElementById('project-overview-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='project-overview-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow-y:auto';
  const projects=S.projects||[];const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Project Overview</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px">';
  projects.forEach(p=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id);
    const done=pTasks.filter(t=>t.status==='done').length;
    const total=pTasks.length;const pct=total>0?Math.round(done/total*100):0;
    const pContent=content.filter(c=>c.projectId===p.id).length;
    const pLinks=links.filter(l=>l.projectId===p.id).length;
    const overdue=pTasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length;
    let healthColor=overdue>3?'#ef4444':overdue>0?'#f97316':'#4ade80';
    h+='<div style="padding:16px;border:1px solid var(--border);border-radius:10px;border-top:3px solid var(--accent)">';
    h+='<div style="font-size:13px;font-weight:600;margin-bottom:8px">'+esc(p.name)+'</div>';
    h+='<div style="height:5px;background:var(--bg-surface);border-radius:3px;overflow:hidden;margin-bottom:10px"><div style="height:100%;background:var(--accent);width:'+pct+'%;border-radius:3px"></div></div>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:10px;color:var(--text-muted)">';
    h+='<div>Tasks: <strong style="color:var(--text-primary)">'+total+'</strong></div>';
    h+='<div>Done: <strong style="color:var(--accent)">'+done+'</strong></div>';
    h+='<div>Content: <strong style="color:var(--text-primary)">'+pContent+'</strong></div>';
    h+='<div>Overdue: <strong style="color:'+healthColor+'">'+overdue+'</strong></div>';
    h+='</div></div>';
  });
  h+='</div>';
  if(projects.length===0)h+='<div style="color:var(--text-muted);text-align:center;padding:40px 0">No projects found.</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskSwimlanes(){
  let panel=document.getElementById('task-swimlanes-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='task-swimlanes-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:900px;width:95vw;max-height:85vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const projects=S.projects||[];
  const projList=[...projects,{id:null,name:'No Project'}];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Task Swimlanes</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Tasks grouped by project (swimlanes), sorted by priority.</div>';
  projList.forEach(p=>{
    const pTasks=tasks.filter(t=>p.id?(t.projectId===p.id):(!t.projectId));
    if(pTasks.length===0)return;
    pTasks.sort((a,b)=>{const order={'p0':0,'p1':1,'p2':2,'p3':3};return(order[a.priority||'p3']||3)-(order[b.priority||'p3']||3);});
    h+='<div style="margin-bottom:16px"><div style="font-size:12px;font-weight:600;padding:6px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:6px;display:flex;justify-content:space-between"><span>'+esc(p.name)+'</span><span style="color:var(--text-muted);font-weight:400">'+pTasks.length+' tasks</span></div>';
    h+='<div style="display:flex;gap:6px;flex-wrap:wrap;padding-left:8px">';
    pTasks.forEach(t=>{
      const color=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f97316':t.priority==='p2'?'#3b82f6':'#6b7280';
      h+='<div style="padding:6px 10px;border:1px solid '+color+'44;border-radius:6px;font-size:10px;border-left:3px solid '+color+';background:'+color+'08"><span style="color:'+color+';font-weight:600;margin-right:4px">'+esc((t.priority||'p3').toUpperCase())+'</span>'+esc(t.title)+'</div>';
    });
    h+='</div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDecisionLog(){
  let panel=document.getElementById('decision-log-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='decision-log-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._decisions)S._decisions=[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Decision Log</h3><div><button onclick="(function(){const title=prompt(\'Decision:\');if(!title)return;const context=prompt(\'Context/reasoning:\');const outcome=prompt(\'Expected outcome:\');S._decisions.unshift({id:Date.now(),title:title,context:context||\'\'  ,outcome:outcome||\'\',date:new Date().toISOString()});save();showDecisionLog();})()" style="background:var(--accent);color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:8px">+ Decision</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Record important decisions with context. Never ask "why did we do X?" again.</div>';
  if(S._decisions.length===0){h+='<div style="color:var(--text-muted);text-align:center;padding:30px 0">No decisions logged yet.</div>';}
  S._decisions.forEach(d=>{
    h+='<div style="padding:12px;border-left:3px solid var(--accent);background:var(--bg-surface);border-radius:0 8px 8px 0;margin-bottom:10px">';
    h+='<div style="display:flex;justify-content:space-between;margin-bottom:6px"><strong style="font-size:12px">'+esc(d.title)+'</strong><span style="font-size:9px;color:var(--text-muted)">'+(d.date||'').split('T')[0]+'</span></div>';
    if(d.context)h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px"><em>Context:</em> '+esc(d.context)+'</div>';
    if(d.outcome)h+='<div style="font-size:11px;color:var(--accent)"><em>Outcome:</em> '+esc(d.outcome)+'</div>';
    h+='<button onclick="(function(){S._decisions=S._decisions.filter(x=>x.id!=='+d.id+');save();showDecisionLog();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px;margin-top:4px">Delete</button></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentWordCloud(){
  let panel=document.getElementById('content-word-cloud-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-word-cloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=S.content||[];const docs=S.writerDocs||[];
  const allText=content.map(c=>c.title+' '+(c.body||'')).join(' ')+' '+docs.map(d=>d.title+' '+(d.content||'')).join(' ');
  const stops=new Set(['the','a','an','and','or','but','in','on','at','to','for','of','with','by','is','was','are','were','be','been','being','have','has','had','do','does','did','will','would','could','should','can','may','might','shall','this','that','these','those','it','its','i','we','you','he','she','they','me','him','her','us','them','my','your','our','their','not','no','from','as','if','then','than','so','very','just','about','also','more','all','each','every','some','any','much','many','such','what','which','who','how','when','where','why']);
  const words={};
  allText.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).forEach(w=>{if(w.length>2&&!stops.has(w))words[w]=(words[w]||0)+1;});
  const sorted=Object.entries(words).sort((a,b)=>b[1]-a[1]).slice(0,40);
  const maxCount=sorted.length>0?sorted[0][1]:1;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Content Word Cloud</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:16px 0">';
  const colors=['var(--accent)','#22d3ee','#a78bfa','#f97316','#ef4444','#eab308'];
  sorted.forEach(([word,count],i)=>{
    const size=Math.max(12,Math.min(36,12+count/maxCount*24));
    const color=colors[i%colors.length];
    const opacity=0.5+count/maxCount*0.5;
    h+='<span style="font-size:'+size+'px;color:'+color+';opacity:'+opacity+';padding:2px;cursor:default" title="'+count+' occurrences">'+esc(word)+'</span>';
  });
  h+='</div>';
  h+='<h4 style="margin:16px 0 8px;font-size:12px;color:var(--text-muted)">Top 15 Words</h4>';
  sorted.slice(0,15).forEach(([word,count])=>{
    const pct=Math.round(count/maxCount*100);
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:3px"><span style="font-size:11px;width:80px;overflow:hidden;text-overflow:ellipsis">'+esc(word)+'</span><div style="flex:1;height:12px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:var(--accent);width:'+pct+'%"></div></div><span style="font-size:10px;color:var(--text-muted);width:30px;text-align:right">'+count+'</span></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickClipboard(){
  let panel=document.getElementById('quick-clipboard-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-clipboard-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:300px;max-height:400px;overflow-y:auto';
  if(!S._clipboard)S._clipboard=[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:var(--accent);font-size:13px">Clipboard History</h4><div><button onclick="(function(){const t=prompt(\'Save to clipboard:\');if(!t)return;S._clipboard.unshift({id:Date.now(),text:t,date:new Date().toISOString()});if(S._clipboard.length>20)S._clipboard.length=20;save();showQuickClipboard();})()" style="background:var(--accent);color:#000;border:none;padding:3px 8px;border-radius:3px;cursor:pointer;font-size:10px;margin-right:4px">+</button><button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div></div>';
  if(S._clipboard.length===0){h+='<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px 0">No clipboard items. Click + to save text.</div>';}
  S._clipboard.forEach(c=>{
    h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:6px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px">';
    h+='<div style="font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;margin-right:8px" title="'+esc(c.text)+'">'+esc(c.text.substring(0,60))+'</div>';
    h+='<div style="display:flex;gap:2px;flex-shrink:0">';
    h+='<button onclick="(function(){navigator.clipboard.writeText(S._clipboard.find(x=>x.id==='+c.id+').text);if(typeof showNotification===\'function\')showNotification(\'Copied!\');})()" style="background:none;border:1px solid var(--accent);color:var(--accent);padding:1px 5px;border-radius:3px;cursor:pointer;font-size:9px">C</button>';
    h+='<button onclick="(function(){S._clipboard=S._clipboard.filter(x=>x.id!=='+c.id+');save();showQuickClipboard();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px">X</button></div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickTodo(){
  let panel=document.getElementById('quick-todo-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='quick-todo-panel';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:300px;max-height:400px;overflow-y:auto';
  if(!S._quickTodos)S._quickTodos=[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:var(--accent);font-size:13px">Quick Todo</h4><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<div style="display:flex;gap:4px;margin-bottom:10px"><input id="qt-input" placeholder="Add quick todo..." style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px" onkeydown="if(event.key===\'Enter\'){const v=this.value.trim();if(!v)return;S._quickTodos.push({id:Date.now(),text:v,done:false});this.value=\'\';save();showQuickTodo();}"><button onclick="(function(){const i=document.getElementById(\'qt-input\');const v=i.value.trim();if(!v)return;S._quickTodos.push({id:Date.now(),text:v,done:false});i.value=\'\';save();showQuickTodo();})()" style="background:var(--accent);color:#000;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:10px">+</button></div>';
  S._quickTodos.forEach(t=>{
    h+='<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">';
    h+='<button onclick="(function(){const t=S._quickTodos.find(x=>x.id==='+t.id+');if(t)t.done=!t.done;save();showQuickTodo();})()" style="width:16px;height:16px;border-radius:3px;border:1px solid '+(t.done?'var(--accent)':'var(--border)')+';background:'+(t.done?'var(--accent)':'transparent')+';cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#000;font-size:8px">'+(t.done?'V':'')+'</button>';
    h+='<span style="font-size:11px;flex:1;'+(t.done?'text-decoration:line-through;color:var(--text-muted)':'')+'">'+esc(t.text)+'</span>';
    h+='<button onclick="(function(){S._quickTodos=S._quickTodos.filter(x=>x.id!=='+t.id+');save();showQuickTodo();})()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px">X</button></div>';
  });
  if(S._quickTodos.length>0){
    const done=S._quickTodos.filter(t=>t.done).length;
    h+='<div style="font-size:9px;color:var(--text-muted);text-align:right;margin-top:8px">'+done+'/'+S._quickTodos.length+' done';
    if(done>0)h+=' | <span onclick="S._quickTodos=S._quickTodos.filter(t=>!t.done);save();showQuickTodo();" style="cursor:pointer;color:var(--accent)">Clear done</span>';
    h+='</div>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
  setTimeout(()=>{const i=document.getElementById('qt-input');if(i)i.focus();},100);
}
function showContentCompare(){
  let panel=document.getElementById('content-compare-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='content-compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow-y:auto';
  const content=S.content||[];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Content Compare</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
  h+='<div><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">Item A</label><select id="cc-a" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px" onchange="(function(){const a=S.content.find(c=>c.id===document.getElementById(\'cc-a\').value);const b=S.content.find(c=>c.id===document.getElementById(\'cc-b\').value);if(!a||!b)return;const r=document.getElementById(\'cc-result\');const aw=(a.body||\'\').split(/\\s+/).filter(w=>w).length;const bw=(b.body||\'\').split(/\\s+/).filter(w=>w).length;r.innerHTML=\'<div style=display:grid;grid-template-columns:1fr\\x201fr;gap:12px><div style=padding:10px;background:var(--bg-surface);border-radius:6px><h4 style=margin:0\\x200\\x208px;font-size:12px;color:var(--accent)>\'+a.title+\'</h4><div style=font-size:10px;color:var(--text-muted);margin-bottom:6px>\'+aw+\' words | \'+(a.theme||\'none\')+\'</div><div style=font-size:11px;line-height:1.5;max-height:200px;overflow-y:auto>\'+(a.body||\'\').substring(0,500)+\'</div></div><div style=padding:10px;background:var(--bg-surface);border-radius:6px><h4 style=margin:0\\x200\\x208px;font-size:12px;color:var(--accent)>\'+b.title+\'</h4><div style=font-size:10px;color:var(--text-muted);margin-bottom:6px>\'+bw+\' words | \'+(b.theme||\'none\')+\'</div><div style=font-size:11px;line-height:1.5;max-height:200px;overflow-y:auto>\'+(b.body||\'\').substring(0,500)+\'</div></div></div>\';})()"><option value="">Select...</option>';
  content.forEach(c=>{h+='<option value="'+c.id+'">'+esc(c.title)+'</option>';});
  h+='</select></div>';
  h+='<div><label style="font-size:10px;color:var(--text-muted);display:block;margin-bottom:4px">Item B</label><select id="cc-b" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px" onchange="document.getElementById(\'cc-a\').onchange()"><option value="">Select...</option>';
  content.forEach(c=>{h+='<option value="'+c.id+'">'+esc(c.title)+'</option>';});
  h+='</select></div></div>';
  h+='<div id="cc-result"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWorkspaceScorecard(){
  let panel=document.getElementById('workspace-scorecard-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='workspace-scorecard-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=S.tasks||[];const content=S.content||[];const links=S.links||[];const docs=S.writerDocs||[];
  let score=0;const criteria=[];
  // Completion rate
  const total=tasks.length;const done=tasks.filter(t=>t.status==='done').length;
  const compRate=total>0?Math.round(done/total*100):0;
  const compPts=compRate>=70?20:compRate>=40?10:0;
  score+=compPts;criteria.push({name:'Task Completion Rate',value:compRate+'%',points:compPts,max:20});
  // No overdue
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length;
  const overPts=overdue===0?15:overdue<=3?10:overdue<=5?5:0;
  score+=overPts;criteria.push({name:'Overdue Management',value:overdue+' overdue',points:overPts,max:15});
  // Content volume
  const totalWords=content.reduce((s,c)=>s+(c.body||'').split(/\s+/).filter(w=>w).length,0);
  const wordPts=totalWords>5000?15:totalWords>1000?10:totalWords>100?5:0;
  score+=wordPts;criteria.push({name:'Content Volume',value:totalWords+' words',points:wordPts,max:15});
  // Link organization
  const uncat=links.filter(l=>!l.category||l.category==='uncategorized').length;
  const catPts=links.length===0?10:uncat/links.length<0.2?15:uncat/links.length<0.5?10:5;
  score+=catPts;criteria.push({name:'Link Organization',value:uncat+' uncategorized',points:catPts,max:15});
  // Doc activity
  const docPts=docs.length>=5?15:docs.length>=2?10:docs.length>=1?5:0;
  score+=docPts;criteria.push({name:'Writer Activity',value:docs.length+' docs',points:docPts,max:15});
  // Project coverage
  const projects=S.projects||[];
  const projPts=projects.length>=3?10:projects.length>=1?5:0;
  score+=projPts;criteria.push({name:'Project Coverage',value:projects.length+' projects',points:projPts,max:10});
  // Tags usage
  const taggedItems=tasks.filter(t=>t.tags&&t.tags.length>0).length+content.filter(c=>c.tags&&c.tags.length>0).length;
  const tagPts=taggedItems>10?10:taggedItems>3?5:0;
  score+=tagPts;criteria.push({name:'Tag Usage',value:taggedItems+' tagged',points:tagPts,max:10});
  const maxScore=criteria.reduce((s,c)=>s+c.max,0);
  const pct=Math.round(score/maxScore*100);
  const grade=pct>=90?'A+':pct>=80?'A':pct>=70?'B':pct>=60?'C':pct>=50?'D':'F';
  const gradeColor=pct>=80?'#4ade80':pct>=60?'#f97316':'#ef4444';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">Workspace Scorecard</h3><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">Close</button></div>';
  h+='<div style="text-align:center;padding:16px;margin-bottom:16px"><div style="font-size:48px;font-weight:bold;color:'+gradeColor+'">'+grade+'</div><div style="font-size:14px;color:var(--text-muted)">'+score+' / '+maxScore+' points ('+pct+'%)</div></div>';
  criteria.forEach(c=>{
    const barPct=c.max>0?Math.round(c.points/c.max*100):0;
    const col=barPct>=80?'#4ade80':barPct>=50?'#f97316':'#ef4444';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
    h+='<span style="font-size:11px;width:140px;flex-shrink:0">'+c.name+'</span>';
    h+='<div style="flex:1;height:14px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:'+col+';width:'+barPct+'%"></div></div>';
    h+='<span style="font-size:10px;color:var(--text-muted);width:60px;text-align:right">'+c.points+'/'+c.max+'</span></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWorkspaceSearch(){
  let panel=document.getElementById('ws-search-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='ws-search-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  let secFilter='all',dateFrom='',dateTo='';
  function render(){
    const q=(panel.querySelector('#wss-q')||{}).value||'';
    secFilter=panel.querySelector('#wss-sec')?panel.querySelector('#wss-sec').value:secFilter;
    dateFrom=panel.querySelector('#wss-from')?panel.querySelector('#wss-from').value:dateFrom;
    dateTo=panel.querySelector('#wss-to')?panel.querySelector('#wss-to').value:dateTo;
    let results=[];
    const ql=q.toLowerCase();
    if(secFilter==='all'||secFilter==='tasks'){
      (S.tasks||[]).forEach(t=>{
        const txt=(t.title+' '+(t.description||'')+' '+(t.tags||[]).join(' ')).toLowerCase();
        if(ql&&!txt.includes(ql))return;
        if(dateFrom&&t.created<dateFrom)return;
        if(dateTo&&t.created>dateTo+'T23:59:59')return;
        results.push({section:'Task',title:t.title,date:t.created||'',extra:t.status+' / '+t.priority,id:t.id});
      });
    }
    if(secFilter==='all'||secFilter==='content'){
      (S.content||[]).forEach(c=>{
        const txt=(c.title+' '+(c.body||'')+' '+(c.tags||[]).join(' ')).toLowerCase();
        if(ql&&!txt.includes(ql))return;
        if(dateFrom&&c.created<dateFrom)return;
        if(dateTo&&c.created>dateTo+'T23:59:59')return;
        results.push({section:'Content',title:c.title,date:c.created||'',extra:c.theme||'',id:c.id});
      });
    }
    if(secFilter==='all'||secFilter==='links'){
      (S.links||[]).forEach(l=>{
        const txt=(l.title+' '+(l.url||'')+' '+(l.category||'')).toLowerCase();
        if(ql&&!txt.includes(ql))return;
        if(dateFrom&&l.created<dateFrom)return;
        if(dateTo&&l.created>dateTo+'T23:59:59')return;
        results.push({section:'Link',title:l.title||l.url,date:l.created||'',extra:l.category||'',id:l.id});
      });
    }
    if(secFilter==='all'||secFilter==='docs'){
      (S.writerDocs||[]).forEach(d=>{
        const txt=(d.title+' '+(d.body||'')).toLowerCase();
        if(ql&&!txt.includes(ql))return;
        results.push({section:'Doc',title:d.title,date:d.modified||d.created||'',extra:(d.body||'').split(/\s+/).filter(Boolean).length+' words',id:d.id});
      });
    }
    results.sort((a,b)=>(b.date||'').localeCompare(a.date||''));
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Advanced Search</span><button onclick="this.closest(\'#ws-search-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<input id="wss-q" placeholder="Search everything..." value="'+esc(q)+'" oninput="this.closest(\'#ws-search-panel\')._render()" style="width:100%;padding:8px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:13px;margin-bottom:8px;box-sizing:border-box">';
    h+='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
    h+='<select id="wss-sec" onchange="this.closest(\'#ws-search-panel\')._render()" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px">';
    ['all','tasks','content','links','docs'].forEach(s=>{h+='<option value="'+s+'"'+(secFilter===s?' selected':'')+'>'+s.charAt(0).toUpperCase()+s.slice(1)+'</option>';});
    h+='</select>';
    h+='<input id="wss-from" type="date" value="'+dateFrom+'" onchange="this.closest(\'#ws-search-panel\')._render()" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px">';
    h+='<input id="wss-to" type="date" value="'+dateTo+'" onchange="this.closest(\'#ws-search-panel\')._render()" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px">';
    h+='<span style="font-size:11px;color:var(--text-muted);align-self:center">'+results.length+' results</span></div>';
    results.slice(0,50).forEach(r=>{
      h+='<div style="padding:8px 10px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center">';
      const col=r.section==='Task'?'#4ade80':r.section==='Content'?'#60a5fa':r.section==='Link'?'#f59e0b':'#a78bfa';
      h+='<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:'+col+'22;color:'+col+';font-weight:600">'+r.section+'</span>';
      h+='<span style="flex:1;font-size:12px;color:var(--text)">'+esc(r.title)+'</span>';
      if(r.extra)h+='<span style="font-size:10px;color:var(--text-muted)">'+esc(r.extra)+'</span>';
      if(r.date)h+='<span style="font-size:10px;color:var(--text-muted)">'+r.date.substring(0,10)+'</span>';
      h+='</div>';
    });
    if(!results.length)h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">'+(q?'No results found':'Type to search across all sections')+'</div>';
    panel.innerHTML=h;
    panel._render=render;
    if(q)panel.querySelector('#wss-q').setSelectionRange(q.length,q.length);
    panel.querySelector('#wss-q').focus();
  }
  render();document.body.appendChild(panel);
}
function showTaskDependencyGraph(){
  let panel=document.getElementById('dep-graph-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='dep-graph-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const blocked=tasks.filter(t=>t.blockedBy);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Dependencies</span><button onclick="this.closest(\'#dep-graph-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!blocked.length){
    h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">No task dependencies found. Use the "blocked by" field in task detail modal to create dependencies.</div>';
  } else {
    const taskMap={};tasks.forEach(t=>{taskMap[t.id]=t;});
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+blocked.length+' tasks with dependencies</div>';
    const visited=new Set();
    function renderChain(tid,depth){
      if(visited.has(tid)||depth>5)return '';
      visited.add(tid);
      const t=taskMap[tid];if(!t)return '';
      const indent=depth*20;
      const pCol=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
      let ch='<div style="padding:6px 10px;margin-left:'+indent+'px;border-left:2px solid '+pCol+';margin-bottom:4px;background:var(--bg-surface);border-radius:0 var(--radius) var(--radius) 0">';
      ch+='<span style="font-size:12px;color:var(--text)">'+esc(t.title)+'</span>';
      ch+=' <span style="font-size:9px;padding:1px 5px;border-radius:3px;background:'+pCol+'22;color:'+pCol+'">'+t.priority+'</span>';
      ch+=' <span style="font-size:9px;color:var(--text-muted)">'+t.status+'</span>';
      if(depth>0)ch+=' <span style="font-size:9px;color:#4ade80">blocks above</span>';
      ch+='</div>';
      if(t.blockedBy){
        const bid=t.blockedBy;
        if(taskMap[bid])ch+=renderChain(bid,depth+1);
        else ch+='<div style="margin-left:'+(indent+20)+'px;font-size:10px;color:var(--text-muted);padding:4px">Blocked by unknown task</div>';
      }
      return ch;
    }
    const roots=blocked.filter(t=>{
      return !blocked.some(other=>other.blockedBy===t.id);
    });
    (roots.length?roots:blocked).forEach(t=>{
      visited.clear();
      h+=renderChain(t.id,0);
      h+='<div style="height:8px"></div>';
    });
  }
  h+='<div style="margin-top:12px;font-size:10px;color:var(--text-muted)">Tip: Set "blocked by" in task detail modal to create dependency chains</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showNotificationCenter(){
  let panel=document.getElementById('notif-center-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='notif-center-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._notifications)S._notifications=[];
  const now=new Date();
  const notifs=[];
  // Overdue tasks
  (S.tasks||[]).filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now).forEach(t=>{
    notifs.push({type:'overdue',icon:'!',color:'#ef4444',text:'Task "'+t.title+'" is overdue (due '+t.due.substring(0,10)+')',time:t.due});
  });
  // Tasks due today
  const todayStr=now.toISOString().substring(0,10);
  (S.tasks||[]).filter(t=>t.status!=='done'&&t.due&&t.due.substring(0,10)===todayStr).forEach(t=>{
    notifs.push({type:'due-today',icon:'D',color:'#f59e0b',text:'Task "'+t.title+'" is due today',time:new Date().toISOString()});
  });
  // Recently completed tasks (last 24h)
  const yesterday=new Date(now-86400000).toISOString();
  (S.tasks||[]).filter(t=>t.status==='done'&&t.completedAt&&t.completedAt>yesterday).forEach(t=>{
    notifs.push({type:'completed',icon:'V',color:'#4ade80',text:'Completed: "'+t.title+'"',time:t.completedAt});
  });
  // Stale in-progress tasks (no update in 7 days)
  const weekAgo=new Date(now-7*86400000).toISOString();
  (S.tasks||[]).filter(t=>t.status==='in-progress'&&t.created&&t.created<weekAgo).forEach(t=>{
    notifs.push({type:'stale',icon:'~',color:'#a78bfa',text:'Stale: "'+t.title+'" in-progress for 7+ days',time:t.created});
  });
  // New content in last 48h
  const twoDaysAgo=new Date(now-2*86400000).toISOString();
  (S.content||[]).filter(c=>c.created&&c.created>twoDaysAgo).forEach(c=>{
    notifs.push({type:'new-content',icon:'+',color:'#60a5fa',text:'New content: "'+c.title+'"',time:c.created});
  });
  notifs.sort((a,b)=>(b.time||'').localeCompare(a.time||''));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Notifications</span><button onclick="this.closest(\'#notif-center-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+notifs.length+' notifications</div>';
  if(!notifs.length){
    h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">All clear — no notifications right now</div>';
  }
  notifs.slice(0,40).forEach(n=>{
    h+='<div style="padding:8px 10px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:flex-start">';
    h+='<span style="width:22px;height:22px;border-radius:50%;background:'+n.color+'22;color:'+n.color+';display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">'+n.icon+'</span>';
    h+='<div style="flex:1"><div style="font-size:12px;color:var(--text)">'+esc(n.text)+'</div>';
    if(n.time)h+='<div style="font-size:10px;color:var(--text-muted);margin-top:2px">'+n.time.substring(0,16).replace('T',' ')+'</div>';
    h+='</div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showEisenhowerMatrix(){
  let panel=document.getElementById('eisenhower-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='eisenhower-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();const weekOut=new Date(now.getTime()+7*86400000);
  const urgent=t=>t.due&&new Date(t.due)<=weekOut;
  const important=t=>t.priority==='p0'||t.priority==='p1';
  const q1=tasks.filter(t=>urgent(t)&&important(t));
  const q2=tasks.filter(t=>!urgent(t)&&important(t));
  const q3=tasks.filter(t=>urgent(t)&&!important(t));
  const q4=tasks.filter(t=>!urgent(t)&&!important(t));
  const quadrants=[
    {label:'DO FIRST',sub:'Urgent + Important',tasks:q1,color:'#ef4444'},
    {label:'SCHEDULE',sub:'Not Urgent + Important',tasks:q2,color:'#f59e0b'},
    {label:'DELEGATE',sub:'Urgent + Not Important',tasks:q3,color:'#3b82f6'},
    {label:'ELIMINATE',sub:'Not Urgent + Not Important',tasks:q4,color:'#6b7280'},
  ];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Eisenhower Matrix</span><button onclick="this.closest(\'#eisenhower-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">Urgent = due within 7 days | Important = P0 or P1</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  quadrants.forEach(q=>{
    h+='<div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;border-top:3px solid '+q.color+'">';
    h+='<div style="font-size:11px;font-weight:700;color:'+q.color+';margin-bottom:2px">'+q.label+'</div>';
    h+='<div style="font-size:9px;color:var(--text-muted);margin-bottom:8px">'+q.sub+' ('+q.tasks.length+')</div>';
    if(!q.tasks.length)h+='<div style="font-size:10px;color:var(--text-muted);font-style:italic">Empty</div>';
    q.tasks.slice(0,6).forEach(t=>{
      h+='<div style="font-size:11px;color:var(--text);padding:3px 0;border-bottom:1px solid var(--border)">'+esc(t.title);
      if(t.due)h+=' <span style="font-size:9px;color:var(--text-muted)">'+t.due.substring(0,10)+'</span>';
      h+='</div>';
    });
    if(q.tasks.length>6)h+='<div style="font-size:10px;color:var(--text-muted);margin-top:4px">+'+(q.tasks.length-6)+' more</div>';
    h+='</div>';
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showRecentActivity(){
  let panel=document.getElementById('recent-activity-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='recent-activity-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const events=[];
  (S.tasks||[]).forEach(t=>{
    if(t.created)events.push({type:'task-created',text:'Created task: "'+t.title+'"',time:t.created,color:'#4ade80'});
    if(t.completedAt)events.push({type:'task-done',text:'Completed: "'+t.title+'"',time:t.completedAt,color:'#22d3ee'});
  });
  (S.content||[]).forEach(c=>{
    if(c.created)events.push({type:'content-created',text:'Added content: "'+c.title+'"',time:c.created,color:'#60a5fa'});
  });
  (S.links||[]).forEach(l=>{
    if(l.created)events.push({type:'link-added',text:'Saved link: "'+(l.title||l.url)+'"',time:l.created,color:'#f59e0b'});
  });
  (S.writerDocs||[]).forEach(d=>{
    if(d.modified)events.push({type:'doc-edited',text:'Edited doc: "'+d.title+'"',time:d.modified,color:'#a78bfa'});
    else if(d.created)events.push({type:'doc-created',text:'Created doc: "'+d.title+'"',time:d.created,color:'#a78bfa'});
  });
  events.sort((a,b)=>b.time.localeCompare(a.time));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Recent Activity</span><button onclick="this.closest(\'#recent-activity-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+events.length+' total events across all sections</div>';
  let lastDate='';
  events.slice(0,60).forEach(e=>{
    const dateStr=e.time.substring(0,10);
    if(dateStr!==lastDate){
      lastDate=dateStr;
      h+='<div style="font-size:10px;font-weight:700;color:var(--text-muted);padding:8px 0 4px;border-bottom:1px solid var(--border)">'+dateStr+'</div>';
    }
    h+='<div style="padding:6px 0 6px 16px;border-left:2px solid '+e.color+';margin-left:6px;display:flex;gap:8px;align-items:center">';
    h+='<span style="font-size:12px;color:var(--text)">'+esc(e.text)+'</span>';
    h+='<span style="font-size:9px;color:var(--text-muted);flex-shrink:0">'+e.time.substring(11,16)+'</span>';
    h+='</div>';
  });
  if(!events.length)h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">No activity recorded yet</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickNote(){
  let panel=document.getElementById('quick-note-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-note-widget';
  panel.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px';
  if(!S._quickNotes)S._quickNotes=[];
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:12px;color:var(--text)">Quick Notes</span><button onclick="this.closest(\'#quick-note-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    h+='<textarea id="qn-input" placeholder="Type a note and press Enter..." style="width:100%;height:50px;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;resize:none;box-sizing:border-box;font-family:inherit" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();const v=this.value.trim();if(v){S._quickNotes.unshift({text:v,time:new Date().toISOString()});if(S._quickNotes.length>30)S._quickNotes.length=30;save();this.closest(\'#quick-note-widget\')._render();}}"></textarea>';
    h+='<div style="max-height:200px;overflow-y:auto;margin-top:6px">';
    (S._quickNotes||[]).forEach((n,i)=>{
      h+='<div style="padding:5px 0;border-bottom:1px solid var(--border);display:flex;gap:6px;align-items:flex-start">';
      h+='<span style="flex:1;font-size:11px;color:var(--text)">'+esc(n.text)+'</span>';
      h+='<span style="font-size:9px;color:var(--text-muted);flex-shrink:0">'+((n.time||'').substring(11,16)||'')+'</span>';
      h+='<button onclick="S._quickNotes.splice('+i+',1);save();this.closest(\'#quick-note-widget\')._render()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px;flex-shrink:0">x</button>';
      h+='</div>';
    });
    h+='</div>';
    if(S._quickNotes.length)h+='<button onclick="S._quickNotes=[];save();this.closest(\'#quick-note-widget\')._render()" style="margin-top:6px;background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:10px;padding:3px 8px;width:100%">Clear All</button>';
    panel.innerHTML=h;
    panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showProjectTimeline(){
  let panel=document.getElementById('proj-timeline-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='proj-timeline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:750px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=(S.projects||[]);
  const tasks=(S.tasks||[]);
  const now=new Date();
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Project Timeline</span><button onclick="this.closest(\'#proj-timeline-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  if(!projects.length){
    h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">No projects found</div>';
  } else {
    // Find date range: earliest task created to latest task due
    let minDate=now,maxDate=now;
    tasks.forEach(t=>{
      if(t.created){const d=new Date(t.created);if(d<minDate)minDate=d;}
      if(t.due){const d=new Date(t.due);if(d>maxDate)maxDate=d;}
    });
    const rangeMs=maxDate-minDate||86400000;
    const totalDays=Math.max(Math.ceil(rangeMs/86400000),7);
    h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">'+minDate.toISOString().substring(0,10)+' to '+maxDate.toISOString().substring(0,10)+' ('+totalDays+' days)</div>';
    projects.forEach(p=>{
      const ptasks=tasks.filter(t=>t.project===p.name||t.projectId===p.id);
      if(!ptasks.length)return;
      const done=ptasks.filter(t=>t.status==='done').length;
      const pct=Math.round(done/ptasks.length*100);
      // Find this project's date span
      let pMin=maxDate,pMax=minDate;
      ptasks.forEach(t=>{
        if(t.created){const d=new Date(t.created);if(d<pMin)pMin=d;}
        if(t.due){const d=new Date(t.due);if(d>pMax)pMax=d;}
        if(t.completedAt){const d=new Date(t.completedAt);if(d>pMax)pMax=d;}
      });
      const leftPct=Math.max(0,Math.round((pMin-minDate)/rangeMs*100));
      const widthPct=Math.max(5,Math.round((pMax-pMin)/rangeMs*100));
      const col=pct===100?'#4ade80':pct>50?'#f59e0b':'#3b82f6';
      h+='<div style="margin-bottom:10px">';
      h+='<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:11px;color:var(--text);font-weight:600">'+esc(p.name)+'</span><span style="font-size:10px;color:var(--text-muted)">'+done+'/'+ptasks.length+' ('+pct+'%)</span></div>';
      h+='<div style="height:18px;background:var(--bg-surface);border-radius:3px;position:relative;overflow:hidden">';
      h+='<div style="position:absolute;left:'+leftPct+'%;width:'+widthPct+'%;height:100%;background:'+col+'44;border-radius:3px"></div>';
      h+='<div style="position:absolute;left:'+leftPct+'%;width:'+(widthPct*pct/100)+'%;height:100%;background:'+col+';border-radius:3px"></div>';
      h+='</div></div>';
    });
    // Today marker info
    const todayPct=Math.round((now-minDate)/rangeMs*100);
    h+='<div style="font-size:10px;color:#4ade80;margin-top:8px">Today is at '+todayPct+'% of the timeline</div>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskRecurrence(){
  let panel=document.getElementById('recurrence-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='recurrence-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const recurring=(S.tasks||[]).filter(t=>t.recurrence&&t.recurrence!=='none');
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Recurring Tasks</span><button onclick="this.closest(\'#recurrence-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+recurring.length+' recurring tasks configured</div>';
  if(!recurring.length){
    h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">No recurring tasks. Set recurrence in task detail modal.</div>';
  }
  const groups={};
  recurring.forEach(t=>{
    const r=t.recurrence||'unknown';
    if(!groups[r])groups[r]=[];
    groups[r].push(t);
  });
  const recColors={daily:'#ef4444',weekday:'#f59e0b',weekly:'#3b82f6',biweekly:'#8b5cf6',monthly:'#4ade80'};
  Object.keys(groups).sort().forEach(r=>{
    const col=recColors[r]||'#6b7280';
    h+='<div style="margin-bottom:12px">';
    h+='<div style="font-size:11px;font-weight:700;color:'+col+';padding:4px 0;border-bottom:1px solid var(--border);text-transform:uppercase">'+r+' ('+groups[r].length+')</div>';
    groups[r].forEach(t=>{
      const statusCol=t.status==='done'?'#4ade80':t.status==='in-progress'?'#f59e0b':'#6b7280';
      h+='<div style="padding:6px 10px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
      h+='<span style="width:8px;height:8px;border-radius:50%;background:'+statusCol+';flex-shrink:0"></span>';
      h+='<span style="flex:1;font-size:12px;color:var(--text)">'+esc(t.title)+'</span>';
      if(t.due)h+='<span style="font-size:10px;color:var(--text-muted)">next: '+t.due.substring(0,10)+'</span>';
      h+='<span style="font-size:9px;color:var(--text-muted)">'+t.status+'</span>';
      h+='</div>';
    });
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickLink(){
  let panel=document.getElementById('quick-link-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-link-widget';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:300px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:12px;color:var(--text)">Quick Link Saver</span><button onclick="this.closest(\'#quick-link-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<input id="ql-url" placeholder="Paste URL..." style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:6px;box-sizing:border-box">';
  h+='<input id="ql-title" placeholder="Title (optional)" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:6px;box-sizing:border-box">';
  h+='<select id="ql-cat" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:8px">';
  const cats=[...new Set((S.links||[]).map(l=>l.category).filter(Boolean))];
  h+='<option value="">No category</option>';
  cats.forEach(c=>{h+='<option value="'+esc(c)+'">'+esc(c)+'</option>';});
  h+='</select>';
  h+='<button onclick="const url=document.getElementById(\'ql-url\').value.trim();if(!url)return;if(!S.links)S.links=[];S.links.push({id:\'l_\'+Date.now(),url:url,title:document.getElementById(\'ql-title\').value.trim()||url,category:document.getElementById(\'ql-cat\').value,project:\'\',created:new Date().toISOString()});save();document.getElementById(\'ql-url\').value=\'\';document.getElementById(\'ql-title\').value=\'\';if(typeof renderLinks===\'function\')renderLinks();" style="width:100%;padding:6px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Save Link</button>';
  h+='<div style="margin-top:8px;font-size:10px;color:var(--text-muted)">'+(S.links||[]).length+' links saved</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDataBackup(){
  let panel=document.getElementById('data-backup-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='data-backup-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._backups)S._backups=[];
  function render(){
    const size=JSON.stringify(S).length;
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Data Backup Manager</span><button onclick="this.closest(\'#data-backup-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Current data size: '+(size/1024).toFixed(1)+'KB | Tasks: '+(S.tasks||[]).length+' | Content: '+(S.content||[]).length+' | Links: '+(S.links||[]).length+' | Docs: '+(S.writerDocs||[]).length+'</div>';
    h+='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
    h+='<button onclick="const d=new Date().toISOString().substring(0,19).replace(/[:\\-T]/g,\'\');const b=JSON.stringify(S);const blob=new Blob([b],{type:\'application/json\'});const a=document.createElement(\'a\');a.href=URL.createObjectURL(blob);a.download=\'astra-backup-\'+d+\'.json\';a.click()" style="padding:6px 12px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Download Full Backup</button>';
    h+='<button onclick="const snap={time:new Date().toISOString(),tasks:(S.tasks||[]).length,content:(S.content||[]).length,links:(S.links||[]).length,docs:(S.writerDocs||[]).length,size:JSON.stringify(S).length};S._backups.unshift(snap);if(S._backups.length>20)S._backups.length=20;save();this.closest(\'#data-backup-panel\')._render()" style="padding:6px 12px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px">Save Snapshot</button>';
    h+='<label style="padding:6px 12px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px"><input type="file" accept=".json" style="display:none" onchange="const f=this.files[0];if(!f)return;const r=new FileReader();r.onload=function(e){try{const d=JSON.parse(e.target.result);if(!confirm(\'Restore backup? This will overwrite current data.\'))return;Object.assign(S,d);save();if(typeof renderAll===\'function\')renderAll();alert(\'Restored!\')}catch(err){alert(\'Invalid backup file\')}};r.readAsText(f)">Import Backup</label>';
    h+='</div>';
    if(S._backups.length){
      h+='<div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:6px">Snapshots ('+S._backups.length+')</div>';
      S._backups.forEach((b,i)=>{
        h+='<div style="padding:6px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;font-size:11px">';
        h+='<span style="color:var(--text-muted)">'+b.time.substring(0,16).replace('T',' ')+'</span>';
        h+='<span style="color:var(--text)">T:'+b.tasks+' C:'+b.content+' L:'+b.links+' D:'+b.docs+'</span>';
        h+='<span style="color:var(--text-muted);font-size:9px">'+(b.size/1024).toFixed(0)+'KB</span>';
        h+='</div>';
      });
    }
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showTaskWallOfFame(){
  let panel=document.getElementById('wall-of-fame-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='wall-of-fame-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const completed=(S.tasks||[]).filter(t=>t.status==='done'&&(t.priority==='p0'||t.priority==='p1'));
  completed.sort((a,b)=>(b.completedAt||b.created||'').localeCompare(a.completedAt||a.created||''));
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Wall of Fame</span><button onclick="this.closest(\'#wall-of-fame-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+completed.length+' high-priority tasks completed</div>';
  if(!completed.length){
    h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">Complete P0 or P1 tasks to see them here</div>';
  }
  completed.forEach(t=>{
    const pCol=t.priority==='p0'?'#ef4444':'#f59e0b';
    h+='<div style="padding:12px;margin-bottom:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);border-left:3px solid '+pCol+'">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
    h+='<span style="font-size:13px;font-weight:600;color:var(--text)">'+esc(t.title)+'</span>';
    h+='<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:'+pCol+'22;color:'+pCol+';font-weight:600">'+t.priority.toUpperCase()+'</span>';
    h+='</div>';
    if(t.description)h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">'+esc(t.description).substring(0,120)+'</div>';
    h+='<div style="display:flex;gap:12px;font-size:10px;color:var(--text-muted)">';
    if(t.completedAt)h+='<span>Completed: '+t.completedAt.substring(0,10)+'</span>';
    if(t.project)h+='<span>Project: '+esc(t.project)+'</span>';
    if(t.timeTracked)h+='<span>Time: '+Math.round(t.timeTracked/60)+'min</span>';
    h+='</div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentCalendar(){
  let panel=document.getElementById('content-cal-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='content-cal-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  let viewMonth=now.getMonth(),viewYear=now.getFullYear();
  function render(){
    const first=new Date(viewYear,viewMonth,1);
    const startDay=first.getDay()||7;
    const daysInMonth=new Date(viewYear,viewMonth+1,0).getDate();
    const monthName=first.toLocaleString('default',{month:'long',year:'numeric'});
    // Group content by date
    const byDate={};
    (S.content||[]).forEach(c=>{
      if(!c.created)return;
      const d=c.created.substring(0,10);
      if(!byDate[d])byDate[d]=[];
      byDate[d].push(c);
    });
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
    h+='<span style="font-weight:700;font-size:15px;color:var(--text)">Content Calendar</span>';
    h+='<div style="display:flex;gap:8px;align-items:center">';
    h+='<button onclick="this.closest(\'#content-cal-panel\')._nav(-1)" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;padding:3px 8px;font-size:12px">&lt;</button>';
    h+='<span style="font-size:13px;color:var(--text);min-width:140px;text-align:center">'+monthName+'</span>';
    h+='<button onclick="this.closest(\'#content-cal-panel\')._nav(1)" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;padding:3px 8px;font-size:12px">&gt;</button>';
    h+='</div>';
    h+='<button onclick="this.closest(\'#content-cal-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;margin-bottom:4px">';
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{
      h+='<div style="text-align:center;font-size:10px;color:var(--text-muted);padding:4px">'+d+'</div>';
    });
    h+='</div>';
    h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px">';
    for(let i=1;i<startDay;i++)h+='<div style="background:var(--bg-surface);min-height:60px;padding:4px;border-radius:2px"></div>';
    for(let d=1;d<=daysInMonth;d++){
      const dateStr=viewYear+'-'+String(viewMonth+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
      const items=byDate[dateStr]||[];
      const isToday=dateStr===now.toISOString().substring(0,10);
      h+='<div style="background:var(--bg-surface);min-height:60px;padding:4px;border-radius:2px;'+(isToday?'border:1px solid var(--accent)':'')+'">';
      h+='<div style="font-size:10px;color:'+(isToday?'var(--accent)':'var(--text-muted)')+';font-weight:'+(isToday?'700':'400')+'">'+d+'</div>';
      items.slice(0,3).forEach(c=>{
        const themeCol=c.theme==='strategy'?'#3b82f6':c.theme==='creative'?'#a78bfa':c.theme==='technical'?'#4ade80':'#f59e0b';
        h+='<div style="font-size:8px;padding:1px 3px;background:'+themeCol+'22;color:'+themeCol+';border-radius:2px;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(c.title)+'</div>';
      });
      if(items.length>3)h+='<div style="font-size:8px;color:var(--text-muted)">+'+(items.length-3)+'</div>';
      h+='</div>';
    }
    h+='</div>';
    panel.innerHTML=h;
    panel._nav=function(dir){viewMonth+=dir;if(viewMonth>11){viewMonth=0;viewYear++;}if(viewMonth<0){viewMonth=11;viewYear--;}render();};
  }
  render();document.body.appendChild(panel);
}
function showFocusBreakdown(){
  let panel=document.getElementById('focus-breakdown-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='focus-breakdown-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.timeTracked&&t.timeTracked>0);
  const totalTime=tasks.reduce((a,t)=>a+t.timeTracked,0);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Focus Time Breakdown</span><button onclick="this.closest(\'#focus-breakdown-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Total tracked: '+Math.round(totalTime/60)+' minutes across '+tasks.length+' tasks</div>';
  if(!tasks.length){
    h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">No time tracked yet. Use the timer button in task detail modal.</div>';
  } else {
    // By project
    const byProject={};
    tasks.forEach(t=>{const p=t.project||'No Project';if(!byProject[p])byProject[p]=0;byProject[p]+=t.timeTracked;});
    const projEntries=Object.entries(byProject).sort((a,b)=>b[1]-a[1]);
    const projColors=['#4ade80','#3b82f6','#f59e0b','#ef4444','#a78bfa','#22d3ee','#f472b6','#84cc16'];
    h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">By Project</div>';
    // CSS conic gradient donut
    let gradParts=[];let cumPct=0;
    projEntries.forEach((e,i)=>{
      const pct=totalTime?e[1]/totalTime*100:0;
      const col=projColors[i%projColors.length];
      gradParts.push(col+' '+cumPct+'% '+(cumPct+pct)+'%');
      cumPct+=pct;
    });
    h+='<div style="display:flex;gap:16px;align-items:center;margin-bottom:16px">';
    h+='<div style="width:100px;height:100px;border-radius:50%;background:conic-gradient('+gradParts.join(',')+');flex-shrink:0;position:relative"><div style="position:absolute;top:25%;left:25%;width:50%;height:50%;border-radius:50%;background:var(--bg-elevated)"></div></div>';
    h+='<div style="flex:1">';
    projEntries.forEach((e,i)=>{
      const col=projColors[i%projColors.length];
      const pct=totalTime?Math.round(e[1]/totalTime*100):0;
      h+='<div style="display:flex;gap:6px;align-items:center;padding:2px 0"><span style="width:8px;height:8px;border-radius:2px;background:'+col+';flex-shrink:0"></span><span style="font-size:11px;color:var(--text);flex:1">'+esc(e[0])+'</span><span style="font-size:10px;color:var(--text-muted)">'+Math.round(e[1]/60)+'m ('+pct+'%)</span></div>';
    });
    h+='</div></div>';
    // By priority
    const byPri={'p0':0,'p1':0,'p2':0,'p3':0};
    tasks.forEach(t=>{const p=t.priority||'p3';byPri[p]=(byPri[p]||0)+t.timeTracked;});
    const priColors={'p0':'#ef4444','p1':'#f59e0b','p2':'#3b82f6','p3':'#6b7280'};
    h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">By Priority</div>';
    Object.entries(byPri).forEach(([p,time])=>{
      if(!time)return;
      const pct=totalTime?Math.round(time/totalTime*100):0;
      h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:4px">';
      h+='<span style="font-size:10px;color:'+priColors[p]+';font-weight:700;width:24px">'+p.toUpperCase()+'</span>';
      h+='<div style="flex:1;height:12px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:'+priColors[p]+';width:'+pct+'%"></div></div>';
      h+='<span style="font-size:10px;color:var(--text-muted);width:60px;text-align:right">'+Math.round(time/60)+'m</span>';
      h+='</div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showLinkCategoryManager(){
  let panel=document.getElementById('link-cat-mgr-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='link-cat-mgr-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  function render(){
    const cats={};
    (S.links||[]).forEach(l=>{const c=l.category||'Uncategorized';cats[c]=(cats[c]||0)+1;});
    const sorted=Object.entries(cats).sort((a,b)=>b[1]-a[1]);
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Link Categories</span><button onclick="this.closest(\'#link-cat-mgr-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+sorted.length+' categories, '+(S.links||[]).length+' total links</div>';
    sorted.forEach(([cat,count])=>{
      h+='<div style="padding:8px 10px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
      h+='<span style="flex:1;font-size:12px;color:var(--text)">'+esc(cat)+'</span>';
      h+='<span style="font-size:10px;color:var(--text-muted)">'+count+' links</span>';
      if(cat!=='Uncategorized'){
        h+='<button onclick="const n=prompt(\'Rename category:\',\''+esc(cat)+'\');if(!n||n===\''+esc(cat)+'\')return;(S.links||[]).forEach(l=>{if(l.category===\''+esc(cat)+'\')l.category=n;});save();this.closest(\'#link-cat-mgr-panel\')._render()" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px;padding:2px 6px">Rename</button>';
        h+='<button onclick="if(!confirm(\'Remove category from '+count+' links?\'))return;(S.links||[]).forEach(l=>{if(l.category===\''+esc(cat)+'\')l.category=\'\';});save();this.closest(\'#link-cat-mgr-panel\')._render()" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:#ef4444;cursor:pointer;font-size:9px;padding:2px 6px">Clear</button>';
      }
      h+='</div>';
    });
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showTaskAging(){
  let panel=document.getElementById('task-aging-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-aging-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  const open=(S.tasks||[]).filter(t=>t.status!=='done'&&t.created);
  const aged=open.map(t=>{
    const days=Math.floor((now-new Date(t.created))/86400000);
    return {...t,ageDays:days};
  }).sort((a,b)=>b.ageDays-a.ageDays);
  const buckets=[
    {label:'Fresh (0-3 days)',min:0,max:3,color:'#4ade80'},
    {label:'Young (4-7 days)',min:4,max:7,color:'#22d3ee'},
    {label:'Aging (8-14 days)',min:8,max:14,color:'#f59e0b'},
    {label:'Old (15-30 days)',min:15,max:30,color:'#ef4444'},
    {label:'Ancient (30+ days)',min:31,max:9999,color:'#dc2626'},
  ];
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Aging Report</span><button onclick="this.closest(\'#task-aging-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+open.length+' open tasks | Average age: '+(aged.length?Math.round(aged.reduce((a,t)=>a+t.ageDays,0)/aged.length):0)+' days</div>';
  // Bucket bars
  h+='<div style="margin-bottom:16px">';
  buckets.forEach(b=>{
    const count=aged.filter(t=>t.ageDays>=b.min&&t.ageDays<=b.max).length;
    const pct=open.length?Math.round(count/open.length*100):0;
    h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:4px">';
    h+='<span style="font-size:10px;color:'+b.color+';width:120px;flex-shrink:0">'+b.label+'</span>';
    h+='<div style="flex:1;height:14px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:'+b.color+';width:'+pct+'%"></div></div>';
    h+='<span style="font-size:10px;color:var(--text-muted);width:40px;text-align:right">'+count+'</span>';
    h+='</div>';
  });
  h+='</div>';
  // Oldest tasks
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Oldest Open Tasks</div>';
  aged.slice(0,15).forEach(t=>{
    const col=t.ageDays>30?'#dc2626':t.ageDays>14?'#ef4444':t.ageDays>7?'#f59e0b':'#4ade80';
    h+='<div style="padding:5px 10px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
    h+='<span style="font-size:10px;color:'+col+';font-weight:700;width:35px;flex-shrink:0">'+t.ageDays+'d</span>';
    h+='<span style="flex:1;font-size:11px;color:var(--text)">'+esc(t.title)+'</span>';
    h+='<span style="font-size:9px;color:var(--text-muted)">'+t.status+'</span>';
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDocOutline(){
  let panel=document.getElementById('doc-outline-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='doc-outline-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const docs=(S.writerDocs||[]).filter(d=>d.body&&d.body.length>50);
  let selDoc=docs.length?docs[0].id:'';
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Document Outline</span><button onclick="this.closest(\'#doc-outline-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<select onchange="this.closest(\'#doc-outline-panel\')._sel=this.value;this.closest(\'#doc-outline-panel\')._render()" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:10px">';
    docs.forEach(d=>{h+='<option value="'+d.id+'"'+(selDoc===d.id?' selected':'')+'>'+esc(d.title)+'</option>';});
    if(!docs.length)h+='<option>No documents</option>';
    h+='</select>';
    const doc=docs.find(d=>d.id===selDoc);
    if(doc&&doc.body){
      const lines=doc.body.split('\n');
      const headings=[];
      lines.forEach((line,i)=>{
        const m=line.match(/^(#{1,6})\s+(.+)/);
        if(m)headings.push({level:m[1].length,text:m[2],line:i+1});
      });
      if(headings.length){
        headings.forEach(hd=>{
          const indent=(hd.level-1)*16;
          const sz=Math.max(10,16-hd.level*1.5);
          h+='<div style="padding:4px 0 4px '+indent+'px;border-bottom:1px solid var(--border)">';
          h+='<span style="font-size:'+sz+'px;color:var(--text)">'+esc(hd.text)+'</span>';
          h+=' <span style="font-size:9px;color:var(--text-muted)">L'+hd.line+'</span>';
          h+='</div>';
        });
      } else {
        h+='<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:11px">No headings found. Use # Heading in your document.</div>';
      }
      const wc=doc.body.split(/\s+/).filter(Boolean).length;
      h+='<div style="margin-top:10px;font-size:10px;color:var(--text-muted)">'+wc+' words | '+lines.length+' lines | '+headings.length+' headings</div>';
    }
    panel.innerHTML=h;panel._render=render;panel._sel=selDoc;
  }
  render();document.body.appendChild(panel);
}
function showProjectComparison(){
  let panel=document.getElementById('proj-compare-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='proj-compare-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=(S.projects||[]);
  let selA=projects.length?projects[0].id:'';
  let selB=projects.length>1?projects[1].id:'';
  function getStats(pid){
    const p=projects.find(pr=>pr.id===pid);
    if(!p)return null;
    const tasks=(S.tasks||[]).filter(t=>t.projectId===pid||t.project===p.name);
    const done=tasks.filter(t=>t.status==='done').length;
    const content=(S.content||[]).filter(c=>c.project===p.name).length;
    const links=(S.links||[]).filter(l=>l.project===p.name).length;
    const docs=(S.writerDocs||[]).filter(d=>d.projectId===pid).length;
    return {name:p.name,tasks:tasks.length,done,active:tasks.length-done,content,links,docs,pct:tasks.length?Math.round(done/tasks.length*100):0};
  }
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Project Comparison</span><button onclick="this.closest(\'#proj-compare-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="display:flex;gap:12px;margin-bottom:12px">';
    h+='<select onchange="this.closest(\'#proj-compare-panel\')._selA=this.value;this.closest(\'#proj-compare-panel\')._render()" style="flex:1;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px">';
    projects.forEach(p=>{h+='<option value="'+p.id+'"'+(selA===p.id?' selected':'')+'>'+esc(p.name)+'</option>';});
    h+='</select>';
    h+='<span style="color:var(--text-muted);align-self:center;font-size:12px">vs</span>';
    h+='<select onchange="this.closest(\'#proj-compare-panel\')._selB=this.value;this.closest(\'#proj-compare-panel\')._render()" style="flex:1;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px">';
    projects.forEach(p=>{h+='<option value="'+p.id+'"'+(selB===p.id?' selected':'')+'>'+esc(p.name)+'</option>';});
    h+='</select></div>';
    const a=getStats(selA),b=getStats(selB);
    if(a&&b){
      const metrics=[
        {label:'Total Tasks',aVal:a.tasks,bVal:b.tasks},
        {label:'Completed',aVal:a.done,bVal:b.done},
        {label:'Active',aVal:a.active,bVal:b.active},
        {label:'Completion %',aVal:a.pct,bVal:b.pct},
        {label:'Content Items',aVal:a.content,bVal:b.content},
        {label:'Links',aVal:a.links,bVal:b.links},
        {label:'Documents',aVal:a.docs,bVal:b.docs},
      ];
      h+='<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:0">';
      h+='<div style="text-align:center;font-size:11px;font-weight:700;color:#4ade80;padding:6px">'+esc(a.name)+'</div>';
      h+='<div style="text-align:center;font-size:10px;color:var(--text-muted);padding:6px">Metric</div>';
      h+='<div style="text-align:center;font-size:11px;font-weight:700;color:#3b82f6;padding:6px">'+esc(b.name)+'</div>';
      metrics.forEach(m=>{
        const aWin=m.aVal>m.bVal,bWin=m.bVal>m.aVal;
        h+='<div style="text-align:center;font-size:13px;padding:6px;color:'+(aWin?'#4ade80':'var(--text)')+';font-weight:'+(aWin?'700':'400')+';border-bottom:1px solid var(--border)">'+m.aVal+'</div>';
        h+='<div style="text-align:center;font-size:10px;padding:6px;color:var(--text-muted);border-bottom:1px solid var(--border)">'+m.label+'</div>';
        h+='<div style="text-align:center;font-size:13px;padding:6px;color:'+(bWin?'#3b82f6':'var(--text)')+';font-weight:'+(bWin?'700':'400')+';border-bottom:1px solid var(--border)">'+m.bVal+'</div>';
      });
      h+='</div>';
    }
    panel.innerHTML=h;panel._render=render;panel._selA=selA;panel._selB=selB;
  }
  render();document.body.appendChild(panel);
}
function showQuickTask(){
  let panel=document.getElementById('quick-task-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-task-widget';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:300px';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:12px;color:var(--text)">Quick Task</span><button onclick="this.closest(\'#quick-task-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<input id="qt-title" placeholder="Task title..." style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:6px;box-sizing:border-box">';
  h+='<div style="display:flex;gap:6px;margin-bottom:6px">';
  h+='<select id="qt-pri" style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px">';
  ['p0','p1','p2','p3'].forEach(p=>{h+='<option value="'+p+'"'+(p==='p2'?' selected':'')+'>'+p.toUpperCase()+'</option>';});
  h+='</select>';
  h+='<select id="qt-status" style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px">';
  ['todo','in-progress','review'].forEach(s=>{h+='<option value="'+s+'">'+s+'</option>';});
  h+='</select>';
  h+='<input id="qt-due" type="date" style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px">';
  h+='</div>';
  h+='<button onclick="const title=document.getElementById(\'qt-title\').value.trim();if(!title)return;if(!S.tasks)S.tasks=[];S.tasks.push({id:\'t_\'+Date.now(),title:title,description:\'\',status:document.getElementById(\'qt-status\').value,priority:document.getElementById(\'qt-pri\').value,due:document.getElementById(\'qt-due\').value||null,project:\'\',tags:[],subtasks:[],created:new Date().toISOString()});save();document.getElementById(\'qt-title\').value=\'\';if(typeof renderTasks===\'function\')renderTasks();" style="width:100%;padding:6px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Add Task</button>';
  h+='<div style="margin-top:6px;font-size:10px;color:var(--text-muted)">'+(S.tasks||[]).filter(t=>t.status!=='done').length+' active tasks</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('qt-title').addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();this.closest('#quick-task-widget').querySelector('button:last-of-type').click();}});
}
function showContentNetwork(){
  let panel=document.getElementById('content-network-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='content-network-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]).filter(c=>c.tags&&c.tags.length);
  // Build tag-based connections
  const tagMap={};
  content.forEach(c=>{
    (c.tags||[]).forEach(tag=>{
      if(!tagMap[tag])tagMap[tag]=[];
      tagMap[tag].push(c);
    });
  });
  const connections=[];
  const seen=new Set();
  Object.entries(tagMap).forEach(([tag,items])=>{
    for(let i=0;i<items.length;i++){
      for(let j=i+1;j<items.length;j++){
        const key=items[i].id+'|'+items[j].id;
        if(seen.has(key))continue;
        seen.add(key);
        connections.push({a:items[i],b:items[j],tag});
      }
    }
  });
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Content Network</span><button onclick="this.closest(\'#content-network-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+content.length+' tagged items | '+Object.keys(tagMap).length+' tags | '+connections.length+' connections</div>';
  // Top connected tags
  const tagCounts=Object.entries(tagMap).sort((a,b)=>b[1].length-a[1].length).slice(0,10);
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Hub Tags (most connected)</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">';
  tagCounts.forEach(([tag,items])=>{
    const size=Math.max(10,Math.min(16,8+items.length*2));
    h+='<span style="font-size:'+size+'px;padding:3px 8px;background:#4ade8022;color:#4ade80;border-radius:var(--radius)">'+esc(tag)+' ('+items.length+')</span>';
  });
  h+='</div>';
  // Connections list
  if(connections.length){
    h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Connections ('+connections.length+')</div>';
    connections.slice(0,30).forEach(c=>{
      h+='<div style="padding:4px 8px;border-bottom:1px solid var(--border);font-size:11px;display:flex;gap:6px;align-items:center">';
      h+='<span style="color:var(--text)">'+esc(c.a.title)+'</span>';
      h+='<span style="color:#4ade80;font-size:9px;padding:1px 5px;background:#4ade8022;border-radius:3px">'+esc(c.tag)+'</span>';
      h+='<span style="color:var(--text)">'+esc(c.b.title)+'</span>';
      h+='</div>';
    });
    if(connections.length>30)h+='<div style="font-size:10px;color:var(--text-muted);padding:6px">+'+(connections.length-30)+' more connections</div>';
  } else {
    h+='<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:11px">No content connections. Add tags to content items to see their network.</div>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showWeeklyPlanner(){
  let panel=document.getElementById('weekly-planner-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='weekly-planner-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:800px;width:95vw;max-height:85vh;overflow-y:auto';
  const now=new Date();
  const monday=new Date(now);monday.setDate(now.getDate()-(now.getDay()||7)+1);monday.setHours(0,0,0,0);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Weekly Planner</span><button onclick="this.closest(\'#weekly-planner-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">';
  const dayNames=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  for(let i=0;i<7;i++){
    const day=new Date(monday);day.setDate(monday.getDate()+i);
    const dateStr=day.toISOString().substring(0,10);
    const isToday=dateStr===now.toISOString().substring(0,10);
    const dayTasks=(S.tasks||[]).filter(t=>t.due&&t.due.substring(0,10)===dateStr&&t.status!=='done');
    const doneTasks=(S.tasks||[]).filter(t=>t.due&&t.due.substring(0,10)===dateStr&&t.status==='done');
    h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:8px;min-height:150px;'+(isToday?'border:1px solid var(--accent)':'border:1px solid var(--border)')+'">';
    h+='<div style="font-size:10px;font-weight:700;color:'+(isToday?'var(--accent)':'var(--text-muted)')+';margin-bottom:6px">'+dayNames[i]+' '+day.getDate()+'</div>';
    dayTasks.forEach(t=>{
      const pCol=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
      h+='<div style="padding:3px 6px;margin-bottom:3px;background:'+pCol+'15;border-left:2px solid '+pCol+';border-radius:2px;font-size:10px;color:var(--text)">'+esc(t.title)+'</div>';
    });
    doneTasks.forEach(t=>{
      h+='<div style="padding:3px 6px;margin-bottom:3px;background:var(--bg-elevated);border-radius:2px;font-size:10px;color:var(--text-muted);text-decoration:line-through">'+esc(t.title)+'</div>';
    });
    if(!dayTasks.length&&!doneTasks.length){
      h+='<div style="font-size:9px;color:var(--text-muted);font-style:italic;padding:4px 0">No tasks</div>';
    }
    h+='</div>';
  }
  h+='</div>';
  // Unscheduled tasks
  const unscheduled=(S.tasks||[]).filter(t=>t.status!=='done'&&!t.due);
  if(unscheduled.length){
    h+='<div style="margin-top:12px;font-size:11px;font-weight:700;color:var(--text)">Unscheduled ('+unscheduled.length+')</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px">';
    unscheduled.slice(0,12).forEach(t=>{
      h+='<span style="font-size:10px;padding:3px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text)">'+esc(t.title)+'</span>';
    });
    if(unscheduled.length>12)h+='<span style="font-size:10px;color:var(--text-muted);padding:3px">+'+(unscheduled.length-12)+' more</span>';
    h+='</div>';
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickSearch(){
  let panel=document.getElementById('quick-search-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-search-widget';
  panel.style.cssText='position:fixed;top:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:320px';
  function render(q){
    q=q||'';
    const ql=q.toLowerCase();
    let results=[];
    if(ql.length>=2){
      (S.tasks||[]).forEach(t=>{if((t.title||'').toLowerCase().includes(ql))results.push({type:'Task',text:t.title,extra:t.status});});
      (S.content||[]).forEach(c=>{if((c.title||'').toLowerCase().includes(ql))results.push({type:'Content',text:c.title,extra:c.theme||''});});
      (S.links||[]).forEach(l=>{if(((l.title||'')+(l.url||'')).toLowerCase().includes(ql))results.push({type:'Link',text:l.title||l.url,extra:l.category||''});});
      (S.writerDocs||[]).forEach(d=>{if((d.title||'').toLowerCase().includes(ql))results.push({type:'Doc',text:d.title,extra:''});});
    }
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:12px;color:var(--text)">Quick Search</span><button onclick="this.closest(\'#quick-search-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    h+='<input id="qs-input" value="'+esc(q)+'" placeholder="Type to search..." oninput="this.closest(\'#quick-search-widget\')._render(this.value)" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;box-sizing:border-box;margin-bottom:6px">';
    if(results.length){
      h+='<div style="max-height:250px;overflow-y:auto">';
      const typeCols={Task:'#4ade80',Content:'#60a5fa',Link:'#f59e0b',Doc:'#a78bfa'};
      results.slice(0,15).forEach(r=>{
        h+='<div style="padding:4px 6px;border-bottom:1px solid var(--border);display:flex;gap:6px;align-items:center">';
        h+='<span style="font-size:8px;padding:1px 4px;border-radius:2px;background:'+(typeCols[r.type]||'#6b7280')+'22;color:'+(typeCols[r.type]||'#6b7280')+'">'+r.type+'</span>';
        h+='<span style="flex:1;font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(r.text)+'</span>';
        if(r.extra)h+='<span style="font-size:9px;color:var(--text-muted)">'+esc(r.extra)+'</span>';
        h+='</div>';
      });
      if(results.length>15)h+='<div style="font-size:10px;color:var(--text-muted);padding:4px">+'+(results.length-15)+' more</div>';
      h+='</div>';
    } else if(ql.length>=2){
      h+='<div style="font-size:11px;color:var(--text-muted);padding:10px;text-align:center">No results</div>';
    }
    panel.innerHTML=h;panel._render=render;
    const inp=panel.querySelector('#qs-input');if(inp){inp.focus();inp.setSelectionRange(q.length,q.length);}
  }
  render('');document.body.appendChild(panel);
}
function showWriterStats(){
  let panel=document.getElementById('writer-stats-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='writer-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const docs=(S.writerDocs||[]);
  const totalWords=docs.reduce((a,d)=>{return a+(d.body||'').split(/\s+/).filter(Boolean).length;},0);
  const totalChars=docs.reduce((a,d)=>{return a+(d.body||'').length;},0);
  const avgWords=docs.length?Math.round(totalWords/docs.length):0;
  const longest=docs.reduce((best,d)=>{const wc=(d.body||'').split(/\s+/).filter(Boolean).length;return wc>best.wc?{title:d.title,wc}:best;},{title:'',wc:0});
  // Docs by day of week
  const dayBuckets=[0,0,0,0,0,0,0];
  docs.forEach(d=>{
    if(d.created){const day=new Date(d.created).getDay();dayBuckets[day]++;}
  });
  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const maxDay=Math.max(...dayBuckets)||1;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Writer Statistics</span><button onclick="this.closest(\'#writer-stats-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  // Key metrics
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  const metrics=[
    {label:'Documents',val:docs.length,color:'#4ade80'},
    {label:'Total Words',val:totalWords.toLocaleString(),color:'#3b82f6'},
    {label:'Avg Words',val:avgWords,color:'#f59e0b'},
    {label:'Total Chars',val:totalChars.toLocaleString(),color:'#a78bfa'},
  ];
  metrics.forEach(m=>{
    h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:10px;text-align:center;border-top:2px solid '+m.color+'">';
    h+='<div style="font-size:18px;font-weight:700;color:'+m.color+'">'+m.val+'</div>';
    h+='<div style="font-size:9px;color:var(--text-muted)">'+m.label+'</div>';
    h+='</div>';
  });
  h+='</div>';
  if(longest.title){
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Longest doc: "'+esc(longest.title)+'" ('+longest.wc+' words)</div>';
  }
  // Day of week chart
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Docs Created by Day</div>';
  h+='<div style="display:flex;gap:4px;align-items:end;height:60px;margin-bottom:12px">';
  dayBuckets.forEach((count,i)=>{
    const pct=Math.round(count/maxDay*100);
    h+='<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%">';
    h+='<div style="font-size:8px;color:var(--text-muted);margin-bottom:2px">'+count+'</div>';
    h+='<div style="width:100%;background:#4ade80;border-radius:2px 2px 0 0;height:'+Math.max(2,pct)+'%"></div>';
    h+='<div style="font-size:8px;color:var(--text-muted);margin-top:2px">'+dayNames[i]+'</div>';
    h+='</div>';
  });
  h+='</div>';
  // Version count
  const totalVersions=docs.reduce((a,d)=>a+(d.versions||[]).length,0);
  h+='<div style="font-size:11px;color:var(--text-muted)">'+totalVersions+' total versions saved across all docs</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskVelocity(){
  let panel=document.getElementById('task-velocity-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-velocity-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();
  const weeks=[];
  for(let w=7;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay()-w*7);weekStart.setHours(0,0,0,0);
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekStart.getDate()+7);
    const completed=(S.tasks||[]).filter(t=>t.completedAt&&t.completedAt>=weekStart.toISOString()&&t.completedAt<weekEnd.toISOString()).length;
    const created=(S.tasks||[]).filter(t=>t.created&&t.created>=weekStart.toISOString()&&t.created<weekEnd.toISOString()).length;
    weeks.push({label:weekStart.toISOString().substring(5,10),completed,created});
  }
  const maxVal=Math.max(...weeks.map(w=>Math.max(w.completed,w.created)),1);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Velocity</span><button onclick="this.closest(\'#task-velocity-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Tasks completed vs created per week (last 8 weeks)</div>';
  // SVG bar chart
  const svgW=540,svgH=150,barW=25,gap=40;
  h+='<svg width="100%" viewBox="0 0 '+svgW+' '+(svgH+30)+'" style="margin-bottom:12px">';
  weeks.forEach((w,i)=>{
    const x=20+i*(barW*2+gap);
    const cH=Math.round(w.completed/maxVal*svgH);
    const crH=Math.round(w.created/maxVal*svgH);
    h+='<rect x="'+x+'" y="'+(svgH-cH)+'" width="'+barW+'" height="'+cH+'" fill="#4ade80" rx="2"/>';
    h+='<rect x="'+(x+barW+2)+'" y="'+(svgH-crH)+'" width="'+barW+'" height="'+crH+'" fill="#3b82f6" rx="2"/>';
    h+='<text x="'+(x+barW)+'" y="'+(svgH+14)+'" text-anchor="middle" fill="#888" font-size="9">'+w.label+'</text>';
    if(w.completed)h+='<text x="'+(x+barW/2)+'" y="'+(svgH-cH-4)+'" text-anchor="middle" fill="#4ade80" font-size="9">'+w.completed+'</text>';
    if(w.created)h+='<text x="'+(x+barW+2+barW/2)+'" y="'+(svgH-crH-4)+'" text-anchor="middle" fill="#3b82f6" font-size="9">'+w.created+'</text>';
  });
  h+='</svg>';
  h+='<div style="display:flex;gap:16px;font-size:10px">';
  h+='<span style="color:#4ade80">Green = Completed</span>';
  h+='<span style="color:#3b82f6">Blue = Created</span>';
  const avgVelocity=weeks.length?Math.round(weeks.reduce((a,w)=>a+w.completed,0)/weeks.length*10)/10:0;
  h+='<span style="color:var(--text-muted)">Avg velocity: '+avgVelocity+'/week</span>';
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickCaptureDashboard(){
  let panel=document.getElementById('capture-dash-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='capture-dash-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const captures=(S.captures||[]);
  const byType={};
  captures.forEach(c=>{const t=c.type||'text';if(!byType[t])byType[t]=[];byType[t].push(c);});
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Quick Captures</span><button onclick="this.closest(\'#capture-dash-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+captures.length+' captures | '+Object.keys(byType).length+' types</div>';
  if(!captures.length){
    h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">No captures yet. Use Quick Capture (lightning bolt) or Nexus Capture extension.</div>';
  }
  const typeColors={text:'#4ade80',idea:'#f59e0b',link:'#3b82f6',quote:'#a78bfa',code:'#22d3ee',todo:'#ef4444',note:'#f472b6'};
  Object.entries(byType).sort((a,b)=>b[1].length-a[1].length).forEach(([type,items])=>{
    const col=typeColors[type]||'#6b7280';
    h+='<div style="margin-bottom:10px">';
    h+='<div style="font-size:11px;font-weight:700;color:'+col+';padding:4px 0;border-bottom:1px solid var(--border);text-transform:uppercase">'+type+' ('+items.length+')</div>';
    items.slice(0,5).forEach(c=>{
      const preview=(c.text||c.body||c.title||'').substring(0,100);
      h+='<div style="padding:5px 8px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text)">'+esc(preview);
      if(c.created)h+=' <span style="font-size:9px;color:var(--text-muted)">'+c.created.substring(0,10)+'</span>';
      h+='</div>';
    });
    if(items.length>5)h+='<div style="font-size:10px;color:var(--text-muted);padding:4px">+'+(items.length-5)+' more</div>';
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showThemeAnalyzer(){
  let panel=document.getElementById('theme-analyzer-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='theme-analyzer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const content=(S.content||[]);
  const byTheme={};
  content.forEach(c=>{
    const theme=c.theme||'untagged';
    if(!byTheme[theme])byTheme[theme]={count:0,words:0,items:[]};
    byTheme[theme].count++;
    byTheme[theme].words+=(c.body||'').split(/\s+/).filter(Boolean).length;
    byTheme[theme].items.push(c);
  });
  const sorted=Object.entries(byTheme).sort((a,b)=>b[1].count-a[1].count);
  const totalWords=sorted.reduce((a,e)=>a+e[1].words,0)||1;
  const themeColors={strategy:'#3b82f6',creative:'#a78bfa',technical:'#4ade80',personal:'#f472b6',business:'#f59e0b',research:'#22d3ee',untagged:'#6b7280'};
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Theme Analyzer</span><button onclick="this.closest(\'#theme-analyzer-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+content.length+' items | '+sorted.length+' themes | '+totalWords+' total words</div>';
  sorted.forEach(([theme,data])=>{
    const col=themeColors[theme]||'#6b7280';
    const pct=Math.round(data.words/totalWords*100);
    h+='<div style="margin-bottom:10px">';
    h+='<div style="display:flex;justify-content:space-between;margin-bottom:3px">';
    h+='<span style="font-size:12px;font-weight:600;color:'+col+'">'+esc(theme)+'</span>';
    h+='<span style="font-size:10px;color:var(--text-muted)">'+data.count+' items | '+data.words.toLocaleString()+' words ('+pct+'%)</span>';
    h+='</div>';
    h+='<div style="height:12px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:'+col+';width:'+pct+'%"></div></div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:4px">';
    data.items.slice(0,4).forEach(c=>{
      h+='<span style="font-size:9px;padding:1px 5px;background:'+col+'15;color:'+col+';border-radius:2px">'+esc(c.title).substring(0,30)+'</span>';
    });
    if(data.items.length>4)h+='<span style="font-size:9px;color:var(--text-muted)">+'+(data.items.length-4)+'</span>';
    h+='</div></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectNotes(){
  let panel=document.getElementById('proj-notes-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='proj-notes-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._projectNotes)S._projectNotes={};
  const projects=(S.projects||[]);
  let selProj=projects.length?projects[0].id:'';
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Project Notes</span><button onclick="this.closest(\'#proj-notes-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<select onchange="this.closest(\'#proj-notes-panel\')._sel=this.value;this.closest(\'#proj-notes-panel\')._render()" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:8px">';
    projects.forEach(p=>{h+='<option value="'+p.id+'"'+(selProj===p.id?' selected':'')+'>'+esc(p.name)+'</option>';});
    h+='</select>';
    const note=S._projectNotes[selProj]||'';
    h+='<textarea id="pn-textarea" style="width:100%;height:200px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:12px;resize:vertical;box-sizing:border-box;font-family:inherit;line-height:1.5" placeholder="Project notes, ideas, reminders...">'+esc(note)+'</textarea>';
    h+='<div style="display:flex;justify-content:space-between;margin-top:8px">';
    h+='<span style="font-size:10px;color:var(--text-muted)">'+(note.split(/\s+/).filter(Boolean).length)+' words</span>';
    h+='<button onclick="S._projectNotes[this.closest(\'#proj-notes-panel\')._sel]=document.getElementById(\'pn-textarea\').value;save();this.textContent=\'Saved!\';setTimeout(()=>this.textContent=\'Save\',1000)" style="padding:4px 12px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Save</button>';
    h+='</div>';
    panel.innerHTML=h;panel._render=render;panel._sel=selProj;
  }
  render();document.body.appendChild(panel);
}
function showQuickGoal(){
  let panel=document.getElementById('quick-goal-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-goal-widget';
  panel.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px';
  if(!S._dailyGoals)S._dailyGoals={};
  const today=new Date().toISOString().substring(0,10);
  if(!S._dailyGoals[today])S._dailyGoals[today]={tasks:0,words:0,target_tasks:3,target_words:500};
  const g=S._dailyGoals[today];
  // Count today's completed tasks
  const todayDone=(S.tasks||[]).filter(t=>t.completedAt&&t.completedAt.substring(0,10)===today).length;
  g.tasks=todayDone;
  function render(){
    const taskPct=Math.min(100,Math.round(g.tasks/Math.max(1,g.target_tasks)*100));
    const wordPct=Math.min(100,Math.round(g.words/Math.max(1,g.target_words)*100));
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:12px;color:var(--text)">Daily Goals</span><button onclick="this.closest(\'#quick-goal-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">'+today+'</div>';
    // Tasks goal
    h+='<div style="margin-bottom:8px">';
    h+='<div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px"><span style="color:var(--text)">Tasks completed</span><span style="color:#4ade80">'+g.tasks+'/'+g.target_tasks+'</span></div>';
    h+='<div style="height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden"><div style="height:100%;background:#4ade80;width:'+taskPct+'%;transition:width 0.3s"></div></div>';
    h+='</div>';
    // Words goal
    h+='<div style="margin-bottom:8px">';
    h+='<div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px"><span style="color:var(--text)">Words written</span><span style="color:#3b82f6">'+g.words+'/'+g.target_words+'</span></div>';
    h+='<div style="height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden"><div style="height:100%;background:#3b82f6;width:'+wordPct+'%;transition:width 0.3s"></div></div>';
    h+='<div style="display:flex;gap:4px;margin-top:4px">';
    [100,250,500].forEach(n=>{
      h+='<button onclick="S._dailyGoals[\''+today+'\'].words+='+n+';save();this.closest(\'#quick-goal-widget\')._render()" style="flex:1;padding:2px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px">+'+n+'</button>';
    });
    h+='</div></div>';
    // Targets
    h+='<div style="display:flex;gap:6px;margin-top:6px">';
    h+='<div style="flex:1"><span style="font-size:9px;color:var(--text-muted)">Task target</span><input type="number" value="'+g.target_tasks+'" min="1" onchange="S._dailyGoals[\''+today+'\'].target_tasks=+this.value;save();this.closest(\'#quick-goal-widget\')._render()" style="width:100%;padding:3px 5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px;box-sizing:border-box"></div>';
    h+='<div style="flex:1"><span style="font-size:9px;color:var(--text-muted)">Word target</span><input type="number" value="'+g.target_words+'" min="1" step="100" onchange="S._dailyGoals[\''+today+'\'].target_words=+this.value;save();this.closest(\'#quick-goal-widget\')._render()" style="width:100%;padding:3px 5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px;box-sizing:border-box"></div>';
    h+='</div>';
    panel.innerHTML=h;panel._render=render;
  }
  render();save();document.body.appendChild(panel);
}
function showStatusBoard(){
  let panel=document.getElementById('status-board-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='status-board-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const statuses=['todo','in-progress','review','blocked','done'];
  const statusColors={'todo':'#6b7280','in-progress':'#f59e0b','review':'#3b82f6','blocked':'#ef4444','done':'#4ade80'};
  const total=tasks.length||1;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Status Board</span><button onclick="this.closest(\'#status-board-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+tasks.length+' total tasks</div>';
  // Stacked bar at top
  h+='<div style="display:flex;height:20px;border-radius:var(--radius);overflow:hidden;margin-bottom:16px">';
  statuses.forEach(s=>{
    const count=tasks.filter(t=>t.status===s).length;
    const pct=Math.round(count/total*100);
    if(pct>0)h+='<div style="width:'+pct+'%;background:'+statusColors[s]+';display:flex;align-items:center;justify-content:center;font-size:8px;color:#000;font-weight:700">'+(pct>=8?pct+'%':'')+'</div>';
  });
  h+='</div>';
  // Columns
  h+='<div style="display:grid;grid-template-columns:repeat('+statuses.length+',1fr);gap:8px">';
  statuses.forEach(s=>{
    const col=statusColors[s];
    const items=tasks.filter(t=>t.status===s);
    h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:8px;border-top:3px solid '+col+'">';
    h+='<div style="font-size:10px;font-weight:700;color:'+col+';text-transform:uppercase;margin-bottom:4px">'+s+'</div>';
    h+='<div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:6px">'+items.length+'</div>';
    items.slice(0,4).forEach(t=>{
      h+='<div style="font-size:9px;color:var(--text-muted);padding:2px 0;border-bottom:1px solid var(--border);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(t.title)+'</div>';
    });
    if(items.length>4)h+='<div style="font-size:9px;color:var(--text-muted);margin-top:2px">+'+(items.length-4)+' more</div>';
    h+='</div>';
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showDocWordHistory(){
  let panel=document.getElementById('doc-word-hist-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='doc-word-hist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const docs=(S.writerDocs||[]).filter(d=>d.versions&&d.versions.length);
  let selDoc=docs.length?docs[0].id:'';
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Document Word History</span><button onclick="this.closest(\'#doc-word-hist-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<select onchange="this.closest(\'#doc-word-hist-panel\')._sel=this.value;this.closest(\'#doc-word-hist-panel\')._render()" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:10px">';
    docs.forEach(d=>{h+='<option value="'+d.id+'"'+(selDoc===d.id?' selected':'')+'>'+esc(d.title)+' ('+d.versions.length+' versions)</option>';});
    if(!docs.length)h+='<option>No docs with versions</option>';
    h+='</select>';
    const doc=docs.find(d=>d.id===selDoc);
    if(doc&&doc.versions&&doc.versions.length){
      const points=doc.versions.map(v=>({date:v.savedAt||'',wc:(v.body||'').split(/\s+/).filter(Boolean).length}));
      const currentWc=(doc.body||'').split(/\s+/).filter(Boolean).length;
      points.push({date:new Date().toISOString(),wc:currentWc});
      const maxWc=Math.max(...points.map(p=>p.wc),1);
      // SVG line chart
      const svgW=520,svgH=120;
      h+='<svg width="100%" viewBox="0 0 '+svgW+' '+(svgH+20)+'" style="margin-bottom:8px">';
      h+='<rect x="0" y="0" width="'+svgW+'" height="'+svgH+'" fill="none" stroke="var(--border)" stroke-width="0.5" rx="3"/>';
      let pathD='';
      points.forEach((p,i)=>{
        const x=Math.round(i/(points.length-1||1)*svgW);
        const y=svgH-Math.round(p.wc/maxWc*svgH);
        pathD+=(i===0?'M':'L')+x+','+y;
        h+='<circle cx="'+x+'" cy="'+y+'" r="3" fill="#4ade80"/>';
      });
      h+='<path d="'+pathD+'" fill="none" stroke="#4ade80" stroke-width="2"/>';
      // Labels
      h+='<text x="5" y="'+(svgH+14)+'" fill="#888" font-size="9">v1</text>';
      h+='<text x="'+(svgW-20)+'" y="'+(svgH+14)+'" fill="#888" font-size="9">v'+points.length+'</text>';
      h+='<text x="'+(svgW-60)+'" y="12" fill="#4ade80" font-size="9">'+currentWc+' words</text>';
      h+='</svg>';
      // Version list
      h+='<div style="font-size:10px;color:var(--text-muted)">';
      points.forEach((p,i)=>{
        h+='<span>v'+(i+1)+': '+p.wc+'w</span>';
        if(i<points.length-1)h+=' > ';
      });
      h+='</div>';
    } else {
      h+='<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:11px">Select a document with saved versions to see word count progression.</div>';
    }
    panel.innerHTML=h;panel._render=render;panel._sel=selDoc;
  }
  render();document.body.appendChild(panel);
}
function showQuickBookmarkbar(){
  let panel=document.getElementById('quick-bmbar-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-bmbar-widget';
  panel.style.cssText='position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:8px 14px;box-shadow:0 4px 16px rgba(0,0,0,0.5);display:flex;gap:8px;align-items:center;max-width:90vw;overflow-x:auto';
  const links=(S.links||[]).filter(l=>l.pinned).slice(0,8);
  const fallback=(S.links||[]).slice(0,8);
  const items=links.length?links:fallback;
  let h='<span style="font-size:10px;color:var(--text-muted);font-weight:600;flex-shrink:0">Links:</span>';
  items.forEach(l=>{
    const title=(l.title||l.url||'').substring(0,20);
    h+='<a href="'+esc(l.url)+'" target="_blank" rel="noopener" style="font-size:10px;color:var(--accent);text-decoration:none;padding:3px 8px;background:var(--bg-surface);border-radius:var(--radius);white-space:nowrap;flex-shrink:0">'+esc(title)+'</a>';
  });
  h+='<button onclick="this.closest(\'#quick-bmbar-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px;flex-shrink:0;padding:0 4px">X</button>';
  if(!items.length)h='<span style="font-size:10px;color:var(--text-muted)">No links saved yet</span><button onclick="this.closest(\'#quick-bmbar-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px;padding:0 4px">X</button>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskDistribution(){
  let panel=document.getElementById('task-dist-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-dist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const total=tasks.length||1;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Distribution</span><button onclick="this.closest(\'#task-dist-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+tasks.length+' total tasks</div>';
  // By Priority
  const priColors={'p0':'#ef4444','p1':'#f59e0b','p2':'#3b82f6','p3':'#6b7280'};
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">By Priority</div>';
  h+='<div style="display:flex;height:24px;border-radius:var(--radius);overflow:hidden;margin-bottom:12px">';
  Object.entries(priColors).forEach(([p,col])=>{
    const count=tasks.filter(t=>t.priority===p).length;
    const pct=Math.round(count/total*100);
    if(pct>0)h+='<div title="'+p.toUpperCase()+': '+count+'" style="width:'+pct+'%;background:'+col+';display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;font-weight:700">'+(pct>=10?p.toUpperCase()+' '+count:'')+'</div>';
  });
  h+='</div>';
  // By Project
  const byProject={};
  tasks.forEach(t=>{const p=t.project||'No Project';byProject[p]=(byProject[p]||0)+1;});
  const projSorted=Object.entries(byProject).sort((a,b)=>b[1]-a[1]);
  const projColors=['#4ade80','#3b82f6','#f59e0b','#a78bfa','#22d3ee','#f472b6','#84cc16','#ef4444'];
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">By Project</div>';
  projSorted.forEach((e,i)=>{
    const pct=Math.round(e[1]/total*100);
    const col=projColors[i%projColors.length];
    h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:4px">';
    h+='<span style="font-size:10px;color:var(--text);width:100px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(e[0])+'</span>';
    h+='<div style="flex:1;height:14px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:'+col+';width:'+pct+'%"></div></div>';
    h+='<span style="font-size:10px;color:var(--text-muted);width:40px;text-align:right">'+e[1]+'</span>';
    h+='</div>';
  });
  // By Status
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-top:12px;margin-bottom:6px">By Status</div>';
  const statusColors={'todo':'#6b7280','in-progress':'#f59e0b','review':'#3b82f6','blocked':'#ef4444','done':'#4ade80'};
  h+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
  Object.entries(statusColors).forEach(([s,col])=>{
    const count=tasks.filter(t=>t.status===s).length;
    h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:8px 12px;text-align:center;border-top:2px solid '+col+'">';
    h+='<div style="font-size:16px;font-weight:700;color:'+col+'">'+count+'</div>';
    h+='<div style="font-size:9px;color:var(--text-muted)">'+s+'</div>';
    h+='</div>';
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showContentArchive(){
  let panel=document.getElementById('content-archive-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='content-archive-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._contentArchive)S._contentArchive=[];
  function render(){
    const active=(S.content||[]);
    const archived=S._contentArchive;
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Content Archive</span><button onclick="this.closest(\'#content-archive-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+active.length+' active | '+archived.length+' archived</div>';
    // Active items to archive
    h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Active Content</div>';
    if(!active.length)h+='<div style="font-size:10px;color:var(--text-muted);padding:8px">No active content</div>';
    active.slice(0,20).forEach(c=>{
      h+='<div style="padding:5px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
      h+='<span style="flex:1;font-size:11px;color:var(--text)">'+esc(c.title)+'</span>';
      h+='<button onclick="if(!S._contentArchive)S._contentArchive=[];const idx=(S.content||[]).findIndex(x=>x.id===\''+c.id+'\');if(idx>=0){S._contentArchive.push(S.content.splice(idx,1)[0]);save();this.closest(\'#content-archive-panel\')._render()}" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px;padding:2px 6px">Archive</button>';
      h+='</div>';
    });
    // Archived items to restore
    if(archived.length){
      h+='<div style="font-size:11px;font-weight:700;color:#f59e0b;margin-top:12px;margin-bottom:6px">Archived</div>';
      archived.forEach((c,i)=>{
        h+='<div style="padding:5px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
        h+='<span style="flex:1;font-size:11px;color:var(--text-muted)">'+esc(c.title)+'</span>';
        h+='<button onclick="if(!S.content)S.content=[];S.content.push(S._contentArchive.splice('+i+',1)[0]);save();this.closest(\'#content-archive-panel\')._render()" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:#4ade80;cursor:pointer;font-size:9px;padding:2px 6px">Restore</button>';
        h+='</div>';
      });
    }
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showSessionTracker(){
  let panel=document.getElementById('session-tracker-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='session-tracker-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._sessions)S._sessions=[];
  if(!S._activeSession)S._activeSession=null;
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Session Tracker</span><button onclick="this.closest(\'#session-tracker-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    if(S._activeSession){
      const elapsed=Math.round((Date.now()-new Date(S._activeSession.start).getTime())/60000);
      h+='<div style="background:#4ade8015;border:1px solid #4ade80;border-radius:var(--radius);padding:12px;margin-bottom:12px">';
      h+='<div style="font-size:12px;font-weight:700;color:#4ade80;margin-bottom:4px">Session Active</div>';
      h+='<div style="font-size:20px;font-weight:700;color:var(--text)">'+elapsed+' min</div>';
      if(S._activeSession.label)h+='<div style="font-size:10px;color:var(--text-muted);margin-top:2px">'+esc(S._activeSession.label)+'</div>';
      h+='<button onclick="S._sessions.unshift({...S._activeSession,end:new Date().toISOString(),duration:'+elapsed+'});S._activeSession=null;if(S._sessions.length>50)S._sessions.length=50;save();this.closest(\'#session-tracker-panel\')._render()" style="margin-top:8px;padding:4px 12px;background:#ef4444;color:#fff;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px">Stop Session</button>';
      h+='</div>';
    } else {
      h+='<div style="margin-bottom:12px">';
      h+='<input id="st-label" placeholder="Session label (optional)" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:6px;box-sizing:border-box">';
      h+='<button onclick="S._activeSession={start:new Date().toISOString(),label:document.getElementById(\'st-label\').value.trim()};save();this.closest(\'#session-tracker-panel\')._render()" style="width:100%;padding:6px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Start Session</button>';
      h+='</div>';
    }
    // Session history
    if(S._sessions.length){
      h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">History ('+S._sessions.length+')</div>';
      const totalMin=S._sessions.reduce((a,s)=>a+(s.duration||0),0);
      h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">Total: '+Math.round(totalMin/60*10)/10+'h ('+totalMin+'min)</div>';
      S._sessions.slice(0,15).forEach(s=>{
        h+='<div style="padding:5px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
        h+='<span style="font-size:10px;color:var(--text-muted);width:60px;flex-shrink:0">'+(s.start||'').substring(5,10)+'</span>';
        h+='<span style="flex:1;font-size:11px;color:var(--text)">'+(s.label||'Unnamed')+'</span>';
        h+='<span style="font-size:10px;color:#4ade80;font-weight:600">'+(s.duration||0)+'min</span>';
        h+='</div>';
      });
    }
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showLinkExplorer(){
  let panel=document.getElementById('link-explorer-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='link-explorer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  const links=(S.links||[]);
  // Group by domain
  const byDomain={};
  links.forEach(l=>{
    let domain='other';
    try{domain=new URL(l.url).hostname.replace('www.','');}catch(e){}
    if(!byDomain[domain])byDomain[domain]=[];
    byDomain[domain].push(l);
  });
  const sorted=Object.entries(byDomain).sort((a,b)=>b[1].length-a[1].length);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Link Explorer</span><button onclick="this.closest(\'#link-explorer-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+links.length+' links across '+sorted.length+' domains</div>';
  // Domain distribution bar
  if(sorted.length){
    const domColors=['#4ade80','#3b82f6','#f59e0b','#a78bfa','#22d3ee','#f472b6','#ef4444','#84cc16'];
    h+='<div style="display:flex;height:16px;border-radius:var(--radius);overflow:hidden;margin-bottom:12px">';
    sorted.slice(0,8).forEach((e,i)=>{
      const pct=Math.round(e[1].length/(links.length||1)*100);
      if(pct>0)h+='<div title="'+esc(e[0])+': '+e[1].length+'" style="width:'+pct+'%;background:'+domColors[i%domColors.length]+'"></div>';
    });
    h+='</div>';
  }
  sorted.forEach(([domain,items],i)=>{
    const col=['#4ade80','#3b82f6','#f59e0b','#a78bfa','#22d3ee'][i%5];
    h+='<div style="margin-bottom:10px">';
    h+='<div style="font-size:11px;font-weight:700;color:'+col+';padding:4px 0;border-bottom:1px solid var(--border)">'+esc(domain)+' ('+items.length+')</div>';
    items.slice(0,5).forEach(l=>{
      h+='<div style="padding:4px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
      h+='<a href="'+esc(l.url)+'" target="_blank" rel="noopener" style="flex:1;font-size:11px;color:var(--text);text-decoration:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(l.title||l.url)+'</a>';
      if(l.category)h+='<span style="font-size:9px;padding:1px 5px;background:var(--bg-surface);border-radius:3px;color:var(--text-muted)">'+esc(l.category)+'</span>';
      h+='</div>';
    });
    if(items.length>5)h+='<div style="font-size:10px;color:var(--text-muted);padding:4px">+'+(items.length-5)+' more</div>';
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectSummary(){
  let panel=document.getElementById('proj-summary-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='proj-summary-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  const projects=(S.projects||[]);
  let selProj=projects.length?projects[0].id:'';
  function render(){
    const p=projects.find(pr=>pr.id===selProj);
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Project Summary</span><button onclick="this.closest(\'#proj-summary-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<select onchange="this.closest(\'#proj-summary-panel\')._sel=this.value;this.closest(\'#proj-summary-panel\')._render()" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:12px">';
    projects.forEach(pr=>{h+='<option value="'+pr.id+'"'+(selProj===pr.id?' selected':'')+'>'+esc(pr.name)+'</option>';});
    h+='</select>';
    if(p){
      const tasks=(S.tasks||[]).filter(t=>t.projectId===p.id||t.project===p.name);
      const done=tasks.filter(t=>t.status==='done').length;
      const inProg=tasks.filter(t=>t.status==='in-progress').length;
      const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length;
      const content=(S.content||[]).filter(c=>c.project===p.name);
      const links=(S.links||[]).filter(l=>l.project===p.name);
      const docs=(S.writerDocs||[]).filter(d=>d.projectId===p.id);
      const pct=tasks.length?Math.round(done/tasks.length*100):0;
      // Header card
      h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:16px;margin-bottom:12px;border-left:4px solid '+(pct===100?'#4ade80':pct>50?'#f59e0b':'#3b82f6')+'">';
      h+='<div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:4px">'+esc(p.name)+'</div>';
      if(p.description)h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">'+esc(p.description)+'</div>';
      h+='<div style="height:8px;background:var(--bg-elevated);border-radius:4px;overflow:hidden;margin-bottom:4px"><div style="height:100%;background:#4ade80;width:'+pct+'%"></div></div>';
      h+='<div style="font-size:10px;color:var(--text-muted)">'+pct+'% complete ('+done+'/'+tasks.length+' tasks)</div>';
      h+='</div>';
      // Stats grid
      h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px">';
      const stats=[
        {label:'In Progress',val:inProg,color:'#f59e0b'},
        {label:'Overdue',val:overdue,color:'#ef4444'},
        {label:'Content',val:content.length,color:'#60a5fa'},
        {label:'Documents',val:docs.length,color:'#a78bfa'},
      ];
      stats.forEach(s=>{
        h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:8px;text-align:center"><div style="font-size:16px;font-weight:700;color:'+s.color+'">'+s.val+'</div><div style="font-size:9px;color:var(--text-muted)">'+s.label+'</div></div>';
      });
      h+='</div>';
      // Recent activity
      const recentTasks=tasks.filter(t=>t.status==='done'&&t.completedAt).sort((a,b)=>b.completedAt.localeCompare(a.completedAt)).slice(0,5);
      if(recentTasks.length){
        h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:4px">Recently Completed</div>';
        recentTasks.forEach(t=>{
          h+='<div style="font-size:10px;color:var(--text-muted);padding:3px 0">'+esc(t.title)+' ('+t.completedAt.substring(0,10)+')</div>';
        });
      }
    }
    panel.innerHTML=h;panel._render=render;panel._sel=selProj;
  }
  render();document.body.appendChild(panel);
}
function showQuickCountdown(){
  let panel=document.getElementById('countdown-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='countdown-widget';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px';
  if(!S._countdowns)S._countdowns=[];
  function render(){
    const now=Date.now();
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:12px;color:var(--text)">Countdowns</span><button onclick="this.closest(\'#countdown-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    h+='<div style="display:flex;gap:4px;margin-bottom:8px">';
    h+='<input id="cd-label" placeholder="Label" style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px;box-sizing:border-box">';
    h+='<input id="cd-date" type="date" style="padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px">';
    h+='<button onclick="const l=document.getElementById(\'cd-label\').value.trim();const d=document.getElementById(\'cd-date\').value;if(!d)return;S._countdowns.push({label:l||\'Countdown\',date:d});if(S._countdowns.length>10)S._countdowns.length=10;save();this.closest(\'#countdown-widget\')._render()" style="padding:4px 8px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:10px;font-weight:600">+</button>';
    h+='</div>';
    (S._countdowns||[]).forEach((c,i)=>{
      const target=new Date(c.date).getTime();
      const diff=target-now;
      const days=Math.ceil(diff/86400000);
      const col=days<0?'#ef4444':days<=3?'#f59e0b':days<=7?'#22d3ee':'#4ade80';
      h+='<div style="padding:6px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
      h+='<span style="font-size:16px;font-weight:700;color:'+col+';width:40px;text-align:right">'+days+'</span>';
      h+='<div style="flex:1"><div style="font-size:11px;color:var(--text)">'+esc(c.label)+'</div><div style="font-size:9px;color:var(--text-muted)">'+c.date+'</div></div>';
      h+='<button onclick="S._countdowns.splice('+i+',1);save();this.closest(\'#countdown-widget\')._render()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">x</button>';
      h+='</div>';
    });
    if(!S._countdowns.length)h+='<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:8px">No countdowns. Add one above.</div>';
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showTextTransformer(){
  let panel=document.getElementById('text-transform-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='text-transform-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Text Transformer</span><button onclick="this.closest(\'#text-transform-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="tt-input" placeholder="Paste or type text here..." style="width:100%;height:100px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:12px;resize:vertical;box-sizing:border-box;font-family:inherit;margin-bottom:8px"></textarea>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
  const transforms=[
    {label:'UPPERCASE',fn:'v.toUpperCase()'},
    {label:'lowercase',fn:'v.toLowerCase()'},
    {label:'Title Case',fn:'v.replace(/\\w\\S*/g,t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase())'},
    {label:'slug-case',fn:'v.toLowerCase().replace(/[^a-z0-9]+/g,\"-\").replace(/^-|-$/g,\"\")'},
    {label:'camelCase',fn:'v.toLowerCase().replace(/[^a-z0-9]+(.)/g,(_,c)=>c.toUpperCase())'},
    {label:'Trim',fn:'v.trim()'},
    {label:'Remove Extra Spaces',fn:'v.replace(/\\s+/g,\" \").trim()'},
    {label:'Reverse',fn:'v.split(\"\").reverse().join(\"\")'},
  ];
  transforms.forEach(t=>{
    h+='<button onclick="const ta=document.getElementById(\'tt-input\');const v=ta.value;ta.value=(function(v){return '+t.fn+'})(v);document.getElementById(\'tt-stats\').textContent=ta.value.split(/\\s+/).filter(Boolean).length+\' words | \'+ta.value.length+\' chars\'" style="padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">'+t.label+'</button>';
  });
  h+='</div>';
  h+='<div style="display:flex;justify-content:space-between;align-items:center">';
  h+='<span id="tt-stats" style="font-size:10px;color:var(--text-muted)">0 words | 0 chars</span>';
  h+='<button onclick="const ta=document.getElementById(\'tt-input\');navigator.clipboard.writeText(ta.value);this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy\',1000)" style="padding:4px 12px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Copy</button>';
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('tt-input').addEventListener('input',function(){document.getElementById('tt-stats').textContent=this.value.split(/\s+/).filter(Boolean).length+' words | '+this.value.length+' chars';});
}
function showLinkArchive(){
  let panel=document.getElementById('link-archive-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='link-archive-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._linkArchive)S._linkArchive=[];
  function render(){
    const active=(S.links||[]);
    const archived=S._linkArchive;
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Link Archive</span><button onclick="this.closest(\'#link-archive-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+active.length+' active | '+archived.length+' archived</div>';
    h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Active Links</div>';
    if(!active.length)h+='<div style="font-size:10px;color:var(--text-muted);padding:8px">No active links</div>';
    active.slice(0,20).forEach(l=>{
      h+='<div style="padding:5px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
      h+='<span style="flex:1;font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(l.title||l.url)+'</span>';
      h+='<button onclick="if(!S._linkArchive)S._linkArchive=[];const idx=(S.links||[]).findIndex(x=>x.id===\''+l.id+'\');if(idx>=0){S._linkArchive.push(S.links.splice(idx,1)[0]);save();this.closest(\'#link-archive-panel\')._render()}" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px;padding:2px 6px">Archive</button>';
      h+='</div>';
    });
    if(active.length>20)h+='<div style="font-size:10px;color:var(--text-muted);padding:4px">+'+(active.length-20)+' more</div>';
    if(archived.length){
      h+='<div style="font-size:11px;font-weight:700;color:#f59e0b;margin-top:12px;margin-bottom:6px">Archived</div>';
      archived.forEach((l,i)=>{
        h+='<div style="padding:5px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
        h+='<span style="flex:1;font-size:11px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(l.title||l.url)+'</span>';
        h+='<button onclick="if(!S.links)S.links=[];S.links.push(S._linkArchive.splice('+i+',1)[0]);save();this.closest(\'#link-archive-panel\')._render()" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:#4ade80;cursor:pointer;font-size:9px;padding:2px 6px">Restore</button>';
        h+='</div>';
      });
    }
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showDocMerge(){
  let panel=document.getElementById('doc-merge-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='doc-merge-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const docs=(S.writerDocs||[]);
  let selA=docs.length?docs[0].id:'';
  let selB=docs.length>1?docs[1].id:'';
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Merge Documents</span><button onclick="this.closest(\'#doc-merge-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Merge two documents into one. The second doc\'s content will be appended to the first.</div>';
    h+='<div style="margin-bottom:8px"><span style="font-size:10px;color:var(--text-muted)">Base document:</span>';
    h+='<select onchange="this.closest(\'#doc-merge-panel\')._selA=this.value;this.closest(\'#doc-merge-panel\')._render()" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-top:2px">';
    docs.forEach(d=>{h+='<option value="'+d.id+'"'+(selA===d.id?' selected':'')+'>'+esc(d.title)+' ('+(d.body||'').split(/\s+/).filter(Boolean).length+' words)</option>';});
    h+='</select></div>';
    h+='<div style="margin-bottom:8px"><span style="font-size:10px;color:var(--text-muted)">Append from:</span>';
    h+='<select onchange="this.closest(\'#doc-merge-panel\')._selB=this.value;this.closest(\'#doc-merge-panel\')._render()" style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-top:2px">';
    docs.forEach(d=>{h+='<option value="'+d.id+'"'+(selB===d.id?' selected':'')+'>'+esc(d.title)+' ('+(d.body||'').split(/\s+/).filter(Boolean).length+' words)</option>';});
    h+='</select></div>';
    const a=docs.find(d=>d.id===selA),b=docs.find(d=>d.id===selB);
    if(a&&b&&a.id!==b.id){
      const merged=(a.body||'')+'\n\n---\n\n'+(b.body||'');
      const mergedWc=merged.split(/\s+/).filter(Boolean).length;
      h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">Result: '+mergedWc+' words</div>';
      h+='<button onclick="const docs=(S.writerDocs||[]);const a=docs.find(d=>d.id===\''+selA+'\');const b=docs.find(d=>d.id===\''+selB+'\');if(a&&b&&a.id!==b.id){if(!confirm(\'Merge \\\"\'+b.title+\'\\\" into \\\"\'+a.title+\'\\\"?\'))return;a.body=(a.body||\'\')+\'\\n\\n---\\n\\n\'+(b.body||\'\');a.modified=new Date().toISOString();save();alert(\'Merged!\');this.closest(\'#doc-merge-panel\').remove();}" style="width:100%;padding:8px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:600">Merge Documents</button>';
    } else if(a&&b&&a.id===b.id){
      h+='<div style="font-size:11px;color:#ef4444;margin-top:8px">Select two different documents</div>';
    }
    panel.innerHTML=h;panel._render=render;panel._selA=selA;panel._selB=selB;
  }
  render();document.body.appendChild(panel);
}
function showJsonViewer(){
  let panel=document.getElementById('json-viewer-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='json-viewer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">JSON Viewer</span><button onclick="this.closest(\'#json-viewer-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="jv-input" placeholder="Paste JSON here..." style="width:100%;height:80px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;resize:vertical;box-sizing:border-box;font-family:monospace;margin-bottom:6px"></textarea>';
  h+='<div style="display:flex;gap:6px;margin-bottom:8px">';
  h+='<button onclick="try{const v=JSON.parse(document.getElementById(\'jv-input\').value);document.getElementById(\'jv-output\').textContent=JSON.stringify(v,null,2);document.getElementById(\'jv-error\').textContent=\'\'}catch(e){document.getElementById(\'jv-error\').textContent=e.message;document.getElementById(\'jv-output\').textContent=\'\'}" style="padding:5px 12px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Format</button>';
  h+='<button onclick="try{const v=JSON.parse(document.getElementById(\'jv-input\').value);const m=JSON.stringify(v);document.getElementById(\'jv-output\').textContent=m;navigator.clipboard.writeText(m);document.getElementById(\'jv-error\').textContent=\'Minified + copied!\'}catch(e){document.getElementById(\'jv-error\').textContent=e.message}" style="padding:5px 12px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px">Minify</button>';
  h+='<button onclick="const o=document.getElementById(\'jv-output\').textContent;if(o)navigator.clipboard.writeText(o);this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy Output\',1000)" style="padding:5px 12px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px">Copy Output</button>';
  h+='</div>';
  h+='<div id="jv-error" style="font-size:11px;color:#ef4444;margin-bottom:6px"></div>';
  h+='<pre id="jv-output" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;font-family:monospace;white-space:pre-wrap;word-break:break-word;max-height:250px;overflow-y:auto"></pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskTemplateManager(){
  let panel=document.getElementById('task-tmpl-mgr-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-tmpl-mgr-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._taskTemplates)S._taskTemplates=[];
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Templates</span><button onclick="this.closest(\'#task-tmpl-mgr-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">'+S._taskTemplates.length+' custom templates</div>';
    // Add new template form
    h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:10px;margin-bottom:10px">';
    h+='<input id="ttm-title" placeholder="Template title" style="width:100%;padding:5px 8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:4px;box-sizing:border-box">';
    h+='<input id="ttm-desc" placeholder="Default description" style="width:100%;padding:5px 8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;margin-bottom:4px;box-sizing:border-box">';
    h+='<div style="display:flex;gap:4px">';
    h+='<select id="ttm-pri" style="flex:1;padding:4px 6px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px">';
    ['p0','p1','p2','p3'].forEach(p=>{h+='<option value="'+p+'"'+(p==='p2'?' selected':'')+'>'+p.toUpperCase()+'</option>';});
    h+='</select>';
    h+='<button onclick="const t=document.getElementById(\'ttm-title\').value.trim();if(!t)return;S._taskTemplates.push({title:t,description:document.getElementById(\'ttm-desc\').value.trim(),priority:document.getElementById(\'ttm-pri\').value});save();this.closest(\'#task-tmpl-mgr-panel\')._render()" style="padding:4px 12px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:10px;font-weight:600">Add Template</button>';
    h+='</div></div>';
    // Template list
    S._taskTemplates.forEach((tmpl,i)=>{
      const pCol=tmpl.priority==='p0'?'#ef4444':tmpl.priority==='p1'?'#f59e0b':tmpl.priority==='p2'?'#3b82f6':'#6b7280';
      h+='<div style="padding:8px 10px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
      h+='<span style="width:6px;height:24px;border-radius:3px;background:'+pCol+';flex-shrink:0"></span>';
      h+='<div style="flex:1"><div style="font-size:12px;color:var(--text)">'+esc(tmpl.title)+'</div>';
      if(tmpl.description)h+='<div style="font-size:10px;color:var(--text-muted)">'+esc(tmpl.description).substring(0,60)+'</div>';
      h+='</div>';
      h+='<button onclick="if(!S.tasks)S.tasks=[];S.tasks.push({id:\'t_\'+Date.now(),title:\''+esc(tmpl.title).replace(/'/g,"\\'")+'\',description:\''+esc(tmpl.description||'').replace(/'/g,"\\'")+'\',status:\'todo\',priority:\''+tmpl.priority+'\',project:\'\',tags:[],subtasks:[],created:new Date().toISOString()});save();if(typeof renderTasks===\'function\')renderTasks();this.textContent=\'Created!\';setTimeout(()=>this.textContent=\'Use\',800)" style="background:none;border:1px solid var(--accent);border-radius:var(--radius);color:var(--accent);cursor:pointer;font-size:9px;padding:2px 8px">Use</button>';
      h+='<button onclick="S._taskTemplates.splice('+i+',1);save();this.closest(\'#task-tmpl-mgr-panel\')._render()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px">x</button>';
      h+='</div>';
    });
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showWorkspaceMood(){
  let panel=document.getElementById('ws-mood-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='ws-mood-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const now=new Date();
  const todayStr=now.toISOString().substring(0,10);
  // Calculate mood factors
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now).length;
  const doneToday=tasks.filter(t=>t.completedAt&&t.completedAt.substring(0,10)===todayStr).length;
  const totalActive=tasks.filter(t=>t.status!=='done').length;
  const blocked=tasks.filter(t=>t.status==='blocked').length;
  const inProgress=tasks.filter(t=>t.status==='in-progress').length;
  // Score 0-100
  let score=50;
  score+=doneToday*8;
  score-=overdue*5;
  score-=blocked*8;
  score+=inProgress>0?10:0;
  score+=totalActive<20?10:-5;
  score=Math.max(0,Math.min(100,score));
  let mood,moodColor,moodIcon;
  if(score>=80){mood='Thriving';moodColor='#4ade80';moodIcon='*';}
  else if(score>=60){mood='Productive';moodColor='#22d3ee';moodIcon='+';}
  else if(score>=40){mood='Steady';moodColor='#f59e0b';moodIcon='=';}
  else if(score>=20){mood='Stressed';moodColor='#ef4444';moodIcon='-';}
  else{mood='Critical';moodColor='#dc2626';moodIcon='!';}
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:700;font-size:15px;color:var(--text)">Workspace Mood</span><button onclick="this.closest(\'#ws-mood-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  // Big mood display
  h+='<div style="text-align:center;margin-bottom:16px">';
  h+='<div style="width:80px;height:80px;border-radius:50%;background:'+moodColor+'22;border:3px solid '+moodColor+';display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:32px;color:'+moodColor+'">'+moodIcon+'</div>';
  h+='<div style="font-size:20px;font-weight:700;color:'+moodColor+'">'+mood+'</div>';
  h+='<div style="font-size:12px;color:var(--text-muted)">Score: '+score+'/100</div>';
  h+='</div>';
  // Factors
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Factors</div>';
  const factors=[
    {label:'Tasks done today',val:doneToday,impact:doneToday>0?'+positive':'neutral',col:doneToday>0?'#4ade80':'#6b7280'},
    {label:'Overdue tasks',val:overdue,impact:overdue>0?'-negative':'positive',col:overdue>0?'#ef4444':'#4ade80'},
    {label:'Blocked tasks',val:blocked,impact:blocked>0?'-negative':'neutral',col:blocked>0?'#ef4444':'#6b7280'},
    {label:'In progress',val:inProgress,impact:inProgress>0?'+positive':'neutral',col:inProgress>0?'#22d3ee':'#6b7280'},
    {label:'Active tasks',val:totalActive,impact:totalActive<20?'manageable':'heavy',col:totalActive<20?'#4ade80':'#f59e0b'},
  ];
  factors.forEach(f=>{
    h+='<div style="padding:4px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
    h+='<span style="flex:1;font-size:11px;color:var(--text)">'+f.label+'</span>';
    h+='<span style="font-size:12px;font-weight:700;color:'+f.col+'">'+f.val+'</span>';
    h+='<span style="font-size:9px;color:'+f.col+'">'+f.impact+'</span>';
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showRegexTester(){
  let panel=document.getElementById('regex-tester-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='regex-tester-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  function render(){
    const pattern=(panel.querySelector('#rx-pattern')||{}).value||'';
    const flags=(panel.querySelector('#rx-flags')||{}).value||'gi';
    const text=(panel.querySelector('#rx-text')||{}).value||'';
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Regex Tester</span><button onclick="this.closest(\'#regex-tester-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="display:flex;gap:6px;margin-bottom:6px">';
    h+='<input id="rx-pattern" value="'+esc(pattern)+'" placeholder="Regex pattern..." oninput="this.closest(\'#regex-tester-panel\')._render()" style="flex:1;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:#4ade80;font-size:12px;font-family:monospace;box-sizing:border-box">';
    h+='<input id="rx-flags" value="'+esc(flags)+'" placeholder="gi" oninput="this.closest(\'#regex-tester-panel\')._render()" style="width:50px;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:12px;font-family:monospace;box-sizing:border-box">';
    h+='</div>';
    h+='<textarea id="rx-text" placeholder="Test string..." oninput="this.closest(\'#regex-tester-panel\')._render()" style="width:100%;height:80px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;resize:vertical;box-sizing:border-box;font-family:monospace;margin-bottom:8px">'+esc(text)+'</textarea>';
    // Test results
    if(pattern&&text){
      try{
        const rx=new RegExp(pattern,flags);
        const matches=text.match(rx);
        if(matches){
          h+='<div style="font-size:11px;color:#4ade80;margin-bottom:6px">'+matches.length+' match'+(matches.length>1?'es':'')+'</div>';
          h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:8px;font-family:monospace;font-size:11px;max-height:120px;overflow-y:auto">';
          matches.forEach((m,i)=>{
            h+='<div style="padding:2px 0;color:var(--text)"><span style="color:var(--text-muted);font-size:9px">['+(i+1)+']</span> <span style="background:#4ade8022;padding:1px 3px;border-radius:2px">'+esc(m)+'</span></div>';
          });
          h+='</div>';
        } else {
          h+='<div style="font-size:11px;color:#ef4444">No matches</div>';
        }
      }catch(e){
        h+='<div style="font-size:11px;color:#ef4444">Error: '+esc(e.message)+'</div>';
      }
    }
    panel.innerHTML=h;panel._render=render;
    if(pattern){const inp=panel.querySelector('#rx-pattern');inp.setSelectionRange(pattern.length,pattern.length);}
  }
  render();document.body.appendChild(panel);
}
function showCalendarExporter(){
  let panel=document.getElementById('cal-export-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='cal-export-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.due&&t.status!=='done');
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Calendar Export (ICS)</span><button onclick="this.closest(\'#cal-export-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+tasks.length+' tasks with due dates (excluding done)</div>';
  // Preview
  tasks.slice(0,10).forEach(t=>{
    const pCol=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':'#3b82f6';
    h+='<div style="padding:4px 8px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center">';
    h+='<span style="font-size:9px;color:'+pCol+';font-weight:600">'+t.priority.toUpperCase()+'</span>';
    h+='<span style="flex:1;font-size:11px;color:var(--text)">'+esc(t.title)+'</span>';
    h+='<span style="font-size:10px;color:var(--text-muted)">'+t.due.substring(0,10)+'</span>';
    h+='</div>';
  });
  if(tasks.length>10)h+='<div style="font-size:10px;color:var(--text-muted);padding:4px">+'+(tasks.length-10)+' more</div>';
  h+='<button onclick="const tasks=(S.tasks||[]).filter(t=>t.due&&t.status!==\'done\');let ics=\'BEGIN:VCALENDAR\\nVERSION:2.0\\nPRODID:-//ASTRA//Tasks//EN\\n\';tasks.forEach(t=>{const d=(t.due||\'\').replace(/[-:]/g,\'\').substring(0,8);ics+=\'BEGIN:VEVENT\\nDTSTART;VALUE=DATE:\'+d+\'\\nSUMMARY:\'+t.title.replace(/[\\n,;]/g,\' \')+\'\\nDESCRIPTION:\'+((t.description||\'\').replace(/[\\n]/g,\'\\\\n\').replace(/[,;]/g,\' \').substring(0,200))+\'\\nEND:VEVENT\\n\';});ics+=\'END:VCALENDAR\';const blob=new Blob([ics],{type:\'text/calendar\'});const a=document.createElement(\'a\');a.href=URL.createObjectURL(blob);a.download=\'astra-tasks.ics\';a.click()" style="width:100%;margin-top:10px;padding:8px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:600">Download ICS File</button>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickDice(){
  let panel=document.getElementById('quick-dice-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-dice-widget';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:240px';
  function render(result){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:12px;color:var(--text)">Random / Decide</span><button onclick="this.closest(\'#quick-dice-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    if(result!==undefined){
      h+='<div style="text-align:center;padding:12px 0;font-size:24px;font-weight:700;color:#4ade80">'+result+'</div>';
    }
    h+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
    const options=[
      {label:'d6',fn:'Math.floor(Math.random()*6)+1'},
      {label:'d20',fn:'Math.floor(Math.random()*20)+1'},
      {label:'d100',fn:'Math.floor(Math.random()*100)+1'},
      {label:'Coin',fn:'Math.random()>0.5?"Heads":"Tails"'},
      {label:'Yes/No',fn:'Math.random()>0.5?"Yes":"No"'},
      {label:'1-10',fn:'Math.floor(Math.random()*10)+1'},
    ];
    options.forEach(o=>{
      h+='<button onclick="this.closest(\'#quick-dice-widget\')._render(eval(\''+o.fn+'\'))" style="flex:1;min-width:60px;padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">'+o.label+'</button>';
    });
    h+='</div>';
    h+='<div style="display:flex;gap:4px">';
    h+='<input id="dice-custom" placeholder="Comma-separated options..." style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:10px;box-sizing:border-box">';
    h+='<button onclick="const v=document.getElementById(\'dice-custom\').value.split(\',\').map(s=>s.trim()).filter(Boolean);if(!v.length)return;this.closest(\'#quick-dice-widget\')._render(v[Math.floor(Math.random()*v.length)])" style="padding:4px 8px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:10px;font-weight:600">Pick</button>';
    h+='</div>';
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showDateCalculator(){
  let panel=document.getElementById('date-calc-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='date-calc-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:80vh;overflow-y:auto';
  const today=new Date().toISOString().substring(0,10);
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Date Calculator</span><button onclick="this.closest(\'#date-calc-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  // Add/subtract days
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Add/Subtract Days</div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:10px;align-items:center">';
  h+='<input id="dc-base" type="date" value="'+today+'" style="flex:1;padding:5px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px">';
  h+='<span style="color:var(--text-muted);font-size:12px">+</span>';
  h+='<input id="dc-days" type="number" value="7" style="width:60px;padding:5px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;text-align:center">';
  h+='<span style="color:var(--text-muted);font-size:10px">days</span>';
  h+='<button onclick="const b=document.getElementById(\'dc-base\').value;const d=+document.getElementById(\'dc-days\').value;const r=new Date(b);r.setDate(r.getDate()+d);document.getElementById(\'dc-result1\').textContent=r.toISOString().substring(0,10)+\' (\'+r.toLocaleDateString(\'en\',{weekday:\'long\'})+\')\';" style="padding:5px 10px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:10px;font-weight:600">=</button>';
  h+='</div>';
  h+='<div id="dc-result1" style="font-size:14px;font-weight:700;color:#4ade80;margin-bottom:16px;min-height:20px"></div>';
  // Date difference
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Days Between Dates</div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:10px;align-items:center">';
  h+='<input id="dc-from" type="date" value="'+today+'" style="flex:1;padding:5px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px">';
  h+='<span style="color:var(--text-muted);font-size:12px">to</span>';
  h+='<input id="dc-to" type="date" style="flex:1;padding:5px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px">';
  h+='<button onclick="const f=new Date(document.getElementById(\'dc-from\').value);const t=new Date(document.getElementById(\'dc-to\').value);const diff=Math.round((t-f)/86400000);document.getElementById(\'dc-result2\').textContent=diff+\' days (\'+Math.round(diff/7*10)/10+\' weeks)\';" style="padding:5px 10px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:10px;font-weight:600">=</button>';
  h+='</div>';
  h+='<div id="dc-result2" style="font-size:14px;font-weight:700;color:#4ade80;margin-bottom:16px;min-height:20px"></div>';
  // Quick references
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:4px">Quick Reference</div>';
  const refs=[7,14,30,60,90];
  h+='<div style="display:flex;gap:4px;flex-wrap:wrap">';
  refs.forEach(d=>{
    const r=new Date();r.setDate(r.getDate()+d);
    h+='<span style="font-size:9px;padding:3px 6px;background:var(--bg-surface);border-radius:var(--radius);color:var(--text-muted)">+'+d+'d = '+r.toISOString().substring(0,10)+'</span>';
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskGantt(){
  let panel=document.getElementById('task-gantt-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-gantt-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:750px;width:95vw;max-height:85vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.due&&t.created).sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  const now=new Date();
  // Find date range
  let minDate=new Date(),maxDate=new Date();
  tasks.forEach(t=>{
    const c=new Date(t.created),d=new Date(t.due);
    if(c<minDate)minDate=c;
    if(d>maxDate)maxDate=d;
  });
  const rangeMs=maxDate-minDate||86400000;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Gantt Chart</span><button onclick="this.closest(\'#task-gantt-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:12px">'+tasks.length+' tasks with dates | '+minDate.toISOString().substring(0,10)+' to '+maxDate.toISOString().substring(0,10)+'</div>';
  if(!tasks.length){
    h+='<div style="text-align:center;color:var(--text-muted);padding:30px;font-size:12px">No tasks with both created and due dates.</div>';
  }
  tasks.slice(0,25).forEach(t=>{
    const created=new Date(t.created);
    const due=new Date(t.due);
    const startPct=Math.max(0,Math.round((created-minDate)/rangeMs*100));
    const endPct=Math.max(startPct+2,Math.round((due-minDate)/rangeMs*100));
    const widthPct=endPct-startPct;
    const pCol=t.priority==='p0'?'#ef4444':t.priority==='p1'?'#f59e0b':t.priority==='p2'?'#3b82f6':'#6b7280';
    const barCol=t.status==='done'?'#4ade80':due<now&&t.status!=='done'?'#ef4444':pCol;
    h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:3px">';
    h+='<span style="font-size:10px;color:var(--text);width:120px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(t.title)+'</span>';
    h+='<div style="flex:1;height:14px;background:var(--bg-surface);border-radius:2px;position:relative">';
    h+='<div style="position:absolute;left:'+startPct+'%;width:'+widthPct+'%;height:100%;background:'+barCol+(t.status==='done'?'':'88')+';border-radius:2px"></div>';
    h+='</div>';
    h+='<span style="font-size:9px;color:var(--text-muted);width:55px;flex-shrink:0;text-align:right">'+t.due.substring(5,10)+'</span>';
    h+='</div>';
  });
  if(tasks.length>25)h+='<div style="font-size:10px;color:var(--text-muted);margin-top:6px">+'+(tasks.length-25)+' more tasks</div>';
  // Today marker
  const todayPct=Math.round((now-minDate)/rangeMs*100);
  h+='<div style="font-size:10px;color:#4ade80;margin-top:8px">Today is at '+todayPct+'% of the range</div>';
  h+='<div style="display:flex;gap:12px;font-size:9px;margin-top:6px"><span style="color:#4ade80">Done</span><span style="color:#ef4444">Overdue</span><span style="color:#3b82f6">Active</span></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickMemo(){
  let panel=document.getElementById('quick-memo-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-memo-widget';
  panel.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:320px';
  if(!S._memo)S._memo='';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:12px;color:var(--text)">Quick Memo</span><div style="display:flex;gap:4px"><button onclick="S._memo=document.getElementById(\'qm-text\').value;save();this.textContent=\'Saved!\';setTimeout(()=>this.textContent=\'Save\',800)" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px;padding:2px 8px">Save</button><button onclick="this.closest(\'#quick-memo-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div></div>';
  h+='<textarea id="qm-text" style="width:100%;height:150px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;resize:vertical;box-sizing:border-box;font-family:inherit;line-height:1.5" placeholder="Write anything here... Auto-saved on close.">'+esc(S._memo)+'</textarea>';
  h+='<div style="display:flex;justify-content:space-between;margin-top:4px"><span style="font-size:9px;color:var(--text-muted)">'+S._memo.split(/\s+/).filter(Boolean).length+' words</span><button onclick="navigator.clipboard.writeText(document.getElementById(\'qm-text\').value);this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy\',800)" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px">Copy</button></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showBase64Tool(){
  let panel=document.getElementById('b64-tool-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='b64-tool-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Base64 Encode/Decode</span><button onclick="this.closest(\'#b64-tool-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="b64-input" placeholder="Paste text to encode or Base64 to decode..." style="width:100%;height:80px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;resize:vertical;box-sizing:border-box;font-family:monospace;margin-bottom:6px"></textarea>';
  h+='<div style="display:flex;gap:6px;margin-bottom:8px">';
  h+='<button onclick="try{document.getElementById(\'b64-output\').textContent=btoa(document.getElementById(\'b64-input\').value);document.getElementById(\'b64-error\').textContent=\'\'}catch(e){document.getElementById(\'b64-error\').textContent=e.message}" style="flex:1;padding:6px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Encode</button>';
  h+='<button onclick="try{document.getElementById(\'b64-output\').textContent=atob(document.getElementById(\'b64-input\').value.trim());document.getElementById(\'b64-error\').textContent=\'\'}catch(e){document.getElementById(\'b64-error\').textContent=e.message}" style="flex:1;padding:6px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px">Decode</button>';
  h+='<button onclick="const o=document.getElementById(\'b64-output\').textContent;if(o)navigator.clipboard.writeText(o);this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy\',800)" style="padding:6px 12px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px">Copy</button>';
  h+='</div>';
  h+='<div id="b64-error" style="font-size:11px;color:#ef4444;margin-bottom:4px"></div>';
  h+='<pre id="b64-output" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;font-family:monospace;white-space:pre-wrap;word-break:break-all;max-height:150px;overflow-y:auto;min-height:30px"></pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskKanbanMini(){
  let panel=document.getElementById('kanban-mini-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='kanban-mini-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:95vw;max-height:85vh;overflow-y:auto';
  const statuses=['todo','in-progress','review','done'];
  const statusColors={'todo':'#6b7280','in-progress':'#f59e0b','review':'#3b82f6','done':'#4ade80'};
  function render(){
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Mini Kanban</span><button onclick="this.closest(\'#kanban-mini-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">Click status buttons to move tasks between columns</div>';
    h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">';
    statuses.forEach(s=>{
      const col=statusColors[s];
      const tasks=(S.tasks||[]).filter(t=>t.status===s);
      h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:8px;border-top:3px solid '+col+';min-height:100px">';
      h+='<div style="font-size:10px;font-weight:700;color:'+col+';text-transform:uppercase;margin-bottom:6px">'+s+' ('+tasks.length+')</div>';
      tasks.slice(0,8).forEach(t=>{
        const nextStatus=s==='todo'?'in-progress':s==='in-progress'?'review':s==='review'?'done':'todo';
        const nextCol=statusColors[nextStatus];
        h+='<div style="padding:4px 6px;margin-bottom:3px;background:var(--bg-elevated);border-radius:var(--radius);display:flex;gap:4px;align-items:center">';
        h+='<span style="flex:1;font-size:9px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(t.title)+'</span>';
        h+='<button onclick="const t=(S.tasks||[]).find(x=>x.id===\''+t.id+'\');if(t){t.status=\''+nextStatus+'\';if(\''+nextStatus+'\'===\'done\')t.completedAt=new Date().toISOString();save();this.closest(\'#kanban-mini-panel\')._render()}" style="background:'+nextCol+'22;border:none;border-radius:2px;color:'+nextCol+';cursor:pointer;font-size:8px;padding:1px 4px;flex-shrink:0" title="Move to '+nextStatus+'">&gt;</button>';
        h+='</div>';
      });
      if(tasks.length>8)h+='<div style="font-size:9px;color:var(--text-muted)">+'+(tasks.length-8)+' more</div>';
      h+='</div>';
    });
    h+='</div>';
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showClockWidget(){
  let panel=document.getElementById('clock-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='clock-widget';
  panel.style.cssText='position:fixed;top:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;box-shadow:0 4px 16px rgba(0,0,0,0.5);display:flex;gap:12px;align-items:center';
  function tick(){
    const now=new Date();
    const time=now.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
    const date=now.toLocaleDateString('en',{weekday:'short',month:'short',day:'numeric'});
    let h='<div><div style="font-size:20px;font-weight:700;color:var(--text);font-family:monospace">'+time+'</div>';
    h+='<div style="font-size:10px;color:var(--text-muted)">'+date+'</div></div>';
    h+='<button onclick="clearInterval(this.closest(\'#clock-widget\')._interval);this.closest(\'#clock-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px">X</button>';
    panel.innerHTML=h;
  }
  tick();
  panel._interval=setInterval(tick,1000);
  document.body.appendChild(panel);
}
function showUrlEncoder(){
  let panel=document.getElementById('url-encoder-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='url-encoder-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">URL Encode/Decode</span><button onclick="this.closest(\'#url-encoder-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="ue-input" placeholder="Paste URL or text to encode/decode..." style="width:100%;height:70px;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;resize:vertical;box-sizing:border-box;font-family:monospace;margin-bottom:6px"></textarea>';
  h+='<div style="display:flex;gap:6px;margin-bottom:8px">';
  h+='<button onclick="document.getElementById(\'ue-output\').textContent=encodeURIComponent(document.getElementById(\'ue-input\').value)" style="flex:1;padding:6px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:11px;font-weight:600">Encode</button>';
  h+='<button onclick="try{document.getElementById(\'ue-output\').textContent=decodeURIComponent(document.getElementById(\'ue-input\').value)}catch(e){document.getElementById(\'ue-output\').textContent=\'Error: \'+e.message}" style="flex:1;padding:6px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px">Decode</button>';
  h+='<button onclick="document.getElementById(\'ue-output\').textContent=encodeURI(document.getElementById(\'ue-input\').value)" style="flex:1;padding:6px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px">Encode URI</button>';
  h+='<button onclick="const o=document.getElementById(\'ue-output\').textContent;if(o)navigator.clipboard.writeText(o);this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy\',800)" style="padding:6px 10px;background:var(--bg-surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-size:11px">Copy</button>';
  h+='</div>';
  h+='<pre id="ue-output" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;font-family:monospace;white-space:pre-wrap;word-break:break-all;max-height:120px;overflow-y:auto;min-height:30px"></pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskPareto(){
  let panel=document.getElementById('task-pareto-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-pareto-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const byProject={};
  tasks.forEach(t=>{const p=t.project||'No Project';if(!byProject[p])byProject[p]={total:0,done:0};byProject[p].total++;if(t.status==='done')byProject[p].done++;});
  const sorted=Object.entries(byProject).sort((a,b)=>b[1].done-a[1].done);
  const totalDone=sorted.reduce((a,e)=>a+e[1].done,0)||1;
  let cumPct=0;
  const paretoLine=sorted.map(e=>{cumPct+=e[1].done/totalDone*100;return Math.round(cumPct);});
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Pareto Analysis</span><button onclick="this.closest(\'#task-pareto-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Which projects produce the most completed tasks?</div>';
  // Find the 80% cutoff
  const cutoff=paretoLine.findIndex(p=>p>=80);
  if(cutoff>=0){
    h+='<div style="font-size:11px;color:#4ade80;margin-bottom:10px">Top '+(cutoff+1)+' project'+(cutoff>0?'s':'')+' account for 80%+ of completions ('+paretoLine[cutoff]+'%)</div>';
  }
  const colors=['#4ade80','#3b82f6','#f59e0b','#a78bfa','#22d3ee','#f472b6','#ef4444','#84cc16'];
  sorted.forEach((e,i)=>{
    const col=colors[i%colors.length];
    const pct=Math.round(e[1].done/totalDone*100);
    const above80=paretoLine[i]<=80||i===cutoff;
    h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:4px;'+(above80?'':'opacity:0.5')+'">';
    h+='<span style="font-size:10px;color:var(--text);width:100px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(e[0])+'</span>';
    h+='<div style="flex:1;height:14px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;background:'+col+';width:'+pct+'%"></div></div>';
    h+='<span style="font-size:10px;color:var(--text-muted);width:50px;text-align:right">'+e[1].done+' ('+pct+'%)</span>';
    h+='<span style="font-size:9px;color:var(--text-muted);width:35px;text-align:right">cum:'+paretoLine[i]+'%</span>';
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showAffirmations(){
  let panel=document.getElementById('affirmation-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='affirmation-widget';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:30px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;text-align:center';
  const affirmations=[
    'You are capable of amazing things.',
    'Every line of code you write makes the world better.',
    'Progress, not perfection.',
    'You handle challenges with grace and determination.',
    'Your creativity knows no bounds.',
    'Small steps every day lead to massive results.',
    'You are building something that matters.',
    'Trust the process. The work compounds.',
    'You are exactly where you need to be.',
    'Your persistence is your superpower.',
    'The best time to start was yesterday. The next best time is now.',
    'You turn obstacles into stepping stones.',
    'Focus is your unfair advantage.',
    'Done is better than perfect.',
    'You are the architect of your own success.',
    'Every expert was once a beginner.',
    'Discipline is choosing between what you want now and what you want most.',
    'Ship it. Iterate later.',
    'Your potential is limitless.',
    'The only way to do great work is to love what you do.',
  ];
  function show(){
    const a=affirmations[Math.floor(Math.random()*affirmations.length)];
    let h='<button onclick="this.closest(\'#affirmation-widget\').remove()" style="position:absolute;top:10px;right:14px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button>';
    h+='<div style="font-size:18px;font-weight:700;color:var(--text);line-height:1.5;margin-bottom:16px">'+a+'</div>';
    h+='<button onclick="this.closest(\'#affirmation-widget\')._show()" style="padding:6px 20px;background:var(--accent);color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-size:12px;font-weight:600">Another One</button>';
    panel.innerHTML=h;panel._show=show;
  }
  show();document.body.appendChild(panel);
}
function showColorPalette(){
  let panel=document.getElementById('color-palette-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='color-palette-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  function hexToHsl(hex){
    hex=hex.replace('#','');
    const r=parseInt(hex.substr(0,2),16)/255,g=parseInt(hex.substr(2,2),16)/255,b=parseInt(hex.substr(4,2),16)/255;
    const max=Math.max(r,g,b),min=Math.min(r,g,b);
    let h=0,s=0,l=(max+min)/2;
    if(max!==min){const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}}
    return [Math.round(h*360),Math.round(s*100),Math.round(l*100)];
  }
  function render(){
    const baseHex=(panel.querySelector('#cp-hex')||{}).value||'#4ade80';
    const hsl=hexToHsl(baseHex);
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Color Palette</span><button onclick="this.closest(\'#color-palette-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">';
    h+='<input id="cp-hex" type="color" value="'+baseHex+'" onchange="this.closest(\'#color-palette-panel\')._render()" style="width:40px;height:30px;border:none;cursor:pointer">';
    h+='<input type="text" value="'+baseHex+'" oninput="document.getElementById(\'cp-hex\').value=this.value;this.closest(\'#color-palette-panel\')._render()" style="width:80px;padding:5px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;font-family:monospace">';
    h+='<span style="font-size:10px;color:var(--text-muted)">HSL('+hsl[0]+', '+hsl[1]+'%, '+hsl[2]+'%)</span>';
    h+='</div>';
    // Shade variations
    h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Lightness Variations</div>';
    h+='<div style="display:flex;gap:3px;margin-bottom:12px">';
    for(let l=10;l<=95;l+=10){
      const col='hsl('+hsl[0]+','+hsl[1]+'%,'+l+'%)';
      h+='<div onclick="navigator.clipboard.writeText(\'hsl('+hsl[0]+','+hsl[1]+'%,'+l+'%)\');this.title=\'Copied!\'" style="flex:1;height:36px;background:'+col+';border-radius:3px;cursor:pointer" title="L:'+l+'%"></div>';
    }
    h+='</div>';
    // Saturation variations
    h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Saturation Variations</div>';
    h+='<div style="display:flex;gap:3px;margin-bottom:12px">';
    for(let s=0;s<=100;s+=12){
      const col='hsl('+hsl[0]+','+Math.min(100,s)+'%,'+hsl[2]+'%)';
      h+='<div onclick="navigator.clipboard.writeText(\'hsl('+hsl[0]+','+Math.min(100,s)+'%,'+hsl[2]+'%)\');this.title=\'Copied!\'" style="flex:1;height:36px;background:'+col+';border-radius:3px;cursor:pointer" title="S:'+Math.min(100,s)+'%"></div>';
    }
    h+='</div>';
    // Complementary
    h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Complementary & Analogous</div>';
    h+='<div style="display:flex;gap:3px;margin-bottom:6px">';
    [0,30,60,120,180,210,240,300].forEach(offset=>{
      const hue=(hsl[0]+offset)%360;
      const col='hsl('+hue+','+hsl[1]+'%,'+hsl[2]+'%)';
      h+='<div onclick="navigator.clipboard.writeText(\'hsl('+hue+','+hsl[1]+'%,'+hsl[2]+'%)\');this.title=\'Copied!\'" style="flex:1;height:36px;background:'+col+';border-radius:3px;cursor:pointer" title="H:'+hue+'"></div>';
    });
    h+='</div>';
    h+='<div style="font-size:9px;color:var(--text-muted)">Click any swatch to copy its HSL value</div>';
    panel.innerHTML=h;panel._render=render;
  }
  render();document.body.appendChild(panel);
}
function showTaskStreaks(){
  let panel=document.getElementById('task-streaks-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-streaks-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const completionDates=new Set();
  tasks.forEach(t=>{if(t.completedAt)completionDates.add(t.completedAt.substring(0,10));});
  // Calculate current streak
  let streak=0;
  const today=new Date();
  for(let i=0;i<365;i++){
    const d=new Date(today);d.setDate(today.getDate()-i);
    const ds=d.toISOString().substring(0,10);
    if(completionDates.has(ds))streak++;
    else if(i>0)break;
  }
  // Longest streak
  const sorted=[...completionDates].sort();
  let longest=0,current=1;
  for(let i=1;i<sorted.length;i++){
    const prev=new Date(sorted[i-1]);const curr=new Date(sorted[i]);
    if(curr-prev===86400000)current++;
    else{if(current>longest)longest=current;current=1;}
  }
  if(current>longest)longest=current;
  let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Completion Streaks</span><button onclick="this.closest(\'#task-streaks-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:16px;margin-bottom:16px">';
  h+='<div style="text-align:center;flex:1;background:var(--bg-surface);border-radius:var(--radius);padding:12px;border-top:3px solid #4ade80"><div style="font-size:28px;font-weight:700;color:#4ade80">'+streak+'</div><div style="font-size:10px;color:var(--text-muted)">Current Streak</div></div>';
  h+='<div style="text-align:center;flex:1;background:var(--bg-surface);border-radius:var(--radius);padding:12px;border-top:3px solid #f59e0b"><div style="font-size:28px;font-weight:700;color:#f59e0b">'+longest+'</div><div style="font-size:10px;color:var(--text-muted)">Longest Streak</div></div>';
  h+='<div style="text-align:center;flex:1;background:var(--bg-surface);border-radius:var(--radius);padding:12px;border-top:3px solid #3b82f6"><div style="font-size:28px;font-weight:700;color:#3b82f6">'+completionDates.size+'</div><div style="font-size:10px;color:var(--text-muted)">Active Days</div></div>';
  h+='</div>';
  // Last 14 days
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:6px">Last 14 Days</div>';
  h+='<div style="display:flex;gap:3px">';
  for(let i=13;i>=0;i--){
    const d=new Date(today);d.setDate(today.getDate()-i);
    const ds=d.toISOString().substring(0,10);
    const active=completionDates.has(ds);
    h+='<div style="flex:1;height:24px;border-radius:3px;background:'+(active?'#4ade80':'var(--bg-surface)')+'" title="'+ds+(active?' - active':'')+'"></div>';
  }
  h+='</div>';
  h+='<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-muted);margin-top:2px"><span>14d ago</span><span>Today</span></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showLoremGenerator(){
  let panel=document.getElementById('lorem-gen-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='lorem-gen-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  window._loremWords='lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua ut enim ad minim veniam quis nostrud exercitation ullamco laboris nisi aliquip ex ea commodo consequat duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur excepteur sint occaecat cupidatat non proident sunt in culpa qui officia deserunt mollit anim id est laborum'.split(' ');
  window._loremGen=function(n){var w=window._loremWords;var r=[];for(var i=0;i<n;i++)r.push(w[Math.floor(Math.random()*w.length)]);return r.join(' ');};
  window._loremPara=function(n){var p=[];for(var i=0;i<n;i++){var sc=3+Math.floor(Math.random()*4);var para='';for(var s=0;s<sc;s++){var t=window._loremGen(5+Math.floor(Math.random()*10));t=t.charAt(0).toUpperCase()+t.slice(1)+'.';para+=(s>0?' ':'')+t;}p.push(para);}return p.join('\n\n');};
  var btnStyle='padding:5px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Lorem Ipsum Generator</span><button onclick="document.getElementById(\'lorem-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">';
  h+='<button onclick="document.getElementById(\'lorem-output\').textContent=window._loremGen(50);document.getElementById(\'lorem-count\').textContent=\'50 words\'" style="'+btnStyle+'">50 words</button>';
  h+='<button onclick="document.getElementById(\'lorem-output\').textContent=window._loremGen(100);document.getElementById(\'lorem-count\').textContent=\'100 words\'" style="'+btnStyle+'">100 words</button>';
  h+='<button onclick="document.getElementById(\'lorem-output\').textContent=window._loremGen(200);document.getElementById(\'lorem-count\').textContent=\'200 words\'" style="'+btnStyle+'">200 words</button>';
  h+='<button onclick="document.getElementById(\'lorem-output\').textContent=window._loremGen(500);document.getElementById(\'lorem-count\').textContent=\'500 words\'" style="'+btnStyle+'">500 words</button>';
  h+='<button onclick="var t=window._loremPara(1);document.getElementById(\'lorem-output\').textContent=t;document.getElementById(\'lorem-count\').textContent=t.split(/\\s+/).length+\' words\'" style="'+btnStyle+'">1 para</button>';
  h+='<button onclick="var t=window._loremPara(3);document.getElementById(\'lorem-output\').textContent=t;document.getElementById(\'lorem-count\').textContent=t.split(/\\s+/).length+\' words\'" style="'+btnStyle+'">3 paras</button>';
  h+='<button onclick="var t=window._loremPara(5);document.getElementById(\'lorem-output\').textContent=t;document.getElementById(\'lorem-count\').textContent=t.split(/\\s+/).length+\' words\'" style="'+btnStyle+'">5 paras</button>';
  h+='</div>';
  h+='<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span id="lorem-count" style="font-size:10px;color:var(--text-muted)"></span><button onclick="navigator.clipboard.writeText(document.getElementById(\'lorem-output\').textContent);this.textContent=\'Copied!\';var b=this;setTimeout(function(){b.textContent=\'Copy\'},800)" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px;padding:2px 8px">Copy</button></div>';
  h+='<pre id="lorem-output" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:11px;color:var(--text);white-space:pre-wrap;max-height:200px;overflow-y:auto;line-height:1.5">Click a button above to generate text.</pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showMarkdownPreview(){
  let panel=document.getElementById('md-preview-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='md-preview-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:85vh;overflow-y:auto';
  function mdToHtml(md){
    var out=md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    out=out.replace(/^### (.+)$/gm,'<h3 style="color:var(--text);font-size:14px;margin:12px 0 4px">$1</h3>');
    out=out.replace(/^## (.+)$/gm,'<h2 style="color:var(--text);font-size:16px;margin:14px 0 6px">$1</h2>');
    out=out.replace(/^# (.+)$/gm,'<h1 style="color:var(--accent);font-size:18px;margin:16px 0 8px">$1</h1>');
    out=out.replace(/\*\*(.+?)\*\*/g,'<strong style="color:var(--text)">$1</strong>');
    out=out.replace(/\*(.+?)\*/g,'<em>$1</em>');
    out=out.replace(/`(.+?)`/g,'<code style="background:var(--bg-surface);padding:1px 4px;border-radius:3px;font-size:11px">$1</code>');
    out=out.replace(/^- (.+)$/gm,'<li style="margin-left:16px;font-size:12px">$1</li>');
    out=out.replace(/^---$/gm,'<hr style="border:none;border-top:1px solid var(--border);margin:10px 0">');
    out=out.replace(/\n\n/g,'<br><br>');
    return out;
  }
  window._mdPreviewUpdate=function(){
    var src=document.getElementById('md-src');
    var dest=document.getElementById('md-dest');
    if(src&&dest)dest.innerHTML=mdToHtml(src.value);
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Markdown Preview</span><button onclick="document.getElementById(\'md-preview-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;height:50vh">';
  h+='<textarea id="md-src" oninput="window._mdPreviewUpdate()" placeholder="Type markdown here..." style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:11px;color:var(--text);font-family:var(--mono);resize:none;outline:none">## Hello World\n\nThis is **bold** and *italic* text.\n\n### Features\n- Item one\n- Item two\n- Item three\n\n`inline code` example\n\n---\n\nMore content here.</textarea>';
  h+='<div id="md-dest" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:12px;color:var(--text-muted);overflow-y:auto;line-height:1.6"></div>';
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  window._mdPreviewUpdate();
}
function showTaskHeatmap(){
  let panel=document.getElementById('task-heatmap-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-heatmap-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw';
  var today=new Date();var days=90;var map={};var maxC=0;
  S.tasks.forEach(function(t){
    if(t.completedAt){var ds=t.completedAt.split('T')[0];map[ds]=(map[ds]||0)+1;if(map[ds]>maxC)maxC=map[ds];}
  });
  if(maxC<1)maxC=1;
  var weeks=Math.ceil(days/7);var cellW=9;var cellH=9;var gap=2;
  var svgW=weeks*(cellW+gap)+40;var svgH=7*(cellH+gap)+20;
  var svg='<svg width="'+svgW+'" height="'+svgH+'" viewBox="0 0 '+svgW+' '+svgH+'">';
  var dayLabels=['M','','W','','F','','S'];
  for(var d=0;d<7;d++){svg+='<text x="0" y="'+(d*(cellH+gap)+cellH+8)+'" fill="#666" font-size="7" font-family="var(--mono)">'+dayLabels[d]+'</text>';}
  for(var i=days-1;i>=0;i--){
    var dt=new Date(today);dt.setDate(dt.getDate()-i);
    var ds=dt.toISOString().split('T')[0];
    var dow=dt.getDay();var adjDow=(dow+6)%7;
    var wk=Math.floor((days-1-i)/7);
    var count=map[ds]||0;
    var intensity=count/maxC;
    var color=count===0?'#161b22':intensity<0.25?'#0e4429':intensity<0.5?'#006d32':intensity<0.75?'#26a641':'#39d353';
    svg+='<rect x="'+(wk*(cellW+gap)+20)+'" y="'+(adjDow*(cellH+gap)+8)+'" width="'+cellW+'" height="'+cellH+'" rx="2" fill="'+color+'"><title>'+ds+': '+count+' completed</title></rect>';
  }
  svg+='</svg>';
  var total=0;Object.values(map).forEach(function(v){total+=v;});
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Completion Heatmap</span><button onclick="document.getElementById(\'task-heatmap-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="overflow-x:auto;margin-bottom:10px">'+svg+'</div>';
  h+='<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted)"><span>'+total+' tasks completed in last '+days+' days</span><div style="display:flex;align-items:center;gap:3px"><span>Less</span>';
  ['#161b22','#0e4429','#006d32','#26a641','#39d353'].forEach(function(c){h+='<span style="width:9px;height:9px;border-radius:2px;background:'+c+';display:inline-block"></span>';});
  h+='<span>More</span></div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickTimer(){
  let panel=document.getElementById('quick-timer-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-timer-widget';
  panel.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:220px';
  window._qtSec=0;window._qtRunning=false;window._qtInterval=null;window._qtMode='up';
  window._qtUpdate=function(){
    var el=document.getElementById('qt-display');if(!el)return;
    var s=window._qtSec;
    var m=Math.floor(Math.abs(s)/60);var sec=Math.abs(s)%60;
    el.textContent=(s<0?'-':'')+String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
    if(window._qtMode==='down'&&s<=0&&window._qtRunning){
      clearInterval(window._qtInterval);window._qtRunning=false;
      el.style.color='#ef4444';
    }
  };
  window._qtToggle=function(){
    if(window._qtRunning){clearInterval(window._qtInterval);window._qtRunning=false;return;}
    window._qtRunning=true;
    window._qtInterval=setInterval(function(){
      if(window._qtMode==='up')window._qtSec++;else window._qtSec--;
      window._qtUpdate();
    },1000);
  };
  window._qtReset=function(){
    clearInterval(window._qtInterval);window._qtRunning=false;window._qtSec=0;window._qtUpdate();
    var el=document.getElementById('qt-display');if(el)el.style.color='var(--accent)';
  };
  window._qtSet=function(m){
    clearInterval(window._qtInterval);window._qtRunning=false;
    window._qtMode='down';window._qtSec=m*60;window._qtUpdate();
    var el=document.getElementById('qt-display');if(el)el.style.color='var(--accent)';
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:11px;color:var(--text-muted)">Quick Timer</span><button onclick="document.getElementById(\'quick-timer-widget\').remove();clearInterval(window._qtInterval)" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
  h+='<div id="qt-display" style="font-size:28px;font-weight:700;color:var(--accent);text-align:center;font-family:var(--mono);margin-bottom:8px">00:00</div>';
  h+='<div style="display:flex;gap:4px;justify-content:center;margin-bottom:6px">';
  h+='<button onclick="window._qtToggle()" style="padding:4px 12px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">Start/Pause</button>';
  h+='<button onclick="window._qtReset()" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Reset</button>';
  h+='</div>';
  h+='<div style="display:flex;gap:3px;justify-content:center">';
  [5,10,15,25].forEach(function(m){
    h+='<button onclick="window._qtSet('+m+')" style="padding:2px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px">'+m+'m</button>';
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showCsvViewer(){
  let panel=document.getElementById('csv-viewer-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='csv-viewer-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:85vh;overflow-y:auto';
  window._csvParse=function(){
    var src=document.getElementById('csv-src');
    var dest=document.getElementById('csv-dest');
    var info=document.getElementById('csv-info');
    if(!src||!dest)return;
    var text=src.value.trim();if(!text){dest.innerHTML='<div style="color:var(--text-muted);font-size:11px;padding:20px;text-align:center">Paste CSV data above</div>';return;}
    var lines=text.split('\n').map(function(l){return l.split(',').map(function(c){return c.trim().replace(/^["']|["']$/g,'');});});
    if(lines.length<1)return;
    var headers=lines[0];var rows=lines.slice(1).filter(function(r){return r.length>0&&r.some(function(c){return c;});});
    var table='<table style="width:100%;border-collapse:collapse;font-size:10px"><thead><tr>';
    headers.forEach(function(h){table+='<th style="background:var(--bg-surface);padding:6px 8px;text-align:left;border:1px solid var(--border);color:var(--accent);font-weight:600">'+esc(h)+'</th>';});
    table+='</tr></thead><tbody>';
    rows.forEach(function(r,ri){
      table+='<tr>';
      headers.forEach(function(_,ci){table+='<td style="padding:4px 8px;border:1px solid var(--border);color:var(--text)">'+(r[ci]?esc(r[ci]):'')+'</td>';});
      table+='</tr>';
    });
    table+='</tbody></table>';
    dest.innerHTML=table;
    if(info)info.textContent=headers.length+' columns, '+rows.length+' rows';
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">CSV Viewer</span><button onclick="document.getElementById(\'csv-viewer-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="csv-src" oninput="window._csvParse()" placeholder="Paste CSV data here (comma separated)..." style="width:100%;height:80px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:10px;color:var(--text);font-family:var(--mono);resize:vertical;outline:none;margin-bottom:8px;box-sizing:border-box"></textarea>';
  h+='<div id="csv-info" style="font-size:10px;color:var(--text-muted);margin-bottom:6px"></div>';
  h+='<div id="csv-dest" style="overflow-x:auto"><div style="color:var(--text-muted);font-size:11px;padding:20px;text-align:center">Paste CSV data above</div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskBubbleChart(){
  let panel=document.getElementById('task-bubble-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-bubble-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw';
  var projs={};
  S.tasks.forEach(function(t){
    var p=t.project||'No Project';
    if(!projs[p])projs[p]={total:0,done:0,p0:0,p1:0};
    projs[p].total++;
    if(t.status==='done')projs[p].done++;
    if(t.priority==='p0')projs[p].p0++;
    if(t.priority==='p1')projs[p].p1++;
  });
  var entries=Object.entries(projs).sort(function(a,b){return b[1].total-a[1].total;});
  var maxTotal=Math.max.apply(null,entries.map(function(e){return e[1].total;}));
  if(maxTotal<1)maxTotal=1;
  var w=500,ht=300;
  var svg='<svg width="'+w+'" height="'+ht+'" viewBox="0 0 '+w+' '+ht+'">';
  var colors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316'];
  entries.forEach(function(e,i){
    var r=Math.max(15,Math.sqrt(e[1].total/maxTotal)*60);
    var pct=e[1].total>0?Math.round(e[1].done/e[1].total*100):0;
    var cx=60+i*(w-120)/Math.max(1,entries.length-1);
    var cy=ht/2+(i%2===0?-20:20);
    var col=colors[i%colors.length];
    svg+='<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="'+col+'" opacity="0.3" stroke="'+col+'" stroke-width="1.5"><title>'+esc(e[0])+': '+e[1].total+' tasks ('+pct+'% done)</title></circle>';
    svg+='<text x="'+cx+'" y="'+cy+'" fill="'+col+'" font-size="10" text-anchor="middle" dy="-2" font-weight="600">'+e[1].total+'</text>';
    svg+='<text x="'+cx+'" y="'+cy+'" fill="#999" font-size="7" text-anchor="middle" dy="8">'+pct+'%</text>';
    svg+='<text x="'+cx+'" y="'+(cy+r+12)+'" fill="#888" font-size="8" text-anchor="middle">'+esc(e[0].length>12?e[0].substring(0,12)+'..':e[0])+'</text>';
  });
  svg+='</svg>';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Bubble Chart</span><button onclick="document.getElementById(\'task-bubble-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="text-align:center;overflow-x:auto">'+svg+'</div>';
  h+='<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:6px">Bubble size = task count. Number = total tasks. Percentage = completion rate.</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickHabit(){
  let panel=document.getElementById('quick-habit-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='quick-habit-widget';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px';
  if(!S._habits)S._habits=[];
  var today=new Date().toISOString().split('T')[0];
  function render(){
    var el=document.getElementById('quick-habit-widget');if(!el)return;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:11px;color:var(--text-muted)">Habits Today</span><button onclick="document.getElementById(\'quick-habit-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    if(S._habits.length===0){
      h2+='<div style="font-size:10px;color:var(--text-muted);padding:8px 0;text-align:center">No habits yet</div>';
    }else{
      S._habits.forEach(function(hab,i){
        var done=hab.log&&hab.log.indexOf(today)!==-1;
        var streak=0;
        if(hab.log){
          var d=new Date();
          for(var k=0;k<365;k++){
            var ds=d.toISOString().split('T')[0];
            if(hab.log.indexOf(ds)!==-1){streak++;}else break;
            d.setDate(d.getDate()-1);
          }
        }
        h2+='<div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid var(--border)">';
        h2+='<button onclick="window._habitToggle('+i+')" style="width:18px;height:18px;border-radius:4px;border:1px solid '+(done?'var(--accent)':'var(--border)')+';background:'+(done?'var(--accent)':'transparent')+';cursor:pointer;display:flex;align-items:center;justify-content:center;color:#000;font-size:10px;font-weight:700">'+(done?'V':'')+'</button>';
        h2+='<span style="font-size:11px;color:var(--text);flex:1">'+esc(hab.name)+'</span>';
        h2+='<span style="font-size:9px;color:var(--accent);font-family:var(--mono)">'+streak+'d</span>';
        h2+='<button onclick="window._habitDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:10px">x</button>';
        h2+='</div>';
      });
    }
    h2+='<div style="display:flex;gap:4px;margin-top:8px"><input id="habit-new-input" placeholder="New habit..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:10px;color:var(--text);outline:none" onkeydown="if(event.key===\'Enter\')window._habitAdd()"><button onclick="window._habitAdd()" style="padding:4px 8px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">+</button></div>';
    el.innerHTML=h2;
  }
  window._habitToggle=function(i){
    var hab=S._habits[i];if(!hab)return;
    if(!hab.log)hab.log=[];
    var idx=hab.log.indexOf(today);
    if(idx!==-1)hab.log.splice(idx,1);else hab.log.push(today);
    save();render();
  };
  window._habitDel=function(i){S._habits.splice(i,1);save();render();};
  window._habitAdd=function(){
    var inp=document.getElementById('habit-new-input');if(!inp||!inp.value.trim())return;
    S._habits.push({name:inp.value.trim(),log:[]});save();render();
  };
  render();
}
function showUnitConverter(){
  let panel=document.getElementById('unit-conv-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='unit-conv-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  var cats={
    length:{units:['m','km','cm','mm','in','ft','yd','mi'],base:[1,1000,0.01,0.001,0.0254,0.3048,0.9144,1609.34]},
    weight:{units:['kg','g','mg','lb','oz','ton'],base:[1,0.001,0.000001,0.453592,0.0283495,1000]},
    temperature:{units:['C','F','K'],special:true},
    time:{units:['s','min','hr','day','week'],base:[1,60,3600,86400,604800]},
    data:{units:['B','KB','MB','GB','TB'],base:[1,1024,1048576,1073741824,1099511627776]}
  };
  window._ucCat='length';
  window._ucConvert=function(){
    var val=parseFloat(document.getElementById('uc-val').value);
    var from=document.getElementById('uc-from').value;
    var to=document.getElementById('uc-to').value;
    var cat=cats[window._ucCat];
    var res=document.getElementById('uc-result');
    if(isNaN(val)||!res)return;
    var result;
    if(cat.special){
      var inC=from==='C'?val:from==='F'?(val-32)*5/9:val-273.15;
      result=to==='C'?inC:to==='F'?inC*9/5+32:inC+273.15;
    }else{
      var fi=cat.units.indexOf(from);var ti=cat.units.indexOf(to);
      if(fi===-1||ti===-1)return;
      result=val*cat.base[fi]/cat.base[ti];
    }
    res.textContent=val+' '+from+' = '+parseFloat(result.toFixed(8))+' '+to;
  };
  window._ucSetCat=function(c){
    window._ucCat=c;
    var cat=cats[c];
    var opts=cat.units.map(function(u){return '<option value="'+u+'">'+u+'</option>';}).join('');
    document.getElementById('uc-from').innerHTML=opts;
    document.getElementById('uc-to').innerHTML=opts;
    if(cat.units.length>1)document.getElementById('uc-to').selectedIndex=1;
    document.getElementById('uc-result').textContent='';
  };
  var selStyle='background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px;font-size:11px;color:var(--text);outline:none';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Unit Converter</span><button onclick="document.getElementById(\'unit-conv-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap">';
  Object.keys(cats).forEach(function(c){
    h+='<button onclick="window._ucSetCat(\''+c+'\')" style="padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px;text-transform:capitalize">'+c+'</button>';
  });
  h+='</div>';
  h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">';
  h+='<input id="uc-val" type="number" value="1" oninput="window._ucConvert()" style="width:80px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px;font-size:12px;color:var(--text);outline:none;font-family:var(--mono)">';
  var defOpts=cats.length.units.map(function(u){return '<option value="'+u+'">'+u+'</option>';}).join('');
  h+='<select id="uc-from" onchange="window._ucConvert()" style="'+selStyle+'">'+defOpts+'</select>';
  h+='<span style="color:var(--text-muted);font-size:14px">-></span>';
  h+='<select id="uc-to" onchange="window._ucConvert()" style="'+selStyle+'">'+defOpts+'</select>';
  h+='</div>';
  h+='<div id="uc-result" style="font-size:14px;font-weight:600;color:var(--accent);font-family:var(--mono);padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center;min-height:24px"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  document.getElementById('uc-to').selectedIndex=1;
  window._ucConvert();
}
function showTaskSunburst(){
  let panel=document.getElementById('task-sunburst-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-sunburst-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw';
  var projs={};
  S.tasks.forEach(function(t){
    var p=t.project||'No Project';
    if(!projs[p])projs[p]={todo:0,inprog:0,done:0};
    if(t.status==='done')projs[p].done++;
    else if(t.status==='in-progress')projs[p].inprog++;
    else projs[p].todo++;
  });
  var entries=Object.entries(projs).sort(function(a,b){var ta=a[1].todo+a[1].inprog+a[1].done;var tb=b[1].todo+b[1].inprog+b[1].done;return tb-ta;});
  var total=S.tasks.length||1;
  var colors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316'];
  var w=360,ht=360;var cx=w/2,cy=ht/2;var outerR=150,innerR=80,midR=115;
  var svg='<svg width="'+w+'" height="'+ht+'" viewBox="0 0 '+w+' '+ht+'">';
  var angle=0;
  entries.forEach(function(e,i){
    var sub=e[1];var projTotal=sub.todo+sub.inprog+sub.done;
    var sweep=projTotal/total*360;
    var col=colors[i%colors.length];
    var startRad=angle*Math.PI/180;var endRad=(angle+sweep)*Math.PI/180;
    var large=sweep>180?1:0;
    // Outer ring - project
    var x1o=cx+outerR*Math.cos(startRad-Math.PI/2);var y1o=cy+outerR*Math.sin(startRad-Math.PI/2);
    var x2o=cx+outerR*Math.cos(endRad-Math.PI/2);var y2o=cy+outerR*Math.sin(endRad-Math.PI/2);
    var x1m=cx+midR*Math.cos(startRad-Math.PI/2);var y1m=cy+midR*Math.sin(startRad-Math.PI/2);
    var x2m=cx+midR*Math.cos(endRad-Math.PI/2);var y2m=cy+midR*Math.sin(endRad-Math.PI/2);
    if(sweep>0.5){
      svg+='<path d="M '+x1m+' '+y1m+' A '+midR+' '+midR+' 0 '+large+' 1 '+x2m+' '+y2m+' L '+x2o+' '+y2o+' A '+outerR+' '+outerR+' 0 '+large+' 0 '+x1o+' '+y1o+' Z" fill="'+col+'" opacity="0.7" stroke="#111" stroke-width="1"><title>'+esc(e[0])+': '+projTotal+' tasks</title></path>';
    }
    // Inner ring - status breakdown
    var subAngle=angle;
    [{v:sub.done,c:'#4ade80'},{v:sub.inprog,c:'#f59e0b'},{v:sub.todo,c:'#666'}].forEach(function(s){
      if(s.v===0)return;
      var ss=s.v/total*360;
      var sr=subAngle*Math.PI/180;var er=(subAngle+ss)*Math.PI/180;
      var sl=ss>180?1:0;
      var x1i=cx+innerR*Math.cos(sr-Math.PI/2);var y1i=cy+innerR*Math.sin(sr-Math.PI/2);
      var x2i=cx+innerR*Math.cos(er-Math.PI/2);var y2i=cy+innerR*Math.sin(er-Math.PI/2);
      var x1c=cx+50*Math.cos(sr-Math.PI/2);var y1c=cy+50*Math.sin(sr-Math.PI/2);
      var x2c=cx+50*Math.cos(er-Math.PI/2);var y2c=cy+50*Math.sin(er-Math.PI/2);
      if(ss>0.5){
        svg+='<path d="M '+x1c+' '+y1c+' A 50 50 0 '+sl+' 1 '+x2c+' '+y2c+' L '+x2i+' '+y2i+' A '+innerR+' '+innerR+' 0 '+sl+' 0 '+x1i+' '+y1i+' Z" fill="'+s.c+'" opacity="0.5" stroke="#111" stroke-width="0.5"></path>';
      }
      subAngle+=ss;
    });
    angle+=sweep;
  });
  svg+='<circle cx="'+cx+'" cy="'+cy+'" r="45" fill="var(--bg-elevated)"/>';
  svg+='<text x="'+cx+'" y="'+(cy-4)+'" fill="var(--text)" font-size="18" text-anchor="middle" font-weight="700">'+S.tasks.length+'</text>';
  svg+='<text x="'+cx+'" y="'+(cy+10)+'" fill="#888" font-size="9" text-anchor="middle">tasks</text>';
  svg+='</svg>';
  var legend=entries.map(function(e,i){var t=e[1].todo+e[1].inprog+e[1].done;return '<span style="display:inline-flex;align-items:center;gap:3px;font-size:8px;color:var(--text-muted)"><span style="width:8px;height:8px;border-radius:2px;background:'+colors[i%colors.length]+'"></span>'+esc(e[0])+' ('+t+')</span>';}).join(' ');
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Sunburst</span><button onclick="document.getElementById(\'task-sunburst-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="text-align:center">'+svg+'</div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:6px">'+legend+'</div>';
  h+='<div style="display:flex;gap:10px;justify-content:center;margin-top:6px;font-size:8px;color:var(--text-muted)"><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#4ade80;border-radius:2px"></span>Done</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#f59e0b;border-radius:2px"></span>In Progress</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#666;border-radius:2px"></span>Todo</span></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickFlashcard(){
  let panel=document.getElementById('flashcard-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='flashcard-widget';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw';
  if(!S._flashcards)S._flashcards=[];
  window._fcIdx=0;window._fcFlipped=false;
  function render(){
    var el=document.getElementById('flashcard-widget');if(!el)return;
    var cards=S._flashcards;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Flashcards</span><div style="display:flex;align-items:center;gap:8px"><span style="font-size:10px;color:var(--text-muted)">'+cards.length+' cards</span><button onclick="document.getElementById(\'flashcard-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div></div>';
    if(cards.length>0){
      var c=cards[window._fcIdx%cards.length];
      h2+='<div onclick="window._fcFlipped=!window._fcFlipped;window._fcRender()" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;min-height:120px;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-bottom:10px;text-align:center">';
      h2+='<div><div style="font-size:8px;color:var(--text-muted);margin-bottom:6px">'+(window._fcFlipped?'ANSWER':'QUESTION')+' ('+(window._fcIdx%cards.length+1)+'/'+cards.length+')</div>';
      h2+='<div style="font-size:14px;color:'+(window._fcFlipped?'var(--accent)':'var(--text)')+'">'+(window._fcFlipped?esc(c.back):esc(c.front))+'</div></div></div>';
      h2+='<div style="display:flex;gap:6px;justify-content:center;margin-bottom:10px">';
      h2+='<button onclick="window._fcIdx--;if(window._fcIdx<0)window._fcIdx=S._flashcards.length-1;window._fcFlipped=false;window._fcRender()" style="padding:4px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Prev</button>';
      h2+='<button onclick="window._fcFlipped=!window._fcFlipped;window._fcRender()" style="padding:4px 12px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">Flip</button>';
      h2+='<button onclick="window._fcIdx++;window._fcFlipped=false;window._fcRender()" style="padding:4px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Next</button>';
      h2+='<button onclick="S._flashcards.splice(window._fcIdx%S._flashcards.length,1);if(window._fcIdx>=S._flashcards.length)window._fcIdx=0;save();window._fcRender()" style="padding:4px 8px;background:none;border:1px solid #555;border-radius:var(--radius);color:#888;cursor:pointer;font-size:9px">Del</button>';
      h2+='</div>';
    }else{
      h2+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No flashcards yet. Add one below.</div>';
    }
    h2+='<div style="border-top:1px solid var(--border);padding-top:8px;display:flex;flex-direction:column;gap:4px">';
    h2+='<input id="fc-front" placeholder="Front (question)..." style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none">';
    h2+='<input id="fc-back" placeholder="Back (answer)..." style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none">';
    h2+='<button onclick="window._fcAdd()" style="padding:5px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">Add Card</button>';
    h2+='</div>';
    el.innerHTML=h2;
  }
  window._fcRender=render;
  window._fcAdd=function(){
    var f=document.getElementById('fc-front');var b=document.getElementById('fc-back');
    if(!f||!b||!f.value.trim()||!b.value.trim())return;
    S._flashcards.push({front:f.value.trim(),back:b.value.trim()});
    save();render();
  };
  render();
}
function showDiffTool(){
  let panel=document.getElementById('diff-tool-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='diff-tool-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:85vh;overflow-y:auto';
  window._diffCompare=function(){
    var a=(document.getElementById('diff-a').value||'').split('\n');
    var b=(document.getElementById('diff-b').value||'').split('\n');
    var out=document.getElementById('diff-out');if(!out)return;
    var maxLen=Math.max(a.length,b.length);
    var html='';
    for(var i=0;i<maxLen;i++){
      var la=a[i]||'';var lb=b[i]||'';
      if(la===lb){
        html+='<div style="display:flex;font-size:10px;font-family:var(--mono);line-height:1.6"><span style="width:30px;text-align:right;color:#555;padding-right:6px;flex-shrink:0">'+(i+1)+'</span><span style="color:var(--text-muted);flex:1;white-space:pre-wrap">'+esc(la)+'</span></div>';
      }else{
        if(la)html+='<div style="display:flex;font-size:10px;font-family:var(--mono);line-height:1.6;background:rgba(239,68,68,0.1)"><span style="width:30px;text-align:right;color:#555;padding-right:6px;flex-shrink:0">'+(i+1)+'</span><span style="color:#ef4444;flex:1;white-space:pre-wrap">- '+esc(la)+'</span></div>';
        if(lb)html+='<div style="display:flex;font-size:10px;font-family:var(--mono);line-height:1.6;background:rgba(74,222,128,0.1)"><span style="width:30px;text-align:right;color:#555;padding-right:6px;flex-shrink:0">'+(i+1)+'</span><span style="color:#4ade80;flex:1;white-space:pre-wrap">+ '+esc(lb)+'</span></div>';
      }
    }
    var added=0,removed=0,same=0;
    for(var j=0;j<maxLen;j++){if((a[j]||'')===(b[j]||''))same++;else{if(a[j])removed++;if(b[j])added++;}}
    out.innerHTML='<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px;display:flex;gap:10px"><span style="color:#4ade80">+'+added+' added</span><span style="color:#ef4444">-'+removed+' removed</span><span>'+same+' unchanged</span></div>'+html;
  };
  var taStyle='width:100%;height:120px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:10px;color:var(--text);font-family:var(--mono);resize:vertical;outline:none;box-sizing:border-box';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Text Diff Tool</span><button onclick="document.getElementById(\'diff-tool-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">';
  h+='<div><div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Original</div><textarea id="diff-a" style="'+taStyle+'" placeholder="Paste original text..."></textarea></div>';
  h+='<div><div style="font-size:9px;color:var(--text-muted);margin-bottom:4px">Modified</div><textarea id="diff-b" style="'+taStyle+'" placeholder="Paste modified text..."></textarea></div>';
  h+='</div>';
  h+='<button onclick="window._diffCompare()" style="padding:6px 16px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:11px;font-weight:600;margin-bottom:8px">Compare</button>';
  h+='<div id="diff-out" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;max-height:200px;overflow-y:auto"><div style="color:var(--text-muted);font-size:10px;text-align:center;padding:12px">Paste text in both panels and click Compare</div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskRadar(){
  let panel=document.getElementById('task-radar-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-radar-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw';
  var total=S.tasks.length||1;
  var done=S.tasks.filter(function(t){return t.status==='done';}).length;
  var overdue=S.tasks.filter(function(t){return t.due&&t.due<new Date().toISOString().split('T')[0]&&t.status!=='done';}).length;
  var p0=S.tasks.filter(function(t){return t.priority==='p0'&&t.status!=='done';}).length;
  var withSub=S.tasks.filter(function(t){return t.subtasks&&t.subtasks.length>0;}).length;
  var withDesc=S.tasks.filter(function(t){return t.description&&t.description.trim();}).length;
  var axes=[
    {label:'Completion',value:Math.min(100,Math.round(done/total*100))},
    {label:'On-time',value:Math.min(100,Math.round((1-overdue/total)*100))},
    {label:'Low Risk',value:Math.min(100,Math.round((1-p0/total)*100))},
    {label:'Detailed',value:Math.min(100,Math.round(withDesc/total*100))},
    {label:'Subtasked',value:Math.min(100,Math.round(withSub/total*100))}
  ];
  var w=360,ht=320;var cx=w/2,cy=ht/2;var maxR=120;
  var svg='<svg width="'+w+'" height="'+ht+'" viewBox="0 0 '+w+' '+ht+'">';
  // Grid rings
  [0.25,0.5,0.75,1].forEach(function(f){
    var r=maxR*f;var pts=[];
    for(var a=0;a<axes.length;a++){
      var ang=(a/axes.length)*2*Math.PI-Math.PI/2;
      pts.push((cx+r*Math.cos(ang)).toFixed(1)+','+(cy+r*Math.sin(ang)).toFixed(1));
    }
    svg+='<polygon points="'+pts.join(' ')+'" fill="none" stroke="#333" stroke-width="0.5"/>';
  });
  // Axis lines + labels
  axes.forEach(function(ax,i){
    var ang=(i/axes.length)*2*Math.PI-Math.PI/2;
    var x2=cx+maxR*Math.cos(ang);var y2=cy+maxR*Math.sin(ang);
    svg+='<line x1="'+cx+'" y1="'+cy+'" x2="'+x2+'" y2="'+y2+'" stroke="#333" stroke-width="0.5"/>';
    var lx=cx+(maxR+14)*Math.cos(ang);var ly=cy+(maxR+14)*Math.sin(ang);
    svg+='<text x="'+lx+'" y="'+ly+'" fill="#888" font-size="8" text-anchor="middle" dy="3">'+ax.label+' ('+ax.value+'%)</text>';
  });
  // Data polygon
  var dataPts=[];
  axes.forEach(function(ax,i){
    var ang=(i/axes.length)*2*Math.PI-Math.PI/2;
    var r=maxR*(ax.value/100);
    dataPts.push((cx+r*Math.cos(ang)).toFixed(1)+','+(cy+r*Math.sin(ang)).toFixed(1));
  });
  svg+='<polygon points="'+dataPts.join(' ')+'" fill="rgba(74,222,128,0.15)" stroke="#4ade80" stroke-width="2"/>';
  axes.forEach(function(ax,i){
    var ang=(i/axes.length)*2*Math.PI-Math.PI/2;
    var r=maxR*(ax.value/100);
    svg+='<circle cx="'+(cx+r*Math.cos(ang)).toFixed(1)+'" cy="'+(cy+r*Math.sin(ang)).toFixed(1)+'" r="3" fill="#4ade80"/>';
  });
  svg+='</svg>';
  var score=Math.round(axes.reduce(function(s,a){return s+a.value;},0)/axes.length);
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Health Radar</span><button onclick="document.getElementById(\'task-radar-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="text-align:center">'+svg+'</div>';
  h+='<div style="text-align:center;font-size:12px;color:var(--accent);font-weight:600;margin-top:4px">Health Score: '+score+'%</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickJournal(){
  let panel=document.getElementById('journal-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='journal-widget';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._journal)S._journal=[];
  var today=new Date().toISOString().split('T')[0];
  window._jnlSave=function(){
    var ta=document.getElementById('jnl-text');if(!ta||!ta.value.trim())return;
    S._journal.unshift({date:today,text:ta.value.trim(),time:new Date().toLocaleTimeString()});
    save();window._jnlRender();
  };
  window._jnlDel=function(i){S._journal.splice(i,1);save();window._jnlRender();};
  window._jnlRender=function(){
    var el=document.getElementById('journal-widget');if(!el)return;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Quick Journal</span><div style="display:flex;align-items:center;gap:8px"><span style="font-size:10px;color:var(--text-muted)">'+S._journal.length+' entries</span><button onclick="document.getElementById(\'journal-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div></div>';
    h2+='<textarea id="jnl-text" placeholder="What is on your mind today?" style="width:100%;height:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:11px;color:var(--text);resize:none;outline:none;margin-bottom:6px;box-sizing:border-box"></textarea>';
    h2+='<button onclick="window._jnlSave()" style="padding:5px 14px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600;margin-bottom:10px">Save Entry</button>';
    var shown=S._journal.slice(0,20);
    if(shown.length>0){
      h2+='<div style="border-top:1px solid var(--border);padding-top:8px">';
      shown.forEach(function(e,i){
        h2+='<div style="padding:6px 0;border-bottom:1px solid var(--border)">';
        h2+='<div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:9px;color:var(--accent);font-family:var(--mono)">'+e.date+' '+e.time+'</span><button onclick="window._jnlDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button></div>';
        h2+='<div style="font-size:11px;color:var(--text);line-height:1.5;white-space:pre-wrap">'+esc(e.text)+'</div>';
        h2+='</div>';
      });
      h2+='</div>';
    }else{
      h2+='<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:10px">No journal entries yet</div>';
    }
    el.innerHTML=h2;
  };
  window._jnlRender();
}
function showPasswordGenerator(){
  let panel=document.getElementById('pwd-gen-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='pwd-gen-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  window._pwdGen=function(){
    var len=parseInt(document.getElementById('pwd-len').value)||16;
    var upper=document.getElementById('pwd-upper').checked;
    var lower=document.getElementById('pwd-lower').checked;
    var nums=document.getElementById('pwd-nums').checked;
    var syms=document.getElementById('pwd-syms').checked;
    var chars='';
    if(upper)chars+='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    if(lower)chars+='abcdefghijklmnopqrstuvwxyz';
    if(nums)chars+='0123456789';
    if(syms)chars+='!@#$%^&*()_+-=[]{}|;:,.<>?';
    if(!chars)chars='abcdefghijklmnopqrstuvwxyz0123456789';
    var pwd='';var arr=new Uint32Array(len);crypto.getRandomValues(arr);
    for(var i=0;i<len;i++)pwd+=chars[arr[i]%chars.length];
    document.getElementById('pwd-out').value=pwd;
    var strength=0;
    if(len>=12)strength++;if(len>=16)strength++;
    if(upper&&lower)strength++;if(nums)strength++;if(syms)strength++;
    var labels=['Very Weak','Weak','Fair','Strong','Very Strong'];
    var colors=['#ef4444','#f59e0b','#eab308','#22c55e','#4ade80'];
    var si=Math.min(strength,4);
    document.getElementById('pwd-strength').textContent=labels[si];
    document.getElementById('pwd-strength').style.color=colors[si];
  };
  var cbStyle='accent-color:var(--accent)';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Password Generator</span><button onclick="document.getElementById(\'pwd-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><label style="font-size:10px;color:var(--text-muted)">Length:</label><input id="pwd-len" type="number" value="16" min="4" max="128" style="width:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 6px;font-size:11px;color:var(--text);outline:none;font-family:var(--mono)"></div>';
  h+='<div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap">';
  h+='<label style="font-size:10px;color:var(--text);display:flex;align-items:center;gap:4px"><input id="pwd-upper" type="checkbox" checked style="'+cbStyle+'">ABC</label>';
  h+='<label style="font-size:10px;color:var(--text);display:flex;align-items:center;gap:4px"><input id="pwd-lower" type="checkbox" checked style="'+cbStyle+'">abc</label>';
  h+='<label style="font-size:10px;color:var(--text);display:flex;align-items:center;gap:4px"><input id="pwd-nums" type="checkbox" checked style="'+cbStyle+'">123</label>';
  h+='<label style="font-size:10px;color:var(--text);display:flex;align-items:center;gap:4px"><input id="pwd-syms" type="checkbox" checked style="'+cbStyle+'">!@#</label>';
  h+='</div>';
  h+='<button onclick="window._pwdGen()" style="padding:6px 16px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:11px;font-weight:600;margin-bottom:10px">Generate</button>';
  h+='<div style="display:flex;gap:6px;margin-bottom:6px"><input id="pwd-out" readonly style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:13px;color:var(--accent);font-family:var(--mono);outline:none"><button onclick="navigator.clipboard.writeText(document.getElementById(\'pwd-out\').value);this.textContent=\'Done\';var b=this;setTimeout(function(){b.textContent=\'Copy\'},800)" style="padding:6px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Copy</button></div>';
  h+='<div id="pwd-strength" style="font-size:10px;font-weight:600;text-align:center"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  window._pwdGen();
}
function showTaskCompletionTrend(){
  let panel=document.getElementById('task-trend-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-trend-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw';
  var days=30;var today=new Date();var dates=[];
  for(var i=days-1;i>=0;i--){var d=new Date(today);d.setDate(d.getDate()-i);dates.push(d.toISOString().split('T')[0]);}
  var completed=dates.map(function(ds){return S.tasks.filter(function(t){return t.completedAt&&t.completedAt.startsWith(ds);}).length;});
  var cumul=[];var sum=0;
  completed.forEach(function(c){sum+=c;cumul.push(sum);});
  var maxC=Math.max.apply(null,completed.concat([1]));
  var maxCum=Math.max.apply(null,cumul.concat([1]));
  var w=500,ht=220,pad=40,gw=w-pad*2,gh=ht-pad*2;
  var svg='<svg width="'+w+'" height="'+ht+'" viewBox="0 0 '+w+' '+ht+'" style="font-family:var(--mono)">';
  // Grid
  for(var g=0;g<=4;g++){var y=pad+gh-gh*(g/4);svg+='<line x1="'+pad+'" y1="'+y+'" x2="'+(pad+gw)+'" y2="'+y+'" stroke="#222" stroke-width="0.5"/>';}
  // Daily bars
  var barW=Math.max(2,Math.floor(gw/days*0.6));
  dates.forEach(function(ds,i){
    var x=pad+i*(gw/days);
    var bh=completed[i]?(completed[i]/maxC)*gh:0;
    svg+='<rect x="'+x+'" y="'+(pad+gh-bh)+'" width="'+barW+'" height="'+bh+'" fill="#4ade80" rx="1" opacity="0.6"><title>'+ds+': '+completed[i]+' done</title></rect>';
    if(i%7===0){svg+='<text x="'+(x+barW/2)+'" y="'+(ht-5)+'" fill="#666" font-size="7" text-anchor="middle">'+ds.substring(5)+'</text>';}
  });
  // Cumulative line
  var pts=[];
  dates.forEach(function(ds,i){
    var x=pad+i*(gw/days)+barW/2;
    var y=pad+gh-gh*(cumul[i]/maxCum);
    pts.push(x+','+y);
  });
  svg+='<polyline points="'+pts.join(' ')+'" fill="none" stroke="#3b82f6" stroke-width="2" opacity="0.8"/>';
  svg+='</svg>';
  var avg=(sum/days).toFixed(1);
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Completion Trend (30d)</span><button onclick="document.getElementById(\'task-trend-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="overflow-x:auto">'+svg+'</div>';
  h+='<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:6px"><span>Total: '+sum+' completed</span><span>Avg: '+avg+'/day</span><span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:3px;background:#4ade80;border-radius:1px"></span>Daily <span style="width:10px;height:3px;background:#3b82f6;border-radius:1px"></span>Cumulative</span></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickBookmark(){
  let panel=document.getElementById('qbm-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='qbm-widget';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:300px;max-height:400px;overflow-y:auto';
  if(!S._quickBookmarks)S._quickBookmarks=[];
  window._qbmAdd=function(){
    var inp=document.getElementById('qbm-url');var name=document.getElementById('qbm-name');
    if(!inp||!inp.value.trim())return;
    S._quickBookmarks.unshift({url:inp.value.trim(),name:(name&&name.value.trim())||inp.value.trim(),added:new Date().toISOString().split('T')[0]});
    save();window._qbmRender();
  };
  window._qbmDel=function(i){S._quickBookmarks.splice(i,1);save();window._qbmRender();};
  window._qbmRender=function(){
    var el=document.getElementById('qbm-widget');if(!el)return;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:11px;color:var(--text-muted)">Quick Bookmarks</span><button onclick="document.getElementById(\'qbm-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:8px"><input id="qbm-url" placeholder="URL..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 6px;font-size:9px;color:var(--text);outline:none"><input id="qbm-name" placeholder="Label..." style="width:70px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 6px;font-size:9px;color:var(--text);outline:none"><button onclick="window._qbmAdd()" style="padding:4px 8px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:9px;font-weight:600">+</button></div>';
    S._quickBookmarks.forEach(function(b,i){
      h2+='<div style="display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid var(--border)">';
      h2+='<img src="https://www.google.com/s2/favicons?domain='+encodeURIComponent(b.url)+'" width="12" height="12" style="border-radius:2px" onerror="this.style.display=\'none\'">';
      h2+='<a href="'+esc(b.url)+'" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(b.name)+'</a>';
      h2+='<span style="font-size:8px;color:#555;font-family:var(--mono)">'+b.added+'</span>';
      h2+='<button onclick="window._qbmDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button>';
      h2+='</div>';
    });
    if(S._quickBookmarks.length===0)h2+='<div style="padding:8px;text-align:center;font-size:10px;color:var(--text-muted)">No bookmarks yet</div>';
    el.innerHTML=h2;
  };
  window._qbmRender();
}
function showAsciiArt(){
  let panel=document.getElementById('ascii-art-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='ascii-art-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  var bigLetters={A:['  #  ','## ##','#####','#   #','#   #'],B:['#### ','#   #','#### ','#   #','#### '],C:[' ### ','#   ','#   ',' #  ',' ### '],D:['#### ','#   #','#   #','#   #','#### '],E:['#####','#    ','#### ','#    ','#####'],F:['#####','#    ','#### ','#    ','#    '],G:[' ### ','#    ','# ##','#  # ',' ### '],H:['#   #','#   #','#####','#   #','#   #'],I:['#####','  #  ','  #  ','  #  ','#####'],K:['#  # ','# #  ','##   ','# #  ','#  # '],L:['#    ','#    ','#    ','#    ','#####'],M:['#   #','## ##','# # #','#   #','#   #'],N:['#   #','##  #','# # #','#  ##','#   #'],O:[' ### ','#   #','#   #','#   #',' ### '],P:['#### ','#   #','#### ','#    ','#    '],R:['#### ','#   #','#### ','# #  ','#  ##'],S:[' ####','#    ',' ### ','    #','#### '],T:['#####','  #  ','  #  ','  #  ','  #  '],U:['#   #','#   #','#   #','#   #',' ### '],V:['#   #','#   #',' # # ',' # # ','  #  '],W:['#   #','#   #','# # #','## ##','#   #'],X:['#   #',' # # ','  #  ',' # # ','#   #'],Y:['#   #',' # # ','  #  ','  #  ','  #  '],Z:['#####','   # ','  #  ',' #   ','#####'],' ':['     ','     ','     ','     ','     ']};
  window._asciiGen=function(){
    var txt=(document.getElementById('ascii-input').value||'').toUpperCase();
    var lines=['','','','',''];
    for(var c=0;c<txt.length;c++){
      var ch=txt[c];var letter=bigLetters[ch]||bigLetters[' '];
      for(var r=0;r<5;r++)lines[r]+=letter[r]+' ';
    }
    document.getElementById('ascii-out').textContent=lines.join('\n');
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">ASCII Art Generator</span><button onclick="document.getElementById(\'ascii-art-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:10px"><input id="ascii-input" oninput="window._asciiGen()" placeholder="Type text..." maxlength="12" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px 10px;font-size:12px;color:var(--text);outline:none"><button onclick="navigator.clipboard.writeText(document.getElementById(\'ascii-out\').textContent);this.textContent=\'Done\';var b=this;setTimeout(function(){b.textContent=\'Copy\'},800)" style="padding:6px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Copy</button></div>';
  h+='<pre id="ascii-out" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;font-size:10px;color:var(--accent);font-family:var(--mono);overflow-x:auto;line-height:1.2;min-height:60px"></pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskPriorityMatrix(){
  let panel=document.getElementById('task-primatrix-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-primatrix-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:80vh;overflow-y:auto';
  var pMap={p0:{label:'Critical',color:'#ef4444',bg:'rgba(239,68,68,0.1)'},p1:{label:'High',color:'#f59e0b',bg:'rgba(245,158,11,0.1)'},p2:{label:'Medium',color:'#3b82f6',bg:'rgba(59,130,246,0.1)'},p3:{label:'Low',color:'#6b7280',bg:'rgba(107,114,128,0.1)'}};
  var active=S.tasks.filter(function(t){return t.status!=='done';});
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Priority Matrix</span><button onclick="document.getElementById(\'task-primatrix-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  ['p0','p1','p2','p3'].forEach(function(p){
    var info=pMap[p];
    var tasks=active.filter(function(t){return (t.priority||'p2')===p;});
    h+='<div style="background:'+info.bg+';border:1px solid '+info.color+'33;border-radius:var(--radius);padding:10px">';
    h+='<div style="font-size:11px;font-weight:600;color:'+info.color+';margin-bottom:6px;display:flex;justify-content:space-between"><span>'+info.label+'</span><span style="font-family:var(--mono)">'+tasks.length+'</span></div>';
    tasks.slice(0,8).forEach(function(t){
      h+='<div onclick="document.getElementById(\'task-primatrix-panel\').remove();openTaskDetail('+t.id+')" style="font-size:10px;color:var(--text);padding:3px 6px;background:var(--bg-surface);border-radius:3px;margin-bottom:3px;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" onmouseenter="this.style.background=\'var(--bg-hover)\'" onmouseleave="this.style.background=\'var(--bg-surface)\'">';
      h+=esc(t.title||'Untitled');
      if(t.due){var isOd=t.due<new Date().toISOString().split('T')[0];h+=' <span style="font-size:8px;color:'+(isOd?'#ef4444':'var(--text-muted)')+';font-family:var(--mono)">'+t.due.substring(5)+'</span>';}
      h+='</div>';
    });
    if(tasks.length>8)h+='<div style="font-size:9px;color:var(--text-muted);margin-top:3px">+'+(tasks.length-8)+' more</div>';
    if(tasks.length===0)h+='<div style="font-size:9px;color:var(--text-muted);font-style:italic">No tasks</div>';
    h+='</div>';
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickSnippet(){
  let panel=document.getElementById('snippet-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='snippet-widget';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._snippets)S._snippets=[];
  window._snipAdd=function(){
    var title=document.getElementById('snip-title');var code=document.getElementById('snip-code');var lang=document.getElementById('snip-lang');
    if(!title||!code||!title.value.trim()||!code.value.trim())return;
    S._snippets.unshift({title:title.value.trim(),code:code.value.trim(),lang:(lang&&lang.value)||'text',created:new Date().toISOString().split('T')[0]});
    save();window._snipRender();
  };
  window._snipDel=function(i){S._snippets.splice(i,1);save();window._snipRender();};
  window._snipCopy=function(i){navigator.clipboard.writeText(S._snippets[i].code);};
  window._snipRender=function(){
    var el=document.getElementById('snippet-widget');if(!el)return;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Code Snippets</span><div style="display:flex;align-items:center;gap:8px"><span style="font-size:10px;color:var(--text-muted)">'+S._snippets.length+'</span><button onclick="document.getElementById(\'snippet-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div></div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:6px"><input id="snip-title" placeholder="Title..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 6px;font-size:10px;color:var(--text);outline:none"><select id="snip-lang" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px;font-size:9px;color:var(--text);outline:none"><option>js</option><option>css</option><option>html</option><option>python</option><option>bash</option><option>sql</option><option>text</option></select></div>';
    h2+='<textarea id="snip-code" placeholder="Paste code..." style="width:100%;height:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px;font-size:10px;color:var(--text);font-family:var(--mono);resize:vertical;outline:none;margin-bottom:6px;box-sizing:border-box"></textarea>';
    h2+='<button onclick="window._snipAdd()" style="padding:5px 14px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600;margin-bottom:10px">Save Snippet</button>';
    S._snippets.slice(0,15).forEach(function(s,i){
      h2+='<div style="border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px;overflow:hidden">';
      h2+='<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 8px;background:var(--bg-surface)"><span style="font-size:10px;color:var(--text);font-weight:600">'+esc(s.title)+'</span><div style="display:flex;gap:4px"><span style="font-size:8px;color:var(--accent);font-family:var(--mono)">'+s.lang+'</span><button onclick="window._snipCopy('+i+')" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-muted);cursor:pointer;font-size:8px;padding:1px 6px">Copy</button><button onclick="window._snipDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button></div></div>';
      h2+='<pre style="padding:6px 8px;font-size:9px;color:var(--text-muted);font-family:var(--mono);margin:0;max-height:80px;overflow-y:auto;white-space:pre-wrap">'+esc(s.code)+'</pre>';
      h2+='</div>';
    });
    if(S._snippets.length===0)h2+='<div style="padding:10px;text-align:center;font-size:10px;color:var(--text-muted)">No snippets saved yet</div>';
    el.innerHTML=h2;
  };
  window._snipRender();
}
function showCharCounter(){
  let panel=document.getElementById('char-counter-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='char-counter-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw';
  window._ccUpdate=function(){
    var ta=document.getElementById('cc-text');if(!ta)return;
    var text=ta.value;
    var chars=text.length;
    var charsNoSpace=text.replace(/\s/g,'').length;
    var words=text.trim()?text.trim().split(/\s+/).length:0;
    var sentences=text.trim()?text.split(/[.!?]+/).filter(function(s){return s.trim();}).length:0;
    var paras=text.trim()?text.split(/\n\n+/).filter(function(p){return p.trim();}).length:0;
    var lines=text?text.split('\n').length:0;
    var readTime=Math.max(1,Math.ceil(words/200));
    var speakTime=Math.max(1,Math.ceil(words/130));
    var stats=[
      {label:'Characters',value:chars},
      {label:'Chars (no space)',value:charsNoSpace},
      {label:'Words',value:words},
      {label:'Sentences',value:sentences},
      {label:'Paragraphs',value:paras},
      {label:'Lines',value:lines},
      {label:'Read time',value:readTime+'m'},
      {label:'Speak time',value:speakTime+'m'}
    ];
    var out=document.getElementById('cc-stats');if(!out)return;
    out.innerHTML=stats.map(function(s){return '<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)"><span style="font-size:10px;color:var(--text-muted)">'+s.label+'</span><span style="font-size:11px;color:var(--accent);font-family:var(--mono);font-weight:600">'+s.value+'</span></div>';}).join('');
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Character Counter</span><button onclick="document.getElementById(\'char-counter-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="cc-text" oninput="window._ccUpdate()" placeholder="Type or paste text here..." style="width:100%;height:100px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:11px;color:var(--text);resize:vertical;outline:none;margin-bottom:10px;box-sizing:border-box"></textarea>';
  h+='<div id="cc-stats"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  window._ccUpdate();
}
function showTaskTreemap(){
  let panel=document.getElementById('task-treemap-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-treemap-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw';
  var projs={};
  S.tasks.forEach(function(t){var p=t.project||'No Project';projs[p]=(projs[p]||0)+1;});
  var entries=Object.entries(projs).sort(function(a,b){return b[1]-a[1];});
  var total=S.tasks.length||1;
  var colors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316','#a855f7','#14b8a6'];
  var w=540,ht=300;
  // Simple treemap layout
  var rects=[];var x=0;var y=0;var rw=w;var rh=ht;
  entries.forEach(function(e,i){
    var frac=e[1]/total;
    if(rw>=rh){
      var bw=Math.round(frac*rw);
      rects.push({x:x,y:y,w:Math.max(bw,1),h:rh,label:e[0],count:e[1],color:colors[i%colors.length]});
      x+=bw;rw-=bw;
    }else{
      var bh=Math.round(frac*rh);
      rects.push({x:x,y:y,w:rw,h:Math.max(bh,1),label:e[0],count:e[1],color:colors[i%colors.length]});
      y+=bh;rh-=bh;
    }
  });
  var svg='<svg width="'+w+'" height="'+ht+'" viewBox="0 0 '+w+' '+ht+'">';
  rects.forEach(function(r){
    svg+='<rect x="'+r.x+'" y="'+r.y+'" width="'+r.w+'" height="'+r.h+'" fill="'+r.color+'" opacity="0.25" stroke="'+r.color+'" stroke-width="1.5" rx="3"><title>'+esc(r.label)+': '+r.count+' tasks</title></rect>';
    if(r.w>40&&r.h>30){
      svg+='<text x="'+(r.x+r.w/2)+'" y="'+(r.y+r.h/2-4)+'" fill="'+r.color+'" font-size="'+(r.w>100?'11':'9')+'" text-anchor="middle" font-weight="600">'+esc(r.label.length>15?r.label.substring(0,15)+'..':r.label)+'</text>';
      svg+='<text x="'+(r.x+r.w/2)+'" y="'+(r.y+r.h/2+10)+'" fill="#999" font-size="9" text-anchor="middle">'+r.count+'</text>';
    }
  });
  svg+='</svg>';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Treemap</span><button onclick="document.getElementById(\'task-treemap-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="overflow-x:auto">'+svg+'</div>';
  h+='<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:6px">Area proportional to task count per project</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickPoll(){
  let panel=document.getElementById('poll-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='poll-widget';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._polls)S._polls=[];
  window._pollCreate=function(){
    var q=document.getElementById('poll-q');var opts=document.getElementById('poll-opts');
    if(!q||!opts||!q.value.trim()||!opts.value.trim())return;
    var options=opts.value.split('\n').filter(function(o){return o.trim();}).map(function(o){return {text:o.trim(),votes:0};});
    if(options.length<2)return;
    S._polls.unshift({question:q.value.trim(),options:options,created:new Date().toISOString().split('T')[0]});
    save();window._pollRender();
  };
  window._pollVote=function(pi,oi){S._polls[pi].options[oi].votes++;save();window._pollRender();};
  window._pollDel=function(i){S._polls.splice(i,1);save();window._pollRender();};
  window._pollRender=function(){
    var el=document.getElementById('poll-widget');if(!el)return;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Quick Polls</span><button onclick="document.getElementById(\'poll-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h2+='<input id="poll-q" placeholder="Question..." style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none;margin-bottom:4px;box-sizing:border-box">';
    h2+='<textarea id="poll-opts" placeholder="Options (one per line)..." style="width:100%;height:50px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);resize:none;outline:none;margin-bottom:6px;box-sizing:border-box"></textarea>';
    h2+='<button onclick="window._pollCreate()" style="padding:5px 14px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600;margin-bottom:12px">Create Poll</button>';
    S._polls.forEach(function(p,pi){
      var totalV=p.options.reduce(function(s,o){return s+o.votes;},0);
      h2+='<div style="border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:8px">';
      h2+='<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:11px;font-weight:600;color:var(--text)">'+esc(p.question)+'</span><button onclick="window._pollDel('+pi+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button></div>';
      p.options.forEach(function(o,oi){
        var pct=totalV>0?Math.round(o.votes/totalV*100):0;
        h2+='<div onclick="window._pollVote('+pi+','+oi+')" style="cursor:pointer;margin-bottom:4px"><div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px"><span style="color:var(--text)">'+esc(o.text)+'</span><span style="color:var(--accent);font-family:var(--mono)">'+pct+'% ('+o.votes+')</span></div><div style="height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:var(--accent);border-radius:3px;transition:width 0.3s"></div></div></div>';
      });
      h2+='<div style="font-size:8px;color:var(--text-muted);margin-top:4px">'+totalV+' votes | '+p.created+'</div>';
      h2+='</div>';
    });
    if(S._polls.length===0)h2+='<div style="padding:10px;text-align:center;font-size:10px;color:var(--text-muted)">No polls yet</div>';
    el.innerHTML=h2;
  };
  window._pollRender();
}
function showHashGenerator(){
  let panel=document.getElementById('hash-gen-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='hash-gen-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw';
  window._hashGen=async function(){
    var text=document.getElementById('hash-input').value||'';
    var enc=new TextEncoder();var data=enc.encode(text);
    var results=[];
    var algos=[{name:'SHA-256',algo:'SHA-256'},{name:'SHA-384',algo:'SHA-384'},{name:'SHA-512',algo:'SHA-512'},{name:'SHA-1',algo:'SHA-1'}];
    for(var i=0;i<algos.length;i++){
      try{
        var hash=await crypto.subtle.digest(algos[i].algo,data);
        var arr=Array.from(new Uint8Array(hash));
        var hex=arr.map(function(b){return b.toString(16).padStart(2,'0');}).join('');
        results.push({name:algos[i].name,hex:hex});
      }catch(e){results.push({name:algos[i].name,hex:'Error'});}
    }
    var out=document.getElementById('hash-out');if(!out)return;
    out.innerHTML=results.map(function(r){
      return '<div style="margin-bottom:8px"><div style="font-size:9px;color:var(--accent);font-weight:600;margin-bottom:2px">'+r.name+'</div><div style="display:flex;gap:4px"><input readonly value="'+r.hex+'" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 6px;font-size:9px;color:var(--text);font-family:var(--mono);outline:none"><button onclick="navigator.clipboard.writeText(\''+r.hex+'\')" style="padding:3px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:8px">Copy</button></div></div>';
    }).join('');
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Hash Generator</span><button onclick="document.getElementById(\'hash-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="hash-input" oninput="window._hashGen()" placeholder="Type text to hash..." style="width:100%;height:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:11px;color:var(--text);resize:none;outline:none;margin-bottom:10px;box-sizing:border-box"></textarea>';
  h+='<div id="hash-out"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showProjectProgress(){
  let panel=document.getElementById('proj-progress-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='proj-progress-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  var projs={};
  S.tasks.forEach(function(t){
    var p=t.project||'No Project';
    if(!projs[p])projs[p]={total:0,done:0,inprog:0,p0:0,overdue:0};
    projs[p].total++;
    if(t.status==='done')projs[p].done++;
    if(t.status==='in-progress')projs[p].inprog++;
    if(t.priority==='p0'&&t.status!=='done')projs[p].p0++;
    if(t.due&&t.due<new Date().toISOString().split('T')[0]&&t.status!=='done')projs[p].overdue++;
  });
  var entries=Object.entries(projs).sort(function(a,b){return b[1].total-a[1].total;});
  var colors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316'];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Project Progress</span><button onclick="document.getElementById(\'proj-progress-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  entries.forEach(function(e,i){
    var d=e[1];var pct=d.total>0?Math.round(d.done/d.total*100):0;
    var col=colors[i%colors.length];
    h+='<div style="margin-bottom:12px;border:1px solid var(--border);border-radius:var(--radius);padding:10px">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:12px;font-weight:600;color:'+col+'">'+esc(e[0])+'</span><span style="font-size:11px;font-weight:700;color:var(--accent);font-family:var(--mono)">'+pct+'%</span></div>';
    h+='<div style="height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden;margin-bottom:6px"><div style="height:100%;width:'+pct+'%;background:'+col+';border-radius:4px;transition:width 0.3s"></div></div>';
    h+='<div style="display:flex;gap:10px;font-size:9px;color:var(--text-muted)">';
    h+='<span>'+d.done+'/'+d.total+' done</span>';
    h+='<span style="color:#f59e0b">'+d.inprog+' active</span>';
    if(d.p0>0)h+='<span style="color:#ef4444">'+d.p0+' critical</span>';
    if(d.overdue>0)h+='<span style="color:#ef4444">'+d.overdue+' overdue</span>';
    h+='</div></div>';
  });
  if(entries.length===0)h+='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No tasks yet</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickWhiteboard(){
  let panel=document.getElementById('qwb-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='qwb-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw';
  var w=550,ht=350;
  window._qwbDrawing=false;window._qwbColor='#4ade80';window._qwbSize=2;
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:15px;color:var(--text)">Quick Sketch</span><div style="display:flex;gap:4px;align-items:center">';
  ['#4ade80','#3b82f6','#ef4444','#f59e0b','#fff','#888'].forEach(function(c){
    h+='<button onclick="window._qwbColor=\''+c+'\'" style="width:16px;height:16px;border-radius:50%;background:'+c+';border:1px solid #555;cursor:pointer"></button>';
  });
  h+='<select onchange="window._qwbSize=parseInt(this.value)" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:2px;font-size:9px;color:var(--text)"><option value="1">1px</option><option value="2" selected>2px</option><option value="4">4px</option><option value="8">8px</option></select>';
  h+='<button onclick="var c=document.getElementById(\'qwb-canvas\');if(c)c.getContext(\'2d\').clearRect(0,0,'+w+','+ht+')" style="padding:2px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px">Clear</button>';
  h+='<button onclick="document.getElementById(\'qwb-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button>';
  h+='</div></div>';
  h+='<canvas id="qwb-canvas" width="'+w+'" height="'+ht+'" style="background:#111;border:1px solid var(--border);border-radius:var(--radius);cursor:crosshair;display:block;width:100%"></canvas>';
  panel.innerHTML=h;document.body.appendChild(panel);
  var canvas=document.getElementById('qwb-canvas');
  var ctx=canvas.getContext('2d');
  ctx.lineCap='round';ctx.lineJoin='round';
  function getPos(e){var r=canvas.getBoundingClientRect();return{x:(e.clientX-r.left)*(w/r.width),y:(e.clientY-r.top)*(ht/r.height)};}
  canvas.addEventListener('mousedown',function(e){window._qwbDrawing=true;ctx.beginPath();var p=getPos(e);ctx.moveTo(p.x,p.y);});
  canvas.addEventListener('mousemove',function(e){if(!window._qwbDrawing)return;ctx.strokeStyle=window._qwbColor;ctx.lineWidth=window._qwbSize;var p=getPos(e);ctx.lineTo(p.x,p.y);ctx.stroke();});
  canvas.addEventListener('mouseup',function(){window._qwbDrawing=false;});
  canvas.addEventListener('mouseleave',function(){window._qwbDrawing=false;});
}
function showIpInfo(){
  let panel=document.getElementById('ip-info-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='ip-info-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">IP Info</span><button onclick="document.getElementById(\'ip-info-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div id="ip-info-content" style="font-size:11px;color:var(--text-muted)">Loading...</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  fetch('https://ipapi.co/json/').then(function(r){return r.json();}).then(function(d){
    var el=document.getElementById('ip-info-content');if(!el)return;
    var fields=[
      {label:'IP Address',value:d.ip,accent:true},
      {label:'City',value:d.city},
      {label:'Region',value:d.region},
      {label:'Country',value:d.country_name+' ('+d.country_code+')'},
      {label:'Postal',value:d.postal},
      {label:'Latitude',value:d.latitude},
      {label:'Longitude',value:d.longitude},
      {label:'Timezone',value:d.timezone},
      {label:'ISP',value:d.org},
      {label:'ASN',value:d.asn}
    ];
    el.innerHTML=fields.map(function(f){
      return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text-muted);font-size:10px">'+f.label+'</span><span style="color:'+(f.accent?'var(--accent)':'var(--text)')+';font-size:10px;font-family:var(--mono)">'+(f.value||'N/A')+'</span></div>';
    }).join('');
  }).catch(function(){
    var el=document.getElementById('ip-info-content');if(el)el.textContent='Failed to fetch IP info';
  });
}
function showTaskFunnel(){
  let panel=document.getElementById('task-funnel-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-funnel-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw';
  var stages=[
    {label:'Total Created',count:S.tasks.length,color:'#3b82f6'},
    {label:'Has Due Date',count:S.tasks.filter(function(t){return t.due;}).length,color:'#8b5cf6'},
    {label:'In Progress',count:S.tasks.filter(function(t){return t.status==='in-progress';}).length,color:'#f59e0b'},
    {label:'Completed',count:S.tasks.filter(function(t){return t.status==='done';}).length,color:'#4ade80'}
  ];
  var maxW=400;var maxCount=Math.max.apply(null,stages.map(function(s){return s.count;}).concat([1]));
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Funnel</span><button onclick="document.getElementById(\'task-funnel-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  stages.forEach(function(s,i){
    var w=Math.max(60,Math.round(s.count/maxCount*maxW));
    var pct=maxCount>0?Math.round(s.count/stages[0].count*100):0;
    h+='<div style="text-align:center;margin-bottom:8px">';
    h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:3px">'+s.label+'</div>';
    h+='<div style="width:'+w+'px;margin:0 auto;background:'+s.color+'22;border:1px solid '+s.color+';border-radius:var(--radius);padding:8px;position:relative">';
    h+='<span style="font-size:14px;font-weight:700;color:'+s.color+';font-family:var(--mono)">'+s.count+'</span>';
    h+='<span style="font-size:9px;color:var(--text-muted);margin-left:6px">('+pct+'%)</span>';
    h+='</div>';
    if(i<stages.length-1)h+='<div style="color:var(--text-muted);font-size:10px;margin:4px 0">v</div>';
    h+='</div>';
  });
  var convRate=stages[0].count>0?Math.round(stages[3].count/stages[0].count*100):0;
  h+='<div style="text-align:center;margin-top:8px;font-size:11px;color:var(--accent);font-weight:600">Overall Conversion: '+convRate+'%</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickGratitude(){
  let panel=document.getElementById('gratitude-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='gratitude-widget';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px;max-height:400px;overflow-y:auto';
  if(!S._gratitude)S._gratitude=[];
  var today=new Date().toISOString().split('T')[0];
  window._gratAdd=function(){
    var inp=document.getElementById('grat-input');if(!inp||!inp.value.trim())return;
    S._gratitude.unshift({text:inp.value.trim(),date:today});
    save();window._gratRender();
  };
  window._gratDel=function(i){S._gratitude.splice(i,1);save();window._gratRender();};
  window._gratRender=function(){
    var el=document.getElementById('gratitude-widget');if(!el)return;
    var todayCount=S._gratitude.filter(function(g){return g.date===today;}).length;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:11px;color:var(--text-muted)">Gratitude Log</span><button onclick="document.getElementById(\'gratitude-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    h2+='<div style="font-size:9px;color:var(--accent);margin-bottom:6px">'+todayCount+' entries today | '+S._gratitude.length+' total</div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:8px"><input id="grat-input" placeholder="I am grateful for..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:10px;color:var(--text);outline:none" onkeydown="if(event.key===\'Enter\')window._gratAdd()"><button onclick="window._gratAdd()" style="padding:4px 8px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">+</button></div>';
    S._gratitude.slice(0,20).forEach(function(g,i){
      h2+='<div style="display:flex;gap:6px;padding:3px 0;border-bottom:1px solid var(--border)"><span style="font-size:10px;color:var(--text);flex:1">'+esc(g.text)+'</span><span style="font-size:8px;color:#555;font-family:var(--mono);white-space:nowrap">'+g.date+'</span><button onclick="window._gratDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button></div>';
    });
    if(S._gratitude.length===0)h2+='<div style="padding:8px;text-align:center;font-size:10px;color:var(--text-muted)">Start your gratitude practice</div>';
    el.innerHTML=h2;
  };
  window._gratRender();
}
function showJsonFormatter(){
  let panel=document.getElementById('json-fmt-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='json-fmt-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:85vh;overflow-y:auto';
  window._jsonFmt=function(indent){
    var src=document.getElementById('json-src');var dest=document.getElementById('json-dest');var info=document.getElementById('json-info');
    if(!src||!dest)return;
    try{
      var obj=JSON.parse(src.value);
      var out=JSON.stringify(obj,null,indent||2);
      dest.textContent=out;
      if(info){
        var keys=0;function countKeys(o){if(typeof o==='object'&&o!==null){if(Array.isArray(o))o.forEach(countKeys);else{var k=Object.keys(o);keys+=k.length;k.forEach(function(kk){countKeys(o[kk]);});}}}
        countKeys(obj);
        info.textContent='Valid JSON | '+out.length+' chars | '+keys+' keys | Type: '+(Array.isArray(obj)?'Array':'Object');
        info.style.color='#4ade80';
      }
    }catch(e){
      dest.textContent='Error: '+e.message;
      if(info){info.textContent='Invalid JSON';info.style.color='#ef4444';}
    }
  };
  window._jsonMinify=function(){
    var src=document.getElementById('json-src');var dest=document.getElementById('json-dest');
    if(!src||!dest)return;
    try{dest.textContent=JSON.stringify(JSON.parse(src.value));}catch(e){dest.textContent='Error: '+e.message;}
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">JSON Formatter</span><button onclick="document.getElementById(\'json-fmt-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="json-src" placeholder="Paste JSON here..." style="width:100%;height:100px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:10px;color:var(--text);font-family:var(--mono);resize:vertical;outline:none;margin-bottom:6px;box-sizing:border-box"></textarea>';
  h+='<div style="display:flex;gap:4px;margin-bottom:8px">';
  h+='<button onclick="window._jsonFmt(2)" style="padding:4px 10px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">Format (2)</button>';
  h+='<button onclick="window._jsonFmt(4)" style="padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Format (4)</button>';
  h+='<button onclick="window._jsonMinify()" style="padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Minify</button>';
  h+='<button onclick="navigator.clipboard.writeText(document.getElementById(\'json-dest\').textContent)" style="padding:4px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Copy</button>';
  h+='</div>';
  h+='<div id="json-info" style="font-size:9px;margin-bottom:4px"></div>';
  h+='<pre id="json-dest" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:var(--text);font-family:var(--mono);max-height:200px;overflow-y:auto;white-space:pre-wrap"></pre>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskScorecard(){
  let panel=document.getElementById('task-score-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-score-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw';
  var total=S.tasks.length;
  var done=S.tasks.filter(function(t){return t.status==='done';}).length;
  var active=S.tasks.filter(function(t){return t.status!=='done';}).length;
  var today=new Date().toISOString().split('T')[0];
  var overdue=S.tasks.filter(function(t){return t.due&&t.due<today&&t.status!=='done';}).length;
  var dueToday=S.tasks.filter(function(t){return t.due===today&&t.status!=='done';}).length;
  var thisWeek=0;var wd=new Date();wd.setDate(wd.getDate()+7);var weekEnd=wd.toISOString().split('T')[0];
  thisWeek=S.tasks.filter(function(t){return t.due&&t.due>=today&&t.due<=weekEnd&&t.status!=='done';}).length;
  var withDesc=S.tasks.filter(function(t){return t.description&&t.description.trim();}).length;
  var withSub=S.tasks.filter(function(t){return t.subtasks&&t.subtasks.length>0;}).length;
  var avgSubs=0;var subTasks=S.tasks.filter(function(t){return t.subtasks&&t.subtasks.length>0;});
  if(subTasks.length)avgSubs=(subTasks.reduce(function(s,t){return s+t.subtasks.length;},0)/subTasks.length).toFixed(1);
  var projects=[...new Set(S.tasks.map(function(t){return t.project||'No Project';}))].length;
  var metrics=[
    {label:'Total Tasks',value:total,color:'var(--text)'},
    {label:'Completed',value:done+' ('+Math.round(total?done/total*100:0)+'%)',color:'#4ade80'},
    {label:'Active',value:active,color:'#3b82f6'},
    {label:'Overdue',value:overdue,color:overdue>0?'#ef4444':'#4ade80'},
    {label:'Due Today',value:dueToday,color:dueToday>0?'#f59e0b':'var(--text-muted)'},
    {label:'Due This Week',value:thisWeek,color:'#8b5cf6'},
    {label:'With Description',value:withDesc+' ('+Math.round(total?withDesc/total*100:0)+'%)',color:'var(--text)'},
    {label:'With Subtasks',value:withSub,color:'var(--text)'},
    {label:'Avg Subtasks',value:avgSubs,color:'var(--text-muted)'},
    {label:'Projects',value:projects,color:'#06b6d4'}
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Scorecard</span><button onclick="document.getElementById(\'task-score-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  metrics.forEach(function(m){
    h+='<div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px;text-align:center">';
    h+='<div style="font-size:18px;font-weight:700;color:'+m.color+';font-family:var(--mono)">'+m.value+'</div>';
    h+='<div style="font-size:9px;color:var(--text-muted);margin-top:2px">'+m.label+'</div>';
    h+='</div>';
  });
  h+='</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickTodo(){
  let panel=document.getElementById('qtodo-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='qtodo-widget';
  panel.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px;max-height:400px;overflow-y:auto';
  if(!S._quickTodos)S._quickTodos=[];
  window._qtdAdd=function(){
    var inp=document.getElementById('qtd-input');if(!inp||!inp.value.trim())return;
    S._quickTodos.push({text:inp.value.trim(),done:false});
    inp.value='';save();window._qtdRender();
  };
  window._qtdToggle=function(i){S._quickTodos[i].done=!S._quickTodos[i].done;save();window._qtdRender();};
  window._qtdDel=function(i){S._quickTodos.splice(i,1);save();window._qtdRender();};
  window._qtdClear=function(){S._quickTodos=S._quickTodos.filter(function(t){return !t.done;});save();window._qtdRender();};
  window._qtdRender=function(){
    var el=document.getElementById('qtodo-widget');if(!el)return;
    var doneCount=S._quickTodos.filter(function(t){return t.done;}).length;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:11px;color:var(--text-muted)">Quick Todos</span><div style="display:flex;gap:4px"><button onclick="window._qtdClear()" style="background:none;border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:8px;padding:2px 6px">Clear done</button><button onclick="document.getElementById(\'qtodo-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div></div>';
    h2+='<div style="font-size:9px;color:var(--accent);margin-bottom:6px">'+doneCount+'/'+S._quickTodos.length+' done</div>';
    S._quickTodos.forEach(function(t,i){
      h2+='<div style="display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid var(--border)">';
      h2+='<button onclick="window._qtdToggle('+i+')" style="width:16px;height:16px;border-radius:3px;border:1px solid '+(t.done?'var(--accent)':'var(--border)')+';background:'+(t.done?'var(--accent)':'transparent')+';cursor:pointer;display:flex;align-items:center;justify-content:center;color:#000;font-size:9px;font-weight:700;flex-shrink:0">'+(t.done?'V':'')+'</button>';
      h2+='<span style="font-size:10px;color:'+(t.done?'var(--text-muted)':'var(--text)')+';flex:1;text-decoration:'+(t.done?'line-through':'none')+'">'+esc(t.text)+'</span>';
      h2+='<button onclick="window._qtdDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button>';
      h2+='</div>';
    });
    h2+='<div style="display:flex;gap:4px;margin-top:6px"><input id="qtd-input" placeholder="Add todo..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:10px;color:var(--text);outline:none" onkeydown="if(event.key===\'Enter\')window._qtdAdd()"><button onclick="window._qtdAdd()" style="padding:4px 8px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">+</button></div>';
    el.innerHTML=h2;
  };
  window._qtdRender();
}
function showCronHelper(){
  let panel=document.getElementById('cron-helper-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='cron-helper-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw';
  var presets=[
    {label:'Every minute',cron:'* * * * *'},
    {label:'Every 5 minutes',cron:'*/5 * * * *'},
    {label:'Every hour',cron:'0 * * * *'},
    {label:'Every day at midnight',cron:'0 0 * * *'},
    {label:'Every day at 9 AM',cron:'0 9 * * *'},
    {label:'Every Monday at 9 AM',cron:'0 9 * * 1'},
    {label:'Every weekday at 9 AM',cron:'0 9 * * 1-5'},
    {label:'1st of every month',cron:'0 0 1 * *'},
    {label:'Every 15 minutes',cron:'*/15 * * * *'},
    {label:'Every Sunday at midnight',cron:'0 0 * * 0'}
  ];
  window._cronExplain=function(){
    var val=(document.getElementById('cron-input').value||'').trim().split(/\s+/);
    var out=document.getElementById('cron-explain');if(!out)return;
    if(val.length!==5){out.textContent='Expected 5 fields: min hour dom month dow';out.style.color='#ef4444';return;}
    var fields=['Minute','Hour','Day of Month','Month','Day of Week'];
    var explain=val.map(function(v,i){
      if(v==='*')return fields[i]+': every';
      if(v.indexOf('/')!==-1){var ps=v.split('/');return fields[i]+': every '+ps[1]+(ps[0]!=='*'?' starting at '+ps[0]:'');}
      if(v.indexOf('-')!==-1)return fields[i]+': '+v;
      if(v.indexOf(',')!==-1)return fields[i]+': '+v;
      return fields[i]+': at '+v;
    });
    out.innerHTML=explain.map(function(e){return '<div style="padding:2px 0;font-size:10px;color:var(--text)">'+e+'</div>';}).join('');
    out.style.color='';
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Cron Helper</span><button onclick="document.getElementById(\'cron-helper-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:10px"><input id="cron-input" value="* * * * *" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:13px;color:var(--accent);font-family:var(--mono);outline:none;text-align:center"><button onclick="window._cronExplain()" style="padding:6px 14px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">Explain</button></div>';
  h+='<div style="display:flex;gap:4px;justify-content:center;margin-bottom:8px;font-size:8px;color:var(--text-muted)"><span>min</span><span style="width:20px"></span><span>hour</span><span style="width:20px"></span><span>dom</span><span style="width:20px"></span><span>month</span><span style="width:20px"></span><span>dow</span></div>';
  h+='<div id="cron-explain" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;margin-bottom:12px;min-height:30px"></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;font-weight:600">Common presets:</div>';
  presets.forEach(function(p){
    h+='<div onclick="document.getElementById(\'cron-input\').value=\''+p.cron+'\';window._cronExplain()" style="display:flex;justify-content:space-between;padding:4px 6px;cursor:pointer;border-bottom:1px solid var(--border);font-size:10px" onmouseenter="this.style.background=\'var(--bg-hover)\'" onmouseleave="this.style.background=\'transparent\'"><span style="color:var(--text)">'+p.label+'</span><span style="color:var(--accent);font-family:var(--mono)">'+p.cron+'</span></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskWorkload(){
  let panel=document.getElementById('task-workload-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-workload-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw';
  var today=new Date();var days=14;var data=[];
  for(var i=0;i<days;i++){
    var d=new Date(today);d.setDate(d.getDate()+i);
    var ds=d.toISOString().split('T')[0];
    var dayName=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
    var tasks=S.tasks.filter(function(t){return t.due===ds&&t.status!=='done';});
    data.push({date:ds,day:dayName,count:tasks.length,tasks:tasks});
  }
  var maxCount=Math.max.apply(null,data.map(function(d){return d.count;}).concat([1]));
  var w=480,ht=220,pad=40,gw=w-pad*2,gh=ht-pad*2;
  var barW=Math.floor(gw/days*0.7);
  var svg='<svg width="'+w+'" height="'+ht+'" viewBox="0 0 '+w+' '+ht+'" style="font-family:var(--mono)">';
  for(var g=0;g<=4;g++){var y=pad+gh-gh*(g/4);svg+='<line x1="'+pad+'" y1="'+y+'" x2="'+(pad+gw)+'" y2="'+y+'" stroke="#222" stroke-width="0.5"/><text x="'+(pad-4)+'" y="'+(y+3)+'" fill="#666" font-size="7" text-anchor="end">'+Math.round(maxCount*(g/4))+'</text>';}
  data.forEach(function(d,i){
    var x=pad+i*(gw/days);
    var bh=d.count?(d.count/maxCount)*gh:0;
    var col=d.count>3?'#ef4444':d.count>1?'#f59e0b':'#4ade80';
    svg+='<rect x="'+x+'" y="'+(pad+gh-bh)+'" width="'+barW+'" height="'+bh+'" fill="'+col+'" rx="2" opacity="0.8"><title>'+d.date+': '+d.count+' tasks due</title></rect>';
    svg+='<text x="'+(x+barW/2)+'" y="'+(ht-5)+'" fill="#666" font-size="7" text-anchor="middle">'+d.day+'</text>';
    if(d.count>0)svg+='<text x="'+(x+barW/2)+'" y="'+(pad+gh-bh-4)+'" fill="'+col+'" font-size="8" text-anchor="middle" font-weight="600">'+d.count+'</text>';
  });
  svg+='</svg>';
  var totalDue=data.reduce(function(s,d){return s+d.count;},0);
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Workload Forecast (14d)</span><button onclick="document.getElementById(\'task-workload-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="overflow-x:auto">'+svg+'</div>';
  h+='<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:6px"><span>'+totalDue+' tasks due in next 14 days</span><div style="display:flex;gap:8px"><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#4ade80;border-radius:2px"></span>Light</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#f59e0b;border-radius:2px"></span>Moderate</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#ef4444;border-radius:2px"></span>Heavy</span></div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickStickyNote(){
  let panel=document.getElementById('sticky-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='sticky-widget';
  panel.style.cssText='position:fixed;top:80px;right:20px;z-index:1500;background:#fef08a;border:none;border-radius:4px;padding:0;box-shadow:0 4px 16px rgba(0,0,0,0.4);width:200px;min-height:160px';
  if(!S._stickyText)S._stickyText='';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:#fde047;border-radius:4px 4px 0 0;cursor:move"><span style="font-size:10px;font-weight:600;color:#713f12">Sticky Note</span><button onclick="document.getElementById(\'sticky-widget\').remove()" style="background:none;border:none;color:#92400e;cursor:pointer;font-size:14px;font-weight:700">X</button></div>';
  h+='<textarea oninput="S._stickyText=this.value;save()" style="width:100%;height:130px;background:transparent;border:none;padding:8px 10px;font-size:11px;color:#422006;resize:none;outline:none;box-sizing:border-box;font-family:inherit;line-height:1.5">'+esc(S._stickyText)+'</textarea>';
  panel.innerHTML=h;document.body.appendChild(panel);
  // Make draggable
  var header=panel.querySelector('div');
  var startX,startY,startLeft,startTop;
  header.addEventListener('mousedown',function(e){
    startX=e.clientX;startY=e.clientY;
    var rect=panel.getBoundingClientRect();
    startLeft=rect.left;startTop=rect.top;
    function onMove(e2){
      panel.style.left=(startLeft+e2.clientX-startX)+'px';
      panel.style.top=(startTop+e2.clientY-startY)+'px';
      panel.style.right='auto';
    }
    function onUp(){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);}
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  });
}
function showEmojiPicker(){
  let panel=document.getElementById('emoji-pick-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='emoji-pick-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:380px;width:90vw;max-height:70vh;overflow-y:auto';
  var categories={
    'Smileys':['😀','😃','😄','😁','😆','😅','🤣','😂','🙂','😉','😊','😇','🥰','😍','😘','😗','😚','😋','😛','😜','🤪','😝','🤑','🤗','🤭','🤫','🤔','🤐','🤨','😐','😑','😶','😏','😒','🙄','😬','🤥','😌','😔','😪','🤤','😴','😷','🤒','🤕','🤢','🤮','🥵','🥶','🥴','😵','🤯','🤠','🥳','😎','🤓','🧐','😕','😟','🙁','☹️','😮','😯','😲','😳','🥺','😦','😧','😨','😰','😥','😢','😭','😱','😖','😣','😞','😓','😩','😫','🥱','😤','😡','😠','🤬','😈','👿'],
    'Hands':['👋','🤚','🖐','✋','🖖','👌','🤌','🤏','✌️','🤞','🤟','🤘','🤙','👈','👉','👆','🖕','👇','☝️','👍','👎','✊','👊','🤛','🤜','👏','🙌','👐','🤲','🤝','🙏'],
    'Objects':['💻','🖥','🖨','⌨️','🖱','📱','📲','☎️','📞','📟','📠','🔋','🔌','💡','🔦','🕯','📡','💰','💳','💎','⚙️','🔧','🔨','🛠','⛏','🔩','⚡','🔥','💧','🌊'],
    'Symbols':['❤️','🧡','💛','💚','💙','💜','🖤','🤍','🤎','💔','❣️','💕','💞','💓','💗','💖','💘','💝','✅','❌','⭐','🌟','💫','⚡','🔥','💯','🎯','🏆','🎮','🎲'],
    'Nature':['🌍','🌎','🌏','🌐','🗺','🧭','🌋','🗻','🏔','⛰','🏕','🏖','🏜','🏝','🌅','🌄','🌠','🎇','🎆','🌇','🌆','🌃','🌌','🌉','🌁'],
    'Arrows':['⬆️','↗️','➡️','↘️','⬇️','↙️','⬅️','↖️','↕️','↔️','↩️','↪️','⤴️','⤵️','🔃','🔄','🔙','🔚','🔛','🔜','🔝']
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:15px;color:var(--text)">Emoji Picker</span><button onclick="document.getElementById(\'emoji-pick-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div id="emoji-copied" style="font-size:9px;color:var(--accent);text-align:center;height:14px;margin-bottom:4px"></div>';
  Object.entries(categories).forEach(function(e){
    h+='<div style="font-size:9px;color:var(--text-muted);font-weight:600;margin:8px 0 4px">'+e[0]+'</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:2px">';
    e[1].forEach(function(em){
      h+='<button onclick="navigator.clipboard.writeText(\''+em+'\');document.getElementById(\'emoji-copied\').textContent=\'Copied: '+em+'\';setTimeout(function(){var el=document.getElementById(\'emoji-copied\');if(el)el.textContent=\'\'},1000)" style="width:28px;height:28px;background:transparent;border:1px solid transparent;border-radius:4px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center" onmouseenter="this.style.background=\'var(--bg-hover)\';this.style.borderColor=\'var(--border)\'" onmouseleave="this.style.background=\'transparent\';this.style.borderColor=\'transparent\'">'+em+'</button>';
    });
    h+='</div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskTimeEstimate(){
  let panel=document.getElementById('task-time-est-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-time-est-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  var active=S.tasks.filter(function(t){return t.status!=='done';});
  var estimated=active.filter(function(t){return t.estimate;});
  var unestimated=active.filter(function(t){return !t.estimate;});
  function parseEst(e){
    if(!e)return 0;
    var m=e.match(/(\d+)\s*(h|hr|hour|m|min)/i);
    if(!m)return parseInt(e)||0;
    var v=parseInt(m[1]);
    if(m[2].startsWith('h'))return v*60;
    return v;
  }
  var totalMins=estimated.reduce(function(s,t){return s+parseEst(t.estimate);},0);
  var byPriority={p0:0,p1:0,p2:0,p3:0};
  estimated.forEach(function(t){byPriority[t.priority||'p2']+=parseEst(t.estimate);});
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Time Estimates</span><button onclick="document.getElementById(\'task-time-est-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">';
  h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:10px;text-align:center"><div style="font-size:18px;font-weight:700;color:var(--accent);font-family:var(--mono)">'+Math.floor(totalMins/60)+'h '+totalMins%60+'m</div><div style="font-size:9px;color:var(--text-muted)">Total Estimated</div></div>';
  h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:10px;text-align:center"><div style="font-size:18px;font-weight:700;color:#3b82f6;font-family:var(--mono)">'+estimated.length+'</div><div style="font-size:9px;color:var(--text-muted)">Estimated</div></div>';
  h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:10px;text-align:center"><div style="font-size:18px;font-weight:700;color:#f59e0b;font-family:var(--mono)">'+unestimated.length+'</div><div style="font-size:9px;color:var(--text-muted)">Unestimated</div></div>';
  h+='</div>';
  h+='<div style="font-size:10px;color:var(--text-muted);font-weight:600;margin-bottom:6px">By Priority:</div>';
  [{p:'p0',label:'Critical',color:'#ef4444'},{p:'p1',label:'High',color:'#f59e0b'},{p:'p2',label:'Medium',color:'#3b82f6'},{p:'p3',label:'Low',color:'#6b7280'}].forEach(function(pr){
    var m=byPriority[pr.p];
    h+='<div style="display:flex;align-items:center;gap:8px;padding:3px 0"><span style="font-size:10px;color:'+pr.color+';width:60px">'+pr.label+'</span><div style="flex:1;height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+(totalMins>0?Math.round(m/totalMins*100):0)+'%;background:'+pr.color+';border-radius:3px"></div></div><span style="font-size:9px;color:var(--text-muted);font-family:var(--mono);width:50px;text-align:right">'+Math.floor(m/60)+'h'+m%60+'m</span></div>';
  });
  if(estimated.length>0){
    h+='<div style="font-size:10px;color:var(--text-muted);font-weight:600;margin:12px 0 6px">Tasks with estimates:</div>';
    estimated.slice(0,15).forEach(function(t){
      h+='<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border);font-size:10px"><span style="color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(t.title||'Untitled')+'</span><span style="color:var(--accent);font-family:var(--mono);margin-left:8px">'+esc(t.estimate)+'</span></div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickMatrix(){
  let panel=document.getElementById('matrix-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='matrix-widget';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw';
  if(!S._matrixItems)S._matrixItems={q1:[],q2:[],q3:[],q4:[]};
  window._mxAdd=function(q){
    var inp=document.getElementById('mx-input');if(!inp||!inp.value.trim())return;
    S._matrixItems[q].push(inp.value.trim());inp.value='';save();window._mxRender();
  };
  window._mxDel=function(q,i){S._matrixItems[q].splice(i,1);save();window._mxRender();};
  window._mxRender=function(){
    var el=document.getElementById('matrix-widget');if(!el)return;
    var quads=[
      {key:'q1',label:'Do First',sub:'Urgent + Important',color:'#ef4444'},
      {key:'q2',label:'Schedule',sub:'Not Urgent + Important',color:'#3b82f6'},
      {key:'q3',label:'Delegate',sub:'Urgent + Not Important',color:'#f59e0b'},
      {key:'q4',label:'Eliminate',sub:'Not Urgent + Not Important',color:'#6b7280'}
    ];
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:15px;color:var(--text)">Decision Matrix</span><button onclick="document.getElementById(\'matrix-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:10px"><input id="mx-input" placeholder="Add item..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none">';
    quads.forEach(function(q){
      h2+='<button onclick="window._mxAdd(\''+q.key+'\')" style="padding:4px 6px;background:'+q.color+'22;border:1px solid '+q.color+'44;border-radius:var(--radius);color:'+q.color+';cursor:pointer;font-size:8px;font-weight:600">'+q.label.split(' ')[0]+'</button>';
    });
    h2+='</div>';
    h2+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">';
    quads.forEach(function(q){
      h2+='<div style="background:'+q.color+'11;border:1px solid '+q.color+'33;border-radius:var(--radius);padding:8px;min-height:80px">';
      h2+='<div style="font-size:10px;font-weight:600;color:'+q.color+';margin-bottom:2px">'+q.label+'</div>';
      h2+='<div style="font-size:8px;color:var(--text-muted);margin-bottom:6px">'+q.sub+'</div>';
      S._matrixItems[q.key].forEach(function(item,i){
        h2+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:10px"><span style="color:var(--text)">'+esc(item)+'</span><button onclick="window._mxDel(\''+q.key+'\','+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button></div>';
      });
      h2+='</div>';
    });
    h2+='</div>';
    el.innerHTML=h2;
  };
  window._mxRender();
}
function showNumberFormatter(){
  let panel=document.getElementById('numfmt-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='numfmt-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw';
  window._numFmt=function(){
    var val=document.getElementById('numfmt-input').value;var num=parseFloat(val);
    var out=document.getElementById('numfmt-out');if(!out)return;
    if(isNaN(num)){out.innerHTML='<div style="color:#ef4444;font-size:10px">Enter a valid number</div>';return;}
    var formats=[
      {label:'Number',value:num.toLocaleString('en-US')},
      {label:'Scientific',value:num.toExponential(4)},
      {label:'Fixed (2)',value:num.toFixed(2)},
      {label:'Percentage',value:(num*100).toFixed(2)+'%'},
      {label:'Binary',value:'0b'+(Number.isInteger(num)?num.toString(2):'N/A')},
      {label:'Octal',value:'0o'+(Number.isInteger(num)?num.toString(8):'N/A')},
      {label:'Hexadecimal',value:'0x'+(Number.isInteger(num)?num.toString(16).toUpperCase():'N/A')},
      {label:'Currency (USD)',value:'$'+num.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})},
      {label:'Currency (EUR)',value:num.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' EUR'},
      {label:'Ordinal',value:num+(num%10===1&&num%100!==11?'st':num%10===2&&num%100!==12?'nd':num%10===3&&num%100!==13?'rd':'th')},
      {label:'Roman',value:Number.isInteger(num)&&num>0&&num<4000?(function(n){var r='';var vals=[[1000,'M'],[900,'CM'],[500,'D'],[400,'CD'],[100,'C'],[90,'XC'],[50,'L'],[40,'XL'],[10,'X'],[9,'IX'],[5,'V'],[4,'IV'],[1,'I']];vals.forEach(function(v){while(n>=v[0]){r+=v[1];n-=v[0];}});return r;})(num):'N/A'},
      {label:'Words (approx)',value:num>=1e9?((num/1e9).toFixed(1)+'B'):num>=1e6?((num/1e6).toFixed(1)+'M'):num>=1e3?((num/1e3).toFixed(1)+'K'):String(num)}
    ];
    out.innerHTML=formats.map(function(f){
      return '<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)"><span style="font-size:10px;color:var(--text-muted)">'+f.label+'</span><span style="font-size:10px;color:var(--accent);font-family:var(--mono);cursor:pointer" onclick="navigator.clipboard.writeText(\''+f.value.replace(/'/g,"\\'")+'\')" title="Click to copy">'+esc(f.value)+'</span></div>';
    }).join('');
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Number Formatter</span><button onclick="document.getElementById(\'numfmt-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<input id="numfmt-input" type="text" placeholder="Enter a number..." oninput="window._numFmt()" style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:14px;color:var(--accent);font-family:var(--mono);outline:none;margin-bottom:10px;box-sizing:border-box;text-align:center">';
  h+='<div id="numfmt-out"></div>';
  h+='<div style="font-size:8px;color:var(--text-muted);text-align:center;margin-top:8px">Click any value to copy</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskWeeklyReport(){
  let panel=document.getElementById('weekly-report-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='weekly-report-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  var today=new Date();var weekStart=new Date(today);weekStart.setDate(weekStart.getDate()-today.getDay()+1);
  var weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);
  var ws=weekStart.toISOString().split('T')[0];var we=weekEnd.toISOString().split('T')[0];
  var created=S.tasks.filter(function(t){return t.created&&t.created>=ws&&t.created<=we+'T';});
  var completed=S.tasks.filter(function(t){return t.completedAt&&t.completedAt>=ws&&t.completedAt<=we+'T';});
  var dueThisWeek=S.tasks.filter(function(t){return t.due&&t.due>=ws&&t.due<=we;});
  var overdue=S.tasks.filter(function(t){return t.due&&t.due<ws&&t.status!=='done';});
  var byDay={};
  for(var d=0;d<7;d++){
    var dd=new Date(weekStart);dd.setDate(dd.getDate()+d);
    var ds=dd.toISOString().split('T')[0];
    var dayName=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][d];
    byDay[dayName]={created:created.filter(function(t){return t.created&&t.created.startsWith(ds);}).length,completed:completed.filter(function(t){return t.completedAt&&t.completedAt.startsWith(ds);}).length};
  }
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Weekly Report</span><div style="display:flex;gap:6px"><button onclick="navigator.clipboard.writeText(document.getElementById(\'weekly-report-panel\').innerText)" style="padding:3px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px">Copy</button><button onclick="document.getElementById(\'weekly-report-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:10px">Week of '+ws+' to '+we+'</div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:12px">';
  [{label:'Created',value:created.length,color:'#3b82f6'},{label:'Completed',value:completed.length,color:'#4ade80'},{label:'Due',value:dueThisWeek.length,color:'#f59e0b'},{label:'Overdue',value:overdue.length,color:'#ef4444'}].forEach(function(m){
    h+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:8px;text-align:center"><div style="font-size:18px;font-weight:700;color:'+m.color+';font-family:var(--mono)">'+m.value+'</div><div style="font-size:8px;color:var(--text-muted)">'+m.label+'</div></div>';
  });
  h+='</div>';
  h+='<div style="font-size:10px;color:var(--text-muted);font-weight:600;margin-bottom:6px">Daily Breakdown:</div>';
  Object.entries(byDay).forEach(function(e){
    h+='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;border-bottom:1px solid var(--border)"><span style="font-size:10px;color:var(--text);width:30px;font-weight:600">'+e[0]+'</span><span style="font-size:9px;color:#3b82f6">+'+e[1].created+'</span><span style="font-size:9px;color:#4ade80">V'+e[1].completed+'</span></div>';
  });
  if(completed.length>0){
    h+='<div style="font-size:10px;color:var(--text-muted);font-weight:600;margin:12px 0 6px">Completed This Week:</div>';
    completed.forEach(function(t){
      h+='<div style="font-size:10px;color:var(--text);padding:2px 0;border-bottom:1px solid var(--border)">V '+esc(t.title||'Untitled')+'</div>';
    });
  }
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickCipher(){
  let panel=document.getElementById('cipher-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='cipher-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw';
  window._cipherRun=function(mode){
    var text=document.getElementById('cipher-text').value||'';
    var shift=parseInt(document.getElementById('cipher-shift').value)||3;
    var method=document.getElementById('cipher-method').value;
    var result='';
    if(method==='caesar'){
      for(var i=0;i<text.length;i++){
        var c=text.charCodeAt(i);
        var s=mode==='enc'?shift:-shift;
        if(c>=65&&c<=90)result+=String.fromCharCode(((c-65+s+26)%26)+65);
        else if(c>=97&&c<=122)result+=String.fromCharCode(((c-97+s+26)%26)+97);
        else result+=text[i];
      }
    }else if(method==='rot13'){
      for(var j=0;j<text.length;j++){
        var cc=text.charCodeAt(j);
        if(cc>=65&&cc<=90)result+=String.fromCharCode(((cc-65+13)%26)+65);
        else if(cc>=97&&cc<=122)result+=String.fromCharCode(((cc-97+13)%26)+97);
        else result+=text[j];
      }
    }else if(method==='reverse'){
      result=text.split('').reverse().join('');
    }else if(method==='atbash'){
      for(var k=0;k<text.length;k++){
        var ca=text.charCodeAt(k);
        if(ca>=65&&ca<=90)result+=String.fromCharCode(90-(ca-65));
        else if(ca>=97&&ca<=122)result+=String.fromCharCode(122-(ca-97));
        else result+=text[k];
      }
    }
    document.getElementById('cipher-out').value=result;
  };
  var selStyle='background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px;font-size:10px;color:var(--text);outline:none';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Text Cipher</span><button onclick="document.getElementById(\'cipher-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:8px;align-items:center"><select id="cipher-method" style="'+selStyle+'"><option value="caesar">Caesar</option><option value="rot13">ROT13</option><option value="atbash">Atbash</option><option value="reverse">Reverse</option></select><label style="font-size:9px;color:var(--text-muted)">Shift:</label><input id="cipher-shift" type="number" value="3" min="1" max="25" style="width:40px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px;font-size:10px;color:var(--text);outline:none;text-align:center;font-family:var(--mono)"></div>';
  h+='<textarea id="cipher-text" placeholder="Enter text to encrypt..." style="width:100%;height:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:11px;color:var(--text);resize:none;outline:none;margin-bottom:6px;box-sizing:border-box"></textarea>';
  h+='<div style="display:flex;gap:6px;margin-bottom:8px"><button onclick="window._cipherRun(\'enc\')" style="flex:1;padding:6px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">Encrypt</button><button onclick="window._cipherRun(\'dec\')" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px">Decrypt</button></div>';
  h+='<textarea id="cipher-out" readonly style="width:100%;height:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:11px;color:var(--accent);font-family:var(--mono);resize:none;outline:none;box-sizing:border-box"></textarea>';
  h+='<button onclick="navigator.clipboard.writeText(document.getElementById(\'cipher-out\').value)" style="margin-top:6px;padding:4px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:9px">Copy Result</button>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTextStats(){
  let panel=document.getElementById('text-stats-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='text-stats-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  window._tsAnalyze=function(){
    var text=document.getElementById('ts-input').value||'';
    var out=document.getElementById('ts-out');if(!out)return;
    if(!text.trim()){out.innerHTML='<div style="color:var(--text-muted);font-size:10px;text-align:center;padding:12px">Paste text above to analyze</div>';return;}
    var words=text.trim().split(/\s+/);var wordCount=words.length;
    var uniqueWords=new Set(words.map(function(w){return w.toLowerCase().replace(/[^a-z]/g,'');}));uniqueWords.delete('');
    var freq={};words.forEach(function(w){var lw=w.toLowerCase().replace(/[^a-z]/g,'');if(lw)freq[lw]=(freq[lw]||0)+1;});
    var topWords=Object.entries(freq).sort(function(a,b){return b[1]-a[1];}).slice(0,10);
    var sentences=text.split(/[.!?]+/).filter(function(s){return s.trim();}).length;
    var avgWordLen=words.reduce(function(s,w){return s+w.length;},0)/wordCount;
    var avgSentLen=wordCount/Math.max(sentences,1);
    var letterFreq={};text.toLowerCase().replace(/[^a-z]/g,'').split('').forEach(function(c){letterFreq[c]=(letterFreq[c]||0)+1;});
    var topLetters=Object.entries(letterFreq).sort(function(a,b){return b[1]-a[1];}).slice(0,10);
    var totalLetters=text.replace(/[^a-zA-Z]/g,'').length;
    var h2='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">';
    [{l:'Words',v:wordCount},{l:'Unique',v:uniqueWords.size},{l:'Sentences',v:sentences},{l:'Avg Word',v:avgWordLen.toFixed(1)+'c'},{l:'Avg Sentence',v:avgSentLen.toFixed(1)+'w'},{l:'Letters',v:totalLetters}].forEach(function(m){
      h2+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:6px;text-align:center"><div style="font-size:14px;font-weight:700;color:var(--accent);font-family:var(--mono)">'+m.v+'</div><div style="font-size:8px;color:var(--text-muted)">'+m.l+'</div></div>';
    });
    h2+='</div>';
    h2+='<div style="font-size:10px;color:var(--text-muted);font-weight:600;margin-bottom:4px">Top 10 Words:</div>';
    topWords.forEach(function(w){
      var pct=Math.round(w[1]/wordCount*100);
      h2+='<div style="display:flex;align-items:center;gap:6px;padding:2px 0"><span style="font-size:10px;color:var(--text);width:80px;overflow:hidden;text-overflow:ellipsis">'+esc(w[0])+'</span><div style="flex:1;height:5px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:var(--accent);min-width:2px;border-radius:3px"></div></div><span style="font-size:9px;color:var(--text-muted);font-family:var(--mono);width:30px;text-align:right">'+w[1]+'</span></div>';
    });
    h2+='<div style="font-size:10px;color:var(--text-muted);font-weight:600;margin:10px 0 4px">Letter Frequency:</div>';
    var maxLetterFreq=topLetters.length>0?topLetters[0][1]:1;
    topLetters.forEach(function(l){
      h2+='<div style="display:flex;align-items:center;gap:6px;padding:1px 0"><span style="font-size:10px;color:var(--text);width:20px;font-family:var(--mono);font-weight:600">'+l[0]+'</span><div style="flex:1;height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="height:100%;width:'+Math.round(l[1]/maxLetterFreq*100)+'%;background:#3b82f6;border-radius:2px"></div></div><span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">'+l[1]+'</span></div>';
    });
    out.innerHTML=h2;
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Text Analysis</span><button onclick="document.getElementById(\'text-stats-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<textarea id="ts-input" oninput="window._tsAnalyze()" placeholder="Paste text to analyze..." style="width:100%;height:80px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px;font-size:11px;color:var(--text);resize:vertical;outline:none;margin-bottom:8px;box-sizing:border-box"></textarea>';
  h+='<div id="ts-out"><div style="color:var(--text-muted);font-size:10px;text-align:center;padding:12px">Paste text above to analyze</div></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskAgeSummary(){
  let panel=document.getElementById('task-age-sum-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='task-age-sum-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw';
  var now=Date.now();
  var active=S.tasks.filter(function(t){return t.status!=='done'&&t.created;});
  var buckets=[
    {label:'Today',min:0,max:1,color:'#4ade80'},
    {label:'1-3 days',min:1,max:3,color:'#22d3ee'},
    {label:'3-7 days',min:3,max:7,color:'#3b82f6'},
    {label:'1-2 weeks',min:7,max:14,color:'#8b5cf6'},
    {label:'2-4 weeks',min:14,max:28,color:'#f59e0b'},
    {label:'1-3 months',min:28,max:90,color:'#ef4444'},
    {label:'3+ months',min:90,max:9999,color:'#dc2626'}
  ];
  buckets.forEach(function(b){b.count=0;b.tasks=[];});
  active.forEach(function(t){
    var age=Math.floor((now-new Date(t.created).getTime())/86400000);
    for(var i=0;i<buckets.length;i++){
      if(age>=buckets[i].min&&age<buckets[i].max){buckets[i].count++;buckets[i].tasks.push(t);break;}
    }
  });
  var maxCount=Math.max.apply(null,buckets.map(function(b){return b.count;}).concat([1]));
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Age Summary</span><button onclick="document.getElementById(\'task-age-sum-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:10px">'+active.length+' active tasks</div>';
  buckets.forEach(function(b){
    var pct=Math.round(b.count/maxCount*100);
    h+='<div style="display:flex;align-items:center;gap:8px;padding:4px 0"><span style="font-size:10px;color:var(--text);width:80px">'+b.label+'</span><div style="flex:1;height:10px;background:var(--bg-surface);border-radius:5px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+b.color+';border-radius:5px;min-width:'+(b.count>0?'4px':'0')+'"></div></div><span style="font-size:10px;color:'+b.color+';font-family:var(--mono);font-weight:600;width:24px;text-align:right">'+b.count+'</span></div>';
  });
  var avgAge=active.length>0?Math.round(active.reduce(function(s,t){return s+Math.floor((now-new Date(t.created).getTime())/86400000);},0)/active.length):0;
  h+='<div style="text-align:center;margin-top:10px;font-size:11px;color:var(--accent);font-weight:600">Average Age: '+avgAge+' days</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickWeather(){
  let panel=document.getElementById('weather-widget');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='weather-widget';
  panel.style.cssText='position:fixed;top:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px';
  panel.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:11px;color:var(--text-muted)">Weather</span><button onclick="document.getElementById(\'weather-widget\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div><div id="weather-content" style="font-size:10px;color:var(--text-muted)">Getting location...</div>';
  document.body.appendChild(panel);
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat=pos.coords.latitude.toFixed(2);var lon=pos.coords.longitude.toFixed(2);
      fetch('https://api.open-meteo.com/v1/forecast?latitude='+lat+'&longitude='+lon+'&current_weather=true&hourly=temperature_2m,weathercode&timezone=auto&forecast_days=1').then(function(r){return r.json();}).then(function(d){
        var el=document.getElementById('weather-content');if(!el)return;
        var cw=d.current_weather||{};
        var weatherNames={0:'Clear',1:'Mainly Clear',2:'Partly Cloudy',3:'Overcast',45:'Foggy',48:'Rime Fog',51:'Light Drizzle',53:'Drizzle',55:'Heavy Drizzle',61:'Light Rain',63:'Rain',65:'Heavy Rain',71:'Light Snow',73:'Snow',75:'Heavy Snow',80:'Light Showers',81:'Showers',82:'Heavy Showers',95:'Thunderstorm',96:'Thunderstorm + Hail'};
        var name=weatherNames[cw.weathercode]||'Unknown';
        var tempF=Math.round(cw.temperature*9/5+32);
        el.innerHTML='<div style="font-size:24px;font-weight:700;color:var(--accent);margin-bottom:4px">'+Math.round(cw.temperature)+'C / '+tempF+'F</div><div style="font-size:11px;color:var(--text);margin-bottom:6px">'+name+'</div><div style="font-size:9px;color:var(--text-muted)">Wind: '+cw.windspeed+' km/h | Lat: '+lat+' | Lon: '+lon+'</div>';
      }).catch(function(){
        var el=document.getElementById('weather-content');if(el)el.textContent='Failed to fetch weather data';
      });
    },function(){
      var el=document.getElementById('weather-content');if(el)el.textContent='Location access denied';
    });
  }else{
    document.getElementById('weather-content').textContent='Geolocation not supported';
  }
}
function showTableGenerator(){
  let panel=document.getElementById('tblgen-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='tblgen-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  window._tblRows=3;window._tblCols=3;
  window._tblRender=function(){
    var el=document.getElementById('tbl-grid');if(!el)return;
    var h2='<table style="width:100%;border-collapse:collapse">';
    for(var r=0;r<window._tblRows;r++){
      h2+='<tr>';
      for(var c=0;c<window._tblCols;c++){
        var isHead=r===0;
        h2+='<td style="border:1px solid var(--border);padding:0"><input data-r="'+r+'" data-c="'+c+'" style="width:100%;background:'+(isHead?'var(--bg-surface)':'transparent')+';border:none;padding:6px 8px;font-size:10px;color:var(--text);outline:none;box-sizing:border-box;font-weight:'+(isHead?'600':'400')+'" placeholder="'+(isHead?'Header':'Cell')+'"></td>';
      }
      h2+='</tr>';
    }
    h2+='</table>';
    el.innerHTML=h2;
  };
  window._tblExport=function(fmt){
    var inputs=document.querySelectorAll('#tbl-grid input');
    var data=[];
    for(var r=0;r<window._tblRows;r++){
      data[r]=[];
      for(var c=0;c<window._tblCols;c++){
        var inp=document.querySelector('#tbl-grid input[data-r="'+r+'"][data-c="'+c+'"]');
        data[r][c]=inp?inp.value:'';
      }
    }
    var out='';
    if(fmt==='md'){
      data.forEach(function(row,ri){
        out+='| '+row.join(' | ')+' |'+'\n';
        if(ri===0)out+='| '+row.map(function(){return '---';}).join(' | ')+' |'+'\n';
      });
    }else if(fmt==='csv'){
      data.forEach(function(row){out+=row.map(function(c){return '"'+c.replace(/"/g,'""')+'"';}).join(',')+'\n';});
    }else if(fmt==='html'){
      out='<table>\n';
      data.forEach(function(row,ri){
        var tag=ri===0?'th':'td';
        out+='  <tr>'+row.map(function(c){return '<'+tag+'>'+c+'</'+tag+'>';}).join('')+'</tr>\n';
      });
      out+='</table>';
    }
    navigator.clipboard.writeText(out);
    var btn=document.getElementById('tbl-status');if(btn){btn.textContent='Copied '+fmt.toUpperCase()+'!';setTimeout(function(){btn.textContent='';},1000);}
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:15px;color:var(--text)">Table Generator</span><button onclick="document.getElementById(\'tblgen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:8px;align-items:center"><label style="font-size:9px;color:var(--text-muted)">Rows:</label><input type="number" value="3" min="1" max="20" onchange="window._tblRows=parseInt(this.value);window._tblRender()" style="width:40px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:3px;font-size:10px;color:var(--text);outline:none;text-align:center"><label style="font-size:9px;color:var(--text-muted)">Cols:</label><input type="number" value="3" min="1" max="10" onchange="window._tblCols=parseInt(this.value);window._tblRender()" style="width:40px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:3px;font-size:10px;color:var(--text);outline:none;text-align:center">';
  h+='<button onclick="window._tblExport(\'md\')" style="padding:3px 8px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:9px;font-weight:600">MD</button>';
  h+='<button onclick="window._tblExport(\'csv\')" style="padding:3px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:9px">CSV</button>';
  h+='<button onclick="window._tblExport(\'html\')" style="padding:3px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:9px">HTML</button>';
  h+='<span id="tbl-status" style="font-size:9px;color:var(--accent)"></span>';
  h+='</div>';
  h+='<div id="tbl-grid" style="overflow-x:auto"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  window._tblRender();
}
function showContentWordCloud(){
  let panel=document.getElementById('wordcloud-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='wordcloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw';
  var text='';
  (S.content||[]).forEach(function(c){text+=' '+(c.body||'');});
  (S.writerDocs||[]).forEach(function(d){text+=' '+(d.content||'');});
  var stopWords=new Set(['the','a','an','and','or','but','in','on','at','to','for','of','with','by','from','is','it','this','that','was','are','be','has','had','have','will','would','could','should','may','not','no','can','do','does','did','so','if','as','its','am','been','were','than','then','my','your','his','her','we','they','them','our','i','you','he','she','me','us','who','what','when','where','how','all','each','every','both','few','more','most','other','some','such','only','same','just','also','very','well','just']);
  var words=text.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(function(w){return w.length>2&&!stopWords.has(w);});
  var freq={};words.forEach(function(w){freq[w]=(freq[w]||0)+1;});
  var topWords=Object.entries(freq).sort(function(a,b){return b[1]-a[1];}).slice(0,40);
  var maxFreq=topWords.length>0?topWords[0][1]:1;
  var colors=['#4ade80','#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316','#a855f7'];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Content Word Cloud</span><button onclick="document.getElementById(\'wordcloud-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;padding:10px;min-height:120px">';
  topWords.forEach(function(w,i){
    var size=Math.max(10,Math.round(8+(w[1]/maxFreq)*24));
    var col=colors[i%colors.length];
    h+='<span style="font-size:'+size+'px;color:'+col+';opacity:'+(0.5+w[1]/maxFreq*0.5).toFixed(2)+';cursor:default" title="'+w[0]+': '+w[1]+' times">'+esc(w[0])+'</span>';
  });
  h+='</div>';
  h+='<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:6px">'+words.length+' words analyzed from content and writer docs</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickKanban(){
  let panel=document.getElementById('qkanban-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='qkanban-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:650px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._kanbanLanes)S._kanbanLanes={backlog:[],doing:[],review:[],done:[]};
  window._kbAdd=function(lane){
    var inp=document.getElementById('kb-input');if(!inp||!inp.value.trim())return;
    S._kanbanLanes[lane].push({text:inp.value.trim(),added:new Date().toISOString().split('T')[0]});
    inp.value='';save();window._kbRender();
  };
  window._kbMove=function(from,idx,to){
    var item=S._kanbanLanes[from].splice(idx,1)[0];
    if(item)S._kanbanLanes[to].push(item);
    save();window._kbRender();
  };
  window._kbDel=function(lane,idx){S._kanbanLanes[lane].splice(idx,1);save();window._kbRender();};
  window._kbRender=function(){
    var el=document.getElementById('qkanban-panel');if(!el)return;
    var lanes=[{key:'backlog',label:'Backlog',color:'#6b7280'},{key:'doing',label:'Doing',color:'#3b82f6'},{key:'review',label:'Review',color:'#f59e0b'},{key:'done',label:'Done',color:'#4ade80'}];
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:15px;color:var(--text)">Quick Kanban</span><button onclick="document.getElementById(\'qkanban-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:10px"><input id="kb-input" placeholder="New item..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none">';
    lanes.forEach(function(l){
      h2+='<button onclick="window._kbAdd(\''+l.key+'\')" style="padding:4px 6px;background:'+l.color+'22;border:1px solid '+l.color+'44;border-radius:var(--radius);color:'+l.color+';cursor:pointer;font-size:8px;font-weight:600">'+l.label.charAt(0)+'</button>';
    });
    h2+='</div>';
    h2+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">';
    lanes.forEach(function(l){
      h2+='<div style="min-height:100px"><div style="font-size:10px;font-weight:600;color:'+l.color+';margin-bottom:6px;display:flex;justify-content:space-between"><span>'+l.label+'</span><span style="font-family:var(--mono)">'+S._kanbanLanes[l.key].length+'</span></div>';
      S._kanbanLanes[l.key].forEach(function(item,i){
        h2+='<div style="background:var(--bg-surface);border:1px solid var(--border);border-left:3px solid '+l.color+';border-radius:3px;padding:5px 6px;margin-bottom:4px;font-size:9px;color:var(--text)">';
        h2+=esc(item.text);
        h2+='<div style="display:flex;gap:3px;margin-top:3px">';
        var li=lanes.map(function(x){return x.key;}).indexOf(l.key);
        if(li>0)h2+='<button onclick="window._kbMove(\''+l.key+'\','+i+',\''+lanes[li-1].key+'\')" style="background:none;border:1px solid var(--border);border-radius:2px;color:var(--text-muted);cursor:pointer;font-size:7px;padding:1px 3px">&lt;</button>';
        if(li<lanes.length-1)h2+='<button onclick="window._kbMove(\''+l.key+'\','+i+',\''+lanes[li+1].key+'\')" style="background:none;border:1px solid var(--border);border-radius:2px;color:var(--text-muted);cursor:pointer;font-size:7px;padding:1px 3px">&gt;</button>';
        h2+='<button onclick="window._kbDel(\''+l.key+'\','+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:7px;margin-left:auto">x</button>';
        h2+='</div></div>';
      });
      h2+='</div>';
    });
    h2+='</div>';
    el.innerHTML=h2;
  };
  window._kbRender();
}
function showColorContrast(){
  let panel=document.getElementById('contrast-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='contrast-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw';
  function hexToRgb(hex){hex=hex.replace('#','');if(hex.length===3)hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];return{r:parseInt(hex.substring(0,2),16),g:parseInt(hex.substring(2,4),16),b:parseInt(hex.substring(4,6),16)};}
  function luminance(r,g,b){var a=[r,g,b].map(function(v){v/=255;return v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4);});return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2];}
  function contrastRatio(c1,c2){var l1=luminance(c1.r,c1.g,c1.b);var l2=luminance(c2.r,c2.g,c2.b);var light=Math.max(l1,l2);var dark=Math.min(l1,l2);return (light+0.05)/(dark+0.05);}
  window._contrastCheck=function(){
    var fg=document.getElementById('cc-fg').value;var bg=document.getElementById('cc-bg').value;
    var fgRgb=hexToRgb(fg);var bgRgb=hexToRgb(bg);
    var ratio=contrastRatio(fgRgb,bgRgb);
    var out=document.getElementById('cc-result');var prev=document.getElementById('cc-preview');
    if(!out||!prev)return;
    var aaLarge=ratio>=3;var aaNormal=ratio>=4.5;var aaaLarge=ratio>=4.5;var aaaNormal=ratio>=7;
    out.innerHTML='<div style="font-size:24px;font-weight:700;color:var(--accent);text-align:center;margin-bottom:8px">'+ratio.toFixed(2)+':1</div>';
    out.innerHTML+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">';
    [{l:'AA Normal',pass:aaNormal},{l:'AA Large',pass:aaLarge},{l:'AAA Normal',pass:aaaNormal},{l:'AAA Large',pass:aaaLarge}].forEach(function(t){
      out.innerHTML+='<div style="background:var(--bg-surface);border-radius:var(--radius);padding:6px;text-align:center"><div style="font-size:10px;font-weight:600;color:'+(t.pass?'#4ade80':'#ef4444')+'">'+(t.pass?'PASS':'FAIL')+'</div><div style="font-size:8px;color:var(--text-muted)">'+t.l+'</div></div>';
    });
    out.innerHTML+='</div>';
    prev.style.background=bg;prev.style.color=fg;prev.textContent='Sample Text - The quick brown fox jumps over the lazy dog';
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Color Contrast Checker</span><button onclick="document.getElementById(\'contrast-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:12px;margin-bottom:12px;align-items:center"><div><label style="font-size:9px;color:var(--text-muted);display:block;margin-bottom:4px">Foreground</label><input id="cc-fg" type="color" value="#ffffff" onchange="window._contrastCheck()" style="width:50px;height:30px;border:none;cursor:pointer"></div><div><label style="font-size:9px;color:var(--text-muted);display:block;margin-bottom:4px">Background</label><input id="cc-bg" type="color" value="#000000" onchange="window._contrastCheck()" style="width:50px;height:30px;border:none;cursor:pointer"></div><button onclick="var t=document.getElementById(\'cc-fg\').value;document.getElementById(\'cc-fg\').value=document.getElementById(\'cc-bg\').value;document.getElementById(\'cc-bg\').value=t;window._contrastCheck()" style="padding:5px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:10px;margin-top:12px">Swap</button></div>';
  h+='<div id="cc-result" style="margin-bottom:10px"></div>';
  h+='<div id="cc-preview" style="padding:12px;border-radius:var(--radius);font-size:12px;text-align:center;border:1px solid var(--border)"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  window._contrastCheck();
}
function showTaskDailyGoals(){
  let panel=document.getElementById('daily-goals-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='daily-goals-panel';
  panel.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px;max-height:400px;overflow-y:auto';
  if(!S._dailyGoals)S._dailyGoals={};
  var today=new Date().toISOString().split('T')[0];
  if(!S._dailyGoals[today])S._dailyGoals[today]=[];
  window._dgAdd=function(){
    var inp=document.getElementById('dg-input');if(!inp||!inp.value.trim())return;
    S._dailyGoals[today].push({text:inp.value.trim(),done:false});
    inp.value='';save();window._dgRender();
  };
  window._dgToggle=function(i){S._dailyGoals[today][i].done=!S._dailyGoals[today][i].done;save();window._dgRender();};
  window._dgDel=function(i){S._dailyGoals[today].splice(i,1);save();window._dgRender();};
  window._dgRender=function(){
    var el=document.getElementById('daily-goals-panel');if(!el)return;
    var goals=S._dailyGoals[today]||[];
    var doneCount=goals.filter(function(g){return g.done;}).length;
    var pct=goals.length>0?Math.round(doneCount/goals.length*100):0;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-weight:600;font-size:11px;color:var(--text-muted)">Daily Goals</span><button onclick="document.getElementById(\'daily-goals-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div>';
    h2+='<div style="font-size:9px;color:var(--accent);margin-bottom:4px">'+today+' | '+doneCount+'/'+goals.length+' ('+pct+'%)</div>';
    h2+='<div style="height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden;margin-bottom:8px"><div style="height:100%;width:'+pct+'%;background:var(--accent);border-radius:2px"></div></div>';
    goals.forEach(function(g,i){
      h2+='<div style="display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid var(--border)">';
      h2+='<button onclick="window._dgToggle('+i+')" style="width:16px;height:16px;border-radius:3px;border:1px solid '+(g.done?'var(--accent)':'var(--border)')+';background:'+(g.done?'var(--accent)':'transparent')+';cursor:pointer;display:flex;align-items:center;justify-content:center;color:#000;font-size:9px;font-weight:700;flex-shrink:0">'+(g.done?'V':'')+'</button>';
      h2+='<span style="font-size:10px;color:'+(g.done?'var(--text-muted)':'var(--text)')+';flex:1;text-decoration:'+(g.done?'line-through':'none')+'">'+esc(g.text)+'</span>';
      h2+='<button onclick="window._dgDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button></div>';
    });
    h2+='<div style="display:flex;gap:4px;margin-top:6px"><input id="dg-input" placeholder="Add goal..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:10px;color:var(--text);outline:none" onkeydown="if(event.key===\'Enter\')window._dgAdd()"><button onclick="window._dgAdd()" style="padding:4px 8px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">+</button></div>';
    el.innerHTML=h2;
  };
  window._dgRender();
}
function showQuickMindmap(){
  let panel=document.getElementById('mindmap-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='mindmap-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._mindmap)S._mindmap={center:'Main Idea',branches:[]};
  window._mmAdd=function(){
    var inp=document.getElementById('mm-input');if(!inp||!inp.value.trim())return;
    S._mindmap.branches.push({text:inp.value.trim(),subs:[]});
    inp.value='';save();window._mmRender();
  };
  window._mmAddSub=function(i){
    var inp=document.getElementById('mm-sub-'+i);if(!inp||!inp.value.trim())return;
    S._mindmap.branches[i].subs.push(inp.value.trim());
    inp.value='';save();window._mmRender();
  };
  window._mmDel=function(i){S._mindmap.branches.splice(i,1);save();window._mmRender();};
  window._mmDelSub=function(i,j){S._mindmap.branches[i].subs.splice(j,1);save();window._mmRender();};
  window._mmRender=function(){
    var el=document.getElementById('mindmap-panel');if(!el)return;
    var colors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316'];
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:15px;color:var(--text)">Mind Map</span><button onclick="document.getElementById(\'mindmap-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h2+='<div style="text-align:center;margin-bottom:12px"><input value="'+esc(S._mindmap.center)+'" onchange="S._mindmap.center=this.value;save()" style="background:var(--accent);border:none;border-radius:20px;padding:8px 20px;font-size:13px;color:#000;font-weight:700;text-align:center;outline:none;max-width:200px"></div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:10px"><input id="mm-input" placeholder="New branch..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none" onkeydown="if(event.key===\'Enter\')window._mmAdd()"><button onclick="window._mmAdd()" style="padding:5px 12px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">+</button></div>';
    S._mindmap.branches.forEach(function(br,i){
      var col=colors[i%colors.length];
      h2+='<div style="border-left:3px solid '+col+';padding-left:10px;margin-bottom:10px">';
      h2+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:12px;font-weight:600;color:'+col+'">'+esc(br.text)+'</span><button onclick="window._mmDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:10px">x</button></div>';
      br.subs.forEach(function(sub,j){
        h2+='<div style="display:flex;justify-content:space-between;padding:2px 0 2px 16px;font-size:10px;color:var(--text)"><span>- '+esc(sub)+'</span><button onclick="window._mmDelSub('+i+','+j+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:8px">x</button></div>';
      });
      h2+='<div style="padding-left:16px;margin-top:4px"><div style="display:flex;gap:3px"><input id="mm-sub-'+i+'" placeholder="Add sub-item..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:3px 6px;font-size:9px;color:var(--text);outline:none" onkeydown="if(event.key===\'Enter\')window._mmAddSub('+i+')"><button onclick="window._mmAddSub('+i+')" style="padding:3px 6px;background:'+col+'44;border:none;border-radius:var(--radius);color:'+col+';cursor:pointer;font-size:8px">+</button></div></div>';
      h2+='</div>';
    });
    el.innerHTML=h2;
  };
  window._mmRender();
}
function showFontPreview(){
  let panel=document.getElementById('font-preview-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='font-preview-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  var fonts=['Arial','Helvetica','Georgia','Times New Roman','Courier New','Verdana','Trebuchet MS','Impact','Comic Sans MS','Lucida Console','Monaco','Palatino','Garamond','system-ui','-apple-system','monospace','serif','sans-serif','cursive','fantasy'];
  window._fpText='The quick brown fox jumps over the lazy dog. 0123456789';
  window._fpSize=18;
  window._fpUpdate=function(){
    var txt=document.getElementById('fp-text');
    if(txt)window._fpText=txt.value;
    var size=document.getElementById('fp-size');
    if(size)window._fpSize=parseInt(size.value);
    var list=document.getElementById('fp-list');if(!list)return;
    list.innerHTML=fonts.map(function(f){
      return '<div style="padding:8px 10px;border-bottom:1px solid var(--border)"><div style="font-size:9px;color:var(--accent);font-family:var(--mono);margin-bottom:4px">'+f+'</div><div style="font-family:\''+f+'\';font-size:'+window._fpSize+'px;color:var(--text);line-height:1.4">'+esc(window._fpText)+'</div></div>';
    }).join('');
  };
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Font Preview</span><button onclick="document.getElementById(\'font-preview-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:10px"><input id="fp-text" value="'+esc(window._fpText)+'" oninput="window._fpUpdate()" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none"><input id="fp-size" type="number" value="18" min="8" max="48" onchange="window._fpUpdate()" style="width:45px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px;font-size:10px;color:var(--text);outline:none;text-align:center"><span style="font-size:9px;color:var(--text-muted);align-self:center">px</span></div>';
  h+='<div id="fp-list"></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  window._fpUpdate();
}
function showTaskStatusFlow(){
  let panel=document.getElementById('status-flow-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='status-flow-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw';
  var statuses=[
    {key:'todo',label:'To Do',color:'#6b7280'},
    {key:'in-progress',label:'In Progress',color:'#3b82f6'},
    {key:'done',label:'Done',color:'#4ade80'}
  ];
  var counts={};
  statuses.forEach(function(s){counts[s.key]=S.tasks.filter(function(t){return t.status===s.key;}).length;});
  var total=S.tasks.length||1;
  var w=460,ht=180;
  var svg='<svg width="'+w+'" height="'+ht+'" viewBox="0 0 '+w+' '+ht+'">';
  var boxW=120,boxH=60,gap=50;
  statuses.forEach(function(s,i){
    var x=i*(boxW+gap)+20;var y=(ht-boxH)/2;
    var pct=Math.round(counts[s.key]/total*100);
    svg+='<rect x="'+x+'" y="'+y+'" width="'+boxW+'" height="'+boxH+'" rx="8" fill="'+s.color+'22" stroke="'+s.color+'" stroke-width="2"/>';
    svg+='<text x="'+(x+boxW/2)+'" y="'+(y+22)+'" fill="'+s.color+'" font-size="11" text-anchor="middle" font-weight="600">'+s.label+'</text>';
    svg+='<text x="'+(x+boxW/2)+'" y="'+(y+42)+'" fill="'+s.color+'" font-size="18" text-anchor="middle" font-weight="700" font-family="var(--mono)">'+counts[s.key]+'</text>';
    svg+='<text x="'+(x+boxW/2)+'" y="'+(y+boxH+14)+'" fill="#888" font-size="9" text-anchor="middle">'+pct+'%</text>';
    if(i<statuses.length-1){
      var ax=x+boxW+5;var ay=ht/2;
      svg+='<line x1="'+ax+'" y1="'+ay+'" x2="'+(ax+gap-10)+'" y2="'+ay+'" stroke="#555" stroke-width="2" marker-end="url(#arrowhead)"/>';
    }
  });
  svg+='<defs><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#555"/></marker></defs>';
  svg+='</svg>';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Task Status Flow</span><button onclick="document.getElementById(\'status-flow-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="text-align:center;overflow-x:auto">'+svg+'</div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickProsCons(){
  let panel=document.getElementById('proscons-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='proscons-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._proscons)S._proscons={topic:'',pros:[],cons:[]};
  window._pcAdd=function(side){
    var inp=document.getElementById('pc-input');if(!inp||!inp.value.trim())return;
    S._proscons[side].push(inp.value.trim());inp.value='';save();window._pcRender();
  };
  window._pcDel=function(side,i){S._proscons[side].splice(i,1);save();window._pcRender();};
  window._pcRender=function(){
    var el=document.getElementById('proscons-panel');if(!el)return;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:15px;color:var(--text)">Pros & Cons</span><button onclick="document.getElementById(\'proscons-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h2+='<input value="'+esc(S._proscons.topic)+'" onchange="S._proscons.topic=this.value;save()" placeholder="Decision topic..." style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px 10px;font-size:12px;color:var(--text);outline:none;margin-bottom:8px;box-sizing:border-box;font-weight:600">';
    h2+='<div style="display:flex;gap:4px;margin-bottom:10px"><input id="pc-input" placeholder="Add item..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none"><button onclick="window._pcAdd(\'pros\')" style="padding:4px 10px;background:#4ade8022;border:1px solid #4ade8044;border-radius:var(--radius);color:#4ade80;cursor:pointer;font-size:9px;font-weight:600">+ Pro</button><button onclick="window._pcAdd(\'cons\')" style="padding:4px 10px;background:#ef444422;border:1px solid #ef444444;border-radius:var(--radius);color:#ef4444;cursor:pointer;font-size:9px;font-weight:600">+ Con</button></div>';
    h2+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    [{key:'pros',label:'Pros',color:'#4ade80'},{key:'cons',label:'Cons',color:'#ef4444'}].forEach(function(side){
      h2+='<div style="border:1px solid '+side.color+'33;border-radius:var(--radius);padding:8px">';
      h2+='<div style="font-size:11px;font-weight:600;color:'+side.color+';margin-bottom:6px;display:flex;justify-content:space-between"><span>'+side.label+'</span><span style="font-family:var(--mono)">'+S._proscons[side.key].length+'</span></div>';
      S._proscons[side.key].forEach(function(item,i){
        h2+='<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:10px;border-bottom:1px solid var(--border)"><span style="color:var(--text)">'+esc(item)+'</span><button onclick="window._pcDel(\''+side.key+'\','+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button></div>';
      });
      if(S._proscons[side.key].length===0)h2+='<div style="font-size:9px;color:var(--text-muted);font-style:italic">None yet</div>';
      h2+='</div>';
    });
    h2+='</div>';
    var balance=S._proscons.pros.length-S._proscons.cons.length;
    h2+='<div style="text-align:center;margin-top:10px;font-size:11px;font-weight:600;color:'+(balance>0?'#4ade80':balance<0?'#ef4444':'var(--text-muted)')+'">Balance: '+(balance>0?'+':'')+balance+'</div>';
    el.innerHTML=h2;
  };
  window._pcRender();
}
function showSpacingGuide(){
  let panel=document.getElementById('spacing-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='spacing-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  var scales=[
    {name:'4px Scale',values:[0,4,8,12,16,20,24,32,40,48,64,80,96,128]},
    {name:'8px Scale',values:[0,8,16,24,32,40,48,56,64,80,96,128]},
    {name:'Tailwind',values:[0,1,2,4,6,8,10,12,16,20,24,32,40,48,56,64,72,80,96]}
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Spacing Guide</span><button onclick="document.getElementById(\'spacing-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  scales.forEach(function(scale){
    h+='<div style="font-size:10px;color:var(--accent);font-weight:600;margin:10px 0 6px">'+scale.name+'</div>';
    scale.values.forEach(function(v){
      h+='<div style="display:flex;align-items:center;gap:8px;padding:2px 0"><span style="font-size:9px;color:var(--text-muted);font-family:var(--mono);width:30px;text-align:right">'+v+'px</span><div style="width:'+v+'px;height:8px;background:var(--accent);border-radius:2px;opacity:0.7"></div></div>';
    });
  });
  h+='<div style="font-size:10px;color:var(--accent);font-weight:600;margin:10px 0 6px">Type Scale</div>';
  [10,11,12,14,16,18,20,24,28,32,36,40,48].forEach(function(s){
    h+='<div style="font-size:'+s+'px;color:var(--text);line-height:1.3;padding:2px 0">'+s+'px - The quick brown fox <span style="font-size:8px;color:var(--text-muted);font-family:var(--mono)">'+s+'px</span></div>';
  });
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showTaskMilestones(){
  let panel=document.getElementById('milestones-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='milestones-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._milestones)S._milestones=[];
  window._msAdd=function(){
    var title=document.getElementById('ms-title');var date=document.getElementById('ms-date');
    if(!title||!title.value.trim())return;
    S._milestones.push({title:title.value.trim(),date:date?date.value:'',done:false,created:new Date().toISOString().split('T')[0]});
    title.value='';if(date)date.value='';
    save();window._msRender();
  };
  window._msToggle=function(i){S._milestones[i].done=!S._milestones[i].done;save();window._msRender();};
  window._msDel=function(i){S._milestones.splice(i,1);save();window._msRender();};
  window._msRender=function(){
    var el=document.getElementById('milestones-panel');if(!el)return;
    var doneCount=S._milestones.filter(function(m){return m.done;}).length;
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:15px;color:var(--text)">Milestones</span><button onclick="document.getElementById(\'milestones-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h2+='<div style="font-size:9px;color:var(--accent);margin-bottom:8px">'+doneCount+'/'+S._milestones.length+' completed</div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:10px"><input id="ms-title" placeholder="Milestone title..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none"><input id="ms-date" type="date" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px;font-size:9px;color:var(--text);outline:none"><button onclick="window._msAdd()" style="padding:5px 10px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">+</button></div>';
    S._milestones.forEach(function(m,i){
      var isOverdue=m.date&&m.date<new Date().toISOString().split('T')[0]&&!m.done;
      h2+='<div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">';
      h2+='<div style="display:flex;flex-direction:column;align-items:center;margin-top:2px"><div style="width:12px;height:12px;border-radius:50%;border:2px solid '+(m.done?'var(--accent)':'var(--border)')+';background:'+(m.done?'var(--accent)':'transparent')+';cursor:pointer" onclick="window._msToggle('+i+')"></div>';
      if(i<S._milestones.length-1)h2+='<div style="width:2px;height:20px;background:var(--border);margin-top:4px"></div>';
      h2+='</div>';
      h2+='<div style="flex:1"><div style="font-size:11px;color:'+(m.done?'var(--text-muted)':'var(--text)')+';font-weight:600;text-decoration:'+(m.done?'line-through':'none')+'">'+esc(m.title)+'</div>';
      if(m.date)h2+='<div style="font-size:9px;color:'+(isOverdue?'#ef4444':'var(--text-muted)')+';font-family:var(--mono);margin-top:2px">'+m.date+(isOverdue?' (overdue)':'')+'</div>';
      h2+='</div>';
      h2+='<button onclick="window._msDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:10px;margin-top:2px">x</button>';
      h2+='</div>';
    });
    if(S._milestones.length===0)h2+='<div style="padding:12px;text-align:center;font-size:10px;color:var(--text-muted)">No milestones yet</div>';
    el.innerHTML=h2;
  };
  window._msRender();
}
function showQuickWishlist(){
  let panel=document.getElementById('wishlist-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='wishlist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._wishlist)S._wishlist=[];
  window._wlAdd=function(){
    var name=document.getElementById('wl-name');var note=document.getElementById('wl-note');var pri=document.getElementById('wl-pri');
    if(!name||!name.value.trim())return;
    S._wishlist.push({name:name.value.trim(),note:note?note.value.trim():'',priority:pri?pri.value:'medium',added:new Date().toISOString().split('T')[0]});
    name.value='';if(note)note.value='';
    save();window._wlRender();
  };
  window._wlDel=function(i){S._wishlist.splice(i,1);save();window._wlRender();};
  window._wlRender=function(){
    var el=document.getElementById('wishlist-panel');if(!el)return;
    var priColors={high:'#ef4444',medium:'#f59e0b',low:'#6b7280'};
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:15px;color:var(--text)">Wishlist</span><div style="display:flex;gap:6px;align-items:center"><span style="font-size:10px;color:var(--text-muted)">'+S._wishlist.length+' items</span><button onclick="document.getElementById(\'wishlist-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div></div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:6px"><input id="wl-name" placeholder="Item name..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none"><select id="wl-pri" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px;font-size:9px;color:var(--text);outline:none"><option value="high">High</option><option value="medium" selected>Med</option><option value="low">Low</option></select><button onclick="window._wlAdd()" style="padding:5px 10px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">+</button></div>';
    h2+='<input id="wl-note" placeholder="Note (optional)..." style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:4px 8px;font-size:9px;color:var(--text);outline:none;margin-bottom:10px;box-sizing:border-box">';
    S._wishlist.forEach(function(item,i){
      var pc=priColors[item.priority]||'#f59e0b';
      h2+='<div style="border-left:3px solid '+pc+';padding:6px 8px;margin-bottom:4px;background:var(--bg-surface);border-radius:0 var(--radius) var(--radius) 0">';
      h2+='<div style="display:flex;justify-content:space-between"><span style="font-size:11px;color:var(--text);font-weight:600">'+esc(item.name)+'</span><div style="display:flex;gap:4px"><span style="font-size:8px;color:'+pc+';font-family:var(--mono)">'+item.priority+'</span><button onclick="window._wlDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:9px">x</button></div></div>';
      if(item.note)h2+='<div style="font-size:9px;color:var(--text-muted);margin-top:2px">'+esc(item.note)+'</div>';
      h2+='<div style="font-size:8px;color:#555;margin-top:2px">Added '+item.added+'</div>';
      h2+='</div>';
    });
    if(S._wishlist.length===0)h2+='<div style="padding:12px;text-align:center;font-size:10px;color:var(--text-muted)">Your wishlist is empty</div>';
    el.innerHTML=h2;
  };
  window._wlRender();
}
function showBoxShadowGen(){
  let panel=document.getElementById('shadow-gen-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='shadow-gen-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw';
  window._bsUpdate=function(){
    var x=document.getElementById('bs-x').value||0;
    var y=document.getElementById('bs-y').value||0;
    var blur=document.getElementById('bs-blur').value||0;
    var spread=document.getElementById('bs-spread').value||0;
    var color=document.getElementById('bs-color').value||'#000000';
    var opacity=document.getElementById('bs-opacity').value||50;
    var inset=document.getElementById('bs-inset').checked;
    var r=parseInt(color.substring(1,3),16);var g=parseInt(color.substring(3,5),16);var b=parseInt(color.substring(5,7),16);
    var shadow=(inset?'inset ':'')+x+'px '+y+'px '+blur+'px '+spread+'px rgba('+r+','+g+','+b+','+(opacity/100).toFixed(2)+')';
    var prev=document.getElementById('bs-preview');if(prev)prev.style.boxShadow=shadow;
    var code=document.getElementById('bs-code');if(code)code.textContent='box-shadow: '+shadow+';';
  };
  var range='style="width:100%;accent-color:var(--accent)"';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Box Shadow Generator</span><button onclick="document.getElementById(\'shadow-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div id="bs-preview" style="width:120px;height:120px;background:var(--bg-surface);border-radius:var(--radius);margin:0 auto 16px;box-shadow:0 4px 12px rgba(0,0,0,0.5)"></div>';
  var controls=[
    {id:'bs-x',label:'X Offset',min:-50,max:50,val:0},
    {id:'bs-y',label:'Y Offset',min:-50,max:50,val:4},
    {id:'bs-blur',label:'Blur',min:0,max:100,val:12},
    {id:'bs-spread',label:'Spread',min:-50,max:50,val:0},
    {id:'bs-opacity',label:'Opacity',min:0,max:100,val:50}
  ];
  controls.forEach(function(c){
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="font-size:9px;color:var(--text-muted);width:60px">'+c.label+'</span><input id="'+c.id+'" type="range" min="'+c.min+'" max="'+c.max+'" value="'+c.val+'" oninput="window._bsUpdate()" '+range+'><span style="font-size:9px;color:var(--text);font-family:var(--mono);width:30px" id="'+c.id+'-v">'+c.val+'</span></div>';
  });
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:9px;color:var(--text-muted);width:60px">Color</span><input id="bs-color" type="color" value="#000000" onchange="window._bsUpdate()" style="width:30px;height:20px;border:none;cursor:pointer"><label style="font-size:9px;color:var(--text);display:flex;align-items:center;gap:4px"><input id="bs-inset" type="checkbox" onchange="window._bsUpdate()" style="accent-color:var(--accent)">Inset</label></div>';
  h+='<div style="display:flex;gap:4px;margin-top:8px"><code id="bs-code" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:6px 8px;font-size:9px;color:var(--accent);font-family:var(--mono)"></code><button onclick="navigator.clipboard.writeText(document.getElementById(\'bs-code\').textContent)" style="padding:5px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-size:9px">Copy</button></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
  // Wire range value display
  controls.forEach(function(c){
    document.getElementById(c.id).addEventListener('input',function(){document.getElementById(c.id+'-v').textContent=this.value;});
  });
  window._bsUpdate();
}
function showTaskWeekOverWeek(){
  let panel=document.getElementById('wow-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='wow-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw';
  var weeks=6;var data=[];var today=new Date();
  for(var w=weeks-1;w>=0;w--){
    var weekStart=new Date(today);weekStart.setDate(weekStart.getDate()-weekStart.getDay()+1-w*7);
    var weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+6);
    var ws=weekStart.toISOString().split('T')[0];var we=weekEnd.toISOString().split('T')[0];
    var created=S.tasks.filter(function(t){return t.created&&t.created>=ws&&t.created<=we+'T';}).length;
    var completed=S.tasks.filter(function(t){return t.completedAt&&t.completedAt>=ws&&t.completedAt<=we+'T';}).length;
    data.push({label:ws.substring(5),created:created,completed:completed});
  }
  var maxVal=Math.max.apply(null,data.map(function(d){return Math.max(d.created,d.completed);}).concat([1]));
  var width=460,ht=200,pad=40,gw=width-pad*2,gh=ht-pad*2;
  var barW=Math.floor(gw/weeks*0.35);
  var svg='<svg width="'+width+'" height="'+ht+'" viewBox="0 0 '+width+' '+ht+'" style="font-family:var(--mono)">';
  for(var g=0;g<=4;g++){var y=pad+gh-gh*(g/4);svg+='<line x1="'+pad+'" y1="'+y+'" x2="'+(pad+gw)+'" y2="'+y+'" stroke="#222" stroke-width="0.5"/>';}
  data.forEach(function(d,i){
    var x=pad+i*(gw/weeks)+4;
    var ch=d.created?(d.created/maxVal)*gh:0;
    var dh=d.completed?(d.completed/maxVal)*gh:0;
    svg+='<rect x="'+x+'" y="'+(pad+gh-ch)+'" width="'+barW+'" height="'+ch+'" fill="#3b82f6" rx="2" opacity="0.8"><title>'+d.label+': '+d.created+' created</title></rect>';
    svg+='<rect x="'+(x+barW+2)+'" y="'+(pad+gh-dh)+'" width="'+barW+'" height="'+dh+'" fill="#4ade80" rx="2" opacity="0.8"><title>'+d.label+': '+d.completed+' completed</title></rect>';
    svg+='<text x="'+(x+barW)+'" y="'+(ht-5)+'" fill="#666" font-size="8" text-anchor="middle">'+d.label+'</text>';
  });
  svg+='</svg>';
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:700;font-size:15px;color:var(--text)">Week-over-Week</span><button onclick="document.getElementById(\'wow-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
  h+='<div style="overflow-x:auto">'+svg+'</div>';
  h+='<div style="display:flex;gap:12px;justify-content:center;font-size:9px;color:var(--text-muted);margin-top:6px"><span style="display:flex;align-items:center;gap:3px"><span style="width:10px;height:6px;background:#3b82f6;border-radius:1px"></span>Created</span><span style="display:flex;align-items:center;gap:3px"><span style="width:10px;height:6px;background:#4ade80;border-radius:1px"></span>Completed</span></div>';
  panel.innerHTML=h;document.body.appendChild(panel);
}
function showQuickReadingList(){
  let panel=document.getElementById('readlist-panel');if(panel){panel.remove();return;}
  panel=document.createElement('div');panel.id='readlist-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._readingList)S._readingList=[];
  window._rlAdd=function(){
    var title=document.getElementById('rl-title');var author=document.getElementById('rl-author');
    if(!title||!title.value.trim())return;
    S._readingList.push({title:title.value.trim(),author:author?author.value.trim():'',status:'to-read',added:new Date().toISOString().split('T')[0]});
    title.value='';if(author)author.value='';
    save();window._rlRender();
  };
  window._rlCycle=function(i){
    var states=['to-read','reading','finished'];
    var cur=states.indexOf(S._readingList[i].status);
    S._readingList[i].status=states[(cur+1)%states.length];
    save();window._rlRender();
  };
  window._rlDel=function(i){S._readingList.splice(i,1);save();window._rlRender();};
  window._rlRender=function(){
    var el=document.getElementById('readlist-panel');if(!el)return;
    var stColors={'to-read':'#6b7280','reading':'#f59e0b','finished':'#4ade80'};
    var counts={'to-read':0,'reading':0,'finished':0};
    S._readingList.forEach(function(b){counts[b.status]=(counts[b.status]||0)+1;});
    var h2='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:700;font-size:15px;color:var(--text)">Reading List</span><button onclick="document.getElementById(\'readlist-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>';
    h2+='<div style="display:flex;gap:8px;font-size:9px;margin-bottom:8px">';
    Object.entries(counts).forEach(function(e){h2+='<span style="color:'+stColors[e[0]]+'">'+e[0]+': '+e[1]+'</span>';});
    h2+='</div>';
    h2+='<div style="display:flex;gap:4px;margin-bottom:10px"><input id="rl-title" placeholder="Book title..." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none"><input id="rl-author" placeholder="Author..." style="width:80px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);padding:5px 8px;font-size:10px;color:var(--text);outline:none"><button onclick="window._rlAdd()" style="padding:5px 10px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;cursor:pointer;font-size:10px;font-weight:600">+</button></div>';
    S._readingList.forEach(function(b,i){
      var sc=stColors[b.status]||'#6b7280';
      h2+='<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">';
      h2+='<button onclick="window._rlCycle('+i+')" style="padding:2px 6px;background:'+sc+'22;border:1px solid '+sc+'44;border-radius:var(--radius);color:'+sc+';cursor:pointer;font-size:8px;font-weight:600;white-space:nowrap">'+b.status+'</button>';
      h2+='<div style="flex:1"><div style="font-size:11px;color:var(--text);font-weight:600">'+esc(b.title)+'</div>';
      if(b.author)h2+='<div style="font-size:9px;color:var(--text-muted)">by '+esc(b.author)+'</div>';
      h2+='</div>';
      h2+='<button onclick="window._rlDel('+i+')" style="background:none;border:none;color:#666;cursor:pointer;font-size:10px">x</button>';
      h2+='</div>';
    });
    if(S._readingList.length===0)h2+='<div style="padding:12px;text-align:center;font-size:10px;color:var(--text-muted)">No books in your reading list</div>';
    el.innerHTML=h2;
  };
  window._rlRender();
}
function showGradientGen(){
  var ex=document.getElementById('gradient-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='gradient-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  var c1='#4ade80',c2='#06b6d4',angle=90,type='linear';
  function getCSS(){
    if(type==='linear') return 'linear-gradient('+angle+'deg, '+c1+', '+c2+')';
    return 'radial-gradient(circle, '+c1+', '+c2+')';
  }
  function render(){
    var prev=d.querySelector('.grad-preview');if(prev)prev.style.background=getCSS();
    var code=d.querySelector('.grad-code');if(code)code.textContent='background: '+getCSS()+';';
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Gradient Generator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div class="grad-preview" style="height:120px;border-radius:8px;margin-bottom:12px;background:'+getCSS()+'"></div>'+
    '<div style="display:flex;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Color 1<br><input type="color" value="'+c1+'" id="grad-c1" style="width:60px;height:30px;border:none;cursor:pointer"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Color 2<br><input type="color" value="'+c2+'" id="grad-c2" style="width:60px;height:30px;border:none;cursor:pointer"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Angle<br><input type="range" min="0" max="360" value="'+angle+'" id="grad-angle" style="width:100px"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Type<br><select id="grad-type" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:2px"><option value="linear">Linear</option><option value="radial">Radial</option></select></label>'+
    '</div>'+
    '<div class="grad-code" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:12px;color:#4ade80;margin-bottom:10px;word-break:break-all">background: '+getCSS()+';</div>'+
    '<button id="grad-copy-btn" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy CSS</button>';
  document.body.appendChild(d);
  d.querySelector('#grad-c1').oninput=function(e){c1=e.target.value;render();};
  d.querySelector('#grad-c2').oninput=function(e){c2=e.target.value;render();};
  d.querySelector('#grad-angle').oninput=function(e){angle=parseInt(e.target.value);render();};
  d.querySelector('#grad-type').onchange=function(e){type=e.target.value;render();};
  d.querySelector('#grad-copy-btn').onclick=function(){
    navigator.clipboard.writeText('background: '+getCSS()+';');
    this.textContent='Copied!';var b=this;setTimeout(function(){b.textContent='Copy CSS';},800);
  };
}
function showTaskCompletionRate(){
  var ex=document.getElementById('completion-rate-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var total=tasks.length,done=tasks.filter(function(t){return t.status==='done';}).length;
  var rate=total?Math.round(done/total*100):0;
  var byProject={};
  tasks.forEach(function(t){
    var p=t.project||'No Project';
    if(!byProject[p])byProject[p]={total:0,done:0};
    byProject[p].total++;
    if(t.status==='done')byProject[p].done++;
  });
  var rows='';
  Object.keys(byProject).forEach(function(p){
    var bp=byProject[p];
    var pr=bp.total?Math.round(bp.done/bp.total*100):0;
    rows+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)">'+
      '<span style="color:var(--text-primary);font-size:12px">'+esc(p)+'</span>'+
      '<div style="display:flex;align-items:center;gap:8px">'+
      '<div style="width:80px;height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pr+'%;background:#4ade80;border-radius:3px"></div></div>'+
      '<span style="color:var(--text-muted);font-size:11px;min-width:35px;text-align:right">'+pr+'%</span>'+
      '</div></div>';
  });
  var d=document.createElement('div');d.id='completion-rate-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Completion Rate</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="text-align:center;margin-bottom:16px">'+
    '<div style="font-size:48px;font-weight:700;color:#4ade80">'+rate+'%</div>'+
    '<div style="color:var(--text-muted);font-size:12px">'+done+' of '+total+' tasks completed</div>'+
    '</div>'+
    '<div style="margin-bottom:12px"><div style="width:100%;height:10px;background:var(--bg-surface);border-radius:5px;overflow:hidden"><div style="height:100%;width:'+rate+'%;background:#4ade80;border-radius:5px"></div></div></div>'+
    '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;font-weight:600">By Project</div>'+
    rows;
  document.body.appendChild(d);
}
function showQuickHabitStreak(){
  var ex=document.getElementById('habit-streak-float');if(ex){ex.remove();return;}
  if(!S._habitStreaks)S._habitStreaks=[];
  var d=document.createElement('div');d.id='habit-streak-float';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:300px;max-height:70vh;overflow-y:auto';
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Habit Streaks</span><button onclick="document.getElementById(\'habit-streak-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">x</button></div>';
    h+='<div style="display:flex;gap:6px;margin-bottom:12px"><input id="hs-input" placeholder="New habit..." style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:12px"><button onclick="window._hsAdd()" style="background:#4ade80;color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">+</button></div>';
    var today=new Date().toISOString().split('T')[0];
    S._habitStreaks.forEach(function(hab,i){
      var checked=hab.dates&&hab.dates.indexOf(today)!==-1;
      var streak=0;
      if(hab.dates&&hab.dates.length){
        var sorted=hab.dates.slice().sort().reverse();
        var dt=new Date();
        for(var j=0;j<sorted.length;j++){
          var dd=dt.toISOString().split('T')[0];
          if(sorted[j]===dd){streak++;dt.setDate(dt.getDate()-1);}else break;
        }
      }
      h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:6px">'+
        '<div style="display:flex;align-items:center;gap:8px">'+
        '<button onclick="window._hsToggle('+i+')" style="width:20px;height:20px;border-radius:4px;border:2px solid '+(checked?'#4ade80':'var(--border)')+';background:'+(checked?'#4ade80':'transparent')+';cursor:pointer;display:flex;align-items:center;justify-content:center;color:#000;font-size:12px;font-weight:700">'+(checked?'v':'')+'</button>'+
        '<span style="color:var(--text-primary);font-size:12px">'+esc(hab.name)+'</span>'+
        '</div>'+
        '<div style="display:flex;align-items:center;gap:6px">'+
        '<span style="color:#4ade80;font-size:11px;font-weight:600">'+streak+'d</span>'+
        '<button onclick="window._hsDelete('+i+')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px">x</button>'+
        '</div></div>';
    });
    if(!S._habitStreaks.length) h+='<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px 0">Add habits to track streaks</div>';
    d.innerHTML=h;
  }
  window._hsAdd=function(){
    var inp=document.getElementById('hs-input');if(!inp||!inp.value.trim())return;
    S._habitStreaks.push({name:inp.value.trim(),dates:[]});save();rend();
  };
  window._hsToggle=function(i){
    var hab=S._habitStreaks[i];if(!hab)return;
    if(!hab.dates)hab.dates=[];
    var today=new Date().toISOString().split('T')[0];
    var idx=hab.dates.indexOf(today);
    if(idx===-1)hab.dates.push(today);else hab.dates.splice(idx,1);
    save();rend();
  };
  window._hsDelete=function(i){
    S._habitStreaks.splice(i,1);save();rend();
  };
  document.body.appendChild(d);
  rend();
}
function showBorderRadiusGen(){
  var ex=document.getElementById('border-radius-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='border-radius-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  var tl=16,tr=16,br=16,bl=16;
  function getCSS(){return tl+'px '+tr+'px '+br+'px '+bl+'px';}
  function render(){
    var prev=d.querySelector('.br-preview');if(prev)prev.style.borderRadius=getCSS();
    var code=d.querySelector('.br-code');if(code)code.textContent='border-radius: '+getCSS()+';';
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Border Radius Generator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div class="br-preview" style="width:160px;height:160px;background:linear-gradient(135deg,#4ade80,#06b6d4);border-radius:'+getCSS()+';margin:0 auto 16px auto"></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Top-Left<br><input type="range" min="0" max="100" value="'+tl+'" id="br-tl" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Top-Right<br><input type="range" min="0" max="100" value="'+tr+'" id="br-tr" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Bottom-Left<br><input type="range" min="0" max="100" value="'+bl+'" id="br-bl" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Bottom-Right<br><input type="range" min="0" max="100" value="'+br+'" id="br-br" style="width:100%"></label>'+
    '</div>'+
    '<div class="br-code" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:12px;color:#4ade80;margin-bottom:10px">border-radius: '+getCSS()+';</div>'+
    '<button id="br-copy" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy CSS</button>';
  document.body.appendChild(d);
  d.querySelector('#br-tl').oninput=function(e){tl=parseInt(e.target.value);render();};
  d.querySelector('#br-tr').oninput=function(e){tr=parseInt(e.target.value);render();};
  d.querySelector('#br-bl').oninput=function(e){bl=parseInt(e.target.value);render();};
  d.querySelector('#br-br').oninput=function(e){br=parseInt(e.target.value);render();};
  d.querySelector('#br-copy').onclick=function(){
    navigator.clipboard.writeText('border-radius: '+getCSS()+';');
    this.textContent='Copied!';var b=this;setTimeout(function(){b.textContent='Copy CSS';},800);
  };
}
function showTaskVelocity(){
  var ex=document.getElementById('task-velocity-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var weeks={};
  tasks.forEach(function(t){
    if(t.status!=='done'||!t.completedAt)return;
    var d=new Date(t.completedAt);
    var start=new Date(d);start.setDate(start.getDate()-start.getDay());
    var key=start.toISOString().split('T')[0];
    weeks[key]=(weeks[key]||0)+1;
  });
  var sorted=Object.keys(weeks).sort();
  var last8=sorted.slice(-8);
  var maxV=0;last8.forEach(function(k){if(weeks[k]>maxV)maxV=weeks[k];});
  var svgW=360,svgH=140,barW=38;
  var bars='';
  last8.forEach(function(k,i){
    var v=weeks[k];
    var bh=maxV?Math.round(v/maxV*(svgH-30)):0;
    var x=i*(barW+6)+10;
    bars+='<rect x="'+x+'" y="'+(svgH-bh-20)+'" width="'+barW+'" height="'+bh+'" rx="3" fill="#4ade80" opacity="0.8"/>';
    bars+='<text x="'+(x+barW/2)+'" y="'+(svgH-bh-24)+'" text-anchor="middle" fill="var(--text-muted)" font-size="10">'+v+'</text>';
    var label=k.substring(5);
    bars+='<text x="'+(x+barW/2)+'" y="'+(svgH-4)+'" text-anchor="middle" fill="var(--text-muted)" font-size="9">'+label+'</text>';
  });
  var avg=0;last8.forEach(function(k){avg+=weeks[k];});avg=last8.length?Math.round(avg/last8.length*10)/10:0;
  var d=document.createElement('div');d.id='task-velocity-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Task Velocity</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="text-align:center;margin-bottom:12px"><span style="font-size:32px;font-weight:700;color:#4ade80">'+avg+'</span><span style="color:var(--text-muted);font-size:12px;margin-left:6px">tasks/week avg</span></div>'+
    '<svg width="'+svgW+'" height="'+svgH+'" style="display:block;margin:0 auto">'+bars+'</svg>'+
    (last8.length===0?'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px 0">Complete tasks to see velocity data</div>':'');
  document.body.appendChild(d);
}
function showQuickAffirmation(){
  var ex=document.getElementById('affirmation-float');if(ex){ex.remove();return;}
  var affirmations=[
    'I am capable of achieving great things.',
    'Every challenge is an opportunity to grow.',
    'I trust my ability to figure things out.',
    'Progress, not perfection, is the goal.',
    'I am building something meaningful.',
    'My consistency will compound over time.',
    'I choose to focus on what I can control.',
    'I am resilient, resourceful, and relentless.',
    'Today I will take one step closer to my goals.',
    'I deserve the success that is coming my way.',
    'Discipline is the bridge between goals and accomplishment.',
    'I am enough. I have enough. I do enough.',
    'My potential is limitless.',
    'I embrace discomfort as the path to mastery.',
    'I am the architect of my own life.'
  ];
  var idx=Math.floor(Math.random()*affirmations.length);
  var d=document.createElement('div');d.id='affirmation-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:40px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;text-align:center';
  d.innerHTML='<div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:20px">Daily Affirmation</div>'+
    '<div style="font-size:22px;color:var(--text-primary);line-height:1.5;font-weight:300;margin-bottom:24px;font-style:italic">"'+affirmations[idx]+'"</div>'+
    '<button onclick="window._nextAffirmation()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:8px 20px;border-radius:6px;cursor:pointer;font-size:12px;margin-right:8px">Next</button>'+
    '<button onclick="this.parentElement.remove()" style="background:#4ade80;color:#000;border:none;padding:8px 20px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Close</button>';
  window._nextAffirmation=function(){
    idx=(idx+1)%affirmations.length;
    var q=d.querySelector('div[style*="font-size:22px"]');
    if(q) q.innerHTML='"'+affirmations[idx]+'"';
  };
  document.body.appendChild(d);
}
function showFlexboxGen(){
  var ex=document.getElementById('flexbox-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='flexbox-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  var dir='row',just='center',ali='center',wrap='nowrap',gap=8;
  function getCSS(){return 'display: flex;\\nflex-direction: '+dir+';\\njustify-content: '+just+';\\nalign-items: '+ali+';\\nflex-wrap: '+wrap+';\\ngap: '+gap+'px;';}
  function render(){
    var prev=d.querySelector('.flex-preview');
    if(prev){prev.style.flexDirection=dir;prev.style.justifyContent=just;prev.style.alignItems=ali;prev.style.flexWrap=wrap;prev.style.gap=gap+'px';}
    var code=d.querySelector('.flex-code');
    if(code)code.textContent=getCSS().replace(/\\n/g,'\n');
  }
  function sel(id,opts,val){
    var h='<select id="'+id+'" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px">';
    opts.forEach(function(o){h+='<option value="'+o+'"'+(o===val?' selected':'')+'>'+o+'</option>';});
    return h+'</select>';
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Flexbox Generator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div class="flex-preview" style="display:flex;flex-direction:'+dir+';justify-content:'+just+';align-items:'+ali+';flex-wrap:'+wrap+';gap:'+gap+'px;height:140px;background:var(--bg-surface);border-radius:8px;margin-bottom:12px;padding:8px">'+
    '<div style="width:40px;height:40px;background:#4ade80;border-radius:6px;opacity:0.9"></div>'+
    '<div style="width:60px;height:30px;background:#06b6d4;border-radius:6px;opacity:0.9"></div>'+
    '<div style="width:35px;height:50px;background:#f59e0b;border-radius:6px;opacity:0.9"></div>'+
    '<div style="width:50px;height:35px;background:#ef4444;border-radius:6px;opacity:0.9"></div>'+
    '</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Direction<br>'+sel('flex-dir',['row','row-reverse','column','column-reverse'],dir)+'</label>'+
    '<label style="color:var(--text-muted);font-size:11px">Justify<br>'+sel('flex-just',['flex-start','flex-end','center','space-between','space-around','space-evenly'],just)+'</label>'+
    '<label style="color:var(--text-muted);font-size:11px">Align<br>'+sel('flex-ali',['flex-start','flex-end','center','stretch','baseline'],ali)+'</label>'+
    '<label style="color:var(--text-muted);font-size:11px">Wrap<br>'+sel('flex-wrap',['nowrap','wrap','wrap-reverse'],wrap)+'</label>'+
    '<label style="color:var(--text-muted);font-size:11px">Gap<br><input type="range" min="0" max="32" value="'+gap+'" id="flex-gap" style="width:100%"></label>'+
    '</div>'+
    '<pre class="flex-code" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:#4ade80;margin-bottom:10px;white-space:pre-wrap">'+getCSS().replace(/\\n/g,'\n')+'</pre>'+
    '<button id="flex-copy" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy CSS</button>';
  document.body.appendChild(d);
  d.querySelector('#flex-dir').onchange=function(e){dir=e.target.value;render();};
  d.querySelector('#flex-just').onchange=function(e){just=e.target.value;render();};
  d.querySelector('#flex-ali').onchange=function(e){ali=e.target.value;render();};
  d.querySelector('#flex-wrap').onchange=function(e){wrap=e.target.value;render();};
  d.querySelector('#flex-gap').oninput=function(e){gap=parseInt(e.target.value);render();};
  d.querySelector('#flex-copy').onclick=function(){
    navigator.clipboard.writeText(getCSS().replace(/\\n/g,'\n'));
    this.textContent='Copied!';var b=this;setTimeout(function(){b.textContent='Copy CSS';},800);
  };
}
function showTaskBurndown(){
  var ex=document.getElementById('task-burndown-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var total=tasks.length;
  var done=tasks.filter(function(t){return t.status==='done';});
  var remaining=total-done.length;
  var dayMap={};
  done.forEach(function(t){
    if(!t.completedAt)return;
    var d=t.completedAt.split('T')[0];
    dayMap[d]=(dayMap[d]||0)+1;
  });
  var sorted=Object.keys(dayMap).sort();
  var last14=sorted.slice(-14);
  var svgW=400,svgH=160;
  var pts=[];
  var cum=total;
  if(last14.length>0){
    var startDay=new Date(last14[0]);
    for(var i=0;i<14;i++){
      var day=new Date(startDay);day.setDate(day.getDate()+i);
      var key=day.toISOString().split('T')[0];
      if(dayMap[key])cum-=dayMap[key];
      pts.push({day:key,val:cum});
    }
  }
  var maxVal=total||1;
  var path='';
  pts.forEach(function(p,i){
    var x=20+i*(svgW-40)/Math.max(pts.length-1,1);
    var y=20+(1-p.val/maxVal)*(svgH-40);
    path+=(i===0?'M':'L')+x.toFixed(1)+','+y.toFixed(1);
  });
  var idealPath='M20,20 L'+(svgW-20)+','+(svgH-20);
  var d=document.createElement('div');d.id='task-burndown-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Task Burndown</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="display:flex;justify-content:space-around;margin-bottom:12px">'+
    '<div style="text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">'+done.length+'</div><div style="font-size:10px;color:var(--text-muted)">Completed</div></div>'+
    '<div style="text-align:center"><div style="font-size:24px;font-weight:700;color:#f59e0b">'+remaining+'</div><div style="font-size:10px;color:var(--text-muted)">Remaining</div></div>'+
    '<div style="text-align:center"><div style="font-size:24px;font-weight:700;color:var(--text-primary)">'+total+'</div><div style="font-size:10px;color:var(--text-muted)">Total</div></div>'+
    '</div>'+
    '<svg width="'+svgW+'" height="'+svgH+'" style="display:block;margin:0 auto">'+
    '<path d="'+idealPath+'" stroke="var(--border)" stroke-width="1" stroke-dasharray="4,4" fill="none"/>'+
    (path?'<path d="'+path+'" stroke="#4ade80" stroke-width="2" fill="none"/>':'')+
    '</svg>'+
    (pts.length===0?'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:16px 0">Complete tasks to see burndown chart</div>':'');
  document.body.appendChild(d);
}
function showQuickCountdown(){
  var ex=document.getElementById('countdown-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='countdown-float';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:260px';
  var target=null,interval=null;
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Countdown</span><button onclick="document.getElementById(\'countdown-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">x</button></div>';
    if(!target){
      h+='<div style="margin-bottom:8px"><input type="text" id="cd-label" placeholder="Event name..." style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:12px;box-sizing:border-box;margin-bottom:6px"></div>';
      h+='<div style="margin-bottom:8px"><input type="datetime-local" id="cd-date" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:12px;box-sizing:border-box"></div>';
      h+='<button onclick="window._cdStart()" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;width:100%">Start Countdown</button>';
    } else {
      var now=new Date(),diff=target.date-now;
      if(diff<=0){
        h+='<div style="text-align:center;padding:16px 0"><div style="font-size:18px;font-weight:700;color:#4ade80">Time\'s up!</div><div style="color:var(--text-muted);font-size:12px;margin-top:4px">'+esc(target.label)+'</div></div>';
      } else {
        var days=Math.floor(diff/86400000);
        var hours=Math.floor((diff%86400000)/3600000);
        var mins=Math.floor((diff%3600000)/60000);
        var secs=Math.floor((diff%60000)/1000);
        h+='<div style="text-align:center;margin-bottom:8px"><div style="color:var(--text-muted);font-size:11px;margin-bottom:4px">'+esc(target.label)+'</div>';
        h+='<div style="display:flex;justify-content:center;gap:8px">';
        h+='<div style="text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">'+days+'</div><div style="font-size:9px;color:var(--text-muted)">days</div></div>';
        h+='<div style="text-align:center"><div style="font-size:24px;font-weight:700;color:var(--text-primary)">'+hours+'</div><div style="font-size:9px;color:var(--text-muted)">hrs</div></div>';
        h+='<div style="text-align:center"><div style="font-size:24px;font-weight:700;color:var(--text-primary)">'+mins+'</div><div style="font-size:9px;color:var(--text-muted)">min</div></div>';
        h+='<div style="text-align:center"><div style="font-size:24px;font-weight:700;color:var(--text-primary)">'+secs+'</div><div style="font-size:9px;color:var(--text-muted)">sec</div></div>';
        h+='</div></div>';
      }
      h+='<button onclick="window._cdReset()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:4px 12px;border-radius:6px;cursor:pointer;font-size:11px;width:100%;margin-top:6px">Reset</button>';
    }
    d.innerHTML=h;
  }
  window._cdStart=function(){
    var label=document.getElementById('cd-label');
    var date=document.getElementById('cd-date');
    if(!date||!date.value)return;
    target={label:(label&&label.value?label.value:'Countdown'),date:new Date(date.value)};
    rend();
    interval=setInterval(rend,1000);
  };
  window._cdReset=function(){
    target=null;if(interval)clearInterval(interval);interval=null;rend();
  };
  document.body.appendChild(d);
  rend();
}
function showGridGen(){
  var ex=document.getElementById('grid-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='grid-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  var cols=3,rows=2,gap=8,colSize='1fr',rowSize='1fr';
  function getCSS(){return 'display: grid;\\ngrid-template-columns: repeat('+cols+', '+colSize+');\\ngrid-template-rows: repeat('+rows+', '+rowSize+');\\ngap: '+gap+'px;';}
  function render(){
    var prev=d.querySelector('.grid-preview');
    if(prev){
      prev.style.gridTemplateColumns='repeat('+cols+', 1fr)';
      prev.style.gridTemplateRows='repeat('+rows+', 1fr)';
      prev.style.gap=gap+'px';
      var cells='';for(var i=0;i<cols*rows;i++){cells+='<div style="background:'+(['#4ade80','#06b6d4','#f59e0b','#ef4444','#a78bfa','#ec4899'][i%6])+';border-radius:4px;opacity:0.7;min-height:30px"></div>';}
      prev.innerHTML=cells;
    }
    var code=d.querySelector('.grid-code');
    if(code)code.textContent=getCSS().replace(/\\n/g,'\n');
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">CSS Grid Generator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div class="grid-preview" style="display:grid;grid-template-columns:repeat('+cols+',1fr);grid-template-rows:repeat('+rows+',1fr);gap:'+gap+'px;min-height:120px;background:var(--bg-surface);border-radius:8px;padding:8px;margin-bottom:12px"></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Columns<br><input type="number" min="1" max="12" value="'+cols+'" id="grid-cols" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Rows<br><input type="number" min="1" max="12" value="'+rows+'" id="grid-rows" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Gap (px)<br><input type="number" min="0" max="40" value="'+gap+'" id="grid-gap" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Col Size<br><input type="text" value="'+colSize+'" id="grid-colsize" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Row Size<br><input type="text" value="'+rowSize+'" id="grid-rowsize" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '</div>'+
    '<pre class="grid-code" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:#4ade80;margin-bottom:10px;white-space:pre-wrap">'+getCSS().replace(/\\n/g,'\n')+'</pre>'+
    '<button id="grid-copy" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy CSS</button>';
  document.body.appendChild(d);
  render();
  d.querySelector('#grid-cols').oninput=function(e){cols=Math.max(1,parseInt(e.target.value)||1);render();};
  d.querySelector('#grid-rows').oninput=function(e){rows=Math.max(1,parseInt(e.target.value)||1);render();};
  d.querySelector('#grid-gap').oninput=function(e){gap=parseInt(e.target.value)||0;render();};
  d.querySelector('#grid-colsize').oninput=function(e){colSize=e.target.value||'1fr';render();};
  d.querySelector('#grid-rowsize').oninput=function(e){rowSize=e.target.value||'1fr';render();};
  d.querySelector('#grid-copy').onclick=function(){
    navigator.clipboard.writeText(getCSS().replace(/\\n/g,'\n'));
    this.textContent='Copied!';var b=this;setTimeout(function(){b.textContent='Copy CSS';},800);
  };
}
function showTaskDistribution(){
  var ex=document.getElementById('task-dist-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var byStatus={};
  tasks.forEach(function(t){
    var s=t.status||'todo';
    byStatus[s]=(byStatus[s]||0)+1;
  });
  var byPriority={p0:0,p1:0,p2:0,p3:0};
  tasks.forEach(function(t){
    var p=t.priority||'p3';
    if(byPriority[p]!==undefined)byPriority[p]++;
  });
  var total=tasks.length||1;
  var statusColors={todo:'#64748b','in-progress':'#f59e0b',done:'#4ade80',blocked:'#ef4444'};
  var priorityColors={p0:'#ef4444',p1:'#f59e0b',p2:'#3b82f6',p3:'#64748b'};
  var statusBars='';
  Object.keys(byStatus).forEach(function(s){
    var pct=Math.round(byStatus[s]/total*100);
    statusBars+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'+
      '<span style="color:var(--text-muted);font-size:11px;min-width:80px">'+s+'</span>'+
      '<div style="flex:1;height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+(statusColors[s]||'#64748b')+';border-radius:4px"></div></div>'+
      '<span style="color:var(--text-muted);font-size:11px;min-width:30px;text-align:right">'+byStatus[s]+'</span></div>';
  });
  var priBars='';
  Object.keys(byPriority).forEach(function(p){
    var pct=Math.round(byPriority[p]/total*100);
    priBars+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'+
      '<span style="color:var(--text-muted);font-size:11px;min-width:80px">'+p.toUpperCase()+'</span>'+
      '<div style="flex:1;height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+priorityColors[p]+';border-radius:4px"></div></div>'+
      '<span style="color:var(--text-muted);font-size:11px;min-width:30px;text-align:right">'+byPriority[p]+'</span></div>';
  });
  var d=document.createElement('div');d.id='task-dist-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Task Distribution</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;font-weight:600">By Status</div>'+statusBars+
    '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;margin-top:12px;font-weight:600">By Priority</div>'+priBars;
  document.body.appendChild(d);
}
function showQuickDice(){
  var ex=document.getElementById('dice-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='dice-float';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:240px;text-align:center';
  var result='?';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Dice Roller</span><button onclick="document.getElementById(\'dice-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">x</button></div>'+
    '<div id="dice-result" style="font-size:48px;font-weight:700;color:#4ade80;margin-bottom:16px">?</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">'+
    '<button onclick="window._rollDice(4)" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px;border-radius:6px;cursor:pointer;font-size:12px">d4</button>'+
    '<button onclick="window._rollDice(6)" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px;border-radius:6px;cursor:pointer;font-size:12px">d6</button>'+
    '<button onclick="window._rollDice(8)" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px;border-radius:6px;cursor:pointer;font-size:12px">d8</button>'+
    '<button onclick="window._rollDice(10)" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px;border-radius:6px;cursor:pointer;font-size:12px">d10</button>'+
    '<button onclick="window._rollDice(12)" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px;border-radius:6px;cursor:pointer;font-size:12px">d12</button>'+
    '<button onclick="window._rollDice(20)" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px;border-radius:6px;cursor:pointer;font-size:12px">d20</button>'+
    '</div>'+
    '<div id="dice-history" style="color:var(--text-muted);font-size:10px;min-height:20px"></div>';
  document.body.appendChild(d);
  var history=[];
  window._rollDice=function(sides){
    var val=Math.floor(Math.random()*sides)+1;
    var el=document.getElementById('dice-result');
    if(el){el.textContent=val;el.style.transform='scale(1.2)';setTimeout(function(){el.style.transform='scale(1)';},200);}
    history.unshift('d'+sides+': '+val);if(history.length>8)history.length=8;
    var hel=document.getElementById('dice-history');
    if(hel)hel.textContent=history.join(' | ');
  };
}
function showAnimationGen(){
  var ex=document.getElementById('animation-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='animation-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  var presets=[
    {name:'Fade In',css:'@keyframes fadeIn{from{opacity:0}to{opacity:1}}\\n.fade-in{animation:fadeIn 0.3s ease forwards}'},
    {name:'Slide Up',css:'@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}\\n.slide-up{animation:slideUp 0.4s ease forwards}'},
    {name:'Slide Down',css:'@keyframes slideDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}\\n.slide-down{animation:slideDown 0.4s ease forwards}'},
    {name:'Scale In',css:'@keyframes scaleIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}\\n.scale-in{animation:scaleIn 0.3s ease forwards}'},
    {name:'Bounce',css:'@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}\\n.bounce{animation:bounce 0.6s ease infinite}'},
    {name:'Pulse',css:'@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}\\n.pulse{animation:pulse 1s ease infinite}'},
    {name:'Shake',css:'@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}\\n.shake{animation:shake 0.4s ease}'},
    {name:'Spin',css:'@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}\\n.spin{animation:spin 1s linear infinite}'},
    {name:'Glow',css:'@keyframes glow{0%,100%{box-shadow:0 0 5px #4ade80}50%{box-shadow:0 0 20px #4ade80,0 0 40px #4ade8050}}\\n.glow{animation:glow 2s ease infinite}'}
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">CSS Animation Presets</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  presets.forEach(function(p,i){
    h+='<div style="background:var(--bg-surface);border-radius:8px;padding:12px;margin-bottom:8px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'+
      '<span style="color:var(--text-primary);font-size:13px;font-weight:600">'+p.name+'</span>'+
      '<button onclick="window._copyAnim('+i+')" style="background:#4ade80;color:#000;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600">Copy</button>'+
      '</div>'+
      '<pre style="font-family:monospace;font-size:10px;color:#4ade80;white-space:pre-wrap;margin:0">'+p.css.replace(/\\n/g,'\n')+'</pre>'+
      '</div>';
  });
  d.innerHTML=h;
  window._copyAnim=function(i){
    navigator.clipboard.writeText(presets[i].css.replace(/\\n/g,'\n'));
    var btns=d.querySelectorAll('button');
    var btn=btns[i+1];
    if(btn){btn.textContent='Copied!';setTimeout(function(){btn.textContent='Copy';},800);}
  };
  document.body.appendChild(d);
}
function showTaskGantt(){
  var ex=document.getElementById('task-gantt-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]).filter(function(t){return t.due;});
  tasks.sort(function(a,b){return new Date(a.due)-new Date(b.due);});
  var first20=tasks.slice(0,20);
  var minDate=null,maxDate=null;
  first20.forEach(function(t){
    var d=new Date(t.due);
    var created=t.createdAt?new Date(t.createdAt):new Date(d.getTime()-86400000*3);
    if(!minDate||created<minDate)minDate=created;
    if(!maxDate||d>maxDate)maxDate=d;
  });
  if(!minDate)minDate=new Date();
  if(!maxDate)maxDate=new Date(minDate.getTime()+86400000*14);
  var range=maxDate-minDate||1;
  var svgW=420,rowH=24;
  var svgH=first20.length*rowH+40;
  var bars='';
  var statusColors={todo:'#64748b','in-progress':'#f59e0b',done:'#4ade80',blocked:'#ef4444'};
  first20.forEach(function(t,i){
    var due=new Date(t.due);
    var start=t.createdAt?new Date(t.createdAt):new Date(due.getTime()-86400000*3);
    var x1=40+Math.max(0,(start-minDate)/range)*(svgW-60);
    var x2=40+Math.max(0,(due-minDate)/range)*(svgW-60);
    var w=Math.max(x2-x1,8);
    var y=i*rowH+25;
    var c=statusColors[t.status]||'#64748b';
    bars+='<rect x="'+x1.toFixed(1)+'" y="'+y+'" width="'+w.toFixed(1)+'" height="16" rx="3" fill="'+c+'" opacity="0.8"/>';
    var label=(t.title||'').substring(0,20);
    bars+='<text x="'+(x1+4).toFixed(1)+'" y="'+(y+12)+'" fill="#fff" font-size="9" font-family="monospace">'+label+'</text>';
  });
  var d=document.createElement('div');d.id='task-gantt-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Task Gantt Chart</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    (first20.length?'<svg width="'+svgW+'" height="'+svgH+'" style="display:block;margin:0 auto">'+bars+'</svg>':
    '<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">Add tasks with due dates to see Gantt chart</div>');
  document.body.appendChild(d);
}
function showQuickCoinFlip(){
  var ex=document.getElementById('coin-flip-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='coin-flip-float';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:200px;text-align:center';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Coin Flip</span><button onclick="document.getElementById(\'coin-flip-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">x</button></div>'+
    '<div id="coin-result" style="font-size:36px;font-weight:700;color:#4ade80;margin-bottom:4px">?</div>'+
    '<div id="coin-stats" style="color:var(--text-muted);font-size:10px;margin-bottom:12px">Flip to start</div>'+
    '<button onclick="window._flipCoin()" style="background:#4ade80;color:#000;border:none;padding:8px 24px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;width:100%">Flip</button>';
  document.body.appendChild(d);
  var heads=0,tails=0;
  window._flipCoin=function(){
    var result=Math.random()<0.5?'Heads':'Tails';
    if(result==='Heads')heads++;else tails++;
    var el=document.getElementById('coin-result');
    if(el){el.textContent=result;el.style.color=result==='Heads'?'#4ade80':'#06b6d4';}
    var st=document.getElementById('coin-stats');
    if(st)st.textContent='H: '+heads+' | T: '+tails+' ('+Math.round(heads/(heads+tails)*100)+'% heads)';
  };
}
function showTransitionGen(){
  var ex=document.getElementById('transition-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='transition-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  var prop='all',dur=300,ease='ease',delay=0;
  function getCSS(){return 'transition: '+prop+' '+dur+'ms '+ease+(delay?' '+delay+'ms':'')+';\n-webkit-transition: '+prop+' '+dur+'ms '+ease+(delay?' '+delay+'ms':'')+';';}
  function render(){
    var code=d.querySelector('.trans-code');if(code)code.textContent=getCSS();
  }
  function sel(id,opts,val){
    var h='<select id="'+id+'" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;width:100%">';
    opts.forEach(function(o){h+='<option value="'+o+'"'+(o===val?' selected':'')+'>'+o+'</option>';});
    return h+'</select>';
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">CSS Transition Generator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="display:flex;justify-content:center;margin-bottom:16px"><div id="trans-preview" onmouseenter="this.style.transform=\'scale(1.2)\';this.style.background=\'#4ade80\'" onmouseleave="this.style.transform=\'scale(1)\';this.style.background=\'#06b6d4\'" style="width:80px;height:80px;background:#06b6d4;border-radius:12px;transition:'+prop+' '+dur+'ms '+ease+';cursor:pointer;display:flex;align-items:center;justify-content:center;color:#000;font-size:11px;font-weight:600">Hover me</div></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Property<br>'+sel('trans-prop',['all','transform','opacity','background','color','border','box-shadow','width','height'],prop)+'</label>'+
    '<label style="color:var(--text-muted);font-size:11px">Easing<br>'+sel('trans-ease',['ease','linear','ease-in','ease-out','ease-in-out','cubic-bezier(0.4,0,0.2,1)'],ease)+'</label>'+
    '<label style="color:var(--text-muted);font-size:11px">Duration (ms)<br><input type="range" min="50" max="2000" value="'+dur+'" id="trans-dur" style="width:100%"><span id="trans-dur-val" style="color:var(--text-primary);font-size:10px">'+dur+'ms</span></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Delay (ms)<br><input type="range" min="0" max="1000" value="'+delay+'" id="trans-delay" style="width:100%"><span id="trans-delay-val" style="color:var(--text-primary);font-size:10px">'+delay+'ms</span></label>'+
    '</div>'+
    '<pre class="trans-code" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:#4ade80;margin-bottom:10px;white-space:pre-wrap">'+getCSS()+'</pre>'+
    '<button id="trans-copy" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy CSS</button>';
  document.body.appendChild(d);
  function updatePreview(){
    var prev=document.getElementById('trans-preview');
    if(prev)prev.style.transition=prop+' '+dur+'ms '+ease+(delay?' '+delay+'ms':'');
  }
  d.querySelector('#trans-prop').onchange=function(e){prop=e.target.value;render();updatePreview();};
  d.querySelector('#trans-ease').onchange=function(e){ease=e.target.value;render();updatePreview();};
  d.querySelector('#trans-dur').oninput=function(e){dur=parseInt(e.target.value);document.getElementById('trans-dur-val').textContent=dur+'ms';render();updatePreview();};
  d.querySelector('#trans-delay').oninput=function(e){delay=parseInt(e.target.value);document.getElementById('trans-delay-val').textContent=delay+'ms';render();updatePreview();};
  d.querySelector('#trans-copy').onclick=function(){
    navigator.clipboard.writeText(getCSS());
    this.textContent='Copied!';var b=this;setTimeout(function(){b.textContent='Copy CSS';},800);
  };
}
function showTaskOverdueSummary(){
  var ex=document.getElementById('overdue-summary-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var now=new Date();var today=now.toISOString().split('T')[0];
  var overdue=tasks.filter(function(t){return t.due&&t.due<today&&t.status!=='done';});
  overdue.sort(function(a,b){return new Date(a.due)-new Date(b.due);});
  var byAge={'1-3 days':[],  '4-7 days':[], '1-2 weeks':[], '2+ weeks':[]};
  overdue.forEach(function(t){
    var diff=Math.floor((now-new Date(t.due))/86400000);
    if(diff<=3)byAge['1-3 days'].push(t);
    else if(diff<=7)byAge['4-7 days'].push(t);
    else if(diff<=14)byAge['1-2 weeks'].push(t);
    else byAge['2+ weeks'].push(t);
  });
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Overdue Tasks</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="text-align:center;margin-bottom:16px"><div style="font-size:36px;font-weight:700;color:'+(overdue.length?'#ef4444':'#4ade80')+'">'+overdue.length+'</div><div style="font-size:11px;color:var(--text-muted)">overdue tasks</div></div>';
  var ageColors={'1-3 days':'#f59e0b','4-7 days':'#f97316','1-2 weeks':'#ef4444','2+ weeks':'#dc2626'};
  Object.keys(byAge).forEach(function(bucket){
    if(!byAge[bucket].length)return;
    h+='<div style="margin-bottom:12px"><div style="font-size:11px;color:'+ageColors[bucket]+';font-weight:600;margin-bottom:4px">'+bucket+' ('+byAge[bucket].length+')</div>';
    byAge[bucket].forEach(function(t){
      h+='<div style="display:flex;justify-content:space-between;padding:4px 8px;background:var(--bg-surface);border-radius:4px;margin-bottom:3px;border-left:3px solid '+ageColors[bucket]+'">'+
        '<span style="color:var(--text-primary);font-size:12px">'+esc(t.title||'Untitled')+'</span>'+
        '<span style="color:var(--text-muted);font-size:10px">'+t.due+'</span></div>';
    });
    h+='</div>';
  });
  if(!overdue.length)h+='<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">No overdue tasks! You\'re on track.</div>';
  var d=document.createElement('div');d.id='overdue-summary-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickRoulette(){
  var ex=document.getElementById('roulette-float');if(ex){ex.remove();return;}
  if(!S._rouletteItems)S._rouletteItems=['Option A','Option B','Option C'];
  var d=document.createElement('div');d.id='roulette-float';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:260px';
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Roulette</span><button onclick="document.getElementById(\'roulette-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">x</button></div>';
    h+='<div id="roulette-result" style="text-align:center;font-size:18px;font-weight:700;color:#4ade80;padding:12px 0;margin-bottom:8px;background:var(--bg-surface);border-radius:8px">Spin to choose</div>';
    h+='<div style="margin-bottom:8px">';
    S._rouletteItems.forEach(function(item,i){
      h+='<div style="display:flex;gap:4px;margin-bottom:4px"><input value="'+esc(item)+'" onchange="S._rouletteItems['+i+']=this.value;save()" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:4px 6px;font-size:11px"><button onclick="S._rouletteItems.splice('+i+',1);save();window._rouletteRender()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">x</button></div>';
    });
    h+='</div>';
    h+='<div style="display:flex;gap:6px"><button onclick="S._rouletteItems.push(\'Option \'+(S._rouletteItems.length+1));save();window._rouletteRender()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;flex:1">+ Add</button><button onclick="window._rouletteSpin()" style="background:#4ade80;color:#000;border:none;padding:4px 14px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;flex:1">Spin</button></div>';
    d.innerHTML=h;
  }
  window._rouletteRender=rend;
  window._rouletteSpin=function(){
    if(!S._rouletteItems.length)return;
    var el=document.getElementById('roulette-result');if(!el)return;
    var count=0,total=15;
    var interval=setInterval(function(){
      var rand=S._rouletteItems[Math.floor(Math.random()*S._rouletteItems.length)];
      el.textContent=rand;
      el.style.color=count<total-1?'var(--text-muted)':'#4ade80';
      count++;
      if(count>=total)clearInterval(interval);
    },80);
  };
  document.body.appendChild(d);
  rend();
}
function showMediaQueryGen(){
  var ex=document.getElementById('mq-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='mq-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  var presets=[
    {name:'Mobile Small',query:'@media (max-width: 375px) { }',desc:'iPhone SE, small phones'},
    {name:'Mobile',query:'@media (max-width: 480px) { }',desc:'Standard phones'},
    {name:'Tablet Portrait',query:'@media (max-width: 768px) { }',desc:'iPad portrait, small tablets'},
    {name:'Tablet Landscape',query:'@media (max-width: 1024px) { }',desc:'iPad landscape, tablets'},
    {name:'Laptop',query:'@media (max-width: 1280px) { }',desc:'Small laptops'},
    {name:'Desktop',query:'@media (max-width: 1440px) { }',desc:'Standard desktops'},
    {name:'Large Desktop',query:'@media (min-width: 1441px) { }',desc:'Ultra-wide monitors'},
    {name:'Dark Mode',query:'@media (prefers-color-scheme: dark) { }',desc:'System dark mode preference'},
    {name:'Light Mode',query:'@media (prefers-color-scheme: light) { }',desc:'System light mode preference'},
    {name:'Reduced Motion',query:'@media (prefers-reduced-motion: reduce) { }',desc:'Accessibility: minimal animations'},
    {name:'Print',query:'@media print { }',desc:'Print stylesheet'},
    {name:'Retina/HiDPI',query:'@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) { }',desc:'High-DPI displays'}
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Media Query Presets</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  presets.forEach(function(p,i){
    h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-surface);border-radius:6px;margin-bottom:6px">'+
      '<div><div style="color:var(--text-primary);font-size:12px;font-weight:600">'+p.name+'</div><div style="color:var(--text-muted);font-size:10px">'+p.desc+'</div></div>'+
      '<button onclick="window._copyMQ('+i+')" style="background:#4ade80;color:#000;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600">Copy</button></div>';
  });
  d.innerHTML=h;
  window._copyMQ=function(i){
    navigator.clipboard.writeText(presets[i].query);
    var btns=d.querySelectorAll('button');
    var btn=btns[i+1];
    if(btn){btn.textContent='Copied!';setTimeout(function(){btn.textContent='Copy';},800);}
  };
  document.body.appendChild(d);
}
function showTaskCreatedVsDone(){
  var ex=document.getElementById('created-vs-done-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var dayMap={};
  tasks.forEach(function(t){
    var cd=t.createdAt?(t.createdAt.split('T')[0]):'';
    var dd=(t.status==='done'&&t.completedAt)?(t.completedAt.split('T')[0]):'';
    if(cd){if(!dayMap[cd])dayMap[cd]={created:0,done:0};dayMap[cd].created++;}
    if(dd){if(!dayMap[dd])dayMap[dd]={created:0,done:0};dayMap[dd].done++;}
  });
  var sorted=Object.keys(dayMap).sort();
  var last14=sorted.slice(-14);
  var maxV=0;
  last14.forEach(function(k){var dm=dayMap[k];var m=Math.max(dm.created,dm.done);if(m>maxV)maxV=m;});
  var svgW=400,svgH=150,barW=12;
  var bars='';
  last14.forEach(function(k,i){
    var dm=dayMap[k];
    var x=20+i*(barW*2+8);
    var ch=maxV?Math.round(dm.created/maxV*(svgH-40)):0;
    var dh=maxV?Math.round(dm.done/maxV*(svgH-40)):0;
    bars+='<rect x="'+x+'" y="'+(svgH-ch-20)+'" width="'+barW+'" height="'+ch+'" rx="2" fill="#3b82f6" opacity="0.8"/>';
    bars+='<rect x="'+(x+barW+2)+'" y="'+(svgH-dh-20)+'" width="'+barW+'" height="'+dh+'" rx="2" fill="#4ade80" opacity="0.8"/>';
    var label=k.substring(5);
    bars+='<text x="'+(x+barW)+'" y="'+(svgH-4)+'" text-anchor="middle" fill="var(--text-muted)" font-size="8">'+label+'</text>';
  });
  var totalCreated=0,totalDone=0;
  last14.forEach(function(k){totalCreated+=dayMap[k].created;totalDone+=dayMap[k].done;});
  var d=document.createElement('div');d.id='created-vs-done-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Created vs Done</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="display:flex;gap:16px;justify-content:center;margin-bottom:12px">'+
    '<div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:#3b82f6;border-radius:2px"></div><span style="color:var(--text-muted);font-size:11px">Created ('+totalCreated+')</span></div>'+
    '<div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:#4ade80;border-radius:2px"></div><span style="color:var(--text-muted);font-size:11px">Done ('+totalDone+')</span></div>'+
    '</div>'+
    '<svg width="'+svgW+'" height="'+svgH+'" style="display:block;margin:0 auto">'+bars+'</svg>'+
    (last14.length===0?'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">Create and complete tasks to see comparison</div>':'');
  document.body.appendChild(d);
}
function showQuickVote(){
  var ex=document.getElementById('vote-float');if(ex){ex.remove();return;}
  if(!S._voteTopics)S._voteTopics=[];
  var d=document.createElement('div');d.id='vote-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:80vh;overflow-y:auto';
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Quick Vote</span><button onclick="document.getElementById(\'vote-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
    h+='<div style="display:flex;gap:6px;margin-bottom:12px"><input id="vote-q" placeholder="Question..." style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:12px"><button onclick="window._voteAdd()" style="background:#4ade80;color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">+</button></div>';
    S._voteTopics.forEach(function(topic,ti){
      var total=0;topic.options.forEach(function(o){total+=o.votes;});
      h+='<div style="background:var(--bg-surface);border-radius:8px;padding:10px;margin-bottom:8px">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text-primary);font-size:12px;font-weight:600">'+esc(topic.question)+'</span><button onclick="S._voteTopics.splice('+ti+',1);save();window._voteRend()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px">x</button></div>';
      topic.options.forEach(function(o,oi){
        var pct=total?Math.round(o.votes/total*100):0;
        h+='<div style="margin-bottom:4px;cursor:pointer" onclick="S._voteTopics['+ti+'].options['+oi+'].votes++;save();window._voteRend()">'+
          '<div style="display:flex;justify-content:space-between;margin-bottom:2px"><span style="color:var(--text-muted);font-size:11px">'+esc(o.label)+'</span><span style="color:var(--text-muted);font-size:10px">'+o.votes+' ('+pct+'%)</span></div>'+
          '<div style="height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:#4ade80;border-radius:3px"></div></div></div>';
      });
      h+='<div style="margin-top:6px;display:flex;gap:4px"><input placeholder="Add option..." onkeydown="if(event.key===\'Enter\'){S._voteTopics['+ti+'].options.push({label:this.value,votes:0});save();window._voteRend()}" style="flex:1;background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px 6px;font-size:10px"></div>';
      h+='</div>';
    });
    if(!S._voteTopics.length)h+='<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">Add a question to start voting</div>';
    d.innerHTML=h;
  }
  window._voteAdd=function(){
    var q=document.getElementById('vote-q');if(!q||!q.value.trim())return;
    S._voteTopics.push({question:q.value.trim(),options:[{label:'Yes',votes:0},{label:'No',votes:0}]});
    save();rend();
  };
  window._voteRend=rend;
  document.body.appendChild(d);
  rend();
}
function showClampGen(){
  var ex=document.getElementById('clamp-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='clamp-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  var minPx=16,maxPx=32,minVw=320,maxVw=1440;
  function calc(){
    var slope=(maxPx-minPx)/(maxVw-minVw);
    var yInt=minPx-slope*minVw;
    var preferred=(yInt/16).toFixed(4)+'rem + '+(slope*100).toFixed(4)+'vw';
    return 'clamp('+(minPx/16).toFixed(3)+'rem, '+preferred+', '+(maxPx/16).toFixed(3)+'rem)';
  }
  function render(){
    var code=d.querySelector('.clamp-code');if(code)code.textContent='font-size: '+calc()+';';
    var preview=d.querySelector('.clamp-preview');if(preview)preview.style.fontSize=maxPx+'px';
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">CSS Clamp() Generator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div class="clamp-preview" style="font-size:'+maxPx+'px;color:#4ade80;text-align:center;margin-bottom:16px;font-weight:700;line-height:1.2">Fluid Text</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Min Font (px)<br><input type="number" min="8" max="100" value="'+minPx+'" id="clamp-min" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Max Font (px)<br><input type="number" min="8" max="200" value="'+maxPx+'" id="clamp-max" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Min Viewport (px)<br><input type="number" min="200" max="600" value="'+minVw+'" id="clamp-minvw" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Max Viewport (px)<br><input type="number" min="600" max="2560" value="'+maxVw+'" id="clamp-maxvw" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:11px;box-sizing:border-box"></label>'+
    '</div>'+
    '<div class="clamp-code" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:#4ade80;margin-bottom:10px;word-break:break-all">font-size: '+calc()+';</div>'+
    '<button id="clamp-copy" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy CSS</button>';
  document.body.appendChild(d);
  d.querySelector('#clamp-min').oninput=function(e){minPx=parseInt(e.target.value)||16;render();};
  d.querySelector('#clamp-max').oninput=function(e){maxPx=parseInt(e.target.value)||32;render();};
  d.querySelector('#clamp-minvw').oninput=function(e){minVw=parseInt(e.target.value)||320;render();};
  d.querySelector('#clamp-maxvw').oninput=function(e){maxVw=parseInt(e.target.value)||1440;render();};
  d.querySelector('#clamp-copy').onclick=function(){
    navigator.clipboard.writeText('font-size: '+calc()+';');
    this.textContent='Copied!';var b=this;setTimeout(function(){b.textContent='Copy CSS';},800);
  };
}
function showTaskProjectHeatmap(){
  var ex=document.getElementById('proj-heatmap-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var projects=(S.projects||[]);
  var statuses=['todo','in-progress','done','blocked'];
  var grid={};
  projects.forEach(function(p){
    grid[p.name]={};
    statuses.forEach(function(s){grid[p.name][s]=0;});
  });
  grid['No Project']={};statuses.forEach(function(s){grid['No Project'][s]=0;});
  tasks.forEach(function(t){
    var pn='No Project';
    if(t.project){
      var found=projects.find(function(p){return p.id===t.project||p.name===t.project;});
      if(found)pn=found.name;else pn=t.project;
    }
    if(!grid[pn]){grid[pn]={};statuses.forEach(function(s){grid[pn][s]=0;});}
    var st=t.status||'todo';
    if(grid[pn][st]!==undefined)grid[pn][st]++;
  });
  var maxVal=0;
  Object.keys(grid).forEach(function(p){statuses.forEach(function(s){if(grid[p][s]>maxVal)maxVal=grid[p][s];});});
  var statusColors={todo:'#64748b','in-progress':'#f59e0b',done:'#4ade80',blocked:'#ef4444'};
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Project x Status Heatmap</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="display:grid;grid-template-columns:120px repeat('+statuses.length+',1fr);gap:2px">';
  h+='<div></div>';
  statuses.forEach(function(s){h+='<div style="text-align:center;font-size:10px;color:var(--text-muted);padding:4px">'+s+'</div>';});
  Object.keys(grid).forEach(function(p){
    h+='<div style="font-size:11px;color:var(--text-primary);padding:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(p)+'</div>';
    statuses.forEach(function(s){
      var v=grid[p][s];
      var intensity=maxVal?Math.round(v/maxVal*100):0;
      var color=statusColors[s]||'#64748b';
      h+='<div style="text-align:center;padding:6px;background:'+color+';opacity:'+Math.max(0.15,intensity/100).toFixed(2)+';border-radius:3px;font-size:11px;color:#fff;font-weight:600">'+v+'</div>';
    });
  });
  h+='</div>';
  var d=document.createElement('div');d.id='proj-heatmap-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickBingo(){
  var ex=document.getElementById('bingo-float');if(ex){ex.remove();return;}
  if(!S._bingoCard)S._bingoCard=null;
  var d=document.createElement('div');d.id='bingo-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:380px;width:90vw;max-height:80vh;overflow-y:auto';
  function genCard(){
    var words=['Deploy','Bug fix','Meeting','Code review','Refactor','Coffee','Standup','Git push','Merge conflict','Test pass','Feature ship','Deadline','Hot fix','PR approved','Lunch break','Slack ping','API call','Console log','Breakpoint','Stack trace','404 error','LGTM','Ship it','Rollback','Sprint end'];
    var shuffled=words.sort(function(){return Math.random()-0.5;});
    var cells=[];
    for(var i=0;i<25;i++){cells.push({text:shuffled[i%words.length],marked:i===12});}
    cells[12]={text:'FREE',marked:true};
    return cells;
  }
  function rend(){
    if(!S._bingoCard)S._bingoCard=genCard();
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Dev Bingo</span><button onclick="document.getElementById(\'bingo-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
    h+='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:3px;margin-bottom:10px">';
    S._bingoCard.forEach(function(cell,i){
      h+='<div onclick="S._bingoCard['+i+'].marked=!S._bingoCard['+i+'].marked;save();window._bingoRend()" style="padding:8px 4px;text-align:center;font-size:10px;background:'+(cell.marked?'#4ade80':'var(--bg-surface)')+';color:'+(cell.marked?'#000':'var(--text-primary)')+';border-radius:4px;cursor:pointer;font-weight:'+(cell.marked?'700':'400')+';line-height:1.2;min-height:36px;display:flex;align-items:center;justify-content:center">'+cell.text+'</div>';
    });
    h+='</div>';
    h+='<button onclick="S._bingoCard=null;save();window._bingoRend()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:11px;width:100%">New Card</button>';
    d.innerHTML=h;
  }
  window._bingoRend=function(){
    if(!S._bingoCard)S._bingoCard=genCard();
    rend();
  };
  document.body.appendChild(d);
  rend();
}
function showFilterGen(){
  var ex=document.getElementById('filter-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='filter-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  var blur=0,brightness=100,contrast=100,saturate=100,hueRotate=0,grayscale=0,sepia=0,invert=0;
  function getCSS(){
    var parts=[];
    if(blur)parts.push('blur('+blur+'px)');
    if(brightness!==100)parts.push('brightness('+brightness+'%)');
    if(contrast!==100)parts.push('contrast('+contrast+'%)');
    if(saturate!==100)parts.push('saturate('+saturate+'%)');
    if(hueRotate)parts.push('hue-rotate('+hueRotate+'deg)');
    if(grayscale)parts.push('grayscale('+grayscale+'%)');
    if(sepia)parts.push('sepia('+sepia+'%)');
    if(invert)parts.push('invert('+invert+'%)');
    return parts.length?parts.join(' '):'none';
  }
  function render(){
    var prev=d.querySelector('.filter-preview');if(prev)prev.style.filter=getCSS();
    var code=d.querySelector('.filter-code');if(code)code.textContent='filter: '+getCSS()+';';
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">CSS Filter Generator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div class="filter-preview" style="height:100px;background:linear-gradient(135deg,#4ade80,#06b6d4,#a78bfa,#f59e0b);border-radius:8px;margin-bottom:12px"></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:10px">Blur ('+blur+'px)<br><input type="range" min="0" max="20" value="'+blur+'" id="f-blur" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Brightness ('+brightness+'%)<br><input type="range" min="0" max="300" value="'+brightness+'" id="f-bright" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Contrast ('+contrast+'%)<br><input type="range" min="0" max="300" value="'+contrast+'" id="f-contrast" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Saturate ('+saturate+'%)<br><input type="range" min="0" max="300" value="'+saturate+'" id="f-saturate" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Hue Rotate ('+hueRotate+'deg)<br><input type="range" min="0" max="360" value="'+hueRotate+'" id="f-hue" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Grayscale ('+grayscale+'%)<br><input type="range" min="0" max="100" value="'+grayscale+'" id="f-gray" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Sepia ('+sepia+'%)<br><input type="range" min="0" max="100" value="'+sepia+'" id="f-sepia" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Invert ('+invert+'%)<br><input type="range" min="0" max="100" value="'+invert+'" id="f-invert" style="width:100%"></label>'+
    '</div>'+
    '<div class="filter-code" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:#4ade80;margin-bottom:10px">filter: '+getCSS()+';</div>'+
    '<div style="display:flex;gap:8px"><button id="filter-copy" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy CSS</button>'+
    '<button id="filter-reset" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px">Reset</button></div>';
  document.body.appendChild(d);
  function updateLabel(id,val,unit){var lbl=d.querySelector('#'+id).parentElement;lbl.childNodes[0].textContent=lbl.childNodes[0].textContent.replace(/\(.*\)/,'('+val+unit+')');}
  d.querySelector('#f-blur').oninput=function(e){blur=parseInt(e.target.value);updateLabel('f-blur',blur,'px');render();};
  d.querySelector('#f-bright').oninput=function(e){brightness=parseInt(e.target.value);updateLabel('f-bright',brightness,'%');render();};
  d.querySelector('#f-contrast').oninput=function(e){contrast=parseInt(e.target.value);updateLabel('f-contrast',contrast,'%');render();};
  d.querySelector('#f-saturate').oninput=function(e){saturate=parseInt(e.target.value);updateLabel('f-saturate',saturate,'%');render();};
  d.querySelector('#f-hue').oninput=function(e){hueRotate=parseInt(e.target.value);updateLabel('f-hue',hueRotate,'deg');render();};
  d.querySelector('#f-gray').oninput=function(e){grayscale=parseInt(e.target.value);updateLabel('f-gray',grayscale,'%');render();};
  d.querySelector('#f-sepia').oninput=function(e){sepia=parseInt(e.target.value);updateLabel('f-sepia',sepia,'%');render();};
  d.querySelector('#f-invert').oninput=function(e){invert=parseInt(e.target.value);updateLabel('f-invert',invert,'%');render();};
  d.querySelector('#filter-copy').onclick=function(){
    navigator.clipboard.writeText('filter: '+getCSS()+';');
    this.textContent='Copied!';var b=this;setTimeout(function(){b.textContent='Copy CSS';},800);
  };
  d.querySelector('#filter-reset').onclick=function(){
    blur=0;brightness=100;contrast=100;saturate=100;hueRotate=0;grayscale=0;sepia=0;invert=0;
    d.querySelector('#f-blur').value=0;d.querySelector('#f-bright').value=100;
    d.querySelector('#f-contrast').value=100;d.querySelector('#f-saturate').value=100;
    d.querySelector('#f-hue').value=0;d.querySelector('#f-gray').value=0;
    d.querySelector('#f-sepia').value=0;d.querySelector('#f-invert').value=0;
    render();
  };
}
function showTaskProjectTimeline(){
  var ex=document.getElementById('proj-timeline-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var projects=(S.projects||[]);
  var projTasks={};
  projects.forEach(function(p){projTasks[p.name]=[];});
  projTasks['No Project']=[];
  tasks.forEach(function(t){
    if(t.status==='done'&&t.completedAt){
      var pn='No Project';
      if(t.project){var found=projects.find(function(p){return p.id===t.project||p.name===t.project;});if(found)pn=found.name;else pn=t.project;}
      if(!projTasks[pn])projTasks[pn]=[];
      projTasks[pn].push(t);
    }
  });
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Project Timeline</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  var colors=['#4ade80','#06b6d4','#a78bfa','#f59e0b','#ef4444','#ec4899','#64748b'];
  var ci=0;
  Object.keys(projTasks).forEach(function(pn){
    var ts=projTasks[pn];if(!ts.length)return;
    ts.sort(function(a,b){return new Date(a.completedAt)-new Date(b.completedAt);});
    var col=colors[ci%colors.length];ci++;
    h+='<div style="margin-bottom:12px"><div style="font-size:12px;font-weight:600;color:'+col+';margin-bottom:6px">'+esc(pn)+' ('+ts.length+' done)</div>';
    var last5=ts.slice(-5);
    last5.forEach(function(t){
      var d=t.completedAt?t.completedAt.split('T')[0]:'';
      h+='<div style="display:flex;gap:8px;align-items:center;padding:3px 0;padding-left:12px;border-left:2px solid '+col+'">'+
        '<span style="color:var(--text-muted);font-size:10px;min-width:70px">'+d+'</span>'+
        '<span style="color:var(--text-primary);font-size:11px">'+esc(t.title||'')+'</span></div>';
    });
    if(ts.length>5)h+='<div style="color:var(--text-muted);font-size:10px;padding-left:12px;border-left:2px solid '+col+'">'+(ts.length-5)+' more...</div>';
    h+='</div>';
  });
  if(!ci)h+='<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">Complete tasks to see project timeline</div>';
  var d=document.createElement('div');d.id='proj-timeline-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickSpinWheel(){
  var ex=document.getElementById('spin-wheel-float');if(ex){ex.remove();return;}
  if(!S._spinItems)S._spinItems=['Work','Break','Exercise','Read','Code'];
  var d=document.createElement('div');d.id='spin-wheel-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:340px;width:90vw;text-align:center';
  var colors=['#4ade80','#06b6d4','#a78bfa','#f59e0b','#ef4444','#ec4899','#3b82f6','#64748b'];
  function drawWheel(){
    var n=S._spinItems.length;if(!n)return '<div style="color:var(--text-muted);font-size:12px;padding:20px">Add items first</div>';
    var size=200,cx=size/2,cy=size/2,r=90;
    var svg='<svg width="'+size+'" height="'+size+'" style="display:block;margin:0 auto">';
    var slice=2*Math.PI/n;
    for(var i=0;i<n;i++){
      var a1=i*slice-Math.PI/2;
      var a2=(i+1)*slice-Math.PI/2;
      var x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
      var x2=cx+r*Math.cos(a2),y2=cy+r*Math.sin(a2);
      var large=slice>Math.PI?1:0;
      svg+='<path d="M'+cx+','+cy+' L'+x1.toFixed(1)+','+y1.toFixed(1)+' A'+r+','+r+' 0 '+large+',1 '+x2.toFixed(1)+','+y2.toFixed(1)+' Z" fill="'+colors[i%colors.length]+'" opacity="0.8"/>';
      var mid=(a1+a2)/2;
      var tx=cx+(r*0.6)*Math.cos(mid),ty=cy+(r*0.6)*Math.sin(mid);
      svg+='<text x="'+tx.toFixed(1)+'" y="'+ty.toFixed(1)+'" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="10" font-weight="600">'+esc(S._spinItems[i].substring(0,8))+'</text>';
    }
    svg+='<polygon points="'+cx+','+(cy-r-8)+' '+(cx-6)+','+(cy-r+4)+' '+(cx+6)+','+(cy-r+4)+'" fill="#fff"/>';
    svg+='</svg>';
    return svg;
  }
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Spin Wheel</span><button onclick="document.getElementById(\'spin-wheel-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
    h+='<div id="spin-result" style="font-size:20px;font-weight:700;color:#4ade80;margin-bottom:8px;min-height:28px"></div>';
    h+=drawWheel();
    h+='<button onclick="window._spinGo()" style="background:#4ade80;color:#000;border:none;padding:8px 24px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;width:100%;margin:10px 0">SPIN</button>';
    h+='<div style="display:flex;gap:4px;margin-top:8px"><input id="spin-add" placeholder="Add item..." style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:4px 6px;font-size:11px"><button onclick="var i=document.getElementById(\'spin-add\');if(i&&i.value.trim()){S._spinItems.push(i.value.trim());save();window._spinRend();}" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px">+</button></div>';
    d.innerHTML=h;
  }
  window._spinRend=rend;
  window._spinGo=function(){
    if(!S._spinItems.length)return;
    var el=document.getElementById('spin-result');if(!el)return;
    var count=0,total=20;
    var interval=setInterval(function(){
      el.textContent=S._spinItems[Math.floor(Math.random()*S._spinItems.length)];
      el.style.color='var(--text-muted)';
      count++;
      if(count>=total){
        clearInterval(interval);
        var winner=S._spinItems[Math.floor(Math.random()*S._spinItems.length)];
        el.textContent=winner;
        el.style.color='#4ade80';
      }
    },80);
  };
  document.body.appendChild(d);
  rend();
}
function showTextShadowGen(){
  var ex=document.getElementById('textshadow-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='textshadow-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  var x=2,y=2,blur=4,color='#4ade80',opacity=80;
  function getCSS(){
    var r=parseInt(color.substring(1,3),16),g=parseInt(color.substring(3,5),16),b=parseInt(color.substring(5,7),16);
    return 'text-shadow: '+x+'px '+y+'px '+blur+'px rgba('+r+','+g+','+b+','+(opacity/100).toFixed(2)+');';
  }
  function render(){
    var prev=d.querySelector('.ts-preview');
    if(prev){var r=parseInt(color.substring(1,3),16),g=parseInt(color.substring(3,5),16),b=parseInt(color.substring(5,7),16);
      prev.style.textShadow=x+'px '+y+'px '+blur+'px rgba('+r+','+g+','+b+','+(opacity/100)+')';}
    var code=d.querySelector('.ts-code');if(code)code.textContent=getCSS();
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Text Shadow Generator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div class="ts-preview" style="text-align:center;font-size:36px;font-weight:700;color:var(--text-primary);margin-bottom:16px;text-shadow:'+x+'px '+y+'px '+blur+'px '+color+'">Shadow Text</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:10px">X Offset<br><input type="range" min="-20" max="20" value="'+x+'" id="ts-x" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Y Offset<br><input type="range" min="-20" max="20" value="'+y+'" id="ts-y" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Blur<br><input type="range" min="0" max="40" value="'+blur+'" id="ts-blur" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Opacity<br><input type="range" min="0" max="100" value="'+opacity+'" id="ts-opacity" style="width:100%"></label>'+
    '<label style="color:var(--text-muted);font-size:10px">Color<br><input type="color" value="'+color+'" id="ts-color" style="width:60px;height:26px;border:none;cursor:pointer"></label>'+
    '</div>'+
    '<div class="ts-code" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:#4ade80;margin-bottom:10px">'+getCSS()+'</div>'+
    '<button id="ts-copy" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy CSS</button>';
  document.body.appendChild(d);
  d.querySelector('#ts-x').oninput=function(e){x=parseInt(e.target.value);render();};
  d.querySelector('#ts-y').oninput=function(e){y=parseInt(e.target.value);render();};
  d.querySelector('#ts-blur').oninput=function(e){blur=parseInt(e.target.value);render();};
  d.querySelector('#ts-opacity').oninput=function(e){opacity=parseInt(e.target.value);render();};
  d.querySelector('#ts-color').oninput=function(e){color=e.target.value;render();};
  d.querySelector('#ts-copy').onclick=function(){
    navigator.clipboard.writeText(getCSS());
    this.textContent='Copied!';var b=this;setTimeout(function(){b.textContent='Copy CSS';},800);
  };
}
function showTaskStreakCalendar(){
  var ex=document.getElementById('streak-cal-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var daySet={};
  tasks.forEach(function(t){
    if(t.status==='done'&&t.completedAt){
      var d=t.completedAt.split('T')[0];
      daySet[d]=(daySet[d]||0)+1;
    }
  });
  var today=new Date();
  var streak=0;
  var dt=new Date(today);
  for(var i=0;i<365;i++){
    var key=dt.toISOString().split('T')[0];
    if(daySet[key])streak++;else break;
    dt.setDate(dt.getDate()-1);
  }
  var cells='';
  var startDate=new Date(today);startDate.setDate(startDate.getDate()-83);
  for(var i=0;i<84;i++){
    var d=new Date(startDate);d.setDate(d.getDate()+i);
    var key=d.toISOString().split('T')[0];
    var count=daySet[key]||0;
    var intensity=count===0?'0':count>=4?'1':count>=2?'0.6':'0.3';
    cells+='<div title="'+key+': '+count+' tasks" style="width:10px;height:10px;border-radius:2px;background:'+(count?'#4ade80':'var(--bg-surface)')+';opacity:'+(count?intensity:'1')+'"></div>';
  }
  var d=document.createElement('div');d.id='streak-cal-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Task Streak Calendar</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="text-align:center;margin-bottom:16px"><span style="font-size:36px;font-weight:700;color:#4ade80">'+streak+'</span><span style="color:var(--text-muted);font-size:12px;margin-left:6px">day streak</span></div>'+
    '<div style="display:grid;grid-template-columns:repeat(12,1fr);gap:2px;margin-bottom:12px">'+cells+'</div>'+
    '<div style="display:flex;justify-content:space-between;color:var(--text-muted);font-size:10px"><span>12 weeks ago</span><span>Today</span></div>';
  document.body.appendChild(d);
}
function showQuickTarot(){
  var ex=document.getElementById('tarot-float');if(ex){ex.remove();return;}
  var cards=['The Fool','The Magician','The High Priestess','The Empress','The Emperor','The Hierophant','The Lovers','The Chariot','Strength','The Hermit','Wheel of Fortune','Justice','The Hanged Man','Death','Temperance','The Devil','The Tower','The Star','The Moon','The Sun','Judgement','The World'];
  var meanings=['New beginnings, spontaneity','Manifestation, resourcefulness','Intuition, inner knowledge','Abundance, nurturing','Authority, structure','Tradition, guidance','Love, harmony, choices','Determination, willpower','Courage, inner strength','Soul-searching, introspection','Change, cycles, fate','Fairness, truth, cause and effect','Surrender, new perspectives','Transformation, endings','Balance, patience, moderation','Shadow self, attachment','Sudden change, upheaval','Hope, inspiration, serenity','Illusion, fear, subconscious','Joy, success, vitality','Reflection, reckoning','Completion, accomplishment'];
  var idx=Math.floor(Math.random()*cards.length);
  var d=document.createElement('div');d.id='tarot-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:30px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:320px;width:90vw;text-align:center';
  function rend(){
    d.innerHTML='<div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px">Daily Draw</div>'+
      '<div style="width:120px;height:180px;border:2px solid #4ade80;border-radius:12px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(74,222,128,0.1),rgba(6,182,212,0.1))">'+
      '<div style="font-size:14px;color:#4ade80;font-weight:600;padding:10px;line-height:1.3">'+cards[idx]+'</div></div>'+
      '<div style="font-size:18px;font-weight:700;color:var(--text-primary);margin-bottom:8px">'+cards[idx]+'</div>'+
      '<div style="font-size:13px;color:var(--text-muted);margin-bottom:20px;font-style:italic">'+meanings[idx]+'</div>'+
      '<button onclick="window._tarotDraw()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:8px 20px;border-radius:6px;cursor:pointer;font-size:12px;margin-right:8px">Draw Again</button>'+
      '<button onclick="document.getElementById(\'tarot-float\').remove()" style="background:#4ade80;color:#000;border:none;padding:8px 20px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Close</button>';
  }
  window._tarotDraw=function(){idx=Math.floor(Math.random()*cards.length);rend();};
  document.body.appendChild(d);
  rend();
}
function showVariableGen(){
  var ex=document.getElementById('var-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='var-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  var themes=[
    {name:'Dark Theme',vars:{'--bg-primary':'#0a0a0a','--bg-secondary':'#1a1a1a','--bg-surface':'#242424','--text-primary':'#e5e5e5','--text-secondary':'#a3a3a3','--accent':'#4ade80','--border':'#333333'}},
    {name:'Ocean Dark',vars:{'--bg-primary':'#050711','--bg-secondary':'#0d1117','--bg-surface':'#161b22','--text-primary':'#e6edf3','--text-secondary':'#8b949e','--accent':'#06b6d4','--border':'#30363d'}},
    {name:'Warm Dark',vars:{'--bg-primary':'#1c1410','--bg-secondary':'#27211c','--bg-surface':'#322b26','--text-primary':'#ede0d4','--text-secondary':'#b7a99a','--accent':'#f59e0b','--border':'#443d37'}},
    {name:'Purple Night',vars:{'--bg-primary':'#0f0a1a','--bg-secondary':'#1a1225','--bg-surface':'#251b33','--text-primary':'#e8e0f0','--text-secondary':'#a898be','--accent':'#a78bfa','--border':'#362b4a'}}
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">CSS Variable Themes</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  themes.forEach(function(t,ti){
    h+='<div style="background:var(--bg-surface);border-radius:8px;padding:12px;margin-bottom:10px">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'+
      '<span style="color:var(--text-primary);font-size:13px;font-weight:600">'+t.name+'</span>'+
      '<button onclick="window._copyTheme('+ti+')" style="background:#4ade80;color:#000;border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600">Copy</button></div>'+
      '<div style="display:flex;gap:4px;margin-bottom:8px">';
    Object.values(t.vars).forEach(function(v){h+='<div style="width:24px;height:24px;border-radius:4px;background:'+v+';border:1px solid rgba(255,255,255,0.1)"></div>';});
    h+='</div><pre style="font-family:monospace;font-size:10px;color:#4ade80;margin:0;white-space:pre-wrap">:root {\n';
    Object.keys(t.vars).forEach(function(k){h+='  '+k+': '+t.vars[k]+';\n';});
    h+='}</pre></div>';
  });
  d.innerHTML=h;
  window._copyTheme=function(ti){
    var t=themes[ti];var css=':root {\n';
    Object.keys(t.vars).forEach(function(k){css+='  '+k+': '+t.vars[k]+';\n';});
    css+='}';
    navigator.clipboard.writeText(css);
    var btns=d.querySelectorAll('button');
    var btn=btns[ti+1];
    if(btn){btn.textContent='Copied!';setTimeout(function(){btn.textContent='Copy';},800);}
  };
  document.body.appendChild(d);
}
function showTaskCycleTime(){
  var ex=document.getElementById('cycle-time-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var cycles=[];
  tasks.forEach(function(t){
    if(t.status==='done'&&t.completedAt&&t.createdAt){
      var created=new Date(t.createdAt);
      var completed=new Date(t.completedAt);
      var days=Math.round((completed-created)/86400000);
      if(days>=0)cycles.push({title:t.title,days:days,priority:t.priority||'p3'});
    }
  });
  cycles.sort(function(a,b){return b.days-a.days;});
  var avgDays=0;cycles.forEach(function(c){avgDays+=c.days;});
  avgDays=cycles.length?Math.round(avgDays/cycles.length*10)/10:0;
  var medianDays=0;
  if(cycles.length){var sorted=cycles.map(function(c){return c.days;}).sort(function(a,b){return a-b;});medianDays=sorted[Math.floor(sorted.length/2)];}
  var byBucket={'Same day':0,'1-3 days':0,'4-7 days':0,'1-2 weeks':0,'2+ weeks':0};
  cycles.forEach(function(c){
    if(c.days===0)byBucket['Same day']++;
    else if(c.days<=3)byBucket['1-3 days']++;
    else if(c.days<=7)byBucket['4-7 days']++;
    else if(c.days<=14)byBucket['1-2 weeks']++;
    else byBucket['2+ weeks']++;
  });
  var maxBucket=0;Object.values(byBucket).forEach(function(v){if(v>maxBucket)maxBucket=v;});
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Task Cycle Time</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="display:flex;justify-content:space-around;margin-bottom:16px">'+
    '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:#4ade80">'+avgDays+'d</div><div style="font-size:10px;color:var(--text-muted)">Avg Cycle</div></div>'+
    '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:#06b6d4">'+medianDays+'d</div><div style="font-size:10px;color:var(--text-muted)">Median</div></div>'+
    '<div style="text-align:center"><div style="font-size:28px;font-weight:700;color:var(--text-primary)">'+cycles.length+'</div><div style="font-size:10px;color:var(--text-muted)">Tasks</div></div></div>';
  h+='<div style="font-size:11px;color:var(--text-muted);font-weight:600;margin-bottom:6px">Distribution</div>';
  Object.keys(byBucket).forEach(function(b){
    var v=byBucket[b];
    var pct=maxBucket?Math.round(v/maxBucket*100):0;
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">'+
      '<span style="color:var(--text-muted);font-size:10px;min-width:70px">'+b+'</span>'+
      '<div style="flex:1;height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:#4ade80;border-radius:4px"></div></div>'+
      '<span style="color:var(--text-muted);font-size:10px;min-width:20px;text-align:right">'+v+'</span></div>';
  });
  if(cycles.length){
    h+='<div style="font-size:11px;color:var(--text-muted);font-weight:600;margin:12px 0 6px">Slowest Tasks</div>';
    cycles.slice(0,5).forEach(function(c){
      h+='<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)">'+
        '<span style="color:var(--text-primary);font-size:11px">'+esc((c.title||'').substring(0,30))+'</span>'+
        '<span style="color:var(--text-muted);font-size:10px">'+c.days+'d</span></div>';
    });
  }
  var d=document.createElement('div');d.id='cycle-time-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickMotivation(){
  var ex=document.getElementById('motivation-float');if(ex){ex.remove();return;}
  var quotes=[
    {text:'The only way to do great work is to love what you do.',author:'Steve Jobs'},
    {text:'It does not matter how slowly you go as long as you do not stop.',author:'Confucius'},
    {text:'What you get by achieving your goals is not as important as what you become.',author:'Zig Ziglar'},
    {text:'The future belongs to those who believe in the beauty of their dreams.',author:'Eleanor Roosevelt'},
    {text:'Success is not final, failure is not fatal: it is the courage to continue that counts.',author:'Winston Churchill'},
    {text:'The best time to plant a tree was 20 years ago. The second best time is now.',author:'Chinese Proverb'},
    {text:'Do what you can, with what you have, where you are.',author:'Theodore Roosevelt'},
    {text:'Everything you have ever wanted is on the other side of fear.',author:'George Addair'},
    {text:'The only limit to our realization of tomorrow is our doubts of today.',author:'FDR'},
    {text:'Believe you can and you are halfway there.',author:'Theodore Roosevelt'},
    {text:'Act as if what you do makes a difference. It does.',author:'William James'},
    {text:'You miss 100% of the shots you do not take.',author:'Wayne Gretzky'},
    {text:'Ship it.',author:'Every Great Developer'}
  ];
  var idx=Math.floor(Math.random()*quotes.length);
  var q=quotes[idx];
  var d=document.createElement('div');d.id='motivation-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:40px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;text-align:center';
  function rend(){
    q=quotes[idx];
    d.innerHTML='<div style="font-size:20px;color:var(--text-primary);line-height:1.6;font-weight:300;margin-bottom:16px;font-style:italic">"'+q.text+'"</div>'+
      '<div style="font-size:13px;color:#4ade80;margin-bottom:24px">- '+q.author+'</div>'+
      '<button onclick="window._nextQuote()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:8px 20px;border-radius:6px;cursor:pointer;font-size:12px;margin-right:8px">Next</button>'+
      '<button onclick="document.getElementById(\'motivation-float\').remove()" style="background:#4ade80;color:#000;border:none;padding:8px 20px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Go Ship!</button>';
  }
  window._nextQuote=function(){idx=(idx+1)%quotes.length;rend();};
  document.body.appendChild(d);
  rend();
}
function showClipPathGen(){
  var ex=document.getElementById('clippath-gen-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='clippath-gen-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  var presets=[
    {name:'Triangle',css:'polygon(50% 0%, 0% 100%, 100% 100%)'},
    {name:'Trapezoid',css:'polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%)'},
    {name:'Parallelogram',css:'polygon(25% 0%, 100% 0%, 75% 100%, 0% 100%)'},
    {name:'Rhombus',css:'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)'},
    {name:'Pentagon',css:'polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%)'},
    {name:'Hexagon',css:'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)'},
    {name:'Octagon',css:'polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%)'},
    {name:'Star',css:'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)'},
    {name:'Arrow Right',css:'polygon(0% 20%, 60% 20%, 60% 0%, 100% 50%, 60% 100%, 60% 80%, 0% 80%)'},
    {name:'Circle',css:'circle(50% at 50% 50%)'},
    {name:'Ellipse',css:'ellipse(50% 35% at 50% 50%)'},
    {name:'Inset',css:'inset(10% 10% 10% 10% round 10px)'}
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Clip-Path Presets</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">';
  presets.forEach(function(p,i){
    h+='<div onclick="window._copyClip('+i+')" style="cursor:pointer;text-align:center;padding:12px 8px;background:var(--bg-surface);border-radius:8px">'+
      '<div style="width:60px;height:60px;background:linear-gradient(135deg,#4ade80,#06b6d4);clip-path:'+p.css+';margin:0 auto 6px"></div>'+
      '<div style="font-size:10px;color:var(--text-primary)">'+p.name+'</div>'+
      '</div>';
  });
  h+='</div>';
  h+='<div id="clip-output" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:#4ade80;min-height:20px">Click a shape to copy</div>';
  d.innerHTML=h;
  window._copyClip=function(i){
    var css='clip-path: '+presets[i].css+';';
    navigator.clipboard.writeText(css);
    var out=document.getElementById('clip-output');
    if(out)out.textContent='Copied: '+css;
  };
  document.body.appendChild(d);
}
function showTaskParetoChart(){
  var ex=document.getElementById('pareto-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var byProject={};
  tasks.forEach(function(t){
    var p=t.project||'No Project';
    if(t.project){var found=(S.projects||[]).find(function(pr){return pr.id===t.project||pr.name===t.project;});if(found)p=found.name;}
    byProject[p]=(byProject[p]||0)+1;
  });
  var sorted=Object.entries(byProject).sort(function(a,b){return b[1]-a[1];});
  var total=tasks.length||1;
  var cumulative=0;
  var svgW=380,svgH=160,barW=sorted.length?Math.min(40,Math.floor((svgW-40)/sorted.length)):40;
  var maxVal=sorted.length?sorted[0][1]:1;
  var bars='',line='';
  sorted.forEach(function(entry,i){
    var name=entry[0],count=entry[1];
    cumulative+=count;
    var pct=Math.round(cumulative/total*100);
    var bh=Math.round(count/maxVal*(svgH-40));
    var x=20+i*(barW+4);
    bars+='<rect x="'+x+'" y="'+(svgH-bh-20)+'" width="'+barW+'" height="'+bh+'" rx="3" fill="#4ade80" opacity="0.8"/>';
    bars+='<text x="'+(x+barW/2)+'" y="'+(svgH-bh-24)+'" text-anchor="middle" fill="var(--text-muted)" font-size="9">'+count+'</text>';
    var ly=20+(1-pct/100)*(svgH-40);
    line+=(i===0?'M':'L')+(x+barW/2).toFixed(1)+','+ly.toFixed(1);
  });
  if(line)line='<path d="'+line+'" stroke="#ef4444" stroke-width="2" fill="none"/>';
  var d=document.createElement('div');d.id='pareto-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Task Pareto Chart</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="display:flex;gap:12px;justify-content:center;margin-bottom:8px">'+
    '<div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:#4ade80;border-radius:2px"></div><span style="font-size:10px;color:var(--text-muted)">Task Count</span></div>'+
    '<div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:2px;background:#ef4444"></div><span style="font-size:10px;color:var(--text-muted)">Cumulative %</span></div></div>'+
    '<svg width="'+svgW+'" height="'+svgH+'" style="display:block;margin:0 auto">'+bars+line+'</svg>'+
    (sorted.length===0?'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">Add tasks with projects to see Pareto chart</div>':'');
  document.body.appendChild(d);
}
function showQuickBreathwork(){
  var ex=document.getElementById('breathwork-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='breathwork-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:30px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:340px;width:90vw;text-align:center';
  var phase='ready',timer=null,count=0;
  var patterns=[
    {name:'Box Breathing',steps:[{text:'Breathe In',dur:4},{text:'Hold',dur:4},{text:'Breathe Out',dur:4},{text:'Hold',dur:4}]},
    {name:'4-7-8 Relaxing',steps:[{text:'Breathe In',dur:4},{text:'Hold',dur:7},{text:'Breathe Out',dur:8}]},
    {name:'Energizing',steps:[{text:'Quick In',dur:2},{text:'Quick Out',dur:2}]}
  ];
  var patIdx=0,stepIdx=0,secLeft=0,cycles=0;
  function rend(){
    var p=patterns[patIdx];
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Breathwork</span><button onclick="window._bwStop();document.getElementById(\'breathwork-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
    if(phase==='ready'){
      h+='<div style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Choose a pattern</div>';
      patterns.forEach(function(pat,i){
        h+='<button onclick="window._bwStart('+i+')" style="display:block;width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:10px;border-radius:8px;cursor:pointer;font-size:13px;margin-bottom:8px;text-align:left"><strong>'+pat.name+'</strong><br><span style="font-size:11px;color:var(--text-muted)">'+pat.steps.map(function(s){return s.text+' ('+s.dur+'s)';}).join(' > ')+'</span></button>';
      });
    } else {
      var step=p.steps[stepIdx];
      var size=60+Math.round((1-secLeft/step.dur)*40);
      h+='<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">'+p.name+' - Cycle '+(cycles+1)+'</div>';
      h+='<div style="width:'+size+'px;height:'+size+'px;border-radius:50%;background:rgba(74,222,128,0.2);border:2px solid #4ade80;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;transition:all 0.5s ease"><div style="font-size:24px;font-weight:700;color:#4ade80">'+secLeft+'</div></div>';
      h+='<div style="font-size:18px;color:var(--text-primary);margin-bottom:16px;font-weight:600">'+step.text+'</div>';
      h+='<button onclick="window._bwStop()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px 20px;border-radius:6px;cursor:pointer;font-size:12px">Stop</button>';
    }
    d.innerHTML=h;
  }
  window._bwStart=function(i){
    patIdx=i;stepIdx=0;cycles=0;
    var p=patterns[patIdx];secLeft=p.steps[0].dur;
    phase='active';rend();
    timer=setInterval(function(){
      secLeft--;
      if(secLeft<=0){
        stepIdx++;
        if(stepIdx>=p.steps.length){stepIdx=0;cycles++;}
        secLeft=p.steps[stepIdx].dur;
      }
      rend();
    },1000);
  };
  window._bwStop=function(){
    if(timer)clearInterval(timer);timer=null;
    phase='ready';rend();
  };
  document.body.appendChild(d);
  rend();
}
function showAspectRatioCalc(){
  var ex=document.getElementById('aspect-ratio-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='aspect-ratio-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:80vh;overflow-y:auto';
  var w=1920,h=1080;
  function gcd(a,b){return b?gcd(b,a%b):a;}
  function calc(){var g=gcd(w,h);return(w/g)+':'+(h/g);}
  var presets=[
    {label:'16:9 (1920x1080)',w:1920,h:1080},
    {label:'4:3 (1024x768)',w:1024,h:768},
    {label:'1:1 (1080x1080)',w:1080,h:1080},
    {label:'21:9 (2560x1080)',w:2560,h:1080},
    {label:'9:16 (1080x1920)',w:1080,h:1920},
    {label:'3:2 (1440x960)',w:1440,h:960}
  ];
  function render(){
    var ratio=calc();
    var el=d.querySelector('.ar-result');if(el)el.textContent=ratio;
    var css=d.querySelector('.ar-css');if(css)css.textContent='aspect-ratio: '+ratio+'; /* '+w+' x '+h+' */';
    var prev=d.querySelector('.ar-preview');
    if(prev){var scale=Math.min(160/w,100/h);prev.style.width=Math.round(w*scale)+'px';prev.style.height=Math.round(h*scale)+'px';}
  }
  var ph='';
  presets.forEach(function(p,i){
    ph+='<button onclick="window._arPreset('+i+')" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px">'+p.label+'</button>';
  });
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Aspect Ratio Calculator</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="text-align:center;margin-bottom:12px"><div class="ar-preview" style="width:160px;height:90px;background:linear-gradient(135deg,#4ade80,#06b6d4);border-radius:6px;margin:0 auto 8px;transition:all 0.3s ease"></div><div class="ar-result" style="font-size:28px;font-weight:700;color:#4ade80">'+calc()+'</div></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Width<br><input type="number" value="'+w+'" id="ar-w" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:4px;font-size:12px;box-sizing:border-box"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Height<br><input type="number" value="'+h+'" id="ar-h" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:4px;font-size:12px;box-sizing:border-box"></label></div>'+
    '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">'+ph+'</div>'+
    '<div class="ar-css" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:#4ade80;margin-bottom:10px;cursor:pointer" onclick="navigator.clipboard.writeText(this.textContent)">aspect-ratio: '+calc()+'; /* '+w+' x '+h+' */</div>';
  document.body.appendChild(d);
  d.querySelector('#ar-w').oninput=function(e){w=parseInt(e.target.value)||1;render();};
  d.querySelector('#ar-h').oninput=function(e){h=parseInt(e.target.value)||1;render();};
  window._arPreset=function(i){
    w=presets[i].w;h=presets[i].h;
    d.querySelector('#ar-w').value=w;d.querySelector('#ar-h').value=h;
    render();
  };
}
function showTaskDueDateAnalysis(){
  var ex=document.getElementById('due-analysis-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]).filter(function(t){return t.status!=='done';});
  var today=new Date().toISOString().split('T')[0];
  var noDate=[],overdue=[],thisWeek=[],nextWeek=[],later=[];
  var now=new Date();
  var weekEnd=new Date(now);weekEnd.setDate(weekEnd.getDate()+(7-weekEnd.getDay()));
  var nextWeekEnd=new Date(weekEnd);nextWeekEnd.setDate(nextWeekEnd.getDate()+7);
  tasks.forEach(function(t){
    if(!t.due){noDate.push(t);return;}
    if(t.due<today)overdue.push(t);
    else if(new Date(t.due)<=weekEnd)thisWeek.push(t);
    else if(new Date(t.due)<=nextWeekEnd)nextWeek.push(t);
    else later.push(t);
  });
  var groups=[
    {name:'Overdue',items:overdue,color:'#ef4444'},
    {name:'This Week',items:thisWeek,color:'#f59e0b'},
    {name:'Next Week',items:nextWeek,color:'#3b82f6'},
    {name:'Later',items:later,color:'#4ade80'},
    {name:'No Due Date',items:noDate,color:'#64748b'}
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Due Date Analysis</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">';
  groups.forEach(function(g){
    h+='<div style="flex:1;min-width:60px;text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px;border-top:3px solid '+g.color+'">'+
      '<div style="font-size:20px;font-weight:700;color:'+g.color+'">'+g.items.length+'</div>'+
      '<div style="font-size:9px;color:var(--text-muted)">'+g.name+'</div></div>';
  });
  h+='</div>';
  groups.forEach(function(g){
    if(!g.items.length)return;
    h+='<div style="margin-bottom:8px"><div style="font-size:11px;color:'+g.color+';font-weight:600;margin-bottom:4px">'+g.name+'</div>';
    g.items.slice(0,5).forEach(function(t){
      h+='<div style="display:flex;justify-content:space-between;padding:3px 8px;background:var(--bg-surface);border-radius:4px;margin-bottom:2px">'+
        '<span style="color:var(--text-primary);font-size:11px">'+esc((t.title||'').substring(0,30))+'</span>'+
        '<span style="color:var(--text-muted);font-size:10px">'+(t.due||'none')+'</span></div>';
    });
    if(g.items.length>5)h+='<div style="color:var(--text-muted);font-size:10px;padding-left:8px">+'+(g.items.length-5)+' more</div>';
    h+='</div>';
  });
  var d=document.createElement('div');d.id='due-analysis-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickMeditationTimer(){
  var ex=document.getElementById('meditation-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='meditation-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:30px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:320px;width:90vw;text-align:center';
  var totalSec=300,remaining=300,running=false,timer=null;
  function fmt(s){return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
  function rend(){
    var pct=totalSec?Math.round(remaining/totalSec*100):0;
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span style="font-weight:600;color:var(--text-primary)">Meditation</span><button onclick="window._medStop();document.getElementById(\'meditation-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
    h+='<div style="width:140px;height:140px;border-radius:50%;border:3px solid var(--border);margin:0 auto 16px;display:flex;align-items:center;justify-content:center;position:relative;background:conic-gradient(#4ade80 '+(100-pct)+'%,transparent 0)">';
    h+='<div style="width:126px;height:126px;border-radius:50%;background:var(--bg-elevated);display:flex;align-items:center;justify-content:center;flex-direction:column">';
    h+='<div style="font-size:32px;font-weight:700;color:var(--text-primary)">'+fmt(remaining)+'</div>';
    h+='<div style="font-size:10px;color:var(--text-muted)">'+(running?'Focus':'Ready')+'</div>';
    h+='</div></div>';
    if(!running){
      h+='<div style="display:flex;gap:6px;justify-content:center;margin-bottom:12px">';
      [3,5,10,15,20].forEach(function(m){
        h+='<button onclick="window._medSet('+m+')" style="background:'+(totalSec===m*60?'#4ade80':'var(--bg-surface)')+';color:'+(totalSec===m*60?'#000':'var(--text-primary)')+';border:1px solid var(--border);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:'+(totalSec===m*60?'600':'400')+'">'+m+'m</button>';
      });
      h+='</div>';
      h+='<button onclick="window._medStart()" style="background:#4ade80;color:#000;border:none;padding:10px 32px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600">Begin</button>';
    } else {
      h+='<button onclick="window._medStop()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:8px 24px;border-radius:6px;cursor:pointer;font-size:12px">Pause</button>';
    }
    d.innerHTML=h;
  }
  window._medSet=function(m){totalSec=m*60;remaining=totalSec;rend();};
  window._medStart=function(){
    running=true;rend();
    timer=setInterval(function(){
      remaining--;
      if(remaining<=0){clearInterval(timer);timer=null;running=false;remaining=0;}
      rend();
    },1000);
  };
  window._medStop=function(){
    if(timer)clearInterval(timer);timer=null;running=false;rend();
  };
  document.body.appendChild(d);
  rend();
}
function showSvgIconBrowser(){
  var ex=document.getElementById('svg-icon-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='svg-icon-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  var icons=[
    {name:'Check',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>'},
    {name:'X',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'},
    {name:'Plus',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>'},
    {name:'Minus',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>'},
    {name:'Arrow Right',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12,5 19,12 12,19"/></svg>'},
    {name:'Arrow Left',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg>'},
    {name:'Home',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3,9 L12,2 L21,9 V20 A1,1 0 0,1 20,21 H4 A1,1 0 0,1 3,20 Z"/></svg>'},
    {name:'Search',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>'},
    {name:'Star',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>'},
    {name:'Heart',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84,4.61a5.5,5.5 0 0,0-7.78,0L12,5.67 10.94,4.61a5.5,5.5 0 0,0-7.78,7.78L12,21.35l8.84-8.96a5.5,5.5 0 0,0,0-7.78Z"/></svg>'},
    {name:'Settings',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4,15a1.65,1.65 0 0,0,.33,1.82l.06,.06a2,2 0 0,1-2.83,2.83l-.06-.06a1.65,1.65 0 0,0-1.82-.33,1.65,1.65 0 0,0-1,1.51V21a2,2 0 0,1-4,0v-.09A1.65,1.65 0 0,0,9,19.4a1.65,1.65 0 0,0-1.82,.33l-.06,.06a2,2 0 0,1-2.83-2.83l.06-.06A1.65,1.65 0 0,0,4.68,15a1.65,1.65 0 0,0-1.51-1H3a2,2 0 0,1,0-4h.09A1.65,1.65 0 0,0,4.6,9a1.65,1.65 0 0,0-.33-1.82l-.06-.06a2,2 0 0,1,2.83-2.83l.06,.06A1.65,1.65 0 0,0,9,4.68a1.65,1.65 0 0,0,1-1.51V3a2,2 0 0,1,4,0v.09a1.65,1.65 0 0,0,1,1.51,1.65,1.65 0 0,0,1.82-.33l.06-.06a2,2 0 0,1,2.83,2.83l-.06,.06A1.65,1.65 0 0,0,19.4,9a1.65,1.65 0 0,0,1.51,1H21a2,2 0 0,1,0,4h-.09A1.65,1.65 0 0,0,19.4,15Z"/></svg>'},
    {name:'User',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20,21v-2a4,4 0 0,0-4-4H8a4,4 0 0,0-4,4v2"/><circle cx="12" cy="7" r="4"/></svg>'},
    {name:'Folder',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22,19a2,2 0 0,1-2,2H4a2,2 0 0,1-2-2V5a2,2 0 0,1,2-2h5l2,3h9a2,2 0 0,1,2,2Z"/></svg>'},
    {name:'File',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13,2H6a2,2 0 0,0-2,2V20a2,2 0 0,0,2,2H18a2,2 0 0,0,2-2V9Z"/><polyline points="13,2 13,9 20,9"/></svg>'},
    {name:'Calendar',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>'},
    {name:'Clock',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>'},
    {name:'Mail',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4,4H20a2,2 0 0,1,2,2V18a2,2 0 0,1-2,2H4a2,2 0 0,1-2-2V6A2,2 0 0,1,4,4Z"/><polyline points="22,6 12,13 2,6"/></svg>'},
    {name:'Trash',svg:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"/></svg>'}
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">SVG Icon Browser</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px">';
  icons.forEach(function(ic,i){
    h+='<div onclick="window._copyIcon('+i+')" style="cursor:pointer;text-align:center;padding:10px 4px;background:var(--bg-surface);border-radius:8px" title="'+ic.name+'">'+
      '<div style="width:24px;height:24px;color:#4ade80;margin:0 auto 4px">'+ic.svg.replace('width="24" height="24"','').replace('<svg ','<svg width="24" height="24" ')+'</div>'+
      '<div style="font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+ic.name+'</div></div>';
  });
  h+='</div><div id="icon-copied" style="color:#4ade80;font-size:11px;text-align:center;margin-top:10px;min-height:16px"></div>';
  d.innerHTML=h;
  window._copyIcon=function(i){
    navigator.clipboard.writeText(icons[i].svg);
    var el=document.getElementById('icon-copied');
    if(el)el.textContent='Copied '+icons[i].name+' SVG!';
  };
  document.body.appendChild(d);
}
function showTaskEstimateAccuracy(){
  var ex=document.getElementById('estimate-acc-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var withEst=tasks.filter(function(t){return t.estimate&&t.status==='done'&&t.timeTracked;});
  function parseEst(e){
    if(!e)return 0;
    var m=e.match(/(\d+)\s*(h|m|d)/i);
    if(!m)return parseInt(e)||0;
    var v=parseInt(m[1]);
    if(m[2]==='h')return v*60;
    if(m[2]==='d')return v*480;
    return v;
  }
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Estimate Accuracy</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  if(!withEst.length){
    h+='<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">Add estimates to tasks and track time to see accuracy analysis.</div>';
  } else {
    var totalEst=0,totalActual=0;
    var rows='';
    withEst.forEach(function(t){
      var est=parseEst(t.estimate);
      var actual=Math.round((t.timeTracked||0)/60);
      totalEst+=est;totalActual+=actual;
      var ratio=est?Math.round(actual/est*100):0;
      var color=ratio<=120&&ratio>=80?'#4ade80':ratio>120?'#ef4444':'#f59e0b';
      rows+='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)">'+
        '<span style="color:var(--text-primary);font-size:11px;flex:1">'+esc((t.title||'').substring(0,25))+'</span>'+
        '<span style="color:var(--text-muted);font-size:10px;min-width:40px;text-align:right">Est: '+t.estimate+'</span>'+
        '<span style="color:var(--text-muted);font-size:10px;min-width:50px;text-align:right">Act: '+actual+'m</span>'+
        '<span style="color:'+color+';font-size:10px;font-weight:600;min-width:35px;text-align:right">'+ratio+'%</span></div>';
    });
    var overallRatio=totalEst?Math.round(totalActual/totalEst*100):0;
    h+='<div style="text-align:center;margin-bottom:16px"><div style="font-size:36px;font-weight:700;color:'+(overallRatio<=120&&overallRatio>=80?'#4ade80':'#f59e0b')+'">'+overallRatio+'%</div><div style="font-size:11px;color:var(--text-muted)">Overall accuracy ('+withEst.length+' tasks)</div></div>';
    h+=rows;
  }
  var d=document.createElement('div');d.id='estimate-acc-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickAmbientSound(){
  var ex=document.getElementById('ambient-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='ambient-float';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:260px';
  var ctx=null,playing=null;
  var sounds=[
    {name:'White Noise',type:'white'},
    {name:'Pink Noise',type:'pink'},
    {name:'Brown Noise',type:'brown'},
    {name:'Binaural 40Hz',type:'binaural'}
  ];
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Ambient Sound</span><button onclick="window._ambStop();document.getElementById(\'ambient-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">x</button></div>';
    sounds.forEach(function(s,i){
      var active=playing===s.type;
      h+='<button onclick="window._ambToggle(\''+s.type+'\')" style="display:block;width:100%;background:'+(active?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:var(--text-primary);border:1px solid '+(active?'#4ade80':'var(--border)')+';padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px;margin-bottom:6px;text-align:left">'+(active?'[playing] ':'')+s.name+'</button>';
    });
    h+='<input type="range" min="0" max="100" value="30" id="amb-vol" style="width:100%;margin-top:6px" oninput="window._ambVol(this.value)">';
    h+='<div style="display:flex;justify-content:space-between;color:var(--text-muted);font-size:10px"><span>Volume</span><span id="amb-vol-label">30%</span></div>';
    d.innerHTML=h;
  }
  var gainNode=null;
  window._ambToggle=function(type){
    if(playing===type){window._ambStop();return;}
    window._ambStop();
    if(!ctx)ctx=new (window.AudioContext||window.webkitAudioContext)();
    gainNode=ctx.createGain();gainNode.gain.value=0.3;gainNode.connect(ctx.destination);
    if(type==='binaural'){
      var osc1=ctx.createOscillator();osc1.frequency.value=200;osc1.type='sine';
      var osc2=ctx.createOscillator();osc2.frequency.value=240;osc2.type='sine';
      var g1=ctx.createGain();g1.gain.value=0.3;
      var g2=ctx.createGain();g2.gain.value=0.3;
      osc1.connect(g1);g1.connect(gainNode);
      osc2.connect(g2);g2.connect(gainNode);
      osc1.start();osc2.start();
      window._ambNodes=[osc1,osc2];
    } else {
      var bufferSize=4096;
      var node=ctx.createScriptProcessor(bufferSize,1,1);
      var b1=0;
      node.onaudioprocess=function(e){
        var output=e.outputBuffer.getChannelData(0);
        for(var i=0;i<bufferSize;i++){
          var white=Math.random()*2-1;
          if(type==='white')output[i]=white;
          else if(type==='pink'){b1=0.99*b1+0.01*white;output[i]=b1*10;}
          else{b1=0.99*b1+0.01*white;output[i]=b1*3.5;}
        }
      };
      node.connect(gainNode);
      window._ambNodes=[node];
    }
    playing=type;rend();
  };
  window._ambStop=function(){
    if(window._ambNodes){window._ambNodes.forEach(function(n){try{n.stop();}catch(e){try{n.disconnect();}catch(e2){}}});}
    window._ambNodes=null;playing=null;
    var el=document.getElementById('ambient-float');if(el)rend();
  };
  window._ambVol=function(v){
    if(gainNode)gainNode.gain.value=v/100;
    var lbl=document.getElementById('amb-vol-label');if(lbl)lbl.textContent=v+'%';
  };
  document.body.appendChild(d);
  rend();
}
function showRegexTester(){
  var ex=document.getElementById('regex-tester-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='regex-tester-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Regex Tester</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="margin-bottom:8px"><label style="color:var(--text-muted);font-size:11px">Pattern</label><div style="display:flex;gap:4px"><span style="color:#4ade80;font-size:14px;line-height:30px">/</span><input id="rx-pattern" placeholder="your regex here" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-family:monospace;font-size:12px"><span style="color:#4ade80;font-size:14px;line-height:30px">/</span><input id="rx-flags" value="g" placeholder="flags" style="width:40px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:6px;font-family:monospace;font-size:12px;text-align:center"></div></div>'+
    '<div style="margin-bottom:8px"><label style="color:var(--text-muted);font-size:11px">Test String</label><textarea id="rx-test" rows="4" placeholder="Enter text to test..." style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-family:monospace;font-size:12px;resize:vertical;box-sizing:border-box"></textarea></div>'+
    '<div id="rx-result" style="background:var(--bg-surface);padding:10px;border-radius:6px;font-family:monospace;font-size:11px;color:var(--text-muted);min-height:40px">Enter a pattern and test string</div>'+
    '<div style="margin-top:8px;font-size:10px;color:var(--text-muted)"><strong>Quick patterns:</strong> '+
    '<span onclick="document.getElementById(\'rx-pattern\').value=\'[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}\';window._rxTest()" style="color:#4ade80;cursor:pointer;margin-right:8px">Email</span>'+
    '<span onclick="document.getElementById(\'rx-pattern\').value=\'https?://[^\\\\s]+\';window._rxTest()" style="color:#4ade80;cursor:pointer;margin-right:8px">URL</span>'+
    '<span onclick="document.getElementById(\'rx-pattern\').value=\'\\\\b\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\b\';window._rxTest()" style="color:#4ade80;cursor:pointer;margin-right:8px">IP</span>'+
    '<span onclick="document.getElementById(\'rx-pattern\').value=\'\\\\d{4}-\\\\d{2}-\\\\d{2}\';window._rxTest()" style="color:#4ade80;cursor:pointer">Date</span>'+
    '</div>';
  document.body.appendChild(d);
  window._rxTest=function(){
    var pat=document.getElementById('rx-pattern').value;
    var flags=document.getElementById('rx-flags').value;
    var test=document.getElementById('rx-test').value;
    var result=document.getElementById('rx-result');
    if(!pat||!test){result.innerHTML='Enter a pattern and test string';return;}
    try{
      var re=new RegExp(pat,flags);
      var matches=test.match(re);
      if(!matches){result.innerHTML='<span style="color:#ef4444">No matches</span>';return;}
      var h='<span style="color:#4ade80">'+matches.length+' match(es):</span><br>';
      matches.forEach(function(m,i){h+='<span style="color:var(--text-primary)">['+i+'] "'+esc(m)+'"</span><br>';});
      result.innerHTML=h;
    }catch(e){result.innerHTML='<span style="color:#ef4444">Error: '+esc(e.message)+'</span>';}
  };
  d.querySelector('#rx-pattern').oninput=window._rxTest;
  d.querySelector('#rx-flags').oninput=window._rxTest;
  d.querySelector('#rx-test').oninput=window._rxTest;
}
function showTaskSLATracker(){
  var ex=document.getElementById('sla-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]).filter(function(t){return t.status!=='done'&&t.due;});
  var now=new Date();var today=now.toISOString().split('T')[0];
  var withinSLA=0,nearBreach=0,breached=0;
  tasks.forEach(function(t){
    var diff=Math.floor((new Date(t.due)-now)/86400000);
    if(diff<0)breached++;
    else if(diff<=2)nearBreach++;
    else withinSLA++;
  });
  var total=tasks.length||1;
  var slaRate=Math.round(withinSLA/total*100);
  var d=document.createElement('div');d.id='sla-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:380px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">SLA Tracker</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="text-align:center;margin-bottom:16px"><div style="font-size:40px;font-weight:700;color:'+(slaRate>=80?'#4ade80':slaRate>=50?'#f59e0b':'#ef4444')+'">'+slaRate+'%</div><div style="font-size:11px;color:var(--text-muted)">SLA Compliance</div></div>'+
    '<div style="display:flex;gap:8px;margin-bottom:16px">'+
    '<div style="flex:1;text-align:center;padding:10px;background:var(--bg-surface);border-radius:8px;border-top:3px solid #4ade80"><div style="font-size:20px;font-weight:700;color:#4ade80">'+withinSLA+'</div><div style="font-size:9px;color:var(--text-muted)">On Track</div></div>'+
    '<div style="flex:1;text-align:center;padding:10px;background:var(--bg-surface);border-radius:8px;border-top:3px solid #f59e0b"><div style="font-size:20px;font-weight:700;color:#f59e0b">'+nearBreach+'</div><div style="font-size:9px;color:var(--text-muted)">Near Breach</div></div>'+
    '<div style="flex:1;text-align:center;padding:10px;background:var(--bg-surface);border-radius:8px;border-top:3px solid #ef4444"><div style="font-size:20px;font-weight:700;color:#ef4444">'+breached+'</div><div style="font-size:9px;color:var(--text-muted)">Breached</div></div></div>'+
    (tasks.length===0?'<div style="color:var(--text-muted);font-size:12px;text-align:center">Add tasks with due dates to track SLA</div>':'');
  document.body.appendChild(d);
}
function showQuickFocusScore(){
  var ex=document.getElementById('focus-score-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var today=new Date().toISOString().split('T')[0];
  var doneToday=tasks.filter(function(t){return t.status==='done'&&t.completedAt&&t.completedAt.startsWith(today);}).length;
  var createdToday=tasks.filter(function(t){return t.createdAt&&t.createdAt.startsWith(today);}).length;
  var inProgress=tasks.filter(function(t){return t.status==='in-progress';}).length;
  var overdue=tasks.filter(function(t){return t.due&&t.due<today&&t.status!=='done';}).length;
  var score=Math.min(100,doneToday*15+inProgress*5-overdue*10-Math.max(0,createdToday-doneToday)*3);
  score=Math.max(0,score);
  var level=score>=80?'Focused':score>=60?'Productive':score>=40?'Getting There':score>=20?'Scattered':'Unfocused';
  var color=score>=80?'#4ade80':score>=60?'#06b6d4':score>=40?'#f59e0b':'#ef4444';
  var d=document.createElement('div');d.id='focus-score-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:30px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:320px;width:90vw;text-align:center';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span style="font-weight:600;color:var(--text-primary)">Focus Score</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="width:120px;height:120px;border-radius:50%;border:4px solid '+color+';margin:0 auto 16px;display:flex;align-items:center;justify-content:center;flex-direction:column">'+
    '<div style="font-size:36px;font-weight:700;color:'+color+'">'+score+'</div>'+
    '<div style="font-size:10px;color:var(--text-muted)">'+level+'</div></div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:center">'+
    '<div style="padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#4ade80">'+doneToday+'</div><div style="font-size:9px;color:var(--text-muted)">Done Today</div></div>'+
    '<div style="padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#06b6d4">'+inProgress+'</div><div style="font-size:9px;color:var(--text-muted)">In Progress</div></div>'+
    '<div style="padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#3b82f6">'+createdToday+'</div><div style="font-size:9px;color:var(--text-muted)">Created Today</div></div>'+
    '<div style="padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:18px;font-weight:700;color:#ef4444">'+overdue+'</div><div style="font-size:9px;color:var(--text-muted)">Overdue</div></div></div>';
  document.body.appendChild(d);
}
function showBase64Tool(){
  var ex=document.getElementById('base64-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='base64-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Base64 Encode/Decode</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="margin-bottom:8px"><label style="color:var(--text-muted);font-size:11px">Input</label><textarea id="b64-input" rows="4" placeholder="Enter text or base64 string..." style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-family:monospace;font-size:12px;resize:vertical;box-sizing:border-box"></textarea></div>'+
    '<div style="display:flex;gap:8px;margin-bottom:8px">'+
    '<button onclick="window._b64Encode()" style="flex:1;background:#4ade80;color:#000;border:none;padding:8px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Encode</button>'+
    '<button onclick="window._b64Decode()" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:8px;border-radius:6px;cursor:pointer;font-size:12px">Decode</button>'+
    '</div>'+
    '<div style="margin-bottom:8px"><label style="color:var(--text-muted);font-size:11px">Output</label><textarea id="b64-output" rows="4" readonly style="width:100%;background:var(--bg-surface);color:#4ade80;border:1px solid var(--border);border-radius:6px;padding:8px;font-family:monospace;font-size:12px;resize:vertical;box-sizing:border-box"></textarea></div>'+
    '<button onclick="var o=document.getElementById(\'b64-output\');if(o)navigator.clipboard.writeText(o.value);this.textContent=\'Copied!\';var b=this;setTimeout(function(){b.textContent=\'Copy Output\'},800)" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px">Copy Output</button>';
  document.body.appendChild(d);
  window._b64Encode=function(){
    var inp=document.getElementById('b64-input');var out=document.getElementById('b64-output');
    if(!inp||!out)return;try{out.value=btoa(unescape(encodeURIComponent(inp.value)));}catch(e){out.value='Error: '+e.message;}
  };
  window._b64Decode=function(){
    var inp=document.getElementById('b64-input');var out=document.getElementById('b64-output');
    if(!inp||!out)return;try{out.value=decodeURIComponent(escape(atob(inp.value.trim())));}catch(e){out.value='Error: '+e.message;}
  };
}
function showTaskProductivityDashboard(){
  var ex=document.getElementById('prod-dash-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var content=(S.content||[]);
  var docs=(S.writerDocs||[]);
  var now=new Date();var today=now.toISOString().split('T')[0];
  var weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);var weekStr=weekAgo.toISOString().split('T')[0];
  var doneThisWeek=tasks.filter(function(t){return t.status==='done'&&t.completedAt&&t.completedAt>=weekStr;}).length;
  var createdThisWeek=tasks.filter(function(t){return t.createdAt&&t.createdAt>=weekStr;}).length;
  var contentThisWeek=content.filter(function(c){return c.createdAt&&c.createdAt>=weekStr;}).length;
  var totalWords=0;
  docs.forEach(function(doc){totalWords+=(doc.content||'').split(/\s+/).filter(function(w){return w;}).length;});
  var totalTasks=tasks.length;
  var totalDone=tasks.filter(function(t){return t.status==='done';}).length;
  var totalContent=content.length;
  var streak=0;var dt=new Date(now);
  for(var i=0;i<365;i++){
    var key=dt.toISOString().split('T')[0];
    var hasDone=tasks.some(function(t){return t.status==='done'&&t.completedAt&&t.completedAt.startsWith(key);});
    if(hasDone)streak++;else break;
    dt.setDate(dt.getDate()-1);
  }
  var d=document.createElement('div');d.id='prod-dash-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Productivity Dashboard</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">'+
    '<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:24px;font-weight:700;color:#4ade80">'+doneThisWeek+'</div><div style="font-size:9px;color:var(--text-muted)">Done This Week</div></div>'+
    '<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:24px;font-weight:700;color:#06b6d4">'+createdThisWeek+'</div><div style="font-size:9px;color:var(--text-muted)">Created This Week</div></div>'+
    '<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:24px;font-weight:700;color:#a78bfa">'+contentThisWeek+'</div><div style="font-size:9px;color:var(--text-muted)">Content This Week</div></div>'+
    '</div>'+
    '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px">'+
    '<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:var(--text-primary)">'+totalTasks+'</div><div style="font-size:8px;color:var(--text-muted)">Total Tasks</div></div>'+
    '<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#4ade80">'+totalDone+'</div><div style="font-size:8px;color:var(--text-muted)">Completed</div></div>'+
    '<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#f59e0b">'+totalContent+'</div><div style="font-size:8px;color:var(--text-muted)">Content Items</div></div>'+
    '<div style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px"><div style="font-size:16px;font-weight:700;color:#ec4899">'+totalWords.toLocaleString()+'</div><div style="font-size:8px;color:var(--text-muted)">Words Written</div></div>'+
    '</div>'+
    '<div style="text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><span style="font-size:28px;font-weight:700;color:#4ade80">'+streak+'</span><span style="font-size:12px;color:var(--text-muted);margin-left:6px">day streak</span></div>';
  document.body.appendChild(d);
}
function showQuickStopwatch(){
  var ex=document.getElementById('stopwatch-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='stopwatch-float';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:220px;text-align:center';
  var elapsed=0,running=false,timer=null,laps=[];
  function fmt(ms){
    var s=Math.floor(ms/1000);var m=Math.floor(s/60);s=s%60;var cs=Math.floor((ms%1000)/10);
    return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')+'.'+String(cs).padStart(2,'0');
  }
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Stopwatch</span><button onclick="window._swReset();document.getElementById(\'stopwatch-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">x</button></div>';
    h+='<div style="font-size:32px;font-weight:700;color:'+(running?'#4ade80':'var(--text-primary)')+';font-family:monospace;margin-bottom:12px">'+fmt(elapsed)+'</div>';
    h+='<div style="display:flex;gap:6px;justify-content:center;margin-bottom:8px">';
    if(!running){
      h+='<button onclick="window._swStart()" style="background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Start</button>';
      if(elapsed>0)h+='<button onclick="window._swReset()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">Reset</button>';
    } else {
      h+='<button onclick="window._swStop()" style="background:#ef4444;color:#fff;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Stop</button>';
      h+='<button onclick="window._swLap()" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">Lap</button>';
    }
    h+='</div>';
    if(laps.length){
      h+='<div style="max-height:80px;overflow-y:auto">';
      laps.forEach(function(l,i){h+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:10px"><span style="color:var(--text-muted)">Lap '+(i+1)+'</span><span style="color:var(--text-primary);font-family:monospace">'+fmt(l)+'</span></div>';});
      h+='</div>';
    }
    d.innerHTML=h;
  }
  var startTime=0;
  window._swStart=function(){
    running=true;startTime=Date.now()-elapsed;
    timer=setInterval(function(){elapsed=Date.now()-startTime;rend();},50);
    rend();
  };
  window._swStop=function(){running=false;if(timer)clearInterval(timer);timer=null;rend();};
  window._swLap=function(){laps.push(elapsed);rend();};
  window._swReset=function(){
    running=false;if(timer)clearInterval(timer);timer=null;elapsed=0;laps=[];
    var el=document.getElementById('stopwatch-float');if(el)rend();
  };
  document.body.appendChild(d);
  rend();
}
function showUrlEncoder(){
  var ex=document.getElementById('url-encoder-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='url-encoder-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">URL Encode/Decode</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="margin-bottom:8px"><label style="color:var(--text-muted);font-size:11px">Input</label><textarea id="url-enc-input" rows="3" placeholder="Enter URL or encoded string..." style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-family:monospace;font-size:12px;resize:vertical;box-sizing:border-box"></textarea></div>'+
    '<div style="display:flex;gap:8px;margin-bottom:8px">'+
    '<button onclick="window._urlEnc()" style="flex:1;background:#4ade80;color:#000;border:none;padding:8px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Encode</button>'+
    '<button onclick="window._urlDec()" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:8px;border-radius:6px;cursor:pointer;font-size:12px">Decode</button>'+
    '<button onclick="window._urlComp()" style="flex:1;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:8px;border-radius:6px;cursor:pointer;font-size:12px">encodeComponent</button>'+
    '</div>'+
    '<div style="margin-bottom:8px"><label style="color:var(--text-muted);font-size:11px">Output</label><textarea id="url-enc-output" rows="3" readonly style="width:100%;background:var(--bg-surface);color:#4ade80;border:1px solid var(--border);border-radius:6px;padding:8px;font-family:monospace;font-size:12px;resize:vertical;box-sizing:border-box"></textarea></div>'+
    '<button onclick="var o=document.getElementById(\'url-enc-output\');if(o)navigator.clipboard.writeText(o.value)" style="background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px">Copy Output</button>';
  document.body.appendChild(d);
  window._urlEnc=function(){var i=document.getElementById('url-enc-input');var o=document.getElementById('url-enc-output');if(i&&o)try{o.value=encodeURI(i.value);}catch(e){o.value='Error: '+e.message;}};
  window._urlDec=function(){var i=document.getElementById('url-enc-input');var o=document.getElementById('url-enc-output');if(i&&o)try{o.value=decodeURI(i.value);}catch(e){o.value='Error: '+e.message;}};
  window._urlComp=function(){var i=document.getElementById('url-enc-input');var o=document.getElementById('url-enc-output');if(i&&o)try{o.value=encodeURIComponent(i.value);}catch(e){o.value='Error: '+e.message;}};
}
function showTaskWorkspaceSummary(){
  var ex=document.getElementById('workspace-summary-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var content=(S.content||[]);
  var links=(S.links||[]);
  var docs=(S.writerDocs||[]);
  var specs=(S.specs||[]);
  var repos=(S.repos||[]);
  var projects=(S.projects||[]);
  var totalSize=JSON.stringify(S).length;
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Workspace Summary</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  var sections=[
    {name:'Tasks',count:tasks.length,color:'#4ade80'},
    {name:'Content',count:content.length,color:'#06b6d4'},
    {name:'Links',count:links.length,color:'#a78bfa'},
    {name:'Writer Docs',count:docs.length,color:'#f59e0b'},
    {name:'Living Docs',count:specs.length,color:'#ec4899'},
    {name:'Repos',count:repos.length,color:'#3b82f6'},
    {name:'Projects',count:projects.length,color:'#ef4444'}
  ];
  var maxCount=0;sections.forEach(function(s){if(s.count>maxCount)maxCount=s.count;});
  sections.forEach(function(s){
    var pct=maxCount?Math.round(s.count/maxCount*100):0;
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'+
      '<div style="width:8px;height:8px;border-radius:50%;background:'+s.color+'"></div>'+
      '<span style="color:var(--text-primary);font-size:12px;min-width:80px">'+s.name+'</span>'+
      '<div style="flex:1;height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+s.color+';border-radius:4px"></div></div>'+
      '<span style="color:var(--text-muted);font-size:11px;min-width:30px;text-align:right">'+s.count+'</span></div>';
  });
  h+='<div style="margin-top:12px;padding:10px;background:var(--bg-surface);border-radius:6px;text-align:center">'+
    '<div style="font-size:11px;color:var(--text-muted)">Total workspace size</div>'+
    '<div style="font-size:20px;font-weight:700;color:#4ade80">'+(totalSize/1024).toFixed(1)+' KB</div></div>';
  var d=document.createElement('div');d.id='workspace-summary-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickMetronome(){
  var ex=document.getElementById('metronome-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='metronome-float';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:220px;text-align:center';
  var bpm=120,running=false,timer=null,ctx=null,beat=0;
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Metronome</span><button onclick="window._metStop();document.getElementById(\'metronome-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">x</button></div>';
    h+='<div style="font-size:36px;font-weight:700;color:'+(running?'#4ade80':'var(--text-primary)')+';margin-bottom:8px">'+bpm+'</div>';
    h+='<div style="color:var(--text-muted);font-size:11px;margin-bottom:8px">BPM</div>';
    h+='<input type="range" min="40" max="240" value="'+bpm+'" id="met-bpm" style="width:100%;margin-bottom:8px">';
    h+='<div style="display:flex;gap:8px;justify-content:center;margin-bottom:8px">';
    [60,80,100,120,140].forEach(function(b){
      h+='<button onclick="window._metBPM('+b+')" style="background:'+(bpm===b?'#4ade80':'var(--bg-surface)')+';color:'+(bpm===b?'#000':'var(--text-primary)')+';border:1px solid var(--border);padding:3px 6px;border-radius:4px;cursor:pointer;font-size:10px">'+b+'</button>';
    });
    h+='</div>';
    h+='<div style="display:flex;gap:8px;justify-content:center">';
    for(var i=0;i<4;i++){
      h+='<div style="width:16px;height:16px;border-radius:50%;background:'+(beat%4===i&&running?'#4ade80':'var(--bg-surface)')+';border:1px solid var(--border)"></div>';
    }
    h+='</div>';
    h+='<button onclick="window._metToggle()" style="background:'+(running?'#ef4444':'#4ade80')+';color:'+(running?'#fff':'#000')+';border:none;padding:8px 24px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;width:100%;margin-top:8px">'+(running?'Stop':'Start')+'</button>';
    d.innerHTML=h;
    var slider=d.querySelector('#met-bpm');
    if(slider)slider.oninput=function(e){bpm=parseInt(e.target.value);if(running){window._metStop();window._metToggle();}else{rend();}};
  }
  function tick(){
    beat++;
    if(!ctx)ctx=new (window.AudioContext||window.webkitAudioContext)();
    var osc=ctx.createOscillator();osc.frequency.value=beat%4===0?880:660;
    var g=ctx.createGain();g.gain.value=0.3;g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.1);
    osc.connect(g);g.connect(ctx.destination);
    osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.1);
    rend();
  }
  window._metToggle=function(){
    if(running){window._metStop();return;}
    running=true;beat=0;
    timer=setInterval(tick,60000/bpm);tick();
  };
  window._metStop=function(){running=false;if(timer)clearInterval(timer);timer=null;rend();};
  window._metBPM=function(b){bpm=b;if(running){window._metStop();window._metToggle();}else rend();};
  document.body.appendChild(d);
  rend();
}
function showHtmlEntityRef(){
  var ex=document.getElementById('html-entity-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='html-entity-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  var entities=[
    ['&amp;','&','Ampersand'],['&lt;','<','Less than'],['&gt;','>','Greater than'],
    ['&quot;','"','Double quote'],['&apos;',"'",'Apostrophe'],['&nbsp;',' ','Non-breaking space'],
    ['&copy;','\u00A9','Copyright'],['&reg;','\u00AE','Registered'],['&trade;','\u2122','Trademark'],
    ['&euro;','\u20AC','Euro'],['&pound;','\u00A3','Pound'],['&yen;','\u00A5','Yen'],
    ['&cent;','\u00A2','Cent'],['&mdash;','\u2014','Em dash'],['&ndash;','\u2013','En dash'],
    ['&hellip;','\u2026','Ellipsis'],['&laquo;','\u00AB','Left guillemet'],['&raquo;','\u00BB','Right guillemet'],
    ['&bull;','\u2022','Bullet'],['&larr;','\u2190','Left arrow'],['&rarr;','\u2192','Right arrow'],
    ['&uarr;','\u2191','Up arrow'],['&darr;','\u2193','Down arrow'],['&times;','\u00D7','Multiplication'],
    ['&divide;','\u00F7','Division'],['&infin;','\u221E','Infinity'],['&ne;','\u2260','Not equal'],
    ['&le;','\u2264','Less or equal'],['&ge;','\u2265','Greater or equal'],['&deg;','\u00B0','Degree']
  ];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">HTML Entity Reference</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px">';
  entities.forEach(function(e,i){
    h+='<div onclick="navigator.clipboard.writeText(\''+e[0].replace(/'/g,"\\'")+'\')" style="cursor:pointer;text-align:center;padding:8px 4px;background:var(--bg-surface);border-radius:6px" title="'+e[2]+': '+e[0]+'">'+
      '<div style="font-size:18px;color:var(--text-primary);margin-bottom:2px">'+e[1]+'</div>'+
      '<div style="font-size:8px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+e[0].replace(/&/g,'&amp;').replace(/</g,'&lt;')+'</div></div>';
  });
  h+='</div><div style="color:var(--text-muted);font-size:10px;text-align:center;margin-top:8px">Click to copy entity code</div>';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showTaskWeeklyDigest(){
  var ex=document.getElementById('weekly-digest-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var now=new Date();
  var weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  weekStart.setHours(0,0,0,0);
  var weekStr=weekStart.toISOString().split('T')[0];
  var done=tasks.filter(function(t){return t.status==='done'&&t.completedAt&&t.completedAt>=weekStr;});
  var created=tasks.filter(function(t){return t.createdAt&&t.createdAt>=weekStr;});
  var inProgress=tasks.filter(function(t){return t.status==='in-progress';});
  var overdue=tasks.filter(function(t){return t.due&&t.due<now.toISOString().split('T')[0]&&t.status!=='done';});
  var byDay={};
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(function(d,i){byDay[d]=0;});
  done.forEach(function(t){
    var d=new Date(t.completedAt);
    var day=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
    byDay[day]++;
  });
  var maxDay=0;Object.values(byDay).forEach(function(v){if(v>maxDay)maxDay=v;});
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Weekly Digest</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="display:flex;gap:4px;margin-bottom:16px;align-items:flex-end;height:80px">';
  Object.keys(byDay).forEach(function(day){
    var v=byDay[day];
    var bh=maxDay?Math.round(v/maxDay*60):0;
    h+='<div style="flex:1;text-align:center"><div style="height:'+bh+'px;background:#4ade80;border-radius:3px 3px 0 0;min-height:'+(v?'4':'0')+'px;margin-bottom:4px"></div><div style="font-size:9px;color:var(--text-muted)">'+day+'</div></div>';
  });
  h+='</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">'+
    '<div style="padding:10px;background:var(--bg-surface);border-radius:6px;text-align:center"><div style="font-size:20px;font-weight:700;color:#4ade80">'+done.length+'</div><div style="font-size:9px;color:var(--text-muted)">Completed</div></div>'+
    '<div style="padding:10px;background:var(--bg-surface);border-radius:6px;text-align:center"><div style="font-size:20px;font-weight:700;color:#3b82f6">'+created.length+'</div><div style="font-size:9px;color:var(--text-muted)">Created</div></div>'+
    '<div style="padding:10px;background:var(--bg-surface);border-radius:6px;text-align:center"><div style="font-size:20px;font-weight:700;color:#f59e0b">'+inProgress.length+'</div><div style="font-size:9px;color:var(--text-muted)">In Progress</div></div>'+
    '<div style="padding:10px;background:var(--bg-surface);border-radius:6px;text-align:center"><div style="font-size:20px;font-weight:700;color:#ef4444">'+overdue.length+'</div><div style="font-size:9px;color:var(--text-muted)">Overdue</div></div></div>';
  if(done.length){
    h+='<div style="font-size:11px;color:var(--text-muted);font-weight:600;margin-bottom:6px">Completed This Week</div>';
    done.slice(0,8).forEach(function(t){
      h+='<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)">'+
        '<span style="color:var(--text-primary);font-size:11px">'+esc((t.title||'').substring(0,35))+'</span>'+
        '<span style="color:var(--text-muted);font-size:10px">'+(t.completedAt||'').split('T')[0]+'</span></div>';
    });
  }
  var d=document.createElement('div');d.id='weekly-digest-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickColorBlend(){
  var ex=document.getElementById('color-blend-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='color-blend-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw;max-height:80vh;overflow-y:auto';
  var c1='#4ade80',c2='#06b6d4',steps=5;
  function hexToRgb(hex){var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return [r,g,b];}
  function rgbToHex(r,g,b){return '#'+[r,g,b].map(function(x){return Math.round(x).toString(16).padStart(2,'0');}).join('');}
  function blend(){
    var rgb1=hexToRgb(c1),rgb2=hexToRgb(c2);
    var colors=[];
    for(var i=0;i<=steps+1;i++){
      var t=i/(steps+1);
      var r=rgb1[0]+(rgb2[0]-rgb1[0])*t;
      var g=rgb1[1]+(rgb2[1]-rgb1[1])*t;
      var b=rgb1[2]+(rgb2[2]-rgb1[2])*t;
      colors.push(rgbToHex(r,g,b));
    }
    return colors;
  }
  function render(){
    var colors=blend();
    var swatches=d.querySelector('.blend-swatches');
    if(swatches){
      var h='';
      colors.forEach(function(c){
        h+='<div onclick="navigator.clipboard.writeText(\''+c+'\')" style="cursor:pointer;text-align:center;padding:8px 4px;background:var(--bg-surface);border-radius:6px;min-width:0"><div style="height:30px;background:'+c+';border-radius:4px;margin-bottom:4px"></div><div style="font-size:9px;color:var(--text-muted);font-family:monospace">'+c+'</div></div>';
      });
      swatches.innerHTML=h;
    }
  }
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Color Blend</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">'+
    '<label style="color:var(--text-muted);font-size:11px">Start<br><input type="color" value="'+c1+'" id="blend-c1" style="width:50px;height:30px;border:none;cursor:pointer"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">End<br><input type="color" value="'+c2+'" id="blend-c2" style="width:50px;height:30px;border:none;cursor:pointer"></label>'+
    '<label style="color:var(--text-muted);font-size:11px">Steps<br><input type="number" value="'+steps+'" min="1" max="20" id="blend-steps" style="width:50px;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:4px;padding:3px;font-size:12px"></label>'+
    '</div>'+
    '<div class="blend-swatches" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(50px,1fr));gap:4px"></div>'+
    '<div style="color:var(--text-muted);font-size:10px;text-align:center;margin-top:8px">Click swatch to copy hex</div>';
  document.body.appendChild(d);
  render();
  d.querySelector('#blend-c1').oninput=function(e){c1=e.target.value;render();};
  d.querySelector('#blend-c2').oninput=function(e){c2=e.target.value;render();};
  d.querySelector('#blend-steps').oninput=function(e){steps=Math.max(1,parseInt(e.target.value)||1);render();};
}
function showTimezoneConverter(){
  var ex=document.getElementById('tz-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='tz-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  var zones=[
    {name:'Local',tz:Intl.DateTimeFormat().resolvedOptions().timeZone},
    {name:'UTC',tz:'UTC'},
    {name:'New York',tz:'America/New_York'},
    {name:'Los Angeles',tz:'America/Los_Angeles'},
    {name:'London',tz:'Europe/London'},
    {name:'Paris',tz:'Europe/Paris'},
    {name:'Tokyo',tz:'Asia/Tokyo'},
    {name:'Sydney',tz:'Australia/Sydney'},
    {name:'Dubai',tz:'Asia/Dubai'},
    {name:'Singapore',tz:'Asia/Singapore'}
  ];
  function render(){
    var now=new Date();
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">World Clock</span><button onclick="document.getElementById(\'tz-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
    zones.forEach(function(z){
      var time=now.toLocaleString('en-US',{timeZone:z.tz,hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
      var date=now.toLocaleString('en-US',{timeZone:z.tz,weekday:'short',month:'short',day:'numeric'});
      var hour=parseInt(now.toLocaleString('en-US',{timeZone:z.tz,hour:'numeric',hour12:false}));
      var isDark=hour<6||hour>=20;
      h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px;border-left:3px solid '+(isDark?'#64748b':'#f59e0b')+'">'+
        '<div><div style="color:var(--text-primary);font-size:12px;font-weight:600">'+z.name+'</div><div style="color:var(--text-muted);font-size:9px">'+z.tz+'</div></div>'+
        '<div style="text-align:right"><div style="color:'+(z.name==='Local'?'#4ade80':'var(--text-primary)')+';font-size:14px;font-weight:700;font-family:monospace">'+time+'</div><div style="color:var(--text-muted);font-size:9px">'+date+'</div></div></div>';
    });
    d.innerHTML=h;
  }
  document.body.appendChild(d);
  render();
  var interval=setInterval(render,1000);
  var origRemove=d.remove.bind(d);
  d.remove=function(){clearInterval(interval);origRemove();};
}
function showTaskTagCloud(){
  var ex=document.getElementById('tag-cloud-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var content=(S.content||[]);
  var tagCounts={};
  tasks.forEach(function(t){
    if(t.tags){t.tags.forEach(function(tag){tagCounts[tag]=(tagCounts[tag]||0)+1;});}
    if(t.project){tagCounts[t.project]=(tagCounts[t.project]||0)+1;}
  });
  content.forEach(function(c){
    if(c.tags){c.tags.forEach(function(tag){tagCounts[tag]=(tagCounts[tag]||0)+1;});}
    if(c.theme)tagCounts[c.theme]=(tagCounts[c.theme]||0)+1;
  });
  var sorted=Object.entries(tagCounts).sort(function(a,b){return b[1]-a[1];}).slice(0,40);
  var maxCount=sorted.length?sorted[0][1]:1;
  var colors=['#4ade80','#06b6d4','#a78bfa','#f59e0b','#ef4444','#ec4899','#3b82f6'];
  var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Tag Cloud</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
  h+='<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center">';
  sorted.forEach(function(entry,i){
    var size=10+Math.round(entry[1]/maxCount*14);
    var color=colors[i%colors.length];
    h+='<span style="font-size:'+size+'px;color:'+color+';cursor:default;padding:2px 6px" title="'+entry[1]+' items">'+esc(entry[0])+'</span>';
  });
  h+='</div>';
  if(!sorted.length)h+='<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">Add tags to tasks and content to see cloud</div>';
  var d=document.createElement('div');d.id='tag-cloud-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML=h;
  document.body.appendChild(d);
}
function showQuickScreenRuler(){
  var ex=document.getElementById('ruler-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='ruler-float';
  d.style.cssText='position:fixed;top:0;left:0;z-index:1500;width:100vw;height:100vh;pointer-events:none';
  var hLine=document.createElement('div');
  hLine.style.cssText='position:absolute;top:50%;left:0;width:100%;height:1px;background:#4ade80;opacity:0.7;pointer-events:none';
  var vLine=document.createElement('div');
  vLine.style.cssText='position:absolute;top:0;left:50%;width:1px;height:100%;background:#4ade80;opacity:0.7;pointer-events:none';
  var label=document.createElement('div');
  label.style.cssText='position:absolute;background:rgba(0,0,0,0.8);color:#4ade80;font-size:11px;font-family:monospace;padding:4px 8px;border-radius:4px;pointer-events:none';
  var closeBtn=document.createElement('button');
  closeBtn.textContent='Close Ruler';
  closeBtn.style.cssText='position:fixed;top:10px;right:10px;z-index:1501;background:#4ade80;color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;pointer-events:auto';
  closeBtn.onclick=function(){d.remove();document.removeEventListener('mousemove',onMove);};
  d.appendChild(hLine);d.appendChild(vLine);d.appendChild(label);d.appendChild(closeBtn);
  document.body.appendChild(d);
  function onMove(e){
    hLine.style.top=e.clientY+'px';
    vLine.style.left=e.clientX+'px';
    label.style.left=(e.clientX+12)+'px';
    label.style.top=(e.clientY+12)+'px';
    label.textContent=e.clientX+'px, '+e.clientY+'px ('+window.innerWidth+'x'+window.innerHeight+')';
  }
  document.addEventListener('mousemove',onMove);
}
function showJwtDecoder(){
  var ex=document.getElementById('jwt-float');if(ex){ex.remove();return;}
  var d=document.createElement('div');d.id='jwt-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">JWT Decoder</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="margin-bottom:8px"><label style="color:var(--text-muted);font-size:11px">Paste JWT Token</label><textarea id="jwt-input" rows="3" placeholder="eyJhbGciOiJIUzI1NiIs..." style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-family:monospace;font-size:11px;resize:vertical;box-sizing:border-box"></textarea></div>'+
    '<button onclick="window._jwtDecode()" style="background:#4ade80;color:#000;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-bottom:12px">Decode</button>'+
    '<div id="jwt-output" style="font-family:monospace;font-size:11px"></div>';
  document.body.appendChild(d);
  window._jwtDecode=function(){
    var inp=document.getElementById('jwt-input');
    var out=document.getElementById('jwt-output');
    if(!inp||!out)return;
    var token=inp.value.trim();
    if(!token){out.innerHTML='<span style="color:var(--text-muted)">Paste a JWT token above</span>';return;}
    var parts=token.split('.');
    if(parts.length!==3){out.innerHTML='<span style="color:#ef4444">Invalid JWT: expected 3 parts, got '+parts.length+'</span>';return;}
    try{
      var header=JSON.parse(atob(parts[0].replace(/-/g,'+').replace(/_/g,'/')));
      var payload=JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
      var h='<div style="margin-bottom:8px"><div style="color:#ef4444;font-size:10px;font-weight:600;margin-bottom:4px">HEADER</div><pre style="background:var(--bg-surface);padding:8px;border-radius:6px;color:#ef4444;white-space:pre-wrap;margin:0">'+esc(JSON.stringify(header,null,2))+'</pre></div>';
      h+='<div style="margin-bottom:8px"><div style="color:#a78bfa;font-size:10px;font-weight:600;margin-bottom:4px">PAYLOAD</div><pre style="background:var(--bg-surface);padding:8px;border-radius:6px;color:#a78bfa;white-space:pre-wrap;margin:0">'+esc(JSON.stringify(payload,null,2))+'</pre></div>';
      if(payload.exp){
        var expDate=new Date(payload.exp*1000);
        var expired=expDate<new Date();
        h+='<div style="padding:6px 10px;background:var(--bg-surface);border-radius:6px;border-left:3px solid '+(expired?'#ef4444':'#4ade80')+'"><span style="color:var(--text-muted);font-size:10px">Expires: </span><span style="color:'+(expired?'#ef4444':'#4ade80')+';font-size:11px">'+expDate.toLocaleString()+(expired?' (EXPIRED)':' (valid)')+'</span></div>';
      }
      out.innerHTML=h;
    }catch(e){out.innerHTML='<span style="color:#ef4444">Decode error: '+esc(e.message)+'</span>';}
  };
}
function showTaskCumulativeFlow(){
  var ex=document.getElementById('cum-flow-float');if(ex){ex.remove();return;}
  var tasks=(S.tasks||[]);
  var statuses=['todo','in-progress','done'];
  var statusColors={todo:'#64748b','in-progress':'#f59e0b',done:'#4ade80'};
  var days=[];
  var now=new Date();
  for(var i=13;i>=0;i--){
    var dt=new Date(now);dt.setDate(dt.getDate()-i);
    days.push(dt.toISOString().split('T')[0]);
  }
  var data=days.map(function(day){
    var counts={todo:0,'in-progress':0,done:0};
    tasks.forEach(function(t){
      if(!t.createdAt||t.createdAt.split('T')[0]>day)return;
      if(t.status==='done'&&t.completedAt&&t.completedAt.split('T')[0]<=day)counts.done++;
      else if(t.status==='in-progress')counts['in-progress']++;
      else counts.todo++;
    });
    return counts;
  });
  var maxTotal=0;
  data.forEach(function(d){var t=d.todo+d['in-progress']+d.done;if(t>maxTotal)maxTotal=t;});
  var svgW=400,svgH=160;
  var areas='';
  statuses.forEach(function(status){
    var pts=[];
    data.forEach(function(d,i){
      var x=20+i*(svgW-40)/Math.max(data.length-1,1);
      var belowSum=0;
      for(var si=statuses.indexOf(status)+1;si<statuses.length;si++){belowSum+=d[statuses[si]];}
      var total=belowSum+d[status];
      var y1=maxTotal?svgH-20-(belowSum/maxTotal)*(svgH-40):svgH-20;
      var y2=maxTotal?svgH-20-(total/maxTotal)*(svgH-40):svgH-20;
      pts.push({x:x,y1:y1,y2:y2});
    });
    var path='M'+pts[0].x+','+pts[0].y2.toFixed(1);
    for(var i=1;i<pts.length;i++)path+='L'+pts[i].x+','+pts[i].y2.toFixed(1);
    for(var i=pts.length-1;i>=0;i--)path+='L'+pts[i].x+','+pts[i].y1.toFixed(1);
    path+='Z';
    areas+='<path d="'+path+'" fill="'+statusColors[status]+'" opacity="0.6"/>';
  });
  var d=document.createElement('div');d.id='cum-flow-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  d.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Cumulative Flow</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>'+
    '<div style="display:flex;gap:12px;justify-content:center;margin-bottom:8px">'+
    '<div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:#64748b;border-radius:2px"></div><span style="font-size:10px;color:var(--text-muted)">Todo</span></div>'+
    '<div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:#f59e0b;border-radius:2px"></div><span style="font-size:10px;color:var(--text-muted)">In Progress</span></div>'+
    '<div style="display:flex;align-items:center;gap:4px"><div style="width:10px;height:10px;background:#4ade80;border-radius:2px"></div><span style="font-size:10px;color:var(--text-muted)">Done</span></div>'+
    '</div>'+
    '<svg width="'+svgW+'" height="'+svgH+'" style="display:block;margin:0 auto">'+areas+'</svg>';
  document.body.appendChild(d);
}
function showQuickTypingTest(){
  var ex=document.getElementById('typing-test-float');if(ex){ex.remove();return;}
  var sentences=[
    'The quick brown fox jumps over the lazy dog.',
    'A journey of a thousand miles begins with a single step.',
    'To be or not to be, that is the question.',
    'All that glitters is not gold, but it sure is shiny.',
    'The best way to predict the future is to create it.',
    'Stay hungry, stay foolish, and keep shipping code.',
    'In the middle of difficulty lies opportunity to grow.',
    'Every expert was once a beginner who refused to quit.'
  ];
  var text=sentences[Math.floor(Math.random()*sentences.length)];
  var started=false,startTime=0,done=false;
  var d=document.createElement('div');d.id='typing-test-float';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  function rend(){
    var h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Typing Speed Test</span><button onclick="document.getElementById(\'typing-test-float\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">x</button></div>';
    h+='<div style="background:var(--bg-surface);padding:12px;border-radius:8px;margin-bottom:12px;font-size:14px;color:var(--text-primary);line-height:1.6">'+text+'</div>';
    h+='<textarea id="tt-input" placeholder="Start typing..." rows="3" style="width:100%;background:var(--bg-surface);color:var(--text-primary);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:14px;resize:none;box-sizing:border-box" '+(done?'disabled':'')+'></textarea>';
    h+='<div id="tt-stats" style="display:flex;gap:16px;justify-content:center;margin-top:12px">';
    h+='<div style="text-align:center"><div id="tt-wpm" style="font-size:24px;font-weight:700;color:#4ade80">0</div><div style="font-size:9px;color:var(--text-muted)">WPM</div></div>';
    h+='<div style="text-align:center"><div id="tt-acc" style="font-size:24px;font-weight:700;color:#06b6d4">100%</div><div style="font-size:9px;color:var(--text-muted)">Accuracy</div></div>';
    h+='<div style="text-align:center"><div id="tt-time" style="font-size:24px;font-weight:700;color:var(--text-primary)">0s</div><div style="font-size:9px;color:var(--text-muted)">Time</div></div>';
    h+='</div>';
    if(done)h+='<button onclick="window._ttReset()" style="display:block;margin:12px auto 0;background:#4ade80;color:#000;border:none;padding:8px 24px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Try Again</button>';
    d.innerHTML=h;
    if(!done){
      var inp=document.getElementById('tt-input');
      if(inp){
        inp.oninput=function(){
          if(!started){started=true;startTime=Date.now();}
          var typed=inp.value;
          var elapsed=(Date.now()-startTime)/1000;
          var words=typed.split(/\s+/).filter(function(w){return w;}).length;
          var wpm=elapsed>0?Math.round(words/(elapsed/60)):0;
          var correct=0;
          for(var i=0;i<typed.length;i++){if(typed[i]===text[i])correct++;}
          var acc=typed.length?Math.round(correct/typed.length*100):100;
          document.getElementById('tt-wpm').textContent=wpm;
          document.getElementById('tt-acc').textContent=acc+'%';
          document.getElementById('tt-time').textContent=Math.round(elapsed)+'s';
          if(typed===text){done=true;rend();}
        };
        inp.focus();
      }
    }
  }
  window._ttReset=function(){
    text=sentences[Math.floor(Math.random()*sentences.length)];
    started=false;done=false;startTime=0;rend();
  };
  document.body.appendChild(d);
  rend();
}
function showQrGenerator(){
  let p=document.getElementById('qr-gen-panel');if(p)p.remove();
  p=document.createElement('div');p.id='qr-gen-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  let txt=S._qrText||'https://example.com';
  let sz=S._qrSize||200;
  function gen(){
    let d=txt;let mods=[];let size=sz;
    let ec='M';let matrix=qrEncode(d,ec);
    if(!matrix)return '<div style="color:var(--text-muted);padding:20px;text-align:center">Too long for QR</div>';
    let n=matrix.length;let cell=Math.floor(size/n);
    let svg='<svg xmlns="http://www.w3.org/2000/svg" width="'+cell*n+'" height="'+cell*n+'" viewBox="0 0 '+n+' '+n+'">';
    svg+='<rect width="'+n+'" height="'+n+'" fill="white"/>';
    for(let r=0;r<n;r++)for(let c=0;c<n;c++)if(matrix[r][c])svg+='<rect x="'+c+'" y="'+r+'" width="1" height="1" fill="black"/>';
    svg+='</svg>';
    return svg;
  }
  function qrEncode(data,ecl){
    let s=data.length;if(s>120)return null;
    let size=0;let versions=[0,21,25,29,33,37,41,45,49,53,57,61,65,69,73,77,81,85,89,93,97];
    for(let v=1;v<=20;v++){if(s<=(v*3+6)){size=versions[v];break;}}
    if(!size)return null;
    let n=size;let m=[];for(let r=0;r<n;r++){m[r]=[];for(let c=0;c<n;c++)m[r][c]=0;}
    function setMod(r,c,v){if(r>=0&&r<n&&c>=0&&c<n)m[r][c]=v?1:0;}
    function finderPattern(row,col){
      for(let r=-1;r<=7;r++)for(let c=-1;c<=7;c++){
        let v=(r>=0&&r<=6&&c>=0&&c<=6)&&(r===0||r===6||c===0||c===6||(r>=2&&r<=4&&c>=2&&c<=4));
        let rr=row+r,cc=col+c;
        if(rr>=0&&rr<n&&cc>=0&&cc<n)setMod(rr,cc,v);
      }
    }
    finderPattern(0,0);finderPattern(0,n-7);finderPattern(n-7,0);
    for(let i=8;i<n-8;i++){setMod(6,i,i%2===0);setMod(i,6,i%2===0);}
    setMod(n-8,8,1);
    let bits=[];for(let i=0;i<data.length;i++){let b=data.charCodeAt(i);for(let j=7;j>=0;j--)bits.push((b>>j)&1);}
    let idx=0;let upward=true;
    for(let col=n-1;col>=1;col-=2){
      if(col===6)col=5;
      let rows=upward?Array.from({length:n},(_,i)=>n-1-i):Array.from({length:n},(_,i)=>i);
      for(let row of rows){
        for(let dc=0;dc<=1;dc++){
          let c=col-dc;
          if(m[row][c]===0){setMod(row,c,idx<bits.length?bits[idx]:0);idx++;}
        }
      }
      upward=!upward;
    }
    return m;
  }
  function rend(){
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">QR Code Generator</span><button onclick="document.getElementById(\'qr-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<input id="qr-text-in" value="'+esc(txt)+'" placeholder="URL or text..." style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);margin-bottom:8px;box-sizing:border-box">'
      +'<div style="display:flex;gap:8px;margin-bottom:12px;align-items:center"><label style="color:var(--text-muted);font-size:11px">Size:</label><input id="qr-size-in" type="range" min="100" max="400" value="'+sz+'" style="flex:1"><span id="qr-size-lbl" style="color:var(--text-muted);font-size:11px;min-width:32px">'+sz+'</span></div>'
      +'<div id="qr-preview" style="display:flex;justify-content:center;padding:16px;background:white;border-radius:var(--radius);margin-bottom:8px">'+gen()+'</div>'
      +'<div style="display:flex;gap:6px"><button id="qr-copy-btn" style="flex:1;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy SVG</button></div>';
    document.getElementById('qr-text-in').oninput=function(){txt=this.value;S._qrText=txt;save();document.getElementById('qr-preview').innerHTML=gen();};
    document.getElementById('qr-size-in').oninput=function(){sz=parseInt(this.value);S._qrSize=sz;save();document.getElementById('qr-size-lbl').textContent=sz;document.getElementById('qr-preview').innerHTML=gen();};
    document.getElementById('qr-copy-btn').onclick=function(){let svg=document.getElementById('qr-preview').innerHTML;navigator.clipboard.writeText(svg);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy SVG';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskWIPHistory(){
  let p=document.getElementById('wip-hist-panel');if(p)p.remove();
  p=document.createElement('div');p.id='wip-hist-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let weeks=12;
  let now=new Date();
  let data=[];
  for(let w=weeks-1;w>=0;w--){
    let wEnd=new Date(now);wEnd.setDate(wEnd.getDate()-w*7);
    let wStart=new Date(wEnd);wStart.setDate(wStart.getDate()-7);
    let label=(wEnd.getMonth()+1)+'/'+wEnd.getDate();
    let inProgress=0;
    tasks.forEach(t=>{
      let created=new Date(t.created||t.id);
      let isDone=t.status==='done';
      let doneDate=t.completedAt?new Date(t.completedAt):null;
      if(created<=wEnd && (!isDone || (doneDate && doneDate>wEnd))){
        if(t.status==='in-progress'||(created<=wEnd && !isDone))inProgress++;
      }
    });
    data.push({label,wip:inProgress});
  }
  let maxW=Math.max(...data.map(d=>d.wip),1);
  let svgW=480,svgH=200,pad=30;
  let barW=(svgW-pad*2)/data.length*0.7;
  let gap=(svgW-pad*2)/data.length;
  let bars='';
  data.forEach((d,i)=>{
    let x=pad+i*gap+gap*0.15;
    let h=(d.wip/maxW)*(svgH-pad*2);
    let y=svgH-pad-h;
    bars+='<rect x="'+x+'" y="'+y+'" width="'+barW+'" height="'+h+'" fill="#4ade80" rx="2"/>';
    bars+='<text x="'+(x+barW/2)+'" y="'+(svgH-pad+14)+'" text-anchor="middle" fill="#888" font-size="9">'+d.label+'</text>';
    bars+='<text x="'+(x+barW/2)+'" y="'+(y-4)+'" text-anchor="middle" fill="#4ade80" font-size="10">'+d.wip+'</text>';
  });
  let svg='<svg viewBox="0 0 '+svgW+' '+svgH+'" style="width:100%"><rect width="'+svgW+'" height="'+svgH+'" fill="transparent"/>'+bars+'</svg>';
  let total=tasks.filter(t=>t.status!=='done').length;
  let ip=tasks.filter(t=>t.status==='in-progress').length;
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">WIP History (12 Weeks)</span><button onclick="document.getElementById(\'wip-hist-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:16px;margin-bottom:12px"><div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);flex:1;text-align:center"><div style="font-size:20px;font-weight:700;color:#4ade80">'+ip+'</div><div style="font-size:10px;color:var(--text-muted)">In Progress</div></div><div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);flex:1;text-align:center"><div style="font-size:20px;font-weight:700;color:var(--text-primary)">'+total+'</div><div style="font-size:10px;color:var(--text-muted)">Open Tasks</div></div></div>'
    +svg;
  document.body.appendChild(p);
}
function showQuickEyeBreak(){
  let p=document.getElementById('eye-break-panel');if(p)p.remove();
  p=document.createElement('div');p.id='eye-break-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px';
  let phase=0;let timer=null;let secs=20;
  let exercises=[
    {name:'20-20-20 Rule',desc:'Look at something 20 feet away for 20 seconds',dur:20},
    {name:'Blink Break',desc:'Blink rapidly 15 times then close eyes',dur:15},
    {name:'Eye Circles',desc:'Roll your eyes in slow circles',dur:15},
    {name:'Palm Rest',desc:'Cover eyes with warm palms, relax',dur:30},
    {name:'Focus Shift',desc:'Focus near (thumb) then far, alternate',dur:20}
  ];
  let ex=exercises[Math.floor(Math.random()*exercises.length)];
  function rend(){
    if(phase===0){
      p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Eye Break</span><button onclick="document.getElementById(\'eye-break-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
        +'<div style="text-align:center;padding:12px 0"><div style="font-size:14px;font-weight:600;color:#4ade80;margin-bottom:6px">'+esc(ex.name)+'</div><div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">'+esc(ex.desc)+'</div><button id="eye-start-btn" style="padding:8px 20px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Start ('+ex.dur+'s)</button></div>';
      document.getElementById('eye-start-btn').onclick=function(){phase=1;secs=ex.dur;startTimer();};
    } else if(phase===1){
      let pct=((ex.dur-secs)/ex.dur)*100;
      p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Eye Break</span><button onclick="clearInterval(window._eyeTimer);document.getElementById(\'eye-break-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
        +'<div style="text-align:center;padding:8px 0"><div style="font-size:13px;color:#4ade80;margin-bottom:8px">'+esc(ex.name)+'</div>'
        +'<div style="font-size:36px;font-weight:700;color:var(--text-primary);margin-bottom:8px">'+secs+'s</div>'
        +'<div style="height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:#4ade80;transition:width 1s linear"></div></div></div>';
    } else {
      if(timer)clearInterval(timer);
      p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Eye Break</span><button onclick="document.getElementById(\'eye-break-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
        +'<div style="text-align:center;padding:12px 0"><div style="font-size:16px;color:#4ade80;margin-bottom:6px">Done!</div><div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Great job. Your eyes thank you.</div><button onclick="document.getElementById(\'eye-break-panel\').remove()" style="padding:6px 16px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);cursor:pointer">Close</button></div>';
    }
  }
  function startTimer(){
    rend();
    window._eyeTimer=setInterval(()=>{secs--;if(secs<=0){phase=2;clearInterval(window._eyeTimer);}rend();},1000);
    timer=window._eyeTimer;
  }
  document.body.appendChild(p);
  rend();
}
function showCurlGenerator(){
  let p=document.getElementById('curl-gen-panel');if(p)p.remove();
  p=document.createElement('div');p.id='curl-gen-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let cfg=S._curlCfg||{method:'GET',url:'https://api.example.com/data',headers:[{k:'Content-Type',v:'application/json'}],body:''};
  function gen(){
    let c='curl';
    if(cfg.method!=='GET')c+=' -X '+cfg.method;
    cfg.headers.forEach(h=>{if(h.k&&h.v)c+=" -H '"+h.k+': '+h.v+"'";});
    if(cfg.body&&(cfg.method==='POST'||cfg.method==='PUT'||cfg.method==='PATCH'))c+=" -d '"+cfg.body+"'";
    c+=' "'+cfg.url+'"';
    return c;
  }
  function rend(){
    let hdrs=cfg.headers.map((h,i)=>'<div style="display:flex;gap:4px;margin-bottom:4px"><input data-hi="'+i+'" data-hf="k" value="'+esc(h.k)+'" placeholder="Key" style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:11px"><input data-hi="'+i+'" data-hf="v" value="'+esc(h.v)+'" placeholder="Value" style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:11px"><button data-hd="'+i+'" style="background:none;border:none;color:#f87171;cursor:pointer;font-size:14px">x</button></div>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">cURL Generator</span><button onclick="document.getElementById(\'curl-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;gap:6px;margin-bottom:8px"><select id="curl-method" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary)">'+['GET','POST','PUT','PATCH','DELETE','HEAD','OPTIONS'].map(m=>'<option'+(m===cfg.method?' selected':'')+'>'+m+'</option>').join('')+'</select><input id="curl-url" value="'+esc(cfg.url)+'" placeholder="URL" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:12px"></div>'
      +'<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:11px;color:var(--text-muted)">Headers</span><button id="curl-add-h" style="font-size:10px;padding:2px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);cursor:pointer">+ Add</button></div>'+hdrs+'</div>'
      +'<div style="margin-bottom:8px"><span style="font-size:11px;color:var(--text-muted)">Body</span><textarea id="curl-body" rows="3" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-top:4px">'+esc(cfg.body)+'</textarea></div>'
      +'<div style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:8px;font-family:monospace;font-size:11px;color:#4ade80;word-break:break-all;line-height:1.5">'+esc(gen())+'</div>'
      +'<button id="curl-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy Command</button>';
    document.getElementById('curl-method').onchange=function(){cfg.method=this.value;S._curlCfg=cfg;save();rend();};
    document.getElementById('curl-url').oninput=function(){cfg.url=this.value;S._curlCfg=cfg;save();rend();};
    document.getElementById('curl-body').oninput=function(){cfg.body=this.value;S._curlCfg=cfg;save();};
    document.getElementById('curl-add-h').onclick=function(){cfg.headers.push({k:'',v:''});S._curlCfg=cfg;save();rend();};
    document.getElementById('curl-copy').onclick=function(){navigator.clipboard.writeText(gen());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy Command';},1200);};
    p.querySelectorAll('[data-hd]').forEach(b=>{b.onclick=function(){cfg.headers.splice(parseInt(this.dataset.hd),1);S._curlCfg=cfg;save();rend();};});
    p.querySelectorAll('[data-hi]').forEach(inp=>{inp.oninput=function(){let i=parseInt(this.dataset.hi);cfg.headers[i][this.dataset.hf]=this.value;S._curlCfg=cfg;save();};});
  }
  document.body.appendChild(p);
  rend();
}
function showTaskAgeDistribution(){
  let p=document.getElementById('task-age-panel');if(p)p.remove();
  p=document.createElement('div');p.id='task-age-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  let now=Date.now();
  let buckets=[
    {label:'< 1 day',max:86400000,count:0,color:'#4ade80'},
    {label:'1-3 days',max:259200000,count:0,color:'#22d3ee'},
    {label:'3-7 days',max:604800000,count:0,color:'#a78bfa'},
    {label:'1-2 weeks',max:1209600000,count:0,color:'#fbbf24'},
    {label:'2-4 weeks',max:2419200000,count:0,color:'#fb923c'},
    {label:'> 1 month',max:Infinity,count:0,color:'#f87171'}
  ];
  tasks.forEach(t=>{
    let age=now-(t.created||Date.parse(t.id)||now);
    for(let b of buckets){if(age<b.max){b.count++;break;}}
  });
  let maxC=Math.max(...buckets.map(b=>b.count),1);
  let rows=buckets.map(b=>{
    let pct=Math.round(b.count/maxC*100);
    return '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="min-width:80px;font-size:11px;color:var(--text-muted);text-align:right">'+b.label+'</span><div style="flex:1;height:18px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+b.color+';border-radius:3px;transition:width 0.3s"></div></div><span style="min-width:24px;font-size:11px;color:var(--text-primary);font-weight:600">'+b.count+'</span></div>';
  }).join('');
  let avg=tasks.length?Math.round(tasks.reduce((s,t)=>s+(now-(t.created||Date.parse(t.id)||now)),0)/tasks.length/86400000):0;
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Age Distribution</span><button onclick="document.getElementById(\'task-age-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:12px;margin-bottom:14px"><div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);text-align:center;flex:1"><div style="font-size:18px;font-weight:700;color:#4ade80">'+tasks.length+'</div><div style="font-size:10px;color:var(--text-muted)">Open Tasks</div></div><div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);text-align:center;flex:1"><div style="font-size:18px;font-weight:700;color:var(--text-primary)">'+avg+'d</div><div style="font-size:10px;color:var(--text-muted)">Avg Age</div></div></div>'
    +rows;
  document.body.appendChild(p);
}
function showQuickWhiteNoise(){
  let p=document.getElementById('white-noise-panel');if(p)p.remove();
  p=document.createElement('div');p.id='white-noise-panel';
  p.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:240px';
  let playing=false;let ctx=null;let node=null;let gain=null;
  let vol=S._wnVol||0.3;
  let type=S._wnType||'white';
  function start(){
    ctx=new(window.AudioContext||window.webkitAudioContext)();
    let bufSize=4096;
    node=ctx.createScriptProcessor(bufSize,1,1);
    gain=ctx.createGain();
    gain.gain.value=vol;
    let b1=0;let b2=0;let b3=0;let b4=0;let b5=0;let b6=0;
    node.onaudioprocess=function(e){
      let out=e.outputBuffer.getChannelData(0);
      for(let i=0;i<bufSize;i++){
        let white=Math.random()*2-1;
        if(type==='white'){out[i]=white;}
        else if(type==='pink'){
          b0=0.99886*b1+white*0.0555179;b1=b0;
          b2=0.99332*b2+white*0.0750759;
          b3=0.96900*b3+white*0.1538520;
          b4=0.86650*b4+white*0.3104856;
          b5=0.55000*b5+white*0.5329522;
          b6=-0.7616*b6-white*0.0168980;
          out[i]=(b0+b2+b3+b4+b5+b6+white*0.5362)*0.11;
        } else {
          b0=b1+(0.02*(white-b1));b1=b0;out[i]=b0*3.5;
        }
      }
    };
    node.connect(gain);gain.connect(ctx.destination);
    playing=true;
  }
  function stop(){if(ctx){node.disconnect();gain.disconnect();ctx.close();ctx=null;playing=false;}}
  function rend(){
    let types=['white','pink','brown'];
    let btns=types.map(t=>'<button data-nt="'+t+'" style="padding:4px 10px;border-radius:var(--radius);border:1px solid '+(type===t?'#4ade80':'var(--border)')+';background:'+(type===t?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(type===t?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:11px">'+t+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">White Noise</span><button onclick="if(window._wnStop)window._wnStop();document.getElementById(\'white-noise-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="display:flex;gap:4px;margin-bottom:10px;justify-content:center">'+btns+'</div>'
      +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><span style="font-size:10px;color:var(--text-muted)">Vol</span><input id="wn-vol" type="range" min="0" max="100" value="'+Math.round(vol*100)+'" style="flex:1"><span id="wn-vol-lbl" style="font-size:10px;color:var(--text-muted);min-width:28px">'+Math.round(vol*100)+'%</span></div>'
      +'<button id="wn-toggle" style="width:100%;padding:8px;background:'+(playing?'#f87171':'#4ade80')+';color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">'+(playing?'Stop':'Play')+'</button>';
    p.querySelectorAll('[data-nt]').forEach(b=>{b.onclick=function(){type=this.dataset.nt;S._wnType=type;save();if(playing){stop();start();}rend();};});
    document.getElementById('wn-vol').oninput=function(){vol=parseInt(this.value)/100;S._wnVol=vol;save();document.getElementById('wn-vol-lbl').textContent=Math.round(vol*100)+'%';if(gain)gain.gain.value=vol;};
    document.getElementById('wn-toggle').onclick=function(){if(playing)stop();else start();rend();};
  }
  window._wnStop=stop;
  document.body.appendChild(p);
  rend();
}
function showFetchGenerator(){
  let p=document.getElementById('fetch-gen-panel');if(p)p.remove();
  p=document.createElement('div');p.id='fetch-gen-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:540px;width:90vw;max-height:80vh;overflow-y:auto';
  let cfg=S._fetchCfg||{method:'GET',url:'https://api.example.com/data',headers:[{k:'Content-Type',v:'application/json'}],body:'',async:true,errorHandling:true};
  function gen(){
    let lines=[];
    if(cfg.async)lines.push('async function fetchData() {');
    else lines.push('function fetchData() {');
    let opts=[];
    if(cfg.method!=='GET')opts.push("    method: '"+cfg.method+"'");
    if(cfg.headers.filter(h=>h.k&&h.v).length){
      opts.push('    headers: {');
      cfg.headers.filter(h=>h.k&&h.v).forEach((h,i,a)=>{opts.push("      '"+h.k+"': '"+h.v+"'"+(i<a.length-1?',':''));});
      opts.push('    }');
    }
    if(cfg.body&&cfg.method!=='GET')opts.push("    body: JSON.stringify("+cfg.body+")");
    if(cfg.async){
      if(cfg.errorHandling)lines.push('  try {');
      let indent=cfg.errorHandling?'    ':'  ';
      if(opts.length){
        lines.push(indent+"const response = await fetch('"+cfg.url+"', {");
        opts.forEach(o=>lines.push(indent+o.trim()));
        lines.push(indent+'});');
      } else {
        lines.push(indent+"const response = await fetch('"+cfg.url+"');");
      }
      lines.push(indent+'if (!response.ok) throw new Error(`HTTP ${response.status}`);');
      lines.push(indent+'const data = await response.json();');
      lines.push(indent+'return data;');
      if(cfg.errorHandling){lines.push('  } catch (error) {');lines.push('    console.error(error);');lines.push('    throw error;');lines.push('  }');}
    } else {
      if(opts.length){
        lines.push("  return fetch('"+cfg.url+"', {");
        opts.forEach(o=>lines.push('  '+o.trim()));
        lines.push('  })');
      } else {
        lines.push("  return fetch('"+cfg.url+"')");
      }
      lines.push('    .then(res => {');
      lines.push('      if (!res.ok) throw new Error(`HTTP ${res.status}`);');
      lines.push('      return res.json();');
      lines.push('    })');
      if(cfg.errorHandling){lines.push('    .catch(err => {');lines.push('      console.error(err);');lines.push('      throw err;');lines.push('    });');}
      else lines[lines.length-1]+=';';
    }
    lines.push('}');
    return lines.join('\n');
  }
  function rend(){
    let code=gen();
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Fetch API Generator</span><button onclick="document.getElementById(\'fetch-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;gap:6px;margin-bottom:8px"><select id="fetch-method" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary)">'+['GET','POST','PUT','PATCH','DELETE'].map(m=>'<option'+(m===cfg.method?' selected':'')+'>'+m+'</option>').join('')+'</select><input id="fetch-url" value="'+esc(cfg.url)+'" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:12px"></div>'
      +'<div style="display:flex;gap:12px;margin-bottom:8px"><label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text-muted);cursor:pointer"><input type="checkbox" id="fetch-async" '+(cfg.async?'checked':'')+' style="cursor:pointer"> async/await</label><label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text-muted);cursor:pointer"><input type="checkbox" id="fetch-err" '+(cfg.errorHandling?'checked':'')+' style="cursor:pointer"> Error handling</label></div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.5">'+esc(code)+'</pre>'
      +'<button id="fetch-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy Code</button>';
    document.getElementById('fetch-method').onchange=function(){cfg.method=this.value;S._fetchCfg=cfg;save();rend();};
    document.getElementById('fetch-url').oninput=function(){cfg.url=this.value;S._fetchCfg=cfg;save();};
    document.getElementById('fetch-async').onchange=function(){cfg.async=this.checked;S._fetchCfg=cfg;save();rend();};
    document.getElementById('fetch-err').onchange=function(){cfg.errorHandling=this.checked;S._fetchCfg=cfg;save();rend();};
    document.getElementById('fetch-copy').onclick=function(){navigator.clipboard.writeText(code);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy Code';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskPriorityHistory(){
  let p=document.getElementById('prio-hist-panel');if(p)p.remove();
  p=document.createElement('div');p.id='prio-hist-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let weeks=8;let now=new Date();
  let data=[];
  let colors={p0:'#f87171',p1:'#fb923c',p2:'#60a5fa',p3:'#6b7280'};
  for(let w=weeks-1;w>=0;w--){
    let wEnd=new Date(now);wEnd.setDate(wEnd.getDate()-w*7);
    let label=(wEnd.getMonth()+1)+'/'+wEnd.getDate();
    let counts={p0:0,p1:0,p2:0,p3:0};
    tasks.forEach(t=>{
      let created=new Date(t.created||t.id);
      if(created<=wEnd){
        let prio=t.priority||'p3';
        if(counts[prio]!==undefined)counts[prio]++;
      }
    });
    data.push({label,...counts});
  }
  let svgW=460,svgH=220,pad=35;
  let maxT=Math.max(...data.map(d=>d.p0+d.p1+d.p2+d.p3),1);
  let gap=(svgW-pad*2)/data.length;
  let barW=gap*0.6;
  let bars='';
  data.forEach((d,i)=>{
    let x=pad+i*gap+gap*0.2;
    let total=d.p0+d.p1+d.p2+d.p3;
    let y=svgH-pad;
    ['p3','p2','p1','p0'].forEach(pk=>{
      let h=(d[pk]/maxT)*(svgH-pad*2);
      y-=h;
      bars+='<rect x="'+x+'" y="'+y+'" width="'+barW+'" height="'+h+'" fill="'+colors[pk]+'" rx="1"/>';
    });
    bars+='<text x="'+(x+barW/2)+'" y="'+(svgH-pad+14)+'" text-anchor="middle" fill="#888" font-size="9">'+d.label+'</text>';
    bars+='<text x="'+(x+barW/2)+'" y="'+(svgH-pad-((total/maxT)*(svgH-pad*2))-4)+'" text-anchor="middle" fill="#ccc" font-size="9">'+total+'</text>';
  });
  let legend=['p0: Critical','p1: High','p2: Medium','p3: Low'].map((l,i)=>{
    let c=[colors.p0,colors.p1,colors.p2,colors.p3][i];
    return '<span style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text-muted)"><span style="width:8px;height:8px;background:'+c+';border-radius:2px;display:inline-block"></span>'+l+'</span>';
  }).join('');
  let svg='<svg viewBox="0 0 '+svgW+' '+svgH+'" style="width:100%"><rect width="'+svgW+'" height="'+svgH+'" fill="transparent"/>'+bars+'</svg>';
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Priority History (8 Weeks)</span><button onclick="document.getElementById(\'prio-hist-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:12px;justify-content:center;margin-bottom:10px">'+legend+'</div>'
    +svg;
  document.body.appendChild(p);
}
function showQuickStretch(){
  let p=document.getElementById('stretch-panel');if(p)p.remove();
  p=document.createElement('div');p.id='stretch-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px';
  let stretches=[
    {name:'Neck Roll',desc:'Slowly roll your head in a circle, 5 each direction',dur:30},
    {name:'Shoulder Shrugs',desc:'Raise shoulders to ears, hold 3s, release. Repeat 10x',dur:30},
    {name:'Wrist Circles',desc:'Extend arms, circle wrists slowly. 10 each direction',dur:20},
    {name:'Chest Opener',desc:'Clasp hands behind back, squeeze shoulder blades, lift arms',dur:20},
    {name:'Seated Twist',desc:'Cross one leg, twist torso toward knee. Hold 15s each side',dur:30},
    {name:'Standing Hamstring',desc:'Place heel on desk edge, lean forward gently. 15s each',dur:30},
    {name:'Finger Stretches',desc:'Spread fingers wide, hold 5s. Make fists, hold 5s. Repeat 5x',dur:20},
    {name:'Cat-Cow Seated',desc:'Round back (cat), arch back (cow). Slow breathing. 8 reps',dur:25}
  ];
  let idx=Math.floor(Math.random()*stretches.length);
  let ex=stretches[idx];
  let phase=0;let secs=ex.dur;let timer=null;
  function rend(){
    if(phase===0){
      p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Desk Stretch</span><button onclick="document.getElementById(\'stretch-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
        +'<div style="text-align:center;padding:8px 0"><div style="font-size:14px;font-weight:600;color:#4ade80;margin-bottom:6px">'+esc(ex.name)+'</div><div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;line-height:1.4">'+esc(ex.desc)+'</div>'
        +'<div style="display:flex;gap:6px;justify-content:center"><button id="str-start" style="padding:8px 20px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Start ('+ex.dur+'s)</button><button id="str-skip" style="padding:8px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:11px">Skip</button></div></div>';
      document.getElementById('str-start').onclick=function(){phase=1;secs=ex.dur;startTimer();};
      document.getElementById('str-skip').onclick=function(){idx=(idx+1)%stretches.length;ex=stretches[idx];secs=ex.dur;rend();};
    } else if(phase===1){
      let pct=((ex.dur-secs)/ex.dur)*100;
      p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Desk Stretch</span><button onclick="clearInterval(window._strTimer);document.getElementById(\'stretch-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
        +'<div style="text-align:center;padding:8px 0"><div style="font-size:13px;color:#4ade80;margin-bottom:4px">'+esc(ex.name)+'</div><div style="font-size:32px;font-weight:700;color:var(--text-primary);margin-bottom:6px">'+secs+'s</div>'
        +'<div style="height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:#4ade80;transition:width 1s linear"></div></div></div>';
    } else {
      p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Desk Stretch</span><button onclick="document.getElementById(\'stretch-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
        +'<div style="text-align:center;padding:12px 0"><div style="font-size:16px;color:#4ade80;margin-bottom:6px">Great stretch!</div><div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Keep your body happy while you code.</div>'
        +'<div style="display:flex;gap:6px;justify-content:center"><button onclick="document.getElementById(\'stretch-panel\').remove()" style="padding:6px 16px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);cursor:pointer">Close</button></div></div>';
    }
  }
  function startTimer(){
    rend();
    window._strTimer=setInterval(()=>{secs--;if(secs<=0){phase=2;clearInterval(window._strTimer);}rend();},1000);
    timer=window._strTimer;
  }
  document.body.appendChild(p);
  rend();
}
function showConsoleLogGen(){
  let p=document.getElementById('clog-gen-panel');if(p)p.remove();
  p=document.createElement('div');p.id='clog-gen-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let templates=[
    {name:'Basic Log',code:'console.log("value:", variable);',desc:'Simple value inspection'},
    {name:'Table',code:'console.table(arrayOrObject);',desc:'Display data in table format'},
    {name:'Group',code:'console.group("Label");\nconsole.log("detail1:", val1);\nconsole.log("detail2:", val2);\nconsole.groupEnd();',desc:'Grouped log output'},
    {name:'Timer',code:'console.time("operation");\n// ... code to measure ...\nconsole.timeEnd("operation");',desc:'Measure execution time'},
    {name:'Styled',code:'console.log("%c Custom Message ", "background:#4ade80;color:#000;padding:2px 6px;border-radius:3px;font-weight:bold");',desc:'Styled console output'},
    {name:'Assert',code:'console.assert(condition, "Assertion failed:", { expected, actual });',desc:'Log only when condition fails'},
    {name:'Trace',code:'console.trace("Stack trace at this point");',desc:'Print stack trace'},
    {name:'Count',code:'console.count("function-name");  // logs how many times called',desc:'Count invocations'},
    {name:'Dir',code:'console.dir(domElement, { depth: 3 });',desc:'Inspect object with depth'},
    {name:'Debug Block',code:'const DEBUG = true;\nfunction dbg(...args) { if(DEBUG) console.log("[DBG]", ...args); }\ndbg("message", data);',desc:'Conditional debug wrapper'}
  ];
  let rows=templates.map(t=>'<div style="padding:10px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:6px;cursor:pointer" data-code="'+esc(t.code)+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-weight:600;color:var(--text-primary);font-size:12px">'+esc(t.name)+'</span><span style="font-size:10px;color:var(--text-muted)">'+esc(t.desc)+'</span></div><pre style="margin:0;font-size:10px;color:#4ade80;background:#0a0a0f;padding:6px 8px;border-radius:3px;overflow-x:auto;white-space:pre">'+esc(t.code)+'</pre></div>').join('');
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Console.log Templates</span><button onclick="document.getElementById(\'clog-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="font-size:10px;color:var(--text-muted);margin-bottom:10px">Click any template to copy to clipboard</div>'
    +rows;
  p.querySelectorAll('[data-code]').forEach(el=>{
    el.onclick=function(){
      navigator.clipboard.writeText(this.dataset.code);
      let orig=this.style.border;this.style.border='1px solid #4ade80';
      setTimeout(()=>{this.style.border=orig;},600);
    };
  });
  document.body.appendChild(p);
}
function showTaskFlowEfficiency(){
  let p=document.getElementById('flow-eff-panel');if(p)p.remove();
  p=document.createElement('div');p.id='flow-eff-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let done=tasks.filter(t=>t.status==='done');
  let total=tasks.length;
  let doneCount=done.length;
  let inProg=tasks.filter(t=>t.status==='in-progress').length;
  let todo=tasks.filter(t=>t.status==='todo'||t.status==='backlog').length;
  let blocked=tasks.filter(t=>t.blockedBy&&t.blockedBy.length>0&&t.status!=='done').length;
  let overdue=tasks.filter(t=>{if(!t.due||t.status==='done')return false;return new Date(t.due)<new Date();}).length;
  let throughput=0;
  if(done.length){
    let earliest=Infinity;let latest=0;
    done.forEach(t=>{
      let d=t.completedAt?new Date(t.completedAt).getTime():(t.created||Date.now());
      if(d<earliest)earliest=d;if(d>latest)latest=d;
    });
    let weeks=Math.max((latest-earliest)/604800000,1);
    throughput=Math.round(done.length/weeks*10)/10;
  }
  let flowEff=total>0?Math.round(doneCount/total*100):0;
  let wipRatio=total>0?Math.round(inProg/Math.max(total-doneCount,1)*100):0;
  let metrics=[
    {label:'Flow Efficiency',value:flowEff+'%',color:flowEff>70?'#4ade80':flowEff>40?'#fbbf24':'#f87171',desc:'Done / Total tasks'},
    {label:'Throughput',value:throughput+'/wk',color:'#22d3ee',desc:'Tasks completed per week'},
    {label:'WIP Ratio',value:wipRatio+'%',color:wipRatio<50?'#4ade80':wipRatio<80?'#fbbf24':'#f87171',desc:'In-progress vs open tasks'},
    {label:'Blocked',value:blocked+'',color:blocked===0?'#4ade80':'#f87171',desc:'Tasks with unresolved dependencies'},
    {label:'Overdue',value:overdue+'',color:overdue===0?'#4ade80':'#f87171',desc:'Tasks past due date'},
    {label:'Completion Rate',value:doneCount+'/'+total,color:'#a78bfa',desc:'Total tasks done vs created'}
  ];
  let cards=metrics.map(m=>'<div style="padding:10px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:22px;font-weight:700;color:'+m.color+'">'+m.value+'</div><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-top:2px">'+m.label+'</div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">'+m.desc+'</div></div>').join('');
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Flow Efficiency Dashboard</span><button onclick="document.getElementById(\'flow-eff-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">'+cards+'</div>';
  document.body.appendChild(p);
}
function showQuickGratitude(){
  let p=document.getElementById('gratitude-panel');if(p)p.remove();
  p=document.createElement('div');p.id='gratitude-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px';
  if(!S._gratitude)S._gratitude=[];
  let today=new Date().toISOString().slice(0,10);
  let todayEntries=S._gratitude.filter(g=>g.date===today);
  function rend(){
    todayEntries=S._gratitude.filter(g=>g.date===today);
    let list=todayEntries.map((g,i)=>'<div style="display:flex;gap:6px;align-items:flex-start;padding:4px 0;border-bottom:1px solid var(--border)"><span style="color:#4ade80;font-size:11px;min-width:14px">'+(i+1)+'.</span><span style="font-size:11px;color:var(--text-primary);flex:1">'+esc(g.text)+'</span></div>').join('');
    let streak=0;
    let d=new Date();
    while(true){
      let ds=d.toISOString().slice(0,10);
      if(S._gratitude.some(g=>g.date===ds)){streak++;d.setDate(d.getDate()-1);}
      else break;
    }
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Gratitude Journal</span><button onclick="document.getElementById(\'gratitude-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="display:flex;gap:8px;margin-bottom:10px"><div style="flex:1;padding:6px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:16px;font-weight:700;color:#4ade80">'+todayEntries.length+'</div><div style="font-size:9px;color:var(--text-muted)">Today</div></div><div style="flex:1;padding:6px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:16px;font-weight:700;color:#22d3ee">'+streak+'</div><div style="font-size:9px;color:var(--text-muted)">Day Streak</div></div></div>'
      +(list||'<div style="font-size:11px;color:var(--text-muted);text-align:center;padding:8px 0">No entries yet today</div>')
      +'<div style="margin-top:8px"><input id="grat-input" placeholder="I am grateful for..." style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;box-sizing:border-box"><button id="grat-add" style="width:100%;margin-top:4px;padding:6px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:11px">Add Entry</button></div>';
    document.getElementById('grat-add').onclick=function(){
      let v=document.getElementById('grat-input').value.trim();
      if(!v)return;
      S._gratitude.push({text:v,date:today,ts:Date.now()});
      save();rend();
    };
    document.getElementById('grat-input').onkeydown=function(e){if(e.key==='Enter'){document.getElementById('grat-add').click();}};
  }
  document.body.appendChild(p);
  rend();
}
function showHttpStatusRef(){
  let p=document.getElementById('http-status-panel');if(p)p.remove();
  p=document.createElement('div');p.id='http-status-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let groups=[
    {label:'1xx Informational',color:'#94a3b8',codes:[
      {c:100,t:'Continue'},{c:101,t:'Switching Protocols'},{c:102,t:'Processing'},{c:103,t:'Early Hints'}
    ]},
    {label:'2xx Success',color:'#4ade80',codes:[
      {c:200,t:'OK'},{c:201,t:'Created'},{c:202,t:'Accepted'},{c:204,t:'No Content'},{c:206,t:'Partial Content'},{c:207,t:'Multi-Status'}
    ]},
    {label:'3xx Redirection',color:'#22d3ee',codes:[
      {c:301,t:'Moved Permanently'},{c:302,t:'Found'},{c:304,t:'Not Modified'},{c:307,t:'Temporary Redirect'},{c:308,t:'Permanent Redirect'}
    ]},
    {label:'4xx Client Error',color:'#fbbf24',codes:[
      {c:400,t:'Bad Request'},{c:401,t:'Unauthorized'},{c:403,t:'Forbidden'},{c:404,t:'Not Found'},{c:405,t:'Method Not Allowed'},{c:408,t:'Request Timeout'},{c:409,t:'Conflict'},{c:410,t:'Gone'},{c:413,t:'Payload Too Large'},{c:415,t:'Unsupported Media Type'},{c:418,t:'I\'m a Teapot'},{c:422,t:'Unprocessable Entity'},{c:429,t:'Too Many Requests'},{c:451,t:'Unavailable For Legal Reasons'}
    ]},
    {label:'5xx Server Error',color:'#f87171',codes:[
      {c:500,t:'Internal Server Error'},{c:501,t:'Not Implemented'},{c:502,t:'Bad Gateway'},{c:503,t:'Service Unavailable'},{c:504,t:'Gateway Timeout'}
    ]}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">HTTP Status Codes</span><button onclick="document.getElementById(\'http-status-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<input id="http-search" placeholder="Search codes..." style="width:100%;padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:12px;margin-bottom:10px;box-sizing:border-box">';
  groups.forEach(g=>{
    html+='<div style="margin-bottom:10px"><div style="font-size:11px;font-weight:600;color:'+g.color+';margin-bottom:4px;padding:4px 0;border-bottom:1px solid var(--border)">'+g.label+'</div>';
    g.codes.forEach(c=>{
      html+='<div class="http-code-row" data-code="'+c.c+'" data-text="'+esc(c.t.toLowerCase())+'" style="display:flex;align-items:center;gap:8px;padding:4px 6px;cursor:pointer;border-radius:3px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'transparent\'"><span style="font-family:monospace;font-weight:700;color:'+g.color+';min-width:36px;font-size:12px">'+c.c+'</span><span style="font-size:11px;color:var(--text-primary)">'+esc(c.t)+'</span></div>';
    });
    html+='</div>';
  });
  p.innerHTML=html;
  p.querySelectorAll('.http-code-row').forEach(r=>{
    r.onclick=function(){navigator.clipboard.writeText(this.dataset.code);let orig=this.style.background;this.style.background='rgba(74,222,128,0.2)';setTimeout(()=>{this.style.background=orig;},400);};
  });
  document.getElementById('http-search').oninput=function(){
    let q=this.value.toLowerCase();
    p.querySelectorAll('.http-code-row').forEach(r=>{
      let show=r.dataset.code.includes(q)||r.dataset.text.includes(q);
      r.style.display=show?'flex':'none';
    });
  };
  document.body.appendChild(p);
}
function showTaskRecurrenceSummary(){
  let p=document.getElementById('recur-sum-panel');if(p)p.remove();
  p=document.createElement('div');p.id='recur-sum-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let recurring=tasks.filter(t=>t.recurrence&&t.recurrence!=='none');
  let byType={};
  recurring.forEach(t=>{
    let r=t.recurrence||'unknown';
    if(!byType[r])byType[r]={count:0,tasks:[]};
    byType[r].count++;
    byType[r].tasks.push(t);
  });
  let types=Object.keys(byType).sort((a,b)=>byType[b].count-byType[a].count);
  let colors={daily:'#4ade80',weekday:'#22d3ee',weekly:'#a78bfa',biweekly:'#fbbf24',monthly:'#fb923c'};
  let rows=types.map(t=>{
    let info=byType[t];
    let c=colors[t]||'#94a3b8';
    let taskList=info.tasks.map(tk=>'<div style="font-size:10px;color:var(--text-muted);padding:2px 0;padding-left:12px">- '+esc(tk.title)+'</div>').join('');
    return '<div style="margin-bottom:8px;padding:8px;background:var(--bg-surface);border-radius:var(--radius);border-left:3px solid '+c+'"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:600;color:var(--text-primary);font-size:12px;text-transform:capitalize">'+t+'</span><span style="font-size:12px;font-weight:700;color:'+c+'">'+info.count+'</span></div>'+taskList+'</div>';
  }).join('');
  if(!rows)rows='<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:12px">No recurring tasks found</div>';
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Recurrence Summary</span><button onclick="document.getElementById(\'recur-sum-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:12px;margin-bottom:12px"><div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);text-align:center;flex:1"><div style="font-size:20px;font-weight:700;color:#4ade80">'+recurring.length+'</div><div style="font-size:10px;color:var(--text-muted)">Recurring</div></div><div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);text-align:center;flex:1"><div style="font-size:20px;font-weight:700;color:var(--text-primary)">'+types.length+'</div><div style="font-size:10px;color:var(--text-muted)">Patterns</div></div></div>'
    +rows;
  document.body.appendChild(p);
}
function showQuickJournalPrompt(){
  let p=document.getElementById('journal-prompt-panel');if(p)p.remove();
  p=document.createElement('div');p.id='journal-prompt-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:300px';
  let prompts=[
    'What is one thing you learned today that surprised you?',
    'What challenge did you face, and how did you handle it?',
    'What are you most proud of accomplishing recently?',
    'If you could tell your past self one thing, what would it be?',
    'What is something small that brought you joy today?',
    'What habit do you want to build or break?',
    'Describe a moment today when you felt fully present.',
    'What would you do differently if you could redo today?',
    'Who inspired you recently, and why?',
    'What is one fear you want to overcome this week?',
    'What does your ideal day look like?',
    'Write about a skill you want to develop and why.',
    'What conversation had the biggest impact on you recently?',
    'What are 3 things you can control right now?',
    'What would you attempt if you knew you could not fail?'
  ];
  let prompt=prompts[Math.floor(Math.random()*prompts.length)];
  if(!S._journalEntries)S._journalEntries=[];
  let today=new Date().toISOString().slice(0,10);
  function rend(){
    let todayEntry=S._journalEntries.find(e=>e.date===today);
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Journal Prompt</span><button onclick="document.getElementById(\'journal-prompt-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="padding:10px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:10px;border-left:3px solid #4ade80"><div style="font-size:12px;color:var(--text-primary);font-style:italic;line-height:1.5">'+esc(prompt)+'</div></div>'
      +'<textarea id="journal-text" rows="5" placeholder="Write your thoughts..." style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;resize:vertical;box-sizing:border-box;line-height:1.5">'+(todayEntry?esc(todayEntry.text):'')+'</textarea>'
      +'<div style="display:flex;gap:6px;margin-top:6px"><button id="journal-save" style="flex:1;padding:6px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:11px">Save</button><button id="journal-new" style="padding:6px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:11px">New Prompt</button></div>'
      +'<div style="font-size:9px;color:var(--text-muted);margin-top:6px;text-align:center">'+S._journalEntries.length+' total entries</div>';
    document.getElementById('journal-save').onclick=function(){
      let text=document.getElementById('journal-text').value.trim();
      if(!text)return;
      let existing=S._journalEntries.findIndex(e=>e.date===today);
      if(existing>=0)S._journalEntries[existing]={date:today,prompt:prompt,text:text,ts:Date.now()};
      else S._journalEntries.push({date:today,prompt:prompt,text:text,ts:Date.now()});
      save();this.textContent='Saved!';setTimeout(()=>{this.textContent='Save';},1200);
    };
    document.getElementById('journal-new').onclick=function(){prompt=prompts[Math.floor(Math.random()*prompts.length)];rend();};
  }
  document.body.appendChild(p);
  rend();
}
function showEnvFileGen(){
  let p=document.getElementById('env-gen-panel');if(p)p.remove();
  p=document.createElement('div');p.id='env-gen-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let vars=S._envVars||[{k:'DATABASE_URL',v:'postgresql://user:pass@localhost:5432/db',comment:'Database connection'},{k:'API_KEY',v:'',comment:'Your API key'},{k:'NODE_ENV',v:'development',comment:'Environment'}];
  function gen(){
    return vars.map(v=>{
      let line='';
      if(v.comment)line='# '+v.comment+'\n';
      line+=v.k+'='+(v.v.includes(' ')?'"'+v.v+'"':v.v);
      return line;
    }).join('\n\n');
  }
  function rend(){
    let rows=vars.map((v,i)=>'<div style="display:flex;gap:4px;margin-bottom:6px;align-items:center"><input data-ei="'+i+'" data-ef="k" value="'+esc(v.k)+'" placeholder="KEY" style="width:140px;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:#4ade80;font-size:11px;font-family:monospace"><input data-ei="'+i+'" data-ef="v" value="'+esc(v.v)+'" placeholder="value" style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:11px;font-family:monospace"><input data-ei="'+i+'" data-ef="comment" value="'+esc(v.comment)+'" placeholder="comment" style="width:100px;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-muted);font-size:10px"><button data-ed="'+i+'" style="background:none;border:none;color:#f87171;cursor:pointer;font-size:14px">x</button></div>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">.env File Generator</span><button onclick="document.getElementById(\'env-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +rows
      +'<button id="env-add" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:11px;margin-bottom:10px">+ Add Variable</button>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.6">'+esc(gen())+'</pre>'
      +'<div style="display:flex;gap:6px"><button id="env-copy" style="flex:1;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy .env</button><button id="env-example" style="padding:8px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:11px">Copy .env.example</button></div>';
    p.querySelectorAll('[data-ei]').forEach(inp=>{inp.oninput=function(){let i=parseInt(this.dataset.ei);vars[i][this.dataset.ef]=this.value;S._envVars=vars;save();};});
    p.querySelectorAll('[data-ed]').forEach(b=>{b.onclick=function(){vars.splice(parseInt(this.dataset.ed),1);S._envVars=vars;save();rend();};});
    document.getElementById('env-add').onclick=function(){vars.push({k:'NEW_VAR',v:'',comment:''});S._envVars=vars;save();rend();};
    document.getElementById('env-copy').onclick=function(){navigator.clipboard.writeText(gen());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy .env';},1200);};
    document.getElementById('env-example').onclick=function(){
      let ex=vars.map(v=>{let line='';if(v.comment)line='# '+v.comment+'\n';line+=v.k+'=';return line;}).join('\n\n');
      navigator.clipboard.writeText(ex);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy .env.example';},1200);
    };
  }
  document.body.appendChild(p);
  rend();
}
function showTaskBlockedGraph(){
  let p=document.getElementById('blocked-graph-panel');if(p)p.remove();
  p=document.createElement('div');p.id='blocked-graph-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let blocked=tasks.filter(t=>t.blockedBy&&t.blockedBy.length>0&&t.status!=='done');
  let blockers={};
  blocked.forEach(t=>{
    (t.blockedBy||[]).forEach(bid=>{
      if(!blockers[bid])blockers[bid]={task:tasks.find(tk=>tk.id===bid),blocking:[]};
      blockers[bid].blocking.push(t);
    });
  });
  let blockerList=Object.keys(blockers).sort((a,b)=>blockers[b].blocking.length-blockers[a].blocking.length);
  if(blockerList.length===0){
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Blocked Tasks Graph</span><button onclick="document.getElementById(\'blocked-graph-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="text-align:center;padding:30px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px">No blocked tasks!</div><div style="font-size:12px">All tasks are unblocked and ready to work on.</div></div>';
  } else {
    let rows=blockerList.map(bid=>{
      let b=blockers[bid];
      let blocker=b.task;
      let bName=blocker?esc(blocker.title):'Unknown ('+bid+')';
      let bStatus=blocker?blocker.status:'unknown';
      let statusColor=bStatus==='done'?'#4ade80':bStatus==='in-progress'?'#22d3ee':'#fbbf24';
      let deps=b.blocking.map(t=>'<div style="font-size:10px;color:var(--text-muted);padding:2px 0 2px 16px">- '+esc(t.title)+'</div>').join('');
      return '<div style="padding:8px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:6px"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:600;color:var(--text-primary);font-size:12px">'+bName+'</span><span style="font-size:9px;padding:2px 6px;border-radius:3px;background:'+statusColor+'20;color:'+statusColor+'">'+bStatus+'</span></div><div style="font-size:10px;color:#f87171;margin:4px 0">Blocking '+b.blocking.length+' task'+(b.blocking.length>1?'s':'')+':</div>'+deps+'</div>';
    }).join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Blocked Tasks Graph</span><button onclick="document.getElementById(\'blocked-graph-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;gap:12px;margin-bottom:12px"><div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);text-align:center;flex:1"><div style="font-size:20px;font-weight:700;color:#f87171">'+blocked.length+'</div><div style="font-size:10px;color:var(--text-muted)">Blocked</div></div><div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);text-align:center;flex:1"><div style="font-size:20px;font-weight:700;color:#fbbf24">'+blockerList.length+'</div><div style="font-size:10px;color:var(--text-muted)">Blockers</div></div></div>'
      +rows;
  }
  document.body.appendChild(p);
}
function showQuickHydration(){
  let p=document.getElementById('hydration-panel');if(p)p.remove();
  p=document.createElement('div');p.id='hydration-panel';
  p.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:220px';
  let today=new Date().toISOString().slice(0,10);
  if(!S._hydration)S._hydration={};
  if(!S._hydration[today])S._hydration[today]=0;
  let goal=S._hydrationGoal||8;
  function rend(){
    let cups=S._hydration[today]||0;
    let pct=Math.min(Math.round(cups/goal*100),100);
    let blocks='';
    for(let i=0;i<goal;i++){
      blocks+='<div style="width:20px;height:20px;border-radius:3px;background:'+(i<cups?'#22d3ee':'var(--bg-surface)')+';border:1px solid '+(i<cups?'#22d3ee':'var(--border)')+';transition:background 0.2s"></div>';
    }
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Hydration</span><button onclick="document.getElementById(\'hydration-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="text-align:center;margin-bottom:8px"><div style="font-size:28px;font-weight:700;color:#22d3ee">'+cups+'/'+goal+'</div><div style="font-size:10px;color:var(--text-muted)">cups ('+pct+'%)</div></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-bottom:10px">'+blocks+'</div>'
      +'<div style="display:flex;gap:4px"><button id="hyd-add" style="flex:1;padding:6px;background:#22d3ee;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:12px">+ Cup</button><button id="hyd-sub" style="padding:6px 10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:12px">-</button></div>';
    document.getElementById('hyd-add').onclick=function(){S._hydration[today]=(S._hydration[today]||0)+1;save();rend();};
    document.getElementById('hyd-sub').onclick=function(){if(S._hydration[today]>0)S._hydration[today]--;save();rend();};
  }
  document.body.appendChild(p);
  rend();
}
function showDockerfileGen(){
  let p=document.getElementById('docker-gen-panel');if(p)p.remove();
  p=document.createElement('div');p.id='docker-gen-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let templates=[
    {name:'Node.js',code:'FROM node:20-alpine\n\nWORKDIR /app\n\nCOPY package*.json ./\nRUN npm ci --only=production\n\nCOPY . .\n\nEXPOSE 3000\n\nCMD ["node", "server.js"]'},
    {name:'Python',code:'FROM python:3.12-slim\n\nWORKDIR /app\n\nCOPY requirements.txt .\nRUN pip install --no-cache-dir -r requirements.txt\n\nCOPY . .\n\nEXPOSE 8000\n\nCMD ["python", "app.py"]'},
    {name:'React (Multi-stage)',code:'# Build stage\nFROM node:20-alpine AS build\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\n# Production stage\nFROM nginx:alpine\nCOPY --from=build /app/build /usr/share/nginx/html\nEXPOSE 80\nCMD ["nginx", "-g", "daemon off;"]'},
    {name:'Go',code:'FROM golang:1.22-alpine AS build\n\nWORKDIR /app\nCOPY go.* ./\nRUN go mod download\nCOPY . .\nRUN CGO_ENABLED=0 go build -o /app/server .\n\nFROM alpine:latest\nCOPY --from=build /app/server /server\nEXPOSE 8080\nCMD ["/server"]'},
    {name:'Static Site',code:'FROM nginx:alpine\n\nCOPY . /usr/share/nginx/html\n\nEXPOSE 80\n\nCMD ["nginx", "-g", "daemon off;"]'},
    {name:'Java Spring',code:'FROM eclipse-temurin:21-jdk-alpine AS build\nWORKDIR /app\nCOPY . .\nRUN ./gradlew bootJar --no-daemon\n\nFROM eclipse-temurin:21-jre-alpine\nCOPY --from=build /app/build/libs/*.jar app.jar\nEXPOSE 8080\nCMD ["java", "-jar", "app.jar"]'}
  ];
  let selected=0;
  function rend(){
    let tabs=templates.map((t,i)=>'<button data-dt="'+i+'" style="padding:4px 10px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:11px">'+t.name+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Dockerfile Generator</span><button onclick="document.getElementById(\'docker-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tabs+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.5">'+esc(templates[selected].code)+'</pre>'
      +'<div style="display:flex;gap:6px"><button id="dock-copy" style="flex:1;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy Dockerfile</button><button id="dock-gitignore" style="padding:8px 12px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:11px">Copy .dockerignore</button></div>';
    p.querySelectorAll('[data-dt]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.dt);rend();};});
    document.getElementById('dock-copy').onclick=function(){navigator.clipboard.writeText(templates[selected].code);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy Dockerfile';},1200);};
    document.getElementById('dock-gitignore').onclick=function(){
      let ignore='node_modules\nnpm-debug.log\n.git\n.gitignore\n.env\n*.md\ndist\nbuild\n.DS_Store\n*.log';
      navigator.clipboard.writeText(ignore);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy .dockerignore';},1200);
    };
  }
  document.body.appendChild(p);
  rend();
}
function showTaskCompletionFunnel(){
  let p=document.getElementById('comp-funnel-panel');if(p)p.remove();
  p=document.createElement('div');p.id='comp-funnel-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let stages=[
    {label:'Backlog',filter:t=>t.status==='backlog',color:'#94a3b8'},
    {label:'To Do',filter:t=>t.status==='todo',color:'#fbbf24'},
    {label:'In Progress',filter:t=>t.status==='in-progress',color:'#22d3ee'},
    {label:'Done',filter:t=>t.status==='done',color:'#4ade80'}
  ];
  stages.forEach(s=>{s.count=tasks.filter(s.filter).length;});
  let maxC=Math.max(...stages.map(s=>s.count),1);
  let funnel=stages.map((s,i)=>{
    let widthPct=Math.max(Math.round(s.count/maxC*100),15);
    let topWidth=i===0?100:Math.max(Math.round(stages[i-1].count/maxC*100),15);
    return '<div style="display:flex;align-items:center;gap:10px;margin-bottom:2px"><span style="min-width:80px;font-size:11px;color:var(--text-muted);text-align:right">'+s.label+'</span><div style="flex:1;display:flex;justify-content:center"><div style="width:'+widthPct+'%;height:32px;background:'+s.color+'25;border-left:3px solid '+s.color+';border-right:3px solid '+s.color+';display:flex;align-items:center;justify-content:center;transition:width 0.3s"><span style="font-weight:700;font-size:14px;color:'+s.color+'">'+s.count+'</span></div></div></div>';
  }).join('');
  let convRate=stages[0].count>0?Math.round(stages[3].count/(stages[0].count+stages[1].count+stages[2].count+stages[3].count)*100):0;
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Completion Funnel</span><button onclick="document.getElementById(\'comp-funnel-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="padding:8px 12px;background:var(--bg-surface);border-radius:var(--radius);text-align:center;margin-bottom:14px"><span style="font-size:10px;color:var(--text-muted)">Completion Rate: </span><span style="font-size:18px;font-weight:700;color:#4ade80">'+convRate+'%</span></div>'
    +funnel;
  document.body.appendChild(p);
}
function showQuickScreenBreak(){
  let p=document.getElementById('screen-break-panel');if(p)p.remove();
  p=document.createElement('div');p.id='screen-break-panel';
  p.style.cssText='position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer';
  let secs=300;
  let messages=[
    'Stand up and walk around',
    'Look out the window',
    'Do some light stretching',
    'Take a few deep breaths',
    'Check your posture',
    'Relax your shoulders',
    'Drink some water'
  ];
  let msg=messages[Math.floor(Math.random()*messages.length)];
  function rend(){
    let min=Math.floor(secs/60);
    let sec=secs%60;
    p.innerHTML='<div style="font-size:48px;font-weight:200;color:#4ade80;margin-bottom:16px;font-family:monospace">'+min+':'+(sec<10?'0':'')+sec+'</div>'
      +'<div style="font-size:18px;color:var(--text-primary);margin-bottom:8px;font-weight:300">Screen Break</div>'
      +'<div style="font-size:14px;color:var(--text-muted);margin-bottom:24px">'+esc(msg)+'</div>'
      +'<div style="font-size:11px;color:#666">Click anywhere or press Escape to dismiss</div>';
  }
  p.onclick=function(){clearInterval(window._sbTimer);p.remove();};
  document.addEventListener('keydown',function handler(e){if(e.key==='Escape'){clearInterval(window._sbTimer);p.remove();document.removeEventListener('keydown',handler);}});
  document.body.appendChild(p);
  rend();
  window._sbTimer=setInterval(()=>{secs--;if(secs<=0){clearInterval(window._sbTimer);p.remove();}else rend();},1000);
}
function showGitignoreGen(){
  let p=document.getElementById('gitignore-panel');if(p)p.remove();
  p=document.createElement('div');p.id='gitignore-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let presets={
    'Node.js':'node_modules/\nnpm-debug.log*\n.env\n.env.local\ndist/\nbuild/\n.DS_Store\ncoverage/\n*.tgz\n.npm',
    'Python':'__pycache__/\n*.py[cod]\n*$py.class\n.env\nvenv/\n.venv/\ndist/\nbuild/\n*.egg-info/\n.pytest_cache/',
    'React':'node_modules/\nbuild/\n.env\n.env.local\n.env.development.local\n.env.test.local\n.env.production.local\nnpm-debug.log*\n.DS_Store',
    'Next.js':'node_modules/\n.next/\nout/\n.env\n.env.local\n.vercel\n.DS_Store\nnpm-debug.log*\ncoverage/',
    'Go':'*.exe\n*.exe~\n*.dll\n*.so\n*.dylib\n*.test\n*.out\nvendor/\n.env\ngo.work',
    'Java':'.class\n*.jar\n*.war\ntarget/\nbuild/\n.gradle/\n.settings/\n.project\n.classpath\n.env',
    'General':'.DS_Store\nThumbs.db\n*.log\n*.tmp\n*.swp\n*~\n.env\n.env.*\n.idea/\n.vscode/\n*.bak'
  };
  let keys=Object.keys(presets);
  let selected=S._gitignorePreset||keys;
  if(!Array.isArray(selected))selected=keys;
  function gen(){
    let lines=['# Generated .gitignore',''];
    selected.forEach(k=>{
      if(presets[k]){
        lines.push('# '+k);
        lines.push(presets[k]);
        lines.push('');
      }
    });
    return lines.join('\n');
  }
  function rend(){
    let checks=keys.map(k=>'<label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text-primary);cursor:pointer;padding:3px 0"><input type="checkbox" data-gk="'+k+'" '+(selected.includes(k)?'checked':'')+' style="cursor:pointer">'+k+'</label>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">.gitignore Generator</span><button onclick="document.getElementById(\'gitignore-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:10px;padding:8px;background:var(--bg-surface);border-radius:var(--radius)">'+checks+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:250px;overflow-y:auto">'+esc(gen())+'</pre>'
      +'<button id="gi-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy .gitignore</button>';
    p.querySelectorAll('[data-gk]').forEach(cb=>{
      cb.onchange=function(){
        let k=this.dataset.gk;
        if(this.checked){if(!selected.includes(k))selected.push(k);}
        else{selected=selected.filter(s=>s!==k);}
        S._gitignorePreset=selected;save();rend();
      };
    });
    document.getElementById('gi-copy').onclick=function(){navigator.clipboard.writeText(gen());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy .gitignore';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskProjectBalance(){
  let p=document.getElementById('proj-balance-panel');if(p)p.remove();
  p=document.createElement('div');p.id='proj-balance-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let projects=(S.projects||[]);
  let projMap={};
  projects.forEach(pr=>{projMap[pr.id]={name:pr.name,open:0,done:0,overdue:0,total:0};});
  projMap['none']={name:'No Project',open:0,done:0,overdue:0,total:0};
  let now=new Date();
  tasks.forEach(t=>{
    let pid=t.projectId||'none';
    if(!projMap[pid])projMap[pid]={name:pid,open:0,done:0,overdue:0,total:0};
    projMap[pid].total++;
    if(t.status==='done')projMap[pid].done++;
    else{
      projMap[pid].open++;
      if(t.due&&new Date(t.due)<now)projMap[pid].overdue++;
    }
  });
  let sorted=Object.values(projMap).filter(p=>p.total>0).sort((a,b)=>b.total-a.total);
  let maxT=Math.max(...sorted.map(p=>p.total),1);
  let rows=sorted.map(pr=>{
    let donePct=Math.round(pr.done/pr.total*100);
    let openPct=Math.round(pr.open/pr.total*100);
    return '<div style="margin-bottom:8px;padding:8px;background:var(--bg-surface);border-radius:var(--radius)"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-weight:600;color:var(--text-primary);font-size:12px">'+esc(pr.name)+'</span><span style="font-size:10px;color:var(--text-muted)">'+pr.total+' tasks</span></div>'
      +'<div style="height:12px;background:var(--bg-base);border-radius:6px;overflow:hidden;display:flex"><div style="width:'+donePct+'%;background:#4ade80;transition:width 0.3s"></div><div style="width:'+openPct+'%;background:#60a5fa;transition:width 0.3s"></div></div>'
      +'<div style="display:flex;gap:12px;margin-top:4px"><span style="font-size:9px;color:#4ade80">Done: '+pr.done+'</span><span style="font-size:9px;color:#60a5fa">Open: '+pr.open+'</span>'+(pr.overdue>0?'<span style="font-size:9px;color:#f87171">Overdue: '+pr.overdue+'</span>':'')+'</div></div>';
  }).join('');
  if(!rows)rows='<div style="text-align:center;color:var(--text-muted);padding:20px">No tasks found</div>';
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Project Balance</span><button onclick="document.getElementById(\'proj-balance-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:8px;margin-bottom:10px;font-size:9px;color:var(--text-muted)"><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#4ade80;border-radius:2px;display:inline-block"></span>Done</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#60a5fa;border-radius:2px;display:inline-block"></span>Open</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#f87171;border-radius:2px;display:inline-block"></span>Overdue</span></div>'
    +rows;
  document.body.appendChild(p);
}
function showQuickDailyReview(){
  let p=document.getElementById('daily-review-panel');if(p)p.remove();
  p=document.createElement('div');p.id='daily-review-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  let today=new Date().toISOString().slice(0,10);
  if(!S._dailyReviews)S._dailyReviews={};
  let review=S._dailyReviews[today]||{wins:'',challenges:'',tomorrow:'',mood:3};
  let moods=['Terrible','Bad','Okay','Good','Great'];
  function rend(){
    let moodBtns=moods.map((m,i)=>'<button data-mood="'+i+'" style="padding:4px 8px;border-radius:var(--radius);border:1px solid '+(review.mood===i?'#4ade80':'var(--border)')+';background:'+(review.mood===i?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(review.mood===i?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:10px">'+m+'</button>').join('');
    let tasks=(S.tasks||[]);
    let doneToday=tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.startsWith(today)).length;
    let created=tasks.filter(t=>{let c=t.created?new Date(t.created).toISOString().slice(0,10):null;return c===today;}).length;
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Daily Review</span><button onclick="document.getElementById(\'daily-review-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;gap:10px;margin-bottom:12px"><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:20px;font-weight:700;color:#4ade80">'+doneToday+'</div><div style="font-size:9px;color:var(--text-muted)">Completed</div></div><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:20px;font-weight:700;color:#22d3ee">'+created+'</div><div style="font-size:9px;color:var(--text-muted)">Created</div></div></div>'
      +'<div style="margin-bottom:10px"><label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px">How was your day?</label><div style="display:flex;gap:4px;flex-wrap:wrap">'+moodBtns+'</div></div>'
      +'<div style="margin-bottom:8px"><label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px">Wins today</label><textarea id="rev-wins" rows="2" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;resize:vertical;box-sizing:border-box">'+esc(review.wins)+'</textarea></div>'
      +'<div style="margin-bottom:8px"><label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px">Challenges</label><textarea id="rev-challenges" rows="2" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;resize:vertical;box-sizing:border-box">'+esc(review.challenges)+'</textarea></div>'
      +'<div style="margin-bottom:10px"><label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px">Plan for tomorrow</label><textarea id="rev-tomorrow" rows="2" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;resize:vertical;box-sizing:border-box">'+esc(review.tomorrow)+'</textarea></div>'
      +'<button id="rev-save" style="width:100%;padding:8px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Save Review</button>';
    p.querySelectorAll('[data-mood]').forEach(b=>{b.onclick=function(){review.mood=parseInt(this.dataset.mood);rend();};});
    document.getElementById('rev-save').onclick=function(){
      review.wins=document.getElementById('rev-wins').value;
      review.challenges=document.getElementById('rev-challenges').value;
      review.tomorrow=document.getElementById('rev-tomorrow').value;
      S._dailyReviews[today]=review;save();
      this.textContent='Saved!';setTimeout(()=>{this.textContent='Save Review';},1200);
    };
  }
  document.body.appendChild(p);
  rend();
}
function showReadmeGen(){
  let p=document.getElementById('readme-gen-panel');if(p)p.remove();
  p=document.createElement('div');p.id='readme-gen-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:80vh;overflow-y:auto';
  let cfg=S._readmeCfg||{name:'My Project',desc:'A brief description of your project',install:'npm install',usage:'npm start',license:'MIT',features:['Feature 1','Feature 2','Feature 3'],tech:['JavaScript','Node.js']};
  function gen(){
    let lines=['# '+cfg.name,'',cfg.desc,'','## Features',''];
    cfg.features.forEach(f=>{lines.push('- '+f);});
    lines.push('','## Tech Stack','');
    cfg.tech.forEach(t=>{lines.push('- '+t);});
    lines.push('','## Getting Started','','### Installation','','```bash',cfg.install,'```','','### Usage','','```bash',cfg.usage,'```','','## License','',''+cfg.license,'');
    return lines.join('\n');
  }
  function rend(){
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">README.md Generator</span><button onclick="document.getElementById(\'readme-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:grid;gap:6px;margin-bottom:10px">'
      +'<input id="rm-name" value="'+esc(cfg.name)+'" placeholder="Project Name" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:12px">'
      +'<textarea id="rm-desc" rows="2" placeholder="Description" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;resize:vertical">'+esc(cfg.desc)+'</textarea>'
      +'<input id="rm-install" value="'+esc(cfg.install)+'" placeholder="Install command" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;font-family:monospace">'
      +'<input id="rm-usage" value="'+esc(cfg.usage)+'" placeholder="Usage command" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;font-family:monospace">'
      +'<input id="rm-features" value="'+esc(cfg.features.join(', '))+'" placeholder="Features (comma-separated)" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px">'
      +'<input id="rm-tech" value="'+esc(cfg.tech.join(', '))+'" placeholder="Tech stack (comma-separated)" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px">'
      +'<select id="rm-license" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px">'+['MIT','Apache-2.0','GPL-3.0','BSD-3-Clause','ISC','Unlicense'].map(l=>'<option'+(l===cfg.license?' selected':'')+'>'+l+'</option>').join('')+'</select>'
      +'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:200px;overflow-y:auto">'+esc(gen())+'</pre>'
      +'<button id="rm-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy README.md</button>';
    let update=function(){
      cfg.name=document.getElementById('rm-name').value;
      cfg.desc=document.getElementById('rm-desc').value;
      cfg.install=document.getElementById('rm-install').value;
      cfg.usage=document.getElementById('rm-usage').value;
      cfg.features=document.getElementById('rm-features').value.split(',').map(s=>s.trim()).filter(Boolean);
      cfg.tech=document.getElementById('rm-tech').value.split(',').map(s=>s.trim()).filter(Boolean);
      cfg.license=document.getElementById('rm-license').value;
      S._readmeCfg=cfg;save();
    };
    ['rm-name','rm-desc','rm-install','rm-usage','rm-features','rm-tech'].forEach(id=>{document.getElementById(id).oninput=update;});
    document.getElementById('rm-license').onchange=function(){update();rend();};
    document.getElementById('rm-copy').onclick=function(){update();navigator.clipboard.writeText(gen());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy README.md';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskStatusTimeline(){
  let p=document.getElementById('status-timeline-panel');if(p)p.remove();
  p=document.createElement('div');p.id='status-timeline-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let days=14;let now=new Date();
  let data=[];
  let statusColors={backlog:'#94a3b8',todo:'#fbbf24','in-progress':'#22d3ee',done:'#4ade80'};
  for(let d=days-1;d>=0;d--){
    let date=new Date(now);date.setDate(date.getDate()-d);
    let ds=date.toISOString().slice(0,10);
    let label=(date.getMonth()+1)+'/'+date.getDate();
    let counts={backlog:0,todo:0,'in-progress':0,done:0};
    tasks.forEach(t=>{
      let created=new Date(t.created||t.id);
      let createdStr=created.toISOString().slice(0,10);
      if(createdStr<=ds){
        if(t.status==='done'&&t.completedAt){
          let doneStr=new Date(t.completedAt).toISOString().slice(0,10);
          if(doneStr<=ds)counts.done++;
          else counts[t.status==='in-progress'?'in-progress':'todo']++;
        } else {
          counts[t.status||'todo']++;
        }
      }
    });
    data.push({label,ds,...counts});
  }
  let svgW=480,svgH=180,pad=30;
  let maxT=Math.max(...data.map(d=>d.backlog+d.todo+d['in-progress']+d.done),1);
  let gap=(svgW-pad*2)/data.length;
  let points={backlog:[],todo:[],'in-progress':[],done:[]};
  let statuses=['done','in-progress','todo','backlog'];
  data.forEach((d,i)=>{
    let x=pad+i*gap+gap/2;
    let cumul=0;
    statuses.forEach(s=>{
      cumul+=d[s];
      points[s].push({x,y:svgH-pad-(cumul/maxT)*(svgH-pad*2)});
    });
  });
  let areas='';
  statuses.forEach(s=>{
    let pts=points[s];
    let pathD='M'+pts[0].x+','+(svgH-pad);
    pts.forEach(pt=>{pathD+=' L'+pt.x+','+pt.y;});
    pathD+=' L'+pts[pts.length-1].x+','+(svgH-pad)+' Z';
    areas+='<path d="'+pathD+'" fill="'+statusColors[s]+'" opacity="0.3"/>';
    let lineD='M'+pts.map(pt=>pt.x+','+pt.y).join(' L');
    areas+='<path d="'+lineD+'" fill="none" stroke="'+statusColors[s]+'" stroke-width="1.5"/>';
  });
  let labels='';
  data.forEach((d,i)=>{if(i%2===0){let x=pad+i*gap+gap/2;labels+='<text x="'+x+'" y="'+(svgH-pad+14)+'" text-anchor="middle" fill="#888" font-size="8">'+d.label+'</text>';}});
  let svg='<svg viewBox="0 0 '+svgW+' '+svgH+'" style="width:100%"><rect width="'+svgW+'" height="'+svgH+'" fill="transparent"/>'+areas+labels+'</svg>';
  let legend=Object.entries(statusColors).map(([s,c])=>'<span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text-muted)"><span style="width:8px;height:8px;background:'+c+';border-radius:2px;display:inline-block"></span>'+s+'</span>').join('');
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Status Timeline (14 Days)</span><button onclick="document.getElementById(\'status-timeline-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:12px;justify-content:center;margin-bottom:8px">'+legend+'</div>'
    +svg;
  document.body.appendChild(p);
}
function showQuickMoodTracker(){
  let p=document.getElementById('mood-track-panel');if(p)p.remove();
  p=document.createElement('div');p.id='mood-track-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px';
  if(!S._moodLog)S._moodLog=[];
  let today=new Date().toISOString().slice(0,10);
  let moods=[
    {label:'Great',color:'#4ade80',val:5},
    {label:'Good',color:'#22d3ee',val:4},
    {label:'Okay',color:'#fbbf24',val:3},
    {label:'Low',color:'#fb923c',val:2},
    {label:'Bad',color:'#f87171',val:1}
  ];
  let todayMood=S._moodLog.find(m=>m.date===today);
  function rend(){
    todayMood=S._moodLog.find(m=>m.date===today);
    let btns=moods.map(m=>'<button data-mv="'+m.val+'" style="padding:6px;border-radius:var(--radius);border:1px solid '+(todayMood&&todayMood.val===m.val?m.color:'var(--border)')+';background:'+(todayMood&&todayMood.val===m.val?m.color+'25':'var(--bg-surface)')+';color:'+(todayMood&&todayMood.val===m.val?m.color:'var(--text-muted)')+';cursor:pointer;font-size:10px;flex:1">'+m.label+'</button>').join('');
    let last7=[];
    for(let i=6;i>=0;i--){
      let d=new Date();d.setDate(d.getDate()-i);
      let ds=d.toISOString().slice(0,10);
      let entry=S._moodLog.find(m=>m.date===ds);
      let moodInfo=entry?moods.find(m=>m.val===entry.val):null;
      last7.push('<div style="width:24px;height:24px;border-radius:4px;background:'+(moodInfo?moodInfo.color+'40':'var(--bg-surface)')+';border:1px solid '+(moodInfo?moodInfo.color:'var(--border)')+';display:flex;align-items:center;justify-content:center;font-size:9px;color:'+(moodInfo?moodInfo.color:'var(--text-muted)')+'">'+['S','M','T','W','T','F','S'][d.getDay()]+'</div>');
    }
    let avg=0;let recent=S._moodLog.slice(-7);
    if(recent.length)avg=Math.round(recent.reduce((s,m)=>s+m.val,0)/recent.length*10)/10;
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Mood Tracker</span><button onclick="document.getElementById(\'mood-track-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="display:flex;gap:4px;margin-bottom:10px">'+btns+'</div>'
      +'<div style="display:flex;gap:4px;justify-content:center;margin-bottom:8px">'+last7.join('')+'</div>'
      +'<div style="text-align:center;font-size:10px;color:var(--text-muted)">7-day avg: <span style="color:var(--text-primary);font-weight:600">'+avg+'/5</span> | '+S._moodLog.length+' entries</div>';
    p.querySelectorAll('[data-mv]').forEach(b=>{
      b.onclick=function(){
        let val=parseInt(this.dataset.mv);
        let existing=S._moodLog.findIndex(m=>m.date===today);
        if(existing>=0)S._moodLog[existing]={date:today,val,ts:Date.now()};
        else S._moodLog.push({date:today,val,ts:Date.now()});
        save();rend();
      };
    });
  }
  document.body.appendChild(p);
  rend();
}
function showPackageJsonGen(){
  let p=document.getElementById('pkgjson-panel');if(p)p.remove();
  p=document.createElement('div');p.id='pkgjson-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let cfg=S._pkgCfg||{name:'my-project',version:'1.0.0',desc:'',main:'index.js',scripts:{start:'node index.js',dev:'nodemon index.js',test:'jest',build:'tsc'},license:'MIT',author:'',keywords:''};
  function gen(){
    let pkg={name:cfg.name,version:cfg.version,description:cfg.desc,main:cfg.main,scripts:cfg.scripts,keywords:cfg.keywords?cfg.keywords.split(',').map(s=>s.trim()).filter(Boolean):[],author:cfg.author,license:cfg.license};
    return JSON.stringify(pkg,null,2);
  }
  function rend(){
    let scriptRows=Object.entries(cfg.scripts).map(([k,v])=>'<div style="display:flex;gap:4px;margin-bottom:3px"><input data-sk="'+esc(k)+'" data-sf="key" value="'+esc(k)+'" style="width:80px;padding:3px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:#4ade80;font-size:10px;font-family:monospace"><input data-sk="'+esc(k)+'" data-sf="val" value="'+esc(v)+'" style="flex:1;padding:3px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:10px;font-family:monospace"></div>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">package.json Generator</span><button onclick="document.getElementById(\'pkgjson-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:grid;gap:6px;margin-bottom:8px">'
      +'<div style="display:flex;gap:6px"><input id="pkg-name" value="'+esc(cfg.name)+'" placeholder="name" style="flex:1;padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"><input id="pkg-ver" value="'+esc(cfg.version)+'" placeholder="version" style="width:80px;padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"></div>'
      +'<input id="pkg-desc" value="'+esc(cfg.desc)+'" placeholder="description" style="padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px">'
      +'<div style="display:flex;gap:6px"><input id="pkg-main" value="'+esc(cfg.main)+'" placeholder="main" style="flex:1;padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;font-family:monospace"><input id="pkg-author" value="'+esc(cfg.author)+'" placeholder="author" style="flex:1;padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"></div>'
      +'<input id="pkg-kw" value="'+esc(cfg.keywords)+'" placeholder="keywords (comma-separated)" style="padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px">'
      +'</div>'
      +'<div style="margin-bottom:8px"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Scripts</div>'+scriptRows+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:180px;overflow-y:auto">'+esc(gen())+'</pre>'
      +'<button id="pkg-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy package.json</button>';
    let upd=function(){
      cfg.name=document.getElementById('pkg-name').value;
      cfg.version=document.getElementById('pkg-ver').value;
      cfg.desc=document.getElementById('pkg-desc').value;
      cfg.main=document.getElementById('pkg-main').value;
      cfg.author=document.getElementById('pkg-author').value;
      cfg.keywords=document.getElementById('pkg-kw').value;
      S._pkgCfg=cfg;save();
    };
    ['pkg-name','pkg-ver','pkg-desc','pkg-main','pkg-author','pkg-kw'].forEach(id=>{document.getElementById(id).oninput=upd;});
    p.querySelectorAll('[data-sk]').forEach(inp=>{inp.oninput=function(){
      let oldKey=this.dataset.sk;
      if(this.dataset.sf==='val'){cfg.scripts[oldKey]=this.value;}
      S._pkgCfg=cfg;save();
    };});
    document.getElementById('pkg-copy').onclick=function(){navigator.clipboard.writeText(gen());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy package.json';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskWeeklyGoals(){
  let p=document.getElementById('weekly-goals-panel');if(p)p.remove();
  p=document.createElement('div');p.id='weekly-goals-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  let now=new Date();
  let weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-weekStart.getDay()+1);
  let weekKey=weekStart.toISOString().slice(0,10);
  if(!S._weeklyGoals)S._weeklyGoals={};
  if(!S._weeklyGoals[weekKey])S._weeklyGoals[weekKey]=[];
  let goals=S._weeklyGoals[weekKey];
  let tasks=(S.tasks||[]);
  let weekEnd=new Date(weekStart);weekEnd.setDate(weekEnd.getDate()+7);
  let doneThisWeek=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=weekStart&&new Date(t.completedAt)<weekEnd).length;
  function rend(){
    goals=S._weeklyGoals[weekKey]||[];
    let list=goals.map((g,i)=>'<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:4px"><input type="checkbox" data-gi="'+i+'" '+(g.done?'checked':'')+' style="cursor:pointer"><span style="flex:1;font-size:12px;color:var(--text-primary);'+(g.done?'text-decoration:line-through;opacity:0.5':'')+'">'+esc(g.text)+'</span><button data-gd="'+i+'" style="background:none;border:none;color:#f87171;cursor:pointer;font-size:12px">x</button></div>').join('');
    let completed=goals.filter(g=>g.done).length;
    let pct=goals.length?Math.round(completed/goals.length*100):0;
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Weekly Goals</span><button onclick="document.getElementById(\'weekly-goals-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">Week of '+weekKey+' | '+doneThisWeek+' tasks completed</div>'
      +'<div style="height:6px;background:var(--bg-surface);border-radius:3px;overflow:hidden;margin-bottom:12px"><div style="height:100%;width:'+pct+'%;background:#4ade80;transition:width 0.3s"></div></div>'
      +'<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">'+completed+'/'+goals.length+' goals completed ('+pct+'%)</div>'
      +(list||'<div style="text-align:center;color:var(--text-muted);padding:12px;font-size:11px">No goals set for this week</div>')
      +'<div style="margin-top:8px;display:flex;gap:4px"><input id="wg-input" placeholder="Add a weekly goal..." style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"><button id="wg-add" style="padding:6px 12px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:11px">Add</button></div>';
    p.querySelectorAll('[data-gi]').forEach(cb=>{cb.onchange=function(){
      goals[parseInt(this.dataset.gi)].done=this.checked;S._weeklyGoals[weekKey]=goals;save();rend();
    };});
    p.querySelectorAll('[data-gd]').forEach(b=>{b.onclick=function(){
      goals.splice(parseInt(this.dataset.gd),1);S._weeklyGoals[weekKey]=goals;save();rend();
    };});
    document.getElementById('wg-add').onclick=function(){
      let v=document.getElementById('wg-input').value.trim();
      if(!v)return;
      goals.push({text:v,done:false});S._weeklyGoals[weekKey]=goals;save();rend();
    };
    document.getElementById('wg-input').onkeydown=function(e){if(e.key==='Enter')document.getElementById('wg-add').click();};
  }
  document.body.appendChild(p);
  rend();
}
function showQuickSleepLog(){
  let p=document.getElementById('sleep-log-panel');if(p)p.remove();
  p=document.createElement('div');p.id='sleep-log-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px';
  if(!S._sleepLog)S._sleepLog=[];
  let today=new Date().toISOString().slice(0,10);
  let todayEntry=S._sleepLog.find(s=>s.date===today);
  function rend(){
    todayEntry=S._sleepLog.find(s=>s.date===today);
    let last7=S._sleepLog.slice(-7);
    let avg=last7.length?Math.round(last7.reduce((s,e)=>s+e.hours,0)/last7.length*10)/10:0;
    let barH=60;
    let bars=last7.map(e=>{
      let h=Math.min(e.hours/10,1)*barH;
      let d=new Date(e.date);
      let day=['S','M','T','W','T','F','S'][d.getDay()];
      let color=e.hours>=7?'#4ade80':e.hours>=5?'#fbbf24':'#f87171';
      return '<div style="display:flex;flex-direction:column;align-items:center;gap:2px"><div style="width:20px;height:'+barH+'px;background:var(--bg-surface);border-radius:3px;display:flex;align-items:flex-end;overflow:hidden"><div style="width:100%;height:'+h+'px;background:'+color+';border-radius:3px"></div></div><span style="font-size:8px;color:var(--text-muted)">'+day+'</span><span style="font-size:8px;color:'+color+'">'+e.hours+'</span></div>';
    }).join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Sleep Log</span><button onclick="document.getElementById(\'sleep-log-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="display:flex;gap:4px;justify-content:center;margin-bottom:8px">'+bars+'</div>'
      +'<div style="text-align:center;font-size:10px;color:var(--text-muted);margin-bottom:8px">7-day avg: <span style="font-weight:600;color:var(--text-primary)">'+avg+'h</span></div>'
      +'<div style="display:flex;gap:4px;align-items:center"><label style="font-size:10px;color:var(--text-muted);min-width:50px">Today:</label><input id="sleep-hrs" type="number" min="0" max="14" step="0.5" value="'+(todayEntry?todayEntry.hours:7)+'" style="flex:1;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:12px;text-align:center"><span style="font-size:10px;color:var(--text-muted)">hrs</span></div>'
      +'<button id="sleep-save" style="width:100%;margin-top:6px;padding:6px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:11px">'+(todayEntry?'Update':'Log Sleep')+'</button>';
    document.getElementById('sleep-save').onclick=function(){
      let hrs=parseFloat(document.getElementById('sleep-hrs').value)||0;
      let existing=S._sleepLog.findIndex(s=>s.date===today);
      if(existing>=0)S._sleepLog[existing]={date:today,hours:hrs};
      else S._sleepLog.push({date:today,hours:hrs});
      save();this.textContent='Saved!';setTimeout(()=>{rend();},800);
    };
  }
  document.body.appendChild(p);
  rend();
}
function showTsConfigGen(){
  let p=document.getElementById('tsconfig-panel');if(p)p.remove();
  p=document.createElement('div');p.id='tsconfig-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let presets=[
    {name:'Strict (Recommended)',cfg:{target:'ES2022',module:'ESNext',moduleResolution:'bundler',strict:true,esModuleInterop:true,skipLibCheck:true,outDir:'./dist',rootDir:'./src',declaration:true,resolveJsonModule:true,isolatedModules:true}},
    {name:'React',cfg:{target:'ES2020',module:'ESNext',moduleResolution:'bundler',strict:true,jsx:'react-jsx',esModuleInterop:true,skipLibCheck:true,outDir:'./dist',rootDir:'./src',declaration:true,resolveJsonModule:true,isolatedModules:true,allowImportingTsExtensions:true,noEmit:true}},
    {name:'Node.js',cfg:{target:'ES2022',module:'NodeNext',moduleResolution:'NodeNext',strict:true,esModuleInterop:true,skipLibCheck:true,outDir:'./dist',rootDir:'./src',declaration:true,resolveJsonModule:true,isolatedModules:true,forceConsistentCasingInFileNames:true}},
    {name:'Library',cfg:{target:'ES2020',module:'ESNext',moduleResolution:'bundler',strict:true,esModuleInterop:true,skipLibCheck:true,outDir:'./dist',rootDir:'./src',declaration:true,declarationMap:true,sourceMap:true,resolveJsonModule:true,isolatedModules:true}},
    {name:'Minimal',cfg:{target:'ES2020',module:'ESNext',strict:false,esModuleInterop:true,skipLibCheck:true}}
  ];
  let selected=0;
  function gen(){
    let config={compilerOptions:presets[selected].cfg,include:['src/**/*'],exclude:['node_modules','dist']};
    return JSON.stringify(config,null,2);
  }
  function rend(){
    let tabs=presets.map((pr,i)=>'<button data-tsi="'+i+'" style="padding:4px 8px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:10px">'+pr.name+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">tsconfig.json Generator</span><button onclick="document.getElementById(\'tsconfig-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tabs+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:280px;overflow-y:auto">'+esc(gen())+'</pre>'
      +'<button id="ts-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy tsconfig.json</button>';
    p.querySelectorAll('[data-tsi]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.tsi);rend();};});
    document.getElementById('ts-copy').onclick=function(){navigator.clipboard.writeText(gen());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy tsconfig.json';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskWeekdayHeatmap(){
  let p=document.getElementById('weekday-heat-panel');if(p)p.remove();
  p=document.createElement('div');p.id='weekday-heat-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let done=tasks.filter(t=>t.status==='done'&&t.completedAt);
  let dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let hours=Array.from({length:24},(_,i)=>i);
  let grid=Array.from({length:7},()=>Array(24).fill(0));
  done.forEach(t=>{
    let d=new Date(t.completedAt);
    grid[d.getDay()][d.getHours()]++;
  });
  let maxVal=0;
  grid.forEach(row=>row.forEach(v=>{if(v>maxVal)maxVal=v;}));
  if(!maxVal)maxVal=1;
  let cells='';
  for(let day=0;day<7;day++){
    for(let hr=0;hr<24;hr++){
      let val=grid[day][hr];
      let intensity=val/maxVal;
      let color=intensity===0?'var(--bg-surface)':'rgba(74,222,128,'+Math.max(intensity,0.15)+')';
      let x=hr*16+40;let y=day*22+20;
      cells+='<rect x="'+x+'" y="'+y+'" width="14" height="20" rx="2" fill="'+color+'" title="'+dayNames[day]+' '+hr+':00 - '+val+' tasks"><title>'+dayNames[day]+' '+hr+':00 - '+val+' tasks</title></rect>';
    }
  }
  let dayLabels='';
  dayNames.forEach((d,i)=>{dayLabels+='<text x="35" y="'+(i*22+33)+'" text-anchor="end" fill="#888" font-size="9">'+d+'</text>';});
  let hrLabels='';
  [0,4,8,12,16,20].forEach(h=>{hrLabels+='<text x="'+(h*16+47)+'" y="15" text-anchor="middle" fill="#888" font-size="8">'+h+'h</text>';});
  let svg='<svg viewBox="0 0 430 180" style="width:100%"><rect width="430" height="180" fill="transparent"/>'+dayLabels+hrLabels+cells+'</svg>';
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Completion Heatmap</span><button onclick="document.getElementById(\'weekday-heat-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">When do you complete tasks? (day x hour)</div>'
    +svg
    +'<div style="display:flex;justify-content:center;gap:4px;margin-top:6px;align-items:center"><span style="font-size:9px;color:var(--text-muted)">Less</span>'+[0,0.25,0.5,0.75,1].map(i=>'<div style="width:14px;height:10px;border-radius:2px;background:'+(i===0?'var(--bg-surface)':'rgba(74,222,128,'+Math.max(i,0.15)+')')+'"></div>').join('')+'<span style="font-size:9px;color:var(--text-muted)">More</span></div>';
  document.body.appendChild(p);
}
function showQuickEnergyLevel(){
  let p=document.getElementById('energy-panel');if(p)p.remove();
  p=document.createElement('div');p.id='energy-panel';
  p.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:240px';
  if(!S._energyLog)S._energyLog=[];
  let today=new Date().toISOString().slice(0,10);
  let levels=[
    {label:'Drained',val:1,color:'#f87171'},
    {label:'Low',val:2,color:'#fb923c'},
    {label:'Medium',val:3,color:'#fbbf24'},
    {label:'High',val:4,color:'#22d3ee'},
    {label:'Peak',val:5,color:'#4ade80'}
  ];
  function rend(){
    let todayEntries=S._energyLog.filter(e=>e.date===today);
    let last=todayEntries[todayEntries.length-1];
    let avgToday=todayEntries.length?Math.round(todayEntries.reduce((s,e)=>s+e.val,0)/todayEntries.length*10)/10:0;
    let btns=levels.map(l=>'<button data-ev="'+l.val+'" style="flex:1;padding:6px 2px;border-radius:var(--radius);border:1px solid '+(last&&last.val===l.val?l.color:'var(--border)')+';background:'+(last&&last.val===l.val?l.color+'25':'var(--bg-surface)')+';color:'+(last&&last.val===l.val?l.color:'var(--text-muted)')+';cursor:pointer;font-size:9px">'+l.label+'</button>').join('');
    let sparkline='';
    let recent=S._energyLog.slice(-14);
    if(recent.length>1){
      let pts=recent.map((e,i)=>{let x=i/(recent.length-1)*200;let y=50-((e.val-1)/4)*40;return x+','+y;}).join(' ');
      sparkline='<svg viewBox="0 0 200 55" style="width:100%;height:30px;margin-bottom:6px"><polyline points="'+pts+'" fill="none" stroke="#4ade80" stroke-width="1.5"/></svg>';
    }
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Energy Level</span><button onclick="document.getElementById(\'energy-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +sparkline
      +'<div style="display:flex;gap:3px;margin-bottom:8px">'+btns+'</div>'
      +'<div style="text-align:center;font-size:10px;color:var(--text-muted)">Today avg: <span style="font-weight:600;color:var(--text-primary)">'+avgToday+'/5</span> | '+todayEntries.length+' checks | '+S._energyLog.length+' total</div>';
    p.querySelectorAll('[data-ev]').forEach(b=>{
      b.onclick=function(){
        S._energyLog.push({date:today,val:parseInt(this.dataset.ev),ts:Date.now()});
        save();rend();
      };
    });
  }
  document.body.appendChild(p);
  rend();
}
function showEslintConfigGen(){
  let p=document.getElementById('eslint-panel');if(p)p.remove();
  p=document.createElement('div');p.id='eslint-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let presets=[
    {name:'Flat Config (v9+)',code:'import js from "@eslint/js";\n\nexport default [\n  js.configs.recommended,\n  {\n    rules: {\n      "no-unused-vars": "warn",\n      "no-console": "warn",\n      "prefer-const": "error",\n      "no-var": "error",\n      "eqeqeq": "error"\n    }\n  }\n];'},
    {name:'TypeScript',code:'import js from "@eslint/js";\nimport tseslint from "typescript-eslint";\n\nexport default tseslint.config(\n  js.configs.recommended,\n  ...tseslint.configs.recommended,\n  {\n    rules: {\n      "@typescript-eslint/no-unused-vars": "warn",\n      "@typescript-eslint/no-explicit-any": "warn",\n      "prefer-const": "error"\n    }\n  }\n);'},
    {name:'React',code:'import js from "@eslint/js";\nimport react from "eslint-plugin-react";\nimport reactHooks from "eslint-plugin-react-hooks";\n\nexport default [\n  js.configs.recommended,\n  {\n    plugins: { react, "react-hooks": reactHooks },\n    rules: {\n      "react/jsx-uses-react": "off",\n      "react/react-in-jsx-scope": "off",\n      "react-hooks/rules-of-hooks": "error",\n      "react-hooks/exhaustive-deps": "warn"\n    }\n  }\n];'},
    {name:'Node.js',code:'import js from "@eslint/js";\nimport globals from "globals";\n\nexport default [\n  js.configs.recommended,\n  {\n    languageOptions: {\n      globals: { ...globals.node }\n    },\n    rules: {\n      "no-process-exit": "warn",\n      "no-console": "off",\n      "prefer-const": "error",\n      "no-var": "error"\n    }\n  }\n];'},
    {name:'Legacy (.eslintrc)',code:'{\n  "env": { "browser": true, "es2021": true, "node": true },\n  "extends": ["eslint:recommended"],\n  "parserOptions": { "ecmaVersion": "latest", "sourceType": "module" },\n  "rules": {\n    "no-unused-vars": "warn",\n    "no-console": "warn",\n    "prefer-const": "error",\n    "no-var": "error",\n    "eqeqeq": "error"\n  }\n}'}
  ];
  let selected=0;
  function rend(){
    let tabs=presets.map((pr,i)=>'<button data-ei="'+i+'" style="padding:4px 8px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:10px">'+pr.name+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">ESLint Config Generator</span><button onclick="document.getElementById(\'eslint-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tabs+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:280px;overflow-y:auto">'+esc(presets[selected].code)+'</pre>'
      +'<button id="esl-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy Config</button>';
    p.querySelectorAll('[data-ei]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.ei);rend();};});
    document.getElementById('esl-copy').onclick=function(){navigator.clipboard.writeText(presets[selected].code);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy Config';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskMonthlyReport(){
  let p=document.getElementById('monthly-report-panel');if(p)p.remove();
  p=document.createElement('div');p.id='monthly-report-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let now=new Date();
  let monthStart=new Date(now.getFullYear(),now.getMonth(),1);
  let monthEnd=new Date(now.getFullYear(),now.getMonth()+1,0);
  let monthName=monthStart.toLocaleDateString('en',{month:'long',year:'numeric'});
  let created=tasks.filter(t=>{let c=new Date(t.created||t.id);return c>=monthStart&&c<=monthEnd;}).length;
  let completed=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=monthStart&&new Date(t.completedAt)<=monthEnd).length;
  let overdue=tasks.filter(t=>{if(!t.due||t.status==='done')return false;let d=new Date(t.due);return d>=monthStart&&d<=monthEnd&&d<now;}).length;
  let byProject={};
  tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=monthStart).forEach(t=>{
    let pn=t.projectId||'none';
    let proj=(S.projects||[]).find(pr=>pr.id===pn);
    let name=proj?proj.name:'No Project';
    byProject[name]=(byProject[name]||0)+1;
  });
  let projRows=Object.entries(byProject).sort((a,b)=>b[1]-a[1]).map(([name,count])=>'<div style="display:flex;justify-content:space-between;padding:4px 8px;background:var(--bg-surface);border-radius:3px;margin-bottom:3px"><span style="font-size:11px;color:var(--text-primary)">'+esc(name)+'</span><span style="font-size:11px;font-weight:600;color:#4ade80">'+count+'</span></div>').join('');
  let dayDist=Array(7).fill(0);
  tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=monthStart).forEach(t=>{dayDist[new Date(t.completedAt).getDay()]++;});
  let dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let maxDay=Math.max(...dayDist,1);
  let dayBars=dayDist.map((c,i)=>'<div style="display:flex;align-items:center;gap:4px"><span style="min-width:28px;font-size:10px;color:var(--text-muted)">'+dayNames[i]+'</span><div style="flex:1;height:12px;background:var(--bg-surface);border-radius:2px;overflow:hidden"><div style="height:100%;width:'+Math.round(c/maxDay*100)+'%;background:#4ade80;border-radius:2px"></div></div><span style="min-width:16px;font-size:10px;color:var(--text-primary);text-align:right">'+c+'</span></div>').join('');
  let report='# Monthly Report: '+monthName+'\n\n- Created: '+created+'\n- Completed: '+completed+'\n- Overdue: '+overdue+'\n\n## By Project\n'+Object.entries(byProject).map(([n,c])=>'- '+n+': '+c).join('\n');
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Monthly Report: '+monthName+'</span><button onclick="document.getElementById(\'monthly-report-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px"><div style="padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:20px;font-weight:700;color:#22d3ee">'+created+'</div><div style="font-size:9px;color:var(--text-muted)">Created</div></div><div style="padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:20px;font-weight:700;color:#4ade80">'+completed+'</div><div style="font-size:9px;color:var(--text-muted)">Completed</div></div><div style="padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:20px;font-weight:700;color:#f87171">'+overdue+'</div><div style="font-size:9px;color:var(--text-muted)">Overdue</div></div></div>'
    +'<div style="margin-bottom:10px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">By Project</div>'+projRows+'</div>'
    +'<div style="margin-bottom:10px"><div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-bottom:6px">By Day of Week</div><div style="display:grid;gap:3px">'+dayBars+'</div></div>'
    +'<button onclick="navigator.clipboard.writeText(\''+esc(report.replace(/'/g,"\\'")+'\');this.textContent=\'Copied!\';setTimeout(()=>{this.textContent=\'Copy Report\';},1200)')+'" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy Report</button>';
  document.body.appendChild(p);
}
function showQuickBookmark(){
  let p=document.getElementById('bookmark-panel');if(p)p.remove();
  p=document.createElement('div');p.id='bookmark-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px';
  if(!S._quickBookmarks)S._quickBookmarks=[];
  function rend(){
    let list=S._quickBookmarks.map((b,i)=>'<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)"><a href="'+esc(b.url)+'" target="_blank" style="flex:1;font-size:11px;color:#22d3ee;text-decoration:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(b.title||b.url)+'</a><button data-bd="'+i+'" style="background:none;border:none;color:#f87171;cursor:pointer;font-size:11px">x</button></div>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Quick Bookmarks</span><button onclick="document.getElementById(\'bookmark-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="max-height:200px;overflow-y:auto;margin-bottom:8px">'+(list||'<div style="font-size:11px;color:var(--text-muted);text-align:center;padding:8px">No bookmarks yet</div>')+'</div>'
      +'<div style="display:flex;gap:4px"><input id="bm-url" placeholder="URL..." style="flex:1;padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:10px"><button id="bm-add" style="padding:4px 10px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:10px">+</button></div>';
    p.querySelectorAll('[data-bd]').forEach(b=>{b.onclick=function(){S._quickBookmarks.splice(parseInt(this.dataset.bd),1);save();rend();};});
    document.getElementById('bm-add').onclick=function(){
      let url=document.getElementById('bm-url').value.trim();
      if(!url)return;
      if(!url.startsWith('http'))url='https://'+url;
      let title=url.replace(/^https?:\/\//,'').split('/')[0];
      S._quickBookmarks.push({url,title,ts:Date.now()});save();rend();
    };
    document.getElementById('bm-url').onkeydown=function(e){if(e.key==='Enter')document.getElementById('bm-add').click();};
  }
  document.body.appendChild(p);
  rend();
}
function showPrettierConfigGen(){
  let p=document.getElementById('prettier-panel');if(p)p.remove();
  p=document.createElement('div');p.id='prettier-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  let cfg=S._prettierCfg||{semi:true,singleQuote:true,tabWidth:2,trailingComma:'all',printWidth:80,bracketSpacing:true,arrowParens:'always',endOfLine:'lf'};
  function gen(){return JSON.stringify(cfg,null,2);}
  let options=[
    {key:'semi',label:'Semicolons',type:'bool'},
    {key:'singleQuote',label:'Single quotes',type:'bool'},
    {key:'bracketSpacing',label:'Bracket spacing',type:'bool'},
    {key:'tabWidth',label:'Tab width',type:'select',opts:[2,4,8]},
    {key:'printWidth',label:'Print width',type:'select',opts:[80,100,120]},
    {key:'trailingComma',label:'Trailing comma',type:'select',opts:['all','es5','none']},
    {key:'arrowParens',label:'Arrow parens',type:'select',opts:['always','avoid']},
    {key:'endOfLine',label:'End of line',type:'select',opts:['lf','crlf','cr','auto']}
  ];
  function rend(){
    let rows=options.map(o=>{
      if(o.type==='bool'){
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)"><span style="font-size:11px;color:var(--text-primary)">'+o.label+'</span><label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" data-pk="'+o.key+'" '+(cfg[o.key]?'checked':'')+' style="cursor:pointer"><span style="font-size:10px;color:var(--text-muted)">'+(cfg[o.key]?'yes':'no')+'</span></label></div>';
      } else {
        let opts=o.opts.map(v=>'<option'+(cfg[o.key]===v||cfg[o.key]===String(v)?' selected':'')+' value="'+v+'">'+v+'</option>').join('');
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)"><span style="font-size:11px;color:var(--text-primary)">'+o.label+'</span><select data-ps="'+o.key+'" style="padding:3px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:10px">'+opts+'</select></div>';
      }
    }).join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Prettier Config</span><button onclick="document.getElementById(\'prettier-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="margin-bottom:10px">'+rows+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4">'+esc(gen())+'</pre>'
      +'<button id="prt-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy .prettierrc</button>';
    p.querySelectorAll('[data-pk]').forEach(cb=>{cb.onchange=function(){cfg[this.dataset.pk]=this.checked;S._prettierCfg=cfg;save();rend();};});
    p.querySelectorAll('[data-ps]').forEach(sel=>{sel.onchange=function(){let v=this.value;if(!isNaN(v))v=parseInt(v);cfg[this.dataset.ps]=v;S._prettierCfg=cfg;save();rend();};});
    document.getElementById('prt-copy').onclick=function(){navigator.clipboard.writeText(gen());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy .prettierrc';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskEisenhowerMatrix(){
  let p=document.getElementById('eisenhower-panel');if(p)p.remove();
  p=document.createElement('div');p.id='eisenhower-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  let now=new Date();
  let quadrants=[
    {label:'Do First',desc:'Urgent + Important',color:'#f87171',tasks:[]},
    {label:'Schedule',desc:'Not Urgent + Important',color:'#22d3ee',tasks:[]},
    {label:'Delegate',desc:'Urgent + Not Important',color:'#fbbf24',tasks:[]},
    {label:'Eliminate',desc:'Not Urgent + Not Important',color:'#94a3b8',tasks:[]}
  ];
  tasks.forEach(t=>{
    let isUrgent=false;
    if(t.due){let d=new Date(t.due);let daysLeft=(d-now)/86400000;isUrgent=daysLeft<=3;}
    if(t.priority==='p0')isUrgent=true;
    let isImportant=t.priority==='p0'||t.priority==='p1';
    if(isUrgent&&isImportant)quadrants[0].tasks.push(t);
    else if(!isUrgent&&isImportant)quadrants[1].tasks.push(t);
    else if(isUrgent&&!isImportant)quadrants[2].tasks.push(t);
    else quadrants[3].tasks.push(t);
  });
  let grid=quadrants.map(q=>{
    let items=q.tasks.slice(0,5).map(t=>'<div style="font-size:10px;color:var(--text-primary);padding:2px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(t.title)+'</div>').join('');
    let more=q.tasks.length>5?'<div style="font-size:9px;color:var(--text-muted)">+'+( q.tasks.length-5)+' more</div>':'';
    return '<div style="padding:10px;background:var(--bg-surface);border-radius:var(--radius);border-top:3px solid '+q.color+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-weight:600;color:'+q.color+';font-size:11px">'+q.label+'</span><span style="font-size:18px;font-weight:700;color:'+q.color+'">'+q.tasks.length+'</span></div><div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">'+q.desc+'</div>'+items+more+'</div>';
  }).join('');
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Eisenhower Matrix</span><button onclick="document.getElementById(\'eisenhower-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="font-size:10px;color:var(--text-muted);margin-bottom:10px">'+tasks.length+' open tasks classified by priority + due date urgency</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">'+grid+'</div>';
  document.body.appendChild(p);
}
function showQuickIdea(){
  let p=document.getElementById('quick-idea-panel');if(p)p.remove();
  p=document.createElement('div');p.id='quick-idea-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px';
  if(!S._ideas)S._ideas=[];
  function rend(){
    let recent=S._ideas.slice(-5).reverse();
    let list=recent.map((idea,i)=>'<div style="padding:6px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:4px;border-left:3px solid #a78bfa"><div style="font-size:11px;color:var(--text-primary);line-height:1.4">'+esc(idea.text)+'</div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">'+new Date(idea.ts).toLocaleDateString()+' '+new Date(idea.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})+'</div></div>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Quick Ideas</span><button onclick="document.getElementById(\'quick-idea-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="max-height:180px;overflow-y:auto;margin-bottom:8px">'+(list||'<div style="font-size:11px;color:var(--text-muted);text-align:center;padding:8px">Capture your ideas here</div>')+'</div>'
      +'<textarea id="idea-text" rows="2" placeholder="What is your idea?" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;resize:none;box-sizing:border-box;margin-bottom:4px"></textarea>'
      +'<div style="display:flex;gap:4px"><button id="idea-save" style="flex:1;padding:6px;background:#a78bfa;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:11px">Save Idea</button><button id="idea-content" style="padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-size:10px" title="Save to Content section">To Content</button></div>'
      +'<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:4px">'+S._ideas.length+' ideas captured</div>';
    document.getElementById('idea-save').onclick=function(){
      let text=document.getElementById('idea-text').value.trim();
      if(!text)return;
      S._ideas.push({text,ts:Date.now()});save();rend();
    };
    document.getElementById('idea-content').onclick=function(){
      let text=document.getElementById('idea-text').value.trim();
      if(!text)return;
      if(!S.content)S.content=[];
      S.content.push({id:Date.now(),title:'Idea: '+text.substring(0,50),body:text,tags:['idea'],created:new Date().toISOString()});
      S._ideas.push({text,ts:Date.now()});save();
      this.textContent='Saved!';setTimeout(()=>{this.textContent='To Content';},1200);
    };
    document.getElementById('idea-text').onkeydown=function(e){if(e.key==='Enter'&&(e.metaKey||e.ctrlKey))document.getElementById('idea-save').click();};
  }
  document.body.appendChild(p);
  rend();
}
function showVercelJsonGen(){
  let p=document.getElementById('vercel-json-panel');if(p)p.remove();
  p=document.createElement('div');p.id='vercel-json-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let presets=[
    {name:'Static HTML',code:'{\n  "version": 2,\n  "builds": [\n    { "src": "*.html", "use": "@vercel/static" }\n  ],\n  "routes": [\n    { "src": "/(.*)", "dest": "/$1" }\n  ]\n}'},
    {name:'Node.js API',code:'{\n  "version": 2,\n  "builds": [\n    { "src": "api/**/*.js", "use": "@vercel/node" },\n    { "src": "public/**", "use": "@vercel/static" }\n  ],\n  "routes": [\n    { "src": "/api/(.*)", "dest": "/api/$1" },\n    { "src": "/(.*)", "dest": "/public/$1" }\n  ]\n}'},
    {name:'Single Page App',code:'{\n  "version": 2,\n  "rewrites": [\n    { "source": "/((?!api/).*)", "destination": "/index.html" }\n  ],\n  "headers": [\n    {\n      "source": "/(.*)",\n      "headers": [\n        { "key": "X-Frame-Options", "value": "DENY" },\n        { "key": "X-Content-Type-Options", "value": "nosniff" }\n      ]\n    }\n  ]\n}'},
    {name:'CORS API',code:'{\n  "version": 2,\n  "builds": [\n    { "src": "api/**/*.js", "use": "@vercel/node" }\n  ],\n  "headers": [\n    {\n      "source": "/api/(.*)",\n      "headers": [\n        { "key": "Access-Control-Allow-Origin", "value": "*" },\n        { "key": "Access-Control-Allow-Methods", "value": "GET, POST, PUT, DELETE, OPTIONS" },\n        { "key": "Access-Control-Allow-Headers", "value": "Content-Type, Authorization" }\n      ]\n    }\n  ]\n}'},
    {name:'Redirects',code:'{\n  "version": 2,\n  "redirects": [\n    { "source": "/old-page", "destination": "/new-page", "permanent": true },\n    { "source": "/blog/:slug", "destination": "/posts/:slug", "permanent": false }\n  ],\n  "cleanUrls": true,\n  "trailingSlash": false\n}'}
  ];
  let selected=0;
  function rend(){
    let tabs=presets.map((pr,i)=>'<button data-vi="'+i+'" style="padding:4px 8px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:10px">'+pr.name+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">vercel.json Generator</span><button onclick="document.getElementById(\'vercel-json-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tabs+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:280px;overflow-y:auto">'+esc(presets[selected].code)+'</pre>'
      +'<button id="vcl-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy vercel.json</button>';
    p.querySelectorAll('[data-vi]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.vi);rend();};});
    document.getElementById('vcl-copy').onclick=function(){navigator.clipboard.writeText(presets[selected].code);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy vercel.json';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskQuarterlyReview(){
  let p=document.getElementById('quarterly-panel');if(p)p.remove();
  p=document.createElement('div');p.id='quarterly-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let now=new Date();
  let qMonth=Math.floor(now.getMonth()/3)*3;
  let qStart=new Date(now.getFullYear(),qMonth,1);
  let qEnd=new Date(now.getFullYear(),qMonth+3,0);
  let qLabel='Q'+(Math.floor(now.getMonth()/3)+1)+' '+now.getFullYear();
  let months=[0,1,2].map(i=>{
    let mStart=new Date(now.getFullYear(),qMonth+i,1);
    let mEnd=new Date(now.getFullYear(),qMonth+i+1,0);
    let mName=mStart.toLocaleDateString('en',{month:'short'});
    let created=tasks.filter(t=>{let c=new Date(t.created||t.id);return c>=mStart&&c<=mEnd;}).length;
    let completed=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=mStart&&new Date(t.completedAt)<=mEnd).length;
    return {name:mName,created,completed};
  });
  let totalCreated=months.reduce((s,m)=>s+m.created,0);
  let totalCompleted=months.reduce((s,m)=>s+m.completed,0);
  let maxVal=Math.max(...months.map(m=>Math.max(m.created,m.completed)),1);
  let chart=months.map(m=>{
    let cPct=Math.round(m.created/maxVal*100);
    let dPct=Math.round(m.completed/maxVal*100);
    return '<div style="flex:1;text-align:center"><div style="height:80px;display:flex;align-items:flex-end;justify-content:center;gap:4px"><div style="width:20px;height:'+cPct+'%;background:#22d3ee;border-radius:3px 3px 0 0"></div><div style="width:20px;height:'+dPct+'%;background:#4ade80;border-radius:3px 3px 0 0"></div></div><div style="font-size:10px;color:var(--text-muted);margin-top:4px">'+m.name+'</div><div style="font-size:9px;color:var(--text-muted)">'+m.created+'/'+m.completed+'</div></div>';
  }).join('');
  let velocity=totalCompleted>0?Math.round(totalCompleted/((now-qStart)/604800000)*10)/10:0;
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Quarterly Review: '+qLabel+'</span><button onclick="document.getElementById(\'quarterly-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px"><div style="padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:#22d3ee">'+totalCreated+'</div><div style="font-size:9px;color:var(--text-muted)">Created</div></div><div style="padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:#4ade80">'+totalCompleted+'</div><div style="font-size:9px;color:var(--text-muted)">Completed</div></div><div style="padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:var(--text-primary)">'+velocity+'/wk</div><div style="font-size:9px;color:var(--text-muted)">Velocity</div></div></div>'
    +'<div style="display:flex;gap:4px;margin-bottom:10px">'+chart+'</div>'
    +'<div style="display:flex;gap:8px;justify-content:center;font-size:9px;color:var(--text-muted);margin-bottom:8px"><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#22d3ee;border-radius:2px;display:inline-block"></span>Created</span><span style="display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:#4ade80;border-radius:2px;display:inline-block"></span>Completed</span></div>';
  document.body.appendChild(p);
}
function showQuickFocusMusic(){
  let p=document.getElementById('focus-music-panel');if(p)p.remove();
  p=document.createElement('div');p.id='focus-music-panel';
  p.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:240px';
  let playing=false;let ctx=null;let osc1=null;let osc2=null;let gainNode=null;
  let vol=S._fmVol||0.2;
  let tones=[
    {name:'Deep Focus',f1:200,f2:210,desc:'Alpha waves (10Hz binaural)'},
    {name:'Calm',f1:200,f2:206,desc:'Theta waves (6Hz binaural)'},
    {name:'Energize',f1:200,f2:240,desc:'Beta waves (40Hz binaural)'},
    {name:'Sleep',f1:150,f2:154,desc:'Delta waves (4Hz binaural)'},
    {name:'Meditation',f1:250,f2:257.83,desc:'Schumann resonance (7.83Hz)'}
  ];
  let selected=S._fmTone||0;
  function start(){
    ctx=new(window.AudioContext||window.webkitAudioContext)();
    gainNode=ctx.createGain();
    gainNode.gain.value=vol;
    gainNode.connect(ctx.destination);
    osc1=ctx.createOscillator();osc1.type='sine';osc1.frequency.value=tones[selected].f1;
    let pan1=ctx.createStereoPanner();pan1.pan.value=-1;
    osc1.connect(pan1);pan1.connect(gainNode);osc1.start();
    osc2=ctx.createOscillator();osc2.type='sine';osc2.frequency.value=tones[selected].f2;
    let pan2=ctx.createStereoPanner();pan2.pan.value=1;
    osc2.connect(pan2);pan2.connect(gainNode);osc2.start();
    playing=true;
  }
  function stop(){if(ctx){osc1.stop();osc2.stop();ctx.close();ctx=null;playing=false;}}
  function rend(){
    let btns=tones.map((t,i)=>'<button data-ft="'+i+'" style="width:100%;padding:6px 8px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:10px;text-align:left;margin-bottom:3px"><span style="font-weight:600">'+t.name+'</span> <span style="opacity:0.6;font-size:9px">'+t.desc+'</span></button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Binaural Focus</span><button onclick="if(window._fmStop)window._fmStop();document.getElementById(\'focus-music-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="margin-bottom:8px">'+btns+'</div>'
      +'<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:10px;color:var(--text-muted)">Vol</span><input id="fm-vol" type="range" min="0" max="100" value="'+Math.round(vol*100)+'" style="flex:1"><span style="font-size:10px;color:var(--text-muted);min-width:28px">'+Math.round(vol*100)+'%</span></div>'
      +'<div style="display:flex;gap:4px"><button id="fm-toggle" style="flex:1;padding:8px;background:'+(playing?'#f87171':'#4ade80')+';color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">'+(playing?'Stop':'Play')+'</button></div>'
      +'<div style="font-size:8px;color:var(--text-muted);text-align:center;margin-top:6px">Use headphones for binaural effect</div>';
    p.querySelectorAll('[data-ft]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.ft);S._fmTone=selected;save();if(playing){stop();start();}rend();};});
    document.getElementById('fm-vol').oninput=function(){vol=parseInt(this.value)/100;S._fmVol=vol;save();if(gainNode)gainNode.gain.value=vol;};
    document.getElementById('fm-toggle').onclick=function(){if(playing)stop();else start();rend();};
  }
  window._fmStop=stop;
  document.body.appendChild(p);
  rend();
}
function showNginxConfigGen(){
  let p=document.getElementById('nginx-panel');if(p)p.remove();
  p=document.createElement('div');p.id='nginx-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:540px;width:90vw;max-height:80vh;overflow-y:auto';
  let presets=[
    {name:'Static Site',code:'server {\n    listen 80;\n    server_name example.com;\n    root /var/www/html;\n    index index.html;\n\n    location / {\n        try_files $uri $uri/ =404;\n    }\n\n    # Cache static assets\n    location ~* \\.(css|js|png|jpg|jpeg|gif|ico|svg)$ {\n        expires 30d;\n        add_header Cache-Control "public, immutable";\n    }\n}'},
    {name:'Reverse Proxy',code:'server {\n    listen 80;\n    server_name example.com;\n\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \'upgrade\';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n    }\n}'},
    {name:'SSL + Redirect',code:'server {\n    listen 80;\n    server_name example.com;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name example.com;\n\n    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;\n\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_prefer_server_ciphers on;\n\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n}'},
    {name:'SPA (React/Vue)',code:'server {\n    listen 80;\n    server_name example.com;\n    root /var/www/app/build;\n    index index.html;\n\n    location / {\n        try_files $uri $uri/ /index.html;\n    }\n\n    location /api {\n        proxy_pass http://localhost:3001;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n\n    location ~* \\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {\n        expires 1y;\n        add_header Cache-Control "public, immutable";\n    }\n\n    gzip on;\n    gzip_types text/css application/javascript application/json image/svg+xml;\n}'}
  ];
  let selected=0;
  function rend(){
    let tabs=presets.map((pr,i)=>'<button data-ni="'+i+'" style="padding:4px 8px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:10px">'+pr.name+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">nginx Config Generator</span><button onclick="document.getElementById(\'nginx-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tabs+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:300px;overflow-y:auto">'+esc(presets[selected].code)+'</pre>'
      +'<button id="ngx-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy Config</button>';
    p.querySelectorAll('[data-ni]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.ni);rend();};});
    document.getElementById('ngx-copy').onclick=function(){navigator.clipboard.writeText(presets[selected].code);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy Config';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskVelocityTrend(){
  let p=document.getElementById('vel-trend-panel');if(p)p.remove();
  p=document.createElement('div');p.id='vel-trend-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let weeks=10;let now=new Date();
  let data=[];
  for(let w=weeks-1;w>=0;w--){
    let wEnd=new Date(now);wEnd.setDate(wEnd.getDate()-w*7);
    let wStart=new Date(wEnd);wStart.setDate(wStart.getDate()-7);
    let label=(wEnd.getMonth()+1)+'/'+wEnd.getDate();
    let completed=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=wStart&&new Date(t.completedAt)<wEnd).length;
    data.push({label,completed});
  }
  let maxV=Math.max(...data.map(d=>d.completed),1);
  let avg=Math.round(data.reduce((s,d)=>s+d.completed,0)/data.length*10)/10;
  let svgW=460,svgH=180,pad=30;
  let gap=(svgW-pad*2)/data.length;
  let pts=data.map((d,i)=>{let x=pad+i*gap+gap/2;let y=svgH-pad-((d.completed/maxV)*(svgH-pad*2));return {x,y,v:d.completed,label:d.label};});
  let lineD='M'+pts.map(pt=>pt.x+','+pt.y).join(' L');
  let areaD=lineD+' L'+pts[pts.length-1].x+','+(svgH-pad)+' L'+pts[0].x+','+(svgH-pad)+' Z';
  let dots=pts.map(pt=>'<circle cx="'+pt.x+'" cy="'+pt.y+'" r="3" fill="#4ade80"/><text x="'+pt.x+'" y="'+(pt.y-8)+'" text-anchor="middle" fill="#4ade80" font-size="9">'+pt.v+'</text>').join('');
  let labels=pts.map((pt,i)=>i%2===0?'<text x="'+pt.x+'" y="'+(svgH-pad+14)+'" text-anchor="middle" fill="#888" font-size="8">'+pt.label+'</text>':'').join('');
  let avgY=svgH-pad-((avg/maxV)*(svgH-pad*2));
  let avgLine='<line x1="'+pad+'" y1="'+avgY+'" x2="'+(svgW-pad)+'" y2="'+avgY+'" stroke="#fbbf24" stroke-width="1" stroke-dasharray="4,3"/><text x="'+(svgW-pad+4)+'" y="'+(avgY+4)+'" fill="#fbbf24" font-size="8">avg '+avg+'</text>';
  let svg='<svg viewBox="0 0 '+svgW+' '+svgH+'" style="width:100%"><rect width="'+svgW+'" height="'+svgH+'" fill="transparent"/><path d="'+areaD+'" fill="rgba(74,222,128,0.1)"/><path d="'+lineD+'" fill="none" stroke="#4ade80" stroke-width="2"/>'+dots+labels+avgLine+'</svg>';
  let trend=data.length>=2?(data[data.length-1].completed>=data[data.length-2].completed?'Trending up':'Trending down'):'Not enough data';
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Velocity Trend (10 Weeks)</span><button onclick="document.getElementById(\'vel-trend-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:12px;margin-bottom:10px"><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:#4ade80">'+avg+'</div><div style="font-size:9px;color:var(--text-muted)">Avg/Week</div></div><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:14px;font-weight:600;color:var(--text-primary)">'+trend+'</div><div style="font-size:9px;color:var(--text-muted)">Direction</div></div></div>'
    +svg;
  document.body.appendChild(p);
}
function showQuickAbcPrioritizer(){
  let p=document.getElementById('abc-prio-panel');if(p)p.remove();
  p=document.createElement('div');p.id='abc-prio-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._abcItems)S._abcItems=[];
  function rend(){
    let grouped={A:[],B:[],C:[]};
    S._abcItems.forEach(item=>{if(grouped[item.cat])grouped[item.cat].push(item);});
    let sections=['A','B','C'].map(cat=>{
      let label=cat==='A'?'Must Do':cat==='B'?'Should Do':'Nice to Do';
      let color=cat==='A'?'#f87171':cat==='B'?'#fbbf24':'#60a5fa';
      let items=grouped[cat].map((item,i)=>'<div style="display:flex;align-items:center;gap:6px;padding:4px;background:var(--bg-base);border-radius:3px;margin-bottom:3px"><span style="font-weight:600;color:'+color+';font-size:11px;min-width:16px">'+cat+(i+1)+'</span><span style="flex:1;font-size:11px;color:var(--text-primary)">'+esc(item.text)+'</span><button data-ad="'+item.id+'" style="background:none;border:none;color:#f87171;cursor:pointer;font-size:11px">x</button></div>').join('');
      return '<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;padding-bottom:4px;border-bottom:2px solid '+color+'"><span style="font-size:12px;font-weight:600;color:'+color+'">'+cat+' - '+label+'</span><span style="font-size:10px;color:var(--text-muted)">'+grouped[cat].length+'</span></div>'+(items||'<div style="font-size:10px;color:var(--text-muted);padding:4px;text-align:center">Empty</div>')+'</div>';
    }).join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">ABC Prioritizer</span><button onclick="document.getElementById(\'abc-prio-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +sections
      +'<div style="display:flex;gap:4px;margin-top:4px"><input id="abc-input" placeholder="Add item..." style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"><select id="abc-cat" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"><option>A</option><option>B</option><option selected>C</option></select><button id="abc-add" style="padding:6px 10px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:11px">+</button></div>';
    p.querySelectorAll('[data-ad]').forEach(b=>{b.onclick=function(){S._abcItems=S._abcItems.filter(i=>i.id!==parseInt(this.dataset.ad));save();rend();};});
    document.getElementById('abc-add').onclick=function(){
      let text=document.getElementById('abc-input').value.trim();
      let cat=document.getElementById('abc-cat').value;
      if(!text)return;
      S._abcItems.push({id:Date.now(),text,cat});save();rend();
    };
    document.getElementById('abc-input').onkeydown=function(e){if(e.key==='Enter')document.getElementById('abc-add').click();};
  }
  document.body.appendChild(p);
  rend();
}
function showDockerComposeGen(){
  let p=document.getElementById('compose-panel');if(p)p.remove();
  p=document.createElement('div');p.id='compose-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:540px;width:90vw;max-height:80vh;overflow-y:auto';
  let presets=[
    {name:'Node + Postgres',code:'services:\n  app:\n    build: .\n    ports:\n      - "3000:3000"\n    environment:\n      - DATABASE_URL=postgresql://user:password@db:5432/mydb\n    depends_on:\n      - db\n\n  db:\n    image: postgres:16-alpine\n    environment:\n      POSTGRES_USER: user\n      POSTGRES_PASSWORD: password\n      POSTGRES_DB: mydb\n    ports:\n      - "5432:5432"\n    volumes:\n      - pgdata:/var/lib/postgresql/data\n\nvolumes:\n  pgdata:'},
    {name:'Node + Redis',code:'services:\n  app:\n    build: .\n    ports:\n      - "3000:3000"\n    environment:\n      - REDIS_URL=redis://cache:6379\n    depends_on:\n      - cache\n\n  cache:\n    image: redis:7-alpine\n    ports:\n      - "6379:6379"\n    volumes:\n      - redis-data:/data\n\nvolumes:\n  redis-data:'},
    {name:'Full Stack',code:'services:\n  frontend:\n    build:\n      context: ./frontend\n    ports:\n      - "3000:3000"\n    depends_on:\n      - api\n\n  api:\n    build:\n      context: ./api\n    ports:\n      - "8000:8000"\n    environment:\n      - DATABASE_URL=postgresql://user:pass@db:5432/app\n      - REDIS_URL=redis://cache:6379\n    depends_on:\n      - db\n      - cache\n\n  db:\n    image: postgres:16-alpine\n    environment:\n      POSTGRES_USER: user\n      POSTGRES_PASSWORD: pass\n      POSTGRES_DB: app\n    volumes:\n      - pgdata:/var/lib/postgresql/data\n\n  cache:\n    image: redis:7-alpine\n\nvolumes:\n  pgdata:'},
    {name:'Python + MongoDB',code:'services:\n  app:\n    build: .\n    ports:\n      - "8000:8000"\n    environment:\n      - MONGO_URI=mongodb://mongo:27017/mydb\n    depends_on:\n      - mongo\n\n  mongo:\n    image: mongo:7\n    ports:\n      - "27017:27017"\n    volumes:\n      - mongo-data:/data/db\n\nvolumes:\n  mongo-data:'}
  ];
  let selected=0;
  function rend(){
    let tabs=presets.map((pr,i)=>'<button data-ci="'+i+'" style="padding:4px 8px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:10px">'+pr.name+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Docker Compose Generator</span><button onclick="document.getElementById(\'compose-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tabs+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:300px;overflow-y:auto">'+esc(presets[selected].code)+'</pre>'
      +'<button id="cmp-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy docker-compose.yml</button>';
    p.querySelectorAll('[data-ci]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.ci);rend();};});
    document.getElementById('cmp-copy').onclick=function(){navigator.clipboard.writeText(presets[selected].code);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy docker-compose.yml';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskCreationTrend(){
  let p=document.getElementById('create-trend-panel');if(p)p.remove();
  p=document.createElement('div');p.id='create-trend-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let days=21;let now=new Date();
  let data=[];
  for(let d=days-1;d>=0;d--){
    let date=new Date(now);date.setDate(date.getDate()-d);
    let ds=date.toISOString().slice(0,10);
    let label=(date.getMonth()+1)+'/'+date.getDate();
    let created=tasks.filter(t=>{let c=t.created?new Date(t.created).toISOString().slice(0,10):null;return c===ds;}).length;
    let completed=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt).toISOString().slice(0,10)===ds).length;
    data.push({label,created,completed});
  }
  let maxV=Math.max(...data.map(d=>Math.max(d.created,d.completed)),1);
  let svgW=440,svgH=160,pad=30;
  let gap=(svgW-pad*2)/data.length;
  let createPts=data.map((d,i)=>{let x=pad+i*gap+gap/2;let y=svgH-pad-((d.created/maxV)*(svgH-pad*2));return x+','+y;}).join(' ');
  let donePts=data.map((d,i)=>{let x=pad+i*gap+gap/2;let y=svgH-pad-((d.completed/maxV)*(svgH-pad*2));return x+','+y;}).join(' ');
  let labels='';data.forEach((d,i)=>{if(i%3===0){let x=pad+i*gap+gap/2;labels+='<text x="'+x+'" y="'+(svgH-pad+14)+'" text-anchor="middle" fill="#888" font-size="8">'+d.label+'</text>';}});
  let svg='<svg viewBox="0 0 '+svgW+' '+svgH+'" style="width:100%"><rect width="'+svgW+'" height="'+svgH+'" fill="transparent"/><polyline points="'+createPts+'" fill="none" stroke="#22d3ee" stroke-width="2"/><polyline points="'+donePts+'" fill="none" stroke="#4ade80" stroke-width="2"/>'+labels+'</svg>';
  let totalC=data.reduce((s,d)=>s+d.created,0);
  let totalD=data.reduce((s,d)=>s+d.completed,0);
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Creation vs Completion (21 Days)</span><button onclick="document.getElementById(\'create-trend-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:12px;margin-bottom:10px"><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:#22d3ee">'+totalC+'</div><div style="font-size:9px;color:var(--text-muted)">Created</div></div><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:#4ade80">'+totalD+'</div><div style="font-size:9px;color:var(--text-muted)">Completed</div></div><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:'+(totalD>=totalC?'#4ade80':'#f87171')+'">'+(totalD>=totalC?'+':'')+( totalD-totalC)+'</div><div style="font-size:9px;color:var(--text-muted)">Net</div></div></div>'
    +'<div style="display:flex;gap:12px;justify-content:center;margin-bottom:6px"><span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text-muted)"><span style="width:12px;height:2px;background:#22d3ee;display:inline-block"></span>Created</span><span style="display:flex;align-items:center;gap:3px;font-size:9px;color:var(--text-muted)"><span style="width:12px;height:2px;background:#4ade80;display:inline-block"></span>Completed</span></div>'
    +svg;
  document.body.appendChild(p);
}
function showQuickDecisionLog(){
  let p=document.getElementById('decision-log-panel');if(p)p.remove();
  p=document.createElement('div');p.id='decision-log-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._decisions)S._decisions=[];
  function rend(){
    let list=S._decisions.slice().reverse().map((d,i)=>'<div style="padding:8px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:6px;border-left:3px solid '+(d.status==='active'?'#4ade80':d.status==='revisit'?'#fbbf24':'#94a3b8')+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-weight:600;color:var(--text-primary);font-size:12px">'+esc(d.title)+'</span><span style="font-size:9px;padding:2px 6px;border-radius:3px;background:'+(d.status==='active'?'rgba(74,222,128,0.15)':'var(--bg-base)')+';color:'+(d.status==='active'?'#4ade80':'var(--text-muted)')+'">'+d.status+'</span></div>'+(d.context?'<div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">Context: '+esc(d.context)+'</div>':'')+'<div style="font-size:9px;color:var(--text-muted)">'+new Date(d.ts).toLocaleDateString()+'</div></div>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Decision Log</span><button onclick="document.getElementById(\'decision-log-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">'+S._decisions.length+' decisions recorded</div>'
      +'<div style="max-height:300px;overflow-y:auto;margin-bottom:10px">'+(list||'<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:12px">No decisions logged yet</div>')+'</div>'
      +'<div style="display:grid;gap:4px"><input id="dec-title" placeholder="Decision made..." style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"><input id="dec-context" placeholder="Context/reasoning (optional)" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"><div style="display:flex;gap:4px"><select id="dec-status" style="padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"><option>active</option><option>revisit</option><option>archived</option></select><button id="dec-add" style="flex:1;padding:6px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:11px">Log Decision</button></div></div>';
    document.getElementById('dec-add').onclick=function(){
      let title=document.getElementById('dec-title').value.trim();
      if(!title)return;
      S._decisions.push({title,context:document.getElementById('dec-context').value.trim(),status:document.getElementById('dec-status').value,ts:Date.now()});
      save();rend();
    };
    document.getElementById('dec-title').onkeydown=function(e){if(e.key==='Enter')document.getElementById('dec-add').click();};
  }
  document.body.appendChild(p);
  rend();
}
function showGithubActionsGen(){
  let p=document.getElementById('gha-panel');if(p)p.remove();
  p=document.createElement('div');p.id='gha-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:540px;width:90vw;max-height:80vh;overflow-y:auto';
  let presets=[
    {name:'Node.js CI',code:'name: CI\n\non:\n  push:\n    branches: [main]\n  pull_request:\n    branches: [main]\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    strategy:\n      matrix:\n        node-version: [18, 20, 22]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ matrix.node-version }}\n          cache: npm\n      - run: npm ci\n      - run: npm test\n      - run: npm run build --if-present'},
    {name:'Deploy to Vercel',code:'name: Deploy\n\non:\n  push:\n    branches: [main]\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: amondnet/vercel-action@v25\n        with:\n          vercel-token: ${{ secrets.VERCEL_TOKEN }}\n          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}\n          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}\n          vercel-args: --prod'},
    {name:'Docker Build + Push',code:'name: Docker\n\non:\n  push:\n    branches: [main]\n    tags: [\"v*\"]\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: docker/setup-buildx-action@v3\n      - uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKER_USERNAME }}\n          password: ${{ secrets.DOCKER_PASSWORD }}\n      - uses: docker/build-push-action@v5\n        with:\n          push: true\n          tags: user/app:latest'},
    {name:'Python Test',code:'name: Python CI\n\non:\n  push:\n    branches: [main]\n  pull_request:\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    strategy:\n      matrix:\n        python-version: [\"3.10\", \"3.11\", \"3.12\"]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-python@v5\n        with:\n          python-version: ${{ matrix.python-version }}\n      - run: pip install -r requirements.txt\n      - run: pip install pytest\n      - run: pytest'},
    {name:'Release',code:'name: Release\n\non:\n  push:\n    tags: [\"v*\"]\n\njobs:\n  release:\n    runs-on: ubuntu-latest\n    permissions:\n      contents: write\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/create-release@v1\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n        with:\n          tag_name: ${{ github.ref_name }}\n          release_name: Release ${{ github.ref_name }}\n          draft: false\n          prerelease: false'}
  ];
  let selected=0;
  function rend(){
    let tabs=presets.map((pr,i)=>'<button data-ghi="'+i+'" style="padding:4px 8px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:10px">'+pr.name+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">GitHub Actions Generator</span><button onclick="document.getElementById(\'gha-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tabs+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:10px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:8px;line-height:1.4;max-height:300px;overflow-y:auto">'+esc(presets[selected].code)+'</pre>'
      +'<button id="gha-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy Workflow</button>';
    p.querySelectorAll('[data-ghi]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.ghi);rend();};});
    document.getElementById('gha-copy').onclick=function(){navigator.clipboard.writeText(presets[selected].code);this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy Workflow';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskDoneVsCreated(){
  let p=document.getElementById('done-vs-created-panel');if(p)p.remove();
  p=document.createElement('div');p.id='done-vs-created-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let projects=(S.projects||[]);
  let projData=projects.map(pr=>{
    let pTasks=tasks.filter(t=>t.projectId===pr.id);
    let created=pTasks.length;
    let done=pTasks.filter(t=>t.status==='done').length;
    return {name:pr.name,created,done,pct:created>0?Math.round(done/created*100):0};
  }).filter(p=>p.created>0).sort((a,b)=>b.created-a.created);
  let maxC=Math.max(...projData.map(p=>p.created),1);
  let rows=projData.map(pr=>{
    let cW=Math.round(pr.created/maxC*100);
    let dW=Math.round(pr.done/maxC*100);
    return '<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:11px;color:var(--text-primary);font-weight:600">'+esc(pr.name)+'</span><span style="font-size:10px;color:var(--text-muted)">'+pr.pct+'%</span></div><div style="position:relative;height:14px;background:var(--bg-surface);border-radius:3px;overflow:hidden"><div style="position:absolute;top:0;left:0;height:100%;width:'+cW+'%;background:#22d3ee30;border-radius:3px"></div><div style="position:absolute;top:0;left:0;height:100%;width:'+dW+'%;background:#4ade80;border-radius:3px"></div></div><div style="display:flex;gap:8px;margin-top:2px"><span style="font-size:9px;color:#22d3ee">Created: '+pr.created+'</span><span style="font-size:9px;color:#4ade80">Done: '+pr.done+'</span></div></div>';
  }).join('');
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Done vs Created by Project</span><button onclick="document.getElementById(\'done-vs-created-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +(rows||'<div style="text-align:center;color:var(--text-muted);padding:20px">No project data available</div>');
  document.body.appendChild(p);
}
function showQuickWinStreak(){
  let p=document.getElementById('win-streak-panel');if(p)p.remove();
  p=document.createElement('div');p.id='win-streak-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px';
  if(!S._wins)S._wins=[];
  let today=new Date().toISOString().slice(0,10);
  function rend(){
    let todayWins=S._wins.filter(w=>w.date===today);
    let streak=0;
    let d=new Date();
    while(true){
      let ds=d.toISOString().slice(0,10);
      if(S._wins.some(w=>w.date===ds)){streak++;d.setDate(d.getDate()-1);}
      else break;
    }
    let list=todayWins.map(w=>'<div style="padding:4px 6px;background:var(--bg-surface);border-radius:3px;margin-bottom:3px;font-size:11px;color:var(--text-primary);border-left:2px solid #4ade80">'+esc(w.text)+'</div>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Win Streak</span><button onclick="document.getElementById(\'win-streak-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="display:flex;gap:8px;margin-bottom:8px"><div style="flex:1;padding:6px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:#4ade80">'+todayWins.length+'</div><div style="font-size:9px;color:var(--text-muted)">Today</div></div><div style="flex:1;padding:6px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:18px;font-weight:700;color:#fbbf24">'+streak+'</div><div style="font-size:9px;color:var(--text-muted)">Day Streak</div></div></div>'
      +(list||'<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:6px">Log your wins!</div>')
      +'<div style="display:flex;gap:4px;margin-top:6px"><input id="win-input" placeholder="What did you win today?" style="flex:1;padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:10px"><button id="win-add" style="padding:5px 10px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:10px">+</button></div>';
    document.getElementById('win-add').onclick=function(){
      let v=document.getElementById('win-input').value.trim();
      if(!v)return;
      S._wins.push({text:v,date:today,ts:Date.now()});save();rend();
    };
    document.getElementById('win-input').onkeydown=function(e){if(e.key==='Enter')document.getElementById('win-add').click();};
  }
  document.body.appendChild(p);
  rend();
}
function showLicenseGen(){
  let p=document.getElementById('license-panel');if(p)p.remove();
  p=document.createElement('div');p.id='license-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let year=new Date().getFullYear();
  let name=S._licenseName||'Your Name';
  let licenses=[
    {name:'MIT',text:'MIT License\n\nCopyright (c) '+year+' [NAME]\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the "Software"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.'},
    {name:'Apache 2.0',text:'Apache License\nVersion 2.0, January 2004\n\nCopyright '+year+' [NAME]\n\nLicensed under the Apache License, Version 2.0 (the "License");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.'},
    {name:'ISC',text:'ISC License\n\nCopyright (c) '+year+' [NAME]\n\nPermission to use, copy, modify, and/or distribute this software for any\npurpose with or without fee is hereby granted, provided that the above\ncopyright notice and this permission notice appear in all copies.\n\nTHE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\nINDIRECT, OR CONSEQUENTIAL DAMAGES.'},
    {name:'Unlicense',text:'This is free and unencumbered software released into the public domain.\n\nAnyone is free to copy, modify, publish, use, compile, sell, or\ndistribute this software, either in source code form or as a compiled\nbinary, for any purpose, commercial or non-commercial, and by any\nmeans.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND.'}
  ];
  let selected=0;
  function getOutput(){return licenses[selected].text.replace(/\[NAME\]/g,name);}
  function rend(){
    let tabs=licenses.map((l,i)=>'<button data-li="'+i+'" style="padding:4px 10px;border-radius:var(--radius);border:1px solid '+(i===selected?'#4ade80':'var(--border)')+';background:'+(i===selected?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(i===selected?'#4ade80':'var(--text-muted)')+';cursor:pointer;font-size:11px">'+l.name+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">LICENSE Generator</span><button onclick="document.getElementById(\'license-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:flex;gap:6px;margin-bottom:8px;align-items:center"><label style="font-size:11px;color:var(--text-muted)">Name:</label><input id="lic-name" value="'+esc(name)+'" style="flex:1;padding:5px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px"></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">'+tabs+'</div>'
      +'<pre style="background:#0a0a0f;border:1px solid var(--border);border-radius:var(--radius);padding:10px;font-size:9px;color:#4ade80;overflow-x:auto;white-space:pre-wrap;margin-bottom:8px;line-height:1.4;max-height:250px;overflow-y:auto">'+esc(getOutput())+'</pre>'
      +'<button id="lic-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy LICENSE</button>';
    p.querySelectorAll('[data-li]').forEach(b=>{b.onclick=function(){selected=parseInt(this.dataset.li);rend();};});
    document.getElementById('lic-name').oninput=function(){name=this.value;S._licenseName=name;save();rend();};
    document.getElementById('lic-copy').onclick=function(){navigator.clipboard.writeText(getOutput());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy LICENSE';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskBlockedTime(){
  let p=document.getElementById('blocked-time-panel');if(p)p.remove();
  p=document.createElement('div');p.id='blocked-time-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:80vh;overflow-y:auto';
  let tasks=(S.tasks||[]);
  let blocked=tasks.filter(t=>t.blockedBy&&t.blockedBy.length>0&&t.status!=='done');
  let now=Date.now();
  let items=blocked.map(t=>{
    let age=Math.round((now-(t.created||now))/86400000);
    return {title:t.title,age,priority:t.priority||'p3',blockers:t.blockedBy.length};
  }).sort((a,b)=>b.age-a.age);
  let totalBlockedDays=items.reduce((s,i)=>s+i.age,0);
  let priorityColors={p0:'#f87171',p1:'#fb923c',p2:'#60a5fa',p3:'#6b7280'};
  let rows=items.map(i=>'<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:4px"><span style="width:6px;height:6px;border-radius:50%;background:'+( priorityColors[i.priority]||'#6b7280')+'"></span><span style="flex:1;font-size:11px;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(i.title)+'</span><span style="font-size:10px;color:#f87171;font-weight:600;min-width:40px;text-align:right">'+i.age+'d</span><span style="font-size:9px;color:var(--text-muted);min-width:30px;text-align:right">'+i.blockers+' dep</span></div>').join('');
  p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Blocked Time Analysis</span><button onclick="document.getElementById(\'blocked-time-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
    +'<div style="display:flex;gap:12px;margin-bottom:12px"><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:20px;font-weight:700;color:#f87171">'+items.length+'</div><div style="font-size:9px;color:var(--text-muted)">Blocked</div></div><div style="flex:1;padding:8px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:20px;font-weight:700;color:var(--text-primary)">'+totalBlockedDays+'</div><div style="font-size:9px;color:var(--text-muted)">Total Days</div></div></div>'
    +(rows||'<div style="text-align:center;color:var(--text-muted);padding:20px">No blocked tasks</div>');
  document.body.appendChild(p);
}
function showQuickReadingLog(){
  let p=document.getElementById('reading-log-panel');if(p)p.remove();
  p=document.createElement('div');p.id='reading-log-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:280px';
  if(!S._readingLog)S._readingLog=[];
  function rend(){
    let current=S._readingLog.filter(b=>b.status==='reading');
    let finished=S._readingLog.filter(b=>b.status==='finished').length;
    let list=current.map((b,i)=>'<div style="padding:6px;background:var(--bg-surface);border-radius:var(--radius);margin-bottom:4px"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:11px;font-weight:600;color:var(--text-primary)">'+esc(b.title)+'</span><button data-rf="'+b.id+'" style="background:none;border:none;color:#4ade80;cursor:pointer;font-size:9px">Done</button></div>'+(b.author?'<div style="font-size:9px;color:var(--text-muted)">by '+esc(b.author)+'</div>':'')+'<div style="height:3px;background:var(--bg-base);border-radius:2px;margin-top:4px;overflow:hidden"><div style="height:100%;width:'+(b.progress||0)+'%;background:#4ade80;border-radius:2px"></div></div><div style="font-size:8px;color:var(--text-muted);margin-top:2px">'+(b.progress||0)+'% complete</div></div>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Reading Log</span><button onclick="document.getElementById(\'reading-log-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="display:flex;gap:8px;margin-bottom:8px"><div style="flex:1;padding:6px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:16px;font-weight:700;color:#22d3ee">'+current.length+'</div><div style="font-size:9px;color:var(--text-muted)">Reading</div></div><div style="flex:1;padding:6px;background:var(--bg-surface);border-radius:var(--radius);text-align:center"><div style="font-size:16px;font-weight:700;color:#4ade80">'+finished+'</div><div style="font-size:9px;color:var(--text-muted)">Finished</div></div></div>'
      +(list||'<div style="font-size:10px;color:var(--text-muted);text-align:center;padding:6px">No books currently reading</div>')
      +'<div style="display:grid;gap:3px;margin-top:6px"><input id="rl-title" placeholder="Book title" style="padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:10px"><input id="rl-author" placeholder="Author (optional)" style="padding:4px 6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:var(--text-primary);font-size:10px"><button id="rl-add" style="padding:5px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:10px">Add Book</button></div>';
    p.querySelectorAll('[data-rf]').forEach(b=>{b.onclick=function(){let id=parseInt(this.dataset.rf);let book=S._readingLog.find(b=>b.id===id);if(book)book.status='finished';save();rend();};});
    document.getElementById('rl-add').onclick=function(){
      let title=document.getElementById('rl-title').value.trim();
      if(!title)return;
      S._readingLog.push({id:Date.now(),title,author:document.getElementById('rl-author').value.trim(),status:'reading',progress:0,ts:Date.now()});
      save();rend();
    };
  }
  document.body.appendChild(p);
  rend();
}
function showCronJobGen(){
  let p=document.getElementById('cron-panel');if(p)p.remove();
  p=document.createElement('div');p.id='cron-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  let cfg=S._cronCfg||{min:'0',hr:'*',dom:'*',mon:'*',dow:'*'};
  let presets=[
    {label:'Every minute',v:{min:'*',hr:'*',dom:'*',mon:'*',dow:'*'}},
    {label:'Every hour',v:{min:'0',hr:'*',dom:'*',mon:'*',dow:'*'}},
    {label:'Daily midnight',v:{min:'0',hr:'0',dom:'*',mon:'*',dow:'*'}},
    {label:'Daily 9 AM',v:{min:'0',hr:'9',dom:'*',mon:'*',dow:'*'}},
    {label:'Weekly Monday',v:{min:'0',hr:'0',dom:'*',mon:'*',dow:'1'}},
    {label:'Monthly 1st',v:{min:'0',hr:'0',dom:'1',mon:'*',dow:'*'}},
    {label:'Every 5 min',v:{min:'*/5',hr:'*',dom:'*',mon:'*',dow:'*'}},
    {label:'Every 30 min',v:{min:'*/30',hr:'*',dom:'*',mon:'*',dow:'*'}},
    {label:'Weekdays 8 AM',v:{min:'0',hr:'8',dom:'*',mon:'*',dow:'1-5'}},
    {label:'Every 6 hours',v:{min:'0',hr:'*/6',dom:'*',mon:'*',dow:'*'}}
  ];
  function getCron(){return cfg.min+' '+cfg.hr+' '+cfg.dom+' '+cfg.mon+' '+cfg.dow;}
  function describe(){
    let c=getCron();
    if(c==='* * * * *')return 'Every minute';
    if(c==='0 * * * *')return 'Every hour at minute 0';
    if(c.match(/^0 0 \* \* \*$/))return 'Daily at midnight';
    if(c.match(/^0 \d+ \* \* \*$/))return 'Daily at '+cfg.hr+':00';
    if(c.match(/^\*\/(\d+) \* \* \* \*$/))return 'Every '+cfg.min.split('/')[1]+' minutes';
    return c;
  }
  function rend(){
    let fields=[
      {k:'min',label:'Minute',placeholder:'0-59, */5'},
      {k:'hr',label:'Hour',placeholder:'0-23, */2'},
      {k:'dom',label:'Day (month)',placeholder:'1-31'},
      {k:'mon',label:'Month',placeholder:'1-12'},
      {k:'dow',label:'Day (week)',placeholder:'0-6 (Sun=0)'}
    ];
    let fieldHtml=fields.map(f=>'<div style="text-align:center"><label style="font-size:9px;color:var(--text-muted);display:block;margin-bottom:2px">'+f.label+'</label><input data-ck="'+f.k+'" value="'+esc(cfg[f.k])+'" placeholder="'+f.placeholder+'" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:#4ade80;font-family:monospace;font-size:14px;text-align:center;box-sizing:border-box"></div>').join('');
    let presetBtns=presets.map(pr=>'<button data-cp="'+esc(JSON.stringify(pr.v))+'" style="padding:3px 8px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg-surface);color:var(--text-muted);cursor:pointer;font-size:10px">'+pr.label+'</button>').join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Cron Job Generator</span><button onclick="document.getElementById(\'cron-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:12px">'+fieldHtml+'</div>'
      +'<div style="text-align:center;margin-bottom:10px"><div style="font-family:monospace;font-size:18px;font-weight:700;color:#4ade80;margin-bottom:4px">'+getCron()+'</div><div style="font-size:11px;color:var(--text-muted)">'+describe()+'</div></div>'
      +'<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:10px;justify-content:center">'+presetBtns+'</div>'
      +'<button id="cron-copy" style="width:100%;padding:8px;background:var(--accent);color:var(--bg-base);border:none;border-radius:var(--radius);cursor:pointer;font-weight:600">Copy Cron Expression</button>';
    p.querySelectorAll('[data-ck]').forEach(inp=>{inp.oninput=function(){cfg[this.dataset.ck]=this.value;S._cronCfg=cfg;save();rend();};});
    p.querySelectorAll('[data-cp]').forEach(b=>{b.onclick=function(){cfg=JSON.parse(this.dataset.cp);S._cronCfg=cfg;save();rend();};});
    document.getElementById('cron-copy').onclick=function(){navigator.clipboard.writeText(getCron());this.textContent='Copied!';setTimeout(()=>{this.textContent='Copy Cron Expression';},1200);};
  }
  document.body.appendChild(p);
  rend();
}
function showTaskSprintBoard(){
  let p=document.getElementById('sprint-panel');if(p)p.remove();
  p=document.createElement('div');p.id='sprint-panel';
  p.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  if(!S._sprints)S._sprints=[];
  let now=new Date();
  let current=S._sprints.find(s=>new Date(s.end)>=now&&new Date(s.start)<=now);
  if(!current){
    let start=new Date(now);start.setDate(start.getDate()-start.getDay()+1);
    let end=new Date(start);end.setDate(end.getDate()+13);
    current={id:Date.now(),name:'Sprint '+(S._sprints.length+1),start:start.toISOString().slice(0,10),end:end.toISOString().slice(0,10),tasks:[]};
    S._sprints.push(current);save();
  }
  let tasks=(S.tasks||[]);
  let sprintTasks=tasks.filter(t=>current.tasks.includes(t.id));
  let available=tasks.filter(t=>t.status!=='done'&&!current.tasks.includes(t.id));
  let done=sprintTasks.filter(t=>t.status==='done').length;
  let total=sprintTasks.length;
  let pct=total>0?Math.round(done/total*100):0;
  let daysLeft=Math.max(Math.ceil((new Date(current.end)-now)/86400000),0);
  function rend(){
    sprintTasks=tasks.filter(t=>current.tasks.includes(t.id));
    done=sprintTasks.filter(t=>t.status==='done').length;
    total=sprintTasks.length;
    pct=total>0?Math.round(done/total*100):0;
    let taskRows=sprintTasks.map(t=>{
      let statusColor=t.status==='done'?'#4ade80':t.status==='in-progress'?'#22d3ee':'#fbbf24';
      return '<div style="display:flex;align-items:center;gap:6px;padding:4px;background:var(--bg-surface);border-radius:3px;margin-bottom:3px"><span style="width:6px;height:6px;border-radius:50%;background:'+statusColor+'"></span><span style="flex:1;font-size:11px;color:var(--text-primary);'+(t.status==='done'?'text-decoration:line-through;opacity:0.5':'')+'">'+esc(t.title)+'</span><span style="font-size:9px;color:'+statusColor+'">'+t.status+'</span></div>';
    }).join('');
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">'+esc(current.name)+'</span><button onclick="document.getElementById(\'sprint-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">X</button></div>'
      +'<div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">'+current.start+' to '+current.end+' | '+daysLeft+' days left</div>'
      +'<div style="height:8px;background:var(--bg-surface);border-radius:4px;overflow:hidden;margin-bottom:8px"><div style="height:100%;width:'+pct+'%;background:#4ade80;transition:width 0.3s"></div></div>'
      +'<div style="font-size:10px;color:var(--text-muted);margin-bottom:10px">'+done+'/'+total+' tasks done ('+pct+'%)</div>'
      +(taskRows||'<div style="text-align:center;color:var(--text-muted);padding:10px;font-size:11px">No tasks in sprint. Add from below.</div>')
      +'<div style="margin-top:10px;border-top:1px solid var(--border);padding-top:8px"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Add to sprint ('+available.length+' available)</div><select id="sprint-add-sel" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-size:11px;margin-bottom:4px">'+available.slice(0,20).map(t=>'<option value="'+t.id+'">'+esc(t.title)+'</option>').join('')+'</select><button id="sprint-add-btn" style="width:100%;padding:6px;background:#4ade80;color:#000;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:11px">Add to Sprint</button></div>';
    document.getElementById('sprint-add-btn').onclick=function(){
      let sel=document.getElementById('sprint-add-sel');
      if(!sel.value)return;
      current.tasks.push(sel.value);save();rend();
    };
  }
  document.body.appendChild(p);
  rend();
}
function showQuickMorningRoutine(){
  let p=document.getElementById('morning-panel');if(p)p.remove();
  p=document.createElement('div');p.id='morning-panel';
  p.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.6);width:260px';
  let today=new Date().toISOString().slice(0,10);
  if(!S._morningRoutine)S._morningRoutine={items:[
    {id:1,text:'Drink water',emoji:''},
    {id:2,text:'5 min stretch',emoji:''},
    {id:3,text:'Review today tasks',emoji:''},
    {id:4,text:'Set top 3 priorities',emoji:''},
    {id:5,text:'Clear inbox',emoji:''}
  ],log:{}};
  let routine=S._morningRoutine;
  if(!routine.log[today])routine.log[today]=[];
  function rend(){
    let checked=routine.log[today]||[];
    let items=routine.items.map(item=>{
      let isDone=checked.includes(item.id);
      return '<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border)"><input type="checkbox" data-mi="'+item.id+'" '+(isDone?'checked':'')+' style="cursor:pointer"><span style="flex:1;font-size:11px;color:var(--text-primary);'+(isDone?'text-decoration:line-through;opacity:0.5':'')+'">'+esc(item.text)+'</span></div>';
    }).join('');
    let done=checked.length;
    let total=routine.items.length;
    let pct=total>0?Math.round(done/total*100):0;
    let streak=0;let d=new Date();
    while(true){
      let ds=d.toISOString().slice(0,10);
      let dayLog=routine.log[ds]||[];
      if(dayLog.length===routine.items.length){streak++;d.setDate(d.getDate()-1);}
      else break;
    }
    p.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;color:var(--text-primary);font-size:13px">Morning Routine</span><button onclick="document.getElementById(\'morning-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px">X</button></div>'
      +'<div style="height:4px;background:var(--bg-surface);border-radius:2px;overflow:hidden;margin-bottom:6px"><div style="height:100%;width:'+pct+'%;background:#4ade80;transition:width 0.3s"></div></div>'
      +'<div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:10px;color:var(--text-muted)"><span>'+done+'/'+total+' ('+pct+'%)</span><span>Streak: '+streak+' days</span></div>'
      +items;
    p.querySelectorAll('[data-mi]').forEach(cb=>{
      cb.onchange=function(){
        let id=parseInt(this.dataset.mi);
        if(this.checked){if(!routine.log[today].includes(id))routine.log[today].push(id);}
        else{routine.log[today]=routine.log[today].filter(i=>i!==id);}
        S._morningRoutine=routine;save();rend();
      };
    });
  }
  document.body.appendChild(p);
  rend();
}
function showMakefileGen(){
  let ex=document.getElementById('makefile-gen-float');if(ex){ex.remove();return;}
  const presets={
    'C Project':`CC=gcc\nCFLAGS=-Wall -Wextra -std=c11\nSRC=$(wildcard src/*.c)\nOBJ=$(SRC:.c=.o)\nTARGET=app\n\nall: $(TARGET)\n\n$(TARGET): $(OBJ)\n\t$(CC) $(CFLAGS) -o $@ $^\n\n%.o: %.c\n\t$(CC) $(CFLAGS) -c $< -o $@\n\nclean:\n\trm -f $(OBJ) $(TARGET)\n\n.PHONY: all clean`,
    'Node.js':`NODE=node\nNPM=npm\n\ninstall:\n\t$(NPM) install\n\ndev:\n\t$(NPM) run dev\n\nbuild:\n\t$(NPM) run build\n\ntest:\n\t$(NPM) test\n\nlint:\n\t$(NPM) run lint\n\nclean:\n\trm -rf node_modules dist\n\n.PHONY: install dev build test lint clean`,
    'Python':`PYTHON=python3\nVENV=.venv\nPIP=$(VENV)/bin/pip\n\nvenv:\n\t$(PYTHON) -m venv $(VENV)\n\ninstall: venv\n\t$(PIP) install -r requirements.txt\n\nrun:\n\t$(VENV)/bin/python main.py\n\ntest:\n\t$(VENV)/bin/pytest tests/\n\nlint:\n\t$(VENV)/bin/flake8 src/\n\nclean:\n\trm -rf $(VENV) __pycache__ .pytest_cache\n\n.PHONY: venv install run test lint clean`,
    'Docker':`IMAGE=myapp\nTAG=latest\n\nbuild:\n\tdocker build -t $(IMAGE):$(TAG) .\n\nrun:\n\tdocker run -d -p 8080:8080 $(IMAGE):$(TAG)\n\nstop:\n\tdocker stop $$(docker ps -q --filter ancestor=$(IMAGE):$(TAG))\n\npush:\n\tdocker push $(IMAGE):$(TAG)\n\nclean:\n\tdocker rmi $(IMAGE):$(TAG)\n\n.PHONY: build run stop push clean`,
    'Go':`BINARY=app\nGO=go\n\nbuild:\n\t$(GO) build -o $(BINARY) ./cmd/...\n\nrun: build\n\t./$(BINARY)\n\ntest:\n\t$(GO) test ./...\n\nlint:\n\tgolangci-lint run\n\nclean:\n\trm -f $(BINARY)\n\n.PHONY: build run test lint clean`
  };
  let sel='C Project';
  const d=document.createElement('div');d.id='makefile-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-mkpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-mkpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Makefile Generator</span><span onclick="document.getElementById('makefile-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#makefile-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Makefile',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy Makefile</button>
    </div>`;
    d.querySelectorAll('[data-mkpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.mkpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskOverdueChart(){
  let ex=document.getElementById('overdue-chart-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&t.due);
  const now=new Date();now.setHours(0,0,0,0);
  const buckets={'On Time':0,'1 day':0,'2-3 days':0,'4-7 days':0,'1-2 weeks':0,'2+ weeks':0};
  tasks.forEach(t=>{
    const dd=new Date(t.due);dd.setHours(0,0,0,0);
    const diff=Math.floor((now-dd)/(1000*60*60*24));
    if(diff<=0) buckets['On Time']++;
    else if(diff===1) buckets['1 day']++;
    else if(diff<=3) buckets['2-3 days']++;
    else if(diff<=7) buckets['4-7 days']++;
    else if(diff<=14) buckets['1-2 weeks']++;
    else buckets['2+ weeks']++;
  });
  const keys=Object.keys(buckets);const vals=Object.values(buckets);
  const mx=Math.max(...vals,1);
  const colors=['#4ade80','#facc15','#fb923c','#f87171','#ef4444','#dc2626'];
  const bars=keys.map((k,i)=>{const h=Math.round((vals[i]/mx)*120);return `<rect x="${i*50+10}" y="${140-h}" width="36" height="${h}" rx="3" fill="${colors[i]}" opacity="0.85"/><text x="${i*50+28}" y="${155}" text-anchor="middle" fill="var(--text-muted)" font-size="8">${k}</text><text x="${i*50+28}" y="${138-h}" text-anchor="middle" fill="var(--text-primary)" font-size="10" font-weight="600">${vals[i]}</text>`;}).join('');
  const d=document.createElement('div');d.id='overdue-chart-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Overdue Distribution</span><span onclick="document.getElementById('overdue-chart-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <svg width="320" height="165" viewBox="0 0 320 165">${bars}</svg>
    <div style="margin-top:8px;font-size:10px;color:var(--text-muted)">${tasks.length} tasks with due dates | ${vals.slice(1).reduce((a,b)=>a+b,0)} overdue</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickWaterIntake(){
  let ex=document.getElementById('water-intake-float');if(ex){ex.remove();return;}
  const today=new Date().toISOString().split('T')[0];
  if(!S._waterLog) S._waterLog={};
  if(!S._waterLog[today]) S._waterLog[today]=0;
  const goal=8;
  const d=document.createElement('div');d.id='water-intake-float';
  const rend=()=>{
    const ct=S._waterLog[today]||0;
    const pct=Math.min(Math.round((ct/goal)*100),100);
    const drops=Array.from({length:goal},(_, i)=>`<div onclick="window._waterTap(${i})" style="width:28px;height:36px;border-radius:0 50% 50% 50%;transform:rotate(45deg);cursor:pointer;${i<ct?'background:linear-gradient(135deg,#22d3ee,#06b6d4)':'background:var(--bg-surface);border:1px solid var(--border)'};transition:all 0.2s" title="Glass ${i+1}"></div>`).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:220px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Water Intake</span><span onclick="document.getElementById('water-intake-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:10px">${drops}</div>
      <div style="background:var(--bg-surface);border-radius:6px;height:8px;overflow:hidden;margin-bottom:6px"><div style="height:100%;width:${pct}%;background:linear-gradient(90deg,#22d3ee,#4ade80);border-radius:6px;transition:width 0.3s"></div></div>
      <div style="text-align:center;font-size:11px;color:var(--text-muted)">${ct}/${goal} glasses (${pct}%)</div>
      ${ct>=goal?'<div style="text-align:center;margin-top:6px;font-size:11px;color:#4ade80;font-weight:600">Goal reached!</div>':''}
    </div>`;
  };
  window._waterTap=(i)=>{S._waterLog[today]=i+1;save();rend();};
  document.body.appendChild(d);rend();
}
function showWebpackConfigGen(){
  let ex=document.getElementById('webpack-gen-float');if(ex){ex.remove();return;}
  const presets={
    'React':`const path = require('path');\nconst HtmlWebpackPlugin = require('html-webpack-plugin');\n\nmodule.exports = {\n  entry: './src/index.jsx',\n  output: {\n    path: path.resolve(__dirname, 'dist'),\n    filename: '[name].[contenthash].js',\n    clean: true\n  },\n  module: {\n    rules: [\n      { test: /\\.jsx?$/, exclude: /node_modules/, use: 'babel-loader' },\n      { test: /\\.css$/, use: ['style-loader', 'css-loader'] },\n      { test: /\\.(png|svg|jpg)$/, type: 'asset/resource' }\n    ]\n  },\n  plugins: [new HtmlWebpackPlugin({ template: './public/index.html' })],\n  resolve: { extensions: ['.js', '.jsx'] },\n  devServer: { port: 3000, hot: true, open: true }\n};`,
    'TypeScript':`const path = require('path');\n\nmodule.exports = {\n  entry: './src/index.ts',\n  output: {\n    path: path.resolve(__dirname, 'dist'),\n    filename: 'bundle.js',\n    clean: true\n  },\n  module: {\n    rules: [\n      { test: /\\.tsx?$/, use: 'ts-loader', exclude: /node_modules/ }\n    ]\n  },\n  resolve: { extensions: ['.ts', '.tsx', '.js'] },\n  devtool: 'source-map'\n};`,
    'Library':`const path = require('path');\n\nmodule.exports = {\n  entry: './src/index.js',\n  output: {\n    path: path.resolve(__dirname, 'dist'),\n    filename: 'index.js',\n    library: { name: 'MyLib', type: 'umd' },\n    globalObject: 'this',\n    clean: true\n  },\n  externals: {},\n  module: {\n    rules: [\n      { test: /\\.js$/, exclude: /node_modules/, use: 'babel-loader' }\n    ]\n  }\n};`,
    'Node.js':`const path = require('path');\nconst nodeExternals = require('webpack-node-externals');\n\nmodule.exports = {\n  target: 'node',\n  entry: './src/server.js',\n  output: {\n    path: path.resolve(__dirname, 'dist'),\n    filename: 'server.js',\n    clean: true\n  },\n  externals: [nodeExternals()],\n  module: {\n    rules: [\n      { test: /\\.js$/, exclude: /node_modules/, use: 'babel-loader' }\n    ]\n  }\n};`
  };
  let sel='React';
  const d=document.createElement('div');d.id='webpack-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-wpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-wpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:620px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Webpack Config Generator</span><span onclick="document.getElementById('webpack-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#webpack-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Config',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy Config</button>
    </div>`;
    d.querySelectorAll('[data-wpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.wpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskTagCloud(){
  let ex=document.getElementById('tag-cloud-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const tagMap={};
  tasks.forEach(t=>{
    if(t.project){tagMap[t.project]=(tagMap[t.project]||0)+1;}
    if(t.priority){tagMap['P'+t.priority]=(tagMap['P'+t.priority]||0)+1;}
    if(t.status){tagMap[t.status]=(tagMap[t.status]||0)+1;}
  });
  const content=(S.content||[]);
  content.forEach(c=>{
    if(c.tags&&Array.isArray(c.tags)){c.tags.forEach(tg=>{tagMap[tg]=(tagMap[tg]||0)+1;});}
    if(c.theme){tagMap[c.theme]=(tagMap[c.theme]||0)+1;}
  });
  const entries=Object.entries(tagMap).sort((a,b)=>b[1]-a[1]).slice(0,40);
  const mx=entries.length?entries[0][1]:1;
  const colors=['#4ade80','#22d3ee','#a78bfa','#fb923c','#f87171','#facc15','#34d399','#60a5fa'];
  const tags=entries.map((e,i)=>{
    const sz=Math.max(10,Math.round((e[1]/mx)*28));
    return `<span style="font-size:${sz}px;color:${colors[i%colors.length]};padding:4px 8px;display:inline-block;cursor:default;opacity:${0.6+(e[1]/mx)*0.4}" title="${e[1]} items">${esc(e[0])}</span>`;
  }).join('');
  const d=document.createElement('div');d.id='tag-cloud-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Tag Cloud</span><span onclick="document.getElementById('tag-cloud-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="text-align:center;line-height:2.2">${tags||'<span style="color:var(--text-muted);font-size:12px">No tags found</span>'}</div>
    <div style="margin-top:12px;font-size:10px;color:var(--text-muted);text-align:center">${entries.length} unique tags from ${tasks.length} tasks + ${content.length} content items</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickAffirmation(){
  let ex=document.getElementById('affirmation-float');if(ex){ex.remove();return;}
  const affirmations=[
    'I am capable of solving any challenge that comes my way.',
    'My code makes a difference and creates value.',
    'I grow stronger with every problem I solve.',
    'Progress, not perfection, is what matters.',
    'I trust my ability to figure things out.',
    'Today I will ship something I am proud of.',
    'I am building something meaningful.',
    'Every line of code is a step forward.',
    'I embrace complexity and turn it into clarity.',
    'My work ethic is my superpower.',
    'I am not behind. I am exactly where I need to be.',
    'The obstacle is the way.',
    'I choose progress over procrastination.',
    'My focus is my greatest asset.',
    'I am creating the future I want to live in.'
  ];
  const pick=affirmations[Math.floor(Math.random()*affirmations.length)];
  const d=document.createElement('div');d.id='affirmation-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:32px 28px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;text-align:center">
    <div style="font-size:14px;color:var(--text-muted);margin-bottom:16px;letter-spacing:1px">DAILY AFFIRMATION</div>
    <div style="font-size:20px;color:var(--text-primary);line-height:1.6;font-weight:300;margin-bottom:24px;font-style:italic">"${esc(pick)}"</div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button onclick="document.getElementById('affirmation-float').remove();showQuickAffirmation()" style="background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px">Another</button>
      <button onclick="navigator.clipboard.writeText('${esc(pick).replace(/'/g,"\\'")}');this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy</button>
      <button onclick="document.getElementById('affirmation-float').remove()" style="background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px">Close</button>
    </div>
  </div>`;
  document.body.appendChild(d);
}
function showBabelConfigGen(){
  let ex=document.getElementById('babel-gen-float');if(ex){ex.remove();return;}
  const presets={
    'React + ES2022':`{\n  "presets": [\n    ["@babel/preset-env", {\n      "targets": "> 0.25%, not dead",\n      "useBuiltIns": "usage",\n      "corejs": 3\n    }],\n    ["@babel/preset-react", {\n      "runtime": "automatic"\n    }]\n  ],\n  "plugins": [\n    "@babel/plugin-proposal-optional-chaining",\n    "@babel/plugin-proposal-nullish-coalescing-operator"\n  ]\n}`,
    'TypeScript':`{\n  "presets": [\n    ["@babel/preset-env", {\n      "targets": { "node": "current" }\n    }],\n    "@babel/preset-typescript"\n  ],\n  "plugins": [\n    ["@babel/plugin-proposal-decorators", { "legacy": true }],\n    "@babel/plugin-proposal-class-properties"\n  ]\n}`,
    'Node.js':`{\n  "presets": [\n    ["@babel/preset-env", {\n      "targets": { "node": "18" },\n      "modules": "commonjs"\n    }]\n  ],\n  "plugins": [\n    "@babel/plugin-transform-runtime"\n  ]\n}`,
    'Minimal':`{\n  "presets": [\n    ["@babel/preset-env", {\n      "targets": "> 1%, not dead"\n    }]\n  ]\n}`
  };
  let sel='React + ES2022';
  const d=document.createElement('div');d.id='babel-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-bpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-bpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:580px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Babel Config Generator</span><span onclick="document.getElementById('babel-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#babel-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy .babelrc',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy .babelrc</button>
    </div>`;
    d.querySelectorAll('[data-bpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.bpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskCompletionRate(){
  let ex=document.getElementById('completion-rate-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const total=tasks.length;
  const done=tasks.filter(t=>t.status==='done').length;
  const inProg=tasks.filter(t=>t.status==='in-progress').length;
  const todo=tasks.filter(t=>t.status==='todo').length;
  const blocked=tasks.filter(t=>t.status==='blocked').length;
  const rate=total?Math.round((done/total)*100):0;
  const r=60;const circ=2*Math.PI*r;
  const segments=[
    {pct:done/Math.max(total,1),color:'#4ade80',label:'Done'},
    {pct:inProg/Math.max(total,1),color:'#22d3ee',label:'In Progress'},
    {pct:todo/Math.max(total,1),color:'#6b7280',label:'To Do'},
    {pct:blocked/Math.max(total,1),color:'#f87171',label:'Blocked'}
  ];
  let offset=0;
  const arcs=segments.map(s=>{
    const dash=s.pct*circ;const gap=circ-dash;
    const arc=`<circle cx="75" cy="75" r="${r}" fill="none" stroke="${s.color}" stroke-width="14" stroke-dasharray="${dash} ${gap}" stroke-dashoffset="${-offset}" opacity="0.85"/>`;
    offset+=dash;return arc;
  }).join('');
  const legend=segments.map(s=>`<div style="display:flex;align-items:center;gap:6px"><div style="width:10px;height:10px;border-radius:2px;background:${s.color}"></div><span style="font-size:11px;color:var(--text-secondary)">${s.label}: ${Math.round(s.pct*total)}</span></div>`).join('');
  const d=document.createElement('div');d.id='completion-rate-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:320px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Completion Rate</span><span onclick="document.getElementById('completion-rate-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="text-align:center"><svg width="150" height="150" viewBox="0 0 150 150">${arcs}<text x="75" y="72" text-anchor="middle" fill="var(--text-primary)" font-size="28" font-weight="700">${rate}%</text><text x="75" y="90" text-anchor="middle" fill="var(--text-muted)" font-size="10">${done}/${total}</text></svg></div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px">${legend}</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickBreathingBox(){
  let ex=document.getElementById('box-breath-float');if(ex){ex.remove();return;}
  const phases=['Inhale','Hold','Exhale','Hold'];
  const dur=4;
  let phase=0,sec=dur,running=false,timer=null;
  const d=document.createElement('div');d.id='box-breath-float';
  const rend=()=>{
    const sz=100;const progress=running?(dur-sec)/dur:0;
    const pts=[[10,10],[sz-10,10],[sz-10,sz-10],[10,sz-10]];
    const px=phase===0?10+(sz-20)*progress:phase===1?sz-10:phase===2?sz-10-(sz-20)*progress:10;
    const py=phase===0?10:phase===1?10+(sz-20)*progress:phase===2?sz-10:sz-10-(sz-20)*progress;
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:180px;text-align:center">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Box Breathing</span><span onclick="if(window._boxTimer)clearInterval(window._boxTimer);document.getElementById('box-breath-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <svg width="${sz}" height="${sz}" viewBox="0 0 ${sz} ${sz}">
        <rect x="10" y="10" width="${sz-20}" height="${sz-20}" rx="6" fill="none" stroke="var(--border)" stroke-width="2"/>
        <circle cx="${px}" cy="${py}" r="6" fill="#4ade80"/>
      </svg>
      <div style="font-size:18px;font-weight:700;color:var(--accent);margin:8px 0">${phases[phase]}</div>
      <div style="font-size:24px;color:var(--text-primary);font-weight:300">${sec}s</div>
      <div style="margin-top:8px">
        <button onclick="window._toggleBoxBreath()" style="background:${running?'#f87171':'var(--accent)'};color:${running?'#fff':'#000'};border:none;padding:6px 20px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">${running?'Pause':'Start'}</button>
      </div>
    </div>`;
  };
  window._toggleBoxBreath=()=>{
    running=!running;
    if(running){
      window._boxTimer=setInterval(()=>{
        sec--;
        if(sec<=0){phase=(phase+1)%4;sec=dur;}
        rend();
      },1000);
    } else {
      clearInterval(window._boxTimer);
    }
    rend();
  };
  document.body.appendChild(d);rend();
}
function showEditorConfigGen(){
  let ex=document.getElementById('editorconfig-gen-float');if(ex){ex.remove();return;}
  const presets={
    'Standard':`root = true\n\n[*]\nindent_style = space\nindent_size = 2\nend_of_line = lf\ncharset = utf-8\ntrim_trailing_whitespace = true\ninsert_final_newline = true\n\n[*.md]\ntrim_trailing_whitespace = false\n\n[Makefile]\nindent_style = tab`,
    'Tabs (4)':`root = true\n\n[*]\nindent_style = tab\nindent_size = 4\nend_of_line = lf\ncharset = utf-8\ntrim_trailing_whitespace = true\ninsert_final_newline = true\n\n[*.md]\ntrim_trailing_whitespace = false`,
    'Python':`root = true\n\n[*]\nindent_style = space\nindent_size = 4\nend_of_line = lf\ncharset = utf-8\ntrim_trailing_whitespace = true\ninsert_final_newline = true\n\n[*.py]\nindent_size = 4\nmax_line_length = 88\n\n[Makefile]\nindent_style = tab`,
    'Go':`root = true\n\n[*]\nindent_style = tab\nend_of_line = lf\ncharset = utf-8\ntrim_trailing_whitespace = true\ninsert_final_newline = true\n\n[*.go]\nindent_style = tab\n\n[*.{yml,yaml}]\nindent_style = space\nindent_size = 2`
  };
  let sel='Standard';
  const d=document.createElement('div');d.id='editorconfig-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-ecpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-ecpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">.editorconfig Generator</span><span onclick="document.getElementById('editorconfig-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#editorconfig-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy .editorconfig',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy .editorconfig</button>
    </div>`;
    d.querySelectorAll('[data-ecpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.ecpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskDueDateCalendar(){
  let ex=document.getElementById('duedate-cal-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.due&&t.status!=='done');
  const now=new Date();
  const yr=now.getFullYear();const mo=now.getMonth();
  const first=new Date(yr,mo,1);const last=new Date(yr,mo+1,0);
  const startDay=first.getDay()||7;
  const dayNames=['Mo','Tu','We','Th','Fr','Sa','Su'];
  const monthNames=['January','February','March','April','May','June','July','August','September','October','November','December'];
  let cells='';
  for(let i=1;i<startDay;i++) cells+=`<div style="padding:4px;font-size:10px"></div>`;
  for(let d=1;d<=last.getDate();d++){
    const ds=`${yr}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayTasks=tasks.filter(t=>t.due&&t.due.startsWith(ds));
    const isToday=d===now.getDate()&&mo===now.getMonth();
    const dots=dayTasks.slice(0,3).map(t=>{
      const col=t.priority==='p0'?'#f87171':t.priority==='p1'?'#fb923c':t.priority==='p2'?'#22d3ee':'#6b7280';
      return `<div style="width:4px;height:4px;border-radius:50%;background:${col}" title="${esc(t.title)}"></div>`;
    }).join('');
    cells+=`<div style="padding:4px;font-size:10px;text-align:center;${isToday?'background:var(--accent);color:#000;border-radius:4px;font-weight:700':'color:var(--text-secondary)'}"><div>${d}</div>${dayTasks.length?`<div style="display:flex;gap:2px;justify-content:center;margin-top:2px">${dots}</div>`:''}</div>`;
  }
  const d=document.createElement('div');d.id='duedate-cal-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:360px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Due Date Calendar</span><span onclick="document.getElementById('duedate-cal-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="text-align:center;margin-bottom:8px;font-size:13px;color:var(--text-secondary);font-weight:600">${monthNames[mo]} ${yr}</div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px">${dayNames.map(n=>`<div style="text-align:center;font-size:9px;color:var(--text-muted);font-weight:600;padding:4px">${n}</div>`).join('')}${cells}</div>
    <div style="margin-top:10px;font-size:10px;color:var(--text-muted)">${tasks.length} open tasks with due dates this month</div>
    <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
      <span style="font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:#f87171"></span>P0</span>
      <span style="font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:#fb923c"></span>P1</span>
      <span style="font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:#22d3ee"></span>P2</span>
      <span style="font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:#6b7280"></span>P3</span>
    </div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickFocusTimer(){
  let ex=document.getElementById('focus-timer-float');if(ex){ex.remove();return;}
  let mins=25,secs=0,running=false,mode='work';
  const workMins=25,breakMins=5;
  const d=document.createElement('div');d.id='focus-timer-float';
  const rend=()=>{
    const totalSec=mode==='work'?workMins*60:breakMins*60;
    const elapsed=totalSec-(mins*60+secs);
    const pct=Math.round((elapsed/totalSec)*100);
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:200px;text-align:center">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Focus Timer</span><span onclick="if(window._focusTimerInt)clearInterval(window._focusTimerInt);document.getElementById('focus-timer-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="font-size:10px;color:${mode==='work'?'#4ade80':'#22d3ee'};font-weight:600;margin-bottom:6px;text-transform:uppercase">${mode==='work'?'Work Session':'Break Time'}</div>
      <div style="font-size:36px;font-weight:200;color:var(--text-primary);letter-spacing:2px">${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}</div>
      <div style="background:var(--bg-surface);border-radius:6px;height:6px;overflow:hidden;margin:10px 0"><div style="height:100%;width:${pct}%;background:${mode==='work'?'#4ade80':'#22d3ee'};border-radius:6px;transition:width 1s linear"></div></div>
      <div style="display:flex;gap:6px;justify-content:center">
        <button onclick="window._toggleFocusTimer()" style="background:${running?'#f87171':'var(--accent)'};color:${running?'#fff':'#000'};border:none;padding:5px 14px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">${running?'Pause':'Start'}</button>
        <button onclick="window._resetFocusTimer()" style="background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);padding:5px 14px;border-radius:6px;cursor:pointer;font-size:11px">Reset</button>
      </div>
    </div>`;
  };
  window._toggleFocusTimer=()=>{
    running=!running;
    if(running){
      window._focusTimerInt=setInterval(()=>{
        if(secs===0){if(mins===0){clearInterval(window._focusTimerInt);running=false;mode=mode==='work'?'break':'work';mins=mode==='work'?workMins:breakMins;secs=0;rend();return;}mins--;secs=59;}else{secs--;}
        rend();
      },1000);
    } else {clearInterval(window._focusTimerInt);}
    rend();
  };
  window._resetFocusTimer=()=>{clearInterval(window._focusTimerInt);running=false;mins=mode==='work'?workMins:breakMins;secs=0;rend();};
  document.body.appendChild(d);rend();
}
function showJestConfigGen(){
  let ex=document.getElementById('jest-gen-float');if(ex){ex.remove();return;}
  const presets={
    'JavaScript':`module.exports = {\n  testEnvironment: 'node',\n  roots: ['<rootDir>/src'],\n  testMatch: ['**/__tests__/**/*.js', '**/?(*.)+(spec|test).js'],\n  collectCoverageFrom: ['src/**/*.js', '!src/**/*.test.js'],\n  coverageDirectory: 'coverage',\n  coverageThreshold: {\n    global: {\n      branches: 80,\n      functions: 80,\n      lines: 80,\n      statements: 80\n    }\n  }\n};`,
    'TypeScript':`module.exports = {\n  preset: 'ts-jest',\n  testEnvironment: 'node',\n  roots: ['<rootDir>/src'],\n  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],\n  moduleNameMapper: {\n    '^@/(.*)$': '<rootDir>/src/$1'\n  },\n  collectCoverageFrom: ['src/**/*.ts', '!src/**/*.d.ts'],\n  coverageDirectory: 'coverage'\n};`,
    'React':`module.exports = {\n  testEnvironment: 'jsdom',\n  setupFilesAfterSetup: ['@testing-library/jest-dom'],\n  roots: ['<rootDir>/src'],\n  testMatch: ['**/__tests__/**/*.{js,jsx}', '**/?(*.)+(spec|test).{js,jsx}'],\n  moduleNameMapper: {\n    '\\\\.(css|less|scss)$': 'identity-obj-proxy',\n    '\\\\.(jpg|jpeg|png|svg)$': '<rootDir>/__mocks__/fileMock.js'\n  },\n  transform: {\n    '^.+\\\\.jsx?$': 'babel-jest'\n  },\n  collectCoverageFrom: ['src/**/*.{js,jsx}']\n};`,
    'Next.js':`const nextJest = require('next/jest');\n\nconst createJestConfig = nextJest({ dir: './' });\n\nconst config = {\n  testEnvironment: 'jsdom',\n  setupFilesAfterSetup: ['<rootDir>/jest.setup.js'],\n  moduleNameMapper: {\n    '^@/(.*)$': '<rootDir>/src/$1'\n  },\n  testPathIgnorePatterns: ['<rootDir>/node_modules/', '<rootDir>/.next/']\n};\n\nmodule.exports = createJestConfig(config);`
  };
  let sel='JavaScript';
  const d=document.createElement('div');d.id='jest-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-jpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-jpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Jest Config Generator</span><span onclick="document.getElementById('jest-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#jest-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy jest.config.js',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy jest.config.js</button>
    </div>`;
    d.querySelectorAll('[data-jpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.jpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskWorkloadBalance(){
  let ex=document.getElementById('workload-balance-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const projects=S.projects||[];
  const projMap={};
  projects.forEach(p=>{projMap[p.id]={name:p.name,count:0,p0:0,p1:0,p2:0,p3:0};});
  projMap['_none']={name:'No Project',count:0,p0:0,p1:0,p2:0,p3:0};
  tasks.forEach(t=>{
    const pid=t.projectId||'_none';
    if(!projMap[pid]) projMap[pid]={name:pid,count:0,p0:0,p1:0,p2:0,p3:0};
    projMap[pid].count++;
    const pr=t.priority||'p3';
    if(projMap[pid][pr]!==undefined) projMap[pid][pr]++;
  });
  const entries=Object.values(projMap).filter(e=>e.count>0).sort((a,b)=>b.count-a.count);
  const mx=entries.length?entries[0].count:1;
  const rows=entries.map(e=>{
    const w=Math.round((e.count/mx)*100);
    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <div style="width:100px;font-size:11px;color:var(--text-secondary);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(e.name)}">${esc(e.name)}</div>
      <div style="flex:1;display:flex;height:18px;border-radius:3px;overflow:hidden">
        ${e.p0?`<div style="width:${(e.p0/e.count)*w}%;background:#f87171;height:100%" title="P0: ${e.p0}"></div>`:''}
        ${e.p1?`<div style="width:${(e.p1/e.count)*w}%;background:#fb923c;height:100%" title="P1: ${e.p1}"></div>`:''}
        ${e.p2?`<div style="width:${(e.p2/e.count)*w}%;background:#22d3ee;height:100%" title="P2: ${e.p2}"></div>`:''}
        ${e.p3?`<div style="width:${(e.p3/e.count)*w}%;background:#6b7280;height:100%" title="P3: ${e.p3}"></div>`:''}
      </div>
      <div style="width:30px;font-size:11px;color:var(--text-muted);font-weight:600">${e.count}</div>
    </div>`;
  }).join('');
  const d=document.createElement('div');d.id='workload-balance-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:70vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Workload Balance</span><span onclick="document.getElementById('workload-balance-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    ${rows||'<div style="color:var(--text-muted);font-size:12px">No open tasks</div>'}
    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
      <span style="font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;border-radius:2px;background:#f87171"></span>P0</span>
      <span style="font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;border-radius:2px;background:#fb923c"></span>P1</span>
      <span style="font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;border-radius:2px;background:#22d3ee"></span>P2</span>
      <span style="font-size:9px;color:var(--text-muted);display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;border-radius:2px;background:#6b7280"></span>P3</span>
    </div>
    <div style="margin-top:8px;font-size:10px;color:var(--text-muted)">${tasks.length} open tasks across ${entries.length} projects</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickDailyQuote(){
  let ex=document.getElementById('daily-quote-float');if(ex){ex.remove();return;}
  const quotes=[
    {q:'The only way to do great work is to love what you do.',a:'Steve Jobs'},
    {q:'Done is better than perfect.',a:'Sheryl Sandberg'},
    {q:'First, solve the problem. Then, write the code.',a:'John Johnson'},
    {q:'Simplicity is the ultimate sophistication.',a:'Leonardo da Vinci'},
    {q:'Talk is cheap. Show me the code.',a:'Linus Torvalds'},
    {q:'The best error message is the one that never shows up.',a:'Thomas Fuchs'},
    {q:'Make it work, make it right, make it fast.',a:'Kent Beck'},
    {q:'Code is like humor. When you have to explain it, it is bad.',a:'Cory House'},
    {q:'The most powerful tool we have as developers is automation.',a:'Scott Hanselman'},
    {q:'Any fool can write code that a computer can understand. Good programmers write code that humans can understand.',a:'Martin Fowler'},
    {q:'Programs must be written for people to read, and only incidentally for machines to execute.',a:'Harold Abelson'},
    {q:'Perfection is achieved not when there is nothing more to add, but when there is nothing left to take away.',a:'Antoine de Saint-Exupery'},
    {q:'The impediment to action advances action. What stands in the way becomes the way.',a:'Marcus Aurelius'},
    {q:'We are what we repeatedly do. Excellence is not an act but a habit.',a:'Aristotle'},
    {q:'Stay hungry, stay foolish.',a:'Steve Jobs'}
  ];
  const dayOfYear=Math.floor((new Date()-new Date(new Date().getFullYear(),0,0))/(1000*60*60*24));
  const pick=quotes[dayOfYear%quotes.length];
  const d=document.createElement('div');d.id='daily-quote-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:32px 28px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw;text-align:center">
    <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px;letter-spacing:2px;text-transform:uppercase">Quote of the Day</div>
    <div style="font-size:18px;color:var(--text-primary);line-height:1.6;font-weight:300;margin-bottom:16px;font-style:italic">"${esc(pick.q)}"</div>
    <div style="font-size:13px;color:var(--accent);font-weight:600">- ${esc(pick.a)}</div>
    <div style="margin-top:20px;display:flex;gap:8px;justify-content:center">
      <button onclick="navigator.clipboard.writeText('"'+${JSON.stringify(pick.q)}+'" - '+${JSON.stringify(pick.a)});this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy</button>
      <button onclick="document.getElementById('daily-quote-float').remove()" style="background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px">Close</button>
    </div>
  </div>`;
  document.body.appendChild(d);
}
function showTailwindConfigGen(){
  let ex=document.getElementById('tailwind-gen-float');if(ex){ex.remove();return;}
  const presets={
    'Standard':`/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: ['./src/**/*.{js,jsx,ts,tsx}', './public/index.html'],\n  theme: {\n    extend: {\n      colors: {\n        primary: '#3b82f6',\n        secondary: '#10b981'\n      },\n      fontFamily: {\n        sans: ['Inter', 'sans-serif']\n      }\n    }\n  },\n  plugins: []\n};`,
    'Dark Mode':`/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: ['./src/**/*.{js,jsx,ts,tsx}'],\n  darkMode: 'class',\n  theme: {\n    extend: {\n      colors: {\n        dark: {\n          bg: '#0f172a',\n          surface: '#1e293b',\n          border: '#334155'\n        }\n      }\n    }\n  },\n  plugins: []\n};`,
    'With Plugins':`/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: ['./src/**/*.{js,jsx,ts,tsx}'],\n  theme: {\n    extend: {}\n  },\n  plugins: [\n    require('@tailwindcss/forms'),\n    require('@tailwindcss/typography'),\n    require('@tailwindcss/aspect-ratio'),\n    require('@tailwindcss/container-queries')\n  ]\n};`,
    'Next.js':`/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: [\n    './pages/**/*.{js,ts,jsx,tsx,mdx}',\n    './components/**/*.{js,ts,jsx,tsx,mdx}',\n    './app/**/*.{js,ts,jsx,tsx,mdx}'\n  ],\n  theme: {\n    extend: {\n      backgroundImage: {\n        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))'\n      }\n    }\n  },\n  plugins: []\n};`
  };
  let sel='Standard';
  const d=document.createElement('div');d.id='tailwind-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-twpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-twpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Tailwind Config Generator</span><span onclick="document.getElementById('tailwind-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#tailwind-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy tailwind.config.js',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy tailwind.config.js</button>
    </div>`;
    d.querySelectorAll('[data-twpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.twpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskBurndown(){
  let ex=document.getElementById('burndown-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const days=14;
  const now=new Date();
  const data=[];
  for(let i=days-1;i>=0;i--){
    const dt=new Date(now);dt.setDate(dt.getDate()-i);
    const ds=dt.toISOString().split('T')[0];
    const created=tasks.filter(t=>t.createdAt&&t.createdAt.startsWith(ds)).length;
    const done=tasks.filter(t=>t.status==='done'&&t.completedAt&&t.completedAt.startsWith(ds)).length;
    data.push({day:ds.slice(5),created,done});
  }
  let totalOpen=tasks.filter(t=>t.status!=='done').length;
  const burnData=[];
  for(let i=data.length-1;i>=0;i--){
    burnData.unshift({day:data[i].day,open:totalOpen});
    totalOpen=totalOpen+data[i].done-data[i].created;
  }
  const mx=Math.max(...burnData.map(d=>d.open),1);
  const w=320,h=140;
  const pts=burnData.map((d,i)=>{const x=Math.round((i/(burnData.length-1||1))*w);const y=Math.round(h-(d.open/mx)*h);return `${x},${y}`;}).join(' ');
  const area=`0,${h} ${pts} ${w},${h}`;
  const labels=burnData.filter((_,i)=>i%3===0||i===burnData.length-1).map((d,i,arr)=>{const x=Math.round((burnData.indexOf(d)/(burnData.length-1||1))*w);return `<text x="${x}" y="${h+14}" text-anchor="middle" fill="var(--text-muted)" font-size="8">${d.day}</text>`;}).join('');
  const d=document.createElement('div');d.id='burndown-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Burndown (14 days)</span><span onclick="document.getElementById('burndown-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <svg width="${w}" height="${h+20}" viewBox="0 0 ${w} ${h+20}">
      <polygon points="${area}" fill="rgba(74,222,128,0.15)"/>
      <polyline points="${pts}" fill="none" stroke="#4ade80" stroke-width="2"/>
      ${labels}
    </svg>
    <div style="margin-top:8px;font-size:10px;color:var(--text-muted)">Currently ${tasks.filter(t=>t.status!=='done').length} open tasks</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickHabitTracker(){
  let ex=document.getElementById('habit-tracker-float');if(ex){ex.remove();return;}
  if(!S._habits) S._habits=['Exercise','Read 30min','Meditate','Code 1hr','Journal'];
  if(!S._habitLog) S._habitLog={};
  const today=new Date().toISOString().split('T')[0];
  if(!S._habitLog[today]) S._habitLog[today]={};
  const d=document.createElement('div');d.id='habit-tracker-float';
  const rend=()=>{
    const days=[];
    for(let i=6;i>=0;i--){const dt=new Date();dt.setDate(dt.getDate()-i);days.push(dt.toISOString().split('T')[0]);}
    const grid=S._habits.map((h,hi)=>{
      const cells=days.map(dy=>{
        const checked=S._habitLog[dy]&&S._habitLog[dy][hi];
        const isToday=dy===today;
        return `<div onclick="${isToday?`window._toggleHabit(${hi})`:''}" style="width:22px;height:22px;border-radius:4px;${checked?'background:#4ade80':'background:var(--bg-surface);border:1px solid var(--border)'};${isToday?'cursor:pointer;box-shadow:0 0 0 1px var(--accent)':''};display:flex;align-items:center;justify-content:center;font-size:9px;color:#000">${checked?'v':''}</div>`;
      }).join('');
      return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><div style="width:80px;font-size:10px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(h)}">${esc(h)}</div>${cells}</div>`;
    }).join('');
    const dayHeaders=days.map(dy=>`<div style="width:22px;text-align:center;font-size:8px;color:var(--text-muted)">${['Su','Mo','Tu','We','Th','Fr','Sa'][new Date(dy).getDay()]}</div>`).join('');
    const streak=()=>{let s=0;for(let i=0;i<30;i++){const dt=new Date();dt.setDate(dt.getDate()-i);const ds=dt.toISOString().split('T')[0];if(S._habitLog[ds]&&Object.values(S._habitLog[ds]).some(v=>v))s++;else break;}return s;};
    d.innerHTML=`<div style="position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:310px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Habit Tracker</span><span onclick="document.getElementById('habit-tracker-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="display:flex;gap:6px;margin-left:86px;margin-bottom:4px">${dayHeaders}</div>
      ${grid}
      <div style="margin-top:8px;font-size:10px;color:var(--text-muted)">Streak: ${streak()} days</div>
    </div>`;
  };
  window._toggleHabit=(idx)=>{
    if(!S._habitLog[today]) S._habitLog[today]={};
    S._habitLog[today][idx]=!S._habitLog[today][idx];
    save();rend();
  };
  document.body.appendChild(d);rend();
}
function showPostcssConfigGen(){
  let ex=document.getElementById('postcss-gen-float');if(ex){ex.remove();return;}
  const presets={
    'Tailwind':`module.exports = {\n  plugins: {\n    'tailwindcss': {},\n    'autoprefixer': {}\n  }\n};`,
    'With Nesting':`module.exports = {\n  plugins: {\n    'postcss-import': {},\n    'tailwindcss/nesting': {},\n    'tailwindcss': {},\n    'autoprefixer': {},\n    'postcss-preset-env': {\n      features: { 'nesting-rules': false }\n    }\n  }\n};`,
    'Production':`module.exports = {\n  plugins: {\n    'postcss-import': {},\n    'tailwindcss': {},\n    'autoprefixer': {},\n    'cssnano': {\n      preset: ['default', {\n        discardComments: { removeAll: true }\n      }]\n    }\n  }\n};`,
    'Custom':`module.exports = {\n  plugins: {\n    'postcss-import': {},\n    'postcss-mixins': {},\n    'postcss-nested': {},\n    'postcss-custom-properties': {},\n    'autoprefixer': {},\n    'cssnano': process.env.NODE_ENV === 'production'\n      ? { preset: 'default' }\n      : false\n  }\n};`
  };
  let sel='Tailwind';
  const d=document.createElement('div');d.id='postcss-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-pcpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-pcpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">PostCSS Config Generator</span><span onclick="document.getElementById('postcss-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#postcss-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy postcss.config.js',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy postcss.config.js</button>
    </div>`;
    d.querySelectorAll('[data-pcpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.pcpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskStaleItems(){
  let ex=document.getElementById('stale-items-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=new Date();
  const stale=tasks.map(t=>{
    const created=new Date(t.createdAt||now);
    const days=Math.floor((now-created)/(1000*60*60*24));
    return {...t,age:days};
  }).filter(t=>t.age>7).sort((a,b)=>b.age-a.age).slice(0,20);
  const rows=stale.map(t=>{
    const col=t.age>30?'#f87171':t.age>14?'#fb923c':'#facc15';
    return `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">
      <div style="width:8px;height:8px;border-radius:50%;background:${col};flex-shrink:0"></div>
      <div style="flex:1;font-size:11px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title)}</div>
      <div style="font-size:10px;color:${col};font-weight:600;flex-shrink:0">${t.age}d</div>
      <div style="font-size:9px;color:var(--text-muted);flex-shrink:0">${t.status}</div>
    </div>`;
  }).join('');
  const d=document.createElement('div');d.id='stale-items-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:70vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Stale Tasks</span><span onclick="document.getElementById('stale-items-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    ${stale.length?rows:'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">No stale tasks (all less than 7 days old)</div>'}
    <div style="margin-top:8px;display:flex;gap:10px;font-size:9px;color:var(--text-muted)">
      <span style="display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:#facc15"></span>7-14 days</span>
      <span style="display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:#fb923c"></span>14-30 days</span>
      <span style="display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:#f87171"></span>30+ days</span>
    </div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickColorPicker(){
  let ex=document.getElementById('color-picker-float');if(ex){ex.remove();return;}
  let hex='#4ade80';
  const d=document.createElement('div');d.id='color-picker-float';
  const palettes={
    'ASTRA':['#4ade80','#22d3ee','#06b6d4','#050508','#0a0a0f','#111118','#1a1a24','#6b7280','#9ca3af','#ffffff'],
    'Warm':['#f87171','#fb923c','#facc15','#fbbf24','#f59e0b','#d97706','#b45309','#92400e','#78350f','#451a03'],
    'Cool':['#3b82f6','#2563eb','#1d4ed8','#6366f1','#4f46e5','#7c3aed','#8b5cf6','#a78bfa','#818cf8','#c4b5fd'],
    'Nature':['#22c55e','#16a34a','#15803d','#166534','#14532d','#84cc16','#65a30d','#4d7c0f','#365314','#1a2e05']
  };
  let activePal='ASTRA';
  const rend=()=>{
    const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
    const rgb=`rgb(${r}, ${g}, ${b})`;
    const hsl=`hsl(${Math.round(rgbToHsl(r,g,b)[0])}, ${Math.round(rgbToHsl(r,g,b)[1])}%, ${Math.round(rgbToHsl(r,g,b)[2])}%)`;
    const palTabs=Object.keys(palettes).map(k=>`<span onclick="window._setColorPal('${k}')" style="padding:2px 8px;border-radius:4px;cursor:pointer;font-size:10px;${k===activePal?'background:var(--accent);color:#000':'color:var(--text-muted)'}">${k}</span>`).join('');
    const swatches=palettes[activePal].map(c=>`<div onclick="window._pickColor('${c}')" style="width:28px;height:28px;border-radius:4px;background:${c};cursor:pointer;border:${c===hex?'2px solid #fff':'1px solid var(--border)'}" title="${c}"></div>`).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:260px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Color Picker</span><span onclick="document.getElementById('color-picker-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap">${palTabs}</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px">${swatches}</div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <div style="width:40px;height:40px;border-radius:6px;background:${hex};border:1px solid var(--border)"></div>
        <div style="flex:1">
          <input type="color" value="${hex}" onchange="window._pickColor(this.value)" style="width:100%;height:28px;border:none;background:none;cursor:pointer">
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-muted)">HEX</span><span onclick="navigator.clipboard.writeText('${hex}');this.textContent='Copied!';setTimeout(()=>this.textContent='${hex}',800)" style="font-size:11px;color:var(--text-primary);cursor:pointer;font-family:monospace">${hex}</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-muted)">RGB</span><span onclick="navigator.clipboard.writeText('${rgb}');this.textContent='Copied!';setTimeout(()=>this.textContent='${rgb}',800)" style="font-size:11px;color:var(--text-primary);cursor:pointer;font-family:monospace">${rgb}</span></div>
        <div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;color:var(--text-muted)">HSL</span><span onclick="navigator.clipboard.writeText('${hsl}');this.textContent='Copied!';setTimeout(()=>this.textContent='${hsl}',800)" style="font-size:11px;color:var(--text-primary);cursor:pointer;font-family:monospace">${hsl}</span></div>
      </div>
    </div>`;
  };
  function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const mx=Math.max(r,g,b),mn=Math.min(r,g,b);let h,s,l=(mx+mn)/2;if(mx===mn){h=s=0;}else{const d=mx-mn;s=l>0.5?d/(2-mx-mn):d/(mx+mn);switch(mx){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}h*=360;}return[h,s*100,l*100];}
  window._pickColor=(c)=>{hex=c;rend();};
  window._setColorPal=(p)=>{activePal=p;rend();};
  document.body.appendChild(d);rend();
}
function showViteConfigGen(){
  let ex=document.getElementById('vite-gen-float');if(ex){ex.remove();return;}
  const presets={
    'React':`import { defineConfig } from 'vite';\nimport react from '@vitejs/plugin-react';\n\nexport default defineConfig({\n  plugins: [react()],\n  server: {\n    port: 3000,\n    open: true\n  },\n  build: {\n    outDir: 'dist',\n    sourcemap: true\n  }\n});`,
    'Vue':`import { defineConfig } from 'vite';\nimport vue from '@vitejs/plugin-vue';\n\nexport default defineConfig({\n  plugins: [vue()],\n  server: {\n    port: 3000\n  },\n  resolve: {\n    alias: {\n      '@': '/src'\n    }\n  }\n});`,
    'Svelte':`import { defineConfig } from 'vite';\nimport { svelte } from '@sveltejs/vite-plugin-svelte';\n\nexport default defineConfig({\n  plugins: [svelte()],\n  server: {\n    port: 5173\n  }\n});`,
    'Library':`import { defineConfig } from 'vite';\nimport { resolve } from 'path';\n\nexport default defineConfig({\n  build: {\n    lib: {\n      entry: resolve(__dirname, 'src/index.ts'),\n      name: 'MyLib',\n      fileName: 'my-lib'\n    },\n    rollupOptions: {\n      external: ['react'],\n      output: {\n        globals: { react: 'React' }\n      }\n    }\n  }\n});`,
    'Vanilla':`import { defineConfig } from 'vite';\n\nexport default defineConfig({\n  root: 'src',\n  build: {\n    outDir: '../dist',\n    emptyOutDir: true\n  },\n  server: {\n    port: 3000,\n    open: true\n  }\n});`
  };
  let sel='React';
  const d=document.createElement('div');d.id='vite-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-vtpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-vtpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:580px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Vite Config Generator</span><span onclick="document.getElementById('vite-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#vite-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy vite.config.js',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy vite.config.js</button>
    </div>`;
    d.querySelectorAll('[data-vtpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.vtpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskPriorityMatrix(){
  let ex=document.getElementById('priority-matrix-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const urgent=t=>t.priority==='p0'||t.priority==='p1';
  const hasDue=t=>t.due&&new Date(t.due)<=new Date(Date.now()+7*86400000);
  const q1=tasks.filter(t=>urgent(t)&&hasDue(t));
  const q2=tasks.filter(t=>urgent(t)&&!hasDue(t));
  const q3=tasks.filter(t=>!urgent(t)&&hasDue(t));
  const q4=tasks.filter(t=>!urgent(t)&&!hasDue(t));
  const renderQ=(items,label,color)=>{
    const list=items.slice(0,5).map(t=>`<div style="font-size:10px;color:var(--text-secondary);padding:2px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(t.title)}">${esc(t.title)}</div>`).join('');
    return `<div style="background:var(--bg-surface);border-radius:6px;padding:10px;border-left:3px solid ${color}">
      <div style="font-size:10px;font-weight:600;color:${color};margin-bottom:4px">${label} (${items.length})</div>
      ${list||'<div style="font-size:10px;color:var(--text-muted);font-style:italic">None</div>'}
      ${items.length>5?`<div style="font-size:9px;color:var(--text-muted)">+${items.length-5} more</div>`:''}
    </div>`;
  };
  const d=document.createElement('div');d.id='priority-matrix-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:440px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Priority Matrix</span><span onclick="document.getElementById('priority-matrix-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      ${renderQ(q1,'Urgent + Soon','#f87171')}
      ${renderQ(q2,'Urgent + Later','#fb923c')}
      ${renderQ(q3,'Normal + Soon','#facc15')}
      ${renderQ(q4,'Normal + Later','#6b7280')}
    </div>
    <div style="margin-top:10px;font-size:10px;color:var(--text-muted)">${tasks.length} open tasks | "Soon" = due within 7 days</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickStopwatch(){
  let ex=document.getElementById('stopwatch-float');if(ex){ex.remove();return;}
  let elapsed=0,running=false,laps=[];
  const d=document.createElement('div');d.id='stopwatch-float';
  const fmt=(ms)=>{const s=Math.floor(ms/1000);const m=Math.floor(s/60);const h=Math.floor(m/60);return `${String(h).padStart(2,'0')}:${String(m%60).padStart(2,'0')}:${String(s%60).padStart(2,'0')}.${String(Math.floor((ms%1000)/100))}`};
  const rend=()=>{
    const lapList=laps.map((l,i)=>`<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);padding:2px 0"><span>Lap ${i+1}</span><span style="font-family:monospace">${fmt(l)}</span></div>`).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:200px;text-align:center">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Stopwatch</span><span onclick="if(window._swInt)clearInterval(window._swInt);document.getElementById('stopwatch-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="font-size:28px;font-weight:200;color:var(--text-primary);font-family:monospace;margin:8px 0">${fmt(elapsed)}</div>
      <div style="display:flex;gap:6px;justify-content:center;margin-bottom:8px">
        <button onclick="window._swToggle()" style="background:${running?'#f87171':'var(--accent)'};color:${running?'#fff':'#000'};border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">${running?'Stop':'Start'}</button>
        <button onclick="window._swLap()" style="background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px" ${running?'':'disabled'}>Lap</button>
        <button onclick="window._swReset()" style="background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px">Reset</button>
      </div>
      ${laps.length?`<div style="max-height:100px;overflow-y:auto;border-top:1px solid var(--border);padding-top:6px">${lapList}</div>`:''}
    </div>`;
  };
  window._swToggle=()=>{
    running=!running;
    if(running){const start=Date.now()-elapsed;window._swInt=setInterval(()=>{elapsed=Date.now()-start;rend();},100);}
    else{clearInterval(window._swInt);}
    rend();
  };
  window._swLap=()=>{if(running)laps.push(elapsed);rend();};
  window._swReset=()=>{clearInterval(window._swInt);running=false;elapsed=0;laps=[];rend();};
  document.body.appendChild(d);rend();
}
function showRollupConfigGen(){
  let ex=document.getElementById('rollup-gen-float');if(ex){ex.remove();return;}
  const presets={
    'ES Module':`import resolve from '@rollup/plugin-node-resolve';\nimport commonjs from '@rollup/plugin-commonjs';\n\nexport default {\n  input: 'src/index.js',\n  output: {\n    file: 'dist/bundle.mjs',\n    format: 'es',\n    sourcemap: true\n  },\n  plugins: [\n    resolve(),\n    commonjs()\n  ]\n};`,
    'UMD Library':`import resolve from '@rollup/plugin-node-resolve';\nimport commonjs from '@rollup/plugin-commonjs';\nimport terser from '@rollup/plugin-terser';\n\nexport default {\n  input: 'src/index.js',\n  output: [\n    { file: 'dist/index.cjs.js', format: 'cjs', sourcemap: true },\n    { file: 'dist/index.esm.js', format: 'es', sourcemap: true },\n    { file: 'dist/index.umd.js', format: 'umd', name: 'MyLib', sourcemap: true }\n  ],\n  plugins: [\n    resolve(),\n    commonjs(),\n    terser()\n  ]\n};`,
    'TypeScript':`import resolve from '@rollup/plugin-node-resolve';\nimport commonjs from '@rollup/plugin-commonjs';\nimport typescript from '@rollup/plugin-typescript';\n\nexport default {\n  input: 'src/index.ts',\n  output: [\n    { file: 'dist/index.cjs.js', format: 'cjs', sourcemap: true },\n    { file: 'dist/index.esm.js', format: 'es', sourcemap: true }\n  ],\n  plugins: [\n    resolve(),\n    commonjs(),\n    typescript({ tsconfig: './tsconfig.json' })\n  ],\n  external: ['react', 'react-dom']\n};`
  };
  let sel='ES Module';
  const d=document.createElement('div');d.id='rollup-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-rupre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-rupre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Rollup Config Generator</span><span onclick="document.getElementById('rollup-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#rollup-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy rollup.config.js',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy rollup.config.js</button>
    </div>`;
    d.querySelectorAll('[data-rupre]').forEach(b=>b.onclick=()=>{sel=b.dataset.rupre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskTimeEstimateAccuracy(){
  let ex=document.getElementById('estimate-accuracy-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.estimate&&t.timeTracked);
  const parseEst=(e)=>{if(!e)return 0;const m=e.match(/(\d+)\s*(h|m)/i);if(!m)return 0;return m[2]==='h'?parseInt(m[1])*60:parseInt(m[1]);};
  const data=tasks.map(t=>{
    const est=parseEst(t.estimate);
    const actual=Math.round((t.timeTracked||0)/60);
    const ratio=est>0?actual/est:0;
    return {title:t.title,est,actual,ratio};
  }).filter(d=>d.est>0).slice(0,15);
  const rows=data.map(d=>{
    const col=d.ratio>1.5?'#f87171':d.ratio>1?'#fb923c':d.ratio>0.7?'#4ade80':'#22d3ee';
    const label=d.ratio>1.5?'Over':'On Track';
    return `<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--border)">
      <div style="flex:1;font-size:10px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(d.title)}</div>
      <div style="font-size:10px;color:var(--text-muted);width:50px;text-align:right">${d.est}m est</div>
      <div style="font-size:10px;color:${col};width:50px;text-align:right;font-weight:600">${d.actual}m act</div>
      <div style="font-size:9px;color:${col};width:40px;text-align:right">${Math.round(d.ratio*100)}%</div>
    </div>`;
  }).join('');
  const avgRatio=data.length?data.reduce((a,d)=>a+d.ratio,0)/data.length:0;
  const d=document.createElement('div');d.id='estimate-accuracy-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:70vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Estimate Accuracy</span><span onclick="document.getElementById('estimate-accuracy-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    ${data.length?rows:'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">No tasks with both estimates and time tracking data</div>'}
    ${data.length?`<div style="margin-top:10px;font-size:11px;color:var(--text-muted)">Average accuracy: <span style="color:var(--accent);font-weight:600">${Math.round(avgRatio*100)}%</span> across ${data.length} tasks</div>`:''}
  </div>`;
  document.body.appendChild(d);
}
function showQuickCountdownTimer(){
  let ex=document.getElementById('countdown-float');if(ex){ex.remove();return;}
  let totalSec=300,remaining=300,running=false;
  const d=document.createElement('div');d.id='countdown-float';
  const fmt=(s)=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  const rend=()=>{
    const pct=totalSec>0?Math.round((remaining/totalSec)*100):0;
    d.innerHTML=`<div style="position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:200px;text-align:center">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Countdown</span><span onclick="if(window._cdInt)clearInterval(window._cdInt);document.getElementById('countdown-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="font-size:32px;font-weight:200;color:${remaining<=30?'#f87171':'var(--text-primary)'};font-family:monospace;margin:8px 0">${fmt(remaining)}</div>
      <div style="background:var(--bg-surface);border-radius:6px;height:6px;overflow:hidden;margin-bottom:10px"><div style="height:100%;width:${pct}%;background:${remaining<=30?'#f87171':'#4ade80'};border-radius:6px;transition:width 1s linear"></div></div>
      <div style="display:flex;gap:4px;justify-content:center;margin-bottom:8px">
        ${[1,5,10,15,25].map(m=>`<button onclick="window._cdSet(${m*60})" style="background:${totalSec===m*60?'var(--accent)':'var(--bg-surface)'};color:${totalSec===m*60?'#000':'var(--text-secondary)'};border:1px solid var(--border);padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px">${m}m</button>`).join('')}
      </div>
      <div style="display:flex;gap:6px;justify-content:center">
        <button onclick="window._cdToggle()" style="background:${running?'#f87171':'var(--accent)'};color:${running?'#fff':'#000'};border:none;padding:5px 14px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">${running?'Pause':'Start'}</button>
        <button onclick="window._cdReset()" style="background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);padding:5px 14px;border-radius:6px;cursor:pointer;font-size:11px">Reset</button>
      </div>
    </div>`;
  };
  window._cdSet=(s)=>{clearInterval(window._cdInt);running=false;totalSec=s;remaining=s;rend();};
  window._cdToggle=()=>{
    running=!running;
    if(running){window._cdInt=setInterval(()=>{remaining--;if(remaining<=0){clearInterval(window._cdInt);running=false;remaining=0;}rend();},1000);}
    else{clearInterval(window._cdInt);}
    rend();
  };
  window._cdReset=()=>{clearInterval(window._cdInt);running=false;remaining=totalSec;rend();};
  document.body.appendChild(d);rend();
}
function showSwcConfigGen(){
  let ex=document.getElementById('swc-gen-float');if(ex){ex.remove();return;}
  const presets={
    'React (JSX)':`{\n  "jsc": {\n    "parser": {\n      "syntax": "ecmascript",\n      "jsx": true,\n      "dynamicImport": true\n    },\n    "transform": {\n      "react": {\n        "runtime": "automatic"\n      }\n    },\n    "target": "es2022"\n  },\n  "module": {\n    "type": "es6"\n  },\n  "minify": true\n}`,
    'TypeScript':`{\n  "jsc": {\n    "parser": {\n      "syntax": "typescript",\n      "tsx": true,\n      "decorators": true\n    },\n    "transform": {\n      "legacyDecorator": true,\n      "decoratorMetadata": true\n    },\n    "target": "es2022"\n  },\n  "module": {\n    "type": "commonjs"\n  }\n}`,
    'Next.js':`{\n  "jsc": {\n    "parser": {\n      "syntax": "typescript",\n      "tsx": true\n    },\n    "transform": {\n      "react": {\n        "runtime": "automatic"\n      }\n    },\n    "paths": {\n      "@/*": ["./src/*"]\n    },\n    "target": "es2022"\n  }\n}`,
    'Node.js':`{\n  "jsc": {\n    "parser": {\n      "syntax": "ecmascript",\n      "dynamicImport": true\n    },\n    "target": "es2022"\n  },\n  "module": {\n    "type": "commonjs"\n  },\n  "minify": false\n}`
  };
  let sel='React (JSX)';
  const d=document.createElement('div');d.id='swc-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-swcpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-swcpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">SWC Config Generator</span><span onclick="document.getElementById('swc-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#swc-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy .swcrc',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy .swcrc</button>
    </div>`;
    d.querySelectorAll('[data-swcpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.swcpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskDependencyList(){
  let ex=document.getElementById('dep-list-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const blocked=tasks.filter(t=>t.blockedBy&&t.status!=='done');
  const blocking=tasks.filter(t=>{
    return blocked.some(b=>b.blockedBy===t.id||b.blockedBy===t.title);
  });
  const rows=blocked.map(t=>{
    const blocker=tasks.find(bt=>bt.id===t.blockedBy||bt.title===t.blockedBy);
    return `<div style="display:flex;align-items:flex-start;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
      <div style="flex:1">
        <div style="font-size:11px;color:var(--text-primary)">${esc(t.title)}</div>
        <div style="font-size:9px;color:var(--text-muted);margin-top:2px">Status: ${t.status} | Priority: ${t.priority||'p3'}</div>
      </div>
      <div style="font-size:10px;color:#f87171;text-align:right">
        <div>Blocked by:</div>
        <div style="color:var(--text-secondary);font-size:10px">${blocker?esc(blocker.title):esc(t.blockedBy||'Unknown')}</div>
      </div>
    </div>`;
  }).join('');
  const d=document.createElement('div');d.id='dep-list-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:70vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Dependencies</span><span onclick="document.getElementById('dep-list-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    ${blocked.length?rows:'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">No blocked tasks found</div>'}
    <div style="margin-top:8px;font-size:10px;color:var(--text-muted)">${blocked.length} blocked tasks | ${blocking.length} blocking tasks</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickDiceRoller(){
  let ex=document.getElementById('dice-roller-float');if(ex){ex.remove();return;}
  let results=[],lastDie=6;
  const d=document.createElement('div');d.id='dice-roller-float';
  const roll=(sides)=>{lastDie=sides;const val=Math.floor(Math.random()*sides)+1;results.unshift({sides,val,time:new Date().toLocaleTimeString()});if(results.length>10)results.length=10;rend();};
  const rend=()=>{
    const dice=[4,6,8,10,12,20,100];
    const btns=dice.map(s=>`<button onclick="window._rollDie(${s})" style="background:${s===lastDie?'var(--accent)':'var(--bg-surface)'};color:${s===lastDie?'#000':'var(--text-secondary)'};border:1px solid var(--border);padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600">d${s}</button>`).join('');
    const hist=results.map(r=>`<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);padding:2px 0"><span>d${r.sides}</span><span style="color:var(--accent);font-weight:600">${r.val}</span><span>${r.time}</span></div>`).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:220px;text-align:center">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Dice Roller</span><span onclick="document.getElementById('dice-roller-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      ${results.length?`<div style="font-size:42px;font-weight:200;color:var(--accent);margin:8px 0">${results[0].val}</div>`:'<div style="font-size:14px;color:var(--text-muted);margin:16px 0">Pick a die</div>'}
      <div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:center;margin-bottom:10px">${btns}</div>
      ${results.length>1?`<div style="border-top:1px solid var(--border);padding-top:6px;max-height:80px;overflow-y:auto">${hist}</div>`:''}
    </div>`;
  };
  window._rollDie=roll;
  document.body.appendChild(d);rend();
}
function showSqlSchemaGen(){
  let ex=document.getElementById('sql-schema-float');if(ex){ex.remove();return;}
  const presets={
    'Users Table':`CREATE TABLE users (\n  id SERIAL PRIMARY KEY,\n  email VARCHAR(255) UNIQUE NOT NULL,\n  password_hash VARCHAR(255) NOT NULL,\n  username VARCHAR(100) UNIQUE,\n  full_name VARCHAR(200),\n  avatar_url TEXT,\n  role VARCHAR(20) DEFAULT 'user',\n  is_active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE INDEX idx_users_email ON users(email);\nCREATE INDEX idx_users_username ON users(username);`,
    'Posts + Comments':`CREATE TABLE posts (\n  id SERIAL PRIMARY KEY,\n  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n  title VARCHAR(300) NOT NULL,\n  slug VARCHAR(300) UNIQUE NOT NULL,\n  body TEXT,\n  status VARCHAR(20) DEFAULT 'draft',\n  published_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE TABLE comments (\n  id SERIAL PRIMARY KEY,\n  post_id INTEGER REFERENCES posts(id) ON DELETE CASCADE,\n  user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,\n  body TEXT NOT NULL,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE INDEX idx_posts_user ON posts(user_id);\nCREATE INDEX idx_comments_post ON comments(post_id);`,
    'E-commerce':`CREATE TABLE products (\n  id SERIAL PRIMARY KEY,\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  price DECIMAL(10,2) NOT NULL,\n  sku VARCHAR(100) UNIQUE,\n  stock INTEGER DEFAULT 0,\n  category_id INTEGER,\n  is_active BOOLEAN DEFAULT true,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE TABLE orders (\n  id SERIAL PRIMARY KEY,\n  user_id INTEGER REFERENCES users(id),\n  status VARCHAR(30) DEFAULT 'pending',\n  total DECIMAL(10,2) NOT NULL,\n  shipping_address TEXT,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE TABLE order_items (\n  id SERIAL PRIMARY KEY,\n  order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,\n  product_id INTEGER REFERENCES products(id),\n  quantity INTEGER NOT NULL,\n  price DECIMAL(10,2) NOT NULL\n);`,
    'Auth + Sessions':`CREATE TABLE sessions (\n  id VARCHAR(128) PRIMARY KEY,\n  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n  ip_address VARCHAR(45),\n  user_agent TEXT,\n  expires_at TIMESTAMP NOT NULL,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE TABLE password_resets (\n  id SERIAL PRIMARY KEY,\n  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n  token VARCHAR(255) UNIQUE NOT NULL,\n  used BOOLEAN DEFAULT false,\n  expires_at TIMESTAMP NOT NULL,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE INDEX idx_sessions_user ON sessions(user_id);\nCREATE INDEX idx_sessions_expires ON sessions(expires_at);`
  };
  let sel='Users Table';
  const d=document.createElement('div');d.id='sql-schema-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-sqlpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-sqlpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:620px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">SQL Schema Generator</span><span onclick="document.getElementById('sql-schema-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#sql-schema-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy SQL',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy SQL</button>
    </div>`;
    d.querySelectorAll('[data-sqlpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.sqlpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskProjectTimeline(){
  let ex=document.getElementById('proj-timeline-float');if(ex){ex.remove();return;}
  const projects=S.projects||[];
  const tasks=S.tasks||[];
  const now=new Date();
  const rows=projects.map(p=>{
    const pTasks=tasks.filter(t=>t.projectId===p.id);
    const done=pTasks.filter(t=>t.status==='done').length;
    const total=pTasks.length;
    const pct=total?Math.round((done/total)*100):0;
    const earliest=pTasks.reduce((min,t)=>t.createdAt&&t.createdAt<min?t.createdAt:min,now.toISOString());
    const latest=pTasks.reduce((max,t)=>{const d=t.completedAt||t.createdAt||'';return d>max?d:max;},'');
    const days=Math.max(1,Math.floor((new Date(latest||now)-new Date(earliest))/(86400000)));
    return `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">
      <div style="width:100px;font-size:11px;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(p.name)}">${esc(p.name)}</div>
      <div style="flex:1;background:var(--bg-surface);height:14px;border-radius:4px;overflow:hidden;position:relative">
        <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,#4ade80,#22d3ee);border-radius:4px"></div>
        <span style="position:absolute;right:4px;top:1px;font-size:9px;color:var(--text-primary)">${pct}%</span>
      </div>
      <div style="width:60px;text-align:right;font-size:10px;color:var(--text-muted)">${done}/${total}</div>
      <div style="width:40px;text-align:right;font-size:9px;color:var(--text-muted)">${days}d</div>
    </div>`;
  }).join('');
  const d=document.createElement('div');d.id='proj-timeline-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Project Timeline</span><span onclick="document.getElementById('proj-timeline-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    ${rows||'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">No projects</div>'}
  </div>`;
  document.body.appendChild(d);
}
function showQuickCoinFlip(){
  let ex=document.getElementById('coin-flip-float');if(ex){ex.remove();return;}
  let history=[],flipping=false;
  const d=document.createElement('div');d.id='coin-flip-float';
  const rend=()=>{
    const heads=history.filter(h=>h==='H').length;
    const tails=history.filter(h=>h==='T').length;
    const hist=history.slice(0,20).map(h=>`<span style="display:inline-block;width:18px;height:18px;border-radius:50%;line-height:18px;text-align:center;font-size:9px;font-weight:600;${h==='H'?'background:#4ade80;color:#000':'background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border)'}">${h}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:200px;text-align:center">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Coin Flip</span><span onclick="document.getElementById('coin-flip-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="font-size:48px;margin:12px 0;${flipping?'animation:spin 0.3s linear infinite':''}">${history.length?history[0]==='H'?'H':'T':'?'}</div>
      <button onclick="window._flipCoin()" style="background:var(--accent);color:#000;border:none;padding:8px 24px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-bottom:10px">Flip</button>
      ${history.length?`<div style="display:flex;gap:3px;flex-wrap:wrap;justify-content:center;margin-bottom:6px">${hist}</div><div style="font-size:10px;color:var(--text-muted)">H: ${heads} | T: ${tails} | Total: ${history.length}</div>`:''}</div>`;
  };
  window._flipCoin=()=>{
    if(flipping)return;flipping=true;rend();
    let count=0;const anim=setInterval(()=>{count++;if(count>8){clearInterval(anim);flipping=false;const result=Math.random()<0.5?'H':'T';history.unshift(result);rend();}},80);
  };
  document.body.appendChild(d);rend();
}
function showPrismaSchemaGen(){
  let ex=document.getElementById('prisma-gen-float');if(ex){ex.remove();return;}
  const presets={
    'User + Auth':`generator client {\n  provider = "prisma-client-js"\n}\n\ndatasource db {\n  provider = "postgresql"\n  url      = env("DATABASE_URL")\n}\n\nmodel User {\n  id        Int      @id @default(autoincrement())\n  email     String   @unique\n  name      String?\n  password  String\n  role      Role     @default(USER)\n  posts     Post[]\n  sessions  Session[]\n  createdAt DateTime @default(now())\n  updatedAt DateTime @updatedAt\n}\n\nmodel Session {\n  id        String   @id @default(cuid())\n  userId    Int\n  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)\n  expiresAt DateTime\n  createdAt DateTime @default(now())\n}\n\nenum Role {\n  USER\n  ADMIN\n}`,
    'Blog':`model Post {\n  id          Int       @id @default(autoincrement())\n  title       String\n  slug        String    @unique\n  content     String?\n  published   Boolean   @default(false)\n  author      User      @relation(fields: [authorId], references: [id])\n  authorId    Int\n  categories  Category[]\n  comments    Comment[]\n  publishedAt DateTime?\n  createdAt   DateTime  @default(now())\n  updatedAt   DateTime  @updatedAt\n}\n\nmodel Comment {\n  id        Int      @id @default(autoincrement())\n  body      String\n  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)\n  postId    Int\n  author    User     @relation(fields: [authorId], references: [id])\n  authorId  Int\n  createdAt DateTime @default(now())\n}\n\nmodel Category {\n  id    Int    @id @default(autoincrement())\n  name  String @unique\n  posts Post[]\n}`,
    'E-commerce':`model Product {\n  id          Int         @id @default(autoincrement())\n  name        String\n  description String?\n  price       Decimal     @db.Decimal(10, 2)\n  sku         String      @unique\n  stock       Int         @default(0)\n  images      String[]\n  category    Category?   @relation(fields: [categoryId], references: [id])\n  categoryId  Int?\n  orderItems  OrderItem[]\n  isActive    Boolean     @default(true)\n  createdAt   DateTime    @default(now())\n}\n\nmodel Order {\n  id         Int         @id @default(autoincrement())\n  user       User        @relation(fields: [userId], references: [id])\n  userId     Int\n  status     OrderStatus @default(PENDING)\n  total      Decimal     @db.Decimal(10, 2)\n  items      OrderItem[]\n  createdAt  DateTime    @default(now())\n}\n\nmodel OrderItem {\n  id        Int     @id @default(autoincrement())\n  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)\n  orderId   Int\n  product   Product @relation(fields: [productId], references: [id])\n  productId Int\n  quantity  Int\n  price     Decimal @db.Decimal(10, 2)\n}\n\nenum OrderStatus {\n  PENDING\n  PROCESSING\n  SHIPPED\n  DELIVERED\n  CANCELLED\n}`
  };
  let sel='User + Auth';
  const d=document.createElement('div');d.id='prisma-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-prpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-prpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:620px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Prisma Schema Generator</span><span onclick="document.getElementById('prisma-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#prisma-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy schema.prisma',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy schema.prisma</button>
    </div>`;
    d.querySelectorAll('[data-prpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.prpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskWeeklyReview(){
  let ex=document.getElementById('weekly-review-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const now=new Date();
  const weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
  const created=tasks.filter(t=>t.createdAt&&new Date(t.createdAt)>=weekAgo);
  const completed=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=weekAgo);
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<now);
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  const docs=S.writerDocs||[];
  const docsCreated=docs.filter(d=>d.created&&new Date(d.created)>=weekAgo);
  const contentCreated=(S.content||[]).filter(c=>c.createdAt&&new Date(c.createdAt)>=weekAgo);
  const d=document.createElement('div');d.id='weekly-review-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:75vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="font-weight:600;color:var(--text-primary)">Weekly Review</span><span onclick="document.getElementById('weekly-review-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">${weekAgo.toLocaleDateString()} - ${now.toLocaleDateString()}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
      <div style="background:var(--bg-surface);border-radius:8px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:700;color:#4ade80">${completed.length}</div><div style="font-size:10px;color:var(--text-muted)">Completed</div></div>
      <div style="background:var(--bg-surface);border-radius:8px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:700;color:#22d3ee">${created.length}</div><div style="font-size:10px;color:var(--text-muted)">Created</div></div>
      <div style="background:var(--bg-surface);border-radius:8px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:700;color:#f87171">${overdue.length}</div><div style="font-size:10px;color:var(--text-muted)">Overdue</div></div>
      <div style="background:var(--bg-surface);border-radius:8px;padding:12px;text-align:center"><div style="font-size:24px;font-weight:700;color:#fb923c">${inProgress.length}</div><div style="font-size:10px;color:var(--text-muted)">In Progress</div></div>
    </div>
    <div style="border-top:1px solid var(--border);padding-top:12px">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">Also this week:</div>
      <div style="font-size:11px;color:var(--text-secondary)">Docs created: ${docsCreated.length} | Content added: ${contentCreated.length}</div>
      <div style="font-size:11px;color:var(--text-secondary);margin-top:4px">Net: ${completed.length-created.length>=0?'+':''}${completed.length-created.length} tasks (${completed.length>=created.length?'reducing':'growing'} backlog)</div>
    </div>
    <button onclick="const t=document.getElementById('weekly-review-float').innerText;navigator.clipboard.writeText(t);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Summary',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-top:12px">Copy Summary</button>
  </div>`;
  document.body.appendChild(d);
}
function showQuickRandomNumber(){
  let ex=document.getElementById('random-num-float');if(ex){ex.remove();return;}
  let min=1,max=100,result=null,history=[];
  const d=document.createElement('div');d.id='random-num-float';
  const rend=()=>{
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:200px;text-align:center">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Random Number</span><span onclick="document.getElementById('random-num-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="display:flex;gap:6px;align-items:center;margin-bottom:10px">
        <input type="number" value="${min}" onchange="window._rnMin=parseInt(this.value)" style="width:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;padding:4px;color:var(--text-primary);font-size:11px;text-align:center">
        <span style="color:var(--text-muted);font-size:11px">to</span>
        <input type="number" value="${max}" onchange="window._rnMax=parseInt(this.value)" style="width:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;padding:4px;color:var(--text-primary);font-size:11px;text-align:center">
      </div>
      ${result!==null?`<div style="font-size:42px;font-weight:200;color:var(--accent);margin:8px 0">${result}</div>`:'<div style="font-size:14px;color:var(--text-muted);margin:16px 0">Set range and generate</div>'}
      <button onclick="window._genRandom()" style="background:var(--accent);color:#000;border:none;padding:6px 20px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-bottom:8px">Generate</button>
      ${history.length>1?`<div style="font-size:9px;color:var(--text-muted);border-top:1px solid var(--border);padding-top:6px">History: ${history.slice(0,10).join(', ')}</div>`:''}
    </div>`;
  };
  window._rnMin=min;window._rnMax=max;
  window._genRandom=()=>{
    min=window._rnMin||1;max=window._rnMax||100;
    result=Math.floor(Math.random()*(max-min+1))+min;
    history.unshift(result);if(history.length>20)history.length=20;
    rend();
  };
  document.body.appendChild(d);rend();
}
function showMongoSchemaGen(){
  let ex=document.getElementById('mongo-gen-float');if(ex){ex.remove();return;}
  const presets={
    'User Model':`const mongoose = require('mongoose');\nconst bcrypt = require('bcryptjs');\n\nconst userSchema = new mongoose.Schema({\n  email: { type: String, required: true, unique: true, lowercase: true, trim: true },\n  password: { type: String, required: true, minlength: 8 },\n  name: { type: String, required: true, trim: true },\n  role: { type: String, enum: ['user', 'admin'], default: 'user' },\n  avatar: String,\n  isActive: { type: Boolean, default: true },\n  lastLogin: Date\n}, { timestamps: true });\n\nuserSchema.pre('save', async function(next) {\n  if (!this.isModified('password')) return next();\n  this.password = await bcrypt.hash(this.password, 12);\n  next();\n});\n\nuserSchema.methods.comparePassword = async function(candidate) {\n  return bcrypt.compare(candidate, this.password);\n};\n\nmodule.exports = mongoose.model('User', userSchema);`,
    'Blog Post':`const mongoose = require('mongoose');\n\nconst postSchema = new mongoose.Schema({\n  title: { type: String, required: true, trim: true },\n  slug: { type: String, required: true, unique: true },\n  content: { type: String, required: true },\n  excerpt: { type: String, maxlength: 300 },\n  author: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },\n  tags: [{ type: String, lowercase: true }],\n  category: { type: String, required: true },\n  status: { type: String, enum: ['draft', 'published', 'archived'], default: 'draft' },\n  featuredImage: String,\n  views: { type: Number, default: 0 },\n  publishedAt: Date\n}, { timestamps: true });\n\npostSchema.index({ title: 'text', content: 'text' });\npostSchema.index({ slug: 1 });\npostSchema.index({ tags: 1 });\n\nmodule.exports = mongoose.model('Post', postSchema);`,
    'Product':`const mongoose = require('mongoose');\n\nconst productSchema = new mongoose.Schema({\n  name: { type: String, required: true, trim: true },\n  description: String,\n  price: { type: Number, required: true, min: 0 },\n  comparePrice: { type: Number, min: 0 },\n  sku: { type: String, unique: true },\n  category: { type: mongoose.Schema.Types.ObjectId, ref: 'Category' },\n  images: [String],\n  stock: { type: Number, default: 0, min: 0 },\n  variants: [{\n    name: String,\n    options: [String],\n    priceModifier: { type: Number, default: 0 }\n  }],\n  isActive: { type: Boolean, default: true },\n  ratings: { average: { type: Number, default: 0 }, count: { type: Number, default: 0 } }\n}, { timestamps: true });\n\nproductSchema.index({ name: 'text', description: 'text' });\n\nmodule.exports = mongoose.model('Product', productSchema);`
  };
  let sel='User Model';
  const d=document.createElement('div');d.id='mongo-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-mgpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-mgpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:620px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Mongoose Schema Generator</span><span onclick="document.getElementById('mongo-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#mongo-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Schema',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy Schema</button>
    </div>`;
    d.querySelectorAll('[data-mgpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.mgpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskStatusPie(){
  let ex=document.getElementById('status-pie-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const statuses={todo:0,'in-progress':0,done:0,blocked:0};
  tasks.forEach(t=>{const s=t.status||'todo';if(statuses[s]!==undefined)statuses[s]++;});
  const total=tasks.length||1;
  const colors={todo:'#6b7280','in-progress':'#22d3ee',done:'#4ade80',blocked:'#f87171'};
  const labels={todo:'To Do','in-progress':'In Progress',done:'Done',blocked:'Blocked'};
  const r=65;const cx=80;const cy=80;
  let angle=0;
  const slices=Object.entries(statuses).filter(([,v])=>v>0).map(([k,v])=>{
    const pct=v/total;const a=pct*Math.PI*2;
    const x1=cx+r*Math.cos(angle);const y1=cy+r*Math.sin(angle);
    const x2=cx+r*Math.cos(angle+a);const y2=cy+r*Math.sin(angle+a);
    const large=a>Math.PI?1:0;
    const path=`<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z" fill="${colors[k]}" opacity="0.85"/>`;
    angle+=a;return path;
  }).join('');
  const legend=Object.entries(statuses).map(([k,v])=>`<div style="display:flex;align-items:center;gap:6px"><div style="width:10px;height:10px;border-radius:2px;background:${colors[k]}"></div><span style="font-size:11px;color:var(--text-secondary)">${labels[k]}: ${v} (${Math.round((v/total)*100)}%)</span></div>`).join('');
  const d=document.createElement('div');d.id='status-pie-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:320px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Status Pie</span><span onclick="document.getElementById('status-pie-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="text-align:center"><svg width="160" height="160" viewBox="0 0 160 160">${slices}<text x="${cx}" y="${cy+4}" text-anchor="middle" fill="var(--text-primary)" font-size="16" font-weight="700">${tasks.length}</text></svg></div>
    <div style="display:flex;flex-direction:column;gap:4px;margin-top:8px">${legend}</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickPasswordStrength(){
  let ex=document.getElementById('pwd-strength-float');if(ex){ex.remove();return;}
  const d=document.createElement('div');d.id='pwd-strength-float';
  const check=(pwd)=>{
    let score=0;const checks=[];
    if(pwd.length>=8){score+=1;checks.push({pass:true,label:'8+ characters'});}else checks.push({pass:false,label:'8+ characters'});
    if(pwd.length>=12){score+=1;checks.push({pass:true,label:'12+ characters'});}else checks.push({pass:false,label:'12+ characters'});
    if(/[a-z]/.test(pwd)){score+=1;checks.push({pass:true,label:'Lowercase letter'});}else checks.push({pass:false,label:'Lowercase letter'});
    if(/[A-Z]/.test(pwd)){score+=1;checks.push({pass:true,label:'Uppercase letter'});}else checks.push({pass:false,label:'Uppercase letter'});
    if(/[0-9]/.test(pwd)){score+=1;checks.push({pass:true,label:'Number'});}else checks.push({pass:false,label:'Number'});
    if(/[^a-zA-Z0-9]/.test(pwd)){score+=1;checks.push({pass:true,label:'Special character'});}else checks.push({pass:false,label:'Special character'});
    if(!/(.)\1{2,}/.test(pwd)){score+=1;checks.push({pass:true,label:'No repeated chars'});}else checks.push({pass:false,label:'No repeated chars'});
    const labels=['Very Weak','Weak','Fair','Good','Strong','Very Strong','Excellent'];
    const colors=['#dc2626','#f87171','#fb923c','#facc15','#4ade80','#22d3ee','#a78bfa'];
    const idx=Math.min(score,labels.length-1);
    return{score,max:7,label:labels[idx],color:colors[idx],checks};
  };
  const rend=(pwd='')=>{
    const r=pwd?check(pwd):{score:0,max:7,label:'Enter password',color:'var(--text-muted)',checks:[]};
    const pct=Math.round((r.score/r.max)*100);
    const checkList=r.checks.map(c=>`<div style="font-size:10px;color:${c.pass?'#4ade80':'var(--text-muted)'}"><span>${c.pass?'v':'x'}</span> ${c.label}</div>`).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:250px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Password Strength</span><span onclick="document.getElementById('pwd-strength-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <input type="text" placeholder="Type password to check..." value="${esc(pwd)}" oninput="window._checkPwd(this.value)" style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-size:12px;font-family:monospace;box-sizing:border-box;margin-bottom:8px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div style="flex:1;background:var(--bg-surface);border-radius:6px;height:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${r.color};border-radius:6px;transition:all 0.3s"></div></div>
        <span style="font-size:11px;color:${r.color};font-weight:600;white-space:nowrap">${r.label}</span>
      </div>
      ${checkList}
    </div>`;
  };
  window._checkPwd=(v)=>rend(v);
  document.body.appendChild(d);rend();
}
function showKubernetesYamlGen(){
  let ex=document.getElementById('k8s-gen-float');if(ex){ex.remove();return;}
  const presets={
    'Deployment':`apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: my-app\n  labels:\n    app: my-app\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: my-app\n  template:\n    metadata:\n      labels:\n        app: my-app\n    spec:\n      containers:\n      - name: my-app\n        image: my-app:latest\n        ports:\n        - containerPort: 8080\n        env:\n        - name: NODE_ENV\n          value: "production"\n        resources:\n          requests:\n            memory: "128Mi"\n            cpu: "250m"\n          limits:\n            memory: "256Mi"\n            cpu: "500m"\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\n          initialDelaySeconds: 15\n          periodSeconds: 10`,
    'Service':`apiVersion: v1\nkind: Service\nmetadata:\n  name: my-app-service\nspec:\n  type: ClusterIP\n  selector:\n    app: my-app\n  ports:\n  - port: 80\n    targetPort: 8080\n    protocol: TCP\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: my-app-lb\nspec:\n  type: LoadBalancer\n  selector:\n    app: my-app\n  ports:\n  - port: 80\n    targetPort: 8080`,
    'Ingress':`apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: my-app-ingress\n  annotations:\n    nginx.ingress.kubernetes.io/rewrite-target: /\n    cert-manager.io/cluster-issuer: letsencrypt-prod\nspec:\n  ingressClassName: nginx\n  tls:\n  - hosts:\n    - app.example.com\n    secretName: app-tls\n  rules:\n  - host: app.example.com\n    http:\n      paths:\n      - path: /\n        pathType: Prefix\n        backend:\n          service:\n            name: my-app-service\n            port:\n              number: 80`,
    'ConfigMap + Secret':`apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: my-app-config\ndata:\n  APP_ENV: production\n  LOG_LEVEL: info\n  DB_HOST: postgres-service\n  DB_PORT: "5432"\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: my-app-secrets\ntype: Opaque\nstringData:\n  DB_PASSWORD: change-me\n  JWT_SECRET: change-me\n  API_KEY: change-me`
  };
  let sel='Deployment';
  const d=document.createElement('div');d.id='k8s-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-k8pre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-k8pre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:620px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Kubernetes YAML Generator</span><span onclick="document.getElementById('k8s-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#k8s-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy YAML',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy YAML</button>
    </div>`;
    d.querySelectorAll('[data-k8pre]').forEach(b=>b.onclick=()=>{sel=b.dataset.k8pre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskCreationHeatmap(){
  let ex=document.getElementById('creation-heat-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const weeks=12;const now=new Date();
  const grid={};
  for(let i=weeks*7-1;i>=0;i--){
    const dt=new Date(now);dt.setDate(dt.getDate()-i);
    const ds=dt.toISOString().split('T')[0];
    grid[ds]=0;
  }
  tasks.forEach(t=>{if(t.createdAt){const ds=t.createdAt.split('T')[0];if(grid[ds]!==undefined)grid[ds]++;}});
  const days=Object.entries(grid);
  const mx=Math.max(...Object.values(grid),1);
  const cellSize=10;const gap=2;
  const cols=Math.ceil(days.length/7);
  const cells=days.map((d,i)=>{
    const col=Math.floor(i/7);const row=i%7;
    const intensity=d[1]/mx;
    const color=d[1]===0?'var(--bg-surface)':`rgba(74,222,128,${0.2+intensity*0.8})`;
    return `<rect x="${col*(cellSize+gap)}" y="${row*(cellSize+gap)}" width="${cellSize}" height="${cellSize}" rx="2" fill="${color}" title="${d[0]}: ${d[1]} tasks"><title>${d[0]}: ${d[1]}</title></rect>`;
  }).join('');
  const svgW=cols*(cellSize+gap);const svgH=7*(cellSize+gap);
  const dayLabels=['M','','W','','F','','S'];
  const yLabels=dayLabels.map((l,i)=>`<text x="-4" y="${i*(cellSize+gap)+9}" text-anchor="end" fill="var(--text-muted)" font-size="8">${l}</text>`).join('');
  const d=document.createElement('div');d.id='creation-heat-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Creation Heatmap</span><span onclick="document.getElementById('creation-heat-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="overflow-x:auto"><svg width="${svgW+20}" height="${svgH+4}" viewBox="-14 0 ${svgW+34} ${svgH+4}">${yLabels}${cells}</svg></div>
    <div style="display:flex;align-items:center;gap:4px;margin-top:8px;font-size:9px;color:var(--text-muted)"><span>Less</span>${[0,0.25,0.5,0.75,1].map(i=>`<div style="width:10px;height:10px;border-radius:2px;background:${i===0?'var(--bg-surface)':`rgba(74,222,128,${0.2+i*0.8})`}"></div>`).join('')}<span>More</span><span style="margin-left:auto">${weeks} weeks | ${tasks.length} total tasks</span></div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickWorldClock(){
  let ex=document.getElementById('world-clock-float');if(ex){ex.remove();return;}
  const zones=[
    {name:'Local',tz:Intl.DateTimeFormat().resolvedOptions().timeZone},
    {name:'New York',tz:'America/New_York'},
    {name:'London',tz:'Europe/London'},
    {name:'Tokyo',tz:'Asia/Tokyo'},
    {name:'Sydney',tz:'Australia/Sydney'},
    {name:'Dubai',tz:'Asia/Dubai'},
    {name:'LA',tz:'America/Los_Angeles'},
    {name:'Berlin',tz:'Europe/Berlin'}
  ];
  const d=document.createElement('div');d.id='world-clock-float';
  const rend=()=>{
    const now=new Date();
    const clocks=zones.map(z=>{
      const time=now.toLocaleTimeString('en-US',{timeZone:z.tz,hour:'2-digit',minute:'2-digit',hour12:true});
      const date=now.toLocaleDateString('en-US',{timeZone:z.tz,weekday:'short',month:'short',day:'numeric'});
      const hr=parseInt(now.toLocaleTimeString('en-US',{timeZone:z.tz,hour:'numeric',hour12:false}));
      const isNight=hr<6||hr>=20;
      return `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">
        <div><div style="font-size:11px;color:var(--text-primary);font-weight:600">${z.name}</div><div style="font-size:9px;color:var(--text-muted)">${date}</div></div>
        <div style="font-size:16px;font-weight:300;color:${isNight?'#6b7280':'var(--accent)'};font-family:monospace">${time}</div>
      </div>`;
    }).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:250px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">World Clock</span><span onclick="clearInterval(window._wcInt);document.getElementById('world-clock-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      ${clocks}
    </div>`;
  };
  document.body.appendChild(d);rend();
  window._wcInt=setInterval(rend,30000);
}
function showTerraformGen(){
  let ex=document.getElementById('terraform-gen-float');if(ex){ex.remove();return;}
  const presets={
    'AWS EC2':`provider "aws" {\n  region = "us-east-1"\n}\n\nresource "aws_instance" "app" {\n  ami           = "ami-0c55b159cbfafe1f0"\n  instance_type = "t3.micro"\n\n  tags = {\n    Name        = "my-app"\n    Environment = "production"\n  }\n\n  vpc_security_group_ids = [aws_security_group.app.id]\n}\n\nresource "aws_security_group" "app" {\n  name = "app-sg"\n\n  ingress {\n    from_port   = 80\n    to_port     = 80\n    protocol    = "tcp"\n    cidr_blocks = ["0.0.0.0/0"]\n  }\n\n  ingress {\n    from_port   = 443\n    to_port     = 443\n    protocol    = "tcp"\n    cidr_blocks = ["0.0.0.0/0"]\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = "-1"\n    cidr_blocks = ["0.0.0.0/0"]\n  }\n}`,
    'AWS S3':`resource "aws_s3_bucket" "assets" {\n  bucket = "my-app-assets"\n\n  tags = {\n    Name        = "Assets Bucket"\n    Environment = "production"\n  }\n}\n\nresource "aws_s3_bucket_versioning" "assets" {\n  bucket = aws_s3_bucket.assets.id\n  versioning_configuration {\n    status = "Enabled"\n  }\n}\n\nresource "aws_s3_bucket_public_access_block" "assets" {\n  bucket                  = aws_s3_bucket.assets.id\n  block_public_acls       = true\n  block_public_policy     = true\n  ignore_public_acls      = true\n  restrict_public_buckets = true\n}`,
    'Variables':`variable "environment" {\n  description = "Deployment environment"\n  type        = string\n  default     = "production"\n}\n\nvariable "instance_type" {\n  description = "EC2 instance type"\n  type        = string\n  default     = "t3.micro"\n}\n\nvariable "app_name" {\n  description = "Application name"\n  type        = string\n}\n\nlocals {\n  common_tags = {\n    Environment = var.environment\n    Application = var.app_name\n    ManagedBy   = "terraform"\n  }\n}\n\noutput "instance_ip" {\n  value = aws_instance.app.public_ip\n}`
  };
  let sel='AWS EC2';
  const d=document.createElement('div');d.id='terraform-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-tfpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-tfpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:620px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Terraform Generator</span><span onclick="document.getElementById('terraform-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#terraform-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy .tf',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy .tf</button>
    </div>`;
    d.querySelectorAll('[data-tfpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.tfpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskLeadTime(){
  let ex=document.getElementById('lead-time-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.status==='done'&&t.createdAt&&t.completedAt);
  const data=tasks.map(t=>{
    const created=new Date(t.createdAt);const completed=new Date(t.completedAt);
    const days=Math.max(0,Math.floor((completed-created)/(86400000)));
    return{title:t.title,days,project:t.projectId};
  }).sort((a,b)=>b.days-a.days).slice(0,20);
  const avg=data.length?Math.round(data.reduce((s,d)=>s+d.days,0)/data.length):0;
  const median=data.length?data[Math.floor(data.length/2)].days:0;
  const mx=data.length?data[0].days:1;
  const bars=data.map(d=>{
    const w=Math.round((d.days/mx)*100);
    const col=d.days>14?'#f87171':d.days>7?'#fb923c':d.days>3?'#facc15':'#4ade80';
    return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">
      <div style="width:120px;font-size:10px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(d.title)}">${esc(d.title)}</div>
      <div style="flex:1;background:var(--bg-surface);height:12px;border-radius:3px;overflow:hidden"><div style="height:100%;width:${w}%;background:${col};border-radius:3px"></div></div>
      <div style="width:30px;font-size:10px;color:var(--text-muted);text-align:right">${d.days}d</div>
    </div>`;
  }).join('');
  const d=document.createElement('div');d.id='lead-time-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:460px;width:90vw;max-height:70vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Lead Time</span><span onclick="document.getElementById('lead-time-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="display:flex;gap:16px;margin-bottom:12px">
      <div style="text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent)">${avg}</div><div style="font-size:9px;color:var(--text-muted)">Avg Days</div></div>
      <div style="text-align:center"><div style="font-size:20px;font-weight:700;color:#22d3ee">${median}</div><div style="font-size:9px;color:var(--text-muted)">Median</div></div>
      <div style="text-align:center"><div style="font-size:20px;font-weight:700;color:var(--text-secondary)">${data.length}</div><div style="font-size:9px;color:var(--text-muted)">Completed</div></div>
    </div>
    ${data.length?bars:'<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">No completed tasks with dates</div>'}
  </div>`;
  document.body.appendChild(d);
}
function showQuickMetronome(){
  let ex=document.getElementById('metronome-float');if(ex){ex.remove();return;}
  let bpm=120,running=false,beat=0;
  const d=document.createElement('div');d.id='metronome-float';
  const tick=()=>{
    try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const osc=ctx.createOscillator();const gain=ctx.createGain();osc.connect(gain);gain.connect(ctx.destination);osc.frequency.value=beat%4===0?880:440;gain.gain.value=0.3;osc.start();osc.stop(ctx.currentTime+0.05);beat++;}catch(e){}
  };
  const rend=()=>{
    const dots=[0,1,2,3].map(i=>`<div style="width:16px;height:16px;border-radius:50%;${beat%4===i&&running?'background:var(--accent)':'background:var(--bg-surface);border:1px solid var(--border)'}"></div>`).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:180px;text-align:center">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Metronome</span><span onclick="clearInterval(window._metInt);document.getElementById('metronome-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="font-size:32px;font-weight:200;color:var(--text-primary)">${bpm}</div>
      <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">BPM</div>
      <div style="display:flex;gap:6px;justify-content:center;margin-bottom:10px">${dots}</div>
      <input type="range" min="40" max="220" value="${bpm}" oninput="window._setBpm(parseInt(this.value))" style="width:100%;margin-bottom:8px;accent-color:var(--accent)">
      <div style="display:flex;gap:4px;justify-content:center;margin-bottom:8px">
        ${[60,90,120,140,180].map(b=>`<button onclick="window._setBpm(${b})" style="background:${bpm===b?'var(--accent)':'var(--bg-surface)'};color:${bpm===b?'#000':'var(--text-secondary)'};border:1px solid var(--border);padding:3px 6px;border-radius:4px;cursor:pointer;font-size:9px">${b}</button>`).join('')}
      </div>
      <button onclick="window._toggleMetronome()" style="background:${running?'#f87171':'var(--accent)'};color:${running?'#fff':'#000'};border:none;padding:6px 20px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">${running?'Stop':'Start'}</button>
    </div>`;
  };
  window._setBpm=(b)=>{bpm=b;if(running){clearInterval(window._metInt);window._metInt=setInterval(()=>{tick();rend();},60000/bpm);}rend();};
  window._toggleMetronome=()=>{running=!running;if(running){beat=0;window._metInt=setInterval(()=>{tick();rend();},60000/bpm);}else{clearInterval(window._metInt);}rend();};
  document.body.appendChild(d);rend();
}
function showApiEndpointGen(){
  let ex=document.getElementById('api-endpoint-float');if(ex){ex.remove();return;}
  const presets={
    'Express REST':`const express = require('express');\nconst router = express.Router();\n\n// GET all items\nrouter.get('/items', async (req, res) => {\n  try {\n    const items = await Item.find();\n    res.json(items);\n  } catch (err) {\n    res.status(500).json({ error: err.message });\n  }\n});\n\n// GET single item\nrouter.get('/items/:id', async (req, res) => {\n  try {\n    const item = await Item.findById(req.params.id);\n    if (!item) return res.status(404).json({ error: 'Not found' });\n    res.json(item);\n  } catch (err) {\n    res.status(500).json({ error: err.message });\n  }\n});\n\n// POST create item\nrouter.post('/items', async (req, res) => {\n  try {\n    const item = new Item(req.body);\n    await item.save();\n    res.status(201).json(item);\n  } catch (err) {\n    res.status(400).json({ error: err.message });\n  }\n});\n\n// PUT update item\nrouter.put('/items/:id', async (req, res) => {\n  try {\n    const item = await Item.findByIdAndUpdate(req.params.id, req.body, { new: true });\n    if (!item) return res.status(404).json({ error: 'Not found' });\n    res.json(item);\n  } catch (err) {\n    res.status(400).json({ error: err.message });\n  }\n});\n\n// DELETE item\nrouter.delete('/items/:id', async (req, res) => {\n  try {\n    const item = await Item.findByIdAndDelete(req.params.id);\n    if (!item) return res.status(404).json({ error: 'Not found' });\n    res.json({ message: 'Deleted' });\n  } catch (err) {\n    res.status(500).json({ error: err.message });\n  }\n});\n\nmodule.exports = router;`,
    'Next.js API':`import { NextResponse } from 'next/server';\n\nexport async function GET(request) {\n  const { searchParams } = new URL(request.url);\n  const id = searchParams.get('id');\n\n  if (id) {\n    const item = await db.item.findUnique({ where: { id } });\n    if (!item) return NextResponse.json({ error: 'Not found' }, { status: 404 });\n    return NextResponse.json(item);\n  }\n\n  const items = await db.item.findMany();\n  return NextResponse.json(items);\n}\n\nexport async function POST(request) {\n  const body = await request.json();\n  const item = await db.item.create({ data: body });\n  return NextResponse.json(item, { status: 201 });\n}\n\nexport async function PUT(request) {\n  const body = await request.json();\n  const item = await db.item.update({\n    where: { id: body.id },\n    data: body\n  });\n  return NextResponse.json(item);\n}\n\nexport async function DELETE(request) {\n  const { searchParams } = new URL(request.url);\n  const id = searchParams.get('id');\n  await db.item.delete({ where: { id } });\n  return NextResponse.json({ message: 'Deleted' });\n}`,
    'Fastify':`const itemRoutes = async (fastify) => {\n  fastify.get('/items', async (request, reply) => {\n    const items = await fastify.db.items.find();\n    return items;\n  });\n\n  fastify.get('/items/:id', {\n    schema: {\n      params: { type: 'object', properties: { id: { type: 'string' } } }\n    }\n  }, async (request, reply) => {\n    const item = await fastify.db.items.findOne({ id: request.params.id });\n    if (!item) return reply.code(404).send({ error: 'Not found' });\n    return item;\n  });\n\n  fastify.post('/items', {\n    schema: {\n      body: { type: 'object', required: ['name'], properties: { name: { type: 'string' } } }\n    }\n  }, async (request, reply) => {\n    const item = await fastify.db.items.insert(request.body);\n    return reply.code(201).send(item);\n  });\n};\n\nmodule.exports = itemRoutes;`
  };
  let sel='Express REST';
  const d=document.createElement('div');d.id='api-endpoint-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-apipre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-apipre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:640px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">API Endpoint Generator</span><span onclick="document.getElementById('api-endpoint-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#api-endpoint-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Code',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy Code</button>
    </div>`;
    d.querySelectorAll('[data-apipre]').forEach(b=>b.onclick=()=>{sel=b.dataset.apipre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskCycleTimeDistribution(){
  let ex=document.getElementById('cycle-dist-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.status==='done'&&t.createdAt&&t.completedAt);
  const buckets={'Same Day':0,'1-2 Days':0,'3-5 Days':0,'1-2 Weeks':0,'2-4 Weeks':0,'1+ Month':0};
  tasks.forEach(t=>{
    const days=Math.floor((new Date(t.completedAt)-new Date(t.createdAt))/(86400000));
    if(days<1) buckets['Same Day']++;
    else if(days<=2) buckets['1-2 Days']++;
    else if(days<=5) buckets['3-5 Days']++;
    else if(days<=14) buckets['1-2 Weeks']++;
    else if(days<=30) buckets['2-4 Weeks']++;
    else buckets['1+ Month']++;
  });
  const keys=Object.keys(buckets);const vals=Object.values(buckets);
  const mx=Math.max(...vals,1);
  const colors=['#4ade80','#22d3ee','#a78bfa','#facc15','#fb923c','#f87171'];
  const bars=keys.map((k,i)=>{const h=Math.round((vals[i]/mx)*120);return `<rect x="${i*52+5}" y="${140-h}" width="40" height="${h}" rx="3" fill="${colors[i]}" opacity="0.85"/><text x="${i*52+25}" y="${155}" text-anchor="middle" fill="var(--text-muted)" font-size="7">${k}</text><text x="${i*52+25}" y="${136-h}" text-anchor="middle" fill="var(--text-primary)" font-size="10" font-weight="600">${vals[i]}</text>`;}).join('');
  const d=document.createElement('div');d.id='cycle-dist-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Cycle Time Distribution</span><span onclick="document.getElementById('cycle-dist-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <svg width="320" height="165" viewBox="0 0 320 165">${bars}</svg>
    <div style="margin-top:6px;font-size:10px;color:var(--text-muted)">${tasks.length} completed tasks analyzed</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickTipCalculator(){
  let ex=document.getElementById('tip-calc-float');if(ex){ex.remove();return;}
  let bill=0,tipPct=18,split=1;
  const d=document.createElement('div');d.id='tip-calc-float';
  const rend=()=>{
    const tip=bill*(tipPct/100);const total=bill+tip;const perPerson=split>0?total/split:total;
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:220px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Tip Calculator</span><span onclick="document.getElementById('tip-calc-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="margin-bottom:8px"><label style="font-size:10px;color:var(--text-muted)">Bill Amount</label><input type="number" value="${bill||''}" placeholder="0.00" oninput="window._tipBill=parseFloat(this.value)||0;window._tipRend()" style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;padding:6px;color:var(--text-primary);font-size:14px;box-sizing:border-box;margin-top:2px"></div>
      <div style="margin-bottom:8px"><label style="font-size:10px;color:var(--text-muted)">Tip %</label><div style="display:flex;gap:4px;margin-top:4px">${[10,15,18,20,25].map(p=>`<button onclick="window._tipPct=${p};window._tipRend()" style="background:${tipPct===p?'var(--accent)':'var(--bg-surface)'};color:${tipPct===p?'#000':'var(--text-secondary)'};border:1px solid var(--border);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;flex:1">${p}%</button>`).join('')}</div></div>
      <div style="margin-bottom:10px"><label style="font-size:10px;color:var(--text-muted)">Split</label><input type="number" value="${split}" min="1" oninput="window._tipSplit=parseInt(this.value)||1;window._tipRend()" style="width:60px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;padding:4px;color:var(--text-primary);font-size:12px;margin-top:2px"></div>
      <div style="border-top:1px solid var(--border);padding-top:8px">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-secondary);margin-bottom:4px"><span>Tip</span><span>$${tip.toFixed(2)}</span></div>
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-secondary);margin-bottom:4px"><span>Total</span><span>$${total.toFixed(2)}</span></div>
        ${split>1?`<div style="display:flex;justify-content:space-between;font-size:13px;color:var(--accent);font-weight:600"><span>Per Person</span><span>$${perPerson.toFixed(2)}</span></div>`:''}
      </div>
    </div>`;
  };
  window._tipBill=bill;window._tipPct=tipPct;window._tipSplit=split;
  window._tipRend=()=>{bill=window._tipBill;tipPct=window._tipPct;split=window._tipSplit;rend();};
  document.body.appendChild(d);rend();
}
function showGraphqlSchemaGen(){
  let ex=document.getElementById('gql-gen-float');if(ex){ex.remove();return;}
  const presets={
    'User + Auth':`type User {\n  id: ID!\n  email: String!\n  name: String\n  role: Role!\n  posts: [Post!]!\n  createdAt: DateTime!\n  updatedAt: DateTime!\n}\n\ntype AuthPayload {\n  token: String!\n  user: User!\n}\n\nenum Role {\n  USER\n  ADMIN\n}\n\ntype Query {\n  me: User\n  user(id: ID!): User\n  users(limit: Int, offset: Int): [User!]!\n}\n\ntype Mutation {\n  signup(email: String!, password: String!, name: String): AuthPayload!\n  login(email: String!, password: String!): AuthPayload!\n  updateUser(id: ID!, name: String, role: Role): User!\n  deleteUser(id: ID!): Boolean!\n}\n\nscalar DateTime`,
    'Blog':`type Post {\n  id: ID!\n  title: String!\n  slug: String!\n  content: String\n  published: Boolean!\n  author: User!\n  tags: [String!]\n  comments: [Comment!]!\n  createdAt: DateTime!\n}\n\ntype Comment {\n  id: ID!\n  body: String!\n  author: User!\n  post: Post!\n  createdAt: DateTime!\n}\n\ntype Query {\n  posts(published: Boolean, limit: Int): [Post!]!\n  post(slug: String!): Post\n  searchPosts(query: String!): [Post!]!\n}\n\ntype Mutation {\n  createPost(title: String!, content: String, tags: [String]): Post!\n  updatePost(id: ID!, title: String, content: String, published: Boolean): Post!\n  deletePost(id: ID!): Boolean!\n  addComment(postId: ID!, body: String!): Comment!\n}`,
    'E-commerce':`type Product {\n  id: ID!\n  name: String!\n  description: String\n  price: Float!\n  images: [String!]\n  category: Category\n  inStock: Boolean!\n  reviews: [Review!]!\n}\n\ntype Order {\n  id: ID!\n  items: [OrderItem!]!\n  total: Float!\n  status: OrderStatus!\n  user: User!\n  createdAt: DateTime!\n}\n\ntype OrderItem {\n  product: Product!\n  quantity: Int!\n  price: Float!\n}\n\ntype Review {\n  id: ID!\n  rating: Int!\n  comment: String\n  user: User!\n}\n\nenum OrderStatus {\n  PENDING\n  PROCESSING\n  SHIPPED\n  DELIVERED\n  CANCELLED\n}\n\ntype Query {\n  products(category: ID, search: String): [Product!]!\n  product(id: ID!): Product\n  orders: [Order!]!\n}\n\ntype Mutation {\n  createOrder(items: [OrderItemInput!]!): Order!\n  addReview(productId: ID!, rating: Int!, comment: String): Review!\n}\n\ninput OrderItemInput {\n  productId: ID!\n  quantity: Int!\n}`
  };
  let sel='User + Auth';
  const d=document.createElement('div');d.id='gql-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-gqlpre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-gqlpre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:620px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">GraphQL Schema Generator</span><span onclick="document.getElementById('gql-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#gql-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Schema',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy Schema</button>
    </div>`;
    d.querySelectorAll('[data-gqlpre]').forEach(b=>b.onclick=()=>{sel=b.dataset.gqlpre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskThroughput(){
  let ex=document.getElementById('throughput-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const weeks=8;const now=new Date();
  const data=[];
  for(let i=weeks-1;i>=0;i--){
    const start=new Date(now);start.setDate(start.getDate()-i*7-6);
    const end=new Date(now);end.setDate(end.getDate()-i*7);
    const completed=tasks.filter(t=>t.status==='done'&&t.completedAt&&new Date(t.completedAt)>=start&&new Date(t.completedAt)<=end).length;
    const created=tasks.filter(t=>t.createdAt&&new Date(t.createdAt)>=start&&new Date(t.createdAt)<=end).length;
    const label=`W${weeks-i}`;
    data.push({label,completed,created});
  }
  const mx=Math.max(...data.map(d=>Math.max(d.completed,d.created)),1);
  const w=300,h=120;
  const compPts=data.map((d,i)=>`${Math.round((i/(data.length-1||1))*w)},${Math.round(h-(d.completed/mx)*h)}`).join(' ');
  const creatPts=data.map((d,i)=>`${Math.round((i/(data.length-1||1))*w)},${Math.round(h-(d.created/mx)*h)}`).join(' ');
  const labels=data.map((d,i)=>`<text x="${Math.round((i/(data.length-1||1))*w)}" y="${h+14}" text-anchor="middle" fill="var(--text-muted)" font-size="8">${d.label}</text>`).join('');
  const avgThru=data.length?Math.round(data.reduce((s,d)=>s+d.completed,0)/data.length*10)/10:0;
  const d=document.createElement('div');d.id='throughput-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Weekly Throughput</span><span onclick="document.getElementById('throughput-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <svg width="${w}" height="${h+20}" viewBox="0 0 ${w} ${h+20}">
      <polyline points="${creatPts}" fill="none" stroke="#22d3ee" stroke-width="2" stroke-dasharray="4 2" opacity="0.6"/>
      <polyline points="${compPts}" fill="none" stroke="#4ade80" stroke-width="2"/>
      ${labels}
    </svg>
    <div style="display:flex;gap:12px;margin-top:8px">
      <span style="font-size:10px;color:#4ade80;display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:#4ade80;display:inline-block"></span>Completed</span>
      <span style="font-size:10px;color:#22d3ee;display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:#22d3ee;display:inline-block;border-top:1px dashed #22d3ee"></span>Created</span>
    </div>
    <div style="margin-top:6px;font-size:10px;color:var(--text-muted)">Avg throughput: ${avgThru} tasks/week over ${weeks} weeks</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickTextDiff(){
  let ex=document.getElementById('text-diff-float');if(ex){ex.remove();return;}
  const d=document.createElement('div');d.id='text-diff-float';
  const rend=(t1,t2)=>{
    t1=t1||'';t2=t2||'';
    let diff='';
    if(t1&&t2){
      const lines1=t1.split('\n');const lines2=t2.split('\n');
      const maxLen=Math.max(lines1.length,lines2.length);
      for(let i=0;i<maxLen;i++){
        const l1=lines1[i]||'';const l2=lines2[i]||'';
        if(l1===l2) diff+=`<div style="font-size:10px;color:var(--text-muted);padding:1px 4px;font-family:monospace">${esc(l1)||'&nbsp;'}</div>`;
        else{
          if(l1) diff+=`<div style="font-size:10px;color:#f87171;background:rgba(248,113,113,0.1);padding:1px 4px;font-family:monospace">- ${esc(l1)}</div>`;
          if(l2) diff+=`<div style="font-size:10px;color:#4ade80;background:rgba(74,222,128,0.1);padding:1px 4px;font-family:monospace">+ ${esc(l2)}</div>`;
        }
      }
    }
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Text Diff</span><span onclick="document.getElementById('text-diff-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
        <div><label style="font-size:10px;color:var(--text-muted)">Original</label><textarea id="diff-t1" rows="6" style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-size:11px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-top:4px">${esc(t1)}</textarea></div>
        <div><label style="font-size:10px;color:var(--text-muted)">Modified</label><textarea id="diff-t2" rows="6" style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-size:11px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-top:4px">${esc(t2)}</textarea></div>
      </div>
      <button onclick="window._runDiff()" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-bottom:10px">Compare</button>
      ${diff?`<div style="border:1px solid var(--border);border-radius:6px;padding:8px;max-height:200px;overflow-y:auto">${diff}</div>`:''}
    </div>`;
  };
  window._runDiff=()=>{
    const t1=document.getElementById('diff-t1').value;
    const t2=document.getElementById('diff-t2').value;
    rend(t1,t2);
  };
  document.body.appendChild(d);rend();
}
function showSocketIoBoilerplate(){
  let ex=document.getElementById('socketio-gen-float');if(ex){ex.remove();return;}
  const presets={
    'Server':`const { Server } = require('socket.io');\nconst http = require('http');\nconst express = require('express');\n\nconst app = express();\nconst server = http.createServer(app);\nconst io = new Server(server, {\n  cors: { origin: '*' }\n});\n\nio.on('connection', (socket) => {\n  console.log('User connected:', socket.id);\n\n  socket.on('join-room', (room) => {\n    socket.join(room);\n    socket.to(room).emit('user-joined', socket.id);\n  });\n\n  socket.on('message', (data) => {\n    io.to(data.room).emit('message', {\n      user: socket.id,\n      text: data.text,\n      timestamp: new Date().toISOString()\n    });\n  });\n\n  socket.on('disconnect', () => {\n    console.log('User disconnected:', socket.id);\n  });\n});\n\nserver.listen(3001, () => {\n  console.log('Socket.IO server on port 3001');\n});`,
    'React Client':`import { useEffect, useState } from 'react';\nimport { io } from 'socket.io-client';\n\nconst socket = io('http://localhost:3001');\n\nexport function useSocket() {\n  const [connected, setConnected] = useState(false);\n  const [messages, setMessages] = useState([]);\n\n  useEffect(() => {\n    socket.on('connect', () => setConnected(true));\n    socket.on('disconnect', () => setConnected(false));\n\n    socket.on('message', (msg) => {\n      setMessages((prev) => [...prev, msg]);\n    });\n\n    return () => {\n      socket.off('connect');\n      socket.off('disconnect');\n      socket.off('message');\n    };\n  }, []);\n\n  const sendMessage = (room, text) => {\n    socket.emit('message', { room, text });\n  };\n\n  const joinRoom = (room) => {\n    socket.emit('join-room', room);\n  };\n\n  return { connected, messages, sendMessage, joinRoom };\n}`,
    'Chat Room':`// Server: chat room with typing indicators\nio.on('connection', (socket) => {\n  let username = '';\n\n  socket.on('set-username', (name) => {\n    username = name;\n    io.emit('user-list', getUsers());\n  });\n\n  socket.on('typing', (room) => {\n    socket.to(room).emit('typing', { user: username });\n  });\n\n  socket.on('stop-typing', (room) => {\n    socket.to(room).emit('stop-typing', { user: username });\n  });\n\n  socket.on('chat-message', ({ room, message }) => {\n    io.to(room).emit('chat-message', {\n      user: username,\n      message,\n      timestamp: Date.now()\n    });\n  });\n});`
  };
  let sel='Server';
  const d=document.createElement('div');d.id='socketio-gen-float';
  const rend=()=>{
    let tabs=Object.keys(presets).map(k=>`<span onclick="document.querySelector('[data-siopre=\\''+k+'\\']').click()" style="padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;${k===sel?'background:var(--accent);color:#000':'background:var(--bg-surface);color:var(--text-secondary)'}" data-siopre="${k}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:620px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Socket.IO Boilerplate</span><span onclick="document.getElementById('socketio-gen-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:12px;font-size:11px;color:#4ade80;overflow-x:auto;white-space:pre;margin-bottom:12px;line-height:1.5">${esc(presets[sel])}</pre>
      <button onclick="navigator.clipboard.writeText(document.querySelector('#socketio-gen-float pre').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Code',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy Code</button>
    </div>`;
    d.querySelectorAll('[data-siopre]').forEach(b=>b.onclick=()=>{sel=b.dataset.siopre;rend();});
  };
  document.body.appendChild(d);rend();
}
function showTaskProjectRadar(){
  let ex=document.getElementById('project-radar-float');if(ex){ex.remove();return;}
  const projects=S.projects||[];
  const tasks=S.tasks||[];
  const metrics=projects.map(p=>{
    const pt=tasks.filter(t=>t.projectId===p.id);
    const total=pt.length||1;
    const done=pt.filter(t=>t.status==='done').length;
    const active=pt.filter(t=>t.status==='in-progress').length;
    const overdue=pt.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length;
    return{name:p.name,completion:done/total,activity:active/Math.max(total,1),health:1-(overdue/Math.max(total,1)),volume:Math.min(total/10,1)};
  }).slice(0,6);
  const cx=120,cy=120,r=90;
  const dims=['Completion','Activity','Health','Volume'];
  const angles=dims.map((_,i)=>(i*2*Math.PI/dims.length)-Math.PI/2);
  const axes=dims.map((d,i)=>{
    const x=cx+r*Math.cos(angles[i]);const y=cy+r*Math.sin(angles[i]);
    return `<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="var(--border)" stroke-width="1"/><text x="${cx+(r+14)*Math.cos(angles[i])}" y="${cy+(r+14)*Math.sin(angles[i])}" text-anchor="middle" fill="var(--text-muted)" font-size="8">${d}</text>`;
  }).join('');
  const colors=['#4ade80','#22d3ee','#a78bfa','#fb923c','#f87171','#facc15'];
  const polys=metrics.map((m,mi)=>{
    const vals=[m.completion,m.activity,m.health,m.volume];
    const pts=vals.map((v,i)=>`${cx+v*r*0.8*Math.cos(angles[i])},${cy+v*r*0.8*Math.sin(angles[i])}`).join(' ');
    return `<polygon points="${pts}" fill="${colors[mi%colors.length]}" fill-opacity="0.15" stroke="${colors[mi%colors.length]}" stroke-width="1.5"/>`;
  }).join('');
  const legend=metrics.map((m,i)=>`<span style="font-size:9px;color:${colors[i%colors.length]};display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;border-radius:2px;background:${colors[i%colors.length]}"></span>${esc(m.name)}</span>`).join('');
  const d=document.createElement('div');d.id='project-radar-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:340px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;color:var(--text-primary)">Project Radar</span><span onclick="document.getElementById('project-radar-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="text-align:center"><svg width="240" height="240" viewBox="0 0 240 240">${axes}${polys}</svg></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">${legend}</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickMarkdownPreview(){
  let ex=document.getElementById('md-preview-float');if(ex){ex.remove();return;}
  const d=document.createElement('div');d.id='md-preview-float';
  const renderMd=(text)=>{
    return text
      .replace(/^### (.+)$/gm,'<h3 style="font-size:14px;color:var(--text-primary);margin:8px 0 4px">$1</h3>')
      .replace(/^## (.+)$/gm,'<h2 style="font-size:16px;color:var(--text-primary);margin:10px 0 4px">$1</h2>')
      .replace(/^# (.+)$/gm,'<h1 style="font-size:18px;color:var(--text-primary);margin:12px 0 6px">$1</h1>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>')
      .replace(/`(.+?)`/g,'<code style="background:var(--bg-surface);padding:1px 4px;border-radius:3px;font-size:11px">$1</code>')
      .replace(/^- (.+)$/gm,'<li style="margin-left:16px;font-size:12px">$1</li>')
      .replace(/^(\d+)\. (.+)$/gm,'<li style="margin-left:16px;font-size:12px">$2</li>')
      .replace(/\n/g,'<br>');
  };
  const rend=(md)=>{
    md=md||'# Hello World\n\n## Subtitle\n\nThis is **bold** and *italic* text with `inline code`.\n\n- Item one\n- Item two\n- Item three\n\n1. First\n2. Second\n3. Third';
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Markdown Preview</span><span onclick="document.getElementById('md-preview-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><label style="font-size:10px;color:var(--text-muted)">Markdown</label><textarea id="md-input" rows="12" oninput="window._mdPreview()" style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-size:11px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-top:4px">${esc(md)}</textarea></div>
        <div><label style="font-size:10px;color:var(--text-muted)">Preview</label><div id="md-output" style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-secondary);font-size:12px;line-height:1.6;margin-top:4px;min-height:200px;overflow-y:auto">${renderMd(md)}</div></div>
      </div>
      <button onclick="navigator.clipboard.writeText(document.getElementById('md-input').value);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Markdown',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-top:10px">Copy Markdown</button>
    </div>`;
  };
  window._mdPreview=()=>{
    const txt=document.getElementById('md-input').value;
    document.getElementById('md-output').innerHTML=renderMd(txt);
  };
  document.body.appendChild(d);rend();
}
function showJwtDecoder(){
  let ex=document.getElementById('jwt-decoder-float');if(ex){ex.remove();return;}
  const d=document.createElement('div');d.id='jwt-decoder-float';
  const decode=(token)=>{
    if(!token)return{header:null,payload:null,valid:false};
    try{
      const parts=token.split('.');
      if(parts.length!==3)return{header:null,payload:null,valid:false};
      const header=JSON.parse(atob(parts[0].replace(/-/g,'+').replace(/_/g,'/')));
      const payload=JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
      const exp=payload.exp?new Date(payload.exp*1000):null;
      const expired=exp?exp<new Date():false;
      return{header,payload,valid:true,exp,expired};
    }catch(e){return{header:null,payload:null,valid:false};}
  };
  const rend=(token)=>{
    token=token||'';
    const r=decode(token);
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">JWT Decoder</span><span onclick="document.getElementById('jwt-decoder-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <textarea id="jwt-input" placeholder="Paste JWT token here..." rows="3" oninput="window._decodeJwt()" style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-size:11px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-bottom:12px">${esc(token)}</textarea>
      ${r.valid?`
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Header</div><pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:11px;color:#22d3ee;overflow-x:auto;line-height:1.4">${JSON.stringify(r.header,null,2)}</pre></div>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Payload</div><pre style="background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:11px;color:#4ade80;overflow-x:auto;line-height:1.4">${JSON.stringify(r.payload,null,2)}</pre></div>
        ${r.exp?`<div style="font-size:11px;color:${r.expired?'#f87171':'#4ade80'};margin-bottom:6px">${r.expired?'EXPIRED':'Valid'} | Expires: ${r.exp.toLocaleString()}</div>`:''}`
      :token?'<div style="color:#f87171;font-size:12px;padding:12px;text-align:center">Invalid JWT format</div>':'<div style="color:var(--text-muted);font-size:12px;padding:12px;text-align:center">Paste a JWT to decode</div>'}
    </div>`;
  };
  window._decodeJwt=()=>{rend(document.getElementById('jwt-input').value);};
  document.body.appendChild(d);rend();
}
function showTaskSummaryDashboard(){
  let ex=document.getElementById('task-summary-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const total=tasks.length;
  const done=tasks.filter(t=>t.status==='done').length;
  const inProg=tasks.filter(t=>t.status==='in-progress').length;
  const todo=tasks.filter(t=>t.status==='todo').length;
  const blocked=tasks.filter(t=>t.status==='blocked').length;
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&new Date(t.due)<new Date()).length;
  const today=new Date().toISOString().split('T')[0];
  const createdToday=tasks.filter(t=>t.createdAt&&t.createdAt.startsWith(today)).length;
  const doneToday=tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(today)).length;
  const p0=tasks.filter(t=>t.priority==='p0'&&t.status!=='done').length;
  const p1=tasks.filter(t=>t.priority==='p1'&&t.status!=='done').length;
  const avgAge=()=>{const open=tasks.filter(t=>t.status!=='done'&&t.createdAt);if(!open.length)return 0;const now=new Date();return Math.round(open.reduce((s,t)=>s+(now-new Date(t.createdAt))/(86400000),0)/open.length);};
  const metric=(label,val,color)=>`<div style="background:var(--bg-surface);border-radius:8px;padding:10px;text-align:center"><div style="font-size:22px;font-weight:700;color:${color}">${val}</div><div style="font-size:9px;color:var(--text-muted);margin-top:2px">${label}</div></div>`;
  const d=document.createElement('div');d.id='task-summary-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Dashboard</span><span onclick="document.getElementById('task-summary-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
      ${metric('Total',total,'var(--text-primary)')}
      ${metric('Done',done,'#4ade80')}
      ${metric('In Progress',inProg,'#22d3ee')}
      ${metric('To Do',todo,'#6b7280')}
      ${metric('Blocked',blocked,'#f87171')}
      ${metric('Overdue',overdue,'#fb923c')}
    </div>
    <div style="border-top:1px solid var(--border);padding-top:10px;display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
      ${metric('Created Today',createdToday,'#22d3ee')}
      ${metric('Done Today',doneToday,'#4ade80')}
      ${metric('P0 Open',p0,'#f87171')}
      ${metric('Avg Age (days)',avgAge(),'#a78bfa')}
    </div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickAsciiArt(){
  let ex=document.getElementById('ascii-art-float');if(ex){ex.remove();return;}
  const arts={
    'Rocket':"    /\\\n   /  \\\n  |    |\n  |    |\n  | () |\n  |    |\n /|    |\\\n/ |    | \\\n  |XXXX|\n  |XXXX|\n /------\\\n/________\\",
    'Computer':" _____________\n|  _________  |\n| |         | |\n| |  ASTRA  | |\n| |_________| |\n|_____________|\n    _[___]_\n   [_______]",
    'Coffee':"    ( (\n     ) )\n  .______.\n  |      |]\n  \\      /\n   `----'",
    'Saturn':"     .  *  .\n   *  ___  *\n    /     \\\n---+-------+---\n    \\_____/\n   *       *\n     .  *  .",
    'Cat':" /\\_/\\\n( o.o )\n > ^ <\n/|   |\\\n(|   |)\n \"\" \"\"",
    'Ship':"     |\n    /|\\\n   / | \\\n  /  |  \\\n /   |   \\\n/    |    \\\n|____|____|\n\\________/\n \\______/"
  };
  let sel='Rocket';
  const d=document.createElement('div');d.id='ascii-art-float';
  const rend=()=>{
    const tabs=Object.keys(arts).map(k=>`<span onclick="window._setAscii('${k}')" style="padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px;${k===sel?'background:var(--accent);color:#000':'color:var(--text-muted)'}">${k}</span>`).join('');
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:240px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">ASCII Art</span><span onclick="document.getElementById('ascii-art-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px">${tabs}</div>
      <pre style="background:var(--bg-surface);border-radius:6px;padding:10px;font-size:10px;color:#4ade80;line-height:1.2;text-align:center;overflow-x:auto">${arts[sel]}</pre>
      <button onclick="navigator.clipboard.writeText(${JSON.stringify(arts[sel]).replace(/'/g,"\\'")});this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',1200)" style="background:var(--accent);color:#000;border:none;padding:4px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;margin-top:6px;width:100%">Copy</button>
    </div>`;
  };
  window._setAscii=(k)=>{sel=k;rend();};
  document.body.appendChild(d);rend();
}
function showRedisCommandRef(){
  let ex=document.getElementById('redis-ref-float');if(ex){ex.remove();return;}
  const categories={
    'Strings':['SET key value [EX seconds]','GET key','MSET key1 val1 key2 val2','MGET key1 key2','INCR key','INCRBY key amount','DECR key','APPEND key value','STRLEN key','SETEX key seconds value','SETNX key value','GETSET key value'],
    'Hashes':['HSET key field value','HGET key field','HMSET key f1 v1 f2 v2','HMGET key f1 f2','HGETALL key','HDEL key field','HEXISTS key field','HINCRBY key field amount','HKEYS key','HVALS key','HLEN key'],
    'Lists':['LPUSH key value','RPUSH key value','LPOP key','RPOP key','LRANGE key start stop','LLEN key','LINDEX key index','LSET key index value','LREM key count value','LINSERT key BEFORE|AFTER pivot value'],
    'Sets':['SADD key member','SREM key member','SMEMBERS key','SISMEMBER key member','SCARD key','SUNION key1 key2','SINTER key1 key2','SDIFF key1 key2','SRANDMEMBER key [count]'],
    'Sorted Sets':['ZADD key score member','ZREM key member','ZRANGE key start stop [WITHSCORES]','ZREVRANGE key start stop','ZSCORE key member','ZRANK key member','ZCARD key','ZINCRBY key increment member','ZRANGEBYSCORE key min max'],
    'Keys':['DEL key','EXISTS key','EXPIRE key seconds','TTL key','PERSIST key','KEYS pattern','TYPE key','RENAME key newkey','SCAN cursor [MATCH pattern] [COUNT count]']
  };
  let sel='Strings';
  const d=document.createElement('div');d.id='redis-ref-float';
  const rend=()=>{
    const tabs=Object.keys(categories).map(k=>`<span onclick="window._redisTab('${k}')" style="padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px;${k===sel?'background:var(--accent);color:#000':'color:var(--text-muted)'}">${k}</span>`).join('');
    const cmds=categories[sel].map(c=>`<div onclick="navigator.clipboard.writeText('${c.replace(/'/g,"\\'")}');this.style.color='#4ade80';setTimeout(()=>this.style.color='',600)" style="padding:4px 8px;font-size:11px;color:var(--text-secondary);font-family:monospace;cursor:pointer;border-bottom:1px solid var(--border)">${esc(c)}</div>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Redis Command Reference</span><span onclick="document.getElementById('redis-ref-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <div style="border:1px solid var(--border);border-radius:6px;overflow:hidden">${cmds}</div>
      <div style="margin-top:8px;font-size:9px;color:var(--text-muted)">Click any command to copy</div>
    </div>`;
  };
  window._redisTab=(k)=>{sel=k;rend();};
  document.body.appendChild(d);rend();
}
function showTaskProgressGauge(){
  let ex=document.getElementById('progress-gauge-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const total=tasks.length||1;
  const done=tasks.filter(t=>t.status==='done').length;
  const pct=Math.round((done/total)*100);
  const r=70;const circ=2*Math.PI*r;const offset=circ-(pct/100)*circ;
  const color=pct>=80?'#4ade80':pct>=50?'#facc15':pct>=25?'#fb923c':'#f87171';
  const d=document.createElement('div');d.id='progress-gauge-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:24px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:280px;width:90vw;text-align:center">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Overall Progress</span><span onclick="document.getElementById('progress-gauge-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <svg width="180" height="180" viewBox="0 0 180 180">
      <circle cx="90" cy="90" r="${r}" fill="none" stroke="var(--bg-surface)" stroke-width="12"/>
      <circle cx="90" cy="90" r="${r}" fill="none" stroke="${color}" stroke-width="12" stroke-linecap="round" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" transform="rotate(-90 90 90)" style="transition:stroke-dashoffset 1s ease"/>
      <text x="90" y="85" text-anchor="middle" fill="var(--text-primary)" font-size="32" font-weight="700">${pct}%</text>
      <text x="90" y="105" text-anchor="middle" fill="var(--text-muted)" font-size="11">${done} / ${total} tasks</text>
    </svg>
    <div style="margin-top:8px;font-size:10px;color:var(--text-muted)">${total-done} remaining</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickLoremIpsum(){
  let ex=document.getElementById('lorem-float');if(ex){ex.remove();return;}
  const paras=['Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.','Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.','Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.','Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet.','At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident.'];
  let count=3;
  const d=document.createElement('div');d.id='lorem-float';
  const rend=()=>{
    const text=paras.slice(0,count).join('\n\n');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Lorem Ipsum</span><span onclick="document.getElementById('lorem-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:4px;margin-bottom:10px">${[1,2,3,4,5].map(n=>`<button onclick="window._setLorem(${n})" style="background:${count===n?'var(--accent)':'var(--bg-surface)'};color:${count===n?'#000':'var(--text-secondary)'};border:1px solid var(--border);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">${n}p</button>`).join('')}</div>
      <div style="background:var(--bg-surface);border-radius:6px;padding:12px;font-size:12px;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap">${text}</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button onclick="navigator.clipboard.writeText(document.querySelector('#lorem-float div[style*=pre-wrap]').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Text',1200)" style="background:var(--accent);color:#000;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600">Copy Text</button>
        <span style="font-size:10px;color:var(--text-muted);align-self:center">${text.split(/\s+/).length} words</span>
      </div>
    </div>`;
  };
  window._setLorem=(n)=>{count=n;rend();};
  document.body.appendChild(d);rend();
}
function showGitCommandRef(){
  let ex=document.getElementById('git-ref-float');if(ex){ex.remove();return;}
  const categories={
    'Basics':['git init','git clone <url>','git status','git add <file>','git add .','git commit -m "msg"','git push','git pull','git fetch','git log --oneline'],
    'Branching':['git branch','git branch <name>','git checkout <branch>','git checkout -b <name>','git merge <branch>','git branch -d <name>','git switch <branch>','git switch -c <name>'],
    'Stash':['git stash','git stash pop','git stash list','git stash apply stash@{n}','git stash drop stash@{n}','git stash clear','git stash show -p'],
    'Diff & Log':['git diff','git diff --staged','git diff HEAD~1','git log --graph --oneline','git log --author="name"','git log --since="2 weeks ago"','git blame <file>','git show <commit>'],
    'Undo':['git reset HEAD <file>','git checkout -- <file>','git revert <commit>','git reset --soft HEAD~1','git reset --hard HEAD~1','git clean -fd','git restore <file>','git restore --staged <file>'],
    'Remote':['git remote -v','git remote add origin <url>','git push -u origin main','git push origin --delete <branch>','git fetch --prune','git pull --rebase']
  };
  let sel='Basics';
  const d=document.createElement('div');d.id='git-ref-float';
  const rend=()=>{
    const tabs=Object.keys(categories).map(k=>`<span onclick="window._gitTab('${k}')" style="padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px;${k===sel?'background:var(--accent);color:#000':'color:var(--text-muted)'}">${k}</span>`).join('');
    const cmds=categories[sel].map(c=>`<div onclick="navigator.clipboard.writeText('${c.replace(/'/g,"\\'")}');this.style.color='#4ade80';setTimeout(()=>this.style.color='',600)" style="padding:4px 8px;font-size:11px;color:var(--text-secondary);font-family:monospace;cursor:pointer;border-bottom:1px solid var(--border)">${esc(c)}</div>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Git Command Reference</span><span onclick="document.getElementById('git-ref-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <div style="border:1px solid var(--border);border-radius:6px;overflow:hidden">${cmds}</div>
      <div style="margin-top:8px;font-size:9px;color:var(--text-muted)">Click any command to copy</div>
    </div>`;
  };
  window._gitTab=(k)=>{sel=k;rend();};
  document.body.appendChild(d);rend();
}
function showTaskAgeHistogram(){
  let ex=document.getElementById('age-hist-float');if(ex){ex.remove();return;}
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done'&&t.createdAt);
  const now=new Date();
  const ages=tasks.map(t=>Math.floor((now-new Date(t.createdAt))/(86400000)));
  const buckets=[0,0,0,0,0,0];
  const labels=['0-1d','2-3d','4-7d','1-2w','2-4w','1m+'];
  ages.forEach(a=>{
    if(a<=1)buckets[0]++;
    else if(a<=3)buckets[1]++;
    else if(a<=7)buckets[2]++;
    else if(a<=14)buckets[3]++;
    else if(a<=30)buckets[4]++;
    else buckets[5]++;
  });
  const mx=Math.max(...buckets,1);
  const colors=['#4ade80','#22d3ee','#a78bfa','#facc15','#fb923c','#f87171'];
  const bars=labels.map((l,i)=>{const h=Math.round((buckets[i]/mx)*120);return `<rect x="${i*52+5}" y="${140-h}" width="40" height="${h}" rx="3" fill="${colors[i]}" opacity="0.85"/><text x="${i*52+25}" y="${155}" text-anchor="middle" fill="var(--text-muted)" font-size="8">${l}</text><text x="${i*52+25}" y="${136-h}" text-anchor="middle" fill="var(--text-primary)" font-size="10" font-weight="600">${buckets[i]}</text>`;}).join('');
  const avgAge=ages.length?Math.round(ages.reduce((s,a)=>s+a,0)/ages.length):0;
  const d=document.createElement('div');d.id='age-hist-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:400px;width:90vw">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Task Age Histogram</span><span onclick="document.getElementById('age-hist-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <svg width="320" height="165" viewBox="0 0 320 165">${bars}</svg>
    <div style="margin-top:6px;font-size:10px;color:var(--text-muted)">${tasks.length} open tasks | Average age: ${avgAge} days</div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickCharCounter(){
  let ex=document.getElementById('char-counter-float');if(ex){ex.remove();return;}
  const d=document.createElement('div');d.id='char-counter-float';
  const rend=(text)=>{
    text=text||'';
    const chars=text.length;
    const words=text.trim()?text.trim().split(/\s+/).length:0;
    const lines=text?text.split('\n').length:0;
    const sentences=text.trim()?text.split(/[.!?]+/).filter(s=>s.trim()).length:0;
    const paras=text.trim()?text.split(/\n\n+/).filter(p=>p.trim()).length:0;
    const readTime=Math.max(1,Math.ceil(words/200));
    d.innerHTML=`<div style="position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:280px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Character Counter</span><span onclick="document.getElementById('char-counter-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      <textarea id="char-input" placeholder="Type or paste text..." rows="4" oninput="window._countChars()" style="width:100%;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:8px;color:var(--text-primary);font-size:11px;resize:vertical;box-sizing:border-box;margin-bottom:8px">${esc(text)}</textarea>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
        <div style="text-align:center"><div style="font-size:16px;font-weight:700;color:var(--accent)">${chars}</div><div style="font-size:8px;color:var(--text-muted)">Chars</div></div>
        <div style="text-align:center"><div style="font-size:16px;font-weight:700;color:#22d3ee">${words}</div><div style="font-size:8px;color:var(--text-muted)">Words</div></div>
        <div style="text-align:center"><div style="font-size:16px;font-weight:700;color:#a78bfa">${lines}</div><div style="font-size:8px;color:var(--text-muted)">Lines</div></div>
        <div style="text-align:center"><div style="font-size:16px;font-weight:700;color:#fb923c">${sentences}</div><div style="font-size:8px;color:var(--text-muted)">Sentences</div></div>
        <div style="text-align:center"><div style="font-size:16px;font-weight:700;color:#facc15">${paras}</div><div style="font-size:8px;color:var(--text-muted)">Paragraphs</div></div>
        <div style="text-align:center"><div style="font-size:16px;font-weight:700;color:var(--text-secondary)">${readTime}m</div><div style="font-size:8px;color:var(--text-muted)">Read Time</div></div>
      </div>
    </div>`;
  };
  window._countChars=()=>rend(document.getElementById('char-input').value);
  document.body.appendChild(d);rend();
}
function showNpmScriptsRef(){
  let ex=document.getElementById('npm-ref-float');if(ex){ex.remove();return;}
  const categories={
    'Common':['npm init -y','npm install <pkg>','npm install -D <pkg>','npm uninstall <pkg>','npm update','npm outdated','npm list --depth=0','npm run <script>','npm test','npm start','npm run build'],
    'Publishing':['npm login','npm publish','npm version patch','npm version minor','npm version major','npm pack','npm deprecate <pkg> "msg"','npm unpublish <pkg>'],
    'Config':['npm config list','npm config set registry <url>','npm config get prefix','npm cache clean --force','npm config set save-exact true'],
    'Info':['npm info <pkg>','npm search <query>','npm view <pkg> versions','npm docs <pkg>','npm bugs <pkg>','npm ls <pkg>','npm audit','npm audit fix','npm doctor'],
    'Workspaces':['npm init -w packages/<name>','npm install -w <workspace>','npm run test --workspaces','npm run build -w <name>','npm ls --workspaces'],
    'npx':['npx create-react-app my-app','npx create-next-app@latest','npx degit user/repo','npx ts-node script.ts','npx prettier --write .','npx eslint .']
  };
  let sel='Common';
  const d=document.createElement('div');d.id='npm-ref-float';
  const rend=()=>{
    const tabs=Object.keys(categories).map(k=>`<span onclick="window._npmTab('${k}')" style="padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px;${k===sel?'background:var(--accent);color:#000':'color:var(--text-muted)'}">${k}</span>`).join('');
    const cmds=categories[sel].map(c=>`<div onclick="navigator.clipboard.writeText('${c.replace(/'/g,"\\'")}');this.style.color='#4ade80';setTimeout(()=>this.style.color='',600)" style="padding:4px 8px;font-size:11px;color:var(--text-secondary);font-family:monospace;cursor:pointer;border-bottom:1px solid var(--border)">${esc(c)}</div>`).join('');
    d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">npm Command Reference</span><span onclick="document.getElementById('npm-ref-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px">${tabs}</div>
      <div style="border:1px solid var(--border);border-radius:6px;overflow:hidden">${cmds}</div>
      <div style="margin-top:8px;font-size:9px;color:var(--text-muted)">Click any command to copy</div>
    </div>`;
  };
  window._npmTab=(k)=>{sel=k;rend();};
  document.body.appendChild(d);rend();
}
function showTaskFlowBoard(){
  let ex=document.getElementById('flow-board-float');if(ex){ex.remove();return;}
  const tasks=S.tasks||[];
  const cols={todo:[],inProgress:[],review:[],done:[]};
  tasks.forEach(t=>{
    if(t.status==='done')cols.done.push(t);
    else if(t.status==='in-progress')cols.inProgress.push(t);
    else if(t.status==='blocked')cols.review.push(t);
    else cols.todo.push(t);
  });
  const renderCol=(title,items,color,limit)=>{
    const over=limit&&items.length>limit;
    const cards=items.slice(0,8).map(t=>{
      const pCol=t.priority==='p0'?'#f87171':t.priority==='p1'?'#fb923c':t.priority==='p2'?'#22d3ee':'#6b7280';
      return `<div style="background:var(--bg-elevated);border-radius:4px;padding:6px;border-left:3px solid ${pCol};font-size:10px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(t.title)}">${esc(t.title)}</div>`;
    }).join('');
    return `<div style="flex:1;min-width:120px">
      <div style="font-size:10px;font-weight:600;color:${color};margin-bottom:6px;display:flex;justify-content:space-between"><span>${title}</span><span style="background:var(--bg-surface);border-radius:10px;padding:0 6px;color:${over?'#f87171':'var(--text-muted)'}">${items.length}</span></div>
      <div style="display:flex;flex-direction:column;gap:4px;background:var(--bg-surface);border-radius:6px;padding:6px;min-height:80px">${cards||'<div style="font-size:9px;color:var(--text-muted);text-align:center;padding:20px">Empty</div>'}</div>
      ${items.length>8?`<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:4px">+${items.length-8} more</div>`:''}
    </div>`;
  };
  const d=document.createElement('div');d.id='flow-board-float';
  d.innerHTML=`<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:70vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:600;color:var(--text-primary)">Flow Board</span><span onclick="document.getElementById('flow-board-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:18px">x</span></div>
    <div style="display:flex;gap:8px;overflow-x:auto">
      ${renderCol('To Do',cols.todo,'#6b7280')}
      ${renderCol('In Progress',cols.inProgress,'#22d3ee',5)}
      ${renderCol('Blocked',cols.review,'#f87171')}
      ${renderCol('Done',cols.done,'#4ade80')}
    </div>
  </div>`;
  document.body.appendChild(d);
}
function showQuickEmojiPicker(){
  let ex=document.getElementById('emoji-picker-float');if(ex){ex.remove();return;}
  const categories={
    'Smileys':['grinning','joy','heart_eyes','thinking','sunglasses','fire','sparkles','rocket','star','zap','100','thumbsup','wave','clap','muscle'],
    'Objects':['laptop','keyboard','books','pencil','bulb','gear','wrench','hammer','package','link','lock','key','bell','clock','calendar'],
    'Nature':['sun','moon','cloud','rainbow','snowflake','tree','flower','leaf','ocean','mountain','earth','tornado','lightning','comet','star2'],
    'Arrows':['arrow_right','arrow_left','arrow_up','arrow_down','arrows_clockwise','fast_forward','rewind','top','end','check','x','warning','info','question','exclamation']
  };
  const emojiMap={grinning:'😀',joy:'😂',heart_eyes:'😍',thinking:'🤔',sunglasses:'😎',fire:'🔥',sparkles:'✨',rocket:'🚀',star:'⭐',zap:'⚡',100:'💯',thumbsup:'👍',wave:'👋',clap:'👏',muscle:'💪',laptop:'💻',keyboard:'⌨️',books:'📚',pencil:'✏️',bulb:'💡',gear:'⚙️',wrench:'🔧',hammer:'🔨',package:'📦',link:'🔗',lock:'🔒',key:'🔑',bell:'🔔',clock:'🕐',calendar:'📅',sun:'☀️',moon:'🌙',cloud:'☁️',rainbow:'🌈',snowflake:'❄️',tree:'🌲',flower:'🌸',leaf:'🍃',ocean:'🌊',mountain:'⛰️',earth:'🌍',tornado:'🌪️',lightning:'⚡',comet:'☄️',star2:'🌟',arrow_right:'→',arrow_left:'←',arrow_up:'↑',arrow_down:'↓',arrows_clockwise:'🔄',fast_forward:'⏩',rewind:'⏪',top:'🔝',end:'🔚',check:'✅',x:'❌',warning:'⚠️',info:'ℹ️',question:'❓',exclamation:'❗'};
  let sel='Smileys',recent=[];
  const d=document.createElement('div');d.id='emoji-picker-float';
  const rend=()=>{
    const tabs=Object.keys(categories).map(k=>`<span onclick="window._emojiTab('${k}')" style="padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px;${k===sel?'background:var(--accent);color:#000':'color:var(--text-muted)'}">${k}</span>`).join('');
    const emojis=categories[sel].map(e=>`<span onclick="navigator.clipboard.writeText('${emojiMap[e]||e}');window._emojiRecent('${e}')" style="font-size:22px;cursor:pointer;padding:4px;border-radius:4px;display:inline-block" title="${e}">${emojiMap[e]||e}</span>`).join('');
    const recentHtml=recent.length?recent.map(e=>`<span onclick="navigator.clipboard.writeText('${emojiMap[e]||e}')" style="font-size:18px;cursor:pointer;padding:2px" title="${e}">${emojiMap[e]||e}</span>`).join(''):'';
    d.innerHTML=`<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);width:280px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:600;font-size:12px;color:var(--text-primary)">Emoji Picker</span><span onclick="document.getElementById('emoji-picker-float').remove()" style="cursor:pointer;color:var(--text-muted);font-size:14px">x</span></div>
      ${recent.length?`<div style="margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:4px"><div style="font-size:9px;color:var(--text-muted);margin-bottom:2px">Recent</div>${recentHtml}</div>`:''}
      <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px">${tabs}</div>
      <div style="display:flex;flex-wrap:wrap;gap:2px">${emojis}</div>
      <div style="margin-top:6px;font-size:9px;color:var(--text-muted)">Click to copy</div>
    </div>`;
  };
  window._emojiTab=(k)=>{sel=k;rend();};
  window._emojiRecent=(e)=>{recent=recent.filter(r=>r!==e);recent.unshift(e);if(recent.length>10)recent.length=10;rend();};
  document.body.appendChild(d);rend();
}
function showYarnCommandRef(){
  const d=document.createElement('div');d.id='yarn-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Dependencies':['yarn add <pkg>','yarn add -D <pkg>','yarn remove <pkg>','yarn upgrade','yarn upgrade-interactive'],
    'Scripts':['yarn start','yarn build','yarn test','yarn run <script>','yarn dlx <pkg>'],
    'Workspace':['yarn workspaces list','yarn workspace <name> add <pkg>','yarn workspace <name> run <cmd>','yarn workspaces foreach run build'],
    'Info':['yarn info <pkg>','yarn why <pkg>','yarn list','yarn config list','yarn --version'],
    'Cache':['yarn cache clean','yarn cache list','yarn cache dir'],
    'Publishing':['yarn pack','yarn publish','yarn npm publish','yarn version patch','yarn version minor']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Yarn Reference</h3><button onclick="document.getElementById(\'yarn-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskVelocityTrend(){
  const d=document.createElement('div');d.id='velocity-trend-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const weeks={};const now=new Date();
  tasks.forEach(t=>{
    if(t.status==='done'&&t.updatedAt){
      const d2=new Date(t.updatedAt);const wk=Math.floor((now-d2)/(7*86400000));
      if(wk<8){const label='W-'+wk;weeks[label]=(weeks[label]||0)+1;}
    }
  });
  const labels=[];const vals=[];
  for(let i=7;i>=0;i--){const l='W-'+i;labels.push(i===0?'This Wk':i===1?'Last Wk':i+'w ago');vals.push(weeks[l]||0);}
  const mx=Math.max(...vals,1);
  let svg='<svg width="500" height="200" viewBox="0 0 500 200">';
  svg+='<rect width="500" height="200" fill="var(--bg-surface)" rx="8"/>';
  const pts=vals.map((v,i)=>{const x=30+i*(460/7);const y=180-((v/mx)*150);return x+','+y;}).join(' ');
  svg+='<polyline points="'+pts+'" fill="none" stroke="#4ade80" stroke-width="2"/>';
  vals.forEach((v,i)=>{
    const x=30+i*(460/7);const y=180-((v/mx)*150);
    svg+='<circle cx="'+x+'" cy="'+y+'" r="4" fill="#4ade80"/>';
    svg+='<text x="'+x+'" y="195" text-anchor="middle" fill="var(--text-muted)" font-size="9">'+labels[i]+'</text>';
    if(v>0)svg+='<text x="'+x+'" y="'+(y-8)+'" text-anchor="middle" fill="var(--text-secondary)" font-size="10">'+v+'</text>';
  });
  svg+='</svg>';
  const total=vals.reduce((a,b)=>a+b,0);const avg=(total/8).toFixed(1);
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Velocity Trend</h3><button onclick="document.getElementById(\'velocity-trend-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:16px;margin-bottom:14px"><div style="background:var(--bg-surface);padding:8px 14px;border-radius:6px;text-align:center"><div style="font-size:20px;color:#4ade80;font-weight:700">'+total+'</div><div style="font-size:10px;color:var(--text-muted)">8-wk total</div></div>';
  html+='<div style="background:var(--bg-surface);padding:8px 14px;border-radius:6px;text-align:center"><div style="font-size:20px;color:#4ade80;font-weight:700">'+avg+'</div><div style="font-size:10px;color:var(--text-muted)">avg/week</div></div>';
  html+='<div style="background:var(--bg-surface);padding:8px 14px;border-radius:6px;text-align:center"><div style="font-size:20px;color:#4ade80;font-weight:700">'+(vals[7]||0)+'</div><div style="font-size:10px;color:var(--text-muted)">this week</div></div></div>';
  html+=svg;
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickUnitConverter(){
  const d=document.createElement('div');d.id='unit-converter-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  const cats={
    'Length':[{n:'km',f:1000},{n:'m',f:1},{n:'cm',f:0.01},{n:'in',f:0.0254},{n:'ft',f:0.3048},{n:'mi',f:1609.34}],
    'Weight':[{n:'kg',f:1},{n:'g',f:0.001},{n:'lb',f:0.453592},{n:'oz',f:0.0283495}],
    'Temperature':[{n:'C',t:'c'},{n:'F',t:'f'},{n:'K',t:'k'}]
  };
  let selCat='Length';
  function rend(){
    let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Unit Converter</h3><button onclick="document.getElementById(\'unit-converter-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
    html+='<div style="display:flex;gap:4px;margin-bottom:10px">';
    Object.keys(cats).forEach(c=>{
      html+='<button onclick="window._ucCat=\''+c+'\';window._ucRend()" style="padding:4px 10px;border-radius:4px;border:1px solid '+(selCat===c?'#4ade80':'var(--border)')+';background:'+(selCat===c?'rgba(74,222,128,0.15)':'var(--bg-surface)')+';color:'+(selCat===c?'#4ade80':'var(--text-secondary)')+';font-size:11px;cursor:pointer">'+c+'</button>';
    });
    html+='</div>';
    html+='<input id="uc-val" type="number" value="1" oninput="window._ucRend()" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:14px;margin-bottom:10px;box-sizing:border-box"/>';
    html+='<select id="uc-from" onchange="window._ucRend()" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:8px">';
    const units=cats[selCat];
    units.forEach(u=>{html+='<option value="'+u.n+'">'+u.n+'</option>';});
    html+='</select>';
    html+='<div id="uc-results" style="font-size:12px"></div>';
    d.innerHTML=html;
    calcResults();
  }
  function calcResults(){
    const valEl=document.getElementById('uc-val');const fromEl=document.getElementById('uc-from');const resEl=document.getElementById('uc-results');
    if(!valEl||!fromEl||!resEl)return;
    const val=parseFloat(valEl.value)||0;const from=fromEl.value;const units=cats[selCat];
    let html='';
    if(selCat==='Temperature'){
      let cVal;
      if(from==='C')cVal=val;else if(from==='F')cVal=(val-32)*5/9;else cVal=val-273.15;
      units.forEach(u=>{
        let r;if(u.n==='C')r=cVal;else if(u.n==='F')r=cVal*9/5+32;else r=cVal+273.15;
        if(u.n!==from)html+='<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text-muted)">'+u.n+'</span><span style="color:var(--text-primary)">'+r.toFixed(2)+'</span></div>';
      });
    } else {
      const fromU=units.find(u=>u.n===from);const baseVal=val*(fromU?fromU.f:1);
      units.forEach(u=>{
        if(u.n!==from){const r=baseVal/u.f;html+='<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text-muted)">'+u.n+'</span><span style="color:var(--text-primary)">'+r.toFixed(4)+'</span></div>';}
      });
    }
    resEl.innerHTML=html;
  }
  window._ucCat=selCat;
  window._ucRend=function(){selCat=window._ucCat||'Length';rend();};
  rend();
  document.body.appendChild(d);
}
function showPnpmCommandRef(){
  const d=document.createElement('div');d.id='pnpm-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Install':['pnpm install','pnpm add <pkg>','pnpm add -D <pkg>','pnpm remove <pkg>','pnpm update','pnpm update --latest'],
    'Scripts':['pnpm run <script>','pnpm start','pnpm test','pnpm build','pnpm exec <cmd>','pnpm dlx <pkg>'],
    'Workspace':['pnpm -r run build','pnpm --filter <pkg> add <dep>','pnpm -r exec -- <cmd>','pnpm --filter <pkg> run test'],
    'Store':['pnpm store status','pnpm store prune','pnpm store path'],
    'Info':['pnpm list','pnpm why <pkg>','pnpm outdated','pnpm audit','pnpm --version']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">pnpm Reference</h3><button onclick="document.getElementById(\'pnpm-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskBlockedReport(){
  const d=document.createElement('div');d.id='blocked-report-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const blocked=tasks.filter(t=>t.blockedBy);
  const overdue=tasks.filter(t=>{if(!t.due)return false;return new Date(t.due)<new Date()&&t.status!=='done';});
  const stale=tasks.filter(t=>{if(!t.updatedAt)return false;return(Date.now()-new Date(t.updatedAt).getTime())>7*86400000;});
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Blocked & At-Risk Report</h3><button onclick="document.getElementById(\'blocked-report-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:12px;margin-bottom:16px">';
  html+='<div style="background:var(--bg-surface);padding:10px 16px;border-radius:6px;text-align:center;flex:1"><div style="font-size:22px;color:#ef4444;font-weight:700">'+blocked.length+'</div><div style="font-size:10px;color:var(--text-muted)">Blocked</div></div>';
  html+='<div style="background:var(--bg-surface);padding:10px 16px;border-radius:6px;text-align:center;flex:1"><div style="font-size:22px;color:#f59e0b;font-weight:700">'+overdue.length+'</div><div style="font-size:10px;color:var(--text-muted)">Overdue</div></div>';
  html+='<div style="background:var(--bg-surface);padding:10px 16px;border-radius:6px;text-align:center;flex:1"><div style="font-size:22px;color:#6366f1;font-weight:700">'+stale.length+'</div><div style="font-size:10px;color:var(--text-muted)">Stale (7d+)</div></div></div>';
  if(blocked.length){
    html+='<div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">Blocked Tasks</div>';
    blocked.forEach(t=>{
      html+='<div style="padding:6px 8px;background:var(--bg-surface);border-radius:4px;margin-bottom:4px;border-left:3px solid #ef4444"><div style="font-size:12px;color:var(--text-primary)">'+esc(t.title)+'</div><div style="font-size:10px;color:var(--text-muted)">Blocked by: '+esc(t.blockedBy)+'</div></div>';
    });
  }
  if(overdue.length){
    html+='<div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin:12px 0 6px">Overdue Tasks</div>';
    overdue.forEach(t=>{
      const days=Math.floor((Date.now()-new Date(t.due).getTime())/86400000);
      html+='<div style="padding:6px 8px;background:var(--bg-surface);border-radius:4px;margin-bottom:4px;border-left:3px solid #f59e0b"><div style="font-size:12px;color:var(--text-primary)">'+esc(t.title)+'</div><div style="font-size:10px;color:var(--text-muted)">'+days+'d overdue</div></div>';
    });
  }
  if(!blocked.length&&!overdue.length&&!stale.length){html+='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">All clear! No blocked or at-risk tasks.</div>';}
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickBmiCalc(){
  const d=document.createElement('div');d.id='bmi-calc-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:260px';
  function rend(){
    let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">BMI Calculator</h3><button onclick="document.getElementById(\'bmi-calc-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
    html+='<div style="margin-bottom:8px"><label style="font-size:10px;color:var(--text-muted)">Weight (kg)</label><input id="bmi-w" type="number" placeholder="70" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px;box-sizing:border-box;margin-top:2px"/></div>';
    html+='<div style="margin-bottom:10px"><label style="font-size:10px;color:var(--text-muted)">Height (cm)</label><input id="bmi-h" type="number" placeholder="175" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px;box-sizing:border-box;margin-top:2px"/></div>';
    html+='<button onclick="window._calcBmi()" style="width:100%;padding:8px;background:#4ade80;color:#000;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px">Calculate</button>';
    html+='<div id="bmi-result" style="margin-top:10px"></div>';
    d.innerHTML=html;
  }
  window._calcBmi=function(){
    const w=parseFloat(document.getElementById('bmi-w').value);const h=parseFloat(document.getElementById('bmi-h').value);
    const resEl=document.getElementById('bmi-result');if(!w||!h||!resEl)return;
    const hm=h/100;const bmi=(w/(hm*hm)).toFixed(1);
    let cat,col;
    if(bmi<18.5){cat='Underweight';col='#60a5fa';}else if(bmi<25){cat='Normal';col='#4ade80';}else if(bmi<30){cat='Overweight';col='#f59e0b';}else{cat='Obese';col='#ef4444';}
    resEl.innerHTML='<div style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px"><div style="font-size:28px;color:'+col+';font-weight:700">'+bmi+'</div><div style="font-size:12px;color:'+col+'">'+cat+'</div></div>';
  };
  rend();document.body.appendChild(d);
}
function showDenoCommandRef(){
  const d=document.createElement('div');d.id='deno-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Run':['deno run <file>','deno run --allow-net <file>','deno run --allow-read <file>','deno run --allow-all <file>','deno task <name>'],
    'Tools':['deno fmt','deno lint','deno test','deno bench','deno check <file>','deno doc <file>'],
    'Manage':['deno install <url>','deno uninstall <name>','deno compile <file>','deno info <url>','deno upgrade'],
    'Permissions':['--allow-net','--allow-read','--allow-write','--allow-env','--allow-run','--allow-ffi','--allow-sys'],
    'Config':['deno.json','deno.lock','import_map.json','deno init','deno add <pkg>']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Deno Reference</h3><button onclick="document.getElementById(\'deno-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskCompletionCalendar(){
  const d=document.createElement('div');d.id='completion-cal-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status==='done'&&t.updatedAt);
  const dayCounts={};
  tasks.forEach(t=>{const day=new Date(t.updatedAt).toISOString().split('T')[0];dayCounts[day]=(dayCounts[day]||0)+1;});
  const today=new Date();const startDate=new Date(today);startDate.setDate(startDate.getDate()-90);
  const mx=Math.max(...Object.values(dayCounts),1);
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Completion Calendar (90 days)</h3><button onclick="document.getElementById(\'completion-cal-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  const weeks=Math.ceil(91/7);
  let svg='<svg width="'+(weeks*14+20)+'" height="120" viewBox="0 0 '+(weeks*14+20)+' 120">';
  const dayLabels=['Mon','','Wed','','Fri','','Sun'];
  dayLabels.forEach((l,i)=>{if(l)svg+='<text x="0" y="'+(20+i*14+10)+'" fill="var(--text-muted)" font-size="9">'+l+'</text>';});
  const cursor=new Date(startDate);
  let wk=0;
  while(cursor<=today){
    const dow=cursor.getDay();const adjDow=(dow===0?6:dow-1);
    const key=cursor.toISOString().split('T')[0];const cnt=dayCounts[key]||0;
    const intensity=cnt>0?Math.max(0.2,cnt/mx):0;
    const x=20+wk*14;const y=20+adjDow*14;
    svg+='<rect x="'+x+'" y="'+y+'" width="12" height="12" rx="2" fill="'+(cnt>0?'rgba(74,222,128,'+intensity+')':'var(--bg-surface)')+'" stroke="var(--border)" stroke-width="0.5"><title>'+key+': '+cnt+' tasks</title></rect>';
    if(adjDow===6)wk++;
    cursor.setDate(cursor.getDate()+1);
  }
  svg+='</svg>';
  const totalDone=tasks.length;const daysActive=Object.keys(dayCounts).length;
  html+='<div style="display:flex;gap:12px;margin-bottom:14px"><div style="background:var(--bg-surface);padding:8px 14px;border-radius:6px;text-align:center"><div style="font-size:18px;color:#4ade80;font-weight:700">'+totalDone+'</div><div style="font-size:10px;color:var(--text-muted)">completed</div></div>';
  html+='<div style="background:var(--bg-surface);padding:8px 14px;border-radius:6px;text-align:center"><div style="font-size:18px;color:#4ade80;font-weight:700">'+daysActive+'</div><div style="font-size:10px;color:var(--text-muted)">active days</div></div></div>';
  html+='<div style="overflow-x:auto">'+svg+'</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickPercentageCalc(){
  const d=document.createElement('div');d.id='pct-calc-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:260px';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Percentage Calculator</h3><button onclick="document.getElementById(\'pct-calc-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:10px;font-size:11px;color:var(--text-muted)">What is X% of Y?</div>';
  html+='<div style="display:flex;gap:6px;margin-bottom:8px"><input id="pct-x" type="number" placeholder="X" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px"/><span style="color:var(--text-muted);padding-top:6px">% of</span><input id="pct-y" type="number" placeholder="Y" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px"/></div>';
  html+='<div id="pct-result" style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px;margin-bottom:10px;font-size:22px;color:#4ade80;font-weight:700">—</div>';
  html+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px">X is what % of Y?</div>';
  html+='<div style="display:flex;gap:6px;margin-bottom:8px"><input id="pct-a" type="number" placeholder="X" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px"/><span style="color:var(--text-muted);padding-top:6px">of</span><input id="pct-b" type="number" placeholder="Y" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px"/></div>';
  html+='<div id="pct-result2" style="text-align:center;padding:10px;background:var(--bg-surface);border-radius:6px;font-size:22px;color:#4ade80;font-weight:700">—</div>';
  d.innerHTML=html;document.body.appendChild(d);
  document.getElementById('pct-x').addEventListener('input',function(){const x=parseFloat(this.value);const y=parseFloat(document.getElementById('pct-y').value);if(!isNaN(x)&&!isNaN(y))document.getElementById('pct-result').textContent=(x/100*y).toFixed(2);});
  document.getElementById('pct-y').addEventListener('input',function(){const y=parseFloat(this.value);const x=parseFloat(document.getElementById('pct-x').value);if(!isNaN(x)&&!isNaN(y))document.getElementById('pct-result').textContent=(x/100*y).toFixed(2);});
  document.getElementById('pct-a').addEventListener('input',function(){const a=parseFloat(this.value);const b=parseFloat(document.getElementById('pct-b').value);if(!isNaN(a)&&!isNaN(b)&&b!==0)document.getElementById('pct-result2').textContent=(a/b*100).toFixed(2)+'%';});
  document.getElementById('pct-b').addEventListener('input',function(){const b=parseFloat(this.value);const a=parseFloat(document.getElementById('pct-a').value);if(!isNaN(a)&&!isNaN(b)&&b!==0)document.getElementById('pct-result2').textContent=(a/b*100).toFixed(2)+'%';});
}
function showBunCommandRef(){
  const d=document.createElement('div');d.id='bun-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Run':['bun run <file>','bun run <script>','bun --watch <file>','bun --hot <file>','bunx <pkg>'],
    'Install':['bun install','bun add <pkg>','bun add -d <pkg>','bun remove <pkg>','bun update'],
    'Create':['bun init','bun create <template>','bun create vite','bun create next-app'],
    'Test':['bun test','bun test --watch','bun test --coverage','bun test <pattern>'],
    'Build':['bun build <file>','bun build --outdir <dir>','bun build --minify','bun build --target node'],
    'Other':['bun --version','bun upgrade','bun pm ls','bun pm cache','bun repl']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Bun Reference</h3><button onclick="document.getElementById(\'bun-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskEffortDistribution(){
  const d=document.createElement('div');d.id='effort-dist-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.estimate);
  const buckets={'< 30m':0,'30m-1h':0,'1h-2h':0,'2h-4h':0,'4h+':0};
  tasks.forEach(t=>{
    const e=t.estimate.toLowerCase();let mins=0;
    if(e.includes('h')){const h=parseFloat(e);mins=h*60;}else if(e.includes('m')){mins=parseFloat(e);}else{mins=parseFloat(e);}
    if(isNaN(mins))return;
    if(mins<30)buckets['< 30m']++;else if(mins<60)buckets['30m-1h']++;else if(mins<120)buckets['1h-2h']++;else if(mins<240)buckets['2h-4h']++;else buckets['4h+']++;
  });
  const labels=Object.keys(buckets);const vals=Object.values(buckets);const mx=Math.max(...vals,1);
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Effort Distribution</h3><button onclick="document.getElementById(\'effort-dist-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">'+tasks.length+' tasks with estimates</div>';
  let svg='<svg width="420" height="180" viewBox="0 0 420 180">';
  const bw=60;const gap=20;
  labels.forEach((l,i)=>{
    const x=20+i*(bw+gap);const h=(vals[i]/mx)*130;const y=150-h;
    svg+='<rect x="'+x+'" y="'+y+'" width="'+bw+'" height="'+h+'" fill="#4ade80" rx="4" opacity="0.8"/>';
    svg+='<text x="'+(x+bw/2)+'" y="168" text-anchor="middle" fill="var(--text-muted)" font-size="9">'+l+'</text>';
    svg+='<text x="'+(x+bw/2)+'" y="'+(y-5)+'" text-anchor="middle" fill="var(--text-secondary)" font-size="11">'+vals[i]+'</text>';
  });
  svg+='</svg>';
  html+=svg;
  if(!tasks.length)html+='<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:12px">No tasks with estimates yet. Add estimates like "30m", "2h" to tasks.</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickTimeZoneConverter(){
  const d=document.createElement('div');d.id='tz-converter-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:300px';
  const zones=[
    {name:'Local',tz:Intl.DateTimeFormat().resolvedOptions().timeZone},
    {name:'UTC',tz:'UTC'},
    {name:'New York',tz:'America/New_York'},
    {name:'London',tz:'Europe/London'},
    {name:'Tokyo',tz:'Asia/Tokyo'},
    {name:'Sydney',tz:'Australia/Sydney'},
    {name:'Dubai',tz:'Asia/Dubai'},
    {name:'Los Angeles',tz:'America/Los_Angeles'}
  ];
  function rend(){
    const now=new Date();
    let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Time Zones</h3><button onclick="document.getElementById(\'tz-converter-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
    zones.forEach(z=>{
      const t=now.toLocaleTimeString('en-US',{timeZone:z.tz,hour:'2-digit',minute:'2-digit',hour12:true});
      const dt=now.toLocaleDateString('en-US',{timeZone:z.tz,weekday:'short',month:'short',day:'numeric'});
      const hr=parseInt(now.toLocaleTimeString('en-US',{timeZone:z.tz,hour:'numeric',hour12:false}));
      const isNight=hr<6||hr>=21;
      html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">';
      html+='<div><div style="font-size:12px;color:var(--text-primary)">'+(isNight?'&#9790; ':'')+''+z.name+'</div><div style="font-size:9px;color:var(--text-muted)">'+dt+'</div></div>';
      html+='<div style="font-size:14px;color:#4ade80;font-weight:600;font-family:monospace">'+t+'</div></div>';
    });
    d.innerHTML=html;
  }
  rend();document.body.appendChild(d);
  const iv=setInterval(()=>{if(!document.getElementById('tz-converter-panel')){clearInterval(iv);return;}rend();},30000);
}
function showCurlCommandRef(){
  const d=document.createElement('div');d.id='curl-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Basic':['curl <url>','curl -o file.html <url>','curl -O <url>','curl -L <url>','curl -v <url>','curl -s <url>'],
    'HTTP Methods':['curl -X GET <url>','curl -X POST <url>','curl -X PUT <url>','curl -X DELETE <url>','curl -X PATCH <url>'],
    'Headers & Data':['curl -H "Content-Type: application/json" <url>','curl -H "Authorization: Bearer TOKEN" <url>','curl -d \'{"key":"val"}\' <url>','curl -F "file=@path" <url>'],
    'Auth':['curl -u user:pass <url>','curl --negotiate -u : <url>','curl -b cookies.txt <url>','curl -c cookies.txt <url>'],
    'Debug':['curl -w "%{http_code}" <url>','curl -w "%{time_total}" <url>','curl --trace-ascii - <url>','curl -I <url>'],
    'SSL':['curl -k <url>','curl --cacert ca.pem <url>','curl --cert client.pem <url>','curl --key key.pem <url>']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">curl Reference</h3><button onclick="document.getElementById(\'curl-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px;word-break:break-all" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskProjectBreakdown(){
  const d=document.createElement('div');d.id='project-breakdown-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const projects=(S.projects||[]);
  const byProject={};
  tasks.forEach(t=>{
    const pid=t.projectId||'none';
    if(!byProject[pid])byProject[pid]={total:0,done:0,inProgress:0,todo:0,overdue:0};
    byProject[pid].total++;
    if(t.status==='done')byProject[pid].done++;
    else if(t.status==='in-progress')byProject[pid].inProgress++;
    else byProject[pid].todo++;
    if(t.due&&new Date(t.due)<new Date()&&t.status!=='done')byProject[pid].overdue++;
  });
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Project Breakdown</h3><button onclick="document.getElementById(\'project-breakdown-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  const entries=Object.entries(byProject).sort((a,b)=>b[1].total-a[1].total);
  entries.forEach(([pid,data])=>{
    const proj=projects.find(p=>p.id===pid);const name=proj?proj.name:'No Project';
    const pct=data.total>0?Math.round(data.done/data.total*100):0;
    html+='<div style="background:var(--bg-surface);border-radius:8px;padding:12px;margin-bottom:8px">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;color:var(--text-primary);font-weight:600">'+esc(name)+'</span><span style="font-size:11px;color:#4ade80">'+pct+'%</span></div>';
    html+='<div style="background:var(--bg-base);border-radius:4px;height:6px;margin-bottom:8px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:#4ade80;border-radius:4px;transition:width 0.3s"></div></div>';
    html+='<div style="display:flex;gap:12px;font-size:10px">';
    html+='<span style="color:var(--text-muted)">Total: <span style="color:var(--text-primary)">'+data.total+'</span></span>';
    html+='<span style="color:var(--text-muted)">Done: <span style="color:#4ade80">'+data.done+'</span></span>';
    html+='<span style="color:var(--text-muted)">WIP: <span style="color:#3b82f6">'+data.inProgress+'</span></span>';
    html+='<span style="color:var(--text-muted)">To Do: <span style="color:var(--text-secondary)">'+data.todo+'</span></span>';
    if(data.overdue)html+='<span style="color:#ef4444">'+data.overdue+' overdue</span>';
    html+='</div></div>';
  });
  if(!entries.length)html+='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">No tasks found.</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickDateDiff(){
  const d=document.createElement('div');d.id='date-diff-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  const today=new Date().toISOString().split('T')[0];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Date Difference</h3><button onclick="document.getElementById(\'date-diff-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:8px"><label style="font-size:10px;color:var(--text-muted)">From</label><input id="dd-from" type="date" value="'+today+'" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;box-sizing:border-box;margin-top:2px"/></div>';
  html+='<div style="margin-bottom:10px"><label style="font-size:10px;color:var(--text-muted)">To</label><input id="dd-to" type="date" value="'+today+'" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;box-sizing:border-box;margin-top:2px"/></div>';
  html+='<div id="dd-result" style="background:var(--bg-surface);border-radius:6px;padding:12px;text-align:center"><div style="font-size:24px;color:#4ade80;font-weight:700">0</div><div style="font-size:11px;color:var(--text-muted)">days</div></div>';
  html+='<div id="dd-detail" style="margin-top:8px;font-size:11px;color:var(--text-muted);text-align:center"></div>';
  d.innerHTML=html;document.body.appendChild(d);
  function calc(){
    const from=new Date(document.getElementById('dd-from').value);const to=new Date(document.getElementById('dd-to').value);
    if(isNaN(from)||isNaN(to))return;
    const diff=Math.abs(to-from);const days=Math.floor(diff/86400000);
    const weeks=Math.floor(days/7);const months=(days/30.44).toFixed(1);const years=(days/365.25).toFixed(2);
    document.getElementById('dd-result').innerHTML='<div style="font-size:24px;color:#4ade80;font-weight:700">'+days+'</div><div style="font-size:11px;color:var(--text-muted)">days</div>';
    document.getElementById('dd-detail').textContent=weeks+' weeks / '+months+' months / '+years+' years';
  }
  document.getElementById('dd-from').addEventListener('change',calc);
  document.getElementById('dd-to').addEventListener('change',calc);
}
function showSshCommandRef(){
  const d=document.createElement('div');d.id='ssh-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Connect':['ssh user@host','ssh -p 2222 user@host','ssh -i key.pem user@host','ssh -v user@host','ssh -J jump@host user@dest'],
    'Keys':['ssh-keygen -t ed25519','ssh-keygen -t rsa -b 4096','ssh-copy-id user@host','ssh-add ~/.ssh/id_ed25519','ssh-add -l'],
    'Transfer':['scp file user@host:path','scp user@host:file .','scp -r dir user@host:path','rsync -avz dir user@host:path'],
    'Tunnels':['ssh -L 8080:localhost:80 user@host','ssh -R 9090:localhost:3000 user@host','ssh -D 1080 user@host','ssh -N -f -L 3306:db:3306 user@host'],
    'Config':['~/.ssh/config','~/.ssh/known_hosts','~/.ssh/authorized_keys','ssh -G host','ssh-keyscan host']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">SSH Reference</h3><button onclick="document.getElementById(\'ssh-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px;word-break:break-all" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskRecurrenceOverview(){
  const d=document.createElement('div');d.id='recurrence-overview-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const recurring=tasks.filter(t=>t.recurrence&&t.recurrence!=='none');
  const byType={daily:0,weekday:0,weekly:0,biweekly:0,monthly:0};
  recurring.forEach(t=>{if(byType[t.recurrence]!==undefined)byType[t.recurrence]++;});
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Recurring Tasks</h3><button onclick="document.getElementById(\'recurrence-overview-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">';
  Object.entries(byType).forEach(([type,count])=>{
    html+='<div style="background:var(--bg-surface);padding:8px 14px;border-radius:6px;text-align:center"><div style="font-size:18px;color:#4ade80;font-weight:700">'+count+'</div><div style="font-size:10px;color:var(--text-muted)">'+type+'</div></div>';
  });
  html+='</div>';
  if(recurring.length){
    recurring.forEach(t=>{
      const priorityColors={p0:'#ef4444',p1:'#f59e0b',p2:'#3b82f6',p3:'#6b7280'};
      const col=priorityColors[t.priority]||'#6b7280';
      html+='<div style="padding:8px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px;border-left:3px solid '+col+'"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;color:var(--text-primary)">'+esc(t.title)+'</span><span style="font-size:10px;color:#4ade80;background:rgba(74,222,128,0.1);padding:2px 6px;border-radius:3px">'+t.recurrence+'</span></div>';
      if(t.due)html+='<div style="font-size:10px;color:var(--text-muted);margin-top:2px">Next: '+t.due+'</div>';
      html+='</div>';
    });
  } else {
    html+='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px">No recurring tasks. Set recurrence on a task to see it here.</div>';
  }
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickBaseConverter(){
  const d=document.createElement('div');d.id='base-converter-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:300px';
  function rend(){
    let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Base Converter</h3><button onclick="document.getElementById(\'base-converter-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
    html+='<input id="bc-input" type="text" placeholder="Enter number..." oninput="window._bcConvert()" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:14px;margin-bottom:8px;box-sizing:border-box;font-family:monospace"/>';
    html+='<select id="bc-base" onchange="window._bcConvert()" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;margin-bottom:10px">';
    html+='<option value="10">Decimal (base 10)</option><option value="16">Hexadecimal (base 16)</option><option value="2">Binary (base 2)</option><option value="8">Octal (base 8)</option></select>';
    html+='<div id="bc-results"></div>';
    d.innerHTML=html;
  }
  window._bcConvert=function(){
    const input=document.getElementById('bc-input');const baseEl=document.getElementById('bc-base');const resEl=document.getElementById('bc-results');
    if(!input||!baseEl||!resEl)return;
    const base=parseInt(baseEl.value);const val=parseInt(input.value,base);
    if(isNaN(val)){resEl.innerHTML='<div style="color:var(--text-muted);font-size:11px;text-align:center">Invalid input</div>';return;}
    const conversions=[
      {name:'Decimal',val:val.toString(10)},
      {name:'Hex',val:'0x'+val.toString(16).toUpperCase()},
      {name:'Binary',val:'0b'+val.toString(2)},
      {name:'Octal',val:'0o'+val.toString(8)}
    ];
    let html='';
    conversions.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.val+'\');this.querySelector(\'.bc-copied\').style.display=\'inline\';setTimeout(()=>this.querySelector(\'.bc-copied\').style.display=\'none\',600)" style="display:flex;justify-content:space-between;padding:6px 8px;border-radius:4px;cursor:pointer;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'"><span style="font-size:11px;color:var(--text-muted)">'+c.name+'</span><span style="font-family:monospace;font-size:12px;color:var(--text-primary)">'+c.val+' <span class="bc-copied" style="display:none;color:#4ade80;font-size:10px">copied</span></span></div>';
    });
    resEl.innerHTML=html;
  };
  rend();document.body.appendChild(d);
}
function showAwsCliRef(){
  const d=document.createElement('div');d.id='aws-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'S3':['aws s3 ls','aws s3 cp file s3://bucket/','aws s3 sync dir s3://bucket/','aws s3 rm s3://bucket/file','aws s3 mb s3://bucket'],
    'EC2':['aws ec2 describe-instances','aws ec2 start-instances --instance-ids i-xxx','aws ec2 stop-instances --instance-ids i-xxx','aws ec2 describe-security-groups'],
    'Lambda':['aws lambda list-functions','aws lambda invoke --function-name fn out.json','aws lambda update-function-code --function-name fn --zip-file fileb://code.zip'],
    'IAM':['aws iam list-users','aws iam create-user --user-name name','aws iam list-roles','aws sts get-caller-identity'],
    'CloudFormation':['aws cloudformation list-stacks','aws cloudformation deploy --template-file tpl.yaml --stack-name name','aws cloudformation describe-stacks'],
    'General':['aws configure','aws configure list','aws --version','aws sts get-caller-identity']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">AWS CLI Reference</h3><button onclick="document.getElementById(\'aws-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px;word-break:break-all" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskCreatedVsDone(){
  const d=document.createElement('div');d.id='created-vs-done-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const created={};const done={};
  tasks.forEach(t=>{
    if(t.createdAt){const d2=new Date(t.createdAt).toISOString().split('T')[0].substring(0,7);created[d2]=(created[d2]||0)+1;}
    if(t.status==='done'&&t.updatedAt){const d2=new Date(t.updatedAt).toISOString().split('T')[0].substring(0,7);done[d2]=(done[d2]||0)+1;}
  });
  const allMonths=new Set([...Object.keys(created),...Object.keys(done)]);
  const sorted=[...allMonths].sort().slice(-6);
  const cVals=sorted.map(m=>created[m]||0);const dVals=sorted.map(m=>done[m]||0);
  const mx=Math.max(...cVals,...dVals,1);
  let svg='<svg width="500" height="200" viewBox="0 0 500 200">';
  svg+='<rect width="500" height="200" fill="var(--bg-surface)" rx="8"/>';
  const bw=30;const gap=50;
  sorted.forEach((m,i)=>{
    const x=40+i*(bw*2+gap);const ch=(cVals[i]/mx)*140;const dh=(dVals[i]/mx)*140;
    svg+='<rect x="'+x+'" y="'+(170-ch)+'" width="'+bw+'" height="'+ch+'" fill="#3b82f6" rx="3" opacity="0.8"/>';
    svg+='<rect x="'+(x+bw+2)+'" y="'+(170-dh)+'" width="'+bw+'" height="'+dh+'" fill="#4ade80" rx="3" opacity="0.8"/>';
    if(cVals[i])svg+='<text x="'+(x+bw/2)+'" y="'+(165-ch)+'" text-anchor="middle" fill="#3b82f6" font-size="10">'+cVals[i]+'</text>';
    if(dVals[i])svg+='<text x="'+(x+bw+2+bw/2)+'" y="'+(165-dh)+'" text-anchor="middle" fill="#4ade80" font-size="10">'+dVals[i]+'</text>';
    svg+='<text x="'+(x+bw+1)+'" y="188" text-anchor="middle" fill="var(--text-muted)" font-size="9">'+m.substring(5)+'</text>';
  });
  svg+='</svg>';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Created vs Done</h3><button onclick="document.getElementById(\'created-vs-done-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:16px;margin-bottom:12px"><div style="display:flex;align-items:center;gap:4px"><div style="width:12px;height:12px;background:#3b82f6;border-radius:2px"></div><span style="font-size:11px;color:var(--text-muted)">Created</span></div>';
  html+='<div style="display:flex;align-items:center;gap:4px"><div style="width:12px;height:12px;background:#4ade80;border-radius:2px"></div><span style="font-size:11px;color:var(--text-muted)">Done</span></div></div>';
  html+=svg;
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickColorConverter(){
  const d=document.createElement('div');d.id='color-converter-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Color Converter</h3><button onclick="document.getElementById(\'color-converter-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:8px;margin-bottom:10px"><input id="cc-color" type="color" value="#4ade80" oninput="window._ccUpdate(this.value)" style="width:50px;height:40px;border:none;background:none;cursor:pointer"/>';
  html+='<input id="cc-hex" type="text" value="#4ade80" oninput="window._ccFromHex(this.value)" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px;font-family:monospace"/></div>';
  html+='<div id="cc-results"></div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._ccUpdate=function(hex){
    document.getElementById('cc-hex').value=hex;document.getElementById('cc-color').value=hex;
    const r=parseInt(hex.slice(1,3),16);const g=parseInt(hex.slice(3,5),16);const b=parseInt(hex.slice(5,7),16);
    const max=Math.max(r,g,b)/255;const min=Math.min(r,g,b)/255;const l=(max+min)/2;
    let h=0,s=0;
    if(max!==min){const d2=max-min;s=l>0.5?d2/(2-max-min):d2/(max+min);
      if(max===r/255)h=(g/255-b/255)/d2+(g<b?6:0);else if(max===g/255)h=(b/255-r/255)/d2+2;else h=(r/255-g/255)/d2+4;h*=60;}
    const resEl=document.getElementById('cc-results');
    let rhtml='';
    const vals=[
      {name:'HEX',val:hex},
      {name:'RGB',val:'rgb('+r+', '+g+', '+b+')'},
      {name:'HSL',val:'hsl('+Math.round(h)+', '+Math.round(s*100)+'%, '+Math.round(l*100)+'%)'},
      {name:'RGBA',val:'rgba('+r+', '+g+', '+b+', 1)'}
    ];
    vals.forEach(v=>{
      rhtml+='<div onclick="navigator.clipboard.writeText(\''+v.val+'\');this.style.borderColor=\'#4ade80\';setTimeout(()=>this.style.borderColor=\'var(--border)\',600)" style="display:flex;justify-content:space-between;padding:6px 8px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;cursor:pointer"><span style="font-size:10px;color:var(--text-muted)">'+v.name+'</span><span style="font-size:11px;color:var(--text-primary);font-family:monospace">'+v.val+'</span></div>';
    });
    resEl.innerHTML=rhtml;
  };
  window._ccFromHex=function(val){if(/^#[0-9a-fA-F]{6}$/.test(val))window._ccUpdate(val);};
  window._ccUpdate('#4ade80');
}
function showVercelCliRef(){
  const d=document.createElement('div');d.id='vercel-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Deploy':['vercel','vercel --prod','vercel deploy','vercel deploy --prebuilt','vercel build'],
    'Projects':['vercel project ls','vercel project add','vercel project rm <name>','vercel link','vercel inspect <url>'],
    'Env':['vercel env ls','vercel env add <key>','vercel env rm <key>','vercel env pull .env.local'],
    'Domains':['vercel domains ls','vercel domains add <domain>','vercel domains rm <domain>','vercel dns ls'],
    'Dev':['vercel dev','vercel dev --listen 3001','vercel logs <url>','vercel whoami','vercel login'],
    'Other':['vercel --version','vercel help','vercel switch','vercel teams ls','vercel certs ls']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Vercel CLI Reference</h3><button onclick="document.getElementById(\'vercel-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskWipAge(){
  const d=document.createElement('div');d.id='wip-age-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status==='in-progress');
  const now=Date.now();
  const sorted=tasks.map(t=>{
    const created=t.createdAt?new Date(t.createdAt).getTime():now;
    const age=Math.floor((now-created)/86400000);
    return{...t,age};
  }).sort((a,b)=>b.age-a.age);
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">WIP Age Report</h3><button onclick="document.getElementById(\'wip-age-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">'+sorted.length+' tasks in progress</div>';
  if(sorted.length){
    const avgAge=sorted.length?Math.round(sorted.reduce((s,t)=>s+t.age,0)/sorted.length):0;
    html+='<div style="display:flex;gap:12px;margin-bottom:14px"><div style="background:var(--bg-surface);padding:8px 14px;border-radius:6px;text-align:center"><div style="font-size:18px;color:#4ade80;font-weight:700">'+avgAge+'d</div><div style="font-size:10px;color:var(--text-muted)">avg age</div></div>';
    html+='<div style="background:var(--bg-surface);padding:8px 14px;border-radius:6px;text-align:center"><div style="font-size:18px;color:'+(sorted[0].age>14?'#ef4444':'#4ade80')+';font-weight:700">'+sorted[0].age+'d</div><div style="font-size:10px;color:var(--text-muted)">oldest</div></div></div>';
    sorted.forEach(t=>{
      const col=t.age>14?'#ef4444':t.age>7?'#f59e0b':'#4ade80';
      html+='<div style="padding:8px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px;border-left:3px solid '+col+'"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;color:var(--text-primary)">'+esc(t.title)+'</span><span style="font-size:11px;color:'+col+';font-weight:600">'+t.age+'d</span></div></div>';
    });
  } else {
    html+='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px">No tasks in progress.</div>';
  }
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickStringEncoder(){
  const d=document.createElement('div');d.id='string-encoder-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px;max-height:70vh;overflow-y:auto';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">String Encoder</h3><button onclick="document.getElementById(\'string-encoder-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<textarea id="se-input" placeholder="Enter text to encode/decode..." rows="3" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-bottom:8px"></textarea>';
  html+='<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:10px">';
  const ops=['Base64 Enc','Base64 Dec','URL Enc','URL Dec','HTML Enc','HTML Dec'];
  ops.forEach(op=>{
    html+='<button onclick="window._seEncode(\''+op+'\')" style="padding:4px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);font-size:10px;cursor:pointer">'+op+'</button>';
  });
  html+='</div>';
  html+='<div id="se-output" style="padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:11px;color:#4ade80;word-break:break-all;min-height:40px;cursor:pointer" onclick="if(this.textContent)navigator.clipboard.writeText(this.textContent)"></div>';
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:4px;text-align:center">Click output to copy</div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._seEncode=function(op){
    const input=document.getElementById('se-input').value;const out=document.getElementById('se-output');
    try{
      if(op==='Base64 Enc')out.textContent=btoa(input);
      else if(op==='Base64 Dec')out.textContent=atob(input);
      else if(op==='URL Enc')out.textContent=encodeURIComponent(input);
      else if(op==='URL Dec')out.textContent=decodeURIComponent(input);
      else if(op==='HTML Enc'){const t=document.createElement('textarea');t.textContent=input;out.textContent=t.innerHTML;}
      else if(op==='HTML Dec'){const t=document.createElement('textarea');t.innerHTML=input;out.textContent=t.value;}
    }catch(e){out.textContent='Error: '+e.message;}
  };
}
function showGhCliRef(){
  const d=document.createElement('div');d.id='gh-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Repos':['gh repo create','gh repo clone <repo>','gh repo fork <repo>','gh repo view','gh repo list'],
    'PRs':['gh pr create','gh pr list','gh pr view <n>','gh pr checkout <n>','gh pr merge <n>','gh pr diff <n>'],
    'Issues':['gh issue create','gh issue list','gh issue view <n>','gh issue close <n>','gh issue reopen <n>'],
    'Workflow':['gh run list','gh run view <id>','gh run watch <id>','gh workflow list','gh workflow run <name>'],
    'Release':['gh release create <tag>','gh release list','gh release view <tag>','gh release download <tag>'],
    'Other':['gh auth login','gh auth status','gh api repos/<owner>/<repo>','gh gist create <file>','gh codespace list']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">GitHub CLI Reference</h3><button onclick="document.getElementById(\'gh-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskPriorityTrend(){
  const d=document.createElement('div');d.id='priority-trend-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const priorities={p0:0,p1:0,p2:0,p3:0,none:0};
  tasks.forEach(t=>{
    if(priorities[t.priority]!==undefined)priorities[t.priority]++;
    else priorities.none++;
  });
  const total=tasks.length||1;
  const colors={p0:'#ef4444',p1:'#f59e0b',p2:'#3b82f6',p3:'#6b7280',none:'#4b5563'};
  const labels={p0:'Critical',p1:'High',p2:'Medium',p3:'Low',none:'None'};
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Priority Distribution</h3><button onclick="document.getElementById(\'priority-trend-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:16px;font-size:11px;color:var(--text-muted)">'+tasks.length+' open tasks</div>';
  let startAngle=0;
  let svg='<svg width="200" height="200" viewBox="-1 -1 2 2" style="transform:rotate(-90deg);display:block;margin:0 auto 16px">';
  Object.entries(priorities).forEach(([p,count])=>{
    if(count===0)return;
    const pct=count/total;const endAngle=startAngle+pct*2*Math.PI;
    const x1=Math.cos(startAngle);const y1=Math.sin(startAngle);
    const x2=Math.cos(endAngle);const y2=Math.sin(endAngle);
    const large=pct>0.5?1:0;
    svg+='<path d="M 0 0 L '+x1+' '+y1+' A 1 1 0 '+large+' 1 '+x2+' '+y2+' Z" fill="'+colors[p]+'" opacity="0.85"/>';
    startAngle=endAngle;
  });
  svg+='</svg>';
  html+=svg;
  Object.entries(priorities).forEach(([p,count])=>{
    const pct=Math.round(count/total*100);
    html+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><div style="width:12px;height:12px;border-radius:2px;background:'+colors[p]+'"></div><span style="font-size:12px;color:var(--text-primary);flex:1">'+labels[p]+'</span><span style="font-size:12px;color:var(--text-secondary)">'+count+'</span><span style="font-size:11px;color:var(--text-muted)">'+pct+'%</span></div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickIpLookup(){
  const d=document.createElement('div');d.id='ip-lookup-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">IP Lookup</h3><button onclick="document.getElementById(\'ip-lookup-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div id="ip-result" style="text-align:center;padding:16px;color:var(--text-muted);font-size:12px">Loading...</div>';
  d.innerHTML=html;document.body.appendChild(d);
  fetch('https://ipapi.co/json/').then(r=>r.json()).then(data=>{
    const el=document.getElementById('ip-result');if(!el)return;
    let rhtml='';
    const fields=[
      {label:'IP',val:data.ip},
      {label:'City',val:data.city},
      {label:'Region',val:data.region},
      {label:'Country',val:data.country_name},
      {label:'ISP',val:data.org},
      {label:'Timezone',val:data.timezone},
      {label:'Lat/Lng',val:(data.latitude||'')+', '+(data.longitude||'')}
    ];
    fields.forEach(f=>{
      if(f.val)rhtml+='<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)"><span style="font-size:11px;color:var(--text-muted)">'+f.label+'</span><span style="font-size:11px;color:var(--text-primary)">'+f.val+'</span></div>';
    });
    el.innerHTML=rhtml;
  }).catch(()=>{
    const el=document.getElementById('ip-result');if(el)el.innerHTML='<div style="color:#ef4444;font-size:11px">Failed to fetch IP info</div>';
  });
}
function showFlyCliRef(){
  const d=document.createElement('div');d.id='fly-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Apps':['fly launch','fly deploy','fly apps list','fly apps destroy <name>','fly status'],
    'Scale':['fly scale count 2','fly scale vm shared-cpu-1x','fly scale show','fly autoscale set min=1 max=5'],
    'Secrets':['fly secrets set KEY=value','fly secrets list','fly secrets unset KEY'],
    'Logs':['fly logs','fly logs --app <name>','fly monitor'],
    'Machines':['fly machine list','fly machine start <id>','fly machine stop <id>','fly machine destroy <id>'],
    'Database':['fly postgres create','fly postgres connect','fly postgres list','fly proxy 5432']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Fly.io CLI Reference</h3><button onclick="document.getElementById(\'fly-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskDueSoonList(){
  const d=document.createElement('div');d.id='due-soon-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.due&&t.status!=='done');
  const now=new Date();const weekFromNow=new Date(now.getTime()+7*86400000);
  const overdue=[];const today2=[];const thisWeek=[];const later=[];
  tasks.forEach(t=>{
    const due=new Date(t.due);
    if(due<now){overdue.push({...t,dueDate:due});}
    else if(due.toDateString()===now.toDateString()){today2.push({...t,dueDate:due});}
    else if(due<=weekFromNow){thisWeek.push({...t,dueDate:due});}
    else{later.push({...t,dueDate:due});}
  });
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Due Soon</h3><button onclick="document.getElementById(\'due-soon-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:8px;margin-bottom:14px">';
  html+='<div style="background:var(--bg-surface);padding:6px 12px;border-radius:6px;text-align:center"><div style="font-size:16px;color:#ef4444;font-weight:700">'+overdue.length+'</div><div style="font-size:9px;color:var(--text-muted)">Overdue</div></div>';
  html+='<div style="background:var(--bg-surface);padding:6px 12px;border-radius:6px;text-align:center"><div style="font-size:16px;color:#f59e0b;font-weight:700">'+today2.length+'</div><div style="font-size:9px;color:var(--text-muted)">Today</div></div>';
  html+='<div style="background:var(--bg-surface);padding:6px 12px;border-radius:6px;text-align:center"><div style="font-size:16px;color:#3b82f6;font-weight:700">'+thisWeek.length+'</div><div style="font-size:9px;color:var(--text-muted)">This Week</div></div>';
  html+='<div style="background:var(--bg-surface);padding:6px 12px;border-radius:6px;text-align:center"><div style="font-size:16px;color:var(--text-secondary);font-weight:700">'+later.length+'</div><div style="font-size:9px;color:var(--text-muted)">Later</div></div></div>';
  function renderGroup(title,items,color){
    if(!items.length)return'';
    let g='<div style="font-size:11px;color:'+color+';text-transform:uppercase;margin:12px 0 6px">'+title+'</div>';
    items.sort((a,b)=>a.dueDate-b.dueDate).forEach(t=>{
      g+='<div style="padding:6px 8px;background:var(--bg-surface);border-radius:4px;margin-bottom:3px;border-left:3px solid '+color+'"><div style="display:flex;justify-content:space-between"><span style="font-size:12px;color:var(--text-primary)">'+esc(t.title)+'</span><span style="font-size:10px;color:var(--text-muted)">'+t.due+'</span></div></div>';
    });
    return g;
  }
  html+=renderGroup('Overdue',overdue,'#ef4444');
  html+=renderGroup('Today',today2,'#f59e0b');
  html+=renderGroup('This Week',thisWeek,'#3b82f6');
  html+=renderGroup('Later',later,'var(--text-secondary)');
  if(!tasks.length)html+='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px">No tasks with due dates.</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickJsonFormatter(){
  const d=document.createElement('div');d.id='json-fmt-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:80vh;overflow-y:auto';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">JSON Formatter</h3><button onclick="document.getElementById(\'json-fmt-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<textarea id="jf-input" placeholder="Paste JSON here..." rows="6" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-bottom:8px"></textarea>';
  html+='<div style="display:flex;gap:4px;margin-bottom:10px">';
  html+='<button onclick="window._jfFormat(2)" style="padding:5px 12px;background:#4ade80;color:#000;border:none;border-radius:4px;font-size:11px;cursor:pointer;font-weight:600">Pretty</button>';
  html+='<button onclick="window._jfFormat(0)" style="padding:5px 12px;background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);border-radius:4px;font-size:11px;cursor:pointer">Minify</button>';
  html+='<button onclick="window._jfCopy()" style="padding:5px 12px;background:var(--bg-surface);color:var(--text-secondary);border:1px solid var(--border);border-radius:4px;font-size:11px;cursor:pointer">Copy</button></div>';
  html+='<div id="jf-status" style="font-size:10px;margin-bottom:6px;color:var(--text-muted)"></div>';
  html+='<pre id="jf-output" style="padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:#4ade80;font-size:11px;font-family:monospace;white-space:pre-wrap;word-break:break-all;max-height:300px;overflow-y:auto;margin:0"></pre>';
  d.innerHTML=html;document.body.appendChild(d);
  window._jfFormat=function(indent){
    const input=document.getElementById('jf-input').value;const outEl=document.getElementById('jf-output');const statusEl=document.getElementById('jf-status');
    try{const obj=JSON.parse(input);const formatted=JSON.stringify(obj,null,indent||undefined);outEl.textContent=formatted;statusEl.textContent='Valid JSON ('+Object.keys(obj).length+' keys)';statusEl.style.color='#4ade80';}
    catch(e){outEl.textContent='';statusEl.textContent='Invalid JSON: '+e.message;statusEl.style.color='#ef4444';}
  };
  window._jfCopy=function(){const t=document.getElementById('jf-output').textContent;if(t)navigator.clipboard.writeText(t);};
}
function showNetlifyCliRef(){
  const d=document.createElement('div');d.id='netlify-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Deploy':['netlify deploy','netlify deploy --prod','netlify deploy --dir=build','netlify build'],
    'Sites':['netlify sites:list','netlify sites:create','netlify sites:delete','netlify open','netlify status'],
    'Dev':['netlify dev','netlify dev --port 3001','netlify functions:create','netlify functions:serve'],
    'Env':['netlify env:set KEY value','netlify env:list','netlify env:unset KEY','netlify env:import .env'],
    'Link':['netlify link','netlify unlink','netlify init','netlify login','netlify logout']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Netlify CLI Reference</h3><button onclick="document.getElementById(\'netlify-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskWeeklyPattern(){
  const d=document.createElement('div');d.id='weekly-pattern-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status==='done'&&t.updatedAt);
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const counts=[0,0,0,0,0,0,0];
  tasks.forEach(t=>{const dow=new Date(t.updatedAt).getDay();counts[dow]++;});
  const mx=Math.max(...counts,1);
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Weekly Pattern</h3><button onclick="document.getElementById(\'weekly-pattern-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">Which days you complete the most tasks</div>';
  let svg='<svg width="420" height="180" viewBox="0 0 420 180">';
  const bw=45;const gap=14;
  days.forEach((day,i)=>{
    const x=15+i*(bw+gap);const h=(counts[i]/mx)*140;const y=160-h;
    const isMax=counts[i]===mx&&mx>0;
    svg+='<rect x="'+x+'" y="'+y+'" width="'+bw+'" height="'+h+'" fill="'+(isMax?'#4ade80':'rgba(74,222,128,0.5)')+'" rx="4"/>';
    svg+='<text x="'+(x+bw/2)+'" y="176" text-anchor="middle" fill="var(--text-muted)" font-size="10">'+day+'</text>';
    if(counts[i])svg+='<text x="'+(x+bw/2)+'" y="'+(y-5)+'" text-anchor="middle" fill="var(--text-secondary)" font-size="11">'+counts[i]+'</text>';
  });
  svg+='</svg>';
  html+=svg;
  const bestDay=days[counts.indexOf(Math.max(...counts))];
  html+='<div style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:8px">Most productive day: <span style="color:#4ade80;font-weight:600">'+bestDay+'</span></div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickCsvToTable(){
  const d=document.createElement('div');d.id='csv-table-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">CSV to Table</h3><button onclick="document.getElementById(\'csv-table-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<textarea id="csv-input" placeholder="Paste CSV data here (comma or tab separated)..." rows="5" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:11px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-bottom:8px"></textarea>';
  html+='<button onclick="window._csvRender()" style="padding:5px 14px;background:#4ade80;color:#000;border:none;border-radius:4px;font-size:11px;cursor:pointer;font-weight:600;margin-bottom:10px">Render Table</button>';
  html+='<div id="csv-output" style="overflow-x:auto"></div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._csvRender=function(){
    const input=document.getElementById('csv-input').value;const outEl=document.getElementById('csv-output');
    if(!input.trim()){outEl.innerHTML='';return;}
    const delim=input.includes('\t')?'\t':',';
    const rows=input.trim().split('\n').map(r=>r.split(delim).map(c=>c.trim().replace(/^"|"$/g,'')));
    if(!rows.length){outEl.innerHTML='';return;}
    let thtml='<table style="width:100%;border-collapse:collapse;font-size:11px">';
    thtml+='<thead><tr>';
    rows[0].forEach(h=>{thtml+='<th style="padding:6px 10px;background:var(--bg-surface);color:#4ade80;border:1px solid var(--border);text-align:left;font-weight:600;white-space:nowrap">'+esc(h)+'</th>';});
    thtml+='</tr></thead><tbody>';
    rows.slice(1).forEach(row=>{
      thtml+='<tr>';
      row.forEach(c=>{thtml+='<td style="padding:5px 10px;border:1px solid var(--border);color:var(--text-secondary)">'+esc(c)+'</td>';});
      thtml+='</tr>';
    });
    thtml+='</tbody></table>';
    thtml+='<div style="font-size:10px;color:var(--text-muted);margin-top:6px">'+rows.length+' rows, '+rows[0].length+' columns</div>';
    outEl.innerHTML=thtml;
  };
}
function showSupabaseCliRef(){
  const d=document.createElement('div');d.id='supabase-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Project':['supabase init','supabase start','supabase stop','supabase status','supabase link --project-ref <ref>'],
    'Database':['supabase db push','supabase db pull','supabase db reset','supabase db diff','supabase db lint'],
    'Migration':['supabase migration new <name>','supabase migration list','supabase migration repair --status applied <ver>'],
    'Functions':['supabase functions new <name>','supabase functions serve','supabase functions deploy <name>','supabase functions delete <name>'],
    'Auth':['supabase login','supabase projects list','supabase orgs list','supabase secrets set KEY=val','supabase secrets list']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Supabase CLI Reference</h3><button onclick="document.getElementById(\'supabase-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px;word-break:break-all" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskSlaReport(){
  const d=document.createElement('div');d.id='sla-report-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const withDue=tasks.filter(t=>t.due&&t.status==='done'&&t.updatedAt);
  let onTime=0;let late=0;
  withDue.forEach(t=>{
    const due=new Date(t.due);const completed=new Date(t.updatedAt);
    if(completed<=new Date(due.getTime()+86400000))onTime++;else late++;
  });
  const total=onTime+late;const pct=total?Math.round(onTime/total*100):0;
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">SLA Report</h3><button onclick="document.getElementById(\'sla-report-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  const gaugeColor=pct>=80?'#4ade80':pct>=60?'#f59e0b':'#ef4444';
  const circumference=2*Math.PI*80;const offset=circumference-(pct/100)*circumference;
  let svg='<svg width="200" height="200" viewBox="0 0 200 200" style="display:block;margin:0 auto 16px">';
  svg+='<circle cx="100" cy="100" r="80" fill="none" stroke="var(--bg-surface)" stroke-width="12"/>';
  svg+='<circle cx="100" cy="100" r="80" fill="none" stroke="'+gaugeColor+'" stroke-width="12" stroke-dasharray="'+circumference+'" stroke-dashoffset="'+offset+'" stroke-linecap="round" transform="rotate(-90 100 100)"/>';
  svg+='<text x="100" y="90" text-anchor="middle" fill="'+gaugeColor+'" font-size="36" font-weight="700">'+pct+'%</text>';
  svg+='<text x="100" y="115" text-anchor="middle" fill="var(--text-muted)" font-size="12">on time</text>';
  svg+='</svg>';
  html+=svg;
  html+='<div style="display:flex;gap:16px;justify-content:center">';
  html+='<div style="text-align:center"><div style="font-size:20px;color:#4ade80;font-weight:700">'+onTime+'</div><div style="font-size:10px;color:var(--text-muted)">On Time</div></div>';
  html+='<div style="text-align:center"><div style="font-size:20px;color:#ef4444;font-weight:700">'+late+'</div><div style="font-size:10px;color:var(--text-muted)">Late</div></div>';
  html+='<div style="text-align:center"><div style="font-size:20px;color:var(--text-secondary);font-weight:700">'+total+'</div><div style="font-size:10px;color:var(--text-muted)">Total</div></div></div>';
  if(!total)html+='<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:12px;margin-top:12px">Complete tasks with due dates to see SLA metrics.</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickRegexTester(){
  const d=document.createElement('div');d.id='regex-tester-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Regex Tester</h3><button onclick="document.getElementById(\'regex-tester-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:8px"><label style="font-size:10px;color:var(--text-muted)">Pattern</label><div style="display:flex;gap:4px"><span style="color:var(--text-muted);padding-top:6px">/</span><input id="rx-pattern" type="text" placeholder="[a-z]+" oninput="window._rxTest()" style="flex:1;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:#4ade80;font-size:13px;font-family:monospace"/><span style="color:var(--text-muted);padding-top:6px">/</span><input id="rx-flags" type="text" value="g" oninput="window._rxTest()" style="width:40px;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px;font-family:monospace"/></div></div>';
  html+='<div style="margin-bottom:8px"><label style="font-size:10px;color:var(--text-muted)">Test String</label><textarea id="rx-input" rows="4" placeholder="Enter test text..." oninput="window._rxTest()" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;font-family:monospace;resize:vertical;box-sizing:border-box"></textarea></div>';
  html+='<div id="rx-status" style="font-size:11px;margin-bottom:6px;color:var(--text-muted)"></div>';
  html+='<div id="rx-matches" style="padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:11px;color:var(--text-secondary);min-height:40px;max-height:200px;overflow-y:auto"></div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._rxTest=function(){
    const pattern=document.getElementById('rx-pattern').value;const flags=document.getElementById('rx-flags').value;
    const input=document.getElementById('rx-input').value;const statusEl=document.getElementById('rx-status');const matchEl=document.getElementById('rx-matches');
    if(!pattern){statusEl.textContent='';matchEl.innerHTML='';return;}
    try{
      const rx=new RegExp(pattern,flags);const matches=[...input.matchAll(rx)];
      statusEl.textContent=matches.length+' match'+(matches.length!==1?'es':'');statusEl.style.color='#4ade80';
      let mhtml='';
      matches.forEach((m,i)=>{
        mhtml+='<div style="margin-bottom:4px;padding:4px 6px;background:var(--bg-base);border-radius:3px"><span style="color:var(--text-muted);font-size:10px">#'+(i+1)+' ['+m.index+']</span> <span style="color:#4ade80">'+esc(m[0])+'</span>';
        if(m.length>1){for(let g=1;g<m.length;g++){mhtml+=' <span style="color:#f59e0b">$'+g+'='+esc(m[g]||'')+'</span>';}}
        mhtml+='</div>';
      });
      if(!matches.length)mhtml='<div style="color:var(--text-muted);font-size:11px">No matches</div>';
      matchEl.innerHTML=mhtml;
    }catch(e){statusEl.textContent='Error: '+e.message;statusEl.style.color='#ef4444';matchEl.innerHTML='';}
  };
}
function showRailwayCliRef(){
  const d=document.createElement('div');d.id='railway-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Project':['railway init','railway link','railway up','railway status','railway open'],
    'Service':['railway service','railway add','railway run <cmd>','railway logs','railway shell'],
    'Deploy':['railway up --detach','railway deploy','railway redeploy'],
    'Variables':['railway variables','railway variables set KEY=val','railway variables delete KEY'],
    'Domain':['railway domain','railway domain add <domain>'],
    'Other':['railway login','railway logout','railway whoami','railway --version','railway help']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Railway CLI Reference</h3><button onclick="document.getElementById(\'railway-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskCompletionStreak(){
  const d=document.createElement('div');d.id='streak-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status==='done'&&t.updatedAt);
  const daySet=new Set();
  tasks.forEach(t=>{daySet.add(new Date(t.updatedAt).toISOString().split('T')[0]);});
  const today=new Date();let currentStreak=0;let longestStreak=0;let tempStreak=0;
  const cursor=new Date(today);
  for(let i=0;i<365;i++){
    const key=cursor.toISOString().split('T')[0];
    if(daySet.has(key)){
      if(i===currentStreak)currentStreak++;
    }
    cursor.setDate(cursor.getDate()-1);
  }
  const sorted=[...daySet].sort().reverse();
  tempStreak=0;
  for(let i=0;i<sorted.length;i++){
    const d2=new Date(sorted[i]);
    if(i===0){tempStreak=1;continue;}
    const prev=new Date(sorted[i-1]);
    const diff=Math.round((prev-d2)/86400000);
    if(diff===1){tempStreak++;}else{if(tempStreak>longestStreak)longestStreak=tempStreak;tempStreak=1;}
  }
  if(tempStreak>longestStreak)longestStreak=tempStreak;
  const totalDays=daySet.size;
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Completion Streak</h3><button onclick="document.getElementById(\'streak-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:16px;justify-content:center;margin-bottom:20px">';
  html+='<div style="text-align:center;background:var(--bg-surface);padding:16px 20px;border-radius:8px"><div style="font-size:36px;color:#4ade80;font-weight:700">'+currentStreak+'</div><div style="font-size:11px;color:var(--text-muted)">Current Streak</div></div>';
  html+='<div style="text-align:center;background:var(--bg-surface);padding:16px 20px;border-radius:8px"><div style="font-size:36px;color:#f59e0b;font-weight:700">'+longestStreak+'</div><div style="font-size:11px;color:var(--text-muted)">Longest Streak</div></div></div>';
  html+='<div style="text-align:center;color:var(--text-muted);font-size:12px">'+totalDays+' active days total / '+tasks.length+' tasks completed</div>';
  const last7=[];const cursor2=new Date(today);
  for(let i=0;i<7;i++){const key=cursor2.toISOString().split('T')[0];const active=daySet.has(key);last7.push({day:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][cursor2.getDay()],active});cursor2.setDate(cursor2.getDate()-1);}
  last7.reverse();
  html+='<div style="display:flex;justify-content:center;gap:6px;margin-top:16px">';
  last7.forEach(d2=>{
    html+='<div style="text-align:center"><div style="width:28px;height:28px;border-radius:50%;background:'+(d2.active?'#4ade80':'var(--bg-surface)')+';border:2px solid '+(d2.active?'#4ade80':'var(--border)')+';display:flex;align-items:center;justify-content:center;margin-bottom:4px">'+(d2.active?'<span style="color:#000;font-size:12px;font-weight:700">&#10003;</span>':'')+'</div><div style="font-size:9px;color:var(--text-muted)">'+d2.day+'</div></div>';
  });
  html+='</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickQrGen(){
  const d=document.createElement('div');d.id='qr-gen-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">QR Code Generator</h3><button onclick="document.getElementById(\'qr-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<input id="qr-text" type="text" placeholder="Enter URL or text..." style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;box-sizing:border-box;margin-bottom:8px"/>';
  html+='<button onclick="window._qrGenerate()" style="width:100%;padding:8px;background:#4ade80;color:#000;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;margin-bottom:10px">Generate</button>';
  html+='<div id="qr-result" style="text-align:center"></div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._qrGenerate=function(){
    const text=document.getElementById('qr-text').value;const resEl=document.getElementById('qr-result');
    if(!text){resEl.innerHTML='<div style="color:var(--text-muted);font-size:11px">Enter text first</div>';return;}
    const url='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data='+encodeURIComponent(text);
    resEl.innerHTML='<img src="'+url+'" alt="QR Code" style="width:200px;height:200px;border-radius:4px;background:#fff;padding:8px"/><div style="font-size:10px;color:var(--text-muted);margin-top:6px">Right-click to save image</div>';
  };
}
function showClaudeCodeRef(){
  const d=document.createElement('div');d.id='claude-code-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Commands':['claude','claude code','claude --model opus','claude --resume','claude --continue','claude --print'],
    'Slash Commands':['/help','/compact','/clear','/commit','/review-pr','/model <name>','/cost','/memory'],
    'Keyboard':['Cmd+C — cancel','Cmd+K — clear','Tab — autocomplete','Shift+Tab — reject','Esc — cancel'],
    'Files':['CLAUDE.md — project instructions','.claude/settings.json — user settings','.claude/projects/ — project memory'],
    'MCP':['MCP servers for external tools','Configure in settings.json','Notion, Slack, GitHub integrations','Custom tool servers'],
    'Tips':['Use /compact to save context','Put rules in CLAUDE.md','Commit often with /commit','Use Task agents for parallel work']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Claude Code Reference</h3><button onclick="document.getElementById(\'claude-code-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskStatusTimeline(){
  const d=document.createElement('div');d.id='status-timeline-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const statusColors={'todo':'#6b7280','in-progress':'#3b82f6','blocked':'#ef4444','done':'#4ade80'};
  const byStatus={};
  Object.keys(statusColors).forEach(s=>{byStatus[s]=tasks.filter(t=>t.status===s).length;});
  const total=tasks.length||1;
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Status Overview</h3><button onclick="document.getElementById(\'status-timeline-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;height:24px;border-radius:6px;overflow:hidden;margin-bottom:16px">';
  Object.entries(byStatus).forEach(([status,count])=>{
    const pct=(count/total*100).toFixed(1);
    if(count>0)html+='<div style="width:'+pct+'%;background:'+statusColors[status]+';display:flex;align-items:center;justify-content:center;font-size:10px;color:#000;font-weight:600" title="'+status+': '+count+'">'+count+'</div>';
  });
  html+='</div>';
  Object.entries(byStatus).forEach(([status,count])=>{
    const pct=Math.round(count/total*100);
    html+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:8px;background:var(--bg-surface);border-radius:6px">';
    html+='<div style="width:14px;height:14px;border-radius:3px;background:'+statusColors[status]+'"></div>';
    html+='<span style="font-size:12px;color:var(--text-primary);flex:1;text-transform:capitalize">'+status.replace('-',' ')+'</span>';
    html+='<span style="font-size:14px;color:var(--text-primary);font-weight:600">'+count+'</span>';
    html+='<span style="font-size:11px;color:var(--text-muted)">'+pct+'%</span>';
    html+='<div style="width:80px;height:6px;background:var(--bg-base);border-radius:3px;overflow:hidden"><div style="width:'+pct+'%;height:100%;background:'+statusColors[status]+';border-radius:3px"></div></div>';
    html+='</div>';
  });
  html+='<div style="text-align:center;font-size:11px;color:var(--text-muted);margin-top:12px">'+tasks.length+' total tasks</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickHashGenerator(){
  const d=document.createElement('div');d.id='hash-gen-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px;max-height:70vh;overflow-y:auto';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Hash Generator</h3><button onclick="document.getElementById(\'hash-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<textarea id="hash-input" placeholder="Enter text to hash..." rows="3" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;font-family:monospace;resize:vertical;box-sizing:border-box;margin-bottom:8px"></textarea>';
  html+='<button onclick="window._hashGenerate()" style="width:100%;padding:8px;background:#4ade80;color:#000;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;margin-bottom:10px">Generate Hashes</button>';
  html+='<div id="hash-results"></div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._hashGenerate=async function(){
    const input=document.getElementById('hash-input').value;const resEl=document.getElementById('hash-results');
    if(!input){resEl.innerHTML='';return;}
    const algos=['SHA-1','SHA-256','SHA-384','SHA-512'];
    let rhtml='';
    for(const algo of algos){
      try{
        const encoder=new TextEncoder();const data=encoder.encode(input);
        const hashBuf=await crypto.subtle.digest(algo,data);
        const hashArr=Array.from(new Uint8Array(hashBuf));
        const hex=hashArr.map(b=>b.toString(16).padStart(2,'0')).join('');
        rhtml+='<div onclick="navigator.clipboard.writeText(\''+hex+'\');this.style.borderColor=\'#4ade80\';setTimeout(()=>this.style.borderColor=\'var(--border)\',600)" style="padding:6px 8px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;cursor:pointer"><div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">'+algo+'</div><div style="font-size:9px;color:#4ade80;font-family:monospace;word-break:break-all">'+hex+'</div></div>';
      }catch(e){rhtml+='<div style="padding:4px;color:#ef4444;font-size:10px">'+algo+': Error</div>';}
    }
    resEl.innerHTML=rhtml;
  };
}
function showPythonPipRef(){
  const d=document.createElement('div');d.id='pip-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Install':['pip install <pkg>','pip install -r requirements.txt','pip install --upgrade <pkg>','pip install -e .','pip uninstall <pkg>'],
    'Info':['pip list','pip show <pkg>','pip freeze','pip check','pip --version'],
    'Search':['pip index versions <pkg>','pip install <pkg>==<ver>','pip install "<pkg>>=1.0,<2.0"'],
    'Venv':['python -m venv .venv','source .venv/bin/activate','deactivate','python -m venv --clear .venv'],
    'Export':['pip freeze > requirements.txt','pip install --target ./lib <pkg>','pip download <pkg>','pip cache purge'],
    'Poetry':['poetry init','poetry add <pkg>','poetry install','poetry run <cmd>','poetry build','poetry publish']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Python/pip Reference</h3><button onclick="document.getElementById(\'pip-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskDailyGoal(){
  const d=document.createElement('div');d.id='daily-goal-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:75vh;overflow-y:auto';
  const today=new Date().toISOString().split('T')[0];
  if(!S._dailyGoal)S._dailyGoal={target:5,history:{}};
  const tasks=(S.tasks||[]).filter(t=>t.status==='done'&&t.updatedAt&&t.updatedAt.startsWith(today));
  const done=tasks.length;const target=S._dailyGoal.target;const pct=Math.min(100,Math.round(done/target*100));
  function rend(){
    let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Daily Goal</h3><button onclick="document.getElementById(\'daily-goal-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
    const circumference=2*Math.PI*70;const offset=circumference-(pct/100)*circumference;
    const col=pct>=100?'#4ade80':pct>=50?'#f59e0b':'#ef4444';
    let svg='<svg width="180" height="180" viewBox="0 0 180 180" style="display:block;margin:0 auto 16px">';
    svg+='<circle cx="90" cy="90" r="70" fill="none" stroke="var(--bg-surface)" stroke-width="10"/>';
    svg+='<circle cx="90" cy="90" r="70" fill="none" stroke="'+col+'" stroke-width="10" stroke-dasharray="'+circumference+'" stroke-dashoffset="'+offset+'" stroke-linecap="round" transform="rotate(-90 90 90)"/>';
    svg+='<text x="90" y="80" text-anchor="middle" fill="'+col+'" font-size="32" font-weight="700">'+done+'</text>';
    svg+='<text x="90" y="100" text-anchor="middle" fill="var(--text-muted)" font-size="12">of '+target+'</text>';
    svg+='<text x="90" y="120" text-anchor="middle" fill="var(--text-muted)" font-size="10">tasks today</text>';
    svg+='</svg>';
    html+=svg;
    if(pct>=100)html+='<div style="text-align:center;padding:10px;background:rgba(74,222,128,0.1);border-radius:6px;color:#4ade80;font-weight:600;font-size:13px;margin-bottom:12px">Goal reached!</div>';
    html+='<div style="display:flex;align-items:center;gap:8px;justify-content:center"><span style="font-size:11px;color:var(--text-muted)">Daily target:</span>';
    html+='<input type="number" value="'+target+'" min="1" max="50" onchange="window._setDailyGoal(this.value)" style="width:50px;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;text-align:center"/></div>';
    d.innerHTML=html;
  }
  window._setDailyGoal=function(val){S._dailyGoal.target=parseInt(val)||5;save();rend();};
  rend();document.body.appendChild(d);
}
function showQuickUuidGenerator(){
  const d=document.createElement('div');d.id='uuid-gen-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:300px';
  function genUuid(){return crypto.randomUUID?crypto.randomUUID():'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16);});}
  function rend(){
    const ids=[];for(let i=0;i<5;i++)ids.push(genUuid());
    let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">UUID Generator</h3><button onclick="document.getElementById(\'uuid-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
    ids.forEach(id=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+id+'\');this.style.borderColor=\'#4ade80\';setTimeout(()=>this.style.borderColor=\'var(--border)\',600)" style="padding:6px 8px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;cursor:pointer;font-family:monospace;font-size:11px;color:#4ade80;word-break:break-all">'+id+'</div>';
    });
    html+='<button onclick="window._uuidRegen()" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);font-size:11px;cursor:pointer;margin-top:4px">Regenerate</button>';
    html+='<div style="font-size:9px;color:var(--text-muted);margin-top:4px;text-align:center">Click any UUID to copy</div>';
    d.innerHTML=html;
  }
  window._uuidRegen=rend;
  rend();document.body.appendChild(d);
}
function showCargoRef(){
  const d=document.createElement('div');d.id='cargo-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Build':['cargo build','cargo build --release','cargo run','cargo run --release','cargo check'],
    'Test':['cargo test','cargo test <name>','cargo bench','cargo doc --open'],
    'Package':['cargo new <name>','cargo init','cargo add <pkg>','cargo remove <pkg>','cargo update'],
    'Publish':['cargo publish','cargo package','cargo login','cargo yank --version <ver>'],
    'Tools':['cargo fmt','cargo clippy','cargo fix','cargo clean','cargo tree'],
    'Other':['cargo --version','cargo search <query>','cargo install <pkg>','cargo audit','rustup update']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Cargo/Rust Reference</h3><button onclick="document.getElementById(\'cargo-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskWeeklyReport(){
  const d=document.createElement('div');d.id='weekly-report-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  const now=new Date();const weekStart=new Date(now);weekStart.setDate(weekStart.getDate()-now.getDay()+1);weekStart.setHours(0,0,0,0);
  const tasks=(S.tasks||[]);
  const createdThisWeek=tasks.filter(t=>t.createdAt&&new Date(t.createdAt)>=weekStart);
  const doneThisWeek=tasks.filter(t=>t.status==='done'&&t.updatedAt&&new Date(t.updatedAt)>=weekStart);
  const overdue=tasks.filter(t=>t.due&&new Date(t.due)<now&&t.status!=='done');
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Weekly Report</h3><button onclick="document.getElementById(\'weekly-report-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Week of '+weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'})+'</div>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">';
  html+='<div style="background:var(--bg-surface);padding:12px;border-radius:6px;text-align:center"><div style="font-size:22px;color:#4ade80;font-weight:700">'+doneThisWeek.length+'</div><div style="font-size:10px;color:var(--text-muted)">Completed</div></div>';
  html+='<div style="background:var(--bg-surface);padding:12px;border-radius:6px;text-align:center"><div style="font-size:22px;color:#3b82f6;font-weight:700">'+createdThisWeek.length+'</div><div style="font-size:10px;color:var(--text-muted)">Created</div></div>';
  html+='<div style="background:var(--bg-surface);padding:12px;border-radius:6px;text-align:center"><div style="font-size:22px;color:#f59e0b;font-weight:700">'+inProgress.length+'</div><div style="font-size:10px;color:var(--text-muted)">In Progress</div></div>';
  html+='<div style="background:var(--bg-surface);padding:12px;border-radius:6px;text-align:center"><div style="font-size:22px;color:#ef4444;font-weight:700">'+overdue.length+'</div><div style="font-size:10px;color:var(--text-muted)">Overdue</div></div></div>';
  if(doneThisWeek.length){
    html+='<div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">Completed This Week</div>';
    doneThisWeek.slice(0,10).forEach(t=>{
      html+='<div style="padding:4px 8px;font-size:12px;color:var(--text-secondary);border-left:2px solid #4ade80;margin-bottom:3px;padding-left:8px">'+esc(t.title)+'</div>';
    });
    if(doneThisWeek.length>10)html+='<div style="font-size:10px;color:var(--text-muted);padding:4px 8px">+'+(doneThisWeek.length-10)+' more</div>';
  }
  html+='<button onclick="window._copyWeeklyReport()" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-secondary);font-size:11px;cursor:pointer;margin-top:12px">Copy as Markdown</button>';
  d.innerHTML=html;document.body.appendChild(d);
  window._copyWeeklyReport=function(){
    let md='# Weekly Report - '+weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'})+'\n\n';
    md+='- Completed: '+doneThisWeek.length+'\n- Created: '+createdThisWeek.length+'\n- In Progress: '+inProgress.length+'\n- Overdue: '+overdue.length+'\n\n';
    if(doneThisWeek.length){md+='## Completed\n';doneThisWeek.forEach(t=>{md+='- '+t.title+'\n';});}
    navigator.clipboard.writeText(md);
  };
}
function showQuickCronBuilder(){
  const d=document.createElement('div');d.id='cron-builder-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px';
  const presets=[
    {label:'Every minute',cron:'* * * * *'},
    {label:'Every hour',cron:'0 * * * *'},
    {label:'Every day at midnight',cron:'0 0 * * *'},
    {label:'Every day at 9am',cron:'0 9 * * *'},
    {label:'Every Monday',cron:'0 0 * * 1'},
    {label:'Every weekday at 9am',cron:'0 9 * * 1-5'},
    {label:'1st of every month',cron:'0 0 1 * *'},
    {label:'Every 5 minutes',cron:'*/5 * * * *'},
    {label:'Every 15 minutes',cron:'*/15 * * * *'},
    {label:'Every Sunday at 6pm',cron:'0 18 * * 0'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Cron Builder</h3><button onclick="document.getElementById(\'cron-builder-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:4px;margin-bottom:10px">';
  const fields=['min','hr','day','mon','dow'];
  fields.forEach((f,i)=>{
    html+='<div style="flex:1;text-align:center"><div style="font-size:8px;color:var(--text-muted);margin-bottom:2px">'+f+'</div><input id="cron-'+i+'" type="text" value="*" style="width:100%;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:3px;color:#4ade80;font-size:12px;font-family:monospace;text-align:center;box-sizing:border-box"/></div>';
  });
  html+='</div>';
  html+='<div id="cron-expr" onclick="navigator.clipboard.writeText(this.textContent)" style="padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:14px;color:#4ade80;text-align:center;cursor:pointer;margin-bottom:10px">* * * * *</div>';
  html+='<div style="font-size:9px;color:var(--text-muted);text-align:center;margin-bottom:10px">Click expression to copy</div>';
  html+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">Presets:</div>';
  presets.forEach(p=>{
    html+='<div onclick="window._setCron(\''+p.cron+'\')" style="padding:4px 8px;font-size:11px;cursor:pointer;border-radius:3px;display:flex;justify-content:space-between;margin-bottom:1px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'"><span style="color:var(--text-secondary)">'+p.label+'</span><span style="color:var(--text-muted);font-family:monospace;font-size:10px">'+p.cron+'</span></div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
  function updateExpr(){
    const parts=[];for(let i=0;i<5;i++)parts.push(document.getElementById('cron-'+i).value||'*');
    document.getElementById('cron-expr').textContent=parts.join(' ');
  }
  for(let i=0;i<5;i++)document.getElementById('cron-'+i).addEventListener('input',updateExpr);
  window._setCron=function(cron){
    const parts=cron.split(' ');for(let i=0;i<5;i++)document.getElementById('cron-'+i).value=parts[i]||'*';
    updateExpr();
  };
}
function showGoModRef(){
  const d=document.createElement('div');d.id='go-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Build':['go build','go build -o <name>','go run .','go run <file>.go','go install'],
    'Modules':['go mod init <module>','go mod tidy','go mod download','go mod vendor','go mod verify','go get <pkg>@latest'],
    'Test':['go test','go test ./...','go test -v','go test -cover','go test -bench=.','go test -race'],
    'Tools':['go fmt ./...','go vet ./...','go doc <pkg>','go generate ./...','go clean'],
    'Info':['go version','go env','go list -m all','go list ./...','go tool pprof']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Go Reference</h3><button onclick="document.getElementById(\'go-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:12px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskArchiveStats(){
  const d=document.createElement('div');d.id='archive-stats-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:75vh;overflow-y:auto';
  const archived=(S._archivedTasks||[]);const active=(S.tasks||[]);
  const totalDone=active.filter(t=>t.status==='done').length;
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Archive Stats</h3><button onclick="document.getElementById(\'archive-stats-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">';
  html+='<div style="background:var(--bg-surface);padding:14px;border-radius:6px;text-align:center"><div style="font-size:24px;color:#4ade80;font-weight:700">'+archived.length+'</div><div style="font-size:10px;color:var(--text-muted)">Archived</div></div>';
  html+='<div style="background:var(--bg-surface);padding:14px;border-radius:6px;text-align:center"><div style="font-size:24px;color:#3b82f6;font-weight:700">'+active.length+'</div><div style="font-size:10px;color:var(--text-muted)">Active</div></div>';
  html+='<div style="background:var(--bg-surface);padding:14px;border-radius:6px;text-align:center"><div style="font-size:24px;color:#f59e0b;font-weight:700">'+totalDone+'</div><div style="font-size:10px;color:var(--text-muted)">Done (Active)</div></div>';
  html+='<div style="background:var(--bg-surface);padding:14px;border-radius:6px;text-align:center"><div style="font-size:24px;color:var(--text-secondary);font-weight:700">'+(archived.length+active.length)+'</div><div style="font-size:10px;color:var(--text-muted)">Total Ever</div></div></div>';
  if(archived.length){
    html+='<div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">Recent Archives</div>';
    archived.slice(0,8).forEach(t=>{
      html+='<div style="padding:4px 8px;font-size:11px;color:var(--text-secondary);border-left:2px solid var(--border);margin-bottom:2px">'+esc(t.title)+'</div>';
    });
    if(archived.length>8)html+='<div style="font-size:10px;color:var(--text-muted);padding:4px 8px">+'+(archived.length-8)+' more in archive</div>';
  }
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickMarkdownTable(){
  const d=document.createElement('div');d.id='md-table-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:80vh;overflow-y:auto';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Markdown Table Generator</h3><button onclick="document.getElementById(\'md-table-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:8px;margin-bottom:10px"><div><label style="font-size:10px;color:var(--text-muted)">Cols</label><input id="mt-cols" type="number" value="3" min="1" max="10" style="width:50px;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px"/></div>';
  html+='<div><label style="font-size:10px;color:var(--text-muted)">Rows</label><input id="mt-rows" type="number" value="3" min="1" max="20" style="width:50px;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px"/></div>';
  html+='<button onclick="window._mtGenerate()" style="padding:4px 12px;background:#4ade80;color:#000;border:none;border-radius:4px;font-size:11px;cursor:pointer;font-weight:600;align-self:flex-end">Generate</button></div>';
  html+='<pre id="mt-output" onclick="navigator.clipboard.writeText(this.textContent)" style="padding:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:#4ade80;font-size:11px;font-family:monospace;white-space:pre;overflow-x:auto;margin:0;cursor:pointer;min-height:60px"></pre>';
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:4px;text-align:center">Click output to copy</div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._mtGenerate=function(){
    const cols=parseInt(document.getElementById('mt-cols').value)||3;const rows=parseInt(document.getElementById('mt-rows').value)||3;
    let md='| ';for(let c=0;c<cols;c++)md+='Header'+(c+1)+' | ';md=md.trim()+'\n| ';
    for(let c=0;c<cols;c++)md+='--- | ';md=md.trim()+'\n';
    for(let r=0;r<rows;r++){md+='| ';for(let c=0;c<cols;c++)md+='data | ';md=md.trim()+'\n';}
    document.getElementById('mt-output').textContent=md;
  };
  window._mtGenerate();
}
function showComposerRef(){
  const d=document.createElement('div');d.id='composer-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Install':['composer install','composer require <pkg>','composer require --dev <pkg>','composer remove <pkg>','composer update'],
    'Create':['composer init','composer create-project <pkg> <dir>'],
    'Info':['composer show','composer show <pkg>','composer outdated','composer depends <pkg>','composer --version'],
    'Scripts':['composer run-script <name>','composer dump-autoload','composer validate','composer check-platform-reqs'],
    'Config':['composer config --list','composer global require <pkg>','composer global show','composer self-update'],
    'Cache':['composer clear-cache','composer diagnose','composer licenses','composer fund']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Composer/PHP Reference</h3><button onclick="document.getElementById(\'composer-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskMilestones(){
  const d=document.createElement('div');d.id='milestones-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const done=tasks.filter(t=>t.status==='done');
  const milestones=[
    {n:10,label:'Getting Started'},
    {n:25,label:'Building Momentum'},
    {n:50,label:'Halfway Hero'},
    {n:100,label:'Century Club'},
    {n:200,label:'Double Century'},
    {n:500,label:'Task Legend'},
    {n:1000,label:'Grandmaster'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Milestones</h3><button onclick="document.getElementById(\'milestones-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="text-align:center;margin-bottom:16px"><div style="font-size:36px;color:#4ade80;font-weight:700">'+done.length+'</div><div style="font-size:12px;color:var(--text-muted)">tasks completed</div></div>';
  milestones.forEach(m=>{
    const reached=done.length>=m.n;const pct=Math.min(100,Math.round(done.length/m.n*100));
    html+='<div style="margin-bottom:8px;padding:10px;background:var(--bg-surface);border-radius:6px;border-left:3px solid '+(reached?'#4ade80':'var(--border)')+'">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:12px;color:'+(reached?'#4ade80':'var(--text-primary)')+';font-weight:'+(reached?'600':'400')+'">'+m.label+' ('+m.n+')</span>';
    html+='<span style="font-size:11px;color:'+(reached?'#4ade80':'var(--text-muted)')+'">'+(reached?'Achieved!':pct+'%')+'</span></div>';
    html+='<div style="background:var(--bg-base);border-radius:3px;height:4px;overflow:hidden"><div style="width:'+pct+'%;height:100%;background:'+(reached?'#4ade80':'var(--border)')+';border-radius:3px"></div></div>';
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickPlaceholderImage(){
  const d=document.createElement('div');d.id='placeholder-img-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Placeholder Image</h3><button onclick="document.getElementById(\'placeholder-img-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:flex;gap:6px;margin-bottom:8px"><div><label style="font-size:10px;color:var(--text-muted)">Width</label><input id="ph-w" type="number" value="400" style="width:100%;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;box-sizing:border-box"/></div>';
  html+='<div><label style="font-size:10px;color:var(--text-muted)">Height</label><input id="ph-h" type="number" value="300" style="width:100%;padding:4px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;box-sizing:border-box"/></div></div>';
  html+='<input id="ph-text" type="text" placeholder="Custom text (optional)" style="width:100%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;box-sizing:border-box;margin-bottom:8px"/>';
  html+='<button onclick="window._phGenerate()" style="width:100%;padding:8px;background:#4ade80;color:#000;border:none;border-radius:4px;font-weight:600;cursor:pointer;font-size:12px;margin-bottom:8px">Generate URL</button>';
  html+='<div id="ph-result" style="font-size:11px"></div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._phGenerate=function(){
    const w=document.getElementById('ph-w').value||400;const h=document.getElementById('ph-h').value||300;
    const text=document.getElementById('ph-text').value;const resEl=document.getElementById('ph-result');
    const url='https://placehold.co/'+w+'x'+h+'/1a1a2e/4ade80'+(text?'?text='+encodeURIComponent(text):'');
    resEl.innerHTML='<div onclick="navigator.clipboard.writeText(\''+url+'\')" style="padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;cursor:pointer;word-break:break-all;color:#4ade80;font-family:monospace;margin-bottom:6px">'+url+'</div><img src="'+url+'" style="width:100%;border-radius:4px;margin-top:4px" alt="preview"/>';
  };
}
function showRubyGemsRef(){
  const d=document.createElement('div');d.id='ruby-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Gems':['gem install <name>','gem uninstall <name>','gem list','gem search <query>','gem update','gem info <name>'],
    'Bundler':['bundle init','bundle install','bundle update','bundle exec <cmd>','bundle add <gem>','bundle lock'],
    'Rails':['rails new <name>','rails server','rails console','rails generate <type> <name>','rails db:migrate','rails routes'],
    'RVM/rbenv':['rbenv install <ver>','rbenv local <ver>','rbenv versions','rvm use <ver>','rvm list'],
    'Other':['ruby --version','irb','gem --version','gem environment','rake --tasks']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Ruby/Rails Reference</h3><button onclick="document.getElementById(\'ruby-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskFocusScore(){
  const d=document.createElement('div');d.id='focus-score-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:420px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const inProgress=tasks.filter(t=>t.status==='in-progress');
  const withDue=tasks.filter(t=>t.due);
  const overdue=tasks.filter(t=>t.due&&new Date(t.due)<new Date());
  const p0p1=tasks.filter(t=>t.priority==='p0'||t.priority==='p1');
  let score=100;
  if(inProgress.length>5)score-=20;
  if(inProgress.length>10)score-=15;
  if(overdue.length>0)score-=overdue.length*5;
  if(p0p1.length>3)score-=10;
  if(tasks.length>20)score-=10;
  score=Math.max(0,Math.min(100,score));
  const col=score>=80?'#4ade80':score>=50?'#f59e0b':'#ef4444';
  const circumference=2*Math.PI*70;const offset=circumference-(score/100)*circumference;
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Focus Score</h3><button onclick="document.getElementById(\'focus-score-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  let svg='<svg width="180" height="180" viewBox="0 0 180 180" style="display:block;margin:0 auto 16px">';
  svg+='<circle cx="90" cy="90" r="70" fill="none" stroke="var(--bg-surface)" stroke-width="10"/>';
  svg+='<circle cx="90" cy="90" r="70" fill="none" stroke="'+col+'" stroke-width="10" stroke-dasharray="'+circumference+'" stroke-dashoffset="'+offset+'" stroke-linecap="round" transform="rotate(-90 90 90)"/>';
  svg+='<text x="90" y="85" text-anchor="middle" fill="'+col+'" font-size="36" font-weight="700">'+score+'</text>';
  svg+='<text x="90" y="108" text-anchor="middle" fill="var(--text-muted)" font-size="11">'+(score>=80?'Focused':score>=50?'Distracted':'Overwhelmed')+'</text>';
  svg+='</svg>';
  html+=svg;
  const factors=[];
  if(inProgress.length>5)factors.push({text:'Too many WIP tasks ('+inProgress.length+')',bad:true});
  if(overdue.length>0)factors.push({text:overdue.length+' overdue tasks',bad:true});
  if(p0p1.length>3)factors.push({text:'Many critical tasks ('+p0p1.length+')',bad:true});
  if(inProgress.length<=3)factors.push({text:'Good WIP limit',bad:false});
  if(overdue.length===0)factors.push({text:'No overdue tasks',bad:false});
  factors.forEach(f=>{
    html+='<div style="padding:4px 8px;margin-bottom:3px;font-size:11px;color:'+(f.bad?'#ef4444':'#4ade80')+'">'+(f.bad?'- ':'+ ')+f.text+'</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickSlugGenerator(){
  const d=document.createElement('div');d.id='slug-gen-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:300px';
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Slug Generator</h3><button onclick="document.getElementById(\'slug-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<input id="slug-input" type="text" placeholder="Enter text..." oninput="window._slugGen()" style="width:100%;padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px;box-sizing:border-box;margin-bottom:8px"/>';
  html+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Slug:</div>';
  html+='<div id="slug-output" onclick="navigator.clipboard.writeText(this.textContent)" style="padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:13px;color:#4ade80;cursor:pointer;min-height:20px;word-break:break-all"></div>';
  html+='<div style="font-size:10px;color:var(--text-muted);margin-top:4px;margin-bottom:8px">camelCase:</div>';
  html+='<div id="camel-output" onclick="navigator.clipboard.writeText(this.textContent)" style="padding:8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:13px;color:#4ade80;cursor:pointer;min-height:20px"></div>';
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:4px;text-align:center">Click to copy</div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._slugGen=function(){
    const input=document.getElementById('slug-input').value;
    const slug=input.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,'').replace(/[\s]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
    document.getElementById('slug-output').textContent=slug;
    const camel=input.trim().split(/\s+/).map((w,i)=>{const lower=w.toLowerCase();return i===0?lower:lower.charAt(0).toUpperCase()+lower.slice(1);}).join('');
    document.getElementById('camel-output').textContent=camel;
  };
}
function showGradleRef(){
  const d=document.createElement('div');d.id='gradle-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Build':['gradle build','gradle clean','gradle assemble','gradle jar','gradle bootRun'],
    'Test':['gradle test','gradle check','gradle jacocoTestReport'],
    'Dependencies':['gradle dependencies','gradle dependencyInsight --dependency <dep>','gradle refreshDependencies'],
    'Info':['gradle tasks','gradle projects','gradle properties','gradle --version','gradle wrapper'],
    'Android':['gradle assembleDebug','gradle assembleRelease','gradle installDebug','gradle connectedAndroidTest'],
    'Other':['gradle init','gradle --daemon','gradle --stop','gradle --scan','gradle help --task <task>']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Gradle Reference</h3><button onclick="document.getElementById(\'gradle-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskScopeCreep(){
  const d=document.createElement('div');d.id='scope-creep-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const projects=(S.projects||[]);
  const byProject={};
  tasks.forEach(t=>{
    const pid=t.projectId||'none';
    if(!byProject[pid])byProject[pid]={original:0,added:0};
    const created=t.createdAt?new Date(t.createdAt):new Date();
    const projCreated=projects.find(p=>p.id===pid);
    const projDate=projCreated&&projCreated.createdAt?new Date(projCreated.createdAt):new Date(0);
    const diff=(created-projDate)/86400000;
    if(diff<1)byProject[pid].original++;else byProject[pid].added++;
  });
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Scope Creep Analysis</h3><button onclick="document.getElementById(\'scope-creep-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">Compares original tasks (created same day as project) vs added later</div>';
  const entries=Object.entries(byProject).sort((a,b)=>(b[1].original+b[1].added)-(a[1].original+a[1].added));
  entries.forEach(([pid,data])=>{
    const proj=projects.find(p=>p.id===pid);const name=proj?proj.name:'No Project';
    const total=data.original+data.added;const creepPct=total?Math.round(data.added/total*100):0;
    const col=creepPct>60?'#ef4444':creepPct>30?'#f59e0b':'#4ade80';
    html+='<div style="padding:10px;background:var(--bg-surface);border-radius:6px;margin-bottom:6px">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:12px;color:var(--text-primary);font-weight:600">'+esc(name)+'</span><span style="font-size:11px;color:'+col+'">'+creepPct+'% scope creep</span></div>';
    html+='<div style="display:flex;height:8px;border-radius:4px;overflow:hidden"><div style="width:'+(100-creepPct)+'%;background:#4ade80"></div><div style="width:'+creepPct+'%;background:#ef4444"></div></div>';
    html+='<div style="display:flex;gap:12px;font-size:10px;color:var(--text-muted);margin-top:4px"><span>Original: '+data.original+'</span><span>Added: '+data.added+'</span></div></div>';
  });
  if(!entries.length)html+='<div style="text-align:center;padding:20px;color:var(--text-muted)">No tasks found.</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickAspectRatio(){
  const d=document.createElement('div');d.id='aspect-ratio-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:260px';
  const ratios=[
    {label:'16:9',desc:'Widescreen',w:1920,h:1080},
    {label:'4:3',desc:'Standard',w:1024,h:768},
    {label:'1:1',desc:'Square',w:1080,h:1080},
    {label:'9:16',desc:'Vertical/Stories',w:1080,h:1920},
    {label:'21:9',desc:'Ultrawide',w:2560,h:1080},
    {label:'3:2',desc:'Photography',w:1500,h:1000},
    {label:'2:3',desc:'Pinterest',w:1000,h:1500}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Aspect Ratios</h3><button onclick="document.getElementById(\'aspect-ratio-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:10px"><input id="ar-width" type="number" placeholder="Width" value="1920" oninput="window._arCalc()" style="width:48%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;box-sizing:border-box"/> x <input id="ar-height" type="number" placeholder="Height" value="1080" oninput="window._arCalc()" style="width:40%;padding:6px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;box-sizing:border-box"/></div>';
  html+='<div id="ar-result" style="text-align:center;padding:8px;background:var(--bg-surface);border-radius:6px;margin-bottom:10px;font-size:18px;color:#4ade80;font-weight:700">16:9</div>';
  html+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">Common ratios:</div>';
  ratios.forEach(r=>{
    html+='<div onclick="document.getElementById(\'ar-width\').value='+r.w+';document.getElementById(\'ar-height\').value='+r.h+';window._arCalc()" style="display:flex;justify-content:space-between;padding:4px 8px;font-size:11px;cursor:pointer;border-radius:3px;margin-bottom:1px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'"><span style="color:#4ade80;font-weight:600">'+r.label+'</span><span style="color:var(--text-muted)">'+r.desc+' ('+r.w+'x'+r.h+')</span></div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
  window._arCalc=function(){
    const w=parseInt(document.getElementById('ar-width').value)||0;const h=parseInt(document.getElementById('ar-height').value)||0;
    if(!w||!h)return;
    function gcd(a,b){return b?gcd(b,a%b):a;}
    const g=gcd(w,h);
    document.getElementById('ar-result').textContent=(w/g)+':'+(h/g);
  };
}
function showMavenRef(){
  const d=document.createElement('div');d.id='maven-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Lifecycle':['mvn clean','mvn compile','mvn test','mvn package','mvn install','mvn deploy'],
    'Build':['mvn clean install','mvn clean package -DskipTests','mvn clean install -U','mvn validate'],
    'Dependencies':['mvn dependency:tree','mvn dependency:resolve','mvn versions:display-dependency-updates','mvn dependency:purge-local-repository'],
    'Plugins':['mvn help:effective-pom','mvn help:effective-settings','mvn site','mvn javadoc:javadoc'],
    'Create':['mvn archetype:generate','mvn archetype:generate -DgroupId=com.example','mvn wrapper:wrapper'],
    'Other':['mvn --version','mvn -pl <module>','mvn -am -pl <module>','mvn -T 4 clean install']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Maven Reference</h3><button onclick="document.getElementById(\'maven-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskTagBreakdown(){
  const d=document.createElement('div');d.id='tag-breakdown-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const content=(S.content||[]);
  const tagCounts={};
  content.forEach(c=>{
    (c.tags||[]).forEach(t=>{tagCounts[t]=(tagCounts[t]||0)+1;});
  });
  const sorted=Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]);
  const mx=sorted.length?sorted[0][1]:1;
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Tag Breakdown</h3><button onclick="document.getElementById(\'tag-breakdown-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">'+sorted.length+' tags across '+content.length+' items</div>';
  sorted.slice(0,20).forEach(([tag,count])=>{
    const pct=Math.round(count/mx*100);
    html+='<div style="margin-bottom:6px"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><span style="font-size:12px;color:var(--text-primary)">'+esc(tag)+'</span><span style="font-size:11px;color:var(--text-muted)">'+count+'</span></div>';
    html+='<div style="background:var(--bg-surface);height:6px;border-radius:3px;overflow:hidden"><div style="width:'+pct+'%;height:100%;background:#4ade80;border-radius:3px"></div></div></div>';
  });
  if(!sorted.length)html+='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px">No tags found. Add tags to content items.</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickShadowGenerator(){
  const d=document.createElement('div');d.id='shadow-gen-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:300px';
  const presets=[
    {label:'Subtle',val:'0 1px 3px rgba(0,0,0,0.12)'},
    {label:'Medium',val:'0 4px 12px rgba(0,0,0,0.15)'},
    {label:'Large',val:'0 8px 30px rgba(0,0,0,0.2)'},
    {label:'XL',val:'0 12px 48px rgba(0,0,0,0.25)'},
    {label:'Float',val:'0 20px 60px rgba(0,0,0,0.3)'},
    {label:'Sharp',val:'4px 4px 0 rgba(0,0,0,0.2)'},
    {label:'Glow Green',val:'0 0 20px rgba(74,222,128,0.3)'},
    {label:'Glow Blue',val:'0 0 20px rgba(59,130,246,0.3)'},
    {label:'Inner',val:'inset 0 2px 6px rgba(0,0,0,0.2)'},
    {label:'Multi',val:'0 1px 3px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.15)'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Shadow Generator</h3><button onclick="document.getElementById(\'shadow-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div id="shadow-preview" style="width:120px;height:80px;background:var(--bg-surface);border-radius:8px;margin:0 auto 12px;box-shadow:0 4px 12px rgba(0,0,0,0.15)"></div>';
  html+='<div id="shadow-css" onclick="navigator.clipboard.writeText(this.textContent)" style="padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:10px;color:#4ade80;cursor:pointer;word-break:break-all;margin-bottom:10px">box-shadow: 0 4px 12px rgba(0,0,0,0.15);</div>';
  presets.forEach(p=>{
    html+='<div onclick="document.getElementById(\'shadow-preview\').style.boxShadow=\''+p.val+'\';document.getElementById(\'shadow-css\').textContent=\'box-shadow: '+p.val+';\';" style="display:flex;justify-content:space-between;padding:4px 8px;font-size:11px;cursor:pointer;border-radius:3px;margin-bottom:1px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'"><span style="color:var(--text-secondary)">'+p.label+'</span><span style="color:var(--text-muted);font-size:9px;font-family:monospace;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+p.val+'</span></div>';
  });
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:6px;text-align:center">Click CSS to copy</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showNugetRef(){
  const d=document.createElement('div');d.id='nuget-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Package':['dotnet add package <pkg>','dotnet remove package <pkg>','dotnet list package','dotnet restore'],
    'Build':['dotnet build','dotnet run','dotnet publish','dotnet clean','dotnet watch run'],
    'Test':['dotnet test','dotnet test --filter <name>','dotnet test --collect:"XPlat Code Coverage"'],
    'Create':['dotnet new webapi','dotnet new console','dotnet new classlib','dotnet new blazorserver','dotnet new list'],
    'Tools':['dotnet tool install -g <tool>','dotnet tool list -g','dotnet tool update -g <tool>','dotnet format'],
    'Other':['dotnet --version','dotnet --info','dotnet nuget push','dotnet ef migrations add <name>','dotnet ef database update']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">.NET/NuGet Reference</h3><button onclick="document.getElementById(\'nuget-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskProductivityIndex(){
  const d=document.createElement('div');d.id='productivity-index-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);
  const now=new Date();
  const periods=[
    {label:'Today',start:new Date(now.getFullYear(),now.getMonth(),now.getDate())},
    {label:'This Week',start:new Date(now.getTime()-now.getDay()*86400000)},
    {label:'This Month',start:new Date(now.getFullYear(),now.getMonth(),1)},
    {label:'All Time',start:new Date(0)}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Productivity Index</h3><button onclick="document.getElementById(\'productivity-index-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  periods.forEach(p=>{
    const created=tasks.filter(t=>t.createdAt&&new Date(t.createdAt)>=p.start).length;
    const done=tasks.filter(t=>t.status==='done'&&t.updatedAt&&new Date(t.updatedAt)>=p.start).length;
    const ratio=created>0?(done/created*100).toFixed(0):0;
    const col=ratio>=80?'#4ade80':ratio>=50?'#f59e0b':'#ef4444';
    html+='<div style="background:var(--bg-surface);padding:12px;border-radius:6px;margin-bottom:8px">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:13px;color:var(--text-primary);font-weight:600">'+p.label+'</span><span style="font-size:16px;color:'+col+';font-weight:700">'+ratio+'%</span></div>';
    html+='<div style="display:flex;height:6px;border-radius:3px;overflow:hidden;background:var(--bg-base)"><div style="width:'+Math.min(100,ratio)+'%;background:'+col+'"></div></div>';
    html+='<div style="display:flex;gap:12px;font-size:10px;color:var(--text-muted);margin-top:6px"><span>Created: '+created+'</span><span>Done: '+done+'</span><span>Ratio: '+ratio+'%</span></div></div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickGradientGenerator(){
  const d=document.createElement('div');d.id='gradient-gen-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:300px';
  const presets=[
    {label:'Mint',val:'linear-gradient(135deg, #4ade80, #059669)'},
    {label:'Ocean',val:'linear-gradient(135deg, #3b82f6, #06b6d4)'},
    {label:'Sunset',val:'linear-gradient(135deg, #f59e0b, #ef4444)'},
    {label:'Purple',val:'linear-gradient(135deg, #8b5cf6, #ec4899)'},
    {label:'Dark',val:'linear-gradient(135deg, #1a1a2e, #16213e)'},
    {label:'Gold',val:'linear-gradient(135deg, #fbbf24, #d97706)'},
    {label:'Rose',val:'linear-gradient(135deg, #f43f5e, #ec4899)'},
    {label:'Forest',val:'linear-gradient(135deg, #059669, #065f46)'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Gradient Generator</h3><button onclick="document.getElementById(\'gradient-gen-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div id="grad-preview" style="width:100%;height:80px;border-radius:8px;margin-bottom:10px;background:linear-gradient(135deg, #4ade80, #059669)"></div>';
  html+='<div id="grad-css" onclick="navigator.clipboard.writeText(this.textContent)" style="padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:10px;color:#4ade80;cursor:pointer;word-break:break-all;margin-bottom:10px">background: linear-gradient(135deg, #4ade80, #059669);</div>';
  html+='<div style="display:flex;gap:6px;margin-bottom:10px"><input id="grad-c1" type="color" value="#4ade80" oninput="window._gradUpdate()" style="flex:1;height:30px;border:none;cursor:pointer"/><input id="grad-c2" type="color" value="#059669" oninput="window._gradUpdate()" style="flex:1;height:30px;border:none;cursor:pointer"/></div>';
  html+='<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px">Presets:</div>';
  presets.forEach(p=>{
    html+='<div onclick="window._gradSet(\''+p.val+'\')" style="display:flex;align-items:center;gap:8px;padding:4px 8px;font-size:11px;cursor:pointer;border-radius:3px;margin-bottom:1px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'"><div style="width:24px;height:14px;border-radius:3px;background:'+p.val+'"></div><span style="color:var(--text-secondary)">'+p.label+'</span></div>';
  });
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:6px;text-align:center">Click CSS to copy</div>';
  d.innerHTML=html;document.body.appendChild(d);
  window._gradUpdate=function(){
    const c1=document.getElementById('grad-c1').value;const c2=document.getElementById('grad-c2').value;
    const val='linear-gradient(135deg, '+c1+', '+c2+')';
    document.getElementById('grad-preview').style.background=val;
    document.getElementById('grad-css').textContent='background: '+val+';';
  };
  window._gradSet=function(val){
    document.getElementById('grad-preview').style.background=val;
    document.getElementById('grad-css').textContent='background: '+val+';';
  };
}
function showHelmRef(){
  const d=document.createElement('div');d.id='helm-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Chart':['helm create <name>','helm install <name> <chart>','helm upgrade <name> <chart>','helm uninstall <name>'],
    'Repo':['helm repo add <name> <url>','helm repo update','helm repo list','helm search repo <query>','helm search hub <query>'],
    'Status':['helm list','helm status <name>','helm history <name>','helm get values <name>','helm get manifest <name>'],
    'Template':['helm template <name> <chart>','helm lint <chart>','helm package <chart>','helm pull <chart>'],
    'Other':['helm version','helm env','helm rollback <name> <rev>','helm show values <chart>','helm dependency update']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Helm Reference</h3><button onclick="document.getElementById(\'helm-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskHealthDashboard(){
  const d=document.createElement('div');d.id='health-dashboard-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:80vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const content=(S.content||[]);const docs=(S.writerDocs||[]);const links=(S.links||[]);
  const now=new Date();
  const active=tasks.filter(t=>t.status!=='done');const done=tasks.filter(t=>t.status==='done');
  const overdue=active.filter(t=>t.due&&new Date(t.due)<now);
  const wip=active.filter(t=>t.status==='in-progress');
  const doneToday=done.filter(t=>t.updatedAt&&new Date(t.updatedAt).toDateString()===now.toDateString());
  const totalWords=docs.reduce((s,d2)=>s+(d2.content?d2.content.split(/\s+/).length:0),0);
  const metrics=[
    {label:'Active Tasks',val:active.length,col:active.length>20?'#f59e0b':'#4ade80'},
    {label:'Done Today',val:doneToday.length,col:doneToday.length>0?'#4ade80':'var(--text-muted)'},
    {label:'Overdue',val:overdue.length,col:overdue.length>0?'#ef4444':'#4ade80'},
    {label:'WIP',val:wip.length,col:wip.length>5?'#f59e0b':'#4ade80'},
    {label:'Content Items',val:content.length,col:'#3b82f6'},
    {label:'Writer Docs',val:docs.length,col:'#8b5cf6'},
    {label:'Links',val:links.length,col:'#06b6d4'},
    {label:'Total Words',val:totalWords.toLocaleString(),col:'#4ade80'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Health Dashboard</h3><button onclick="document.getElementById(\'health-dashboard-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
  metrics.forEach(m=>{
    html+='<div style="background:var(--bg-surface);padding:12px;border-radius:6px;text-align:center"><div style="font-size:20px;color:'+m.col+';font-weight:700">'+m.val+'</div><div style="font-size:10px;color:var(--text-muted)">'+m.label+'</div></div>';
  });
  html+='</div>';
  let healthScore=100;
  if(overdue.length>0)healthScore-=overdue.length*5;
  if(wip.length>5)healthScore-=15;
  if(active.length>30)healthScore-=10;
  healthScore=Math.max(0,Math.min(100,healthScore));
  const hCol=healthScore>=80?'#4ade80':healthScore>=50?'#f59e0b':'#ef4444';
  html+='<div style="margin-top:16px;text-align:center;padding:12px;background:var(--bg-surface);border-radius:8px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">System Health</div><div style="font-size:28px;color:'+hCol+';font-weight:700">'+healthScore+'%</div></div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickFontPairing(){
  const d=document.createElement('div');d.id='font-pairing-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px;max-height:70vh;overflow-y:auto';
  const pairings=[
    {heading:'Inter',body:'system-ui',desc:'Clean & modern'},
    {heading:'Georgia',body:'Verdana',desc:'Classic editorial'},
    {heading:'Helvetica',body:'Georgia',desc:'Swiss + serif'},
    {heading:'Futura',body:'Times New Roman',desc:'Modernist contrast'},
    {heading:'Playfair Display',body:'Source Sans Pro',desc:'Elegant + readable'},
    {heading:'Montserrat',body:'Merriweather',desc:'Geometric + traditional'},
    {heading:'Oswald',body:'Lato',desc:'Bold headlines'},
    {heading:'Roboto',body:'Roboto Slab',desc:'Google Material'},
    {heading:'Poppins',body:'Inter',desc:'Friendly & modern'},
    {heading:'Space Grotesk',body:'Space Mono',desc:'Tech / monospace'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Font Pairings</h3><button onclick="document.getElementById(\'font-pairing-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  pairings.forEach(p=>{
    html+='<div onclick="navigator.clipboard.writeText(\'font-family: '+p.heading+', sans-serif;\')" style="padding:10px;background:var(--bg-surface);border-radius:6px;margin-bottom:6px;cursor:pointer" onmouseover="this.style.borderColor=\'#4ade80\'" onmouseout="this.style.borderColor=\'transparent\'">';
    html+='<div style="font-family:'+p.heading+',sans-serif;font-size:16px;color:var(--text-primary);font-weight:700;margin-bottom:2px">'+p.heading+'</div>';
    html+='<div style="font-family:'+p.body+',serif;font-size:12px;color:var(--text-secondary);margin-bottom:4px">Body text in '+p.body+'</div>';
    html+='<div style="font-size:10px;color:var(--text-muted)">'+p.desc+'</div></div>';
  });
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:4px;text-align:center">Click pairing to copy heading font-family</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showKubectlRef(){
  const d=document.createElement('div');d.id='kubectl-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Pods':['kubectl get pods','kubectl get pods -A','kubectl describe pod <name>','kubectl logs <pod>','kubectl exec -it <pod> -- /bin/sh','kubectl delete pod <name>'],
    'Deploy':['kubectl get deployments','kubectl apply -f <file>','kubectl delete -f <file>','kubectl rollout status deploy/<name>','kubectl rollout undo deploy/<name>'],
    'Service':['kubectl get services','kubectl get ingress','kubectl expose deploy <name> --port=80','kubectl port-forward <pod> 8080:80'],
    'Config':['kubectl get configmaps','kubectl get secrets','kubectl create secret generic <name> --from-literal=key=val'],
    'Cluster':['kubectl get nodes','kubectl get namespaces','kubectl cluster-info','kubectl top pods','kubectl top nodes'],
    'Debug':['kubectl get events','kubectl describe node <name>','kubectl api-resources','kubectl config view','kubectl config use-context <ctx>']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">kubectl Reference</h3><button onclick="document.getElementById(\'kubectl-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px;word-break:break-all" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskNetFlow(){
  const d=document.createElement('div');d.id='net-flow-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]);const now=new Date();
  const weeks=[];
  for(let i=7;i>=0;i--){
    const start=new Date(now.getTime()-i*7*86400000);const end=new Date(start.getTime()+7*86400000);
    const created=tasks.filter(t=>t.createdAt&&new Date(t.createdAt)>=start&&new Date(t.createdAt)<end).length;
    const done=tasks.filter(t=>t.status==='done'&&t.updatedAt&&new Date(t.updatedAt)>=start&&new Date(t.updatedAt)<end).length;
    weeks.push({label:i===0?'This Wk':'W-'+i,created,done,net:done-created});
  }
  const mx=Math.max(...weeks.map(w=>Math.max(Math.abs(w.net),w.created,w.done)),1);
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Net Flow (8 weeks)</h3><button onclick="document.getElementById(\'net-flow-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">Positive = clearing backlog. Negative = growing.</div>';
  let svg='<svg width="460" height="200" viewBox="0 0 460 200">';
  svg+='<rect width="460" height="200" fill="var(--bg-surface)" rx="8"/>';
  svg+='<line x1="30" y1="100" x2="450" y2="100" stroke="var(--border)" stroke-width="1" stroke-dasharray="4"/>';
  weeks.forEach((w,i)=>{
    const x=50+i*52;const h=Math.abs(w.net)/mx*80;
    const y=w.net>=0?100-h:100;
    svg+='<rect x="'+x+'" y="'+y+'" width="35" height="'+h+'" fill="'+(w.net>=0?'#4ade80':'#ef4444')+'" rx="3" opacity="0.8"/>';
    svg+='<text x="'+(x+17)+'" y="'+(w.net>=0?y-5:y+h+12)+'" text-anchor="middle" fill="var(--text-secondary)" font-size="10">'+(w.net>0?'+':'')+w.net+'</text>';
    svg+='<text x="'+(x+17)+'" y="195" text-anchor="middle" fill="var(--text-muted)" font-size="8">'+w.label+'</text>';
  });
  svg+='</svg>';
  html+=svg;
  const totalNet=weeks.reduce((s,w)=>s+w.net,0);
  html+='<div style="text-align:center;margin-top:10px;font-size:12px;color:var(--text-muted)">8-week net: <span style="color:'+(totalNet>=0?'#4ade80':'#ef4444')+';font-weight:600">'+(totalNet>0?'+':'')+totalNet+'</span></div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickBorderRadius(){
  const d=document.createElement('div');d.id='border-radius-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px';
  const presets=[
    {label:'None',val:'0px'},
    {label:'Subtle',val:'4px'},
    {label:'Small',val:'8px'},
    {label:'Medium',val:'12px'},
    {label:'Large',val:'16px'},
    {label:'XL',val:'24px'},
    {label:'Pill',val:'9999px'},
    {label:'Circle',val:'50%'},
    {label:'Custom',val:'12px 0 12px 0'},
    {label:'Blob',val:'30% 70% 70% 30% / 30% 30% 70% 70%'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Border Radius</h3><button onclick="document.getElementById(\'border-radius-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  html+='<div id="br-preview" style="width:120px;height:80px;background:#4ade80;border-radius:8px;margin:0 auto 10px;transition:border-radius 0.3s"></div>';
  html+='<div id="br-css" onclick="navigator.clipboard.writeText(this.textContent)" style="padding:6px 8px;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;font-family:monospace;font-size:10px;color:#4ade80;cursor:pointer;text-align:center;margin-bottom:10px">border-radius: 8px;</div>';
  presets.forEach(p=>{
    html+='<div onclick="document.getElementById(\'br-preview\').style.borderRadius=\''+p.val+'\';document.getElementById(\'br-css\').textContent=\'border-radius: '+p.val+';\';" style="display:flex;justify-content:space-between;padding:4px 8px;font-size:11px;cursor:pointer;border-radius:3px;margin-bottom:1px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'"><span style="color:var(--text-secondary)">'+p.label+'</span><span style="color:var(--text-muted);font-family:monospace;font-size:9px">'+p.val+'</span></div>';
  });
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:6px;text-align:center">Click CSS to copy</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showAnsibleRef(){
  const d=document.createElement('div');d.id='ansible-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:520px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Playbook':['ansible-playbook site.yml','ansible-playbook -i hosts site.yml','ansible-playbook --check site.yml','ansible-playbook --tags <tag> site.yml'],
    'Ad-hoc':['ansible all -m ping','ansible all -m shell -a "uptime"','ansible all -m copy -a "src=f dest=f"','ansible all -m apt -a "name=pkg state=present"'],
    'Inventory':['ansible-inventory --list','ansible-inventory --graph','ansible-inventory --host <host>'],
    'Galaxy':['ansible-galaxy init <role>','ansible-galaxy install <role>','ansible-galaxy collection install <ns.coll>','ansible-galaxy list'],
    'Vault':['ansible-vault create <file>','ansible-vault edit <file>','ansible-vault encrypt <file>','ansible-vault decrypt <file>'],
    'Other':['ansible --version','ansible-doc -l','ansible-doc <module>','ansible-config dump','ansible-lint']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Ansible Reference</h3><button onclick="document.getElementById(\'ansible-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskAbandonedReport(){
  const d=document.createElement('div');d.id='abandoned-report-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.status!=='done');
  const now=Date.now();
  const abandoned=tasks.filter(t=>{
    const updated=t.updatedAt?new Date(t.updatedAt).getTime():(t.createdAt?new Date(t.createdAt).getTime():now);
    return(now-updated)>14*86400000;
  }).sort((a,b)=>{
    const aT=a.updatedAt?new Date(a.updatedAt).getTime():0;
    const bT=b.updatedAt?new Date(b.updatedAt).getTime():0;
    return aT-bT;
  });
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Abandoned Tasks (14d+)</h3><button onclick="document.getElementById(\'abandoned-report-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  html+='<div style="margin-bottom:12px;font-size:12px;color:var(--text-muted)">'+abandoned.length+' tasks untouched for 14+ days</div>';
  if(abandoned.length){
    abandoned.forEach(t=>{
      const updated=t.updatedAt?new Date(t.updatedAt):new Date(t.createdAt||now);
      const days=Math.floor((now-updated.getTime())/86400000);
      const col=days>30?'#ef4444':days>21?'#f59e0b':'#6366f1';
      html+='<div style="padding:8px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px;border-left:3px solid '+col+'">';
      html+='<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;color:var(--text-primary)">'+esc(t.title)+'</span><span style="font-size:11px;color:'+col+';font-weight:600">'+days+'d</span></div>';
      html+='<div style="font-size:10px;color:var(--text-muted);margin-top:2px">Last: '+updated.toLocaleDateString()+'</div></div>';
    });
  } else {
    html+='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px">No abandoned tasks! Everything is actively worked on.</div>';
  }
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickFlexboxHelper(){
  const d=document.createElement('div');d.id='flexbox-helper-panel';
  d.style.cssText='position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px;max-height:70vh;overflow-y:auto';
  const configs=[
    {label:'Center All',css:'display:flex;align-items:center;justify-content:center'},
    {label:'Space Between',css:'display:flex;justify-content:space-between;align-items:center'},
    {label:'Stack Vertical',css:'display:flex;flex-direction:column;gap:8px'},
    {label:'Wrap Grid',css:'display:flex;flex-wrap:wrap;gap:8px'},
    {label:'Sidebar + Content',css:'display:flex;gap:16px /* child1: width:250px; child2: flex:1 */'},
    {label:'Sticky Footer',css:'display:flex;flex-direction:column;min-height:100vh /* footer: margin-top:auto */'},
    {label:'Equal Width',css:'display:flex;gap:8px /* children: flex:1 */'},
    {label:'Right Align',css:'display:flex;justify-content:flex-end;gap:8px'},
    {label:'Baseline Align',css:'display:flex;align-items:baseline;gap:12px'},
    {label:'Reverse Row',css:'display:flex;flex-direction:row-reverse;gap:8px'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">Flexbox Helper</h3><button onclick="document.getElementById(\'flexbox-helper-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  configs.forEach(c=>{
    html+='<div onclick="navigator.clipboard.writeText(\''+c.css.replace(/'/g,"\\'")+'\');this.style.borderColor=\'#4ade80\';setTimeout(()=>this.style.borderColor=\'var(--border)\',600)" style="padding:8px;border:1px solid var(--border);border-radius:6px;margin-bottom:4px;cursor:pointer">';
    html+='<div style="font-size:12px;color:var(--text-primary);font-weight:600;margin-bottom:4px">'+c.label+'</div>';
    html+='<div style="font-size:10px;color:#4ade80;font-family:monospace;word-break:break-all">'+c.css+'</div></div>';
  });
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:4px;text-align:center">Click any to copy CSS</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showNginxRef(){
  const d=document.createElement('div');d.id='nginx-ref-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw;max-height:75vh;overflow-y:auto';
  const cats={
    'Service':['sudo systemctl start nginx','sudo systemctl stop nginx','sudo systemctl restart nginx','sudo systemctl reload nginx','sudo systemctl status nginx'],
    'Config':['nginx -t','nginx -T','nginx -s reload','nginx -s stop','nginx -V'],
    'Common Directives':['server { listen 80; }','location / { proxy_pass http://localhost:3000; }','root /var/www/html;','index index.html;','try_files $uri $uri/ /index.html;'],
    'SSL':['ssl_certificate /path/cert.pem;','ssl_certificate_key /path/key.pem;','listen 443 ssl;','ssl_protocols TLSv1.2 TLSv1.3;'],
    'Locations':['location /api { proxy_pass http://backend; }','location ~* \\.(jpg|png)$ { expires 30d; }','location = /health { return 200; }'],
    'Logs':['access_log /var/log/nginx/access.log;','error_log /var/log/nginx/error.log;','tail -f /var/log/nginx/access.log']
  };
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">nginx Reference</h3><button onclick="document.getElementById(\'nginx-ref-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  Object.entries(cats).forEach(([cat,cmds])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px">'+cat+'</div>';
    cmds.forEach(c=>{
      html+='<div onclick="navigator.clipboard.writeText(\''+c.replace(/\\/g,'\\\\').replace(/'/g,"\\'")+'\');this.style.color=\'#4ade80\';setTimeout(()=>this.style.color=\'\',600)" style="padding:5px 8px;font-family:monospace;font-size:11px;color:var(--text-secondary);cursor:pointer;border-radius:4px;margin-bottom:2px;word-break:break-all" onmouseover="this.style.background=\'var(--bg-surface)\'" onmouseout="this.style.background=\'none\'">'+c+'</div>';
    });
    html+='</div>';
  });
  d.innerHTML=html;document.body.appendChild(d);
}
function showTaskEstimateAccuracy2(){
  const d=document.createElement('div');d.id='estimate-acc2-panel';
  d.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:480px;width:90vw;max-height:75vh;overflow-y:auto';
  const tasks=(S.tasks||[]).filter(t=>t.estimate&&t.status==='done'&&t.timeTracked);
  let accurate=0;let over=0;let under=0;
  tasks.forEach(t=>{
    const est=t.estimate.toLowerCase();let estMins=0;
    if(est.includes('h'))estMins=parseFloat(est)*60;else estMins=parseFloat(est);
    const actual=t.timeTracked/60;
    if(isNaN(estMins)||estMins===0)return;
    const ratio=actual/estMins;
    if(ratio>=0.8&&ratio<=1.2)accurate++;
    else if(ratio>1.2)under++;
    else over++;
  });
  const total=accurate+over+under;const pct=total?Math.round(accurate/total*100):0;
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Estimate Accuracy</h3><button onclick="document.getElementById(\'estimate-acc2-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">&times;</button></div>';
  const col=pct>=70?'#4ade80':pct>=40?'#f59e0b':'#ef4444';
  html+='<div style="text-align:center;margin-bottom:16px"><div style="font-size:42px;color:'+col+';font-weight:700">'+pct+'%</div><div style="font-size:12px;color:var(--text-muted)">estimates within 20% of actual</div></div>';
  html+='<div style="display:flex;gap:12px;justify-content:center;margin-bottom:16px">';
  html+='<div style="text-align:center;background:var(--bg-surface);padding:10px 16px;border-radius:6px"><div style="font-size:18px;color:#4ade80;font-weight:700">'+accurate+'</div><div style="font-size:10px;color:var(--text-muted)">Accurate</div></div>';
  html+='<div style="text-align:center;background:var(--bg-surface);padding:10px 16px;border-radius:6px"><div style="font-size:18px;color:#f59e0b;font-weight:700">'+under+'</div><div style="font-size:10px;color:var(--text-muted)">Underestimated</div></div>';
  html+='<div style="text-align:center;background:var(--bg-surface);padding:10px 16px;border-radius:6px"><div style="font-size:18px;color:#3b82f6;font-weight:700">'+over+'</div><div style="font-size:10px;color:var(--text-muted)">Overestimated</div></div></div>';
  if(!total)html+='<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:12px">Complete tasks with both estimates and time tracking to see accuracy.</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showQuickGridHelper(){
  const d=document.createElement('div');d.id='grid-helper-panel';
  d.style.cssText='position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:320px;max-height:70vh;overflow-y:auto';
  const configs=[
    {label:'2 Columns',css:'display:grid;grid-template-columns:1fr 1fr;gap:16px'},
    {label:'3 Columns',css:'display:grid;grid-template-columns:repeat(3,1fr);gap:16px'},
    {label:'4 Columns',css:'display:grid;grid-template-columns:repeat(4,1fr);gap:16px'},
    {label:'Auto Fill',css:'display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px'},
    {label:'Auto Fit',css:'display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px'},
    {label:'Sidebar',css:'display:grid;grid-template-columns:250px 1fr;gap:16px'},
    {label:'Holy Grail',css:'display:grid;grid-template-columns:200px 1fr 200px;grid-template-rows:auto 1fr auto;gap:16px'},
    {label:'Masonry-ish',css:'display:grid;grid-template-columns:repeat(3,1fr);gap:16px;grid-auto-rows:minmax(100px,auto)'},
    {label:'Centered',css:'display:grid;place-items:center;min-height:100vh'},
    {label:'12 Col Grid',css:'display:grid;grid-template-columns:repeat(12,1fr);gap:8px'}
  ];
  let html='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h3 style="margin:0;color:#4ade80;font-size:14px">CSS Grid Helper</h3><button onclick="document.getElementById(\'grid-helper-panel\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer">&times;</button></div>';
  configs.forEach(c=>{
    html+='<div onclick="navigator.clipboard.writeText(\''+c.css.replace(/'/g,"\\'")+'\');this.style.borderColor=\'#4ade80\';setTimeout(()=>this.style.borderColor=\'var(--border)\',600)" style="padding:8px;border:1px solid var(--border);border-radius:6px;margin-bottom:4px;cursor:pointer">';
    html+='<div style="font-size:12px;color:var(--text-primary);font-weight:600;margin-bottom:4px">'+c.label+'</div>';
    html+='<div style="font-size:10px;color:#4ade80;font-family:monospace;word-break:break-all">'+c.css+'</div></div>';
  });
  html+='<div style="font-size:9px;color:var(--text-muted);margin-top:4px;text-align:center">Click any to copy CSS</div>';
  d.innerHTML=html;document.body.appendChild(d);
}
function showTerraformRef(){
  const cmds={
    'Init & Plan':['terraform init|Initialize working directory','terraform plan|Preview changes before apply','terraform plan -out=plan.tfplan|Save plan to file','terraform apply plan.tfplan|Apply saved plan'],
    'Apply & Destroy':['terraform apply|Apply changes to infrastructure','terraform apply -auto-approve|Apply without confirmation prompt','terraform destroy|Destroy all managed infrastructure','terraform destroy -target=aws_instance.web|Destroy specific resource'],
    'State':['terraform state list|List all resources in state','terraform state show aws_instance.web|Show details of a resource','terraform state mv old new|Rename resource in state','terraform state rm aws_instance.web|Remove resource from state','terraform state pull|Download remote state'],
    'Workspace':['terraform workspace list|List all workspaces','terraform workspace new staging|Create new workspace','terraform workspace select prod|Switch to workspace','terraform workspace delete staging|Delete workspace'],
    'Import & Format':['terraform import aws_instance.web i-abc123|Import existing resource','terraform fmt|Format .tf files','terraform fmt -recursive|Format all subdirectories','terraform validate|Validate configuration syntax'],
    'Output & Graph':['terraform output|Show all outputs','terraform output -json|Outputs as JSON','terraform graph|Generate dependency graph DOT','terraform providers|List required providers']
  };
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Terraform Reference</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  Object.entries(cmds).forEach(([cat,list])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">'+cat+'</div>';
    list.forEach(c=>{const[cmd,desc]=c.split('|');html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:3px;cursor:pointer" onclick="navigator.clipboard.writeText(\''+cmd.replace(/'/g,"\\'")+'\');this.style.background=\'#4ade8033\';setTimeout(()=>this.style.background=\'var(--bg-surface)\',500)"><code style="color:#4ade80;font-size:12px">'+cmd+'</code><span style="color:var(--text-muted);font-size:11px">'+desc+'</span></div>';});
    html+='</div>';
  });
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
}
function showTaskDayOfWeekHeatmap(){
  const tasks=(S.tasks||[]);
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const created=new Array(7).fill(0);
  const completed=new Array(7).fill(0);
  tasks.forEach(t=>{
    if(t.createdAt){const d=new Date(t.createdAt).getDay();created[d]++;}
    if(t.status==='done'&&t.updatedAt){const d=new Date(t.updatedAt).getDay();completed[d]++;}
  });
  const maxC=Math.max(...created,1);const maxD=Math.max(...completed,1);
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Day-of-Week Heatmap</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">Tasks created &amp; completed by day of week</div>';
  html+='<div style="display:grid;grid-template-columns:50px 1fr 1fr;gap:4px;margin-bottom:16px">';
  html+='<div style="font-size:10px;color:var(--text-muted)"></div><div style="font-size:10px;color:var(--text-muted);text-align:center">Created</div><div style="font-size:10px;color:var(--text-muted);text-align:center">Completed</div>';
  days.forEach((day,i)=>{
    const cInt=Math.round((created[i]/maxC)*255);
    const dInt=Math.round((completed[i]/maxD)*255);
    html+='<div style="font-size:12px;color:var(--text-secondary);padding:8px 4px">'+day+'</div>';
    html+='<div style="background:rgba(74,222,128,'+((created[i]/maxC)*0.8).toFixed(2)+');border-radius:6px;padding:8px;text-align:center;color:#fff;font-size:13px;font-weight:600">'+created[i]+'</div>';
    html+='<div style="background:rgba(96,165,250,'+((completed[i]/maxD)*0.8).toFixed(2)+');border-radius:6px;padding:8px;text-align:center;color:#fff;font-size:13px;font-weight:600">'+completed[i]+'</div>';
  });
  html+='</div>';
  const busiestCreate=days[created.indexOf(Math.max(...created))];
  const busiestDone=days[completed.indexOf(Math.max(...completed))];
  html+='<div style="display:flex;gap:12px"><div style="flex:1;background:var(--bg-surface);border-radius:8px;padding:10px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">Most Created</div><div style="font-size:16px;color:#4ade80;font-weight:700">'+busiestCreate+'</div></div>';
  html+='<div style="flex:1;background:var(--bg-surface);border-radius:8px;padding:10px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">Most Completed</div><div style="font-size:16px;color:#60a5fa;font-weight:700">'+busiestDone+'</div></div></div>';
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
}
function showQuickLoremGenerator(){
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Lorem Ipsum Generator</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  html+='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
  const presets=[{l:'1 Paragraph',n:1},{l:'3 Paragraphs',n:3},{l:'5 Paragraphs',n:5},{l:'10 Sentences',n:-10},{l:'50 Words',n:-50}];
  presets.forEach(p=>{html+='<button onclick="window._genLorem('+p.n+')" style="background:var(--bg-surface);border:1px solid var(--border);color:var(--text-secondary);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:11px">'+p.l+'</button>';});
  html+='</div>';
  html+='<textarea id="_lorem-out" readonly style="width:100%;height:200px;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-primary);border-radius:8px;padding:10px;font-size:12px;resize:vertical;font-family:inherit" placeholder="Click a preset above..."></textarea>';
  html+='<button onclick="const t=document.getElementById(\'_lorem-out\');navigator.clipboard.writeText(t.value);this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy\',800)" style="margin-top:8px;background:#4ade80;color:#000;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px">Copy</button>';
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
  const words='lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua ut enim ad minim veniam quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur excepteur sint occaecat cupidatat non proident sunt in culpa qui officia deserunt mollit anim id est laborum'.split(' ');
  window._genLorem=function(n){
    const out=document.getElementById('_lorem-out');if(!out)return;
    function randSentence(){let len=8+Math.floor(Math.random()*12);let s='';for(let i=0;i<len;i++){s+=(i===0?'':' ')+words[Math.floor(Math.random()*words.length)];}return s.charAt(0).toUpperCase()+s.slice(1)+'.';}
    function randParagraph(){let cnt=4+Math.floor(Math.random()*4);let p='';for(let i=0;i<cnt;i++){p+=(i===0?'':' ')+randSentence();}return p;}
    if(n>0){let r=[];for(let i=0;i<n;i++)r.push(randParagraph());out.value=r.join('\n\n');}
    else if(n<=-10 && n>-50){let r=[];for(let i=0;i<Math.abs(n);i++)r.push(randSentence());out.value=r.join(' ');}
    else{let target=Math.abs(n);let r='';while(r.split(/\s+/).length<target){r+=(r?' ':'')+words[Math.floor(Math.random()*words.length)];}out.value=r.split(/\s+/).slice(0,target).join(' ')+'.';}
  };
}
function showPulumiRef(){
  const cmds={
    'Stack Management':['pulumi new|Create a new Pulumi project','pulumi stack init staging|Create a new stack','pulumi stack select prod|Switch to stack','pulumi stack ls|List all stacks','pulumi stack rm staging|Remove a stack','pulumi stack export > state.json|Export stack state'],
    'Deploy & Preview':['pulumi preview|Preview changes without applying','pulumi up|Deploy infrastructure changes','pulumi up --yes|Deploy without confirmation','pulumi up --diff|Show detailed diff on deploy','pulumi destroy|Tear down all resources','pulumi destroy --yes|Tear down without confirmation'],
    'Config & Secrets':['pulumi config set key value|Set a config value','pulumi config set --secret dbPass s3cret|Set encrypted secret','pulumi config get key|Get a config value','pulumi config rm key|Remove config value','pulumi config|List all config values'],
    'State & Import':['pulumi state delete urn|Remove resource from state','pulumi import aws:s3:Bucket myBucket id|Import existing resource','pulumi refresh|Reconcile state with cloud','pulumi stack graph graph.dot|Generate dependency graph'],
    'Info':['pulumi whoami|Show current user','pulumi version|Show Pulumi version','pulumi about|Show environment info','pulumi logs|Show resource logs']
  };
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Pulumi Reference</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  Object.entries(cmds).forEach(([cat,list])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">'+cat+'</div>';
    list.forEach(c=>{const[cmd,desc]=c.split('|');html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:3px;cursor:pointer" onclick="navigator.clipboard.writeText(\''+cmd.replace(/'/g,"\\'")+'\');this.style.background=\'#4ade8033\';setTimeout(()=>this.style.background=\'var(--bg-surface)\',500)"><code style="color:#4ade80;font-size:12px">'+cmd+'</code><span style="color:var(--text-muted);font-size:11px">'+desc+'</span></div>';});
    html+='</div>';
  });
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
}
function showTaskCreationHourChart(){
  const tasks=(S.tasks||[]);
  const hours=new Array(24).fill(0);
  tasks.forEach(t=>{if(t.createdAt){const h=new Date(t.createdAt).getHours();hours[h]++;}});
  const maxH=Math.max(...hours,1);
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Task Creation by Hour</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">When do you create tasks? (24-hour distribution)</div>';
  html+='<svg viewBox="0 0 520 180" style="width:100%;margin-bottom:16px">';
  hours.forEach((count,i)=>{
    const bw=18;const gap=3.5;const x=i*(bw+gap)+10;const h=(count/maxH)*130;const y=150-h;
    const color=i>=6&&i<12?'#4ade80':i>=12&&i<18?'#60a5fa':i>=18&&i<22?'#f59e0b':'#6b7280';
    html+='<rect x="'+x+'" y="'+y+'" width="'+bw+'" height="'+h+'" fill="'+color+'" rx="3" opacity="0.85"/>';
    if(count>0)html+='<text x="'+(x+bw/2)+'" y="'+(y-4)+'" fill="var(--text-muted)" font-size="8" text-anchor="middle">'+count+'</text>';
    html+='<text x="'+(x+bw/2)+'" y="166" fill="var(--text-muted)" font-size="7" text-anchor="middle">'+(i<10?'0':'')+i+'</text>';
  });
  html+='</svg>';
  html+='<div style="display:flex;gap:10px;flex-wrap:wrap;font-size:10px;margin-bottom:12px">';
  html+='<span style="color:#4ade80">Morning (6-12)</span><span style="color:#60a5fa">Afternoon (12-18)</span><span style="color:#f59e0b">Evening (18-22)</span><span style="color:#6b7280">Night (22-6)</span>';
  html+='</div>';
  const peakHour=hours.indexOf(Math.max(...hours));
  const totalMorn=hours.slice(6,12).reduce((a,b)=>a+b,0);const totalAft=hours.slice(12,18).reduce((a,b)=>a+b,0);
  const totalEve=hours.slice(18,22).reduce((a,b)=>a+b,0);const totalNight=hours.slice(22).reduce((a,b)=>a+b,0)+hours.slice(0,6).reduce((a,b)=>a+b,0);
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div style="background:var(--bg-surface);border-radius:8px;padding:10px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">Peak Hour</div><div style="font-size:18px;color:#4ade80;font-weight:700">'+(peakHour<10?'0':'')+peakHour+':00</div></div>';
  html+='<div style="background:var(--bg-surface);border-radius:8px;padding:10px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">Busiest Period</div><div style="font-size:14px;color:#60a5fa;font-weight:700">'+([totalMorn,totalAft,totalEve,totalNight].indexOf(Math.max(totalMorn,totalAft,totalEve,totalNight))===0?'Morning':([totalMorn,totalAft,totalEve,totalNight].indexOf(Math.max(totalMorn,totalAft,totalEve,totalNight))===1?'Afternoon':([totalMorn,totalAft,totalEve,totalNight].indexOf(Math.max(totalMorn,totalAft,totalEve,totalNight))===2?'Evening':'Night')))+'</div></div></div>';
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
}
function showQuickPasswordGenerator(){
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:450px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Password Generator</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  html+='<div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px;text-align:center"><code id="_pw-output" style="font-size:18px;color:#4ade80;letter-spacing:1px;word-break:break-all">Click Generate</code></div>';
  html+='<div style="margin-bottom:12px"><label style="font-size:11px;color:var(--text-muted)">Length: <span id="_pw-len-val">16</span></label><input id="_pw-len" type="range" min="8" max="64" value="16" oninput="document.getElementById(\'_pw-len-val\').textContent=this.value" style="width:100%;accent-color:#4ade80"></div>';
  html+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">';
  html+='<label style="font-size:11px;color:var(--text-secondary);display:flex;align-items:center;gap:4px"><input type="checkbox" id="_pw-upper" checked> Uppercase</label>';
  html+='<label style="font-size:11px;color:var(--text-secondary);display:flex;align-items:center;gap:4px"><input type="checkbox" id="_pw-lower" checked> Lowercase</label>';
  html+='<label style="font-size:11px;color:var(--text-secondary);display:flex;align-items:center;gap:4px"><input type="checkbox" id="_pw-nums" checked> Numbers</label>';
  html+='<label style="font-size:11px;color:var(--text-secondary);display:flex;align-items:center;gap:4px"><input type="checkbox" id="_pw-syms" checked> Symbols</label>';
  html+='</div>';
  html+='<div style="display:flex;gap:8px"><button onclick="window._genPw()" style="flex:1;background:#4ade80;color:#000;border:none;padding:10px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px">Generate</button>';
  html+='<button onclick="navigator.clipboard.writeText(document.getElementById(\'_pw-output\').textContent);this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\'Copy\',800)" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-secondary);padding:10px;border-radius:6px;cursor:pointer;font-size:13px">Copy</button></div>';
  html+='<div style="margin-top:12px"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Strength</div><div id="_pw-strength" style="height:6px;border-radius:3px;background:var(--bg-surface)"></div><div id="_pw-str-label" style="font-size:10px;color:var(--text-muted);margin-top:4px;text-align:right"></div></div>';
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
  window._genPw=function(){
    const len=parseInt(document.getElementById('_pw-len').value);
    let chars='';
    if(document.getElementById('_pw-upper').checked)chars+='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    if(document.getElementById('_pw-lower').checked)chars+='abcdefghijklmnopqrstuvwxyz';
    if(document.getElementById('_pw-nums').checked)chars+='0123456789';
    if(document.getElementById('_pw-syms').checked)chars+='!@#$%^&*()_+-=[]{}|;:,.<>?';
    if(!chars)chars='abcdefghijklmnopqrstuvwxyz';
    const arr=new Uint32Array(len);crypto.getRandomValues(arr);
    let pw='';for(let i=0;i<len;i++)pw+=chars[arr[i]%chars.length];
    document.getElementById('_pw-output').textContent=pw;
    const strength=len>=32?100:len>=20?80:len>=16?60:len>=12?40:20;
    const bar=document.getElementById('_pw-strength');
    const label=document.getElementById('_pw-str-label');
    const color=strength>=80?'#4ade80':strength>=60?'#60a5fa':strength>=40?'#f59e0b':'#ef4444';
    bar.innerHTML='<div style="width:'+strength+'%;height:100%;background:'+color+';border-radius:3px;transition:width 0.3s"></div>';
    label.textContent=strength>=80?'Very Strong':strength>=60?'Strong':strength>=40?'Medium':'Weak';
    label.style.color=color;
  };
  window._genPw();
}
function showVagrantRef(){
  const cmds={
    'Box Management':['vagrant box add ubuntu/focal64|Download a box from catalog','vagrant box list|List installed boxes','vagrant box remove ubuntu/focal64|Remove a local box','vagrant box update|Update box to latest version','vagrant box outdated|Check if box is outdated'],
    'VM Lifecycle':['vagrant init ubuntu/focal64|Create a new Vagrantfile','vagrant up|Start and provision the VM','vagrant halt|Gracefully shut down the VM','vagrant destroy|Delete the VM completely','vagrant reload|Restart VM (applies Vagrantfile changes)','vagrant suspend|Suspend the VM (save state)','vagrant resume|Resume a suspended VM'],
    'Access & Info':['vagrant ssh|SSH into the running VM','vagrant status|Show VM status','vagrant global-status|Show all VMs on this host','vagrant port|Show port mappings','vagrant ssh-config|Print SSH config for use with ssh command'],
    'Provisioning':['vagrant provision|Re-run provisioners','vagrant up --provision|Start with forced provisioning','vagrant up --no-provision|Start without provisioning'],
    'Snapshots':['vagrant snapshot save mysnap|Save a snapshot','vagrant snapshot restore mysnap|Restore a snapshot','vagrant snapshot list|List all snapshots','vagrant snapshot delete mysnap|Delete a snapshot'],
    'Plugins':['vagrant plugin install NAME|Install a plugin','vagrant plugin list|List installed plugins','vagrant plugin uninstall NAME|Remove a plugin']
  };
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Vagrant Reference</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  Object.entries(cmds).forEach(([cat,list])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">'+cat+'</div>';
    list.forEach(c=>{const[cmd,desc]=c.split('|');html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:3px;cursor:pointer" onclick="navigator.clipboard.writeText(\''+cmd.replace(/'/g,"\\'")+'\');this.style.background=\'#4ade8033\';setTimeout(()=>this.style.background=\'var(--bg-surface)\',500)"><code style="color:#4ade80;font-size:12px">'+cmd+'</code><span style="color:var(--text-muted);font-size:11px">'+desc+'</span></div>';});
    html+='</div>';
  });
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
}
function showTaskCompletionRate(){
  const tasks=(S.tasks||[]);
  const now=new Date();const weeks=[];
  for(let w=7;w>=0;w--){
    const weekStart=new Date(now);weekStart.setDate(now.getDate()-now.getDay()-w*7);
    const weekEnd=new Date(weekStart);weekEnd.setDate(weekStart.getDate()+6);
    let created=0,completed=0;
    tasks.forEach(t=>{
      const cd=t.createdAt?new Date(t.createdAt):null;
      const ud=t.updatedAt?new Date(t.updatedAt):null;
      if(cd&&cd>=weekStart&&cd<=weekEnd)created++;
      if(t.status==='done'&&ud&&ud>=weekStart&&ud<=weekEnd)completed++;
    });
    weeks.push({label:(weekStart.getMonth()+1)+'/'+weekStart.getDate(),created,completed,rate:created>0?Math.round((completed/created)*100):0});
  }
  const maxVal=Math.max(...weeks.map(w=>Math.max(w.created,w.completed)),1);
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Weekly Completion Rate</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  html+='<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">Created vs completed per week (last 8 weeks)</div>';
  html+='<svg viewBox="0 0 520 180" style="width:100%;margin-bottom:16px">';
  weeks.forEach((w,i)=>{
    const gw=56;const x=i*gw+20;const bw=20;
    const hC=(w.created/maxVal)*130;const hD=(w.completed/maxVal)*130;
    html+='<rect x="'+x+'" y="'+(150-hC)+'" width="'+bw+'" height="'+hC+'" fill="#4ade80" rx="3" opacity="0.7"/>';
    html+='<rect x="'+(x+bw+2)+'" y="'+(150-hD)+'" width="'+bw+'" height="'+hD+'" fill="#60a5fa" rx="3" opacity="0.7"/>';
    html+='<text x="'+(x+bw+1)+'" y="168" fill="var(--text-muted)" font-size="8" text-anchor="middle">'+w.label+'</text>';
    if(w.rate>0)html+='<text x="'+(x+bw+1)+'" y="'+(Math.min(150-hC,150-hD)-6)+'" fill="var(--text-secondary)" font-size="8" text-anchor="middle">'+w.rate+'%</text>';
  });
  html+='</svg>';
  html+='<div style="display:flex;gap:12px;font-size:10px;margin-bottom:12px"><span><span style="display:inline-block;width:10px;height:10px;background:#4ade80;border-radius:2px;margin-right:4px"></span>Created</span><span><span style="display:inline-block;width:10px;height:10px;background:#60a5fa;border-radius:2px;margin-right:4px"></span>Completed</span></div>';
  const avgRate=weeks.length>0?Math.round(weeks.reduce((a,w)=>a+w.rate,0)/weeks.length):0;
  const thisWeek=weeks[weeks.length-1];
  html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px"><div style="background:var(--bg-surface);border-radius:8px;padding:10px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">Avg Rate</div><div style="font-size:18px;color:#4ade80;font-weight:700">'+avgRate+'%</div></div>';
  html+='<div style="background:var(--bg-surface);border-radius:8px;padding:10px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">This Week</div><div style="font-size:18px;color:#60a5fa;font-weight:700">'+thisWeek.rate+'%</div></div>';
  html+='<div style="background:var(--bg-surface);border-radius:8px;padding:10px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">Trend</div><div style="font-size:18px;font-weight:700;color:'+(thisWeek.rate>=avgRate?'#4ade80':'#ef4444')+'">'+(thisWeek.rate>=avgRate?'Up':'Down')+'</div></div></div>';
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
}
function showQuickCountdownTimer(){
  let html='<div style="position:fixed;bottom:20px;right:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:280px">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:#4ade80;font-size:13px">Countdown Timer</h4><button onclick="if(window._cdInterval)clearInterval(window._cdInterval);this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:16px;cursor:pointer">X</button></div>';
  html+='<div id="_cd-display" style="text-align:center;font-size:36px;color:#4ade80;font-weight:700;font-family:monospace;margin-bottom:12px">00:00</div>';
  html+='<div style="display:flex;gap:6px;margin-bottom:10px">';
  [5,10,15,25,30,60].forEach(m=>{
    html+='<button onclick="window._startCd('+m+')" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-secondary);padding:6px 2px;border-radius:6px;cursor:pointer;font-size:10px">'+m+'m</button>';
  });
  html+='</div>';
  html+='<div style="display:flex;gap:6px"><input id="_cd-custom" type="number" min="1" max="999" placeholder="Min" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-primary);padding:6px 8px;border-radius:6px;font-size:12px">';
  html+='<button onclick="const v=parseInt(document.getElementById(\'_cd-custom\').value);if(v>0)window._startCd(v)" style="background:#4ade80;color:#000;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:11px">Start</button></div>';
  html+='<div style="display:flex;gap:6px;margin-top:8px"><button id="_cd-pause" onclick="window._pauseCd()" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-secondary);padding:6px;border-radius:6px;cursor:pointer;font-size:11px;display:none">Pause</button>';
  html+='<button onclick="window._resetCd()" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-secondary);padding:6px;border-radius:6px;cursor:pointer;font-size:11px">Reset</button></div>';
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
  window._cdSeconds=0;window._cdPaused=false;
  window._startCd=function(mins){
    if(window._cdInterval)clearInterval(window._cdInterval);
    window._cdSeconds=mins*60;window._cdPaused=false;
    const pb=document.getElementById('_cd-pause');if(pb){pb.style.display='block';pb.textContent='Pause';}
    window._cdInterval=setInterval(()=>{
      if(window._cdPaused)return;
      window._cdSeconds--;
      const disp=document.getElementById('_cd-display');
      if(disp){const m=Math.floor(window._cdSeconds/60);const s=window._cdSeconds%60;disp.textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;}
      if(window._cdSeconds<=0){clearInterval(window._cdInterval);if(disp){disp.textContent='DONE!';disp.style.color='#ef4444';}try{new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ==').play();}catch(e){}}
    },1000);
    const disp=document.getElementById('_cd-display');if(disp){disp.style.color='#4ade80';const m=Math.floor(window._cdSeconds/60);const s=window._cdSeconds%60;disp.textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;}
  };
  window._pauseCd=function(){
    window._cdPaused=!window._cdPaused;
    const pb=document.getElementById('_cd-pause');if(pb)pb.textContent=window._cdPaused?'Resume':'Pause';
    const disp=document.getElementById('_cd-display');if(disp)disp.style.color=window._cdPaused?'#f59e0b':'#4ade80';
  };
  window._resetCd=function(){
    if(window._cdInterval)clearInterval(window._cdInterval);window._cdSeconds=0;window._cdPaused=false;
    const disp=document.getElementById('_cd-display');if(disp){disp.textContent='00:00';disp.style.color='#4ade80';}
    const pb=document.getElementById('_cd-pause');if(pb)pb.style.display='none';
  };
}
function showPackerRef(){
  const cmds={
    'Build':['packer build template.pkr.hcl|Build image from template','packer build -var "region=us-east-1" .|Build with variable','packer build -only=amazon-ebs .|Build only specific source','packer build -force .|Force overwrite existing artifacts','packer build -on-error=ask .|Ask what to do on error'],
    'Init & Validate':['packer init .|Install required plugins','packer validate template.pkr.hcl|Validate template syntax','packer validate -var-file=vars.pkrvars.hcl .|Validate with var file','packer fmt -recursive .|Format all HCL files'],
    'Inspect':['packer inspect template.pkr.hcl|Show template components','packer hcl2_upgrade template.json|Convert JSON to HCL2'],
    'Plugins':['packer plugins install github.com/hashicorp/amazon|Install plugin','packer plugins installed|List installed plugins','packer plugins remove github.com/hashicorp/amazon|Remove plugin'],
    'Console':['packer console|Interactive console for expressions','packer console -var-file=vars.pkrvars.hcl|Console with variables']
  };
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:700px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Packer Reference</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  Object.entries(cmds).forEach(([cat,list])=>{
    html+='<div style="margin-bottom:14px"><div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">'+cat+'</div>';
    list.forEach(c=>{const[cmd,desc]=c.split('|');html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:3px;cursor:pointer" onclick="navigator.clipboard.writeText(\''+cmd.replace(/'/g,"\\'")+'\');this.style.background=\'#4ade8033\';setTimeout(()=>this.style.background=\'var(--bg-surface)\',500)"><code style="color:#4ade80;font-size:12px">'+cmd+'</code><span style="color:var(--text-muted);font-size:11px">'+desc+'</span></div>';});
    html+='</div>';
  });
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
}
function showTaskOverdueHistory(){
  const tasks=(S.tasks||[]);const now=new Date();const today=now.toISOString().split('T')[0];
  const overdue=tasks.filter(t=>t.status!=='done'&&t.due&&t.due<today);
  const pastOverdue=tasks.filter(t=>t.status==='done'&&t.due&&t.updatedAt&&t.due<t.updatedAt.split('T')[0]);
  let html='<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:550px;width:90vw;max-height:80vh;overflow-y:auto">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:#4ade80">Overdue History</h3><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer">X</button></div>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">';
  html+='<div style="background:var(--bg-surface);border-radius:8px;padding:12px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">Currently Overdue</div><div style="font-size:24px;color:#ef4444;font-weight:700">'+overdue.length+'</div></div>';
  html+='<div style="background:var(--bg-surface);border-radius:8px;padding:12px;text-align:center"><div style="font-size:10px;color:var(--text-muted)">Completed Late</div><div style="font-size:24px;color:#f59e0b;font-weight:700">'+pastOverdue.length+'</div></div></div>';
  if(overdue.length>0){
    html+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase">Currently Overdue</div>';
    overdue.sort((a,b)=>a.due.localeCompare(b.due)).slice(0,15).forEach(t=>{
      const days=Math.floor((now-new Date(t.due))/(86400000));
      const color=days>7?'#ef4444':days>3?'#f59e0b':'#fb923c';
      html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px;border-left:3px solid '+color+'">';
      html+='<span style="color:var(--text-primary);font-size:12px">'+esc(t.title)+'</span>';
      html+='<span style="color:'+color+';font-size:11px;font-weight:600">'+days+'d overdue</span></div>';
    });
  }
  if(pastOverdue.length>0){
    html+='<div style="font-size:11px;color:var(--text-muted);margin:12px 0 8px;text-transform:uppercase">Completed Late (last 10)</div>';
    pastOverdue.sort((a,b)=>(b.updatedAt||'').localeCompare(a.updatedAt||'')).slice(0,10).forEach(t=>{
      const daysLate=Math.floor((new Date(t.updatedAt)-new Date(t.due))/(86400000));
      html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg-surface);border-radius:6px;margin-bottom:4px;border-left:3px solid #f59e0b">';
      html+='<span style="color:var(--text-secondary);font-size:12px">'+esc(t.title)+'</span>';
      html+='<span style="color:#f59e0b;font-size:11px">'+daysLate+'d late</span></div>';
    });
  }
  if(overdue.length===0&&pastOverdue.length===0){html+='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">No overdue tasks! Great job.</div>';}
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
}
function showQuickStopwatch(){
  let html='<div style="position:fixed;bottom:20px;left:20px;z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 12px 48px rgba(0,0,0,0.7);width:260px">';
  html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h4 style="margin:0;color:#4ade80;font-size:13px">Stopwatch</h4><button onclick="if(window._swInterval)clearInterval(window._swInterval);this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:var(--text-muted);font-size:16px;cursor:pointer">X</button></div>';
  html+='<div id="_sw-display" style="text-align:center;font-size:32px;color:#4ade80;font-weight:700;font-family:monospace;margin-bottom:8px">00:00:00</div>';
  html+='<div id="_sw-laps" style="max-height:100px;overflow-y:auto;margin-bottom:8px"></div>';
  html+='<div style="display:flex;gap:6px">';
  html+='<button id="_sw-start" onclick="window._swToggle()" style="flex:1;background:#4ade80;color:#000;border:none;padding:8px;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px">Start</button>';
  html+='<button onclick="window._swLap()" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-secondary);padding:8px;border-radius:6px;cursor:pointer;font-size:12px">Lap</button>';
  html+='<button onclick="window._swReset()" style="flex:1;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-secondary);padding:8px;border-radius:6px;cursor:pointer;font-size:12px">Reset</button></div>';
  html+='</div>';const d=document.createElement('div');d.innerHTML=html;document.body.appendChild(d);
  window._swMs=0;window._swRunning=false;window._swLaps=[];window._swLapCount=0;
  window._swToggle=function(){
    const btn=document.getElementById('_sw-start');
    if(window._swRunning){
      clearInterval(window._swInterval);window._swRunning=false;
      if(btn){btn.textContent='Resume';btn.style.background='#f59e0b';}
    } else {
      window._swRunning=true;
      if(btn){btn.textContent='Pause';btn.style.background='#ef4444';}
      const start=Date.now()-window._swMs;
      window._swInterval=setInterval(()=>{
        window._swMs=Date.now()-start;
        const disp=document.getElementById('_sw-display');
        if(disp){const t=window._swMs;const h=Math.floor(t/3600000);const m=Math.floor((t%3600000)/60000);const s=Math.floor((t%60000)/1000);disp.textContent=(h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(s<10?'0':'')+s;}
      },100);
    }
  };
  window._swLap=function(){
    if(!window._swRunning)return;
    window._swLapCount++;const t=window._swMs;
    const h=Math.floor(t/3600000);const m=Math.floor((t%3600000)/60000);const s=Math.floor((t%60000)/1000);
    const lapStr=(h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
    const el=document.getElementById('_sw-laps');
    if(el)el.innerHTML='<div style="display:flex;justify-content:space-between;padding:3px 6px;font-size:11px;color:var(--text-secondary)"><span>Lap '+window._swLapCount+'</span><span style="color:#4ade80;font-family:monospace">'+lapStr+'</span></div>'+el.innerHTML;
  };
  window._swReset=function(){
    clearInterval(window._swInterval);window._swMs=0;window._swRunning=false;window._swLapCount=0;
    const disp=document.getElementById('_sw-display');if(disp)disp.textContent='00:00:00';
    const laps=document.getElementById('_sw-laps');if(laps)laps.innerHTML='';
    const btn=document.getElementById('_sw-start');if(btn){btn.textContent='Start';btn.style.background='#4ade80';}
  };
}
function showProjectRoadmap(filterProject){
  let panel=document.getElementById('roadmap-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='roadmap-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:600px;width:90vw;max-height:75vh;overflow-y:auto';
  let tasks=S.tasks.filter(t=>t.due);
  if(filterProject)tasks=tasks.filter(t=>t.project===filterProject);
  tasks.sort((a,b)=>(a.due||'').localeCompare(b.due||''));
  const projects=[...new Set(tasks.map(t=>t.project||'No Project'))];
  const pColors=['#3b82f6','#8b5cf6','#f59e0b','#ef4444','#06b6d4','#ec4899','#22c55e','#f97316'];
  const pColorMap={};projects.forEach((p,i)=>pColorMap[p]=pColors[i%pColors.length]);
  const today=new Date().toISOString().split('T')[0];
  let h='';
  const months={};
  tasks.forEach(t=>{const m=t.due.substring(0,7);if(!months[m])months[m]=[];months[m].push(t);});
  Object.keys(months).sort().forEach(m=>{
    const d=new Date(m+'-01');
    const label=d.toLocaleDateString('en-US',{month:'long',year:'numeric'});
    h+=`<div style="padding:8px 0 4px;font-size:11px;font-weight:600;color:var(--text-primary);border-bottom:1px solid var(--border);margin-top:12px">${label} (${months[m].length} tasks)</div>`;
    months[m].forEach(t=>{
      const clr=pColorMap[t.project||'No Project'];
      const isDone=t.status==='done';const isOverdue=t.due<today&&!isDone;
      h+=`<div onclick="document.getElementById('roadmap-panel').remove();openTaskDetail(${t.id})" style="display:flex;align-items:center;gap:8px;padding:5px 8px;cursor:pointer;border-left:3px solid ${clr};margin:2px 0;border-radius:0 4px 4px 0;opacity:${isDone?'0.5':'1'}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'"><span style="font-size:9px;color:var(--text-muted);font-family:var(--mono);min-width:40px">${t.due.substring(5)}</span><span style="font-size:10px;color:${isOverdue?'var(--red)':isDone?'var(--text-muted)':'var(--text-primary)'};flex:1;text-decoration:${isDone?'line-through':'none'}">${esc(t.title||'Untitled')}</span>${t.project?`<span style="font-size:8px;color:${clr};font-family:var(--mono)">${esc(t.project)}</span>`:''}<span style="font-size:8px;color:${t.priority==='p0'?'var(--red)':t.priority==='p1'?'var(--orange)':'var(--text-muted)'}">${t.priority||'p2'}</span></div>`;
    });
  });
  if(!tasks.length)h='<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:11px">No tasks with due dates'+(filterProject?' in '+filterProject:'')+'</div>';
  const legend=projects.map(p=>`<span style="display:inline-flex;align-items:center;gap:3px;font-size:8px;color:var(--text-muted)"><span style="width:8px;height:8px;border-radius:2px;background:${pColorMap[p]}"></span>${esc(p)}</span>`).join(' ');
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Project Roadmap${filterProject?' - '+esc(filterProject):''}</span><button onclick="document.getElementById('roadmap-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="margin-bottom:8px;display:flex;flex-wrap:wrap;gap:6px">${legend}</div>${h}`;
  document.body.appendChild(panel);
}
function addTaskColorLabel(taskId,color){
  const t=S.tasks.find(x=>x.id===taskId);if(!t)return;
  if(!t.labels)t.labels=[];
  if(t.labels.includes(color)){t.labels=t.labels.filter(c=>c!==color);}
  else{t.labels.push(color);if(t.labels.length>4)t.labels.shift();}
  save();renderTasks();
}
function showBurndownChart(days){
  days=days||14;
  let panel=document.getElementById('burndown-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='burndown-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:560px;width:90vw';
  const w=500,h=260,pad=40,gw=w-pad*2,gh=h-pad*2;
  const today=new Date();const dates=[];
  for(let i=days-1;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);dates.push(d.toISOString().split('T')[0]);}
  const created=dates.map(ds=>S.tasks.filter(t=>t.created&&t.created.startsWith(ds)).length);
  const completed=dates.map(ds=>S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length);
  const maxVal=Math.max(1,...created,...completed);
  const barW=Math.floor(gw/dates.length*0.35);
  let svg=`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="font-family:var(--mono)">`;
  // grid lines
  for(let i=0;i<=4;i++){const y=pad+gh-gh*(i/4);const v=Math.round(maxVal*(i/4));svg+=`<line x1="${pad}" y1="${y}" x2="${pad+gw}" y2="${y}" stroke="#222" stroke-width="0.5"/><text x="${pad-4}" y="${y+3}" fill="#666" font-size="8" text-anchor="end">${v}</text>`;}
  // bars
  dates.forEach((ds,i)=>{
    const x=pad+i*(gw/dates.length)+2;
    const ch=created[i]?(created[i]/maxVal)*gh:0;
    const dh=completed[i]?(completed[i]/maxVal)*gh:0;
    svg+=`<rect x="${x}" y="${pad+gh-ch}" width="${barW}" height="${ch}" fill="#3b82f6" rx="1" opacity="0.85"><title>${ds}: ${created[i]} created</title></rect>`;
    svg+=`<rect x="${x+barW+1}" y="${pad+gh-dh}" width="${barW}" height="${dh}" fill="#4ade80" rx="1" opacity="0.85"><title>${ds}: ${completed[i]} completed</title></rect>`;
    if(i%Math.ceil(days/7)===0||i===dates.length-1){svg+=`<text x="${x+barW}" y="${h-5}" fill="#666" font-size="7" text-anchor="middle">${ds.substring(5)}</text>`;}
  });
  // legend
  svg+=`<rect x="${w-120}" y="8" width="8" height="8" fill="#3b82f6" rx="1"/><text x="${w-108}" y="16" fill="#888" font-size="9">Created</text>`;
  svg+=`<rect x="${w-120}" y="22" width="8" height="8" fill="#4ade80" rx="1"/><text x="${w-108}" y="30" fill="#888" font-size="9">Completed</text>`;
  // totals
  const totalCreated=created.reduce((a,v)=>a+v,0);const totalCompleted=completed.reduce((a,v)=>a+v,0);
  svg+=`<text x="${pad}" y="16" fill="#888" font-size="9">${totalCreated} created, ${totalCompleted} completed (${days}d)</text>`;
  svg+=`</svg>`;
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Task Burndown (${days} days)</span><button onclick="document.getElementById('burndown-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;justify-content:center;overflow-x:auto">${svg}</div><div style="margin-top:10px;display:flex;gap:8px;justify-content:center"><button onclick="showBurndownChart(7)" class="btn btn-sm btn-ghost" style="font-size:9px">7d</button><button onclick="showBurndownChart(14)" class="btn btn-sm btn-ghost" style="font-size:9px">14d</button><button onclick="showBurndownChart(30)" class="btn btn-sm btn-ghost" style="font-size:9px">30d</button><button onclick="showBurndownChart(90)" class="btn btn-sm btn-ghost" style="font-size:9px">90d</button></div>`;
  document.body.appendChild(panel);
}
function checkDeadLinks(){
  const links=S.links.filter(l=>l.url&&l.url.startsWith('http'));
  if(!links.length){toast('No links to check');return;}
  let panel=document.getElementById('deadlinks-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='deadlinks-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw;max-height:70vh;overflow-y:auto';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">Checking ${links.length} Links...</span><button onclick="document.getElementById('deadlinks-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div id="deadlinks-progress" style="font-size:10px;color:var(--text-muted);margin-bottom:8px">0/${links.length} checked</div><div id="deadlinks-results"></div>`;
  document.body.appendChild(panel);
  let checked=0;const results=[];const batch=5;
  async function checkBatch(start){
    const slice=links.slice(start,start+batch);
    await Promise.allSettled(slice.map(async l=>{
      try{const r=await fetch(l.url,{method:'HEAD',mode:'no-cors',signal:AbortSignal.timeout(5000)});results.push({url:l.url,title:l.title,status:'ok',code:r.status||'opaque'});}
      catch(e){results.push({url:l.url,title:l.title,status:'error',error:e.message||'timeout'});}
      checked++;document.getElementById('deadlinks-progress').textContent=checked+'/'+links.length+' checked';
    }));
    const resEl=document.getElementById('deadlinks-results');
    const broken=results.filter(r=>r.status==='error');
    const ok=results.filter(r=>r.status==='ok');
    resEl.innerHTML=(broken.length?`<div style="margin-bottom:8px;font-size:11px;color:var(--red);font-weight:600">${broken.length} Broken/Unreachable</div>`+broken.map(r=>`<div style="padding:4px 0;border-bottom:1px solid var(--border);font-size:10px"><span style="color:var(--red)">x</span> <span style="color:var(--text-primary)">${esc(r.title)}</span><br><span style="color:var(--text-muted);font-size:9px">${esc(r.url)} - ${esc(r.error)}</span></div>`).join(''):'')+(ok.length?`<div style="margin-top:8px;margin-bottom:4px;font-size:11px;color:var(--green);font-weight:600">${ok.length} OK</div>`:'')+(checked===links.length?`<div style="margin-top:8px;font-size:10px;color:var(--text-muted)">Done. ${broken.length} broken, ${ok.length} ok out of ${links.length} total.</div>`:'');
    if(start+batch<links.length)setTimeout(()=>checkBatch(start+batch),200);
    else{document.getElementById('deadlinks-progress').textContent='Complete: '+checked+'/'+links.length;document.querySelector('#deadlinks-panel > div:first-child > span').textContent='Link Health: '+broken.length+' broken, '+ok.length+' ok';}
  }
  checkBatch(0);
}
function enableDesktopNotifications(){
  if(!('Notification' in window)){toast('Browser does not support notifications');return;}
  if(Notification.permission==='granted'){toast('Notifications already enabled');checkOverdueNotify();return;}
  if(Notification.permission==='denied'){toast('Notifications blocked. Enable in browser settings.');return;}
  Notification.requestPermission().then(perm=>{if(perm==='granted'){toast('Notifications enabled');checkOverdueNotify();S._notificationsEnabled=true;save();}else toast('Notifications denied');});
}
function checkOverdueNotify(){
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  const today=new Date().toISOString().split('T')[0];
  const overdue=S.tasks.filter(t=>t.due&&t.due<today&&t.status!=='done');
  if(overdue.length){new Notification('SATURNO HUB',{body:overdue.length+' overdue task'+(overdue.length>1?'s':'')+': '+overdue.slice(0,3).map(t=>t.title).join(', '),icon:'planet-logo.png'});}
}
function notifyFocusComplete(taskName){
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  new Notification('Focus Session Complete',{body:taskName?'Finished: '+taskName:'Timer done! Take a break.',icon:'planet-logo.png'});
}
function showChart(type){
  let panel=document.getElementById('chart-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='chart-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:500px;width:90vw';
  let svg='';const w=400,h=250;
  if(type==='status'){
    const counts={todo:0,progress:0,done:0,blocked:0};S.tasks.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
    const total=Object.values(counts).reduce((a,v)=>a+v,0);if(!total){panel.innerHTML='<div style="text-align:center;color:var(--text-muted);padding:20px">No tasks yet</div><button onclick="this.parentElement.remove()" style="display:block;margin:0 auto;background:none;border:none;color:var(--text-muted);cursor:pointer">Close</button>';document.body.appendChild(panel);return;}
    const colors={todo:'#3b82f6',progress:'#f59e0b',done:'#4ade80',blocked:'#ef4444'};
    let startAngle=-Math.PI/2;const cx=120,cy=120,r=100;
    svg=`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
    Object.entries(counts).filter(([,v])=>v>0).forEach(([status,count])=>{
      const angle=(count/total)*Math.PI*2;const endAngle=startAngle+angle;
      const x1=cx+r*Math.cos(startAngle),y1=cy+r*Math.sin(startAngle);
      const x2=cx+r*Math.cos(endAngle),y2=cy+r*Math.sin(endAngle);
      const large=angle>Math.PI?1:0;
      svg+=`<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z" fill="${colors[status]}" opacity="0.85"><title>${status}: ${count} (${Math.round(count/total*100)}%)</title></path>`;
      startAngle=endAngle;
    });
    let ly=20;Object.entries(counts).filter(([,v])=>v>0).forEach(([s,c])=>{svg+=`<rect x="260" y="${ly}" width="12" height="12" fill="${colors[s]}" rx="2"/><text x="278" y="${ly+10}" fill="#ccc" font-size="11">${s}: ${c} (${Math.round(c/total*100)}%)</text>`;ly+=20;});
    svg+='</svg>';
  }else if(type==='priority'){
    const counts={p0:0,p1:0,p2:0,p3:0};S.tasks.filter(t=>t.status!=='done').forEach(t=>counts[t.priority||'p2']++);
    const max=Math.max(...Object.values(counts),1);const colors={p0:'#ef4444',p1:'#f59e0b',p2:'#3b82f6',p3:'#666'};
    svg=`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
    Object.entries(counts).forEach(([p,c],i)=>{const bw=60,bh=Math.round(c/max*150),x=40+i*90,y=180-bh;
      svg+=`<rect x="${x}" y="${y}" width="${bw}" height="${bh}" fill="${colors[p]}" rx="4" opacity="0.85"/><text x="${x+bw/2}" y="200" fill="#888" font-size="11" text-anchor="middle">${p.toUpperCase()}</text><text x="${x+bw/2}" y="${y-5}" fill="#ccc" font-size="12" text-anchor="middle">${c}</text>`;
    });svg+='</svg>';
  }else if(type==='theme'){
    const themes={};S.content.forEach(c=>{const t=c.theme||'unthemed';themes[t]=(themes[t]||0)+1;});
    const sorted=Object.entries(themes).sort((a,b)=>b[1]-a[1]).slice(0,8);const max=sorted.length?sorted[0][1]:1;
    const cl=['#4ade80','#22d3ee','#a855f7','#f59e0b','#3b82f6','#ec4899','#ef4444','#eab308'];
    svg=`<svg width="${w}" height="${sorted.length*28+10}" viewBox="0 0 ${w} ${sorted.length*28+10}">`;
    sorted.forEach(([t,c],i)=>{const bw=Math.round(c/max*(w-140)),y=5+i*28;
      svg+=`<rect x="0" y="${y}" width="${bw}" height="20" fill="${cl[i%cl.length]}" rx="3" opacity="0.85"/><text x="${bw+6}" y="${y+14}" fill="#ccc" font-size="10">${esc(t)} (${c})</text>`;
    });svg+='</svg>';
  }else if(type==='weekly'){
    const days=[];const today=new Date();
    for(let i=6;i>=0;i--){const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];days.push({label:['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()],created:S.tasks.filter(t=>t.created&&t.created.startsWith(ds)).length,completed:S.tasks.filter(t=>t.completedAt&&t.completedAt.startsWith(ds)).length,content:S.content.filter(c=>c.created&&c.created.startsWith(ds)).length});}
    const max=Math.max(...days.map(d=>d.created+d.completed+d.content),1);
    svg=`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
    days.forEach((d,i)=>{const x=30+i*52,bw=14;
      svg+=`<rect x="${x}" y="${180-Math.round(d.created/max*150)}" width="${bw}" height="${Math.round(d.created/max*150)}" fill="#3b82f6" rx="2" opacity="0.85"/><rect x="${x+16}" y="${180-Math.round(d.completed/max*150)}" width="${bw}" height="${Math.round(d.completed/max*150)}" fill="#4ade80" rx="2" opacity="0.85"/><rect x="${x+32}" y="${180-Math.round(d.content/max*150)}" width="${bw}" height="${Math.round(d.content/max*150)}" fill="#a855f7" rx="2" opacity="0.85"/><text x="${x+22}" y="198" fill="#888" font-size="10" text-anchor="middle">${d.label}</text>`;
    });
    svg+=`<rect x="${w-110}" y="10" width="10" height="10" fill="#3b82f6" rx="2"/><text x="${w-95}" y="19" fill="#888" font-size="9">Created</text><rect x="${w-110}" y="25" width="10" height="10" fill="#4ade80" rx="2"/><text x="${w-95}" y="34" fill="#888" font-size="9">Done</text><rect x="${w-110}" y="40" width="10" height="10" fill="#a855f7" rx="2"/><text x="${w-95}" y="49" fill="#888" font-size="9">Content</text></svg>`;
  }
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">${{status:'Task Status',priority:'Task Priority (Active)',theme:'Content Themes',weekly:'Weekly Activity'}[type]}</span><button onclick="document.getElementById('chart-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:flex;justify-content:center">${svg}</div>`;
  document.body.appendChild(panel);
}
function toggleScratchpad(){
  let panel=document.getElementById('scratchpad-panel');
  if(panel){panel.style.display=panel.style.display==='none'?'flex':'none';if(panel.style.display==='flex')panel.querySelector('textarea').focus();return;}
  panel=document.createElement('div');panel.id='scratchpad-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1400;width:400px;max-width:90vw;height:300px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 12px 48px rgba(0,0,0,0.6);resize:both;overflow:hidden';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em">Scratchpad</span><div style="display:flex;gap:6px"><button onclick="navigator.clipboard.writeText(document.getElementById('scratch-text').value);toast('Copied')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:9px">Copy</button><button onclick="document.getElementById('scratchpad-panel').style.display='none'" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">&times;</button></div></div><textarea id="scratch-text" oninput="S._scratchpad=this.value;save()" placeholder="Type anything... auto-saved." style="flex:1;background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;padding:8px;resize:none;font-family:var(--mono);line-height:1.6">${esc(S._scratchpad||'')}</textarea>`;
  document.body.appendChild(panel);panel.querySelector('textarea').focus();
}
function showActivityHeatmap(){
  let panel=document.getElementById('heatmap-panel');if(panel)panel.remove();
  panel=document.createElement('div');panel.id='heatmap-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1500;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:0 12px 48px rgba(0,0,0,0.7);max-width:720px;width:90vw';
  const today=new Date();const cells=[];
  for(let i=89;i>=0;i--){
    const d=new Date(today);d.setDate(d.getDate()-i);const ds=d.toISOString().split('T')[0];
    const count=S.tasks.filter(t=>(t.completedAt&&t.completedAt.startsWith(ds))||(t.created&&t.created.startsWith(ds))).length+S.content.filter(c=>c.created&&c.created.startsWith(ds)).length+S.docs.filter(doc=>(doc.updated||doc.created||'').startsWith(ds)).length;
    const lvl=count===0?0:count<=2?1:count<=5?2:count<=10?3:4;
    const colors=['#161619','#0e4429','#006d32','#26a641','#39d353'];
    cells.push(`<div title="${ds}: ${count} activities" style="width:10px;height:10px;background:${colors[lvl]};border-radius:2px"></div>`);
  }
  const totalAct=cells.reduce((a,c,i)=>{const m=c.match(/: (\d+)/);return a+parseInt(m?m[1]:0);},0);
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:13px;font-weight:600;color:var(--text-primary)">90-Day Activity Heatmap</span><button onclick="document.getElementById('heatmap-panel').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px">&times;</button></div><div style="display:grid;grid-template-columns:repeat(13,1fr);gap:2px;margin-bottom:12px">${cells.join('')}</div><div style="display:flex;gap:12px;font-size:9px;color:var(--text-muted);align-items:center"><span>Less</span><div style="width:10px;height:10px;background:#161619;border-radius:2px"></div><div style="width:10px;height:10px;background:#0e4429;border-radius:2px"></div><div style="width:10px;height:10px;background:#006d32;border-radius:2px"></div><div style="width:10px;height:10px;background:#26a641;border-radius:2px"></div><div style="width:10px;height:10px;background:#39d353;border-radius:2px"></div><span>More</span></div>`;
  document.body.appendChild(panel);
}
function cmdSearch() {
  const q = document.getElementById('cmd-input').value;
  const items = cmdGetItems(q);
  cmdIdx = 0;
  const el = document.getElementById('cmd-results');
  if(!items.length) { el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:12px">No results</div>'; return; }
  el.innerHTML = (q?`<div style="padding:4px 16px;font-size:8px;color:var(--text-muted);font-family:var(--mono);border-bottom:1px solid var(--border)">${items.length} result${items.length!==1?'s':''}</div>`:'')+items.map((it, i) => {
    const iconHtml = it.icon.startsWith('<') ? it.icon : `<span>${it.icon}</span>`;
    return `<div class="cmd-item ${i===0?'active':''}" data-idx="${i}" onclick="cmdExec(${i})" onmouseenter="cmdHover(${i})">
      <div class="cmd-item-icon">${iconHtml}</div>
      <div class="cmd-item-text"><div class="cmd-item-title">${esc(it.title)}</div><div class="cmd-item-desc">${esc(it.desc||'')}</div></div>
      <span class="cmd-item-badge">${it.type}</span>
    </div>`;
  }).join('');
}
function cmdHover(i) { cmdIdx = i; cmdHighlight(); }
function cmdHighlight() {
  document.querySelectorAll('.cmd-item').forEach((el, i) => el.classList.toggle('active', i === cmdIdx));
  const active = document.querySelector('.cmd-item.active');
  if(active) active.scrollIntoView({block:'nearest'});
}
function cmdKeydown(e) {
  const items = document.querySelectorAll('.cmd-item');
  if(e.key === 'ArrowDown') { e.preventDefault(); cmdIdx = Math.min(cmdIdx + 1, items.length - 1); cmdHighlight(); }
  else if(e.key === 'ArrowUp') { e.preventDefault(); cmdIdx = Math.max(cmdIdx - 1, 0); cmdHighlight(); }
  else if(e.key === 'Enter') { e.preventDefault(); cmdExec(cmdIdx); }
  else if(e.key === 'Escape') { closeCommandPalette(); }
}
function cmdExec(idx) {
  const items = cmdGetItems(document.getElementById('cmd-input').value);
  if(items[idx] && items[idx].action) { closeCommandPalette(); items[idx].action(); }
}

// === MODE SWITCHING ===
let currentMode = 'default';
function setMode(mode) {
  currentMode = mode;
  const app = document.querySelector('.app');
  app.classList.remove('mode-focus', 'mode-extended');
  // Close project panel in focus mode — no sidebar means no way to navigate
  if(mode === 'focus') {
    app.classList.add('mode-focus');
    if(app.classList.contains('project-open')) closeProjectPanel();
    app.classList.remove('context-open');
  }
  if(mode === 'extended') {
    app.classList.add('mode-extended');
    if(app.classList.contains('project-open')) closeProjectPanel();
    if(!app.classList.contains('context-open')) app.classList.add('context-open');
    updateContextStats();
  }
  if(mode === 'default') {
    app.classList.remove('context-open');
  }
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('mode-'+mode+'-btn').classList.add('active');
}

// === SIDEBAR TOGGLE ===
function toggleSidebar() {
  const app = document.querySelector('.app');
  app.classList.toggle('sidebar-collapsed');
  localStorage.setItem('sidebar-collapsed', app.classList.contains('sidebar-collapsed') ? '1' : '');
}
function openMobileSidebar(){document.querySelector('.sidebar').classList.add('mobile-open');document.getElementById('mobile-overlay').classList.add('open');}
function closeMobileSidebar(){document.querySelector('.sidebar').classList.remove('mobile-open');document.getElementById('mobile-overlay').classList.remove('open');}

// === CONTEXT PANEL ===
function toggleContextPanel() {
  const app = document.querySelector('.app');
  if(app.classList.contains('project-open')) {
    closeProjectPanel();
  }
  app.classList.toggle('context-open');
  updateContextStats();
}

// === PANEL RESIZING ===
(function initResize() {
  document.addEventListener('DOMContentLoaded', () => {
    const sidebarHandle = document.getElementById('sidebar-resize');
    const contextHandle = document.getElementById('context-resize');
    const root = document.documentElement;
    let resizing = null;
    function onMouseDown(e, type) {
      e.preventDefault();
      resizing = type;
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      const handle = type === 'sidebar' ? sidebarHandle : contextHandle;
      if(handle) handle.classList.add('dragging');
    }
    if(sidebarHandle) sidebarHandle.addEventListener('mousedown', e => onMouseDown(e, 'sidebar'));
    if(contextHandle) contextHandle.addEventListener('mousedown', e => onMouseDown(e, 'context'));
    document.addEventListener('mousemove', e => {
      if(!resizing) return;
      if(resizing === 'sidebar') {
        const w = Math.max(160, Math.min(400, e.clientX));
        root.style.setProperty('--sidebar-width', w + 'px');
      } else if(resizing === 'context') {
        const w = Math.max(200, Math.min(500, window.innerWidth - e.clientX));
        root.style.setProperty('--context-width', w + 'px');
      }
    });
    document.addEventListener('mouseup', () => {
      if(!resizing) return;
      const handle = resizing === 'sidebar' ? sidebarHandle : contextHandle;
      if(handle) handle.classList.remove('dragging');
      resizing = null;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    });
  });
})();

function updateContextStats() {
  const activeTasks = S.tasks.filter(t => t.status !== 'done').length;
  const el = id => { const e = document.getElementById(id); if(e) return e; return {textContent:''}; };
  el('ctx-stat-tasks').textContent = activeTasks;
  el('ctx-stat-docs').textContent = S.docs.length + S.specs.length;
  el('ctx-stat-projects').textContent = (S.projects||[]).length;
  el('ctx-stat-kb').textContent = (S.knowledgeBase||[]).length;
  updateContextRelated();
  renderGraph();
}
function updateContextRelated() {
  const el = document.getElementById('ctx-related-items');
  if(!el) return;
  let html = '';
  if(currentSection === 'writer') {
    const doc = getActiveDoc();
    if(doc && doc.title) {
      const backlinks = getBacklinks('doc', doc.title);
      if(backlinks.length) {
        html += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Backlinks to "' + esc(doc.title) + '":</div>';
        backlinks.forEach(bl => {
          html += '<div class="context-item" onclick="navigateToItem(\'' + bl.type + '\',\'' + bl.id + '\')"><span class="context-item-icon">' + bl.type[0].toUpperCase() + '</span>' + esc(bl.title) + '</div>';
        });
      }
    }
  } else if(currentSection === 'specs') {
    const spec = getActiveSpec();
    if(spec && spec.title) {
      const backlinks = getBacklinks('spec', spec.title);
      if(backlinks.length) {
        html += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Backlinks to "' + esc(spec.title) + '":</div>';
        backlinks.forEach(bl => {
          html += '<div class="context-item" onclick="navigateToItem(\'' + bl.type + '\',\'' + bl.id + '\')"><span class="context-item-icon">' + bl.type[0].toUpperCase() + '</span>' + esc(bl.title) + '</div>';
        });
      }
    }
  } else if(currentSection === 'tasks') {
    // Show overdue tasks
    const today = new Date().toISOString().split('T')[0];
    const overdue = S.tasks.filter(t => t.due && t.due < today && t.status !== 'done');
    if(overdue.length) {
      html += '<div style="font-size:9px;color:var(--red);margin-bottom:6px">Overdue (' + overdue.length + '):</div>';
      overdue.slice(0, 5).forEach(t => {
        html += '<div class="context-item" style="color:var(--red)"><span class="context-item-icon">!</span>' + esc(t.title || 'Untitled') + '</div>';
      });
    }
    // Show today's tasks
    const todayTasks = S.tasks.filter(t => t.due === today && t.status !== 'done');
    if(todayTasks.length) {
      html += '<div style="font-size:9px;color:var(--accent);margin-bottom:6px;margin-top:8px">Today (' + todayTasks.length + '):</div>';
      todayTasks.forEach(t => {
        html += '<div class="context-item"><span class="context-item-icon">*</span>' + esc(t.title || 'Untitled') + '</div>';
      });
    }
  }
  if(!html) html = '<div style="font-size:10px;color:var(--text-muted);padding:4px 0">No related items for current view</div>';
  el.innerHTML = html;
}

// === FOCUS TIMER (Embedded) ===
let ftDuration = 1500, ftTimeLeft = 1500, ftRunning = false, ftPaused = false, ftInterval = null;
let ftCategory = 'Writing', ftColor = '#4ade80';
function ftToggle() {
  if(!ftRunning && !ftPaused) ftStart();
  else if(ftRunning) ftPause();
  else ftResume();
}
let ftTaskId=null;
function ftStartForTask(id){
  const t=S.tasks.find(x=>x.id===id);if(!t)return;
  ftTaskId=id;
  ftSetCat(null,t.title.substring(0,20)||'Task','#4ade80');
  ftReset();
  if(!document.querySelector('.app').classList.contains('context-open'))toggleContextPanel();
  closeTaskDetail();
  ftToggle();
  if(!t.timeStarted){t.timeStarted=new Date().toISOString();if(t.status==='todo'){t.status='progress';if(!t.log)t.log=[];t.log.push({from:'todo',to:'progress',at:t.timeStarted});}save();}
  toast('Focus timer started for: '+t.title.substring(0,30));
}
function ftStart() {
  ftRunning = true; ftPaused = false;
  document.getElementById('ft-btn').textContent = 'Pause';
  document.getElementById('ft-btn').classList.add('running');
  document.getElementById('ft-time-adjust').style.opacity = '0.3';
  ftInterval = setInterval(() => {
    ftTimeLeft--;
    ftUpdateDisplay();
    if(ftTimeLeft <= 0) ftComplete();
  }, 1000);
}
function ftPause() {
  ftRunning = false; ftPaused = true;
  clearInterval(ftInterval);
  document.getElementById('ft-btn').textContent = 'Resume';
  document.getElementById('ft-btn').classList.remove('running');
}
function ftResume() { ftStart(); }
function ftComplete() {
  ftRunning = false; ftPaused = false;
  clearInterval(ftInterval);
  document.getElementById('ft-btn').textContent = 'Done!';
  document.getElementById('ft-btn').classList.remove('running');
  ftPlaySound();
  setTimeout(ftReset, 3000);
}
function ftReset() {
  ftRunning = false; ftPaused = false;
  clearInterval(ftInterval);
  ftTimeLeft = ftDuration;
  document.getElementById('ft-btn').textContent = 'Start';
  document.getElementById('ft-btn').classList.remove('running');
  document.getElementById('ft-time-adjust').style.opacity = '1';
  ftUpdateDisplay();
}
function ftUpdateDisplay() {
  const m = Math.floor(ftTimeLeft / 60), s = ftTimeLeft % 60;
  document.getElementById('ft-time').textContent = m + ':' + String(s).padStart(2, '0');
  const progress = 1 - (ftTimeLeft / ftDuration);
  const circumference = 2 * Math.PI * 70;
  const offset = circumference * (1 - progress);
  const prog = document.getElementById('ft-progress');
  if(prog) { prog.style.strokeDasharray = circumference; prog.style.strokeDashoffset = offset; prog.style.stroke = ftColor; }
}
function ftAdjust(min) {
  if(ftRunning || ftPaused) return;
  ftDuration = Math.max(300, Math.min(7200, ftDuration + min * 60));
  ftTimeLeft = ftDuration;
  document.getElementById('ft-duration-label').textContent = Math.floor(ftDuration / 60) + ' min';
  ftUpdateDisplay();
}
function ftSetCat(el, name, color) {
  ftCategory = name; ftColor = color;
  document.querySelectorAll('.ft-cat').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('ft-label').textContent = name;
  ftUpdateDisplay();
}
function ftPlaySound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator(), gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.frequency.setValueAtTime(600, ctx.currentTime + 0.1);
    osc.frequency.setValueAtTime(800, ctx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.5);
  } catch(e) {}
}

// === CLOUD SYNC (Vercel Blob Backend) ===
const ASTRA_API = window.location.origin;
let ASTRA_ADMIN_PW = localStorage.getItem('astra_admin_pw') || '';
let cloudSyncTimer = null;
let lastCloudSync = 0;
const CLOUD_SYNC_INTERVAL = 30000;

function ensureAdminPW() {
  if (ASTRA_ADMIN_PW) return true;
  var pw = prompt('Enter ASTRA admin password for cloud sync:');
  if (!pw) return false;
  ASTRA_ADMIN_PW = pw;
  localStorage.setItem('astra_admin_pw', pw);
  return true;
}

function setCloudIndicator(state) {
  const el = document.getElementById('cloud-sync-indicator');
  if(!el) return;
  if(state==='syncing') { el.style.opacity='1'; el.style.color='var(--accent-cyan)'; el.title='Syncing...'; }
  else if(state==='synced') { el.style.opacity='0.7'; el.style.color='var(--green)'; el.title='Synced '+(new Date().toLocaleTimeString())+' — click to sync'; }
  else if(state==='error') { el.style.opacity='0.8'; el.style.color='var(--red)'; el.title='Sync failed — click to retry'; }
  else { el.style.opacity='0.4'; el.style.color='var(--text-muted)'; el.title='Not synced — click to sync'; }
}
async function cloudSave(silent) {
  if (!ASTRA_ADMIN_PW && silent) return { ok: false };
  if (!ensureAdminPW()) return { ok: false };
  setCloudIndicator('syncing');
  try {
    const state = JSON.parse(localStorage.getItem(SK) || '{}');
    const res = await fetch(ASTRA_API + '/api/state', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify(state)
    });
    const data = await res.json();
    if (data.ok) {
      lastCloudSync = Date.now();
      setCloudIndicator('synced');
      if (!silent) toast('Synced to cloud (v' + data.version + ')');
    } else if (data.error === 'Unauthorized') {
      localStorage.removeItem('astra_admin_pw');
      ASTRA_ADMIN_PW = '';
      setCloudIndicator('error');
      if (!silent) toast('Wrong password. Try Cmd+S again.');
    } else {
      setCloudIndicator('error');
    }
    return data;
  } catch(e) { setCloudIndicator('error'); if (!silent) toast('Cloud sync error: ' + e.message); return { ok: false }; }
}

function scheduleCloudSync() {
  if (cloudSyncTimer) clearTimeout(cloudSyncTimer);
  cloudSyncTimer = setTimeout(function() { cloudSave(true); }, CLOUD_SYNC_INTERVAL);
}

async function cloudLoad() {
  if (!ensureAdminPW()) return;
  try {
    const res = await fetch(ASTRA_API + '/api/state', {
      headers: { 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW }
    });
    const data = await res.json();
    if (data._source === 'blob' && (data.projects || data.tasks || data.docs || data.content)) {
      delete data._source; delete data._savedAt; delete data._version;
      localStorage.setItem(SK, JSON.stringify(data));
      location.reload();
    } else if (data._source === 'none' || data._source === 'empty') {
      toast('No cloud state yet — saving current state');
      cloudSave(false);
    } else { toast('No cloud state found'); }
  } catch(e) { toast('Cloud load error: ' + e.message); }
}

async function logTranscript(text, source) {
  try {
    await fetch(ASTRA_API + '/api/transcripts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify({ text, source: source || 'astra-voice', tags: ['voice-input'] })
    });
  } catch(e) { /* silent fail for transcript logging */ }
}

async function queryAstra(type, params) {
  try {
    const res = await fetch(ASTRA_API + '/api/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + ASTRA_ADMIN_PW },
      body: JSON.stringify({ type, ...params })
    });
    return await res.json();
  } catch(e) { return { ok: false, error: e.message }; }
}

// === INIT ===
load();
seedLinks();
seedProjects();
migrateV2();
save();
if(localStorage.getItem('sidebar-collapsed')) document.querySelector('.app').classList.add('sidebar-collapsed');
initVoice();
wbLoadState();
renderContent();renderTasks();renderCalendar();renderWriter();renderSpecs();renderLinks();renderProjectsSidebar();renderFolderTree();updateStorage();
ftUpdateDisplay();updateContextStats();
document.getElementById('sidebar-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
setTimeout(function(){ cloudSave(true); }, 3000);
setTimeout(function(){ if(S._notificationsEnabled) checkOverdueNotify(); }, 5000);
if(S._autoBackup) scheduleAutoBackup();
if(S._stickies&&S._stickies.length) renderStickyNotes();
// Whiteboard drop handler for KB items
document.getElementById('panel-whiteboard')?.addEventListener('drop', handleWbDrop);
document.getElementById('panel-whiteboard')?.addEventListener('dragover', e => { if(e.dataTransfer?.types?.includes('text/plain')) e.preventDefault(); });
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
window.addEventListener('beforeunload',()=>{if(zenIsOpen)zenSnapshot();snapshotWriter();snapshotSpec();wbPersist();save();});
document.addEventListener('keydown',e=>{
  // Command Palette: Cmd+K
  if((e.metaKey||e.ctrlKey) && e.key==='k') { e.preventDefault(); openCommandPalette(); return; }
  // Cmd+Shift+W: toggle Zen Writer
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='w'||e.key==='W')) { e.preventDefault(); if(zenIsOpen) zenClose(); else zenOpen(); return; }
  // Cmd+S: save (Zen Writer version save or workspace save)
  if((e.metaKey||e.ctrlKey) && e.key==='s') { e.preventDefault(); if(zenIsOpen){ zenSaveVersion(); } else { snapshotWriter(); snapshotSpec(); wbPersist(); save(); cloudSave(); } return; }
  // Cmd+Shift+S: toggle Scratchpad
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='s'||e.key==='S')) { e.preventDefault(); toggleScratchpad(); return; }
  // Skip shortcuts when typing in inputs
  const inInput = e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.contentEditable==='true';
  if(e.key==='Escape'){
    if(zenIsOpen) { zenClose(); return; }
    if(document.getElementById('task-detail-modal').classList.contains('open')) { closeTaskDetail(); return; }
    if(document.getElementById('cmd-overlay').classList.contains('open')) { closeCommandPalette(); return; }
    document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));
    if(activeProject) closeProjectPanel();
  }
  if(inInput) return;
  // Priority shortcuts in task detail modal (1-4 for p0-p3)
  if(document.getElementById('task-detail-modal').classList.contains('open')&&!e.metaKey&&!e.ctrlKey){
    const pMap={'1':'p0','2':'p1','3':'p2','4':'p3'};
    if(pMap[e.key]){document.getElementById('td-priority').value=pMap[e.key];toast('Priority: '+pMap[e.key].toUpperCase());return;}
    if(e.key==='s'&&!e.shiftKey){saveTaskDetail();return;}
  }
  // Cmd+number: switch sections
  if((e.metaKey||e.ctrlKey) && e.key>='1' && e.key<='9') {
    e.preventDefault();
    const sections = ['content','tasks','calendar','writer','specs','links','whiteboard','pipeline','repos'];
    const idx = parseInt(e.key)-1;
    if(sections[idx]) {
      const items = document.querySelectorAll('.sidebar-item');
      switchSection(sections[idx], items[idx]||null);
    }
    return;
  }
  // Cmd+Shift+N: quick capture
  if((e.metaKey||e.ctrlKey) && e.shiftKey && e.key==='n') { e.preventDefault(); qcOpen(); return; }
  // Cmd+Shift+T: new task from anywhere
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='t'||e.key==='T')) { e.preventDefault(); switchSection('tasks',document.querySelectorAll('.sidebar-item')[1]||null); setTimeout(()=>addTask(),100); return; }
  // Cmd+B: toggle sidebar
  if((e.metaKey||e.ctrlKey) && e.key==='b' && !e.shiftKey) { e.preventDefault(); toggleSidebar(); return; }
  // Cmd+Shift+D: today view
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='d'||e.key==='D')) { e.preventDefault(); showTodayView(); return; }
  // Cmd+Shift+F: toggle focus mode
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='f'||e.key==='F')) { e.preventDefault(); const app=document.querySelector('.app');const isFocus=app.classList.contains('mode-focus');setMode(isFocus?'default':'focus'); return; }
  // Cmd+Shift+W: open Zen Writer
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='w'||e.key==='W')) { e.preventDefault(); zenOpen(); return; }
  // Cmd+Shift+E: export current section
  if((e.metaKey||e.ctrlKey) && e.shiftKey && (e.key==='e'||e.key==='E')) { e.preventDefault(); if(currentSection==='tasks')exportTasks();else if(currentSection==='content')exportContent();else if(currentSection==='links')exportLinks();else if(currentSection==='calendar')exportWeek();else if(currentSection==='writer'){writerExport('clipboard');}else toast('No export for this section'); return; }
  // Cmd+D: duplicate current item (writer doc / spec)
  if((e.metaKey||e.ctrlKey) && e.key==='d' && !e.shiftKey && currentSection==='writer') { e.preventDefault(); if(S.activeDoc)dupDoc(S.activeDoc); return; }
  if((e.metaKey||e.ctrlKey) && e.key==='d' && !e.shiftKey && currentSection==='specs') { e.preventDefault(); if(S.activeSpec)dupSpec(S.activeSpec); return; }
  // Cmd+N: new item in current section
  if((e.metaKey||e.ctrlKey) && e.key==='n' && !e.shiftKey) {
    e.preventDefault();
    if(currentSection==='content') openContentModal();
    else if(currentSection==='tasks') addTask();
    else if(currentSection==='writer') newDoc();
    else if(currentSection==='specs') newSpec();
    else if(currentSection==='links') openLinkModal();
    return;
  }
  // Cmd+Z: undo last delete (content)
  if((e.metaKey||e.ctrlKey) && e.key==='z' && !e.shiftKey) { if(lastDeletedContent){e.preventDefault();undoDeleteContent();return;} if(lastDeletedLink){e.preventDefault();undoDeleteLink();return;} }
  // Cmd+E: toggle context panel
  if((e.metaKey||e.ctrlKey) && e.key==='e') { e.preventDefault(); toggleContextPanel(); return; }
  // Cmd+\\: toggle focus mode
  if((e.metaKey||e.ctrlKey) && e.key==='\\') { e.preventDefault(); setMode(currentMode==='focus'?'default':'focus'); return; }
  // Cmd+/: show shortcuts help
  if((e.metaKey||e.ctrlKey) && e.key==='/') { e.preventDefault(); document.getElementById('shortcuts-modal').classList.toggle('open'); return; }
});

// === RESIZE HANDLE FOR PROJECT PANEL ===
(function(){
  const handle = document.getElementById('project-resize-handle');
  const root = document.documentElement;
  let dragging = false;
  let startX, startWidth;
  handle.addEventListener('mousedown', e => {
    dragging = true;
    handle.classList.add('dragging');
    startX = e.clientX;
    startWidth = document.getElementById('panel-project').offsetWidth;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if(!dragging) return;
    const delta = startX - e.clientX;
    const newWidth = Math.max(280, Math.min(800, startWidth + delta));
    root.style.setProperty('--project-width', newWidth + 'px');
  });
  document.addEventListener('mouseup', () => {
    if(!dragging) return;
    dragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  });
})();

// === PIPELINE ===
let plRecorder=null, plChunks=[], plRecording=false, plRecStart=0, plRecTimer=null, plAudioBlob=null, plTranscriptText='', plSynthesisText='', plApiOk=null;
function plCheckApi(){
  if(!ASTRA_ADMIN_PW){document.getElementById('pl-status-dot').style.background='var(--text-muted)';document.getElementById('pl-status-dot').title='No password set';document.getElementById('pl-onboarding').style.display='block';return;}
  fetch(ASTRA_API+'/api/health',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}}).then(r=>r.json()).then(d=>{
    plApiOk=true;document.getElementById('pl-status-dot').style.background='var(--green)';document.getElementById('pl-status-dot').title='API connected';document.getElementById('pl-onboarding').style.display='none';
  }).catch(()=>{
    plApiOk=false;document.getElementById('pl-status-dot').style.background='var(--orange)';document.getElementById('pl-status-dot').title='API unreachable';document.getElementById('pl-onboarding').style.display='block';
  });
}
function plSaveLocal(entry){if(!S.pipelineHistory)S.pipelineHistory=[];S.pipelineHistory.unshift(entry);if(S.pipelineHistory.length>50)S.pipelineHistory.length=50;save();}

function plToggleRecord() {
  const btn=document.getElementById('pl-record-btn');
  const indicator=document.getElementById('pl-recording');
  if(plRecording && plRecorder && plRecorder.state==='recording') {
    plRecorder.stop();
    plRecording=false;
    btn.textContent='Record Mic';
    btn.classList.remove('active');
    indicator.style.display='none';
    clearInterval(plRecTimer);
    toast('Processing audio...');
    return;
  }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {
    plChunks=[];
    plRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'});
    plRecorder.ondataavailable=e=>{if(e.data.size>0)plChunks.push(e.data);};
    plRecorder.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      plAudioBlob=new Blob(plChunks,{type:'audio/webm'});
      const preview=document.getElementById('pl-input-preview');
      preview.style.display='block';
      preview.textContent='Audio recorded ('+Math.round(plAudioBlob.size/1024)+'KB). Ready to process.';
      toast('Audio ready — set your prompt and hit Process');
    };
    plRecorder.start();
    plRecording=true;
    btn.textContent='Stop Recording';
    btn.classList.add('active');
    indicator.style.display='flex';
    plRecStart=Date.now();
    plRecTimer=setInterval(()=>{
      document.getElementById('pl-rec-time').textContent='Recording... '+Math.floor((Date.now()-plRecStart)/1000)+'s';
    },1000);
    toast('Recording...');
  }).catch(()=>toast('Mic access denied'));
}

function plUploadFile(input) {
  const file=input.files[0];
  if(!file) return;
  plAudioBlob=file;
  const preview=document.getElementById('pl-input-preview');
  preview.style.display='block';
  preview.textContent='File: '+file.name+' ('+Math.round(file.size/1024)+'KB). Ready to process.';
  toast('Audio loaded — set your prompt and hit Process');
  input.value='';
}

// Pipeline drop zone for text/audio files
(function(){
  const panel=document.getElementById('panel-pipeline');
  if(!panel)return;
  panel.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='copy';panel.style.outline='2px dashed var(--accent)';});
  panel.addEventListener('dragleave',()=>{panel.style.outline='none';});
  panel.addEventListener('drop',e=>{
    e.preventDefault();panel.style.outline='none';
    const file=e.dataTransfer.files[0];if(!file)return;
    if(file.type.startsWith('audio/')){plAudioBlob=file;const p=document.getElementById('pl-input-preview');p.style.display='block';p.textContent='Audio: '+file.name+' ('+Math.round(file.size/1024)+'KB)';toast('Audio loaded');}
    else if(file.type.startsWith('text/')||file.name.endsWith('.txt')||file.name.endsWith('.md')){
      const r=new FileReader();r.onload=()=>{plAudioBlob=null;plTranscriptText=r.result;const p=document.getElementById('pl-input-preview');p.style.display='block';p.textContent=plTranscriptText.length>300?plTranscriptText.substring(0,300)+'...':plTranscriptText;toast('Text loaded from '+file.name);};r.readAsText(file);
    }else{toast('Drop audio or text files');}
  });
})();
function plPasteText() {
  navigator.clipboard.readText().then(text=>{
    if(!text){toast('Clipboard empty');return;}
    plAudioBlob=null;
    plTranscriptText=text;
    const preview=document.getElementById('pl-input-preview');
    preview.style.display='block';
    const wc=text.trim().split(/\s+/).filter(x=>x.length).length;
    preview.innerHTML='<div style="font-size:8px;color:var(--accent);margin-bottom:4px">'+text.length+' chars / '+wc+' words</div>'+(text.length>300?esc(text.substring(0,300))+'...':esc(text));
    toast('Text pasted — set your prompt and hit Process');
  }).catch(()=>toast('Cannot read clipboard'));
}

async function plProcess() {
  const prompt=document.getElementById('pl-prompt').value.trim();
  if(!prompt){toast('Enter a prompt first');return;}
  if(!plAudioBlob && !plTranscriptText){toast('Record, upload, or paste something first');return;}

  const btn=document.getElementById('pl-process-btn');
  btn.textContent='Processing...';
  btn.disabled=true;

  try {
    const source=document.getElementById('pl-source').value;
    let res;
    if(plAudioBlob) {
      const fd=new FormData();
      fd.append('audio',plAudioBlob,plAudioBlob.name||'recording.webm');
      fd.append('prompt',prompt);
      fd.append('source',source);
      res=await fetch(ASTRA_API+'/api/pipeline',{method:'POST',headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW},body:fd});
    } else {
      res=await fetch(ASTRA_API+'/api/pipeline',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+ASTRA_ADMIN_PW},body:JSON.stringify({text:plTranscriptText,prompt:prompt,source:source})});
    }
    const data=await res.json();
    if(data.ok) {
      plTranscriptText=data.transcript||'';
      plSynthesisText=data.synthesis||'';
      const resultDiv=document.getElementById('pl-result');
      resultDiv.style.display='block';
      if(data.inputType==='audio'&&data.transcript) {
        document.getElementById('pl-transcript-box').style.display='block';
        document.getElementById('pl-transcript-text').textContent=data.transcript;
      } else {
        document.getElementById('pl-transcript-box').style.display='none';
      }
      document.getElementById('pl-synthesis-text').textContent=data.synthesis;
      plUpdateResultStats(data.synthesis);
      plSaveLocal({id:data.pipelineId||('p_'+Date.now()),inputType:data.inputType||'text',prompt:prompt,preview:(data.synthesis||'').substring(0,200),source:source,createdAt:new Date().toISOString()});
      toast('Pipeline complete!');
    } else {
      toast('Error: '+(data.error||'unknown'));
    }
  } catch(e) {
    // Fallback: local text processing if API unavailable
    if(plTranscriptText){
      const result=plLocalProcess(plTranscriptText,prompt);
      plSynthesisText=result;
      document.getElementById('pl-result').style.display='block';
      document.getElementById('pl-transcript-box').style.display='none';
      document.getElementById('pl-synthesis-text').textContent=result;
      plUpdateResultStats(result);
      plSaveLocal({id:'p_'+Date.now(),inputType:'text',prompt:prompt,preview:result.substring(0,200),source:document.getElementById('pl-source').value,createdAt:new Date().toISOString()});
      toast('Processed locally (API unavailable)');
    } else {
      toast('Pipeline error: '+e.message);
    }
  } finally {
    btn.textContent='Process Pipeline';
    btn.disabled=false;
  }
}
function plLocalProcess(text,prompt){
  const words=text.trim().split(/\s+/).filter(x=>x.length);
  const sentences=text.split(/[.!?]+/).map(s=>s.trim()).filter(Boolean);
  const pl=prompt.toLowerCase();
  if(pl.includes('summar')){return'Summary (local):\n\n'+sentences.slice(0,Math.min(5,Math.ceil(sentences.length/3))).map(s=>'- '+s+'.').join('\n')+'\n\nStats: '+words.length+' words, '+sentences.length+' sentences.';}
  if(pl.includes('action')||pl.includes('task')||pl.includes('checklist')){const actions=sentences.filter(s=>/\b(need|must|should|will|todo|action|fix|add|create|build|update|check|review|send|schedule)\b/i.test(s));return'Action Items (local):\n\n'+(actions.length?actions.map(a=>'[ ] '+a+'.').join('\n'):'No explicit action items found.\n\nAll sentences:\n'+sentences.map(s=>'[ ] '+s+'.').join('\n'));}
  if(pl.includes('clean')||pl.includes('grammar')){return text.replace(/\s+/g,' ').replace(/\s([,.!?;:])/g,'$1').replace(/([.!?])\s*/g,'$1 ').trim();}
  if(pl.includes('count')||pl.includes('stat')){const chars=text.length;const paras=text.split(/\n\s*\n/).filter(Boolean).length;const uniq=[...new Set(words.map(w=>w.toLowerCase()))].length;return'Text Statistics:\n\nWords: '+words.length+'\nCharacters: '+chars+'\nSentences: '+sentences.length+'\nParagraphs: '+paras+'\nUnique words: '+uniq+'\nAvg words/sentence: '+Math.round(words.length/Math.max(1,sentences.length))+'\nReading time: '+Math.max(1,Math.ceil(words.length/238))+' min';}
  if(pl.includes('keyword')||pl.includes('frequent')||pl.includes('top word')){const freq={};words.forEach(w=>{const lw=w.toLowerCase().replace(/[^a-z0-9]/g,'');if(lw.length>3){freq[lw]=(freq[lw]||0)+1;}});const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,20);return'Top Keywords (local):\n\n'+sorted.map(([w,c])=>w+': '+c+' times').join('\n');}
  if(pl.includes('bullet')||pl.includes('list')){return'Bullet Points (local):\n\n'+sentences.map(s=>'- '+s.charAt(0).toUpperCase()+s.slice(1)+'.').join('\n');}
  if(pl.includes('question')||pl.includes('faq')){const qs=sentences.filter(s=>/\?|who|what|when|where|why|how|which|can|could|should|would|is|are|do|does/i.test(s));return'Questions Found (local):\n\n'+(qs.length?qs.map(q=>'Q: '+q+(q.endsWith('?')?'':'?')).join('\n\n'):'No explicit questions found in the text.');}
  if(pl.includes('headline')||pl.includes('title')){const caps=sentences.slice(0,5).map(s=>{const w=s.split(/\s+/).slice(0,8).join(' ');return w.split(' ').map(x=>x.charAt(0).toUpperCase()+x.slice(1).toLowerCase()).join(' ');});return'Headline Suggestions (local):\n\n'+caps.map((h,i)=>(i+1)+'. '+h).join('\n');}
  return'Processed text (local - API unavailable):\n\nInput: '+words.length+' words, '+sentences.length+' sentences.\n\nKey sentences:\n'+sentences.slice(0,5).map(s=>'- '+s+'.').join('\n')+'\n\nNote: For advanced processing (AI summarization, translation, etc.), configure OPENAI_API_KEY in Vercel environment variables.';
}
function plWordCloud(){
  const text=(document.getElementById('pl-text')?.value||'').trim();
  if(!text){toast('Paste or enter text first');return;}
  const stopWords=new Set(['the','a','an','is','are','was','were','be','been','have','has','had','do','does','did','will','would','shall','should','may','might','must','can','could','and','but','or','nor','for','yet','so','in','on','at','to','of','by','with','from','as','into','through','during','before','after','above','below','up','down','out','off','over','under','again','then','once','here','there','when','where','why','how','all','each','every','both','few','more','most','other','some','such','no','not','only','own','same','than','too','very','just','also','about','its','it','this','that','these','those','i','me','my','we','us','our','you','your','he','him','his','she','her','they','them','their','what','which','who','been','being','because']);
  const words=text.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stopWords.has(w));
  const freq={};words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,40);
  if(!sorted.length){toast('Not enough words');return;}
  const maxF=sorted[0][1];const svgW=500;const svgH=300;
  const colors=['#4ade80','#22d3ee','#a855f7','#f472b6','#fbbf24','#f87171','#34d399','#60a5fa','#c084fc','#fb923c'];
  let cloudSvg='<svg xmlns="http://www.w3.org/2000/svg" width="'+svgW+'" height="'+svgH+'" style="background:#0a0a0e;border-radius:8px">';
  const placed=[];
  sorted.forEach(([w,c],i)=>{
    const size=Math.max(10,Math.round((c/maxF)*36));
    const color=colors[i%colors.length];
    for(let attempt=0;attempt<50;attempt++){
      const x=20+Math.random()*(svgW-40);const y=20+Math.random()*(svgH-40);
      const overlap=placed.some(p=>Math.abs(p.x-x)<(p.w+w.length*size*0.5)/2&&Math.abs(p.y-y)<size);
      if(!overlap){
        cloudSvg+=`<text x="${x}" y="${y}" font-size="${size}" fill="${color}" font-family="system-ui" opacity="${0.6+0.4*(c/maxF)}">${w}</text>`;
        placed.push({x,y,w:w.length*size*0.6});break;
      }
    }
  });
  cloudSvg+='</svg>';
  const resultDiv=document.getElementById('pl-result');resultDiv.style.display='block';
  document.getElementById('pl-synthesis-text').innerHTML=cloudSvg+'<div style="margin-top:8px;font-size:10px;color:var(--text-muted)">Top words: '+sorted.slice(0,10).map(([w,c])=>w+'('+c+')').join(', ')+'</div>';
  toast('Word cloud generated');
}
function plSaveTemplate(){
  const prompt=document.getElementById('pl-prompt').value.trim();
  if(!prompt){toast('Write a prompt first');return;}
  const name=window.prompt('Template name:',prompt.substring(0,30));
  if(!name)return;
  if(!S.pipelineTemplates)S.pipelineTemplates=[];
  S.pipelineTemplates.push({name:name.trim(),prompt,created:new Date().toISOString()});
  save();plRenderCustomTemplates();toast('Template saved: '+name.trim());
}
function plRenderCustomTemplates(){
  const el=document.getElementById('pl-custom-templates');if(!el)return;
  const tpls=S.pipelineTemplates||[];
  if(!tpls.length){el.innerHTML='';return;}
  el.innerHTML=tpls.map((t,i)=>`<button class="btn btn-sm btn-ghost" onclick="document.getElementById('pl-prompt').value='${escA(t.prompt)}'" style="font-size:8px;padding:2px 6px;border-color:rgba(74,222,128,0.15)" title="${escA(t.prompt)}">${esc(t.name)}</button><span style="font-size:7px;color:var(--text-muted);cursor:pointer;opacity:0.4" onclick="plDeleteTemplate(${i})" title="Delete template">x</span>`).join('');
}
function plDeleteTemplate(idx){
  if(!S.pipelineTemplates||!S.pipelineTemplates[idx])return;
  S.pipelineTemplates.splice(idx,1);save();plRenderCustomTemplates();toast('Template deleted');
}

function plCopyResult() {
  const text=document.getElementById('pl-synthesis-text').textContent;
  navigator.clipboard.writeText(text).then(()=>toast('Copied!')).catch(()=>toast('Copy failed'));
}

function plSaveCapture() {
  fetch(ASTRA_API+'/api/capture',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+ASTRA_ADMIN_PW},body:JSON.stringify({
    content:plSynthesisText,category:'pipeline',source:'pipeline-ui',sourceTitle:'Pipeline Result',type:'synthesis',tags:['pipeline','processed']
  })}).then(r=>r.json()).then(d=>{
    if(d.ok) toast('Saved to ASTRA!');
    else toast('Save error');
  }).catch(()=>toast('Save failed'));
}
function plSaveToContent(){
  const text=plSynthesisText||document.getElementById('pl-synthesis-text').textContent;
  if(!text){toast('No result to save');return;}
  const prompt=document.getElementById('pl-prompt').value.trim();
  const src=document.getElementById('pl-source').value.replace('pipeline-','');
  S.content.unshift({id:Date.now(),body:text,theme:'pipeline',tags:['pipeline',src].filter(Boolean),created:new Date().toISOString()});
  save();toast('Saved to Content section');
  if(currentSection==='content')renderContent();
}

async function plLoadHistory() {
  const histDiv=document.getElementById('pl-history');
  const listDiv=document.getElementById('pl-history-list');
  histDiv.style.display=histDiv.style.display==='none'?'block':'none';
  if(histDiv.style.display==='none') return;
  listDiv.innerHTML='<div style="font-size:10px;color:var(--text-muted)">Loading...</div>';
  let results=[];
  let source='none';
  try {
    if(ASTRA_ADMIN_PW){
      const res=await fetch(ASTRA_API+'/api/pipeline',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}});
      const data=await res.json();
      if(data.ok && data.results && data.results.length>0){results=data.results;source='cloud';}
    }
  } catch(e){}
  if(!results.length && S.pipelineHistory && S.pipelineHistory.length){results=S.pipelineHistory;source='local';}
  const hq=(document.getElementById('pl-history-search')?.value||'').toLowerCase();
  if(hq)results=results.filter(r=>((r.preview||'')+(r.prompt||'')+(r.source||'')).toLowerCase().includes(hq));
  if(results.length>0){
    const srcColors={'pipeline-manual':'var(--accent)','pipeline-whatsapp':'#25d366','pipeline-voice':'#a855f7','pipeline-capture':'#fbbf24'};
    listDiv.innerHTML=(source==='local'?'<div style="font-size:9px;color:var(--text-muted);margin-bottom:8px;padding:4px 8px;background:var(--bg-elevated);border-radius:3px">Showing local history ('+results.length+' entries)</div>':'')+results.map((r,i)=>{const full=r.preview||'';const short=full.length>150?full.substring(0,150)+'...':full;const sc=srcColors[r.source]||'var(--text-muted)';const srcLabel=(r.source||'').replace('pipeline-','');return '<div style="padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;margin-bottom:8px;cursor:pointer" onclick="this.querySelector(\'.pl-full\').style.display=this.querySelector(\'.pl-full\').style.display===\'none\'?\'block\':\'none\';this.querySelector(\'.pl-short\').style.display=this.querySelector(\'.pl-short\').style.display===\'none\'?\'block\':\'none\'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:4px"><div style="display:flex;gap:4px;align-items:center"><span class="badge badge-blue" style="font-size:9px">'+esc(r.inputType||'text')+'</span><span style="font-size:8px;padding:2px 6px;border-radius:3px;border:1px solid '+sc+';color:'+sc+'">'+esc(srcLabel||'manual')+'</span></div><span style="font-size:9px;color:var(--text-muted)">'+new Date(r.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})+'</span></div>'+(r.prompt?'<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;font-style:italic;border-left:2px solid var(--accent);padding-left:8px">'+esc(r.prompt)+'</div>':'')+'<div class="pl-short" style="font-size:11px;line-height:1.5;color:var(--text-secondary)">'+esc(short)+(full.length>150?' <span style="color:var(--accent);font-size:9px">[click to expand]</span>':'')+'</div><div class="pl-full" style="display:none;font-size:11px;line-height:1.6;color:var(--text);white-space:pre-wrap">'+esc(full)+'</div><div style="display:flex;gap:4px;margin-top:8px" onclick="event.stopPropagation()"><button class="btn btn-sm btn-ghost" onclick="navigator.clipboard.writeText('+JSON.stringify(full).replace(/'/g,"\\'")+');toast(\'Copied\')">Copy</button><button class="btn btn-sm btn-ghost" onclick="S.content.unshift({id:Date.now(),type:\'caption\',theme:\'pipeline\',body:'+JSON.stringify(full).replace(/'/g,"\\'")+',tags:[\'pipeline\'],created:new Date().toISOString()});save();toast(\'Saved to content\')">To Content</button><button class="btn btn-sm btn-ghost btn-danger" onclick="plDeleteEntry('+i+');event.stopPropagation()">Delete</button></div></div>';}).join('');
  } else {
    listDiv.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">P</div><div style="font-size:11px">No pipeline history yet</div><div style="font-size:10px;margin-top:4px">Paste text, write a prompt, and hit Process</div></div>';
  }
}

function plDeleteEntry(idx){
  if(!confirm('Delete this pipeline entry?'))return;
  if(S.pipelineHistory&&S.pipelineHistory[idx]){S.pipelineHistory.splice(idx,1);save();plLoadHistory();plLoadHistory();toast('Deleted');}
}
function plUpdateResultStats(text){
  const el=document.getElementById('pl-result-stats');if(!el||!text)return;
  const words=text.trim().split(/\s+/).filter(x=>x.length).length;
  const chars=text.length;
  const lines=text.split('\n').length;
  const sents=text.split(/[.!?]+/).filter(s=>s.trim().length).length;
  el.textContent=words+' words / '+chars+' chars / '+lines+' lines / '+sents+' sentences';
}
function plClearResult(){
  document.getElementById('pl-result').style.display='none';
  document.getElementById('pl-input-preview').style.display='none';
  plAudioBlob=null;plTranscriptText='';plSynthesisText='';
  document.getElementById('pl-prompt').value='';
}
async function plViewEntry(id) {
  try {
    const res=await fetch(ASTRA_API+'/api/pipeline',{headers:{'Authorization':'Bearer '+ASTRA_ADMIN_PW}});
    const data=await res.json();
    const entry=(data.results||[]).find(r=>r.id===id);
    if(entry) {
      document.getElementById('pl-synthesis-text').textContent=entry.preview||'(load full entry)';
      document.getElementById('pl-result').style.display='block';
      toast('Loaded: '+id);
    }
  } catch(e) { toast('Error loading entry'); }
}

// === REPOS ===
function timeAgo(dateStr){
  if(!dateStr)return '';
  const d=new Date(dateStr),now=new Date(),ms=now-d,s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60),dy=Math.floor(h/24);
  if(dy>30)return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if(dy>0)return dy+'d ago';if(h>0)return h+'h ago';if(m>0)return m+'m ago';return 'just now';
}
function reposRefresh() {
  if(!S.repos || !S.repos.length) {
    S.repos = [
      { name:'astra-command-center', github:'https://github.com/gabosaturno11/astra-command-center', live:'https://astra-command-center-sigma.vercel.app', role:'backend-hub', status:'active', desc:'ASTRA V2 command center, project hub, KB, whiteboard, API backend', updatedAt:new Date().toISOString() },
      { name:'saturno-bonus', github:'https://github.com/gabosaturno11/saturno-bonus', live:'https://saturno-bonus-omega.vercel.app', role:'customer-facing', status:'active', desc:'Bonus vault for SM Academy customers. 60 tools, 15 PDFs, music player.', updatedAt:new Date().toISOString() },
      { name:'titan-forge', github:'https://github.com/gabosaturno11/titan-forge', live:'https://titan-forge-ten.vercel.app', role:'internal-tools', status:'active', desc:'Internal tools collection. Bonus page moved out to saturno-bonus.', updatedAt:new Date().toISOString() },
      { name:'de-aqui-a-saturno', github:'https://github.com/gabosaturno11/de-aqui-a-saturno', live:'https://de-aqui-a-saturno-jet.vercel.app', role:'experience', status:'complete', desc:'Valentine crystal cosmic scroll. Gate, 18 chapters, 11 love dimensions.', updatedAt:'2026-02-14T00:00:00Z' },
      { name:'nexus-capture', github:'https://github.com/gabosaturno11/nexus-capture', live:null, role:'extension', status:'active', desc:'Chrome extension for universal highlight capture. Routes to ASTRA API.', updatedAt:new Date().toISOString() },
    ];
    save();
  }
  const grid=document.getElementById('repos-grid');
  if(!grid) return;
  const rq=(document.getElementById('repo-search')?.value||'').toLowerCase();
  let repos=[...(S.repos||[])];
  if(rq)repos=repos.filter(r=>(r.name+' '+r.role+' '+r.desc+' '+r.status).toLowerCase().includes(rq));
  const rsort=(document.getElementById('repo-sort')?.value)||'name';
  if(rsort==='name')repos.sort((a,b)=>a.name.localeCompare(b.name));
  else if(rsort==='status')repos.sort((a,b)=>(a.status||'').localeCompare(b.status||''));
  else if(rsort==='updated')repos.sort((a,b)=>new Date(b.updatedAt||0)-new Date(a.updatedAt||0));
  else if(rsort==='role')repos.sort((a,b)=>(a.role||'').localeCompare(b.role||''));
  const cntEl=document.getElementById('repos-count');if(cntEl)cntEl.textContent=(S.repos||[]).length;
  const roleColors={'backend-hub':'var(--accent)','customer-facing':'#22d3ee','internal-tools':'#a855f7','experience':'#f472b6','extension':'#fbbf24'};
  const roleIcons={'backend-hub':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><circle cx="6" cy="6" r="1"/><circle cx="6" cy="18" r="1"/></svg>','customer-facing':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>','internal-tools':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>','experience':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>','extension':'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>'};
  if(!repos.length){grid.innerHTML=`<div style="text-align:center;padding:30px;color:var(--text-muted)"><div style="font-size:24px;margin-bottom:8px;opacity:0.3">R</div><div style="font-size:12px">${rq?'No matching repos':'No repos connected'}</div><div style="font-size:10px;margin-top:4px">${rq?'Try a different filter':'Click + Add to connect a repository'}</div></div>`;return;}
  const renderRepoCard=r=>{
    const rc=roleColors[r.role]||'var(--text-muted)';
    const sc=r.status==='active'?'var(--green)':r.status==='complete'?'var(--accent-cyan)':'var(--text-muted)';
    const icon=roleIcons[r.role]||'';
    return `<div style="padding:14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);transition:all 0.15s" onmouseenter="this.style.borderColor='rgba(255,255,255,0.08)'" onmouseleave="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span style="color:${rc};flex-shrink:0">${icon}</span>
        <span style="font-size:13px;font-weight:600;color:var(--text);flex:1">${esc(r.name)}</span>
        <span style="width:8px;height:8px;border-radius:50%;background:${sc}" title="${r.status}"></span>
        ${r.live?'<span style="font-size:7px;padding:1px 5px;border-radius:3px;background:rgba(74,222,128,0.1);color:var(--accent);border:1px solid rgba(74,222,128,0.2)">LIVE</span>':'<span style="font-size:7px;padding:1px 5px;border-radius:3px;background:rgba(255,255,255,0.04);color:var(--text-muted)">LOCAL</span>'}
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <span style="font-size:9px;text-transform:uppercase;letter-spacing:0.06em;color:${rc}">${esc(r.role)}</span>
        ${r.updatedAt?'<span style="font-size:8px;color:var(--text-muted)">'+timeAgo(r.updatedAt)+'</span>':''}
        ${r.lastDeploy?'<span style="font-size:8px;color:var(--accent);font-family:var(--mono)" title="Last deploy">deployed '+r.lastDeploy+'</span>':''}
      </div>
      <div style="font-size:11px;color:var(--text-secondary);margin-bottom:${r.notes||r.lastCommit||r.stack?'4':'10'}px;line-height:1.5">${esc(r.desc)}</div>${r.stack?`<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px">${r.stack.split(',').map(t=>`<span style="font-size:7px;padding:1px 5px;border-radius:8px;border:1px solid rgba(74,222,128,0.2);color:var(--accent);letter-spacing:0.03em">${esc(t.trim())}</span>`).join('')}</div>`:''}${r.lastCommit?`<div style="font-size:9px;color:var(--text-muted);margin-bottom:4px;font-family:var(--mono);padding:3px 6px;background:var(--bg-deep);border-radius:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">last: ${esc(r.lastCommit)}</div>`:''}${r.notes?`<div style="font-size:10px;color:var(--accent);margin-bottom:10px;padding:4px 6px;background:rgba(74,222,128,0.04);border-radius:4px;border-left:2px solid var(--accent);line-height:1.4">${esc(r.notes)}</div>`:''}
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <a href="${escA(r.github)}" target="_blank" style="font-size:10px;color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:3px"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg> repo</a>
        ${r.live?`<a href="${escA(r.live)}" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;display:flex;align-items:center;gap:3px"><span style="width:6px;height:6px;border-radius:50%;background:${r.lastCheck?(r.lastCheckOk?'var(--green)':'var(--red)'):'var(--green)'};display:inline-block"></span> live${r.lastCheck?' ('+timeAgo(r.lastCheck)+')':''}</a>`:'<span style="font-size:10px;color:var(--text-muted)">local only</span>'}
        <span style="flex:1"></span>
        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('git clone ${escA(r.github)}.git');toast('Clone command copied')" style="font-size:9px;padding:2px 6px" title="Copy git clone command">Clone</button>
        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();cpText('${escA(r.github)}')" style="font-size:9px;padding:2px 6px" title="Copy GitHub URL">URL</button>
        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();openRepoModal('${escA(r.name)}')" style="font-size:9px;padding:2px 6px">Edit</button>
        <button class="btn btn-sm btn-ghost btn-danger" onclick="event.stopPropagation();deleteRepo('${escA(r.name)}')" style="font-size:9px;padding:2px 6px">Del</button>
      </div>
    </div>`;};
  let repoHtml='';if(rsort==='role'||rsort==='status'){let lastGrp=null;repos.forEach(r=>{const grp=rsort==='role'?(r.role||'other'):(r.status||'unknown');if(grp!==lastGrp){const cnt=repos.filter(x=>(rsort==='role'?(x.role||'other'):(x.status||'unknown'))===grp).length;const gc=rsort==='role'?(roleColors[grp]||'var(--text-muted)'):(grp==='active'?'var(--green)':grp==='complete'?'var(--accent-cyan)':'var(--text-muted)');repoHtml+=`<div style="grid-column:1/-1;padding:8px 4px 4px;font-size:11px;font-weight:600;color:${gc};border-bottom:1px solid var(--border);margin-bottom:2px;text-transform:uppercase;letter-spacing:0.05em">${esc(grp)} <span style="font-size:9px;color:var(--text-muted);font-weight:400">${cnt}</span></div>`;lastGrp=grp;}repoHtml+=renderRepoCard(r);});}else{repoHtml=repos.map(renderRepoCard).join('');}
  grid.innerHTML=repoHtml;
}

async function repoHealthCheck(){
  const repos=(S.repos||[]).filter(r=>r.live);
  if(!repos.length){toast('No repos with live URLs');return;}
  toast('Checking '+repos.length+' live URLs...');
  let ok=0,fail=0;
  for(const r of repos){
    try{
      const res=await fetch(r.live,{mode:'no-cors',signal:AbortSignal.timeout(5000)});
      r.lastCheck=new Date().toISOString();r.lastCheckOk=true;ok++;
    }catch(e){r.lastCheck=new Date().toISOString();r.lastCheckOk=false;fail++;}
  }
  save();reposRefresh();toast(ok+' up, '+fail+' down');
}

// === REPO MODAL ===
let editingRepoName=null;
function openRepoModal(name){
  editingRepoName=name||null;
  document.getElementById('repo-modal-title').textContent=name?'Edit Repo':'Add Repo';
  if(name){
    const r=(S.repos||[]).find(x=>x.name===name);
    if(r){document.getElementById('rm-name').value=r.name;document.getElementById('rm-github').value=r.github||'';document.getElementById('rm-live').value=r.live||'';document.getElementById('rm-role').value=r.role||'other';document.getElementById('rm-status').value=r.status||'active';document.getElementById('rm-desc').value=r.desc||'';document.getElementById('rm-notes').value=r.notes||'';document.getElementById('rm-lastcommit').value=r.lastCommit||'';document.getElementById('rm-stack').value=r.stack||'';document.getElementById('rm-deploy').value=r.lastDeploy||'';}
  } else {
    document.getElementById('rm-name').value='';document.getElementById('rm-github').value='';document.getElementById('rm-live').value='';document.getElementById('rm-role').value='other';document.getElementById('rm-status').value='active';document.getElementById('rm-desc').value='';document.getElementById('rm-notes').value='';document.getElementById('rm-lastcommit').value='';document.getElementById('rm-stack').value='';document.getElementById('rm-deploy').value='';
  }
  document.getElementById('repo-modal').classList.add('open');
  setTimeout(()=>document.getElementById('rm-name').focus(),100);
}
function closeRepoModal(){document.getElementById('repo-modal').classList.remove('open');editingRepoName=null;}
function saveRepo(){
  const name=document.getElementById('rm-name').value.trim();
  if(!name){toast('Name required');return;}
  const notes=document.getElementById('rm-notes').value.trim();
  const lastCommit=document.getElementById('rm-lastcommit').value.trim();
  const stack=document.getElementById('rm-stack').value.trim();
  const lastDeploy=document.getElementById('rm-deploy').value;
  const data={name,github:document.getElementById('rm-github').value.trim(),live:document.getElementById('rm-live').value.trim()||null,role:document.getElementById('rm-role').value,status:document.getElementById('rm-status').value,desc:document.getElementById('rm-desc').value.trim(),notes:notes||undefined,lastCommit:lastCommit||undefined,stack:stack||undefined,lastDeploy:lastDeploy||undefined,updatedAt:new Date().toISOString()};
  if(!S.repos)S.repos=[];
  if(editingRepoName){
    const idx=S.repos.findIndex(r=>r.name===editingRepoName);
    if(idx>=0)S.repos[idx]=data;
    else S.repos.push(data);
  } else {
    if(S.repos.find(r=>r.name===name)){toast('Repo already exists');return;}
    S.repos.push(data);
  }
  save();closeRepoModal();reposRefresh();toast(editingRepoName?'Updated':'Added');
}
function deleteRepo(name){
  if(!confirm('Delete repo "'+name+'"?'))return;
  S.repos=(S.repos||[]).filter(r=>r.name!==name);
  save();reposRefresh();toast('Deleted');
}
async function reposHealthCheck(){
  const repos=(S.repos||[]).filter(r=>r.live);
  if(!repos.length){toast('No live URLs to check');return;}
  toast('Checking '+repos.length+' live URLs...');
  const results=await Promise.allSettled(repos.map(r=>fetch(r.live,{mode:'no-cors',cache:'no-cache'}).then(()=>({name:r.name,ok:true})).catch(()=>({name:r.name,ok:false}))));
  const summary=results.map(r=>r.value||r.reason);
  const up=summary.filter(s=>s&&s.ok).length;
  toast(up+'/'+repos.length+' repos responding');
  summary.forEach(s=>{if(s){const repo=(S.repos||[]).find(r=>r.name===s.name);if(repo){repo.lastCheck=new Date().toISOString();repo.lastCheckOk=s.ok;}}});
  save();reposRefresh();
}

// === FOCUS TIMER ===
let focusTimerInterval=null;let focusTimerEnd=0;let focusTimerTaskId=null;let focusTimerStartedAt=null;let focusTimerMinutes=0;
function startFocusTimer(taskId,minutes){
  minutes=minutes||25;
  if(focusTimerInterval){clearInterval(focusTimerInterval);const fp=document.getElementById('focus-timer-float');if(fp)fp.remove();}
  focusTimerTaskId=taskId||null;focusTimerEnd=Date.now()+minutes*60*1000;focusTimerStartedAt=new Date().toISOString();focusTimerMinutes=minutes;
  const t=taskId?S.tasks.find(x=>x.id===taskId):null;
  const panel=document.createElement('div');panel.id='focus-timer-float';
  panel.style.cssText='position:fixed;bottom:20px;right:20px;background:var(--bg-surface);border:1px solid var(--accent);border-radius:12px;padding:12px 16px;z-index:9999;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,0.4)';
  panel.innerHTML='<div style="font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">Focus Mode</div>'+(t?'<div style="font-size:10px;color:var(--text);margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px">'+esc(t.title)+'</div>':'')+'<div id="focus-timer-display" style="font-size:24px;color:var(--accent);font-family:var(--mono);text-align:center">'+minutes+':00</div><div style="display:flex;gap:6px;margin-top:8px;justify-content:center"><button onclick="stopFocusTimer()" style="font-size:9px;padding:3px 10px;background:var(--red);color:#fff;border:none;border-radius:4px;cursor:pointer">Stop</button><button onclick="extendFocusTimer(5)" style="font-size:9px;padding:3px 10px;background:var(--bg-elevated);color:var(--text);border:1px solid var(--border);border-radius:4px;cursor:pointer">+5m</button></div>';
  document.body.appendChild(panel);
  focusTimerInterval=setInterval(()=>{
    const rem=Math.max(0,focusTimerEnd-Date.now());
    const m=Math.floor(rem/60000);const s=Math.floor((rem%60000)/1000);
    const disp=document.getElementById('focus-timer-display');
    if(disp)disp.textContent=m+':'+String(s).padStart(2,'0');
    if(rem<=0){stopFocusTimer();toast('Focus session complete!');if(focusTimerTaskId){const tk=S.tasks.find(x=>x.id===focusTimerTaskId);if(tk){tk.timeSpent=(tk.timeSpent||0)+minutes;save();renderTasks();}}}
  },1000);
  toast('Focus timer: '+minutes+'min'+(t?' on '+t.title.substring(0,30):''));
}
function stopFocusTimer(){
  if(focusTimerInterval){clearInterval(focusTimerInterval);focusTimerInterval=null;}
  const fp=document.getElementById('focus-timer-float');if(fp)fp.remove();
  const elapsed=focusTimerStartedAt?Math.max(1,Math.round((Date.now()-new Date(focusTimerStartedAt).getTime())/60000)):0;
  if(focusTimerTaskId){const t=S.tasks.find(x=>x.id===focusTimerTaskId);if(t){t.timeSpent=(t.timeSpent||0)+elapsed;save();renderTasks();}}
  if(elapsed>0&&focusTimerStartedAt){if(!S.focusSessions)S.focusSessions=[];const t=focusTimerTaskId?S.tasks.find(x=>x.id===focusTimerTaskId):null;S.focusSessions.unshift({date:new Date().toISOString().split('T')[0],minutes:elapsed,task:t?t.title:'',startedAt:new Date(focusTimerStartedAt).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}),planned:focusTimerMinutes});if(S.focusSessions.length>200)S.focusSessions.length=200;save();}
  const fTaskName=focusTimerTaskId?(S.tasks.find(x=>x.id===focusTimerTaskId)||{}).title:'';
  notifyFocusComplete(fTaskName);
  focusTimerTaskId=null;focusTimerStartedAt=null;focusTimerMinutes=0;
}
function extendFocusTimer(mins){focusTimerEnd+=mins*60*1000;toast('+'+mins+' minutes added');}

// === FLOATING QUICK NOTE ===
function toggleQuickNote(){
  let panel=document.getElementById('quick-note-panel');
  if(panel){panel.style.display=panel.style.display==='none'?'flex':'none';if(panel.style.display==='flex')panel.querySelector('textarea').focus();return;}
  panel=document.createElement('div');panel.id='quick-note-panel';
  panel.style.cssText='position:fixed;bottom:72px;left:20px;z-index:950;width:280px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 8px 32px rgba(0,0,0,0.6)';
  panel.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:10px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.05em">Quick Note</span><button onclick="document.getElementById('quick-note-panel').style.display='none'" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:0">&times;</button></div><textarea id="qn-text" placeholder="Type a quick note..." style="background:var(--bg-surface);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;padding:8px;resize:vertical;min-height:60px;max-height:200px;font-family:inherit"></textarea><div style="display:flex;gap:4px"><button onclick="saveQuickNote('content')" class="btn btn-sm btn-primary" style="flex:1;font-size:9px">Save as Content</button><button onclick="saveQuickNote('task')" class="btn btn-sm" style="flex:1;font-size:9px">Save as Task</button></div>`;
  document.body.appendChild(panel);panel.querySelector('textarea').focus();
}
function saveQuickNote(type){
  const text=document.getElementById('qn-text')?.value?.trim();if(!text){toast('Type something first');return;}
  if(type==='content'){S.content.unshift({id:Date.now(),body:text,type:'note',theme:'quick-note',tags:['quick-note'],created:new Date().toISOString()});save();if(currentSection==='content')renderContent();toast('Saved as content');}
  else if(type==='task'){S.tasks.unshift({id:Date.now(),title:text,description:'',subtasks:[],status:'todo',priority:'p2',project:taskProjectFilter||'',due:'',created:new Date().toISOString()});save();if(currentSection==='tasks')renderTasks();toast('Saved as task');}
  document.getElementById('qn-text').value='';
}

// === CONTENT WORD CLOUD ===
function contentWordCloud(){
  const allText=S.content.map(c=>c.body||'').join(' ');
  if(allText.trim().length<50){toast('Not enough content for word cloud');return;}
  const stop=new Set(['the','be','to','of','and','a','in','that','have','i','it','for','not','on','with','he','as','you','do','at','this','but','his','by','from','they','we','her','she','or','an','will','my','one','all','would','there','their','what','so','up','out','if','about','who','get','which','go','me','when','make','can','like','time','no','just','him','know','take','people','into','year','your','good','some','could','them','see','other','than','then','now','look','only','come','its','over','think','also','back','after','use','two','how','our','work','first','well','way','even','new','want','because','any','these','give','day','most','us','is','are','was','were','been','being','has','had','does','did','may','might','shall','should','must','need','am','very','much','more','own','each','every','while','still','through','where','too','around','find','here','thing','many','well','also','between','before','after','during','without','again','same','another','such','already','since','something','anything','everything','nothing','always','never','often','really']);
  const words=allText.toLowerCase().replace(/[^a-z\s]/g,'').split(/\s+/).filter(w=>w.length>2&&!stop.has(w));
  const freq={};words.forEach(w=>{freq[w]=(freq[w]||0)+1;});
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,40);
  if(!sorted.length){toast('No words found');return;}
  const maxF=sorted[0][1];const minF=sorted[sorted.length-1][1];
  const panel=document.createElement('div');panel.id='content-wordcloud-panel';
  panel.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;padding:24px;z-index:9999;max-width:520px;max-height:70vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,0.6)';
  const colors=['#4ade80','#22d3ee','#a855f7','#f472b6','#fbbf24','#60a5fa','#34d399','#fb923c'];
  let cloud='<div style="display:flex;flex-wrap:wrap;gap:6px 10px;align-items:baseline;justify-content:center;padding:12px">';
  sorted.forEach(([w,c],i)=>{
    const size=Math.round(10+((c-minF)/(maxF-minF||1))*22);
    const color=colors[i%colors.length];
    cloud+=`<span style="font-size:${size}px;color:${color};opacity:${0.6+(c/maxF)*0.4};cursor:default" title="${w}: ${c} occurrences">${esc(w)}</span>`;
  });
  cloud+='</div>';
  panel.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="color:var(--accent);font-weight:600">Content Word Cloud</span><button onclick="this.closest(\'#content-wordcloud-panel\').remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px">X</button></div><div style="font-size:9px;color:var(--text-muted);margin-bottom:12px">'+sorted.length+' unique words from '+S.content.length+' items</div>'+cloud;
  document.body.appendChild(panel);
}

if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{});}
</script>
</body>
</html>
